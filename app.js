// HeartSync Dating App - Main JavaScript File

class DatingApp {
    constructor() {
        this.currentUser = null;
        this.users = [];
        this.matches = [];
        this.messages = {};
        this.activeChatThread = null;
        this.activeChatUser = null;
        this.activeChatContext = null;
        this.currentUserIndex = 0;
        this.userLocation = null;
        this.watchLocationId = null;
        this.hasRequestedLocationOnLoad = false;
        this.didApplyEntryLocationDefaults = false;
        this.reverseGeocodeCache = new Map();
        // Google Maps integration
        this.googleApiKey = (window.GOOGLE_MAPS_API_KEY || 'YOUR_GOOGLE_API_KEY');
        this.googleMapsLoading = null; // Promise
        this.googleMap = null;
        this.googleMapMarkers = [];
        // Navigation state
        this.navOrder = ['home', 'marketplace', 'premium', 'location', 'profile'];
        this.activeScreen = 'home';
        this.navHistory = ['home'];
        this.navIndex = 0;
        this.isNavigatingHistory = false;
        this.isApplyingRoute = false;
        this.didSetupBrowserNavigation = false;
        this.didShowMainApp = false;
        this.pendingRoute = null;
        // Browser history tracking (for enabling/disabling in-app arrows).
        this.browserHistoryIndex = 0;
        this.browserHistoryMaxIndex = 0;
        this.isApplyingUiState = false;
        this.marketplaceContext = null;
        this.activeMarketplaceItem = null;
        this.activeMarketplaceItemGallery = [];
        this.boundMarketplaceItemModalKeydown = (e) => this.handleMarketplaceItemModalKeydown(e);
        this.boundChatKeydown = (e) => this.handleChatKeydown(e);
        this.boundSafetyKeydown = (e) => this.handleSafetyKeydown(e);
        this.pendingSafetyContinue = null;
        this.postAdUploads = [];
        this.postAdDraft = { placement: 'all', category: '', description: '' };
        this.discoveryPostUploads = [];
        this.discoveryPostUploadLimit = 5;
        this.profileAdUploads = [];
        this.profileAdDraft = { placement: 'home', category: '', description: '' };
        this.profileAdUploadLimit = 6;
	        this.promotionFees = {
	            banner: { home: 15, nearby: 15, dating: 15, companionship: 15, all: 39 },
	            featured: { default: 29 }
	        };
	        this.pendingPromotionFee = null;
	        this.wallet = { credits: 0, earnings: 0 };
	        this.isSignedIn = this.loadSignedInState();
	        this.pendingAuthAction = null;
	        this.pendingAuthReason = '';
        this.hookupPlusFilters = { city: '', radiusKm: 10 };
        this.hookupPlusDeck = [];
        this.hookupPlusDeckIndex = 0;
        this.hookupPlusLikes = new Set();
        this.hookupPlusPasses = new Set();
        this.hookupPlusDragging = null;
        this.hookupPlusAnimating = false;
        this.realestateModalMedia = [];
        this.realestateModalIndex = 0;
        this.activeRealestateListing = null;

        this.realestateListings = [
            {
                id: 're-1',
                title: 'Skyline Residence 路 2 Bed',
                price: '$6,800/mo',
                seller: 'Skyline Realty Group',
                rating: 4.9,
                reviews: 146,
                city: 'San Francisco',
                country: 'United States',
                location: 'Downtown, San Francisco',
                meta: 'Downtown 路 Fully furnished 路 1,450 sq ft',
                description: 'Penthouse-style residence with concierge services, sweeping skyline views, and designer finishes.',
                tags: ['Short-term', 'Concierge', 'Gym'],
                badge: 'Luxury',
                propertyType: 'Penthouse',
                bedrooms: 2,
                bathrooms: 2.5,
                sqft: 1450,
                availableOn: 'Now',
                amenities: 'Concierge, gym, skyline terrace',
                images: [
                    'https://images.unsplash.com/photo-1499952127939-9bbf5af6c51c?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&w=800&h=560'
                ],
                alt: 'Luxury city apartment',
                categories: ['for_rent', 'short_term'],
                date: '2024-12-20'
            },
            {
                id: 're-2',
                title: 'Artist Loft 路 1 Bed',
                price: '$3,250/mo',
                seller: 'Loft & Co.',
                rating: 4.8,
                reviews: 92,
                city: 'Los Angeles',
                country: 'United States',
                location: 'Arts District, Los Angeles',
                meta: 'Arts District 路 980 sq ft 路 Pet friendly',
                description: 'Open-plan loft with skylights, exposed brick, and flexible studio space for creatives.',
                tags: ['Rentals', 'Open layout', 'Parking'],
                badge: 'New',
                propertyType: 'Loft',
                bedrooms: 1,
                bathrooms: 1,
                sqft: 980,
                availableOn: 'Now',
                amenities: 'Skylights, exposed brick, parking',
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                images: [
                    'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800&h=560'
                ],
                alt: 'Loft interior with natural light',
                categories: ['for_rent', 'long_term', 'room_rental'],
                date: '2024-12-20'
            },
            {
                id: 're-3',
                title: 'Hillside Villa 路 4 Bed',
                price: '$2.1M',
                seller: 'Marina Estates',
                rating: 4.9,
                reviews: 214,
                city: 'Santa Barbara',
                country: 'United States',
                location: 'Hillside, Santa Barbara',
                meta: 'Private estate 路 Pool 路 Smart home',
                description: 'Private hillside villa with panoramic views, resort-style pool, and smart home automation.',
                tags: ['For sale', 'Luxury', 'Gated'],
                badge: 'Premium',
                propertyType: 'Villa',
                bedrooms: 4,
                bathrooms: 3.5,
                sqft: 3200,
                availableOn: 'By appointment',
                amenities: 'Pool, smart home, gated entry',
                images: [
                    'https://images.unsplash.com/photo-1502673530728-f79b4cab31b1?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1507089947368-19c1da9775ae?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1502005229762-cf1b2da7c5d6?auto=format&fit=crop&w=800&h=560'
                ],
                alt: 'Modern villa exterior',
                categories: ['for_sale', 'house'],
                date: '2024-12-19'
            },
            {
                id: 're-4',
                title: 'Harborview Condo 路 2 Bed',
                price: '$980k',
                seller: 'Bayline Property Group',
                rating: 4.8,
                reviews: 178,
                city: 'Seattle',
                country: 'United States',
                location: 'Waterfront, Seattle',
                meta: 'Waterfront 路 1,120 sq ft 路 Move-in ready',
                description: 'Waterfront condo with floor-to-ceiling windows, renovated kitchen, and marina access.',
                tags: ['For sale', 'Condo', 'Transit'],
                badge: 'Top Seller',
                propertyType: 'Condo',
                bedrooms: 2,
                bathrooms: 2,
                sqft: 1120,
                availableOn: 'Now',
                amenities: 'Marina access, renovated kitchen, transit nearby',
                images: [
                    'https://images.unsplash.com/photo-1501183638710-841dd1904471?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=800&h=560',
                    'https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&w=800&h=560'
                ],
                alt: 'Modern condo living room',
                categories: ['for_sale', 'condo'],
                date: '2024-12-18'
            }
        ];

        this.vehicleListings = [
            {
                id: 'veh-1',
                title: '2024 Porsche Taycan Turbo',
                price: '$124,900',
                priceValue: 124900,
                make: 'Porsche',
                model: 'Taycan',
                condition: 'used',
                year: 2024,
                mileageKm: 12000,
                city: 'Los Angeles',
                country: 'United States',
                seller: 'Executive Auto Group',
                date: '2025-12-20',
                category: 'repairs',
                image: 'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-2',
                title: 'Lamborghini Aventador SVJ',
                price: '$899/day',
                priceValue: 899,
                make: 'Lamborghini',
                model: 'Aventador',
                condition: 'used',
                year: 2021,
                mileageKm: 18000,
                city: 'Dubai',
                country: 'United Arab Emirates',
                seller: 'Elite Chauffeur',
                date: '2025-12-20',
                category: 'rentals',
                image: 'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-3',
                title: 'Rolls-Royce Ghost',
                price: '$2,150/day',
                priceValue: 2150,
                make: 'Rolls-Royce',
                model: 'Ghost',
                condition: 'used',
                year: 2022,
                mileageKm: 24000,
                city: 'London',
                country: 'United Kingdom',
                seller: 'Black Label Motors',
                date: '2025-12-19',
                category: 'detailing',
                image: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1441148345475-03a2e82f9719?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-4',
                title: 'Maybach GLS 600',
                price: '$189,000',
                priceValue: 189000,
                make: 'Mercedes-Benz',
                model: 'GLS',
                condition: 'new',
                year: 2024,
                mileageKm: 900,
                city: 'Monaco',
                country: 'Monaco',
                seller: 'Prestige Garage',
                date: '2025-12-18',
                category: 'auto_parts',
                image: 'https://images.unsplash.com/photo-1441148345475-03a2e82f9719?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1441148345475-03a2e82f9719?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-5',
                title: '2020 Toyota Corolla',
                price: '$14,200',
                priceValue: 14200,
                make: 'Toyota',
                model: 'Corolla',
                condition: 'used',
                year: 2020,
                mileageKm: 68000,
                city: 'Accra',
                country: 'Ghana',
                seller: 'Tonaton Motors',
                date: '2025-12-17',
                category: 'other',
                image: 'https://images.unsplash.com/photo-1541899481282-d53bffe3c35d?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1541899481282-d53bffe3c35d?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1511919884226-fd3cad34687c?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-6',
                title: '2019 Honda Civic',
                price: '$16,900',
                priceValue: 16900,
                make: 'Honda',
                model: 'Civic',
                condition: 'used',
                year: 2019,
                mileageKm: 54000,
                city: 'Kumasi',
                country: 'Ghana',
                seller: 'City Autos',
                date: '2025-12-17',
                category: 'repairs',
                image: 'https://images.unsplash.com/photo-1605515298946-dc9d3c4c30b1?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1605515298946-dc9d3c4c30b1?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1525609004556-c46c7d6cf023?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-7',
                title: '2021 BMW X5 xDrive40i',
                price: '$52,500',
                priceValue: 52500,
                make: 'BMW',
                model: 'X5',
                condition: 'used',
                year: 2021,
                mileageKm: 39000,
                city: 'Toronto',
                country: 'Canada',
                seller: 'Northline Auto',
                date: '2025-12-16',
                category: 'detailing',
                image: 'https://images.unsplash.com/photo-1555215695-3004980ad54e?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1555215695-3004980ad54e?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-8',
                title: '2022 Tesla Model S',
                price: '$78,900',
                priceValue: 78900,
                make: 'Tesla',
                model: 'Model S',
                condition: 'used',
                year: 2022,
                mileageKm: 21000,
                city: 'San Francisco',
                country: 'United States',
                seller: 'EV Select',
                date: '2025-12-16',
                category: 'auto_parts',
                image: 'https://images.unsplash.com/photo-1617788138017-80ad40651399?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1617788138017-80ad40651399?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-9',
                title: 'Mercedes-Benz C300 (Detailing Package)',
                price: '$249',
                priceValue: 249,
                make: 'Mercedes-Benz',
                model: 'C-Class',
                condition: 'used',
                year: 2018,
                mileageKm: 86000,
                city: 'Berlin',
                country: 'Germany',
                seller: 'Crystal Detail',
                date: '2025-12-15',
                category: 'detailing',
                image: 'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=600&h=420&sat=-20',
                images: [
                    'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1200&h=800&sat=-20',
                    'https://images.unsplash.com/photo-1441148345475-03a2e82f9719?auto=format&fit=crop&w=1200&h=800&sat=-15'
                ]
            },
            {
                id: 'veh-10',
                title: 'Ford Ranger (Tires & Rims)',
                price: '$1,120',
                priceValue: 1120,
                make: 'Ford',
                model: 'Ranger',
                condition: 'used',
                year: 2020,
                mileageKm: 74000,
                city: 'Cape Town',
                country: 'South Africa',
                seller: 'RimHaus',
                date: '2025-12-15',
                category: 'tires_rims',
                image: 'https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1525609004556-c46c7d6cf023?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-11',
                title: 'Nissan Patrol (Rental)',
                price: '$180/day',
                priceValue: 180,
                make: 'Nissan',
                model: 'Patrol',
                condition: 'used',
                year: 2021,
                mileageKm: 43000,
                city: 'Dubai',
                country: 'United Arab Emirates',
                seller: 'Desert Rentals',
                date: '2025-12-14',
                category: 'rentals',
                image: 'https://images.unsplash.com/photo-1550355291-bbee04a92027?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1550355291-bbee04a92027?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1511919884226-fd3cad34687c?auto=format&fit=crop&w=1200&h=800'
                ]
            },
            {
                id: 'veh-12',
                title: 'Audi Q7 (Service & Inspection)',
                price: '$199',
                priceValue: 199,
                make: 'Audi',
                model: 'Q7',
                condition: 'used',
                year: 2017,
                mileageKm: 102000,
                city: 'London',
                country: 'United Kingdom',
                seller: 'Prime Service Bay',
                date: '2025-12-13',
                category: 'repairs',
                image: 'https://images.unsplash.com/photo-1519641471654-76ce0107ad1b?auto=format&fit=crop&w=600&h=420',
                images: [
                    'https://images.unsplash.com/photo-1519641471654-76ce0107ad1b?auto=format&fit=crop&w=1200&h=800',
                    'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=1200&h=800'
                ]
            }
        ];

        this.loadVehicleState();

        // Geo filter metadata
        this.countryDistanceMap = {
            'United States': 10,
            'Canada': 900,
            'Mexico': 1300,
            'Japan': 8300,
            'South Africa': 16600,
            'Portugal': 9100,
            'India': 13400,
            'United Kingdom': 8600,
            'Germany': 9100,
            'Australia': 11900,
            'Singapore': 13500,
            'Brazil': 10700
        };
        this.countryFlagMap = {
            'United States': '吼',
            'Canada': '',
            'Mexico': '拆',
            'Japan': '',
            'South Africa': '筐',
            'Portugal': '叼',
            'India': '',
            'United Kingdom': '',
            'Germany': '',
            'Australia': '',
            'Singapore': '葛',
            'Brazil': 'ю'
        };
        // Companionship location metadata
        this.companionshipLocations = {
            'United States': {
                regions: {
                    'California': ['San Francisco', 'Los Angeles', 'San Diego'],
                    'New York': ['New York City', 'Buffalo'],
                    'Texas': ['Austin', 'Dallas'],
                    'Florida': ['Miami', 'Orlando'],
                    'Illinois': ['Chicago'],
                    'Washington': ['Seattle']
                }
            },
            'Canada': {
                regions: {
                    'Ontario': ['Toronto', 'Ottawa'],
                    'British Columbia': ['Vancouver', 'Victoria'],
                    'Quebec': ['Montreal']
                }
            },
            'United Kingdom': {
                regions: {
                    'England': ['London', 'Manchester'],
                    'Scotland': ['Edinburgh'],
                    'Northern Ireland': ['Belfast']
                }
            },
            'Australia': {
                regions: {
                    'New South Wales': ['Sydney'],
                    'Victoria': ['Melbourne'],
                    'Queensland': ['Brisbane']
                }
            },
            'India': {
                regions: {
                    'Karnataka': ['Bengaluru'],
                    'Maharashtra': ['Mumbai'],
                    'Delhi NCR': ['New Delhi'],
                    'Tamil Nadu': ['Chennai']
                }
            },
            'Germany': {
                regions: {
                    'Berlin': ['Berlin'],
                    'Bavaria': ['Munich'],
                    'North Rhine-Westphalia': ['Cologne'],
                    'Hamburg': ['Hamburg']
                }
            },
            'France': {
                regions: {
                    'Ile-de-France': ['Paris'],
                    'Provence-Alpes-Cote d\'Azur': ['Nice'],
                    'Auvergne-Rhone-Alpes': ['Lyon']
                }
            },
            'Spain': {
                regions: {
                    'Community of Madrid': ['Madrid'],
                    'Catalonia': ['Barcelona'],
                    'Andalusia': ['Seville']
                }
            },
            'Italy': {
                regions: {
                    'Lazio': ['Rome'],
                    'Lombardy': ['Milan'],
                    'Campania': ['Naples']
                }
            },
            'Japan': {
                regions: {
                    'Tokyo Prefecture': ['Tokyo'],
                    'Osaka Prefecture': ['Osaka'],
                    'Kyoto Prefecture': ['Kyoto']
                }
            },
            'Mexico': {
                regions: {
                    'Mexico City': ['Mexico City'],
                    'Jalisco': ['Guadalajara'],
                    'Nuevo Leon': ['Monterrey']
                }
            },
            'Brazil': {
                regions: {
                    'Sao Paulo': ['Sao Paulo'],
                    'Rio de Janeiro': ['Rio de Janeiro'],
                    'Bahia': ['Salvador']
                }
            },
            'South Africa': {
                regions: {
                    'Western Cape': ['Cape Town'],
                    'Gauteng': ['Johannesburg'],
                    'KwaZulu-Natal': ['Durban']
                }
            },
            'United Arab Emirates': {
                regions: {
                    'Dubai': ['Dubai'],
                    'Abu Dhabi': ['Abu Dhabi']
                }
            },
            'Singapore': {
                regions: {
                    'Singapore': ['Singapore']
                }
            }
        };
        this.companionshipCityGeo = {
            'San Francisco|United States': { lat: 37.7749, lng: -122.4194 },
            'Los Angeles|United States': { lat: 34.0522, lng: -118.2437 },
            'San Diego|United States': { lat: 32.7157, lng: -117.1611 },
            'New York City|United States': { lat: 40.7128, lng: -74.006 },
            'Buffalo|United States': { lat: 42.8864, lng: -78.8784 },
            'Austin|United States': { lat: 30.2672, lng: -97.7431 },
            'Dallas|United States': { lat: 32.7767, lng: -96.797 },
            'Miami|United States': { lat: 25.7617, lng: -80.1918 },
            'Orlando|United States': { lat: 28.5383, lng: -81.3792 },
            'Chicago|United States': { lat: 41.8781, lng: -87.6298 },
            'Seattle|United States': { lat: 47.6062, lng: -122.3321 },
            'Toronto|Canada': { lat: 43.6532, lng: -79.3832 },
            'Ottawa|Canada': { lat: 45.4215, lng: -75.6972 },
            'Vancouver|Canada': { lat: 49.2827, lng: -123.1207 },
            'Victoria|Canada': { lat: 48.4284, lng: -123.3656 },
            'Montreal|Canada': { lat: 45.5017, lng: -73.5673 },
            'London|United Kingdom': { lat: 51.5074, lng: -0.1278 },
            'Manchester|United Kingdom': { lat: 53.4808, lng: -2.2426 },
            'Edinburgh|United Kingdom': { lat: 55.9533, lng: -3.1883 },
            'Belfast|United Kingdom': { lat: 54.5973, lng: -5.9301 },
            'Sydney|Australia': { lat: -33.8688, lng: 151.2093 },
            'Melbourne|Australia': { lat: -37.8136, lng: 144.9631 },
            'Brisbane|Australia': { lat: -27.4698, lng: 153.0251 },
            'Bengaluru|India': { lat: 12.9716, lng: 77.5946 },
            'Mumbai|India': { lat: 19.076, lng: 72.8777 },
            'New Delhi|India': { lat: 28.6139, lng: 77.209 },
            'Chennai|India': { lat: 13.0827, lng: 80.2707 },
            'Berlin|Germany': { lat: 52.52, lng: 13.405 },
            'Munich|Germany': { lat: 48.1351, lng: 11.582 },
            'Cologne|Germany': { lat: 50.9375, lng: 6.9603 },
            'Hamburg|Germany': { lat: 53.5511, lng: 9.9937 },
            'Paris|France': { lat: 48.8566, lng: 2.3522 },
            'Nice|France': { lat: 43.7102, lng: 7.262 },
            'Lyon|France': { lat: 45.764, lng: 4.8357 },
            'Madrid|Spain': { lat: 40.4168, lng: -3.7038 },
            'Barcelona|Spain': { lat: 41.3851, lng: 2.1734 },
            'Seville|Spain': { lat: 37.3891, lng: -5.9845 },
            'Rome|Italy': { lat: 41.9028, lng: 12.4964 },
            'Milan|Italy': { lat: 45.4642, lng: 9.19 },
            'Naples|Italy': { lat: 40.8518, lng: 14.2681 },
            'Tokyo|Japan': { lat: 35.6895, lng: 139.6917 },
            'Osaka|Japan': { lat: 34.6937, lng: 135.5023 },
            'Kyoto|Japan': { lat: 35.0116, lng: 135.7681 },
            'Mexico City|Mexico': { lat: 19.4326, lng: -99.1332 },
            'Guadalajara|Mexico': { lat: 20.6597, lng: -103.3496 },
            'Monterrey|Mexico': { lat: 25.6866, lng: -100.3161 },
            'Sao Paulo|Brazil': { lat: -23.5505, lng: -46.6333 },
            'Rio de Janeiro|Brazil': { lat: -22.9068, lng: -43.1729 },
            'Salvador|Brazil': { lat: -12.9777, lng: -38.5016 },
            'Cape Town|South Africa': { lat: -33.9249, lng: 18.4241 },
            'Johannesburg|South Africa': { lat: -26.2041, lng: 28.0473 },
            'Durban|South Africa': { lat: -29.8587, lng: 31.0218 },
            'Dubai|United Arab Emirates': { lat: 25.2048, lng: 55.2708 },
            'Abu Dhabi|United Arab Emirates': { lat: 24.4539, lng: 54.3773 },
            'Singapore|Singapore': { lat: 1.3521, lng: 103.8198 }
        };
        this.companionshipFilters = {
            country: '',
            region: '',
            city: '',
            nearMe: false,
            gender: '',
            seeking: '',
            category: '',
            query: '',
            onlineOnly: false,
            sort: 'smart'
        };
        this.companionshipNearMeRadius = 120; // km
        this.companionshipFeedPage = 1;
        this.companionshipFeedPageSize = 20;
        this.companionshipProfiles = [];
        this.companionshipTickerId = null;
        this.datingLocationFeedFilters = { country: '', region: '', city: '', status: 'all' };
        this.nearbyDistanceThreshold = 1500; // km approximation for "nearby" filter
        // Feature flags
        // Enable age gate, but trigger it lazily on premium actions (not on entering the Premium tab)
        this.ageGateEnabled = true;
        this.afterAgeGateAction = null; // continuation to run after verification
        
        this.init();
    }

	    init() {
	        this.initializeNavOrder();
	        this.loadSampleData();
	        this.setupEventListeners();
	        this.setupBrowserNavigation();
	        this.requestLocationPermissionOnLoad();
	        this.hideLoadingScreen();
	        this.showMainApp();
	    }

	    loadSignedInState() {
	        try {
	            return window.localStorage.getItem('hs_signed_in') === 'true';
	        } catch {
	            return false;
	        }
	    }

	    persistSignedInState() {
	        try {
	            window.localStorage.setItem('hs_signed_in', this.isSignedIn ? 'true' : 'false');
	        } catch {}
	    }

	    setSignedIn(signedIn, { email = '' } = {}) {
	        this.isSignedIn = Boolean(signedIn);
	        if (this.isSignedIn && email) {
	            if (!this.currentUser) this.currentUser = {};
	            this.currentUser.email = String(email || '').trim();
	        }
	        this.persistSignedInState();
	    }

	    cancelAuthFlow() {
	        this.pendingAuthAction = null;
	        this.pendingAuthReason = '';
	        this.showMainApp();
	    }

	    requireSignedIn({ reason = 'continue', onAuthed = null } = {}) {
	        if (this.isSignedIn) return true;
	        if (typeof onAuthed === 'function') {
	            this.pendingAuthAction = onAuthed;
	            this.pendingAuthReason = String(reason || '').trim();
	        }
	        this.showNotification(`Please log in to ${reason}.`);
	        this.showLoginScreen();
	        return false;
	    }

	    runPendingAuthAction() {
	        const action = this.pendingAuthAction;
	        this.pendingAuthAction = null;
	        this.pendingAuthReason = '';
	        if (typeof action !== 'function') return;
	        try {
	            action();
	        } catch (err) {
	            console.warn('Pending auth action failed:', err);
	        }
	    }

		    setupBrowserNavigation() {
		        if (this.didSetupBrowserNavigation) return;
		        this.didSetupBrowserNavigation = true;

		        window.addEventListener('popstate', (e) => {
		            const state = e?.state || null;
		            const idx = Number.isFinite(state?.appHistoryIndex) ? state.appHistoryIndex : null;
		            if (idx !== null) {
		                this.browserHistoryIndex = idx;
		                this.browserHistoryMaxIndex = Math.max(this.browserHistoryMaxIndex, idx);
		            }
		            const route = state?.route || this.parseRouteFromLocation();
		            if (!this.didShowMainApp) {
		                this.pendingRoute = route;
		                return;
		            }
		            const targetHash = this.buildHashFromRoute(route);
		            const currentHash = this.buildHashFromRoute(this.getCurrentRoute());
		            if (targetHash !== currentHash) {
		                this.applyRoute(route, { source: 'pop' });
		            }
		            this.applyUiState(state?.ui || null, { source: 'pop' });
		            this.updateNavArrows();
		        });

		        window.addEventListener('hashchange', () => {
		            // Handles manual edits to the URL hash (or external deep links).
		            const route = this.parseRouteFromLocation();
		            if (!this.didShowMainApp) {
		                this.pendingRoute = route;
		                return;
		            }
		            this.applyRoute(route, { source: 'hash' });
		            this.applyUiState(null, { source: 'hash' });
		            // Ensure history.state stays consistent with the URL without adding an entry.
		            this.updateBrowserRoute(this.getCurrentRoute(), { replace: true });
		            this.updateNavArrows();
		        });
		    }

	    parseRouteFromLocation() {
	        return this.parseRouteFromHash(window.location.hash || '');
	    }

	    parseRouteFromHash(hash = '') {
	        const raw = String(hash || '').replace(/^#/, '');
	        if (!raw) return { screen: 'home' };

	        const [pathPart, queryPart] = raw.split('?');
	        const parts = String(pathPart || '').split('/').filter(Boolean).map((p) => {
	            try { return decodeURIComponent(p); } catch { return p; }
	        });
	        const screen = parts[0] || 'home';
	        const sub = parts[1] || '';
	        const params = new URLSearchParams(queryPart || '');

	        const route = { screen };
	        if (screen === 'dating') {
	            route.datingCategory = sub || params.get('category') || params.get('dating') || '';
	        }
	        return route;
	    }

	    buildHashFromRoute(route) {
	        const screen = String(route?.screen || 'home').trim() || 'home';
	        const base = encodeURIComponent(screen);
	        if (screen === 'dating') {
	            const category = String(route?.datingCategory || '').trim();
	            if (category) return `#${base}/${encodeURIComponent(category)}`;
	        }
	        return `#${base}`;
	    }

	    resolveScreenName(screen) {
	        const key = String(screen || '').trim();
	        if (!key) return 'home';
	        const el = document.getElementById(`${key}-content`);
	        return el ? key : 'home';
	    }

	    getCurrentRoute() {
	        const screen = this.activeScreen || 'home';
	        if (screen === 'dating' && this.currentDatingCategory) {
	            return { screen: 'dating', datingCategory: this.currentDatingCategory };
	        }
	        return { screen };
	    }

		    updateBrowserRoute(route, { replace = false } = {}) {
		        const nextHash = this.buildHashFromRoute(route);
		        const currentState = window.history.state || {};
		        const currentIndex = Number.isFinite(currentState?.appHistoryIndex)
		            ? currentState.appHistoryIndex
		            : (Number.isFinite(this.browserHistoryIndex) ? this.browserHistoryIndex : 0);
		        const nextIndex = (window.location.hash === nextHash)
		            ? currentIndex
		            : (replace ? currentIndex : currentIndex + 1);

		        if (window.location.hash === nextHash) {
		            // Keep state in sync even if URL didn't change.
		            try {
		                const state = { app: '6ixo', route, appHistoryIndex: nextIndex };
		                window.history.replaceState(state, '', nextHash);
		            } catch {}
		            this.browserHistoryIndex = nextIndex;
		            this.browserHistoryMaxIndex = Math.max(this.browserHistoryMaxIndex, nextIndex);
		            return;
		        }
		        try {
		            const state = { app: '6ixo', route, appHistoryIndex: nextIndex };
		            if (replace) window.history.replaceState(state, '', nextHash);
		            else window.history.pushState(state, '', nextHash);
		            this.browserHistoryIndex = nextIndex;
		            this.browserHistoryMaxIndex = Math.max(this.browserHistoryMaxIndex, nextIndex);
		        } catch {
		            // Fallback: hash navigation (still provides back/forward support).
		            window.location.hash = nextHash;
		        }
		    }

		    updateBrowserUiState(ui, { replace = false } = {}) {
		        const route = this.getCurrentRoute();
		        const url = `${window.location.pathname}${window.location.search}${window.location.hash || this.buildHashFromRoute(route)}`;
		        const currentState = window.history.state || {};
		        const currentIndex = Number.isFinite(currentState?.appHistoryIndex)
		            ? currentState.appHistoryIndex
		            : (Number.isFinite(this.browserHistoryIndex) ? this.browserHistoryIndex : 0);
		        const nextIndex = replace ? currentIndex : currentIndex + 1;
		        try {
		            const state = { app: '6ixo', route, appHistoryIndex: nextIndex, ui };
		            if (replace) window.history.replaceState(state, '', url);
		            else window.history.pushState(state, '', url);
		            this.browserHistoryIndex = nextIndex;
		            this.browserHistoryMaxIndex = Math.max(this.browserHistoryMaxIndex, nextIndex);
		        } catch {
		            // ignore
		        }
		    }

		    applyUiState(ui, { source = 'unknown' } = {}) {
		        if (this.isApplyingUiState) return;
		        this.isApplyingUiState = true;
		        try {
		            const kind = ui?.kind || '';
		            const modalId = ui?.id || '';

		            if (kind === 'story') {
		                this.hidePostItemModal();
		                this.closeCompanionshipPostModal(false);
		                const items = Array.isArray(ui?.items) ? ui.items : [];
		                const index = Number.isFinite(ui?.index) ? ui.index : 0;
		                this.openStoryOverlay(items, index, { pushState: false });
		                return;
		            }

		            // Close story if we're not explicitly in it.
		            this.closeStoryOverlay({ useHistory: false });

		            if (kind === 'modal' && modalId === 'companionship-post-modal') {
		                this.hidePostItemModal();
		                this.openCompanionshipPostModal({ pushState: false });
		                return;
		            }

		            if (kind === 'modal' && modalId === 'post-item-modal') {
		                this.closeCompanionshipPostModal(false);
		                const options = (ui?.options && typeof ui.options === 'object') ? ui.options : {};
		                this.showPostItemModal({ ...options, pushState: false });
		                return;
		            }

		            // Default: close known overlays/modals.
		            this.closeCompanionshipPostModal(false);
		            this.hidePostItemModal();
		        } finally {
		            this.isApplyingUiState = false;
		        }
		    }

	    applyRoute(route, { source = 'unknown' } = {}) {
	        const resolved = route || {};
	        const screen = this.resolveScreenName(resolved.screen);

	        this.isApplyingRoute = true;
	        try {
            this.switchScreen(screen, { pushState: false });
            if (screen === 'dating') {
                const category = String(resolved.datingCategory || '').trim();
                if (category) this.openDatingCategory(category);
                else this.closeDatingCategory(true);
            }
	        } finally {
	            this.isApplyingRoute = false;
	        }

	        // On initial load, ensure history state is present for a consistent back/forward experience.
	        if (source === 'init') {
	            this.updateBrowserRoute(this.getCurrentRoute(), { replace: true });
	        }
	    }

    // Sample data for demonstration
	    loadSampleData() {
        this.users = [
            {
                id: 1,
                name: "Emma Johnson",
                age: 25,
	                mapVisible: true,
	                photos: [
	                    "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=400&h=600",
                bio: "Love hiking, photography, and good coffee. Looking for someone to explore the city with!",
                interests: ["Photography", "Hiking", "Coffee", "Travel"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Not specified",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Product marketer"
                },
                location: { lat: 37.7749, lng: -122.4194, distance: 2.3, city: 'San Francisco', country: 'United States', region: 'California' },
                online: true,
                isPremium: true,
                profileVideo: "https://samplelib.com/lib/preview/mp4/sample-10s.mp4"
            },
            {
                id: 2,
                name: "Michael Chen",
	                age: 28,
	                mapVisible: true,
	                photos: [
	                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=400&h=600",
                bio: "Software engineer by day, chef by night. Love cooking and trying new restaurants.",
                interests: ["Cooking", "Technology", "Food", "Movies"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Not specified",
                    kids: "Open to kids",
                    education: "Masters",
                    occupation: "Software engineer"
                },
                location: { lat: 43.6532, lng: -79.3832, distance: 1.8, city: 'Toronto', country: 'Canada', region: 'Ontario' },
                online: true,
                isPremium: false
            },
            {
                id: 3,
                name: "Sophia Martinez",
	                age: 24,
	                mapVisible: true,
	                photos: [
	                    "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1531259683007-016a7b628fc3?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=400&h=600",
                bio: "Yoga instructor and wellness enthusiast. Seeking positive vibes and genuine connections.",
                interests: ["Yoga", "Wellness", "Nature", "Reading"],
                lifestylePreferences: {
                    drinking: "No",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Spiritual",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Yoga instructor"
                },
                location: { lat: 38.7223, lng: -9.1393, distance: 3.1, city: 'Lisbon', country: 'Portugal', region: 'Lisbon District' },
                online: false,
                isPremium: true,
                profileVideo: "https://samplelib.com/lib/preview/mp4/sample-10s.mp4"
            },
            {
                id: 4,
                name: "David Kim",
	                age: 30,
	                mapVisible: true,
	                photos: [
	                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1463453091185-61582044d556?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1502767089025-6572583495b0?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=400&h=600",
                bio: "Musician and artist. Love live music, art galleries, and deep conversations.",
                interests: ["Music", "Art", "Culture", "Guitar"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Not specified",
                    kids: "Not sure",
                    education: "Bachelors",
                    occupation: "Musician"
                },
                location: { lat: 35.6762, lng: 139.6503, distance: 4.2, city: 'Tokyo', country: 'Japan', region: 'Tokyo Prefecture' },
                online: true,
                isPremium: false
            },
            {
                id: 5,
                name: "Isabella Brown",
	                age: 26,
	                mapVisible: true,
	                photos: [
	                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650",
	                    "https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&h=600",
                bio: "Marketing professional who loves weekend adventures and trying new activities.",
                interests: ["Adventures", "Marketing", "Fitness", "Wine"],
                lifestylePreferences: {
                    drinking: "Yes",
                    smoking: "No",
                    cannabis: "Sometimes",
                    religion: "Catholic",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Marketing"
                },
                location: { lat: 19.4326, lng: -99.1332, distance: 5.7, city: 'Mexico City', country: 'Mexico', region: 'Mexico City' },
                online: true,
                isPremium: false
            },
            {
                id: 6,
                name: "Ava Patel",
                age: 29,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&h=600",
                bio: "Weekend cyclist and gallery-goer looking for great conversations and city walks.",
                interests: ["Cycling", "Art", "Coffee", "City walks"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Not specified",
                    kids: "Open to kids",
                    education: "Bachelors",
                    occupation: "Designer"
                },
                location: { lat: 51.5074, lng: -0.1278, distance: 6.4, city: 'London', country: 'United Kingdom', region: 'England' },
                online: true,
                isPremium: true
            },
            {
                id: 7,
                name: "Liam Garcia",
                age: 31,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=400&h=600",
                bio: "Live music regular, always scouting new taco spots and late-night shows.",
                interests: ["Music", "Food", "Comedy", "Travel"],
                lifestylePreferences: {
                    drinking: "Yes",
                    smoking: "No",
                    cannabis: "Sometimes",
                    religion: "Not specified",
                    kids: "Not sure",
                    education: "Bachelors",
                    occupation: "Product manager"
                },
                location: { lat: 40.7128, lng: -74.0060, distance: 7.9, city: 'New York', country: 'United States', region: 'New York' },
                online: false,
                isPremium: false
            },
            {
                id: 8,
                name: "Maya Lee",
                age: 26,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1531259683007-016a7b628fc3?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=400&h=600",
                bio: "Bookstore lurker and street-food fan with a soft spot for sunrise hikes.",
                interests: ["Reading", "Street food", "Hiking", "Photography"],
                lifestylePreferences: {
                    drinking: "No",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Buddhist",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Writer"
                },
                location: { lat: 37.5665, lng: 126.9780, distance: 4.9, city: 'Seoul', country: 'South Korea', region: 'Seoul' },
                online: true,
                isPremium: false
            },
            {
                id: 9,
                name: "Noah Wilson",
                age: 27,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1463453091185-61582044d556?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1502767089025-6572583495b0?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1463453091185-61582044d556?auto=format&fit=crop&w=400&h=600",
                bio: "Sunrise surfer and weekend market explorer. Looking for easy laughs.",
                interests: ["Surfing", "Markets", "Cooking", "Outdoors"],
                lifestylePreferences: {
                    drinking: "Yes",
                    smoking: "No",
                    cannabis: "Sometimes",
                    religion: "Not specified",
                    kids: "Open to kids",
                    education: "Bachelors",
                    occupation: "Marketing"
                },
                location: { lat: -33.8688, lng: 151.2093, distance: 8.6, city: 'Sydney', country: 'Australia', region: 'New South Wales' },
                online: true,
                isPremium: true
            },
            {
                id: 10,
                name: "Zoe Ahmed",
                age: 28,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&h=600",
                bio: "Design lead who loves rooftop sunsets, strong coffee, and new travel stories.",
                interests: ["Design", "Travel", "Coffee", "Photography"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Muslim",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Design lead"
                },
                location: { lat: 25.2048, lng: 55.2708, distance: 9.8, city: 'Dubai', country: 'United Arab Emirates', region: 'Dubai' },
                online: false,
                isPremium: false
            },
            {
                id: 11,
                name: "Ethan Brooks",
                age: 32,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=400&h=600",
                bio: "Road trip fan and amateur chef. Always down for a coastal drive.",
                interests: ["Road trips", "Cooking", "Hiking", "Photography"],
                lifestylePreferences: {
                    drinking: "Yes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Not specified",
                    kids: "Have kids",
                    education: "Bachelors",
                    occupation: "Chef"
                },
                location: { lat: -33.9249, lng: 18.4241, distance: 6.2, city: 'Cape Town', country: 'South Africa', region: 'Western Cape' },
                online: true,
                isPremium: false
            },
            {
                id: 12,
                name: "Chloe Rossi",
                age: 25,
                mapVisible: true,
                photos: [
                    "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=500&h=650",
                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650"
                ],
                photo: "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=400&h=600",
                bio: "Foodie with a soft spot for classic films and late-night gelato.",
                interests: ["Cinema", "Food", "Museums", "Walking tours"],
                lifestylePreferences: {
                    drinking: "Sometimes",
                    smoking: "No",
                    cannabis: "No",
                    religion: "Catholic",
                    kids: "Want someday",
                    education: "Bachelors",
                    occupation: "Brand strategist"
                },
                location: { lat: 41.9028, lng: 12.4964, distance: 5.1, city: 'Rome', country: 'Italy', region: 'Lazio' },
                online: true,
                isPremium: true
            }
        ];
        this.users.forEach(user => {
            if (!user?.location) return;
            if (typeof user.location.distance !== 'number') return;
            if (typeof user.location.nearbyDistance === 'number') return;
            user.location.nearbyDistance = user.location.distance;
        });

        this.currentUser = {
            id: 0,
            name: "You",
            age: 25,
		            phone: "",
		            mapVisible: false,
		            photos: [
		                "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=500&h=650",
		                "https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650",
		                "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650"
		            ],
            photo: "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=400&h=600",
            bio: "Looking for meaningful connections and new adventures!",
            interests: ["Travel", "Food", "Music"],
            lifestylePreferences: {
                drinking: "Sometimes",
                smoking: "No",
                cannabis: "No",
                religion: "Not specified",
                kids: "Open to kids",
                education: "Bachelors",
                occupation: "Product manager"
            },
	            location: { lat: 37.7749, lng: -122.4194, distance: 0 },
            isPremium: false
        };

        this.datingSchedule = this.loadDatingSchedule();
        this.tripAlerts = this.loadTripAlerts();
        this.notifications = this.loadNotifications();
        this.matchIds = this.loadMatches();

		        try {
		            const saved = localStorage.getItem('hs_map_visible');
		            if (saved === 'true' || saved === 'false') {
		                this.currentUser.mapVisible = saved === 'true';
		            }
		        } catch {}

		        try {
		            const savedPhone = localStorage.getItem('hs_profile_phone');
		            if (savedPhone) this.currentUser.phone = savedPhone;
		        } catch {}

	        // Initialize marketplace data
	        this.marketplaceItems = this.loadSampleMarketplaceItems();
	        this.filteredItems = [...this.marketplaceItems];
	        this.marketplaceSaved = this.loadMarketplaceSaved();
	        this.marketplaceRecent = this.loadMarketplaceRecent();
	        this.serviceProfiles = this.loadSampleServiceProfiles();

        // Initialize discovery feed data
        this.discoveryPosts = this.loadSampleDiscoveryPosts();
        this.filteredPosts = [...this.discoveryPosts];
        this.activeDiscoveryFilter = 'all';
        this.discoveryGeoFilter = 'worldwide';
        this.discoveryCountryFilter = this.currentUser?.location?.country || '';
        this.discoveryCitySearch = '';
        this.discoveryCountrySearch = '';
        this.communityPosts = this.loadSampleCommunityPosts();
        this.filteredCommunityPosts = [...this.communityPosts];
        this.activeCommunityCategory = 'all';
        this.communityFilters = {
            search: '',
            country: '',
            city: '',
            nearMe: false
        };
	        this.companionshipProfiles = this.loadSampleCompanionshipProfiles();
		        this.marketplaceUploads = [];
	        this.postItemStoryFile = null;
        this.postItemStoryPreviewUrl = '';
        this.postItemStoryVideoOk = false;
		        this.myPosts = this.loadMyPosts();
	        this.wallet = this.loadWallet();

			        this.datingSponsoredProfiles = {
	            'dating-ad-1': {
	                id: 'dating-ad-1',
	                name: 'Lina',
	                age: 27,
	                role: 'Spotlight Member',
	                distance: '2km away 路 Berlin, Germany',
	                looking: 'Museum dates, late-night ramen, and someone who loves city walks.',
	                bio: 'Lina is a product marketer whos always planning the next gallery hop. Shes big on calm conversation, great playlists, and weekend farmers markets.',
	                online: false,
	                statusText: 'Offline',
	                highlights: [
	                    'Verification video on file',
	                    'Favorite first date: museum + coffee',
	                    'Replies within a few hours'
	                ],
	                interests: ['Art exhibits', 'City walks', 'Cooking', 'Indie music'],
                lifestyle: {
                    drinking: 'Sometimes',
                    smoking: 'No',
                    cannabis: 'No',
                    religion: 'Spiritual',
                    kids: 'Open to kids',
                    education: 'Bachelors',
                    occupation: 'Product marketing'
                },
	                photos: [
	                    'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1520975682031-a37e5a0a4c19?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1000&h=1330'
	                ]
	            },
	            'dating-ad-2': {
	                id: 'dating-ad-2',
	                name: 'Jade',
	                age: 29,
	                role: 'Spotlight Member',
	                distance: '5km away 路 San Francisco, USA',
	                looking: 'A partner-in-crime for coffee crawls and spontaneous weekend trips.',
	                bio: 'Jade works in tech and spends her evenings testing new food spots. She loves playful banter, honest conversations, and being outside whenever possible.',
	                online: true,
	                statusText: 'Online now',
	                highlights: [
	                    'Replies fast 路 Verified',
	                    'Down for a sunset walk',
	                    'Loves trying new restaurants'
	                ],
	                interests: ['Coffee', 'Food spots', 'Hiking', 'Travel'],
                lifestyle: {
                    drinking: 'Yes',
                    smoking: 'No',
                    cannabis: 'Sometimes',
                    religion: 'Not specified',
                    kids: 'Want someday',
                    education: 'Bachelors',
                    occupation: 'Product designer'
                },
	                photos: [
	                    'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=1000&h=1330'
	                ]
	            },
	            'dating-ad-3': {
	                id: 'dating-ad-3',
	                name: 'Sam',
	                age: 32,
	                role: 'Spotlight Member',
	                distance: 'Near you 路 Toronto, Canada',
	                looking: 'Someone kind who likes deep talks and low-key adventures.',
	                bio: 'Sam is into live shows, great books, and weekend road trips. Friends describe Sam as grounded, funny, and always up for exploring a new neighborhood.',
	                online: false,
	                statusText: 'Offline',
	                highlights: [
	                    'Vouches available',
	                    'Favorite vibe: live music + tacos',
	                    'Prefers respectful, real conversations'
	                ],
	                interests: ['Live music', 'Books', 'Road trips', 'Photography'],
                lifestyle: {
                    drinking: 'Sometimes',
                    smoking: 'No',
                    cannabis: 'No',
                    religion: 'Not specified',
                    kids: 'Open to kids',
                    education: 'Masters',
                    occupation: 'Photographer'
                },
	                photos: [
	                    'https://images.unsplash.com/photo-1509631179647-0177331693ae?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=1000&h=1330'
	                ]
	            },
	            'dating-ad-4': {
	                id: 'dating-ad-4',
	                name: 'Sofia',
	                age: 24,
	                role: 'Spotlight Member',
	                distance: 'Offline 路 Lisbon, Portugal',
	                looking: 'Cute dates: bookstores, beaches, and a good playlist.',
	                bio: 'Sofia is a creative whos always collecting recommendations for hidden spots. Shes into slow mornings, trying new caf茅s, and exploring on foot.',
	                online: false,
	                statusText: 'Offline',
	                highlights: [
	                    'Open to museum dates',
	                    'Great at planning the perfect itinerary',
	                    'Big on safety and respect'
	                ],
	                interests: ['Bookstores', 'Beaches', 'Caf茅s', 'Photography'],
                lifestyle: {
                    drinking: 'Yes',
                    smoking: 'No',
                    cannabis: 'No',
                    religion: 'Catholic',
                    kids: 'Want someday',
                    education: 'Bachelors',
                    occupation: 'Creative director'
                },
	                photos: [
	                    'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1504753793650-d4a2b783c15e?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1000&h=1330'
	                ]
	            },
	            'dating-ad-5': {
	                id: 'dating-ad-5',
	                name: 'Michael',
	                age: 28,
	                role: 'Spotlight Member',
	                distance: 'Online now 路 Toronto, Canada',
	                looking: 'Foodie dates, city walks, and someone who laughs easily.',
	                bio: 'Michael loves checking out new restaurants, working out, and exploring the city. Hes friendly, thoughtful, and always down for a good conversation.',
	                online: true,
	                statusText: 'Online now',
	                highlights: [
	                    'Foodie 路 City walks',
	                    'Down for brunch anytime',
	                    'Enjoys concerts + sports'
	                ],
	                interests: ['Restaurants', 'Gym', 'City walks', 'Concerts'],
                lifestyle: {
                    drinking: 'Sometimes',
                    smoking: 'No',
                    cannabis: 'No',
                    religion: 'Not specified',
                    kids: 'Have kids',
                    education: 'Bachelors',
                    occupation: 'Entrepreneur'
                },
	                photos: [
	                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=1000&h=1330',
	                    'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=1000&h=1330'
	                ]
	            }
	        };
	        this.activeDemoProfile = null;
	        this.boundDemoProfileKeydown = (e) => this.handleDemoProfileKeydown(e);

        // Dating category metadata
	        this.datingCategoryLabels = {
            serious_long_term: "Serious Relationship / Long-Term",
            casual_dating: "Casual Dating",
            friendship: "Friendship",
            travel_vacation: "Travel or Vacation Dating",
            networking_social: "Networking / Social Connections",
	            companionship: "Companionship",
	            arrive_plus: "Arrive+",
	            instant_meetups: "Hookup+",
	            virtual_video: "Virtual Dating / Video Chat",
	            exclusive_premium: "Exclusive / Premium Dating",
	            premium_18_plus: "Mature Dating (18+)"
	        };
        this.datingCategoryFeeds = this.loadSampleDatingCategoryFeeds();

        this.datingProfiles = [
          { id:'u1', name:'Ava', bio:'Hiking, coffee, tech.', photos:[
            'images/ava1.jpg','images/ava2.jpg','images/ava3.jpg'
          ]},
          { id:'u2', name:'Liam', bio:'Music and travel.', photos:[
            'images/liam1.jpg','images/liam2.jpg','images/liam3.jpg','images/liam4.jpg'
          ]},
          // ...
        ];
    }

    loadSampleMarketplaceItems() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const week = new Date(today);
        week.setDate(today.getDate() - 7);
        const twoDays = new Date(today);
        twoDays.setDate(today.getDate() - 2);
        const threeDays = new Date(today);
        threeDays.setDate(today.getDate() - 3);

        return [
            {
                id: 1,
                title: "iPhone 14 Pro - Like New",
                category: "electronics",
                electronicsCategory: "phones_accessories",
                price: 899,
                city: "San Francisco",
                description: "Barely used iPhone 14 Pro, 256GB. All original accessories included. No scratches or damage.",
                seller: "Emma Johnson",
                postedDate: today,
                condition: "like_new",
                brand: "Apple",
                model: "iPhone 14 Pro",
                electronicsBadges: ["Unlocked", "AppleCare+"],
                featured: true,
                images: [
                    "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1510557880182-3d4d3cba35a5?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1512499617640-c2f999018b72?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 2,
                title: "Vintage Leather Jacket",
                category: "clothing",
                price: 120,
                city: "San Francisco",
                description: "Authentic vintage leather jacket from the 80s. Size M. Perfect condition.",
                seller: "Michael Chen",
                postedDate: today,
                condition: "good",
                brand: "Vintage",
                model: "Leather Jacket",
                tags: ["streetwear", "vintage", "used", "size m"],
                images: [
                    "https://images.unsplash.com/photo-1551028719-00167b16eac5?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1520975682031-a37e5a0a4c19?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1520975867597-0dfb34c0f2d9?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 3,
                title: "Mountain Bike - Trek 2022",
                category: "sports",
                price: 650,
                city: "Oakland",
                description: "Excellent condition Trek mountain bike. Used only a few times. Great for trails.",
                seller: "Sophia Martinez",
                postedDate: yesterday,
                images: [
                    "https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1544191696-102c7c6fdc9f?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 4,
                title: "Coffee Table - Modern Design",
                category: "home",
                price: 180,
                city: "Berkeley",
                description: "Beautiful modern coffee table. Walnut finish. Moving sale.",
                seller: "David Kim",
                postedDate: today,
                images: [
                    "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1519710164239-da123dc03ef4?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1505693314120-0d443867891c?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 5,
                title: "MacBook Pro 2021",
                category: "electronics",
                electronicsCategory: "computers_tablets",
                price: 1200,
                city: "San Jose",
                description: "MacBook Pro 14-inch, M1 Pro chip, 512GB. Excellent for work or creative projects.",
                seller: "Isabella Brown",
                postedDate: week,
                condition: "excellent",
                brand: "Apple",
                model: "MacBook Pro 14",
                electronicsBadges: ["M1 Pro", "512GB"],
                featured: true,
                images: [
                    "https://images.unsplash.com/photo-1541807084-5c52b6b3adef?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 17,
                title: "LG C2 OLED 55\" 4K TV",
                category: "electronics",
                electronicsCategory: "tv_video_home_theatre",
                price: 1150,
                city: "Seattle",
                description: "OLED panel with deep blacks, 120Hz refresh, and ultra-low input lag. Includes wall mount kit.",
                seller: "NorthwestAV",
                postedDate: yesterday,
                condition: "excellent",
                brand: "LG",
                model: "C2 OLED",
                electronicsBadges: ["OLED", "4K HDR"],
                featured: true,
                images: [
                    "https://images.unsplash.com/photo-1519583159771-0fcf4f25f1ee?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1519710164239-da123dc03ef4?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 18,
                title: "Bose QuietComfort 45",
                category: "electronics",
                electronicsCategory: "audio_headphones",
                price: 199,
                city: "New York",
                description: "Comfortable noise canceling headphones with case, cables, and extra ear pads.",
                seller: "Studio Sound",
                postedDate: today,
                condition: "good",
                brand: "Bose",
                model: "QC45",
                electronicsBadges: ["Noise canceling", "Bluetooth"],
                images: [
                    "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1484704849700-f032a568e944?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 19,
                title: "PlayStation 5 Disc Edition",
                category: "electronics",
                electronicsCategory: "gaming_consoles",
                price: 480,
                city: "Austin",
                description: "PS5 disc version with 2 controllers and charging dock. Box included.",
                seller: "LoneStar Gaming",
                postedDate: twoDays,
                condition: "like_new",
                brand: "Sony",
                model: "PlayStation 5",
                electronicsBadges: ["Bundle", "2 controllers"],
                featured: true,
                images: [
                    "https://images.unsplash.com/photo-1606813907291-d86efa9b94db?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1511512578047-dfb367046420?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1607853202273-797f1c22a38e?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 20,
                title: "Sony A7 IV Mirrorless Body",
                category: "electronics",
                electronicsCategory: "cameras_photography",
                price: 2050,
                city: "Los Angeles",
                description: "Low shutter count, includes battery grip and dual chargers. Perfect for hybrid shoots.",
                seller: "FrameFoundry",
                postedDate: threeDays,
                condition: "excellent",
                brand: "Sony",
                model: "A7 IV",
                electronicsBadges: ["4K 60fps", "8k shutter"],
                images: [
                    "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1517632298124-11f7fcb0f5a6?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 21,
                title: "iPad Air (5th Gen) 256GB",
                category: "electronics",
                electronicsCategory: "computers_tablets",
                price: 520,
                city: "Chicago",
                description: "Space Gray iPad Air with box, charger, and paperlike screen protector.",
                seller: "Midwest Tech",
                postedDate: week,
                condition: "like_new",
                brand: "Apple",
                model: "iPad Air",
                electronicsBadges: ["Wi-Fi", "Apple Pencil"],
                images: [
                    "https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1522199755839-a2bacb67c546?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1518770660439-4636190af475?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 22,
                title: "Pixel 7 Screen Replacement Kit",
                category: "electronics",
                electronicsCategory: "repair_parts_accessories",
                price: 45,
                city: "Denver",
                description: "OEM-grade screen with tools, adhesive, and detailed install guide.",
                seller: "FixLab Supply",
                postedDate: today,
                condition: "new",
                brand: "Google",
                model: "Pixel 7",
                electronicsBadges: ["OEM part", "Tools included"],
                images: [
                    "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1531297484001-80022131f5a1?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 23,
                title: "Smart Home Hub + Sensor Pack",
                category: "electronics",
                electronicsCategory: "other",
                price: 130,
                city: "Boston",
                description: "Hub with motion and door sensors. Works with voice assistants and app automation.",
                seller: "Harbor Smart",
                postedDate: twoDays,
                condition: "excellent",
                brand: "Aqara",
                model: "M2 Hub",
                electronicsBadges: ["Matter ready", "Voice control"],
                images: [
                    "https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1518770660439-4636190af475?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1518770660439-4636190af475?w=900&auto=format&fit=crop&sat=-10"
                ]
            },
            {
                id: 24,
                title: "Nintendo Switch OLED",
                category: "electronics",
                electronicsCategory: "gaming_consoles",
                price: 295,
                city: "San Diego",
                description: "Switch OLED with dock, case, and 128GB card. Minor scuffs on dock only.",
                seller: "Coastline Games",
                postedDate: yesterday,
                condition: "good",
                brand: "Nintendo",
                model: "Switch OLED",
                electronicsBadges: ["OLED", "Portable"],
                images: [
                    "https://images.unsplash.com/photo-1606813907291-d86efa9b94db?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1587202372775-e229f172b9d1?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542751371-adc38448a05e?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 6,
                title: "Nike Dunk Low Panda (Size 10)",
                category: "clothing",
                price: 260,
                city: "Los Angeles",
                description: "Deadstock pair, never worn. Original box included. Size 10.",
                seller: "SneakerVault",
                postedDate: today,
                condition: "new",
                brand: "Nike",
                model: "Dunk Low",
                tags: ["sneakers", "deadstock", "reseller", "size 10", "bid", "men"],
                images: [
                    "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=900&auto=format&fit=crop&sat=-10",
                    "https://images.unsplash.com/photo-1514989940723-e8e51635b782?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 7,
                title: "Jordan 4 Retro Bred (Size 9.5)",
                category: "clothing",
                price: 420,
                city: "New York",
                description: "Light wear, clean soles. Includes extra laces. Size 9.5.",
                seller: "FourthQuarter",
                postedDate: yesterday,
                condition: "good",
                brand: "Jordan",
                model: "Retro 4",
                tags: ["sneakers", "used", "size 9.5", "streetwear", "men"],
                images: [
                    "https://images.unsplash.com/photo-1514989940723-e8e51635b782?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=900&auto=format&fit=crop&sat=-15",
                    "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 8,
                title: "Vintage Carhartt Detroit Jacket",
                category: "clothing",
                price: 150,
                city: "Chicago",
                description: "Vintage Detroit jacket, fits M/L. Broken-in canvas, no rips.",
                seller: "ArchiveRoom",
                postedDate: twoDays,
                condition: "used",
                brand: "Carhartt",
                model: "Detroit Jacket",
                tags: ["streetwear", "vintage", "used", "reseller", "men"],
                images: [
                    "https://images.unsplash.com/photo-1520975682031-a37e5a0a4c19?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1520975867597-0dfb34c0f2d9?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 9,
                title: "Yeezy Slide Onyx (Size 11)",
                category: "clothing",
                price: 0,
                city: "Miami",
                description: "Brand new slides. Giving away to clear space. Size 11.",
                seller: "FreeDrop",
                postedDate: today,
                condition: "new",
                brand: "Adidas",
                model: "Yeezy Slide",
                tags: ["free", "sneakers", "size 11", "deadstock", "men"],
                images: [
                    "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1441984904996-e0b6ba687e04?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 10,
                title: "Supreme Box Logo Hoodie (Size L)",
                category: "clothing",
                price: 360,
                city: "Toronto",
                description: "Worn twice, flawless condition. Accepting bids.",
                seller: "NorthsideHeat",
                postedDate: threeDays,
                condition: "like_new",
                brand: "Supreme",
                model: "Box Logo",
                tags: ["streetwear", "bidding", "reseller", "size l", "men"],
                images: [
                    "https://images.unsplash.com/photo-1441984904996-e0b6ba687e04?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1490481651871-ab68de25d43d?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 11,
                title: "Chrome Hearts Ring",
                category: "clothing",
                price: 220,
                city: "Houston",
                description: "Sterling silver ring, size 9. Includes pouch.",
                seller: "Vaulted",
                postedDate: twoDays,
                condition: "excellent",
                brand: "Chrome Hearts",
                model: "Cross Ring",
                tags: ["accessories", "reseller", "size 9", "women"],
                images: [
                    "https://images.unsplash.com/photo-1507679799987-c73779587ccf?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1490481651871-ab68de25d43d?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 12,
                title: "Stussy 8 Ball Tee (Size M)",
                category: "clothing",
                price: 45,
                city: "Seattle",
                description: "Clean tee, slight fading. Size M.",
                seller: "WestCoastRack",
                postedDate: week,
                condition: "good",
                brand: "Stussy",
                model: "8 Ball Tee",
                tags: ["streetwear", "used", "size m", "women"],
                images: [
                    "https://images.unsplash.com/photo-1490481651871-ab68de25d43d?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1503341455253-b2e723bb3dbb?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 15,
                title: "Kids Jordan 1 Mid (Size 3Y)",
                category: "clothing",
                price: 95,
                city: "Phoenix",
                description: "Lightly worn, cleaned and ready. Size 3Y.",
                seller: "MiniHeat",
                postedDate: twoDays,
                condition: "good",
                brand: "Jordan",
                model: "1 Mid",
                tags: ["kids", "youth", "sneakers", "size 3y"],
                images: [
                    "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 13,
                title: "Retail Associate - Sneaker Boutique",
                category: "jobs",
                price: 22,
                city: "Atlanta",
                description: "Part-time retail associate. Must know sneaker culture and basic POS systems.",
                seller: "KicksLab",
                postedDate: today,
                jobCategory: "retail_customer_service",
                employmentType: "part_time",
                experienceLevel: "entry",
                remote: false,
                payMin: 22,
                payMax: 26,
                payUnit: "hr",
                companyLogo: "https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?w=300&auto=format&fit=crop",
                jobStatus: "Hiring fast",
                tags: ["retail", "part-time", "sneakers"],
                images: [
                    "https://images.unsplash.com/photo-1521334884684-d80222895322?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1483985988355-763728e1935b?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 14,
                title: "Social Media Lead - Streetwear Brand",
                category: "jobs",
                price: 28,
                city: "Los Angeles",
                description: "Manage drops, content calendar, and IG/TikTok performance. Hybrid role.",
                seller: "CityBlock Apparel",
                postedDate: twoDays,
                jobCategory: "marketing_sales",
                employmentType: "full_time",
                experienceLevel: "mid",
                remote: true,
                payMin: 28,
                payMax: 36,
                payUnit: "hr",
                companyLogo: "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=300&auto=format&fit=crop",
                jobStatus: "Verified employer",
                tags: ["marketing", "streetwear", "full-time"],
                images: [
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?w=900&auto=format&fit=crop"
                ]
            },
            {
                id: 16,
                title: "Luxury Concierge - Private Members Club",
                category: "jobs",
                price: 45,
                city: "Miami",
                description: "Oversee VIP guest experiences, manage reservations, and deliver white-glove service in a high-touch environment.",
                seller: "Atlas Society",
                postedDate: threeDays,
                jobCategory: "food_hospitality",
                employmentType: "full_time",
                experienceLevel: "mid",
                remote: false,
                payMin: 45,
                payMax: 55,
                payUnit: "hr",
                companyLogo: "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=300&auto=format&fit=crop",
                jobStatus: "Open role",
                tags: ["luxury", "hospitality", "vip", "full-time"],
                images: [
                    "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=900&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=900&auto=format&fit=crop"
                ]
            }
        ];
    }

    loadSampleServiceProfiles() {
        const now = new Date();
        const hoursAgo = (hours) => new Date(now.getTime() - hours * 60 * 60 * 1000);
        const daysAgo = (days) => new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

        return [
            {
                id: 'svc-glam',
                title: 'Mobile Glam 路 Hair & Makeup',
                category: 'health_beauty',
                price: 'From $120',
                priceNote: 'At-home appointments',
                city: 'Los Angeles',
                country: 'United States',
                phone: '+1 (310) 555-0198',
                provider: 'Sana Lewis',
                role: 'Licensed stylist',
                avatar: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=300&h=300',
                badge: 'Verified pro',
                postedAt: hoursAgo(5),
                rating: 4.9,
                reviews: 128,
                desc: 'On-site hair and makeup for weddings, shoots, and events. Includes skin prep, lashes, and a mini touch-up kit.',
                meta: 'Travel radius 15 km 路 Deposit required',
                highlights: ['On-site glam team', 'All skin tones', 'Touch-up kit included'],
                availability: ['Same-week slots', 'Evenings', 'Weekends'],
                tags: ['Top Rated', 'Mobile', 'Insured'],
                photos: [
                    'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1519415943484-9fa1873496d4?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Verified pro 路 Same-week slots',
                cardTag: 'Top Rated',
                cardTagClass: 'tag-top',
                remote: false
            },
            {
                id: 'svc-chef',
                title: 'Private Chef Tasting Night',
                category: 'food',
                price: '$350',
                priceNote: '3-course dinner at home',
                city: 'Brooklyn',
                country: 'United States',
                phone: '+1 (718) 555-0136',
                provider: 'Chef Mateo Ruiz',
                role: 'Private chef',
                avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=300&h=300',
                badge: 'Premium',
                postedAt: hoursAgo(12),
                rating: 4.8,
                reviews: 76,
                desc: 'Chef-prepared tasting menu with custom courses, plating, and cleanup. Sourcing local and seasonal ingredients.',
                meta: 'Dinner for 2-6 guests 路 Book 48h ahead',
                highlights: ['Custom menu design', 'Allergies supported', 'Chef + server team'],
                availability: ['Fridays', 'Weekends', 'Holiday bookings'],
                tags: ['Premium', "Chef's table", 'Locally sourced'],
                photos: [
                    'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Menu tailored 路 Allergies supported',
                cardTag: 'Premium',
                cardTagClass: 'tag-premium',
                remote: false
            },
            {
                id: 'svc-clean',
                title: 'White-Glove Cleaning & Organizing',
                category: 'home_services',
                price: 'From $99',
                priceNote: 'Deep clean + reset',
                city: 'Austin',
                country: 'United States',
                phone: '+1 (512) 555-0174',
                provider: 'Clean & Co.',
                role: 'Insured cleaning team',
                avatar: 'https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=300&h=300',
                badge: 'New',
                postedAt: daysAgo(1),
                rating: 4.9,
                reviews: 210,
                desc: 'Room-by-room deep clean with organizing, linen resets, and eco-friendly supplies.',
                meta: 'Supplies included 路 4-hour minimum',
                highlights: ['Insured team', 'Eco-friendly products', 'Same-day available'],
                availability: ['Weekdays', 'Early mornings', 'Evenings'],
                tags: ['New', 'Insured', 'Eco-friendly'],
                photos: [
                    'https://images.unsplash.com/photo-1581578731548-c64695cc6952?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Insured 路 Supplies included',
                cardTag: 'New',
                cardTagClass: 'tag-new',
                remote: false
            },
            {
                id: 'svc-pet',
                title: 'Pup + Purr Grooming Spa',
                category: 'pet_services',
                price: 'From $75',
                priceNote: 'Bath, trim, nails',
                city: 'Seattle',
                country: 'United States',
                phone: '+1 (206) 555-0184',
                provider: 'Nia Harper',
                role: 'Certified groomer',
                avatar: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=300&h=300',
                badge: 'Top rated',
                postedAt: daysAgo(2),
                rating: 4.9,
                reviews: 94,
                desc: 'Calm, one-on-one grooming with hypoallergenic products, paw balm, and coat treatments.',
                meta: 'Small to large breeds 路 Pickup available',
                highlights: ['Fear-free handling', 'Hydrating coat mask', 'Same-day slots'],
                availability: ['Weekdays', 'Saturdays'],
                tags: ['Pet friendly', 'Pickup', 'Calm care'],
                photos: [
                    'https://images.unsplash.com/photo-1517849845537-4d257902454a?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1507146426996-ef05306b995a?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1502673530728-f79b4cab31b1?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Fear-free care 路 Pickup available',
                cardTag: 'Top Rated',
                cardTagClass: 'tag-top',
                remote: false
            },
            {
                id: 'svc-dj',
                title: 'Luxe Event DJ + Lighting',
                category: 'events_services',
                price: 'From $950',
                priceNote: '4-hour set + lighting',
                city: 'Miami',
                country: 'United States',
                phone: '+1 (305) 555-0142',
                provider: 'Rico Vega',
                role: 'Event DJ',
                avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=300&h=300',
                badge: 'Premium',
                postedAt: daysAgo(3),
                rating: 4.8,
                reviews: 58,
                desc: 'High-energy DJ sets with curated playlists, MC services, and custom uplighting.',
                meta: 'Corporate + weddings 路 Sound system included',
                highlights: ['Custom setlist', 'Wireless mics', 'Lighting package'],
                availability: ['Fridays', 'Weekends'],
                tags: ['Premium', 'MC', 'Lighting'],
                photos: [
                    'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1464375117522-1311d8f05f54?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Custom setlist 路 Lighting included',
                cardTag: 'Premium',
                cardTagClass: 'tag-premium',
                remote: false
            },
            {
                id: 'svc-trainer',
                title: 'Strength Coach 路 6-Week Reset',
                category: 'fitness',
                price: '$220',
                priceNote: 'Personalized plan',
                city: 'London',
                country: 'United Kingdom',
                phone: '+44 20 7946 0112',
                provider: 'Maya Thompson',
                role: 'Strength coach',
                avatar: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=300&h=300',
                badge: 'Verified',
                postedAt: daysAgo(4),
                rating: 4.7,
                reviews: 63,
                desc: 'Goal-driven strength plan with weekly check-ins, gym programming, and nutrition guidance.',
                meta: 'Gym or home 路 Includes habit tracking',
                highlights: ['Weekly check-ins', 'Form videos', 'Macro guidance'],
                availability: ['Weekdays', 'Evenings'],
                tags: ['Personal training', 'Accountability', 'Results'],
                photos: [
                    'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1518611012118-696072aa579a?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1483721310020-03333e577078?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Weekly check-ins 路 Form reviews',
                cardTag: 'Verified',
                cardTagClass: 'tag-top',
                remote: false
            },
            {
                id: 'svc-finance',
                title: 'Tax Strategy + Bookkeeping',
                category: 'financial',
                price: '$180',
                priceNote: 'Monthly retainer',
                city: 'Toronto',
                country: 'Canada',
                phone: '+1 (416) 555-0117',
                provider: 'Kiran Patel',
                role: 'CPA + advisor',
                avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=300&h=300',
                badge: 'Remote-friendly',
                postedAt: daysAgo(7),
                rating: 4.9,
                reviews: 84,
                desc: 'Monthly bookkeeping, quarterly tax planning, and year-end filings for creatives and founders.',
                meta: 'Remote service 路 Secure client portal',
                highlights: ['Monthly reports', 'Tax optimization', 'Invoice cleanup'],
                availability: ['Weekdays', 'Remote'],
                tags: ['Remote', 'CPA', 'Fast response'],
                photos: [
                    'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1551836022-2c8293d38a7a?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1450101499163-c8848c66ca85?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Remote service 路 Monthly reports',
                cardTag: 'Remote',
                cardTagClass: 'tag-new',
                remote: true
            },
            {
                id: 'svc-handyman',
                title: 'Smart Home Install & Repair',
                category: 'skilled_trades',
                price: 'From $140',
                priceNote: 'Install + troubleshooting',
                city: 'Berlin',
                country: 'Germany',
                phone: '+49 30 9018 3322',
                provider: 'Jonas Keller',
                role: 'Home systems tech',
                avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=300&h=300',
                badge: 'Insured',
                postedAt: daysAgo(1),
                rating: 4.8,
                reviews: 71,
                desc: 'Smart locks, cameras, thermostats, and mesh Wi-Fi installs with clear walkthroughs.',
                meta: 'Same-week availability 路 Parts sourcing',
                highlights: ['Device setup', 'Network optimization', 'Warranty help'],
                availability: ['Weekdays', 'Evenings'],
                tags: ['Insured', 'Same-week', 'Smart home'],
                photos: [
                    'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1501045661006-fcebe0257c3f?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Same-week availability 路 Parts sourcing',
                cardTag: 'Insured',
                cardTagClass: 'tag-top',
                remote: false
            },
            {
                id: 'svc-travel',
                title: 'Destination Trip Planner',
                category: 'travel',
                price: '$280',
                priceNote: 'Custom 5-day itinerary',
                city: 'Lisbon',
                country: 'Portugal',
                phone: '+351 21 000 1203',
                provider: 'Ines Costa',
                role: 'Travel concierge',
                avatar: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=300&h=300',
                badge: 'Remote-friendly',
                postedAt: hoursAgo(20),
                rating: 4.9,
                reviews: 52,
                desc: 'Full itinerary planning with reservations, local guides, and route optimization.',
                meta: 'Remote service 路 Timezone flexible',
                highlights: ['Boutique stays', 'Local guides', 'Restaurant bookings'],
                availability: ['Weekdays', 'Remote'],
                tags: ['Remote', 'Concierge', 'VIP'],
                photos: [
                    'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Remote concierge 路 Reservations handled',
                cardTag: 'Remote',
                cardTagClass: 'tag-new',
                remote: true
            },
            {
                id: 'svc-jazz',
                title: 'Live Jazz Trio for Nights',
                category: 'entertainment',
                price: 'From $650',
                priceNote: '2-hour set',
                city: 'New Orleans',
                country: 'United States',
                phone: '+1 (504) 555-0170',
                provider: 'The Blue Note Trio',
                role: 'Live music',
                avatar: 'https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=300&h=300',
                badge: 'Top rated',
                postedAt: daysAgo(5),
                rating: 4.8,
                reviews: 46,
                desc: 'Smooth jazz sets for cocktail hours, private dinners, and celebrations.',
                meta: 'Indoor/outdoor 路 Sound gear included',
                highlights: ['Custom setlist', 'Sound gear', 'MC add-on'],
                availability: ['Thursdays', 'Weekends'],
                tags: ['Live music', 'Events', 'Sound gear'],
                photos: [
                    'https://images.unsplash.com/photo-1485579149621-3123dd979885?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&w=800&h=600',
                    'https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?auto=format&fit=crop&w=800&h=600'
                ],
                highlightLine: 'Custom setlist 路 Sound gear included',
                cardTag: 'Top Rated',
                cardTagClass: 'tag-top',
                remote: false
            }
        ];
    }

    loadSampleDiscoveryPosts() {
        const now = new Date();
        const minutesAgo = (mins) => new Date(now.getTime() - mins * 60 * 1000);

        const buildSeller = (data) => ({
            name: data.name,
            avatar: data.avatar,
            location: this.ensureLocationDistance(data.location || {}),
            stats: data.stats,
            online: data.online,
            trust: data.trust
        });

        const listings = [
	            {
	                id: 'global-sale-1',
	                seller: buildSeller({
	                    name: 'Aya Nakamura',
	                    avatar: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=300&h=300',
	                    // Keep the first demo post visible even when the feed is set to Nearby.
	                    location: { city: 'San Francisco', country: 'United States', flag: '吼', timezone: 'PST', distance: 2.1 },
	                    stats: '126 global trades',
	                    online: true,
	                    trust: 'Superhost seller'
	                }),
	                listingType: 'sale',
	                listing: {
	                    title: 'Sony A7C II mirrorless kit',
	                    summary: 'Full-frame creator kit with two lenses, original box, travel strap, and USB-C battery grip. Only used on one expedition.',
	                    price: { amount: 1850, currency: 'USD' },
	                    priceText: '$1,850 USD 路 ships worldwide',
	                    condition: 'Like new (9/10)',
	                    availability: 'Ships within 24h',
	                    fulfillment: 'Pickup in San Francisco or insured shipping',
                        media: [
                            'https://images.unsplash.com/photo-1484704849700-f032a568e944?auto=format&fit=crop&w=900&h=650',
                            'https://images.unsplash.com/photo-1519183071298-a2962be96f14?auto=format&fit=crop&w=900&h=650',
                            'https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?auto=format&fit=crop&w=900&h=650'
                        ],
	                    mediaUrl: 'https://images.unsplash.com/photo-1484704849700-f032a568e944?auto=format&fit=crop&w=900&h=650',
	                    tags: ['Mirrorless', 'Full-frame', 'Travel kit']
	                },
	                location: 'San Francisco, United States',
	                likes: 64,
	                comments: 12,
	                timestamp: minutesAgo(8)
	            },
            {
                id: 'global-free-1',
                seller: buildSeller({
                    name: 'Sipho Dlamini',
                    avatar: 'https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=300&h=300',
                    location: { city: 'Cape Town', country: 'South Africa', flag: '筐', timezone: 'SAST' },
                    stats: '42 community gifts',
                    online: true,
                    trust: 'Neighbourhood verified'
                }),
                listingType: 'free',
                listing: {
                    title: 'Solid pine dining table + 4 chairs',
                    summary: '2m handcrafted table retiring from our studio. Still sturdyperfect for families or creative spaces. Free if you can pick up.',
                    priceText: 'Free 路 pickup only',
                    condition: 'Gently loved',
                    availability: 'Pickup this weekend',
                    fulfillment: 'Collect in Salt River, Cape Town',
                    mediaUrl: 'https://images.unsplash.com/photo-1484100356142-db6ab6244067?auto=format&fit=crop&w=900&h=650',
                    tags: ['Home goods', 'Upcycle', 'Community']
                },
                location: 'Cape Town, South Africa',
                likes: 38,
                comments: 6,
                timestamp: minutesAgo(22)
            },
            {
                id: 'global-trade-1',
                seller: buildSeller({
                    name: 'Jordan Winters',
                    avatar: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=300&h=300',
                    location: { city: 'Toronto', country: 'Canada', flag: '', timezone: 'EST' },
                    stats: '78 successful swaps',
                    online: false,
                    trust: 'Trade circle moderator'
                }),
                listingType: 'trade',
                listing: {
                    title: 'Custom longboard (Maple) looking to trade',
                    summary: 'Hand-pressed 40 deck with Paris V3 trucks and Orangatang wheels. Seeking high-end film camera or modular synth gear.',
                    priceText: 'Trade for film camera / synth gear',
                    condition: 'Freshly tuned & waxed',
                    availability: 'Can ship to North America & EU',
                    fulfillment: 'Toronto pickup or insured shipping',
                    mediaUrl: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=900&h=650',
                    tags: ['Handmade', 'Board sport', 'Swap']
                },
                location: 'Toronto, Canada',
                likes: 41,
                comments: 9,
                timestamp: minutesAgo(37)
            },
            {
                id: 'global-rent-1',
                seller: buildSeller({
                    name: 'Mariana Costa',
                    avatar: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=300&h=300',
                    location: { city: 'Lisbon', country: 'Portugal', flag: '叼', timezone: 'WEST' },
                    stats: 'Top rated host 路 4.98猸',
                    online: true,
                    trust: 'Event friendly'
                }),
                listingType: 'rent',
                listing: {
                    title: 'Chiado daylight loft for creators',
                    summary: '120m虏 corner loft with plants, projector, and modular seating. Ideal for photo shoots, supper clubs, or remote team days.',
                    priceText: '55/hr 路 4 hr minimum',
                    condition: 'Ready with concierge',
                    availability: 'Open slots this Friday + weekend',
                    fulfillment: 'Keyless entry 路 host on-site',
                    mediaUrl: 'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=900&h=650',
                    tags: ['Event space', 'Loft', 'High ceilings']
                },
                location: 'Lisbon, Portugal',
                likes: 52,
                comments: 14,
                timestamp: minutesAgo(44)
            },
            {
                id: 'global-service-1',
                seller: buildSeller({
                    name: 'Riya Desai',
                    avatar: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=300&h=300',
                    location: { city: 'Bengaluru', country: 'India', flag: '', timezone: 'IST' },
                    stats: 'Product design lead 路 9 yrs',
                    online: true,
                    trust: 'Remote-friendly'
                }),
                listingType: 'service',
                listing: {
                    title: '1-week product design sprint (remote)',
                    summary: 'Figma + FigJam sprint for fintech and SaaS teams. Includes async research playback, UI kit, and Loom handoff.',
                    priceText: '$2,400 USD per sprint',
                    availability: 'Next opening: Dec 2',
                    fulfillment: 'Remote 路 CET + IST overlap hours',
                    condition: 'Includes research plan + prototypes',
                    mediaUrl: 'https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?auto=format&fit=crop&w=900&h=650',
                    tags: ['UX/UI', 'Remote', 'Sprint']
                },
                location: 'Remote from Bengaluru, India',
                likes: 33,
                comments: 11,
                timestamp: minutesAgo(58)
            },
            {
                id: 'global-sale-2',
                seller: buildSeller({
                    name: 'Mateo Aguilar',
                    avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=300&h=300',
                    location: { city: 'Mexico City', country: 'Mexico', flag: '拆', timezone: 'CST' },
                    stats: 'Certified refurbisher',
                    online: false,
                    trust: '90-day warranty'
                }),
                listingType: 'sale',
                listing: {
                    title: 'Restored mid-century lounge chair',
                    summary: 'Teak + leather restoration with natural oils, fresh strapping, and protective finish. Ships flat-packed with care kit.',
                    priceText: '$680 USD 路 insured freight',
                    condition: 'Professionally restored',
                    availability: 'Dispatch in 3 days',
                    fulfillment: 'Ships from CDMX 路 US/EU freight',
                    mediaUrl: 'https://images.unsplash.com/photo-1484100356142-db6ab6244067?auto=format&fit=crop&w=900&h=650',
                    tags: ['Vintage', 'Furniture', 'Handcrafted']
                },
                location: 'Mexico City, Mexico',
                likes: 47,
                comments: 7,
                timestamp: minutesAgo(75)
            }
        ];

        return listings.map(post => ({
            ...post,
            user: post.seller,
            content: post.listing?.summary || post.content || ''
        }));
    }

    loadSampleCommunityPosts() {
        const now = new Date();
        const hoursAgo = (hours) => new Date(now.getTime() - hours * 60 * 60 * 1000);
        const daysAgo = (days) => new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
        const buildLocation = (city, country, distance) => (
            this.ensureLocationDistance({ city, country, distance })
        );

        return [
            {
                id: 'com-1',
                category: 'classes_lessons',
                title: 'Sunrise Yoga Social',
                summary: 'Flow class on the pier with sound bath finish. Mats provided.',
                when: 'Sat 路 7:00 AM',
                priceText: '$15',
                host: 'Maya Singh',
                tags: ['Wellness', 'Beginner', 'Outdoors'],
                image: 'https://images.unsplash.com/photo-1524863479829-916d8e77f114?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Santa Monica', 'United States', 12),
                postedAt: hoursAgo(3)
            },
            {
                id: 'com-2',
                category: 'rideshare',
                title: 'Airport ride share to LAX',
                summary: 'Two seats open for Tuesday morning ride. Split fuel, leave 6:30 AM.',
                when: 'Tue 路 6:30 AM',
                priceText: 'Split fare',
                host: 'Jordan Lee',
                tags: ['Carpool', 'Early'],
                image: 'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Culver City', 'United States', 18),
                postedAt: hoursAgo(6)
            },
            {
                id: 'com-3',
                category: 'events',
                title: 'Night Market on the Roof',
                summary: 'Local vendors, vinyl DJs, and late bites. RSVP recommended.',
                when: 'Fri 路 8:00 PM',
                priceText: 'Free entry',
                host: 'Eastside Collective',
                tags: ['Food', 'Music', 'Pop-up'],
                image: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Austin', 'United States', 210),
                postedAt: hoursAgo(10)
            },
            {
                id: 'com-4',
                category: 'activities_groups',
                title: 'Saturday Run Club',
                summary: '5k loop with coffee after. All paces welcome.',
                when: 'Sat 路 9:00 AM',
                priceText: 'Free',
                host: 'Run With Us',
                tags: ['Fitness', 'Social'],
                image: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Toronto', 'Canada', 60),
                postedAt: hoursAgo(14)
            },
            {
                id: 'com-5',
                category: 'volunteers',
                title: 'Beach cleanup crew',
                summary: 'Grab gloves and join us for a 90-minute cleanup with snacks after.',
                when: 'Sun 路 10:30 AM',
                priceText: 'Volunteer',
                host: 'Green Bay Alliance',
                tags: ['Community', 'Eco'],
                image: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Lisbon', 'Portugal', 350),
                postedAt: hoursAgo(20)
            },
            {
                id: 'com-6',
                category: 'lost_found',
                title: 'Lost passport near downtown',
                summary: 'Black passport wallet lost near 3rd Ave station. Reward offered.',
                when: 'Last seen yesterday',
                priceText: 'Reward',
                host: 'Elena Martinez',
                tags: ['Urgent', 'Help'],
                image: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Seattle', 'United States', 240),
                postedAt: daysAgo(1)
            },
            {
                id: 'com-7',
                category: 'business_networking',
                title: 'Founder coffee swap',
                summary: 'Pairing early-stage founders for 30 minute coffee intros.',
                when: 'Wed 路 9:00 AM',
                priceText: 'RSVP',
                host: 'Startup Atlas',
                tags: ['Networking', 'Tech'],
                image: 'https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('New York', 'United States', 120),
                postedAt: daysAgo(1)
            },
            {
                id: 'com-8',
                category: 'travel',
                title: 'Tokyo weekend planner group',
                summary: 'Sharing a weekend itinerary with food stops and neighborhood walks.',
                when: 'Next weekend',
                priceText: 'Free',
                host: 'Kenji Mori',
                tags: ['Travel', 'Food'],
                image: 'https://images.unsplash.com/photo-1496939376851-89342e90adcd?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Tokyo', 'Japan', 5200),
                postedAt: daysAgo(2)
            },
            {
                id: 'com-9',
                category: 'other',
                title: 'Cat sitting swap',
                summary: 'Looking for someone to swap weekend pet sitting in October.',
                when: 'October dates',
                priceText: 'Swap',
                host: 'Priya Desai',
                tags: ['Pets', 'Swap'],
                image: 'https://images.unsplash.com/photo-1518791841217-8f162f1e1131?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Chicago', 'United States', 150),
                postedAt: daysAgo(2)
            },
            {
                id: 'com-10',
                category: 'classes_lessons',
                title: 'Beginner pottery night',
                summary: 'Small group wheel class with take-home glaze firing.',
                when: 'Thu 路 6:30 PM',
                priceText: '$45',
                host: 'Clay House',
                tags: ['Art', 'Workshop'],
                image: 'https://images.unsplash.com/photo-1496318447583-f524534e9ce1?auto=format&fit=crop&w=900&h=650',
                location: buildLocation('Brooklyn', 'United States', 130),
                postedAt: daysAgo(3)
            }
        ];
    }

	    loadSampleCompanionshipProfiles() {
	        const now = new Date();
	        const minutesFromLabel = (label = '') => {
	            const text = String(label).toLowerCase();
	            if (!text || text.includes('online now') || text.includes('just now')) return 0;
	            if (text.includes('yesterday')) return 24 * 60;
	            const m = text.match(/(\d+)\s*m/);
	            if (m) return parseInt(m[1], 10) || 0;
	            const h = text.match(/(\d+)\s*h/);
	            if (h) return (parseInt(h[1], 10) || 0) * 60;
	            const d = text.match(/(\d+)\s*d/);
	            if (d) return (parseInt(d[1], 10) || 0) * 24 * 60;
	            return 0;
	        };
	        const daysAgo = (days, minutes = 0) => new Date(now.getTime() - days * 24 * 60 * 60 * 1000 - minutes * 60 * 1000);

	        const profiles = [
	            {
	                id: 'comp-ava',
	                alias: 'Ava Rivers',
                age: 29,
                tagline: 'Cocktails + slow-burn chemistry.',
                description: '18+ only. Meet up for flirty dinners, rooftop nights, and consent-first sparks.',
                country: 'United States',
                region: 'California',
                city: 'San Francisco',
                gender: 'Woman',
                seeking: 'Magnetic, respectful company with real chemistry.',
                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
                photos: [
                    'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
                    'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650'
                ],
	                online: true,
	                premium: true,
		                lastActive: '5m ago',
		                postedAt: daysAgo(0, 25),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
		            {
		                id: 'comp-sf-bella',
		                alias: 'Bella M.',
		                age: 26,
                tagline: 'Silk dresses + golden hour views.',
                description: '18+ companionship. Meet up for flirt-forward brunches, city lights, and slow-burn tension.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
                seeking: 'Flirty, respectful dates with chemistry.',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '45m ago',
		                postedAt: daysAgo(0, 60)
		            },
		            {
		                id: 'comp-sf-morgan',
		                alias: 'Morgan T.',
		                age: 31,
                tagline: 'After-dark concerts + playful tension.',
                description: '18+ companionship. Meet up for music nights, late walks, and sensual energy (consent-first).',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Non-binary',
                seeking: 'Nightlife, chemistry, and a spark.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: 'Online now',
		                postedAt: daysAgo(0, 18)
		            },
		            {
		                id: 'comp-sf-kenji',
		                alias: 'Kenji R.',
		                age: 34,
                tagline: 'Jazz lounges + close conversation.',
                description: '18+ companionship. Meet up for jazz bars, candlelit dinners, and slow-burn chemistry.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Man',
                seeking: 'Respectful, flirt-forward meetups.',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '2h ago',
		                postedAt: daysAgo(0, 140)
		            },
		            {
		                id: 'comp-sf-noelle',
		                alias: 'Noelle S.',
		                age: 28,
                tagline: 'Gallery nights + velvet cocktails.',
                description: '18+ companionship. Meet up for exhibits, rooftop lounges, and a little tension.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
                seeking: 'Chemistry-first dates and city nights.',
		                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: true,
		                lastActive: '12m ago',
		                postedAt: daysAgo(0, 35),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
		            {
		                id: 'comp-sf-jordan',
		                alias: 'Jordan C.',
		                age: 29,
                tagline: 'Gigs & jobs  nightlife runner + errands.',
		                description: 'Available for short gigs: event help, deliveries, errands. 18+ respectful requests only.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Man',
		                seeking: 'Short gigs and city-day planning.',
		                serviceCategory: 'gigs_jobs',
		                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '6m ago',
		                postedAt: daysAgo(0, 22)
		            },
		            {
		                id: 'comp-sf-tessa',
		                alias: 'Tessa (Wellness)',
		                age: 30,
                tagline: 'Aromatherapy + slow reset.',
                description: 'Licensed massage therapist (wellness only, non-sexual). 18+ respectful bookings.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
		                seeking: 'Wellness clients and caf茅 walks.',
		                serviceCategory: 'massage',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: 'Yesterday',
		                postedAt: daysAgo(1, 30)
		            },
		            {
		                id: 'comp-sf-reese',
		                alias: 'Reese P.',
		                age: 27,
                tagline: 'Food trucks + late-night strolls.',
                description: '18+ companionship. Meet up for flirty markets, night walks, and easy chemistry.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Non-binary',
                seeking: 'Light flirting and relaxed conversation.',
		                photo: 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '1d ago',
		                postedAt: daysAgo(1, 110)
		            },
		            {
		                id: 'comp-sf-sage',
		                alias: 'Sage W.',
		                age: 33,
                tagline: 'Museum afternoons + candlelit dinners.',
                description: '18+ companionship. Meet up for calm nights, warm conversation, and slow-burn chemistry.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Man',
                seeking: 'Respectful, chemistry-first meetups.',
		                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '2d ago',
		                postedAt: daysAgo(2, 15)
		            },
		            {
		                id: 'comp-sf-emmy',
		                alias: 'Emmy (Massage)',
		                age: 29,
                tagline: 'Therapeutic massage + soft lighting.',
                description: 'Wellness-only massage (licensed, non-sexual). 18+ respectful bookings.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
		                seeking: 'Wellness clients and calm conversation.',
		                serviceCategory: 'massage',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: 'Online now',
		                postedAt: daysAgo(0, 6)
		            },
		            {
		                id: 'comp-sf-ty',
		                alias: 'Ty B.',
		                age: 35,
		                tagline: 'Gigs & jobs  moving help + deliveries.',
		                description: 'Available for short gigs: lifting, deliveries, day-of help. 18+ respectful requests only.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Man',
		                seeking: 'Short gigs and local recommendations.',
		                serviceCategory: 'gigs_jobs',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '3d ago',
		                postedAt: daysAgo(3, 35)
		            },
		            {
		                id: 'comp-sf-jia',
		                alias: 'Jia L.',
		                age: 28,
                tagline: 'Rooftop views + sultry dinners.',
                description: '18+ companionship. Meet up for rooftop nights, shows, and playful tension.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
                seeking: 'Flirty dinners and sparks.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '4d ago',
		                postedAt: daysAgo(4, 20)
		            },
		            {
		                id: 'comp-sf-alexis',
		                alias: 'Alexis K.',
		                age: 32,
                tagline: 'Night markets + soft flirting.',
                description: '18+ companionship. Meet up for cozy cafes, night walks, and chemistry.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Woman',
                seeking: 'Flirty meetups and city exploring.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '25m ago',
		                postedAt: daysAgo(0, 90)
		            },
		            {
		                id: 'comp-sf-drew',
		                alias: 'Drew H.',
		                age: 37,
                tagline: 'Calm dinners + low-lit lounges.',
                description: '18+ companionship. Meet up for relaxed nights, warm chemistry, and good conversation.',
		                country: 'United States',
		                region: 'California',
		                city: 'San Francisco',
		                gender: 'Man',
                seeking: 'Shows, dinner dates, and sparks.',
		                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '6d ago',
		                postedAt: daysAgo(6, 5)
		            },
			            {
			                id: 'comp-sf-rory',
			                alias: 'Rory J.',
			                age: 26,
	                tagline: 'Vintage shops + slow-burn coffee.',
	                description: '18+ companionship. Meet up for cafes, strolls, and playful tension.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Non-binary',
	                seeking: 'Chemistry-first coffee dates.',
			                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
			                online: false,
			                premium: false,
			                lastActive: '7d ago',
			                postedAt: daysAgo(7, 45)
			            },
			            {
			                id: 'comp-sf-mila',
			                alias: 'Mila V.',
			                age: 27,
			                tagline: 'Gallery openings + rooftop cocktails.',
			                description: '18+ companionship. Respectful meetups for art nights, dinners, and city exploring.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Woman',
			                seeking: 'Chemistry-first dates and nightlife plans.',
			                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: true,
			                lastActive: 'Online now',
			                postedAt: daysAgo(0, 7),
			                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
			            },
			            {
			                id: 'comp-sf-ari',
			                alias: 'Ari K.',
			                age: 30,
			                tagline: 'Late-night ramen + city walks.',
			                description: '18+ companionship. Respectful meetups: dinners, shows, and easy conversation.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Non-binary',
			                seeking: 'Food spots, concerts, and relaxed plans.',
			                photo: 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '12m ago',
			                postedAt: daysAgo(0, 18)
			            },
			            {
			                id: 'comp-sf-hugo',
			                alias: 'Hugo (Gigs)',
			                age: 33,
			                tagline: 'Gigs & jobs  event helper + deliveries.',
			                description: 'Available for short gigs: event help, deliveries, errands. 18+ respectful requests only.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Man',
			                seeking: 'Short gigs and city-day planning.',
			                serviceCategory: 'gigs_jobs',
			                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '6m ago',
			                postedAt: daysAgo(0, 12)
			            },
			            {
			                id: 'comp-sf-selene',
			                alias: 'Selene (Wellness)',
			                age: 29,
			                tagline: 'Deep tissue massage + calm reset.',
			                description: 'Licensed massage therapist (wellness only, non-sexual). 18+ respectful bookings.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Woman',
			                seeking: 'Wellness clients and calm conversation.',
			                serviceCategory: 'massage',
			                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
			                online: false,
			                premium: true,
			                lastActive: '45m ago',
			                postedAt: daysAgo(0, 60)
			            },
			            {
			                id: 'comp-sf-zi',
			                alias: 'Zi L.',
			                age: 26,
			                tagline: 'Coffee flights + cozy dinners.',
			                description: '18+ companionship. Respectful meetups for caf茅s, markets, and city nights.',
			                country: 'United States',
			                region: 'California',
			                city: 'San Francisco',
			                gender: 'Woman',
			                seeking: 'Conversation, dinners, and city exploring.',
			                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '25m ago',
			                postedAt: daysAgo(0, 35)
			            },
			            {
			                id: 'comp-ellie',
		                alias: 'Ellie Chen',
		                age: 32,
	                tagline: 'Local foodie + late-night reads.',
                description: '18+ companionship. Meet up for noodle spots, night markets, and gentle flirting.',
                country: 'Canada',
                region: 'Ontario',
                city: 'Toronto',
                gender: 'Woman',
                seeking: 'Coffee dates, concerts, and chemistry.',
                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: false,
	                lastActive: 'Yesterday',
	                postedAt: daysAgo(1, 90),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-raj',
                alias: 'Raj Singh',
                age: 35,
                tagline: 'After-work walks + slow-burn eye contact.',
                description: '18+ meetups for jazz nights, match days, and consent-first chemistry.',
                country: 'United Kingdom',
                region: 'England',
                city: 'London',
                gender: 'Man',
                seeking: 'Easygoing meetups with sparks.',
                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
	                online: true,
	                premium: false,
	                lastActive: 'Online now',
	                postedAt: daysAgo(0, 10),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-luca',
                alias: 'Luca Moretti',
                age: 31,
                tagline: 'Sunrise swims + sunset tension.',
                description: '18+ companionship. Meet up for beach walks, film nights, and easy chemistry.',
                country: 'Australia',
                region: 'New South Wales',
                city: 'Sydney',
                gender: 'Man',
                seeking: 'Coastal meetups with a spark.',
                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: true,
	                lastActive: '1d ago',
	                postedAt: daysAgo(1, 30),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-cam',
                alias: 'Cam Harper',
                age: 27,
                tagline: 'Live music + taco trucks.',
                description: '18+ companionship. Respectful, low-pressure hangs around the city.',
                country: 'United States',
                region: 'Texas',
                city: 'Austin',
                gender: 'Non-binary',
                seeking: 'Looking for concert buddies and chill conversation.',
                photo: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=500&h=650',
	                online: true,
	                premium: false,
	                lastActive: '12m ago',
	                postedAt: daysAgo(0, 90),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
            {
                id: 'comp-maya',
                alias: 'Maya Sol',
                age: 28,
                tagline: 'Weekend brunch + rooftop sunsets.',
                description: '18+ companionship. Looking for respectful company for events and city nights.',
                country: 'United States',
                region: 'California',
                city: 'Los Angeles',
                gender: 'Woman',
                seeking: 'Dinner dates, art shows, and chill conversation.',
                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                online: false,
                premium: true,
                lastActive: '2d ago',
                postedAt: daysAgo(2, 45),
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            },
            {
                id: 'comp-noah',
                alias: 'Noah Blake',
                age: 34,
                tagline: 'Quiet dinners + live jazz.',
                description: '18+ respectful companionship. Prefer low-key evenings and meaningful chats.',
                country: 'United Kingdom',
                region: 'England',
                city: 'Manchester',
                gender: 'Man',
                seeking: 'Concerts, museums, and weekend markets.',
                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
                online: false,
                premium: false,
                lastActive: '3d ago',
                postedAt: daysAgo(3, 120),
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            },
            {
                id: 'comp-sana',
                alias: 'Sana K.',
                age: 26,
                tagline: 'Therapeutic massage + cafe hopping.',
                description: 'Licensed massage therapist (wellness only). Book a session or add a city stroll after.',
                country: 'Singapore',
                region: 'Central',
                city: 'Singapore',
                gender: 'Woman',
                seeking: 'Walks, food spots, and casual conversation.',
                serviceCategory: 'massage',
                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: false,
	                lastActive: 'Yesterday',
		                postedAt: daysAgo(1, 18),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
            {
                id: 'comp-kai',
                alias: 'Kai M.',
                age: 31,
                tagline: 'Gigs & jobs  event helper + city guide.',
                description: 'Available for short gigs: event assistance, errands, and city-day planning. 18+ respectful requests only.',
                country: 'United States',
                region: 'Florida',
                city: 'Miami',
                gender: 'Man',
                seeking: 'Open to short-term gigs, day plans, and local recommendations.',
                serviceCategory: 'gigs_jobs',
                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
                online: true,
                premium: false,
                lastActive: '12m ago',
                postedAt: daysAgo(1, 20),
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            },
            {
                id: 'comp-gianni',
                alias: 'Gianni R.',
                age: 30,
                tagline: 'Espresso dates + seaside walks.',
                description: '18+ companionship. Prefer daytime meetups and relaxed plans.',
                country: 'Italy',
                region: 'Lazio',
                city: 'Rome',
                gender: 'Man',
                seeking: 'Museum visits and dinner dates.',
                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
                online: false,
	                premium: true,
	                lastActive: '4d ago',
		                postedAt: daysAgo(4, 15),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
		            {
		                id: 'comp-nia',
		                alias: 'Nia Park',
		                age: 27,
	                tagline: 'Rooftop dinners + live DJ nights.',
	                description: '18+ companionship. Respectful events, dinners, and city nights.',
	                country: 'United States',
	                region: 'New York',
	                city: 'New York City',
	                gender: 'Woman',
	                seeking: 'Dinner dates and nightlife plans.',
	                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
	                online: true,
	                premium: true,
	                lastActive: 'Online now',
	                postedAt: daysAgo(0, 5),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-diego',
	                alias: 'Diego M.',
	                age: 33,
	                tagline: 'City guide  food spots & hidden views.',
	                description: '18+ respectful meetups. I can plan a full day itinerary in your city.',
	                country: 'Mexico',
	                region: 'Mexico City',
	                city: 'Mexico City',
	                gender: 'Man',
	                seeking: 'Exploring, food, and relaxed conversation.',
	                photo: 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: false,
	                lastActive: 'Yesterday',
	                postedAt: daysAgo(1, 55),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-hana',
	                alias: 'Hana S.',
	                age: 26,
	                tagline: 'Spa day + calm conversation.',
	                description: 'Wellness-only massage (licensed). 18+ respectful bookings.',
	                country: 'Japan',
	                region: 'Tokyo Prefecture',
	                city: 'Tokyo',
	                gender: 'Woman',
	                seeking: 'Wellness clients and caf茅 walks.',
	                serviceCategory: 'massage',
	                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: false,
	                lastActive: '2d ago',
	                postedAt: daysAgo(2, 20),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-zara',
	                alias: 'Zara B.',
	                age: 30,
	                tagline: 'Museum dates + wine bars.',
	                description: '18+ companionship. Looking for respectful plans and great conversation.',
	                country: 'France',
	                region: 'Ile-de-France',
	                city: 'Paris',
	                gender: 'Woman',
	                seeking: 'Museums, dinners, and city walks.',
	                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
	                online: true,
	                premium: false,
	                lastActive: '12m ago',
	                postedAt: daysAgo(3, 10),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-omar',
	                alias: 'Omar K.',
	                age: 34,
	                tagline: 'Gigs & jobs  event runner + errands.',
	                description: 'Available for short gigs: event setup, deliveries, and day-of help. 18+ respectful requests only.',
	                country: 'United Arab Emirates',
	                region: 'Dubai',
	                city: 'Dubai',
	                gender: 'Man',
	                seeking: 'Short gigs and city-day planning.',
	                serviceCategory: 'gigs_jobs',
	                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
	                online: false,
	                premium: false,
	                lastActive: '4d ago',
	                postedAt: daysAgo(4, 110),
	                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
	            },
	            {
	                id: 'comp-leah',
	                alias: 'Leah N.',
	                age: 28,
	                tagline: 'Beach walks + brunch dates.',
	                description: '18+ companionship. Low-pressure daytime meetups and events.',
	                country: 'South Africa',
	                region: 'Western Cape',
	                city: 'Cape Town',
	                gender: 'Woman',
	                seeking: 'Brunch, markets, and beach walks.',
	                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
	                online: false,
		                premium: true,
		                lastActive: '5d ago',
		                postedAt: daysAgo(5, 40),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
			            {
			                id: 'comp-maya-vancouver',
			                alias: 'Maya L.',
			                age: 28,
			                tagline: 'Brunch spots + waterfront walks.',
			                description: '18+ companionship. Respectful plans: caf茅s, markets, and city strolls.',
			                country: 'Canada',
			                region: 'British Columbia',
			                city: 'Vancouver',
			                gender: 'Woman',
			                seeking: 'Coffee dates and low-key evenings.',
			                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '18m ago',
			                postedAt: daysAgo(0, 55)
			            },
		            {
		                id: 'comp-ella',
		                alias: 'Ella W.',
		                age: 30,
		                tagline: 'Coffee flights + bookshops.',
		                description: '18+ companionship. Looking for respectful company for dinners, museums, and shows.',
		                country: 'United States',
		                region: 'Washington',
		                city: 'Seattle',
		                gender: 'Woman',
		                seeking: 'Conversation, concerts, and city nights.',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: 'Yesterday',
		                postedAt: daysAgo(1, 35)
		            },
		            {
		                id: 'comp-ethan',
		                alias: 'Ethan J.',
		                age: 33,
		                tagline: 'Jazz nights + skyline views.',
		                description: '18+ companionship. Prefer calm, respectful meetups and good conversation.',
		                country: 'United States',
		                region: 'Illinois',
		                city: 'Chicago',
		                gender: 'Man',
		                seeking: 'Dinner dates, live music, and museums.',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '2d ago',
		                postedAt: daysAgo(2, 70)
		            },
		            {
		                id: 'comp-yuki',
		                alias: 'Yuki A.',
		                age: 27,
		                tagline: 'Street food + sunset ferries.',
		                description: '18+ companionship. Respectful meetups: caf茅s, markets, and city walks.',
		                country: 'Japan',
		                region: 'Osaka Prefecture',
		                city: 'Osaka',
		                gender: 'Woman',
		                seeking: 'Food tours and easygoing conversation.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: 'Online now',
		                postedAt: daysAgo(0, 8),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
		            {
		                id: 'comp-rina',
		                alias: 'Rina K.',
		                age: 29,
		                tagline: 'Tea houses + quiet city corners.',
		                description: '18+ companionship. Looking for respectful daytime plans and calm conversation.',
		                country: 'Japan',
		                region: 'Kyoto Prefecture',
		                city: 'Kyoto',
		                gender: 'Woman',
		                seeking: 'Caf茅 dates, gardens, and museums.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '3d ago',
		                postedAt: daysAgo(3, 25)
		            },
		            {
		                id: 'comp-priya',
		                alias: 'Priya S.',
		                age: 31,
		                tagline: 'City guide  caf茅s, galleries, and markets.',
		                description: '18+ companionship. Friendly local who can plan a full day in the city.',
		                country: 'India',
		                region: 'Maharashtra',
		                city: 'Mumbai',
		                gender: 'Woman',
		                seeking: 'City exploring, coffee, and relaxed conversation.',
		                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: true,
		                lastActive: '22m ago',
		                postedAt: daysAgo(0, 85)
		            },
		            {
		                id: 'comp-daniel',
		                alias: 'Daniel C.',
		                age: 36,
		                tagline: 'Gigs & jobs  event setup + day-of runner.',
		                description: 'Available for short gigs: event assistance, errands, deliveries. 18+ respectful requests only.',
		                country: 'United States',
		                region: 'Texas',
		                city: 'Dallas',
		                gender: 'Man',
		                seeking: 'Short gigs and city recommendations.',
		                serviceCategory: 'gigs_jobs',
		                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '6m ago',
		                postedAt: daysAgo(0, 35)
		            },
		            {
		                id: 'comp-jules',
		                alias: 'Jules M.',
		                age: 30,
		                tagline: 'Coastal caf茅s + late sunsets.',
		                description: '18+ companionship. Respectful meetups: dinners, museums, and seaside walks.',
		                country: 'France',
		                region: "Provence-Alpes-Cote d'Azur",
		                city: 'Nice',
		                gender: 'Non-binary',
		                seeking: 'City walks and calm dinners.',
		                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '4d ago',
		                postedAt: daysAgo(4, 5)
		            },
		            {
		                id: 'comp-luis',
		                alias: 'Luis R.',
		                age: 32,
		                tagline: 'Tapas tours + match nights.',
		                description: '18+ companionship. Looking for respectful company for dinners, events, and city exploring.',
		                country: 'Spain',
		                region: 'Catalonia',
		                city: 'Barcelona',
		                gender: 'Man',
		                seeking: 'Food spots, museums, and live shows.',
		                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '5d ago',
		                postedAt: daysAgo(5, 20)
		            },
		            {
		                id: 'comp-marco',
		                alias: 'Marco P.',
		                age: 34,
		                tagline: 'Dinner dates + design districts.',
		                description: '18+ companionship. Looking for respectful meetups and relaxed city nights.',
		                country: 'Italy',
		                region: 'Lombardy',
		                city: 'Milan',
		                gender: 'Man',
		                seeking: 'Dinners, museums, and good conversation.',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '6d ago',
		                postedAt: daysAgo(6, 10)
		            },
		            {
		                id: 'comp-ana',
		                alias: 'Ana G.',
		                age: 29,
		                tagline: 'City markets + cozy caf茅s.',
		                description: '18+ companionship. Respectful meetups: dinners, museums, and neighborhood walks.',
		                country: 'Mexico',
		                region: 'Jalisco',
		                city: 'Guadalajara',
		                gender: 'Woman',
		                seeking: 'Food spots and calm conversation.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '7d ago',
		                postedAt: daysAgo(7, 25)
		            },
		            {
		                id: 'comp-isa',
		                alias: 'Isa B.',
		                age: 30,
		                tagline: 'Beach walks + live music.',
		                description: '18+ companionship. Looking for respectful company for events and city nights.',
		                country: 'Brazil',
		                region: 'Rio de Janeiro',
		                city: 'Rio de Janeiro',
		                gender: 'Woman',
		                seeking: 'Music events, dinners, and seaside strolls.',
		                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: true,
		                lastActive: 'Online now',
		                postedAt: daysAgo(0, 12),
		                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
		            },
		            {
		                id: 'comp-aisha',
		                alias: 'Aisha H.',
		                age: 28,
		                tagline: 'Rooftop caf茅s + modern art.',
		                description: '18+ companionship. Respectful company for dinners, events, and city nights.',
		                country: 'United Arab Emirates',
		                region: 'Abu Dhabi',
		                city: 'Abu Dhabi',
		                gender: 'Woman',
		                seeking: 'Dinners, galleries, and calm conversation.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '42m ago',
		                postedAt: daysAgo(0, 160)
		            },
		            {
		                id: 'comp-lina-massage',
		                alias: 'Lina (Wellness)',
		                age: 30,
		                tagline: 'Wellness-only massage + recovery sessions.',
		                description: 'Licensed massage therapist (wellness only). 18+ respectful bookings.',
		                country: 'Canada',
		                region: 'Quebec',
		                city: 'Montreal',
		                gender: 'Woman',
		                seeking: 'Wellness clients and caf茅 walks.',
		                serviceCategory: 'massage',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: true,
		                lastActive: '14m ago',
		                postedAt: daysAgo(0, 95)
		            },
		            {
		                id: 'comp-nora',
		                alias: 'Nora J.',
		                age: 31,
		                tagline: 'Cozy caf茅s + weekend markets.',
		                description: '18+ companionship. Respectful daytime meetups and city walks.',
		                country: 'Canada',
		                region: 'Ontario',
		                city: 'Ottawa',
		                gender: 'Woman',
		                seeking: 'Coffee dates and relaxed conversation.',
		                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '2h ago',
		                postedAt: daysAgo(0, 180)
		            },
		            {
		                id: 'comp-jasper',
		                alias: 'Jasper K.',
		                age: 29,
		                tagline: 'Seaside walks + live comedy.',
		                description: '18+ companionship. Respectful plans and good vibes.',
		                country: 'Canada',
		                region: 'British Columbia',
		                city: 'Victoria',
		                gender: 'Man',
		                seeking: 'Walks, concerts, and caf茅s.',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: 'Online now',
		                postedAt: daysAgo(0, 2)
		            },
		            {
		                id: 'comp-finn',
		                alias: 'Finn R.',
		                age: 33,
		                tagline: 'Whisky bars + late-night walks.',
		                description: '18+ companionship. Respectful meetups for dinners and shows.',
		                country: 'United Kingdom',
		                region: 'Scotland',
		                city: 'Edinburgh',
		                gender: 'Man',
		                seeking: 'Conversation, museums, and city nights.',
		                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '2d ago',
		                postedAt: daysAgo(2, 30)
		            },
		            {
		                id: 'comp-aine',
		                alias: 'Aine M.',
		                age: 28,
		                tagline: 'Coffee shops + live music.',
		                description: '18+ companionship. Respectful plans: dinners, events, and easy conversation.',
		                country: 'United Kingdom',
		                region: 'Northern Ireland',
		                city: 'Belfast',
		                gender: 'Woman',
		                seeking: 'Concerts and low-key evenings.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '4d ago',
		                postedAt: daysAgo(4, 50)
		            },
		            {
		                id: 'comp-kira',
		                alias: 'Kira S.',
		                age: 27,
		                tagline: 'Beach days + rooftop sunsets.',
		                description: '18+ companionship. Respectful hangs and city exploring.',
		                country: 'Australia',
		                region: 'Queensland',
		                city: 'Brisbane',
		                gender: 'Woman',
		                seeking: 'Walks, food spots, and events.',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '38m ago',
		                postedAt: daysAgo(1, 15)
		            },
		            {
		                id: 'comp-anika',
		                alias: 'Anika P.',
		                age: 29,
		                tagline: 'Tea spots + city nights.',
		                description: '18+ companionship. Respectful dinners and calm conversation.',
		                country: 'India',
		                region: 'Tamil Nadu',
		                city: 'Chennai',
		                gender: 'Woman',
		                seeking: 'Caf茅s, markets, and relaxed plans.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '6d ago',
		                postedAt: daysAgo(6, 20)
		            },
		            {
		                id: 'comp-leon',
		                alias: 'Leon H.',
		                age: 34,
		                tagline: 'Beer gardens + museum afternoons.',
		                description: '18+ companionship. Respectful meetups and thoughtful conversation.',
		                country: 'Germany',
		                region: 'Bavaria',
		                city: 'Munich',
		                gender: 'Man',
		                seeking: 'Museums, dinners, and weekend markets.',
		                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '7d ago',
		                postedAt: daysAgo(7, 70)
		            },
		            {
		                id: 'comp-selma',
		                alias: 'Selma V.',
		                age: 28,
		                tagline: 'Gallery hops + ramen nights.',
		                description: '18+ companionship. Respectful plans with good conversation.',
		                country: 'Germany',
		                region: 'North Rhine-Westphalia',
		                city: 'Cologne',
		                gender: 'Woman',
		                seeking: 'City walks, caf茅s, and shows.',
		                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '12m ago',
		                postedAt: daysAgo(3, 40)
		            },
		            {
		                id: 'comp-nico',
		                alias: 'Nico S.',
		                age: 31,
		                tagline: 'Harbor walks + live jazz.',
		                description: '18+ companionship. Calm, respectful meetups for dinners and music.',
		                country: 'Germany',
		                region: 'Hamburg',
		                city: 'Hamburg',
		                gender: 'Man',
		                seeking: 'Jazz bars and cozy dinners.',
		                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '8d ago',
		                postedAt: daysAgo(8, 10)
		            },
		            {
		                id: 'comp-claire',
		                alias: 'Claire D.',
		                age: 30,
		                tagline: 'Wine bars + river strolls.',
		                description: '18+ companionship. Respectful plans and easy conversation.',
		                country: 'France',
		                region: 'Auvergne-Rhone-Alpes',
		                city: 'Lyon',
		                gender: 'Woman',
		                seeking: 'Dinners, museums, and city walks.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '9d ago',
		                postedAt: daysAgo(9, 5)
		            },
		            {
		                id: 'comp-sofia-sev',
		                alias: 'Sofia M.',
		                age: 29,
		                tagline: 'Tapas + city nights.',
		                description: '18+ companionship. Respectful dinner plans and events.',
		                country: 'Spain',
		                region: 'Andalusia',
		                city: 'Seville',
		                gender: 'Woman',
		                seeking: 'Food spots and city exploring.',
		                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '10d ago',
		                postedAt: daysAgo(10, 30)
		            },
		            {
		                id: 'comp-vito',
		                alias: 'Vito R.',
		                age: 35,
		                tagline: 'Seaside dinners + old town walks.',
		                description: '18+ companionship. Respectful meetups and calm conversation.',
		                country: 'Italy',
		                region: 'Campania',
		                city: 'Naples',
		                gender: 'Man',
		                seeking: 'Dinners, museums, and city nights.',
		                photo: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '12d ago',
		                postedAt: daysAgo(12, 45)
		            },
		            {
		                id: 'comp-lucia',
		                alias: 'Lucia V.',
		                age: 28,
		                tagline: 'Coffee dates + city exploring.',
		                description: '18+ companionship. Respectful plans and easy conversation.',
		                country: 'Mexico',
		                region: 'Nuevo Leon',
		                city: 'Monterrey',
		                gender: 'Woman',
		                seeking: 'Food spots and relaxed plans.',
		                photo: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=500&h=650',
		                online: true,
		                premium: false,
		                lastActive: '1h ago',
		                postedAt: daysAgo(0, 65)
		            },
		            {
		                id: 'comp-bruno',
		                alias: 'Bruno P.',
		                age: 33,
		                tagline: 'Street food + live music.',
		                description: '18+ companionship. Respectful meetups and good vibes.',
		                country: 'Brazil',
		                region: 'Sao Paulo',
		                city: 'Sao Paulo',
		                gender: 'Man',
		                seeking: 'Music events, dinners, and city nights.',
		                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: false,
		                lastActive: '11d ago',
		                postedAt: daysAgo(11, 20)
		            },
		            {
		                id: 'comp-mariana',
		                alias: 'Mariana S.',
		                age: 27,
		                tagline: 'Sunset walks + local markets.',
		                description: '18+ companionship. Respectful meetups: dinners, events, and city exploring.',
		                country: 'Brazil',
		                region: 'Bahia',
		                city: 'Salvador',
		                gender: 'Woman',
		                seeking: 'Markets, caf茅s, and calm conversation.',
		                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
		                online: false,
		                premium: true,
		                lastActive: '13d ago',
		                postedAt: daysAgo(13, 15)
		            },
			            {
			                id: 'comp-sibusiso',
			                alias: 'Sibusiso N.',
			                age: 32,
			                tagline: 'Beach walks + city nights.',
			                description: '18+ companionship. Respectful meetups and easygoing conversation.',
			                country: 'South Africa',
			                region: 'KwaZulu-Natal',
			                city: 'Durban',
			                gender: 'Man',
			                seeking: 'Dinners, beach walks, and events.',
			                photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '14d ago',
			                postedAt: daysAgo(14, 5)
			            },
			            {
			                id: 'comp-ivy-montreal',
			                alias: 'Ivy L.',
			                age: 29,
			                tagline: 'Bookshops + caf茅 nights.',
			                description: '18+ companionship. Respectful meetups for dinners, museums, and cozy winter walks.',
			                country: 'Canada',
			                region: 'Quebec',
			                city: 'Montreal',
			                gender: 'Woman',
			                seeking: 'Coffee dates, galleries, and easy conversation.',
			                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: 'Online now',
			                postedAt: daysAgo(0, 14),
			                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
			            },
			            {
			                id: 'comp-greta-munich',
			                alias: 'Greta S.',
			                age: 31,
			                tagline: 'Dinner dates + museum afternoons.',
			                description: '18+ companionship. Respectful meetups: city walks, exhibits, and calm evenings.',
			                country: 'Germany',
			                region: 'Bavaria',
			                city: 'Munich',
			                gender: 'Woman',
			                seeking: 'Museums, dinner dates, and good conversation.',
			                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
			                online: false,
			                premium: true,
			                lastActive: '2h ago',
			                postedAt: daysAgo(0, 140)
			            },
			            {
			                id: 'comp-thabo-johannesburg',
			                alias: 'Thabo K.',
			                age: 34,
			                tagline: 'Local markets + live music.',
			                description: '18+ companionship. Respectful meetups for events, dinners, and city exploring.',
			                country: 'South Africa',
			                region: 'Gauteng',
			                city: 'Johannesburg',
			                gender: 'Man',
			                seeking: 'Concerts, markets, and relaxed conversation.',
			                photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
			                online: false,
			                premium: false,
			                lastActive: '1d ago',
			                postedAt: daysAgo(1, 45)
			            },
			            {
			                id: 'comp-mika-kyoto',
			                alias: 'Mika (Wellness)',
			                age: 28,
			                tagline: 'Stretch + wellness reset.',
			                description: 'Wellness-only sessions (non-sexual). 18+ respectful bookings.',
			                country: 'Japan',
			                region: 'Kyoto Prefecture',
			                city: 'Kyoto',
			                gender: 'Woman',
			                seeking: 'Wellness clients and calm conversation.',
			                serviceCategory: 'massage',
			                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
			                online: true,
			                premium: false,
			                lastActive: '18m ago',
			                postedAt: daysAgo(0, 55)
			            },
			            {
			                id: 'comp-layla-dubai',
			                alias: 'Layla R.',
			                age: 30,
			                tagline: 'Gigs & jobs  event help + errands.',
			                description: 'Available for short gigs: event assistance, deliveries, and day-of help. 18+ respectful requests only.',
			                country: 'United Arab Emirates',
			                region: 'Dubai',
			                city: 'Dubai',
			                gender: 'Woman',
			                seeking: 'Short gigs and city-day planning.',
			                serviceCategory: 'gigs_jobs',
			                photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650',
			                online: false,
			                premium: false,
			                lastActive: '3d ago',
			                postedAt: daysAgo(3, 120)
			            }
			        ];

	        return profiles.map((profile) => {
	            const key = `${profile.city}|${profile.country}`;
            const coords = this.companionshipCityGeo[key] || {};
            return {
                ...profile,
                photos: profile.photos && profile.photos.length ? profile.photos : [profile.photo],
                postedAt: profile.postedAt instanceof Date
                    ? profile.postedAt
                    : new Date(now.getTime() - minutesFromLabel(profile.lastActive) * 60000),
                lat: profile.lat || coords.lat,
                lng: profile.lng || coords.lng
            };
        });
    }

    loadSampleDatingCategoryFeeds() {
        const baseNow = new Date();
        const updateTime = (mins) => {
            const d = new Date(baseNow.getTime() - mins * 60000);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        return {
            serious_long_term: [
                {
                    id: 'sl1',
                    title: 'Elena, 30  Product Strategist',
                    subtitle: 'Ready to build something lasting with someone grounded',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1502685104226-ee32379fefbe?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1528763380143-65b3f6ebfcfe?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Weekend hikes, volunteering at the animal shelter, and planning the next big step. Looking for a steady partner who values emotional intelligence and long-term goals.',
                    distance: 5,
                    updated: updateTime(35),
                    online: true,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Values-aligned', 'Family-ready', 'Verified']
                },
                {
                    id: 'sl2',
                    title: 'Marcus, 33  Architect',
                    subtitle: 'Dream home designer looking for co-architect of life',
                    photos: [
                        'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1531746790731-6c087fecd65a?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Mentor to young designers, loves cooking for friends, and exploring new jazz lounges. Searching for someone who appreciates depth, loyalty, and weekend getaways.',
                    distance: 9,
                    updated: updateTime(82),
                    online: false,
                    premium: false,
                    tags: ['Intentional', 'Jazz nights', 'Ambitious']
                }
            ],
            casual_dating: [
                {
                    id: 'cd1',
                    title: 'Keisha, 27  Creative Producer',
                    subtitle: 'Chronicles of spontaneous city dates',
                    photos: [
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1520854221050-0f4caff449fb?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Live music pop-ups, rooftop movies, and taste-testing the latest food truck menus. Open to fun chemistry without the pressure.',
                    distance: 3,
                    updated: updateTime(20),
                    online: true,
                    premium: false,
                    tags: ['Spontaneous', 'Live music', 'Good vibes']
                },
                {
                    id: 'cd2',
                    title: 'Theo, 29  UX Researcher',
                    subtitle: 'Curious conversationalist seeking easygoing connections',
                    photos: [
                        'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Shares playlists, loves late-night coffee, and respects boundaries. Down for casual dinners or gallery strolls.',
                    distance: 11,
                    updated: updateTime(64),
                    online: false,
                    premium: false,
                    tags: ['Laid-back', 'Playlist swaps']
                }
            ],
            friendship: [
                {
                    id: 'fr1',
                    title: 'Sasha, 26  ER Nurse',
                    subtitle: 'Looking for new brunch buddies and art gallery partners',
                    photos: [
                        'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1520854221050-0f4caff449fb?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Rotating day-off adventures: pottery classes, dog park meetups, and chill movie nights. Seeking authentic, drama-free connections.',
                    distance: 4,
                    updated: updateTime(15),
                    online: true,
                    premium: false,
                    tags: ['Dog lover', 'Art tours', 'Early bird']
                },
                {
                    id: 'fr2',
                    title: 'Jun, 31  Indie Game Dev',
                    subtitle: 'Co-op gamer open to IRL hangouts',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1502764613149-7f1d229e230f?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1506086679524-493c64fdfaa6?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Hosting board game nights, joining trivia teams, and scouting the best ramen in town. Always down for friendship-first meetups.',
                    distance: 8,
                    updated: updateTime(48),
                    online: true,
                    premium: false,
                    tags: ['Board games', 'Ramen runs', 'Pixel art']
                }
            ],
            arrive_plus: [
                {
                    id: 'ap1',
                    title: 'Layla, 26  Arrival Host',
                    subtitle: 'Landing at 7pm  dinner + city walk?',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Arriving tonight and looking for a relaxed dinner with someone who knows the city. Low-pressure, public meetup.',
                    distance: 2,
                    updated: updateTime(14),
                    online: true,
                    premium: true,
                    tags: ['Arriving tonight', 'City walk', 'Verified']
                },
                {
                    id: 'ap2',
                    title: 'Noah, 30  Travel Consultant',
                    subtitle: 'Layover lounge meetup for coffee',
                    photos: [
                        'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Long layover and looking for a friendly conversation over coffee. Quick meet, easygoing vibe.',
                    distance: 5,
                    updated: updateTime(48),
                    online: false,
                    premium: false,
                    tags: ['Layover', 'Coffee', 'Easygoing']
                }
            ],
            travel_vacation: [
                {
                    id: 'tv1',
                    title: 'Camila, 32  Flight Attendant',
                    subtitle: 'Layover in SF for 48 hoursseeking local guide',
                    photos: [
                        'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Knows the best hidden beaches and city skylines. Loves swapping travel stories over good espresso. Looking for respectful, curious explorers.',
                    distance: 2,
                    updated: updateTime(10),
                    online: true,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Globetrotter', 'Coffee tours', 'Layover meet']
                },
                {
                    id: 'tv2',
                    title: 'Rafael, 34  Travel Filmmaker',
                    subtitle: 'Planning a Bay Area food reelseeking camera confident local',
                    photos: [
                        'https://images.unsplash.com/photo-1507537297725-24a1c029d3ca?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Surf sunrise, film sunset. Flexible schedules welcome. Open to building long-distance vibes if we click.',
                    distance: 14,
                    updated: updateTime(95),
                    online: false,
                    premium: false,
                    tags: ['Foodie', 'Sunrise chaser', 'Cinema grade']
                }
            ],
            networking_social: [
                {
                    id: 'ns1',
                    title: 'Avery, 28  Tech Community Lead',
                    subtitle: 'Hosts monthly founder mixers and wants new co-host energy',
                    photos: [
                        'https://images.unsplash.com/photo-1463453091185-61582044d556?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Building inclusive spaces for diverse founders. Seeking collaboration-minded people who love connecting talent.',
                    distance: 1,
                    updated: updateTime(5),
                    online: true,
                    premium: false,
                    tags: ['Startups', 'Inclusive', 'Connector']
                },
                {
                    id: 'ns2',
                    title: 'Priyanka, 35  Fashion Buyer',
                    subtitle: 'In town for market weekcoffee chats welcome',
                    photos: [
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Organizing intimate salon dinners and designer walk-throughs. Looking to expand creative network while in the city.',
                    distance: 7,
                    updated: updateTime(57),
                    online: false,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Fashion week', 'Salon dinners', 'Creative minds']
                }
            ],
            companionship: [
                {
                    id: 'co1',
                    title: 'Nora, 65  Retired Photojournalist',
                    subtitle: 'Storytelling walks along the Embarcadero',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524613032530-9644d66eb1ba?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Capturing daily life with a vintage Leica. Seeking thoughtful companionship for museum days and jazz evenings.',
                    distance: 6,
                    updated: updateTime(42),
                    online: true,
                    premium: false,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    videoDuration: 10,
                    tags: ['Storyteller', 'Jazz clubs', 'Museum member']
                },
                {
                    id: 'co2',
                    title: 'Samuel, 58  Chef Instructor',
                    subtitle: 'Hosting small supper clubslooking for a co-host',
                    photos: [
                        'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Farmers market mornings, recipe testing afternoons, and teaching seasonal cooking. Open to platonic or gentle romantic companionship.',
                    distance: 12,
                    updated: updateTime(120),
                    online: false,
                    premium: false,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    videoDuration: 10,
                    tags: ['Culinary arts', 'Supper club', 'Warm presence']
                }
            ],
            instant_meetups: [
                {
                    id: 'im1',
                    title: 'Liv, 24  DJ & Community Organizer',
                    subtitle: 'Pop-up set in SoMa tonightlooking for hype crew',
                    photos: [
                        'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Hosting a midnight set at an art loft. DM if you vibe with disco-house and can pull up within the hour.',
                    distance: 2,
                    updated: updateTime(3),
                    online: true,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Tonight', 'Disco house', 'Community']
                },
                {
                    id: 'im2',
                    title: 'Chris, 27  Fitness Coach',
                    subtitle: 'Sunset run across the Golden Gate in 30 minjoin?',
                    photos: [
                        'https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Training for a charity 10k. Looking for a friendly pace partner and smoothie after.',
                    distance: 4,
                    updated: updateTime(12),
                    online: true,
                    premium: false,
                    tags: ['Sunset run', 'Charity 10k', 'Smoothie stop']
                }
            ],
            virtual_video: [
                {
                    id: 'vv1',
                    title: 'Aria, 25  Voice Actor',
                    subtitle: 'Hosting weekly virtual game nights & cozy chats',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Anime marathons, cozy art streams, and learning languages via video dates. Prefers meeting online first, open to offline later.',
                    distance: 0,
                    updated: updateTime(8),
                    online: true,
                    premium: false,
                    tags: ['Virtual first', 'Creative', 'Art streams']
                },
                {
                    id: 'vv2',
                    title: 'Dmitri, 31  Remote Data Scientist',
                    subtitle: 'Coffee over video before planning in-person',
                    photos: [
                        'https://images.unsplash.com/photo-1502767089025-6572583495b0?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Leads a distributed team across time zones. Available for late-night chats and online co-working sessions.',
                    distance: 0,
                    updated: updateTime(55),
                    online: false,
                    premium: false,
                    tags: ['Remote life', 'Co-working', 'Night owl']
                }
            ],
            exclusive_premium: [
                {
                    id: 'ep1',
                    title: 'The Velvet Circle  Invite-only Salon',
                    subtitle: 'Curated events for vetted professionals and creatives',
                    photos: [
                        'https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Next gathering: speakeasy jazz salon with chef-paired tasting. Premium members get first access.',
                    distance: 5,
                    updated: updateTime(25),
                    online: false,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Invite-only', 'Salon', 'Premium']
                },
                {
                    id: 'ep2',
                    title: 'Isabelle, 29  Luxury Travel Curator',
                    subtitle: 'Planning a private coastal retreat for six vetted matches',
                    photos: [
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Looking for confident, goal-driven individuals who enjoy bespoke experiences and value discretion.',
                    distance: 7,
                    updated: updateTime(90),
                    online: true,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Bespoke', 'Retreat', 'Discreet']
                }
            ],
            premium_18_plus: [
                {
                    id: 'p18-1',
                    title: 'Verified 18+ Social Lounge',
                    subtitle: 'Age-verified events and respectful connections',
                    photos: [
                        'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Age-verified socials, clear rules, and safety-focused moderation. Meet in public and report bad behavior.',
                    distance: 3,
                    updated: updateTime(18),
                    online: false,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Verified', 'Moderated', 'Adults only']
                },
                {
                    id: 'p18-2',
                    title: 'Sloane, 28  Verified Member',
                    subtitle: 'Looking for dinner dates and event partners',
                    photos: [
                        'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=500&h=650',
                        'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=500&h=650'
                    ],
                    description: 'Respectful 18+ dating. Prefers public meetups, clear boundaries, and slow-burn conversation.',
                    distance: 6,
                    updated: updateTime(52),
                    online: true,
                    premium: true,
                    video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
                    tags: ['Verified', 'Boundaries', 'Adults only']
                }
            ]
        };
    }

		    setupEventListeners() {
        // Auth events (legacy landing flow)
        const loginForm = document.getElementById('login-form');
        if (loginForm) loginForm.addEventListener('submit', (e) => this.handleLogin(e));
        const signupForm = document.getElementById('signup-form');
        if (signupForm) signupForm.addEventListener('submit', (e) => this.handleSignup(e));
        const showSignupLink = document.getElementById('show-signup');
        if (showSignupLink) showSignupLink.addEventListener('click', () => this.showSignupScreen());
        const showLoginLink = document.getElementById('show-login');
        if (showLoginLink) showLoginLink.addEventListener('click', () => this.showLoginScreen());
	    const loginClose = document.getElementById('login-close');
	    if (loginClose) loginClose.addEventListener('click', () => this.cancelAuthFlow());
	    const signupClose = document.getElementById('signup-close');
	    if (signupClose) signupClose.addEventListener('click', () => this.cancelAuthFlow());
	        const onboardingForm = document.getElementById('onboarding-form');
	        if (onboardingForm) onboardingForm.addEventListener('submit', (e) => this.handleOnboardingSubmit(e));
        const onboardingNext = document.getElementById('onboarding-next');
        if (onboardingNext) onboardingNext.addEventListener('click', () => this.advanceOnboarding(1));
        const onboardingBack = document.getElementById('onboarding-back');
        if (onboardingBack) onboardingBack.addEventListener('click', () => this.advanceOnboarding(-1));
        const onboardingSkip = document.getElementById('onboarding-skip');
        if (onboardingSkip) onboardingSkip.addEventListener('click', () => this.completeOnboarding({ skipped: true }));
        const onboardingClose = document.getElementById('onboarding-close');
        if (onboardingClose) onboardingClose.addEventListener('click', () => this.completeOnboarding({ skipped: true }));

        this.setupNotificationCenter();

        // Navigation events
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.switchScreen(e.target.closest('.nav-btn').dataset.screen));
        });

	        const navBackBtn = document.getElementById('nav-back');
	        if (navBackBtn) navBackBtn.addEventListener('click', () => this.navigateBack());
	        const navForwardBtn = document.getElementById('nav-forward');
	        if (navForwardBtn) navForwardBtn.addEventListener('click', () => this.navigateForward());
	        const navBackFloat = document.getElementById('nav-back-float');
	        if (navBackFloat) navBackFloat.addEventListener('click', () => this.navigateBack());
	        const navForwardFloat = document.getElementById('nav-forward-float');
	        if (navForwardFloat) navForwardFloat.addEventListener('click', () => this.navigateForward());

	        const communityPromote = document.getElementById('community-promote-ad');
	        if (communityPromote && !communityPromote.dataset.bound) {
	            communityPromote.addEventListener('click', () => {
	                this.showPostItemModal({ category: 'community', placement: 'community_featured', luxe: true });
	            });
	            communityPromote.dataset.bound = '1';
	        }

	        const communityBack = document.getElementById('community-back');
	        if (communityBack && !communityBack.dataset.bound) {
	            communityBack.addEventListener('click', () => {
	                if (this.browserHistoryIndex > 0) window.history.back();
	                else this.switchScreen('home');
	            });
	            communityBack.dataset.bound = '1';
	        }
	        const personalBack = document.getElementById('personal-back');
	        if (personalBack && !personalBack.dataset.bound) {
	            personalBack.addEventListener('click', () => {
	                if (this.browserHistoryIndex > 0) window.history.back();
	                else this.switchScreen('premium');
	            });
	            personalBack.dataset.bound = '1';
	        }

	        const chatNavBack = document.getElementById('chat-nav-back');
	        if (chatNavBack && !chatNavBack.dataset.bound) {
	            chatNavBack.addEventListener('click', () => window.history.back());
	            chatNavBack.dataset.bound = '1';
	        }
	        const chatNavForward = document.getElementById('chat-nav-forward');
	        if (chatNavForward && !chatNavForward.dataset.bound) {
	            chatNavForward.addEventListener('click', () => window.history.forward());
	            chatNavForward.dataset.bound = '1';
	        }

	        // Swipe events
	        document.getElementById('like-btn')?.addEventListener('click', () => this.likeUser());
	        document.getElementById('reject-btn')?.addEventListener('click', () => this.rejectUser());

	        // Home Discover section collapse/expand
	        const homeDiscoverSection = document.querySelector('#home-content .home-discover');
	        const homeDiscoverToggle = document.getElementById('home-discover-toggle');
	        const homeDiscoverBody = document.getElementById('home-discover-body');
	        if (homeDiscoverSection && homeDiscoverToggle && homeDiscoverBody && !homeDiscoverToggle.dataset.bound) {
	            const applyDiscoverState = (collapsed) => {
	                const isCollapsed = collapsed === true;
	                homeDiscoverSection.classList.toggle('is-collapsed', isCollapsed);
	                homeDiscoverToggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
	                homeDiscoverToggle.setAttribute('aria-label', isCollapsed ? 'Expand Discover' : 'Collapse Discover');
	                const icon = homeDiscoverToggle.querySelector('i');
	                if (icon) {
	                    icon.classList.toggle('fa-chevron-up', !isCollapsed);
	                    icon.classList.toggle('fa-chevron-down', isCollapsed);
	                }
	                const label = homeDiscoverToggle.querySelector('.home-discover-toggle-label');
	                if (label) label.textContent = isCollapsed ? 'Expand' : 'Collapse';
	            };

	            applyDiscoverState(localStorage.getItem('homeDiscoverCollapsed') === '1');
	            homeDiscoverToggle.addEventListener('click', (e) => {
	                e.preventDefault();
	                const nextCollapsed = !homeDiscoverSection.classList.contains('is-collapsed');
	                applyDiscoverState(nextCollapsed);
	                localStorage.setItem('homeDiscoverCollapsed', nextCollapsed ? '1' : '0');
	            });
	            homeDiscoverToggle.dataset.bound = '1';
	        }

		        // Discovery feed events
		        const postText = document.getElementById('post-text');
		        const postBtn = document.getElementById('post-btn');
		    const postTitle = document.getElementById('post-title');
		    const postRegion = document.getElementById('post-region');
        const postMediaUpload = document.getElementById('post-media-upload');
        const postMediaPreviews = document.getElementById('post-media-previews');
	        if (postText) postText.addEventListener('input', () => this.updatePostButton());
	    if (postTitle) postTitle.addEventListener('input', () => this.updatePostButton());
	    if (postRegion) postRegion.addEventListener('input', () => this.updatePostButton());
	        if (postBtn) postBtn.addEventListener('click', () => this.createDiscoveryPost());
        if (postMediaUpload && !postMediaUpload.dataset.bound) {
            postMediaUpload.addEventListener('change', (e) => this.addDiscoveryPostUploads(e.target.files));
            postMediaUpload.dataset.bound = '1';
        }
        if (postMediaPreviews && !postMediaPreviews.dataset.bound) {
            postMediaPreviews.addEventListener('click', (e) => {
                const btn = e.target?.closest?.('.market-upload-remove');
                if (!btn) return;
                const id = btn.parentElement?.dataset?.id;
                this.removeDiscoveryPostUpload(id);
            });
            postMediaPreviews.dataset.bound = '1';
        }
        this.renderDiscoveryPostUploads(postMediaPreviews);

	        const geoCitySearch = document.getElementById('geo-search-city');
	        if (geoCitySearch && !geoCitySearch.dataset.bound) {
	            geoCitySearch.addEventListener('input', (e) => this.handleGeoSearchInput('city', e.target.value));
	            geoCitySearch.dataset.bound = '1';
        }
        const geoCountrySearch = document.getElementById('geo-search-country');
        if (geoCountrySearch && !geoCountrySearch.dataset.bound) {
            geoCountrySearch.addEventListener('input', (e) => this.handleGeoSearchInput('country', e.target.value));
            geoCountrySearch.dataset.bound = '1';
        }

        // Discovery filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                this.filterDiscoveryPosts(target.dataset.filter || 'all');
            });
            btn.dataset.bound = '1';
        });

        // Discovery geo filter buttons
        document.querySelectorAll('.geo-filter-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                this.handleGeoFilterSelection(target.dataset.geo || 'worldwide');
            });
            btn.dataset.bound = '1';
        });


        // Location events
        document.getElementById('location-btn')?.addEventListener('click', () => this.updateLocation());
        document.getElementById('distance-range')?.addEventListener('input', (e) => this.updateDistanceFilter(e.target.value));
        const nearbyOnlineOnly = document.getElementById('nearby-online-only');
        if (nearbyOnlineOnly && !nearbyOnlineOnly.dataset.bound) {
            nearbyOnlineOnly.addEventListener('change', () => {
                this.nearbyOnlineOnly = Boolean(nearbyOnlineOnly.checked);
                this.updateNearbyList();
                this.updateMapMarkers({ fitToResults: Boolean(this.nearbyCountryFilter) });
            });
            nearbyOnlineOnly.dataset.bound = '1';
        }
        const nearbySearch = document.getElementById('nearby-search');
        const nearbySearchBtn = document.getElementById('nearby-search-btn');
        if (nearbySearch && !nearbySearch.dataset.bound) {
            const runNearbySearch = (opts = {}) => {
                const raw = (nearbySearch.value || '').trim();
                this.nearbySearchQueryRaw = raw;
                this.nearbySearchQuery = raw.toLowerCase();
                this.nearbyCountryFilter = this.resolveNearbyCountryFilter(raw);
                this.updateNearbyList();
                this.updateMapMarkers({ fitToResults: Boolean(this.nearbyCountryFilter) || opts.fitToResults === true });

                if (this.nearbyCountryFilter) {
                    const showMapToggle = document.getElementById('show-map-toggle');
                    const mapContainer = document.getElementById('map-container');
                    if (showMapToggle && mapContainer) {
                        if (!showMapToggle.checked) {
                            showMapToggle.checked = true;
                            mapContainer.classList.remove('hidden');
                        }
                        if (!this.googleMap) {
                            void this.initializeMap().then(() => this.updateMapMarkers({ fitToResults: true }));
                        } else {
                            this.updateMapMarkers({ fitToResults: true });
                        }
                    }
                }
            };

            nearbySearch.addEventListener('input', () => runNearbySearch());
            nearbySearch.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                runNearbySearch({ fitToResults: true });
            });
            if (nearbySearchBtn && !nearbySearchBtn.dataset.bound) {
                nearbySearchBtn.addEventListener('click', () => runNearbySearch({ fitToResults: true }));
                nearbySearchBtn.dataset.bound = '1';
            }
            nearbySearch.dataset.bound = '1';
        }
        const refreshNearby = document.getElementById('refresh-nearby');
        if (refreshNearby && !refreshNearby.dataset.bound) {
            refreshNearby.addEventListener('click', () => {
                this.showNotification('Refreshing nearby');
                this.requestLocationPermission();
                this.updateNearbyList();
            });
            refreshNearby.dataset.bound = '1';
        }
        const showMapToggle = document.getElementById('show-map-toggle');
        const mapContainer = document.getElementById('map-container');
        if (showMapToggle && mapContainer && !showMapToggle.dataset.bound) {
            showMapToggle.addEventListener('change', () => {
                mapContainer.classList.toggle('hidden', !showMapToggle.checked);
                if (showMapToggle.checked) this.initializeMap();
            });
            showMapToggle.dataset.bound = '1';
        }

	        // Profile events
	        document.getElementById('save-profile').addEventListener('click', () => this.saveProfile());
	        const walletAdd = document.getElementById('wallet-add');
	        if (walletAdd && !walletAdd.dataset.bound) {
	            walletAdd.addEventListener('click', () => this.openAddCreditsPrompt());
	            walletAdd.dataset.bound = '1';
	        }
	        const walletPayout = document.getElementById('wallet-payout');
	        if (walletPayout && !walletPayout.dataset.bound) {
	            walletPayout.addEventListener('click', () => {
	                this.showNotification('Payout requested (demo).', { force: true });
	            });
	            walletPayout.dataset.bound = '1';
	        }
	        const myPosts = document.getElementById('my-posts-list');
	        if (myPosts && !myPosts.dataset.bound) {
	            myPosts.addEventListener('click', (e) => this.handleMyPostsClick(e));
	            myPosts.dataset.bound = '1';
	        }
	        const profilePromoteOpen = document.getElementById('profile-promote-open');
	        if (profilePromoteOpen && !profilePromoteOpen.dataset.bound) {
	            profilePromoteOpen.addEventListener('click', () => this.openProfilePromoteBuilder());
	            profilePromoteOpen.dataset.bound = '1';
	        }
	        const profileUsername = document.getElementById('profile-username');
	        if (profileUsername && !profileUsername.dataset.bound) {
	            profileUsername.addEventListener('input', () => {
	                const nextName = (profileUsername.value || '').trim();
                const profileName = document.getElementById('profile-name');
                if (profileName) profileName.textContent = nextName || this.currentUser?.name || 'Your Name';
            });
            profileUsername.dataset.bound = '1';
        }
	        const profileMapVisible = document.getElementById('profile-map-visible');
	        if (profileMapVisible && !profileMapVisible.dataset.bound) {
	            profileMapVisible.addEventListener('change', () => {
	                this.currentUser.mapVisible = Boolean(profileMapVisible.checked);
	                try { localStorage.setItem('hs_map_visible', this.currentUser.mapVisible ? 'true' : 'false'); } catch {}
	                this.updateMapMarkers();
	                this.updateNearbyList();
	            });
	            profileMapVisible.dataset.bound = '1';
	        }
	        document.getElementById('interest-input').addEventListener('keypress', (e) => {
	            if (e.key === 'Enter') this.addInterest(e.target.value);
	        });

        // Chat events
        document.getElementById('send-message').addEventListener('click', () => this.sendMessage());
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });
        // Mac window controls for chat are bound in setupMacWindowControls()

        // Match modal events
        document.getElementById('keep-swiping').addEventListener('click', () => this.closeMatchModal());
        document.getElementById('send-message-btn').addEventListener('click', () => this.openChatFromMatch());
        const matchClose = document.getElementById('match-close');
        if (matchClose && !matchClose.dataset.bound) {
            matchClose.addEventListener('click', () => this.closeMatchModal());
            matchClose.dataset.bound = '1';
        }

        // Card swipe events (legacy)
        this.setupCardSwipe();

        // Availability Planner
        const availabilityForm = document.getElementById('availabilityForm');
        if (availabilityForm) availabilityForm.addEventListener('submit', (e) => this.handleAvailabilitySubmit(e));

        // Premium Personal section
        const personalSelect = document.getElementById('personal-category');
        if (personalSelect) personalSelect.addEventListener('change', (e) => this.handlePersonalChange(e));

	        // Premium: subscribe button
	        const startPremiumBtn = document.getElementById('start-premium-btn');
	        if (startPremiumBtn) startPremiumBtn.addEventListener('click', () => this.requireAgeGate(() => this.startPremium()));

		        // Marketplace events
		        const postItemBtn = document.getElementById('post-item-btn');
		        if (postItemBtn) postItemBtn.addEventListener('click', () => this.showPostItemModal());

		        const marketplacePromoteBtn = document.getElementById('marketplace-promote-ad');
		        if (marketplacePromoteBtn && !marketplacePromoteBtn.dataset.bound) {
		            marketplacePromoteBtn.addEventListener('click', () => {
		                const categoryFilter = document.getElementById('category-filter');
		                const filterValue = (categoryFilter?.value || '').trim();
		                const itemCategorySelect = document.getElementById('item-category');
		                const canUseFilterValue = Boolean(
		                    filterValue
		                    && itemCategorySelect
		                    && Array.from(itemCategorySelect.options).some((opt) => opt.value === filterValue)
		                );
			                this.showPostItemModal({
			                    category: canUseFilterValue ? filterValue : undefined,
			                    placement: 'marketplace_featured',
			                    luxe: true
			                });
		            });
		            marketplacePromoteBtn.dataset.bound = '1';
		        }
		        
		        const postItemForm = document.getElementById('post-item-form');
		        if (postItemForm) postItemForm.addEventListener('submit', (e) => this.handlePostItem(e));
	            const postAdForm = document.getElementById('post-ad-form');
	            if (postAdForm && !postAdForm.dataset.bound) {
	                postAdForm.addEventListener('submit', (e) => this.handlePostAdSubmit(e));
                const desc = document.getElementById('ad-description');
                if (desc) {
                    desc.addEventListener('input', () => {
                        this.postAdDraft.description = desc.value;
                    });
                }
                const cat = document.getElementById('ad-category');
                if (cat) {
                    cat.addEventListener('change', () => {
                        this.postAdDraft.category = cat.value;
                    });
                }
                postAdForm.dataset.bound = '1';
            }
            ['nearby-ad-cta', 'dating-ad-cta', 'companionship-ad-cta'].forEach((id) => {
                const btn = document.getElementById(id);
                if (!btn || btn.dataset.bound) return;
                btn.addEventListener('click', () => {
                    if (id === 'companionship-ad-cta') {
                        this.promoteCompanionshipAds();
                        return;
                    }
                    this.showPostAdModal();
                });
                btn.dataset.bound = '1';
            });
	        this.bindPostItemCategory();
        this.setupMacWindowControls();
        this.bindServiceModal();
        this.bindLuxuryAdModal();
        const postItemPlacement = document.getElementById('item-placement');
        if (postItemPlacement && !postItemPlacement.dataset.boundService) {
            postItemPlacement.addEventListener('change', () => {
                const category = document.getElementById('item-category')?.value || '';
                this.updatePostItemCategoryFields(category);
            });
            postItemPlacement.dataset.boundService = '1';
        }
        const postItemFeatured = document.getElementById('item-featured');
        if (postItemFeatured && !postItemFeatured.dataset.boundService) {
            postItemFeatured.addEventListener('change', () => {
                const category = document.getElementById('item-category')?.value || '';
                this.updatePostItemCategoryFields(category);
            });
            postItemFeatured.dataset.boundService = '1';
        }

        const servicesPostBtn = document.getElementById('services-post-btn');
        if (servicesPostBtn && !servicesPostBtn.dataset.bound) {
            servicesPostBtn.addEventListener('click', () => {
                this.showPostItemModal({ category: 'services', placement: 'services' });
            });
            servicesPostBtn.dataset.bound = '1';
        }
        const servicesPromoteBtn = document.getElementById('services-promote-btn');
        if (servicesPromoteBtn && !servicesPromoteBtn.dataset.bound) {
            servicesPromoteBtn.addEventListener('click', () => {
                this.showPostItemModal({ category: 'services', placement: 'services_featured', luxe: true });
            });
            servicesPromoteBtn.dataset.bound = '1';
        }
        const serviceAvailabilitySelect = document.getElementById('service-availability-window');
        if (serviceAvailabilitySelect && !serviceAvailabilitySelect.dataset.bound) {
            serviceAvailabilitySelect.addEventListener('change', () => {
                const wrap = document.getElementById('service-availability-other-wrap');
                if (!wrap) return;
                wrap.classList.toggle('hidden', serviceAvailabilitySelect.value !== 'Other');
            });
            serviceAvailabilitySelect.dataset.bound = '1';
        }
        const servicesQuoteBtn = document.getElementById('services-quote-btn');
        if (servicesQuoteBtn && !servicesQuoteBtn.dataset.bound) {
            servicesQuoteBtn.addEventListener('click', () => {
                const quoteModal = document.getElementById('quote-modal');
                if (quoteModal) quoteModal.classList.remove('hidden');
            });
            servicesQuoteBtn.dataset.bound = '1';
        }
        const quoteCancel = document.getElementById('quote-cancel');
        if (quoteCancel && !quoteCancel.dataset.bound) {
            quoteCancel.addEventListener('click', () => {
                const quoteModal = document.getElementById('quote-modal');
                if (quoteModal) quoteModal.classList.add('hidden');
            });
            quoteCancel.dataset.bound = '1';
        }

		        // Marketplace filters
	            const categoryFilter = document.getElementById('category-filter');
                const marketSearch = document.getElementById('market-search');
                const marketAiBtn = document.getElementById('market-ai-btn');
	            const countryFilter = document.getElementById('country-filter');
	            const cityFilter = document.getElementById('city-filter');
	            const priceMinInput = document.getElementById('price-filter-min');
	            const priceMaxInput = document.getElementById('price-filter-max');
	            const dateFilter = document.getElementById('date-filter');
	        
		        if (categoryFilter) {
		            const handler = () => this.applyMarketplaceFilters();
		            const eventName = categoryFilter.tagName === 'INPUT' ? 'input' : 'change';
		            categoryFilter.addEventListener(eventName, handler);
		            if (eventName !== 'change') categoryFilter.addEventListener('change', handler);
		        }
                if (marketSearch && !marketSearch.dataset.boundMarketplaceSearch) {
                    marketSearch.addEventListener('input', () => this.applyMarketplaceFilters());
                    marketSearch.addEventListener('keydown', (e) => {
                        if (e.key !== 'Enter') return;
                        e.preventDefault();
                        this.applyMarketplaceFilters();
                    });
                    marketSearch.dataset.boundMarketplaceSearch = '1';
                }
                if (marketAiBtn && !marketAiBtn.dataset.boundMarketplaceAi) {
                    marketAiBtn.addEventListener('click', () => this.applyMarketplaceAiSearch());
                    marketAiBtn.dataset.boundMarketplaceAi = '1';
                }
	            if (countryFilter) countryFilter.addEventListener('input', () => this.applyMarketplaceFilters());
	            if (cityFilter) cityFilter.addEventListener('input', () => this.applyMarketplaceFilters());
	            if (priceMinInput) priceMinInput.addEventListener('input', () => this.applyMarketplaceFilters());
	            if (priceMaxInput) priceMaxInput.addEventListener('input', () => this.applyMarketplaceFilters());
		        if (dateFilter) dateFilter.addEventListener('change', () => this.applyMarketplaceFilters());

	            const advancedToggle = document.getElementById('market-advanced-toggle');
	            const advancedPanel = document.getElementById('market-advanced-filters');
	            if (advancedToggle && advancedPanel && !advancedToggle.dataset.bound) {
                    this.setMarketplaceAdvancedFiltersExpanded(false);
	                advancedToggle.addEventListener('click', () => {
	                    const expanded = advancedToggle.getAttribute('aria-expanded') === 'true';
                        this.setMarketplaceAdvancedFiltersExpanded(!expanded);
	                });
	                advancedToggle.dataset.bound = '1';
	            }

        // Age gate buttons
        const ageConfirm = document.getElementById('age-confirm');
        const ageCancel = document.getElementById('age-cancel');
        const ageGateClose = document.getElementById('age-gate-close');
        if (ageConfirm && !ageConfirm.dataset.bound) {
            ageConfirm.addEventListener('click', () => {
                try { localStorage.setItem('age_verified', 'true'); } catch {}
                this.hideAgeGate();
                const cont = this.afterAgeGateAction;
                this.afterAgeGateAction = null;
                if (typeof cont === 'function') cont();
            });
            ageConfirm.dataset.bound = '1';
        }
        if (ageCancel && !ageCancel.dataset.bound) {
            ageCancel.addEventListener('click', () => {
                this.hideAgeGate();
                this.afterAgeGateAction = null;
            });
            ageCancel.dataset.bound = '1';
        }
        if (ageGateClose && !ageGateClose.dataset.bound) {
            ageGateClose.addEventListener('click', () => {
                this.hideAgeGate();
                this.afterAgeGateAction = null;
            });
            ageGateClose.dataset.bound = '1';
        }

        // Media lightbox controls
        const mediaLightbox = document.getElementById('media-lightbox');
        if (mediaLightbox && !mediaLightbox.dataset.bound) {
            mediaLightbox.addEventListener('click', (e) => {
                if (e.target === mediaLightbox) this.closeMediaLightbox();
            });
            mediaLightbox.dataset.bound = '1';
        }
        const mediaClose = document.getElementById('ml-close');
        if (mediaClose && !mediaClose.dataset.bound) {
            mediaClose.addEventListener('click', () => this.closeMediaLightbox());
            mediaClose.dataset.bound = '1';
        }
        const mediaPrev = document.getElementById('media-lightbox-prev');
        if (mediaPrev && !mediaPrev.dataset.bound) {
            mediaPrev.addEventListener('click', () => this.stepMediaLightbox(-1));
            mediaPrev.dataset.bound = '1';
        }
        const mediaNext = document.getElementById('media-lightbox-next');
        if (mediaNext && !mediaNext.dataset.bound) {
            mediaNext.addEventListener('click', () => this.stepMediaLightbox(1));
            mediaNext.dataset.bound = '1';
        }

        // Location autocomplete (country -> state/province -> city)
        this.setupLocationAutocomplete();

        // Circular video popup controls
        const videoRingModal = document.getElementById('video-ring-modal');
        if (videoRingModal && !videoRingModal.dataset.bound) {
            videoRingModal.addEventListener('click', (e) => {
                if (e.target === videoRingModal) this.closeVideoRingModal();
            });
            videoRingModal.dataset.bound = '1';
        }
        const videoRingClose = document.getElementById('video-ring-close');
        if (videoRingClose && !videoRingClose.dataset.bound) {
            videoRingClose.addEventListener('click', () => this.closeVideoRingModal());
            videoRingClose.dataset.bound = '1';
        }

        const demoModal = document.getElementById('demo-profile-modal');
        if (demoModal && !demoModal.dataset.bound) {
            demoModal.addEventListener('click', (event) => {
                if (event.target === demoModal) this.closeDemoProfile();
            });
            demoModal.dataset.bound = '1';
        }
        const demoClose = document.getElementById('demo-profile-close');
        if (demoClose && !demoClose.dataset.bound) {
            demoClose.addEventListener('click', () => this.closeDemoProfile());
            demoClose.dataset.bound = '1';
        }

	        this.setupProfileModalControls();
        this.setupSellerProfileModalControls();
        this.setupSellerRatingModalControls();
        this.setupMarketplaceItemModalControls();
	        this.setupSafetyModalControls();
	        this.setupPromotionFeeModalControls();

        // SOS modal
        const sosBtn = document.getElementById('sos-btn');
        if (sosBtn) sosBtn.addEventListener('click', () => this.openSosModal());
        const closeSos = document.getElementById('close-sos');
        if (closeSos) closeSos.addEventListener('click', () => this.closeSosModal());
        const sosShareLoc = document.getElementById('sos-share-location');
        if (sosShareLoc) sosShareLoc.addEventListener('click', () => this.shareSosLocation());
        const sosMsg = document.getElementById('sos-message');
        if (sosMsg) sosMsg.addEventListener('click', () => this.sendSosMessage());

        // ETA modal
        const shareEtaBtn = document.getElementById('share-eta-btn');
        if (shareEtaBtn) shareEtaBtn.addEventListener('click', () => this.openEtaModal());
        const closeEta = document.getElementById('close-eta');
        if (closeEta) closeEta.addEventListener('click', () => this.closeEtaModal());
        const shareEtaConfirm = document.getElementById('share-eta-confirm');
        if (shareEtaConfirm) shareEtaConfirm.addEventListener('click', () => this.shareEta());

        // Block / report in chat
        const blockBtn = document.getElementById('block-user-btn');
        if (blockBtn) blockBtn.addEventListener('click', () => this.blockCurrentChatUser());
        const reportBtn = document.getElementById('report-user-btn');
        if (reportBtn) reportBtn.addEventListener('click', () => this.reportCurrentChatUser());

        // Profile photos (3 slots)
        for (let i = 0; i < 3; i++) {
            const changeBtn = document.getElementById(`photo-change-${i}`);
            const removeBtn = document.getElementById(`photo-remove-${i}`);
            const fileInput = document.getElementById(`photo-input-${i}`);
            if (changeBtn && fileInput) {
                changeBtn.addEventListener('click', () => fileInput.click());
            }
            if (fileInput) {
                fileInput.addEventListener('change', (e) => this.onPhotoSelected(e, i));
            }
            if (removeBtn) {
                removeBtn.addEventListener('click', () => this.removePhoto(i));
            }
        }

        // Profile video recorder
        const recordBtn = document.getElementById('record-video-btn');
        const retakeBtn = document.getElementById('retake-video-btn');
        const useBtn = document.getElementById('use-video-btn');
        if (recordBtn) recordBtn.addEventListener('click', () => this.startVideoRecording());
        if (retakeBtn) retakeBtn.addEventListener('click', () => this.retakeVideo());
        if (useBtn) useBtn.addEventListener('click', () => this.useRecordedVideo());
    }

    normalizeLocationText(value) {
        return String(value || '').trim().toLowerCase();
    }

    ensureDatalist(id) {
        if (!id) return null;
        let el = document.getElementById(id);
        if (el) return el;
        el = document.createElement('datalist');
        el.id = id;
        document.body.appendChild(el);
        return el;
    }

    fillDatalist(datalistEl, values = [], limit = 500) {
        if (!datalistEl) return;
        const unique = Array.from(new Set((values || []).map(v => String(v || '').trim()).filter(Boolean)));
        unique.sort((a, b) => a.localeCompare(b));
        const capped = unique.slice(0, Math.max(0, limit));
        datalistEl.innerHTML = capped.map(v => `<option value="${this.escapeHtml(v)}"></option>`).join('');
    }

    async fetchCountriesNowPositions() {
        const res = await fetch('https://countriesnow.space/api/v0.1/countries/positions', { method: 'GET' });
        if (!res.ok) throw new Error('Failed to load countries');
        const data = await res.json();
        if (data?.error) throw new Error('Countries API error');
        return Array.isArray(data?.data) ? data.data : [];
    }

    async fetchCountriesNowStates(country) {
        const res = await fetch('https://countriesnow.space/api/v0.1/countries/states', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country })
        });
        if (!res.ok) throw new Error('Failed to load states');
        const data = await res.json();
        if (data?.error) return [];
        const states = data?.data?.states;
        return Array.isArray(states) ? states.map(s => s?.name).filter(Boolean) : [];
    }

    async fetchCountriesNowCities(country) {
        const res = await fetch('https://countriesnow.space/api/v0.1/countries/cities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country })
        });
        if (!res.ok) throw new Error('Failed to load cities');
        const data = await res.json();
        if (data?.error) return [];
        return Array.isArray(data?.data) ? data.data : [];
    }

    async fetchCountriesNowStateCities(country, state) {
        const res = await fetch('https://countriesnow.space/api/v0.1/countries/state/cities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country, state })
        });
        if (!res.ok) throw new Error('Failed to load state cities');
        const data = await res.json();
        if (data?.error) return [];
        return Array.isArray(data?.data) ? data.data : [];
    }

    async ensureWorldCountries() {
        this.locationAuto = this.locationAuto || {};
        if (Array.isArray(this.locationAuto.countries) && this.locationAuto.countries.length) return this.locationAuto.countries;
        if (this.locationAuto.countriesPromise) return this.locationAuto.countriesPromise;

        const fromStorage = () => {
            try {
                const raw = localStorage.getItem('worldCountries_v1');
                const parsed = raw ? JSON.parse(raw) : null;
                return Array.isArray(parsed) ? parsed : null;
            } catch {
                return null;
            }
        };
        const cached = fromStorage();
        if (cached && cached.length) {
            this.locationAuto.countries = cached;
            this.locationAuto.countryByLower = new Map(cached.map((c) => [this.normalizeLocationText(c), c]));
            return cached;
        }

        this.locationAuto.countriesPromise = (async () => {
            const rows = await this.fetchCountriesNowPositions();
            const countries = rows.map(r => r?.name).filter(Boolean);
            this.locationAuto.countries = countries;
            this.locationAuto.countryByLower = new Map(countries.map((c) => [this.normalizeLocationText(c), c]));
            try { localStorage.setItem('worldCountries_v1', JSON.stringify(countries)); } catch {}
            return countries;
        })().finally(() => {
            this.locationAuto.countriesPromise = null;
        });
        return this.locationAuto.countriesPromise;
    }

    ensureLocationAutoCaches() {
        this.locationAuto = this.locationAuto || {};
        if (!this.locationAuto.countryByLower) this.locationAuto.countryByLower = new Map();
        if (!this.locationAuto.statesByCountry) this.locationAuto.statesByCountry = new Map();
        if (!this.locationAuto.citiesByCountry) this.locationAuto.citiesByCountry = new Map();
        if (!this.locationAuto.citiesByStateKey) this.locationAuto.citiesByStateKey = new Map();
        return this.locationAuto;
    }

    populateCountrySelect(select, { placeholder = 'Country', active = '' } = {}) {
        if (!select || select.tagName !== 'SELECT') return;
        this.ensureLocationAutoCaches();
        const placeholderOption = `<option value="">${this.escapeHtml(placeholder)}</option>`;
        select.innerHTML = placeholderOption;
        select.disabled = false;

        const requestId = String(Date.now() + Math.random());
        select.dataset.countryOptionsRequest = requestId;

        Promise.resolve(this.ensureWorldCountries())
            .then((countries) => {
                if (select.dataset.countryOptionsRequest !== requestId) return;
                const options = (countries || []).map((c) => {
                    const label = String(c || '').trim();
                    if (!label) return '';
                    return `<option value="${this.escapeHtml(label)}">${this.escapeHtml(label)}</option>`;
                }).join('');
                select.innerHTML = placeholderOption + options;
                if (active) select.value = active;
            })
            .catch(() => {
                // Keep placeholder only if network fails.
            });
    }

    populateStateSelect(select, country, { placeholder = 'Province/State', active = '' } = {}) {
        if (!select || select.tagName !== 'SELECT') return;
        this.ensureLocationAutoCaches();
        select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>`;
        if (!country) {
            select.disabled = true;
            return;
        }

        const countryKey = this.normalizeLocationText(country);
        const requestId = `${countryKey}:${Date.now() + Math.random()}`;
        select.dataset.stateOptionsRequest = requestId;

        const canonical = this.locationAuto.countryByLower.get(countryKey) || country;
        const cacheKey = this.normalizeLocationText(canonical);
        const cached = this.locationAuto.statesByCountry.get(cacheKey);
        if (Array.isArray(cached) && cached.length) {
            const options = cached.map((r) => {
                const label = String(r || '').trim();
                if (!label) return '';
                return `<option value="${this.escapeHtml(label)}">${this.escapeHtml(label)}</option>`;
            }).join('');
            select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>` + options;
            select.disabled = false;
            if (active) select.value = active;
            return;
        }

        select.disabled = true;
        Promise.resolve(this.fetchCountriesNowStates(canonical))
            .then((states) => {
                if (select.dataset.stateOptionsRequest !== requestId) return;
                const list = Array.isArray(states) ? states : [];
                this.locationAuto.statesByCountry.set(cacheKey, list);
                const options = list.map((r) => {
                    const label = String(r || '').trim();
                    if (!label) return '';
                    return `<option value="${this.escapeHtml(label)}">${this.escapeHtml(label)}</option>`;
                }).join('');
                select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>` + options;
                select.disabled = !list.length;
                if (active) select.value = active;
            })
            .catch(() => {
                if (select.dataset.stateOptionsRequest !== requestId) return;
                select.disabled = true;
            });
    }

    populateCitySelect(select, country, state, { placeholder = 'City', active = '' } = {}) {
        if (!select || select.tagName !== 'SELECT') return;
        this.ensureLocationAutoCaches();
        select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>`;
        if (!country || !state) {
            select.disabled = true;
            return;
        }

        const cKey = this.normalizeLocationText(country);
        const canonicalCountry = this.locationAuto.countryByLower.get(cKey) || country;
        const cacheCountryKey = this.normalizeLocationText(canonicalCountry);
        const sKey = this.normalizeLocationText(state);
        const cacheKey = `${cacheCountryKey}|${sKey}`;

        const requestId = `${cacheKey}:${Date.now() + Math.random()}`;
        select.dataset.cityOptionsRequest = requestId;

        const cached = this.locationAuto.citiesByStateKey.get(cacheKey);
        if (Array.isArray(cached) && cached.length) {
            const options = cached.map((c) => {
                const label = String(c || '').trim();
                if (!label) return '';
                return `<option value="${this.escapeHtml(label)}">${this.escapeHtml(label)}</option>`;
            }).join('');
            select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>` + options;
            select.disabled = false;
            if (active) select.value = active;
            return;
        }

        select.disabled = true;
        Promise.resolve(this.fetchCountriesNowStateCities(canonicalCountry, state))
            .then((cities) => {
                if (select.dataset.cityOptionsRequest !== requestId) return;
                const list = Array.isArray(cities) ? cities : [];
                this.locationAuto.citiesByStateKey.set(cacheKey, list);
                const options = list.map((c) => {
                    const label = String(c || '').trim();
                    if (!label) return '';
                    return `<option value="${this.escapeHtml(label)}">${this.escapeHtml(label)}</option>`;
                }).join('');
                select.innerHTML = `<option value="">${this.escapeHtml(placeholder)}</option>` + options;
                select.disabled = !list.length;
                if (active) select.value = active;
            })
            .catch(() => {
                if (select.dataset.cityOptionsRequest !== requestId) return;
                select.disabled = true;
            });
    }

    setupLocationAutocomplete() {
        if (this.didSetupLocationAutocomplete) return;
        this.didSetupLocationAutocomplete = true;

        this.locationAuto = this.locationAuto || {
            countries: null,
            countryByLower: new Map(),
            statesByCountry: new Map(),
            citiesByCountry: new Map(),
            citiesByStateKey: new Map()
        };

		        const countryInputs = [
		            'profile-country',
		            'services-country-filter',
		            'vehicles-country',
		            'item-country',
		            'community-country',
		            'dating-feed-country',
		            'companionship-mini-country',
		            'geo-search-country',
		            'realestate-location',
		            'category-filter',
		            'country'
		        ].map((id) => document.getElementById(id)).filter(Boolean);

        const countryDatalist = this.ensureDatalist('global-country-datalist');
        countryInputs.forEach((input) => input.setAttribute('list', 'global-country-datalist'));

        // Populate countries once (async) and keep UI usable if it fails.
        this.ensureWorldCountries()
            .then((countries) => this.fillDatalist(countryDatalist, countries, 300))
            .catch(() => {
                // Keep manual typing available if network fails.
            });

        // Populate country selects used across the app (filters and forms).
        this.populateCountrySelect(document.getElementById('services-country-filter'), { placeholder: 'Any country' });

        const bindGroup = ({ countryId, regionId, cityId }) => {
            const countryEl = document.getElementById(countryId);
            const regionEl = regionId ? document.getElementById(regionId) : null;
            const cityEl = cityId ? document.getElementById(cityId) : null;
            if (!countryEl) return;

            const regionListId = regionEl ? `region-datalist-${countryId}` : '';
            const cityListId = cityEl ? `city-datalist-${countryId}` : '';
            const regionList = regionEl ? this.ensureDatalist(regionListId) : null;
            const cityList = cityEl ? this.ensureDatalist(cityListId) : null;
            if (regionEl) regionEl.setAttribute('list', regionListId);
            if (cityEl) cityEl.setAttribute('list', cityListId);

            const getCanonicalCountry = () => {
                const raw = countryEl.value || '';
                const key = this.normalizeLocationText(raw);
                return this.locationAuto.countryByLower.get(key) || raw.trim();
            };

            const setRegionOptions = async (country) => {
                if (!regionEl || !regionList) return;
                const k = this.normalizeLocationText(country);
                if (!k) {
                    regionList.innerHTML = '';
                    return;
                }
                if (this.locationAuto.statesByCountry.has(k)) {
                    this.fillDatalist(regionList, this.locationAuto.statesByCountry.get(k), 400);
                    return;
                }
                try {
                    const states = await this.fetchCountriesNowStates(country);
                    this.locationAuto.statesByCountry.set(k, states);
                    this.fillDatalist(regionList, states, 400);
                } catch {
                    regionList.innerHTML = '';
                }
            };

            const setCityOptions = async ({ country, state }) => {
                if (!cityEl || !cityList) return;
                const cKey = this.normalizeLocationText(country);
                if (!cKey) {
                    cityList.innerHTML = '';
                    return;
                }

                const sKey = this.normalizeLocationText(state);
                if (sKey) {
                    const key = `${cKey}|${sKey}`;
                    if (this.locationAuto.citiesByStateKey.has(key)) {
                        this.fillDatalist(cityList, this.locationAuto.citiesByStateKey.get(key), 600);
                        return;
                    }
                    try {
                        const cities = await this.fetchCountriesNowStateCities(country, state);
                        this.locationAuto.citiesByStateKey.set(key, cities);
                        this.fillDatalist(cityList, cities, 600);
                    } catch {
                        cityList.innerHTML = '';
                    }
                    return;
                }

                if (this.locationAuto.citiesByCountry.has(cKey)) {
                    this.fillDatalist(cityList, this.locationAuto.citiesByCountry.get(cKey), 600);
                    return;
                }
                try {
                    const cities = await this.fetchCountriesNowCities(country);
                    this.locationAuto.citiesByCountry.set(cKey, cities);
                    this.fillDatalist(cityList, cities, 600);
                } catch {
                    cityList.innerHTML = '';
                }
            };

            const handleCountryMaybeSelected = async () => {
                const canonicalCountry = getCanonicalCountry();
                const lower = this.normalizeLocationText(canonicalCountry);
                if (!lower) return;
                // If we have a known list, only trigger when it's an exact match.
                if (this.locationAuto.countryByLower.size && !this.locationAuto.countryByLower.has(lower)) return;
                if (countryEl.dataset.locationLastCountry === lower) return;
                countryEl.dataset.locationLastCountry = lower;

                if (regionEl) regionEl.value = '';
                if (cityEl) cityEl.value = '';
                await setRegionOptions(canonicalCountry);
                await setCityOptions({ country: canonicalCountry, state: '' });
            };

            const handleRegionMaybeSelected = async () => {
                if (!regionEl) return;
                const country = getCanonicalCountry();
                const cLower = this.normalizeLocationText(country);
                if (!cLower) return;
                if (this.locationAuto.countryByLower.size && !this.locationAuto.countryByLower.has(cLower)) return;
                const state = regionEl.value || '';
                const sLower = this.normalizeLocationText(state);
                if (regionEl.dataset.locationLastState === sLower) return;
                regionEl.dataset.locationLastState = sLower;
                if (cityEl) cityEl.value = '';
                await setCityOptions({ country, state });
            };

            if (!countryEl.dataset.locationBound) {
                countryEl.addEventListener('change', () => handleCountryMaybeSelected());
                countryEl.addEventListener('blur', () => handleCountryMaybeSelected());
                countryEl.addEventListener('input', () => {
                    const lower = this.normalizeLocationText(countryEl.value);
                    if (!this.locationAuto.countryByLower.size) return;
                    if (!lower || !this.locationAuto.countryByLower.has(lower)) return;
                    handleCountryMaybeSelected();
                });
                countryEl.dataset.locationBound = '1';
            }
            if (regionEl && !regionEl.dataset.locationBound) {
                regionEl.addEventListener('change', () => handleRegionMaybeSelected());
                regionEl.addEventListener('blur', () => handleRegionMaybeSelected());
                regionEl.addEventListener('input', () => {
                    const cLower = this.normalizeLocationText(countryEl.value);
                    if (this.locationAuto.countryByLower.size && (!cLower || !this.locationAuto.countryByLower.has(cLower))) return;
                    if (!regionEl.value) return;
                    handleRegionMaybeSelected();
                });
                regionEl.dataset.locationBound = '1';
            }
        };

	        bindGroup({ countryId: 'profile-country', regionId: 'profile-region', cityId: 'profile-city' });
	        bindGroup({ countryId: 'companionship-mini-country', regionId: 'companionship-mini-region', cityId: 'companionship-mini-city' });
	        bindGroup({ countryId: 'dating-feed-country', regionId: 'dating-feed-region', cityId: 'dating-feed-city' });
	        bindGroup({ countryId: 'vehicles-country', regionId: null, cityId: 'vehicles-city' });
	        bindGroup({ countryId: 'item-country', regionId: null, cityId: 'item-city' });
	        bindGroup({ countryId: 'community-country', regionId: null, cityId: 'community-city' });
	        bindGroup({ countryId: 'geo-search-country', regionId: null, cityId: 'geo-search-city' });
	        bindGroup({ countryId: 'country', regionId: null, cityId: 'city' });
	    }

    setupCardSwipe() {
        const card = document.getElementById('current-card');
        if (!card) return; // guard if legacy swipe UI not present
        let startX = 0;
        let currentX = 0;
        let isDragging = false;

        card.addEventListener('mousedown', (e) => this.startSwipe(e, 'mouse'));
        card.addEventListener('touchstart', (e) => this.startSwipe(e, 'touch'));
        
        document.addEventListener('mousemove', (e) => this.moveSwipe(e, 'mouse'));
        document.addEventListener('touchmove', (e) => this.moveSwipe(e, 'touch'));
        
        document.addEventListener('mouseup', () => this.endSwipe());
        document.addEventListener('touchend', () => this.endSwipe());
    }

    startSwipe(e, type) {
        this.isDragging = true;
        this.startX = type === 'mouse' ? e.clientX : e.touches[0].clientX;
        document.getElementById('current-card').style.transition = 'none';
    }

    moveSwipe(e, type) {
        if (!this.isDragging) return;
        
        this.currentX = type === 'mouse' ? e.clientX : e.touches[0].clientX;
        const deltaX = this.currentX - this.startX;
        const card = document.getElementById('current-card');
        
        card.style.transform = `translateX(${deltaX}px) rotate(${deltaX * 0.1}deg)`;
        card.style.opacity = Math.max(0.5, 1 - Math.abs(deltaX) / 300);
    }

    endSwipe() {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        const deltaX = this.currentX - this.startX;
        const card = document.getElementById('current-card');
        
        if (Math.abs(deltaX) > 100) {
            if (deltaX > 0) {
                this.likeUser();
            } else {
                this.rejectUser();
            }
        } else {
            card.style.transition = 'all 0.3s ease';
            card.style.transform = 'translateX(0) rotate(0)';
            card.style.opacity = '1';
        }
    }

    // Location Services
    async requestLocationPermissionOnLoad() {
        if (this.hasRequestedLocationOnLoad) return;
        this.hasRequestedLocationOnLoad = true;
        if (!('geolocation' in navigator)) return;

        try {
            if (navigator.permissions?.query) {
                const status = await navigator.permissions.query({ name: 'geolocation' });
                if (status?.state === 'denied') {
                    this.showNotification('Location is blocked in your browser settings.');
                    return;
                }
            }
        } catch {}

        // Small delay helps ensure the page is fully initialized before the browser prompts.
        setTimeout(() => this.requestLocationPermission(), 0);
    }

    requestLocationPermission() {
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => this.handleLocationSuccess(position),
                (error) => this.handleLocationError(error),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
    }

    normalizeLocationKey(lat, lng) {
        const la = Number(lat);
        const lo = Number(lng);
        if (!Number.isFinite(la) || !Number.isFinite(lo)) return '';
        return `${la.toFixed(3)},${lo.toFixed(3)}`;
    }

    async reverseGeocodeLatLng(lat, lng) {
        const key = this.normalizeLocationKey(lat, lng);
        if (key && this.reverseGeocodeCache.has(key)) {
            return this.reverseGeocodeCache.get(key);
        }
        if (!this.googleApiKey) return null;

        try {
            if (!window.google?.maps?.Geocoder) {
                try { await this.loadGoogleMaps(); } catch {}
            }

            let result = null;
            if (window.google?.maps?.Geocoder) {
                const geocoder = new google.maps.Geocoder();
                const geocodeResult = await new Promise((resolve) => {
                    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                        if (status === 'OK' && Array.isArray(results) && results.length) resolve(results[0]);
                        else resolve(null);
                    });
                });
                result = geocodeResult;
            } else {
                const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${encodeURIComponent(
                    `${lat},${lng}`
                )}&key=${encodeURIComponent(this.googleApiKey)}`;
                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) return null;
                const data = await res.json();
                result = data?.results?.[0] || null;
            }

            const components = Array.isArray(result?.address_components) ? result.address_components : [];

            const pick = (type) => components.find((c) => Array.isArray(c.types) && c.types.includes(type));
            const country = pick('country')?.long_name || '';
            const region =
                pick('administrative_area_level_1')?.long_name ||
                pick('administrative_area_level_2')?.long_name ||
                '';
            const city =
                pick('locality')?.long_name ||
                pick('postal_town')?.long_name ||
                pick('administrative_area_level_3')?.long_name ||
                pick('sublocality')?.long_name ||
                '';

            const parsed = { city, region, country };
            if (key) this.reverseGeocodeCache.set(key, parsed);
            return parsed;
        } catch (e) {
            return null;
        }
    }

    async applyEntryLocationDefaults() {
        if (this.didApplyEntryLocationDefaults) return;
        if (!this.userLocation?.lat || !this.userLocation?.lng) return;

        const geo = await this.reverseGeocodeLatLng(this.userLocation.lat, this.userLocation.lng);
        if (geo) {
            this.currentUser.location.city = geo.city || this.currentUser.location.city || '';
            this.currentUser.location.region = geo.region || this.currentUser.location.region || '';
            this.currentUser.location.country = geo.country || this.currentUser.location.country || '';
            this.discoveryCountryFilter = this.currentUser.location.country || this.discoveryCountryFilter || '';
        }

        const city = this.currentUser.location.city || '';
        const country = this.currentUser.location.country || '';
        const region = this.currentUser.location.region || '';

        const homeLocation = document.getElementById('home-search-location');
        if (homeLocation && !homeLocation.value && city) {
            homeLocation.value = city;
            this.applyHomeFilters();
        }

        const marketplaceCity = document.getElementById('city-filter');
        if (marketplaceCity && !marketplaceCity.value && city) {
            marketplaceCity.value = city;
            this.applyMarketplaceFilters();
        }

        const vehiclesCity = document.getElementById('vehicles-city');
        if (vehiclesCity && !vehiclesCity.value && city) {
            vehiclesCity.value = city;
        }
        const vehiclesCountry = document.getElementById('vehicles-country');
        if (vehiclesCountry && !vehiclesCountry.value && country) {
            vehiclesCountry.value = country;
        }
        if ((vehiclesCity && city) || (vehiclesCountry && country)) {
            const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
            this.vehicleFilters.city = (vehiclesCity?.value || '').trim().toLowerCase();
            this.vehicleFilters.country = (vehiclesCountry?.value || '').trim().toLowerCase();
            this.renderVehiclesFeed(activeCategory);
        }

        if (this.discoveryGeoFilter === 'worldwide' && this.userLocation) {
            this.discoveryGeoFilter = 'nearby';
            this.syncGeoFilterControls();
            this.filterDiscoveryPosts(this.activeDiscoveryFilter);
        }

        if (!this.companionshipFilters.country && country) this.companionshipFilters.country = country;
        if (!this.companionshipFilters.region && region) this.companionshipFilters.region = region;
        if (!this.companionshipFilters.city && city) this.companionshipFilters.city = city;
        if (!this.companionshipFilters.nearMe && this.userLocation) this.companionshipFilters.nearMe = true;
        this.syncCompanionshipMiniLocationFromFilters();
        if (this.currentDatingCategory === 'companionship') {
            this.resetCompanionshipPagination();
            this.applyCompanionshipFilters();
        }

        this.didApplyEntryLocationDefaults = true;
    }

    handleLocationSuccess(position) {
        this.userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        
        this.currentUser.location = this.userLocation;
        this.updateUserDistances();
        if (this.currentDatingCategory === 'companionship') this.applyCompanionshipFilters();
        this.applyEntryLocationDefaults();
        this.startLocationTracking();
    }

    handleLocationError(error) {
        console.warn('Location access denied or unavailable:', error);
        // Use default San Francisco location
        this.userLocation = { lat: 37.7749, lng: -122.4194 };
        this.currentUser.location = this.userLocation;
        this.updateUserDistances();
        if (this.currentDatingCategory === 'companionship') this.applyCompanionshipFilters();
        this.applyEntryLocationDefaults();
    }

    startLocationTracking() {
        if ('geolocation' in navigator) {
            this.watchLocationId = navigator.geolocation.watchPosition(
                (position) => {
                    this.userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    this.currentUser.location = this.userLocation;
	                    this.updateUserDistances();
	                    if (this.currentDatingCategory === 'companionship') this.applyCompanionshipFilters();
	                    // Recenter Google map if visible
	                    if (this.googleMap && this.userLocation) {
	                        const la = Number(this.userLocation.lat);
	                        const lo = Number(this.userLocation.lng);
	                        if (Number.isFinite(la) && Number.isFinite(lo)) {
	                            this.googleMap.setCenter({
	                                lat: Math.round(la * 10) / 10,
	                                lng: Math.round(lo * 10) / 10
	                            });
	                        }
	                    }
	                },
	                (error) => console.warn('Location tracking error:', error),
	                { enableHighAccuracy: true, timeout: 60000, maximumAge: 300000 }
	            );
	        }
    }

    updateLocation() {
        this.requestLocationPermission();
        this.showNotification('Location updated!');
    }

    updateUserDistances() {
        if (!this.userLocation) return;
        
        this.users.forEach(user => {
            user.location.distance = this.calculateDistance(
                this.userLocation.lat,
                this.userLocation.lng,
                user.location.lat,
                user.location.lng
            );
        });
        
        this.updateNearbyList();
        this.updateMapMarkers();
    }

    calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.round(R * c * 10) / 10; // Round to 1 decimal
    }

	    // Authentication
	    handleLogin(e) {
	        e.preventDefault();
	        const email = document.getElementById('email').value;
	        const password = document.getElementById('password').value;
	        
	        // Simulate login
	        if (email && password) {
	            this.setSignedIn(true, { email });
	            this.showMainApp();
	            this.loadUserProfile();
	            this.loadCurrentCard();
	            this.runPendingAuthAction();
	        }
	    }

    handleSignup(e) {
        e.preventDefault();
        const firstName = document.getElementById('signup-first-name').value;
        const lastName = document.getElementById('signup-last-name').value;
        const email = document.getElementById('signup-email').value;
        const age = document.getElementById('signup-age').value;
        const password = document.getElementById('signup-password').value;
        
        // Simulate signup
        if (firstName && lastName && email && age && password) {
            const trimmedFirst = firstName.trim();
            const trimmedLast = lastName.trim();
            this.currentUser.firstName = trimmedFirst;
            this.currentUser.lastName = trimmedLast;
            this.currentUser.name = [trimmedFirst, trimmedLast].filter(Boolean).join(' ').trim();
            this.currentUser.age = parseInt(age, 10);
            this.currentUser.email = email;
            this.showOnboardingScreen();
        }
    }

    handleOnboardingSubmit(e) {
        e.preventDefault();
        if (this.onboardingStep < this.onboardingTotalSteps) {
            this.advanceOnboarding(1);
            return;
        }
        this.completeOnboarding();
    }

    applyOnboardingData() {
        const firstNameInput = document.getElementById('onboarding-first-name');
        const lastNameInput = document.getElementById('onboarding-last-name');
        const ageInput = document.getElementById('onboarding-age');
        const photoInput = document.getElementById('onboarding-photo');
        const bioInput = document.getElementById('onboarding-bio');
        const interestsInput = document.getElementById('onboarding-interests');
        const cityInput = document.getElementById('onboarding-city');
        const countryInput = document.getElementById('onboarding-country');
        const mapVisibleInput = document.getElementById('onboarding-map-visible');

        const firstName = (firstNameInput?.value || '').trim();
        const lastName = (lastNameInput?.value || '').trim();
        if (firstName) this.currentUser.firstName = firstName;
        if (lastName) this.currentUser.lastName = lastName;
        const fullName = [firstName || this.currentUser.firstName, lastName || this.currentUser.lastName]
            .filter(Boolean)
            .join(' ')
            .trim();
        if (fullName) this.currentUser.name = fullName;

        const ageValue = parseInt(ageInput?.value, 10);
        if (Number.isFinite(ageValue)) this.currentUser.age = ageValue;

        const photo = (photoInput?.value || '').trim();
        if (photo) this.currentUser.photo = photo;

        const bio = (bioInput?.value || '').trim();
        if (bio) this.currentUser.bio = bio;

        const interests = (interestsInput?.value || '')
            .split(',')
            .map((interest) => interest.trim())
            .filter(Boolean);
        if (interests.length) this.currentUser.interests = interests;

        const city = (cityInput?.value || '').trim();
        const country = (countryInput?.value || '').trim();
        if (city || country) {
            if (!this.currentUser.location) this.currentUser.location = { distance: 0 };
            if (city) this.currentUser.location.city = city;
            if (country) this.currentUser.location.country = country;
        }

        if (mapVisibleInput) {
            this.currentUser.mapVisible = Boolean(mapVisibleInput.checked);
            try { localStorage.setItem('hs_map_visible', this.currentUser.mapVisible ? 'true' : 'false'); } catch {}
        }
    }

    prefillOnboardingFields() {
        const firstNameInput = document.getElementById('onboarding-first-name');
        const lastNameInput = document.getElementById('onboarding-last-name');
        if (this.currentUser?.firstName) {
            if (firstNameInput) firstNameInput.value = this.currentUser.firstName;
        }
        if (this.currentUser?.lastName) {
            if (lastNameInput) lastNameInput.value = this.currentUser.lastName;
        }
        if ((!this.currentUser?.firstName || !this.currentUser?.lastName) && this.currentUser?.name) {
            const parts = String(this.currentUser.name).trim().split(/\s+/);
            if (parts.length) {
                if (firstNameInput && !firstNameInput.value) firstNameInput.value = parts[0];
                if (lastNameInput && !lastNameInput.value) lastNameInput.value = parts.slice(1).join(' ');
            }
        }
        const ageInput = document.getElementById('onboarding-age');
        if (ageInput && this.currentUser?.age) ageInput.value = this.currentUser.age;
        const photoInput = document.getElementById('onboarding-photo');
        if (photoInput && this.currentUser?.photo) photoInput.value = this.currentUser.photo;
        const bioInput = document.getElementById('onboarding-bio');
        if (bioInput && this.currentUser?.bio) bioInput.value = this.currentUser.bio;
        const interestsInput = document.getElementById('onboarding-interests');
        if (interestsInput && Array.isArray(this.currentUser?.interests)) {
            interestsInput.value = this.currentUser.interests.join(', ');
        }
        const cityInput = document.getElementById('onboarding-city');
        if (cityInput && this.currentUser?.location?.city) cityInput.value = this.currentUser.location.city;
        const countryInput = document.getElementById('onboarding-country');
        if (countryInput && this.currentUser?.location?.country) countryInput.value = this.currentUser.location.country;
        const mapVisibleInput = document.getElementById('onboarding-map-visible');
        if (mapVisibleInput) mapVisibleInput.checked = this.currentUser?.mapVisible === true;
    }

    updateOnboardingStep() {
        const steps = Array.from(document.querySelectorAll('.onboarding-step'));
        steps.forEach((step) => {
            const stepNum = parseInt(step.dataset.step, 10);
            step.classList.toggle('hidden', stepNum !== this.onboardingStep);
        });
        const label = document.getElementById('onboarding-step-label');
        if (label) label.textContent = `Step ${this.onboardingStep} of ${this.onboardingTotalSteps}`;
        const backBtn = document.getElementById('onboarding-back');
        if (backBtn) backBtn.disabled = this.onboardingStep <= 1;
        const nextBtn = document.getElementById('onboarding-next');
        const finishBtn = document.getElementById('onboarding-finish');
        if (nextBtn) nextBtn.classList.toggle('hidden', this.onboardingStep >= this.onboardingTotalSteps);
        if (finishBtn) finishBtn.classList.toggle('hidden', this.onboardingStep < this.onboardingTotalSteps);
        const dots = Array.from(document.querySelectorAll('.onboarding-dot'));
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index + 1 <= this.onboardingStep);
        });
    }

    advanceOnboarding(delta) {
        if (delta > 0) {
            const currentStep = document.querySelector(`.onboarding-step[data-step="${this.onboardingStep}"]`);
            if (currentStep) {
                const fields = Array.from(currentStep.querySelectorAll('input, textarea, select'));
                for (const field of fields) {
                    if (!field.checkValidity()) {
                        field.reportValidity();
                        return;
                    }
                }
            }
        }
        const nextStep = (this.onboardingStep || 1) + delta;
        this.onboardingStep = Math.min(this.onboardingTotalSteps, Math.max(1, nextStep));
        this.updateOnboardingStep();
    }

	    completeOnboarding({ skipped = false } = {}) {
	        if (!skipped) {
	            this.applyOnboardingData();
	        }
	        this.setSignedIn(true, { email: this.currentUser?.email || '' });
	        this.showMainApp();
	        this.loadUserProfile();
	        this.loadCurrentCard();
	        this.runPendingAuthAction();
	    }

    // Screen Management
    showLoadingScreen() {
        const el = document.getElementById('loading-screen');
        if (el) el.style.display = 'flex';
    }

    hideLoadingScreen() {
        const el = document.getElementById('loading-screen');
        if (el) el.style.display = 'none';
    }

    initializeNavOrder() {
        const buttons = Array.from(document.querySelectorAll('.nav-btn'))
            .map(btn => btn.dataset.screen)
            .filter(Boolean);
        if (buttons.length) {
            this.navOrder = buttons;
        }
    }

    pushNavHistory(screen) {
        if (!screen) return;
        const current = this.navHistory[this.navIndex];
        if (current === screen) {
            this.updateNavArrows();
            return;
        }
        // Drop forward history when branching
        this.navHistory = this.navHistory.slice(0, this.navIndex + 1);
        this.navHistory.push(screen);
        this.navIndex = this.navHistory.length - 1;
        this.updateNavArrows();
    }

	    navigateBack() {
	        if (this.browserHistoryIndex > 0) {
	            window.history.back();
	            return;
	        }
	        // Fallback for direct-deep-link entry: go home inside the app.
	        this.switchScreen('home');
	    }

	    navigateForward() {
	        if (this.browserHistoryIndex < this.browserHistoryMaxIndex) {
	            window.history.forward();
	        }
	    }

	    updateNavArrows() {
	        const backBtn = document.getElementById('nav-back');
	        const fwdBtn = document.getElementById('nav-forward');
	        const backFloat = document.getElementById('nav-back-float');
	        const fwdFloat = document.getElementById('nav-forward-float');

	        const canBack = this.browserHistoryIndex > 0;
	        const canForward = this.browserHistoryIndex < this.browserHistoryMaxIndex;

	        if (backBtn) {
	            backBtn.disabled = !canBack;
	            backBtn.setAttribute('aria-label', canBack ? 'Back' : 'Back disabled');
	        }
	        if (backFloat) {
	            backFloat.disabled = !canBack;
	            backFloat.setAttribute('aria-label', canBack ? 'Back' : 'Back disabled');
	        }
	        if (fwdBtn) {
	            fwdBtn.disabled = !canForward;
	            fwdBtn.setAttribute('aria-label', canForward ? 'Forward' : 'Forward disabled');
	        }
	        if (fwdFloat) {
	            fwdFloat.disabled = !canForward;
	            fwdFloat.setAttribute('aria-label', canForward ? 'Forward' : 'Forward disabled');
	        }
	    }

    hideAllScreens() {
        const sectionIds = ['main-app', 'login-screen', 'signup-screen', 'onboarding-screen'];
        sectionIds.forEach((id) => {
            const section = document.getElementById(id);
            if (section) section.classList.add('hidden');
        });

        document.querySelectorAll('.content-screen').forEach((screen) => {
            screen.classList.remove('active');
        });

        document.querySelectorAll('.nav-btn').forEach((btn) => {
            btn.classList.remove('active');
        });

        this.activeScreen = null;
    }

    showHomeScreen() {
        this.hideAllScreens();
        document.getElementById('home-screen')?.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'auto' });
        this.updateNavArrows();
    }

    showLoginScreen() {
        this.hideAllScreens();
        const screen = document.getElementById('login-screen');
        if (screen) {
            screen.classList.remove('hidden');
            this.updateNotificationBellVisibility('');
            this.updateNavArrows();
        } else {
            this.showMainApp();
        }
    }

    showSignupScreen() {
        this.hideAllScreens();
        const screen = document.getElementById('signup-screen');
        if (screen) {
            screen.classList.remove('hidden');
            this.updateNotificationBellVisibility('');
            this.updateNavArrows();
        } else {
            this.showMainApp();
        }
    }

    showOnboardingScreen() {
        this.hideAllScreens();
        const screen = document.getElementById('onboarding-screen');
        if (screen) {
            screen.classList.remove('hidden');
            this.onboardingStep = 1;
            this.prefillOnboardingFields();
            this.updateOnboardingStep();
            this.updateNotificationBellVisibility('');
            this.updateNavArrows();
        } else {
            this.showMainApp();
        }
    }

	    showMainApp() {
	        this.hideAllScreens();
	        const app = document.getElementById('main-app');
	        if (!app) {
	            console.error('Main app container missing: #main-app');
	            return;
	        }
	        app.classList.remove('hidden');
	        this.didShowMainApp = true;
	        const route = this.pendingRoute || this.parseRouteFromLocation();
	        this.pendingRoute = null;
	        const initialScreen = this.resolveScreenName(route?.screen || 'home');
	        this.activeScreen = initialScreen;
	        this.navHistory = [initialScreen];
	        this.navIndex = 0;
	        this.applyRoute(route, { source: 'init' });
            this.updateNotificationBellVisibility(initialScreen);
	    }

			    switchScreen(screenName, { pushState = true } = {}) {
			        const screenEl = document.getElementById(`${screenName}-content`);
			        if (!screenEl) {
			            console.warn('Screen not found:', screenName);
			            return;
			        }
	        // Close any overlays/modals when changing screens.
	        this.applyUiState(null, { source: 'screen' });
	        // Update navigation
	        const navBtn = document.querySelector(`[data-screen="${screenName}"]`);
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn === navBtn);
        });

        // Update content
        document.querySelectorAll('.content-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        screenEl.classList.add('active');
        screenEl.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });

	        // Load screen-specific data
	        switch (screenName) {
	            case 'dating':
	                // If the user taps into Dating from Home/nav, default to the Dating base view
	                // (avoid reopening the last in-screen category like Companionship unless routing/history asked for it).
	                if (!this.isApplyingRoute && !this.isNavigatingHistory) {
	                    this.currentDatingCategory = null;
	                    this.currentDatingCategoryFilter = 'all';
	                }
	                this.loadDatingPage();
	                break;
	            case 'home':
	                this.loadHome();
	                break;
            case 'discover':
                this.loadDiscoveryFeed();
                break;
            case 'community':
                this.loadCommunity();
                break;
            case 'location':
                this.loadNearbyUsers();
                break;
            case 'profile':
                this.loadUserProfile();
                break;
            case 'premium':
                this.loadPremium();
                break;
            case 'personal':
                this.loadPersonal();
                break;
            case 'marketplace':
                this.loadMarketplace();
                break;
            case 'services':
                this.loadServices();
                break;
            case 'realestate':
                this.loadRealestate();
                break;
            case 'vehicles':
                this.loadVehicles();
                break;
            case 'electronics':
                this.loadElectronics();
                break;
            case 'clothing':
                this.loadClothing();
                break;
            case 'jobs':
                this.loadJobs();
                break;
        }

        // Ensure global interactive media controls are wired on every screen.
        this.bindImageCarousels();
        this.bindFeaturedAdCardLightbox();

        if (screenName === 'marketplace') {
            const title = document.getElementById('marketplace-title');
            if (title) {
                title.textContent = this.marketplaceContext === 'vehicles' ? 'Vehicles' : 'Marketplace';
            }
        } else {
            this.marketplaceContext = null;
        }

	        this.activeScreen = screenName;
            this.updateNotificationBellVisibility(screenName);
	        if (!this.isNavigatingHistory && !this.isApplyingRoute) {
	            this.pushNavHistory(screenName);
	        }
	        this.updateNavArrows();

	        if (!this.isApplyingRoute && pushState) {
	            this.updateBrowserRoute(this.getCurrentRoute(), { replace: pushState === 'replace' });
	        }
	    }

	    // Home (Kijiji-style) functionality
		    loadHome() {
	        // Wire topbar and auth actions if present
	        this.bindHomeSponsoredAds();
	        const loginBtn = document.getElementById('home-login');
        if (loginBtn) loginBtn.onclick = () => this.showLoginScreen();
	        const signupBtn = document.getElementById('home-signup-btn');
	        if (signupBtn) signupBtn.onclick = () => this.showSignupScreen();
	        const postAdBtn = document.getElementById('home-post-ad');
	        if (postAdBtn) postAdBtn.onclick = () => {
	            const homeCategory = (document.getElementById('home-search-category')?.value
	                || document.getElementById('home-filter-category')?.value
	                || ''
	            ).trim();

	            this.showPostAdModal({ category: homeCategory });
	        };
	        this.bindFeaturedAds();
	        this.bindImageCarousels();
	        this.bindFeaturedAdCardLightbox();

        const postAvatar = document.getElementById('post-avatar');
        if (postAvatar) postAvatar.src = this.currentUser.photo || '';

	        // Search actions
	        const searchBtn = document.getElementById('home-search-btn');
	        if (searchBtn) searchBtn.onclick = () => this.applyHomeFilters({ scrollToResults: true });
	        const scheduleSearch = (() => {
	            let timer = null;
	            return () => {
	                if (timer) window.clearTimeout(timer);
	                timer = window.setTimeout(() => this.applyHomeFilters({ scrollToResults: false }), 150);
	            };
	        })();
	        // Enter-to-search in inputs
	        const searchWhat = document.getElementById('home-search-what');
            const homeAiBtn = document.getElementById('home-ai-btn');
            if (homeAiBtn && !homeAiBtn.dataset.bound) {
                homeAiBtn.addEventListener('click', () => this.applyHomeAiSearch());
                homeAiBtn.dataset.bound = '1';
            }
	        if (searchWhat && !searchWhat.dataset.boundEnter) {
	            searchWhat.addEventListener('keydown', (e) => {
		                if (e.key === 'Enter') { e.preventDefault(); this.applyHomeFilters({ scrollToResults: true }); }
	            });
	            searchWhat.dataset.boundEnter = '1';
	        }
	        if (searchWhat && !searchWhat.dataset.boundInput) {
	            searchWhat.addEventListener('input', () => scheduleSearch());
	            searchWhat.dataset.boundInput = '1';
	        }
	        const searchLoc = document.getElementById('home-search-location');
	        if (searchLoc && !searchLoc.dataset.boundEnter) {
	            searchLoc.addEventListener('keydown', (e) => {
	                    if (e.key === 'Enter') { e.preventDefault(); this.applyHomeFilters({ scrollToResults: true }); }
	            });
	            searchLoc.dataset.boundEnter = '1';
	        }
	        if (searchLoc && !searchLoc.dataset.boundInput) {
	            searchLoc.addEventListener('input', () => scheduleSearch());
	            searchLoc.dataset.boundInput = '1';
	        }
        const topCat = document.getElementById('home-top-category');
        if (topCat) topCat.onchange = () => this.applyHomeFilters();

	        const categoryScreenMap = {
	            dating: 'dating',
	            real_estate: 'realestate',
	            services: 'services',
	            community: 'community',
	            vehicles: 'vehicles',
	            electronics: 'electronics',
	            clothing: 'clothing',
	            jobs: 'jobs'
	        };
	        const resetIfNavCategory = (selectEl) => {
	            if (!selectEl) return;
	            if (Object.prototype.hasOwnProperty.call(categoryScreenMap, selectEl.value)) {
	                selectEl.value = '';
	            }
	        };
	        const resetAllHomeCategorySelects = () => {
	            resetIfNavCategory(globalCat);
	            resetIfNavCategory(searchCat);
	            resetIfNavCategory(sideCat);
	        };

	        // Global unified category dropdown (takes precedence)
	        const globalCat = document.getElementById('global-category-select');
	        if (globalCat) globalCat.onchange = () => {
	            const mappedScreen = categoryScreenMap[globalCat.value];
	            if (mappedScreen) {
	                if (globalCat.value === 'vehicles') this.marketplaceContext = 'vehicles';
	                resetAllHomeCategorySelects();
	                this.switchScreen(mappedScreen);
	            } else {
	                // Sync legacy dropdowns for consistent UI state
	                const searchCatSync = document.getElementById('home-search-category');
	                if (searchCatSync) searchCatSync.value = globalCat.value;
	                const sideCatSync = document.getElementById('home-filter-category');
	                if (sideCatSync) sideCatSync.value = globalCat.value;
		        this.applyHomeFilters();
	            }
	        };

	        // Navigate to Dating page when 'dating' is selected in category dropdowns
	        const searchCat = document.getElementById('home-search-category');
	        if (searchCat) searchCat.onchange = () => {
	            const mappedScreen = categoryScreenMap[searchCat.value];
	            if (mappedScreen) {
	                if (searchCat.value === 'vehicles') this.marketplaceContext = 'vehicles';
	                resetAllHomeCategorySelects();
	                this.switchScreen(mappedScreen);
	            }
	            else this.applyHomeFilters();
	        };
	        const sideCat = document.getElementById('home-filter-category');
	        if (sideCat) sideCat.onchange = () => {
	            const mappedScreen = categoryScreenMap[sideCat.value];
	            if (mappedScreen) {
	                if (sideCat.value === 'vehicles') this.marketplaceContext = 'vehicles';
	                resetAllHomeCategorySelects();
	                this.switchScreen(mappedScreen);
	            }
	            else this.applyHomeFilters();
	        };

	        const applyFilters = document.getElementById('home-apply-filters');
	        if (applyFilters) applyFilters.onclick = () => this.applyHomeFilters();

	        // Initial render uses current marketplace items
	        this.bindHomeCategoryNav();
	        this.bindMarketplaceCardInteractions(document.getElementById('home-content'));
	        resetAllHomeCategorySelects();
	        this.applyHomeFilters();
	        this.renderHomePersonalizedRows();
	        this.updatePostButton();
	        this.loadDiscoveryFeed();
	    }

	    getHomeRawCategoryValue() {
	        const catGlobal = document.getElementById('global-category-select')?.value || '';
	        const catSearch = document.getElementById('home-search-category')?.value || '';
	        const catTop = document.getElementById('home-top-category')?.value || '';
	        const catSide = document.getElementById('home-filter-category')?.value || '';
	        return String(catGlobal || catSide || catSearch || catTop || '').trim();
	    }

	    syncHomeCategoryNav(forcedValue = null) {
	        const nav = document.getElementById('home-category-nav');
	        if (!nav) return;
	        const value = String(forcedValue != null ? forcedValue : this.getHomeRawCategoryValue()).trim();
	        const buttons = Array.from(nav.querySelectorAll('[data-home-category]'));
	        if (!buttons.length) return;
	        const valid = new Set(buttons.map((btn) => String(btn.dataset.homeCategory || '').trim()));
	        const resolved = valid.has(value) ? value : '';

	        buttons.forEach((btn) => {
	            const btnValue = String(btn.dataset.homeCategory || '').trim();
	            const active = btnValue === resolved;
	            btn.classList.toggle('active', active);
	            btn.setAttribute('aria-pressed', active ? 'true' : 'false');
	        });
	    }

	    bindHomeCategoryNav() {
	        const nav = document.getElementById('home-category-nav');
	        if (!nav || nav.dataset.bound) return;

	        nav.addEventListener('click', (e) => {
	            const btn = e.target.closest('[data-home-category]');
	            if (!btn) return;

	            const value = String(btn.dataset.homeCategory || '').trim();

	            const globalCat = document.getElementById('global-category-select');
	            const searchCat = document.getElementById('home-search-category');
	            const sideCat = document.getElementById('home-filter-category');

	            if (globalCat) globalCat.value = value;
	            if (searchCat) searchCat.value = value;
	            if (sideCat) sideCat.value = value;

	            this.syncHomeCategoryNav(value);

	            const target = globalCat || searchCat || sideCat;
	            if (!target) return;
	            target.dispatchEvent(new Event('change', { bubbles: true }));
	        });

	        nav.dataset.bound = '1';
	        this.syncHomeCategoryNav();
	    }

	    renderHomePersonalizedRows(pool = null) {
	        const recommendedEl = document.getElementById('home-recommended-row');
	        const recentSection = document.getElementById('home-recent-row-section');
	        const recentEl = document.getElementById('home-recent-row');
	        if (!recommendedEl || !recentSection || !recentEl) return;

	        const allItems = this.marketplaceItems || [];
	        const source = Array.isArray(pool) ? pool : allItems;
	        const byId = new Map(allItems.map((entry) => [Number(entry.id), entry]));
	        const poolIds = Array.isArray(pool) ? new Set(source.map((entry) => Number(entry.id))) : null;

	        const sortByDateDesc = (arr) => arr.slice().sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
	        const sorted = sortByDateDesc(source);
	        const sortedAll = sortByDateDesc(allItems);

	        const pickUnique = (primary, fallback, max, exclude = new Set()) => {
	            const out = [];
	            const seen = new Set(exclude);
	            const addFrom = (list) => {
	                for (const entry of list) {
	                    const id = Number(entry?.id);
	                    if (!Number.isFinite(id) || seen.has(id)) continue;
	                    out.push(entry);
	                    seen.add(id);
	                    if (out.length >= max) break;
	                }
	            };
	            addFrom(primary);
	            if (out.length < max) addFrom(fallback);
	            return out;
	        };

	        const trending = pickUnique(sorted, sortedAll, 8);
	        const trendingIds = new Set(trending.map((entry) => Number(entry.id)));

	        const activeHomeCategory = this.getHomeRawCategoryValue();
	        const activeCategory = (activeHomeCategory && sortedAll.some((entry) => entry.category === activeHomeCategory))
	            ? activeHomeCategory
	            : null;

	        const seedId = (Array.isArray(this.marketplaceRecent) && this.marketplaceRecent.length)
	            ? this.marketplaceRecent[0]
	            : null;
	        const seedItem = seedId ? byId.get(Number(seedId)) : null;
	        const seedCategory = activeCategory || seedItem?.category || null;

	        const recommendedPrimary = seedCategory
	            ? sortedAll.filter(entry => entry.category === seedCategory)
	            : sortedAll;
	        const recommended = pickUnique(
	            recommendedPrimary.filter(entry => !trendingIds.has(Number(entry.id))),
	            sortedAll,
	            8,
	            trendingIds
	        );
	        const resolvedRecommended = recommended.length ? recommended : trending.slice(0, 8);

	        const recent = (Array.isArray(this.marketplaceRecent) ? this.marketplaceRecent : [])
	            .map((id) => byId.get(Number(id)))
	            .filter(Boolean)
	            .filter((entry) => !poolIds || poolIds.has(Number(entry.id)))
	            .slice(0, 10);

	        recommendedEl.innerHTML = resolvedRecommended.map(entry => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true })).join('');

	        if (recent.length) {
	            recentSection.classList.remove('hidden');
	            recentEl.innerHTML = recent.map(entry => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true })).join('');
	        } else {
	            recentSection.classList.add('hidden');
	            recentEl.innerHTML = '';
	        }
	    }

    getHomeStickyAdDismissedUntil() {
        try {
            const raw = window.localStorage.getItem(this.homeStickyAdDismissedUntilKey);
            const value = Number(raw);
            return Number.isFinite(value) ? value : 0;
        } catch (err) {
            return 0;
        }
    }

    isHomeStickyAdDismissed() {
        return Date.now() < this.getHomeStickyAdDismissedUntil();
    }

    dismissHomeStickyAd() {
        try {
            window.localStorage.setItem(
                this.homeStickyAdDismissedUntilKey,
                String(Date.now() + this.homeStickyAdDismissMs)
            );
        } catch (err) {
            // ignore storage failures (private mode, quota, etc.)
        }
    }

    updateHomeStickyAdVisibility() {
        const homeContent = document.getElementById('home-content');
        const banner = document.getElementById('home-sticky-ad');
        if (!homeContent || !banner) return;

        const isSmallViewport = window.matchMedia('(max-width: 899px)').matches;
        const shouldShow = this.activeScreen === 'home' && isSmallViewport && !this.isHomeStickyAdDismissed();
        banner.classList.toggle('hidden', !shouldShow);
        homeContent.classList.toggle('sticky-ad-visible', shouldShow);
    }

    bindHomeSponsoredAds() {
        if (this.didBindHomeSponsoredAds) {
            this.updateHomeStickyAdVisibility();
            return;
        }

        const betweenCta = document.getElementById('home-sponsored-break-cta');
        if (betweenCta) {
            betweenCta.addEventListener('click', () => {
                this.showPostAdModal();
            });
        }

        const betweenLearn = document.getElementById('home-sponsored-break-learn');
        if (betweenLearn) {
            betweenLearn.addEventListener('click', () => {
                this.showNotification('Sponsored placements help highlight your best listing on Home.');
            });
        }

        const stickyCta = document.getElementById('home-sticky-ad-cta');
        if (stickyCta) {
            stickyCta.addEventListener('click', () => {
                this.showPostAdModal();
            });
        }

        const bottomCta = document.getElementById('home-bottom-ad-cta');
        if (bottomCta) {
            bottomCta.addEventListener('click', () => {
                this.showPostAdModal();
            });
        }

        const stickyClose = document.getElementById('home-sticky-ad-close');
        if (stickyClose) {
            stickyClose.addEventListener('click', () => {
                this.dismissHomeStickyAd();
                this.updateHomeStickyAdVisibility();
            });
        }

        window.addEventListener('resize', () => this.updateHomeStickyAdVisibility());
        this.didBindHomeSponsoredAds = true;
        this.updateHomeStickyAdVisibility();
    }

		    showPostAdModal({ category = '', placement = '', skipAuth = false } = {}) {
		        if (!skipAuth) {
		            const ok = this.requireSignedIn({
		                reason: 'post an ad',
		                onAuthed: () => this.showPostAdModal({ category, placement, skipAuth: true })
		            });
		            if (!ok) return;
		        }
		        const modal = document.getElementById('post-ad-modal');
		        if (!modal) return;
		        modal.classList.remove('hidden');

        const restoreBtn = document.getElementById('post-ad-restore');
        if (restoreBtn) restoreBtn.classList.add('hidden');

	        if (category) {
	            const categorySelect = document.getElementById('ad-category');
            if (categorySelect) {
                const normalized = String(category).toLowerCase();
                const map = {
                    electronics: 'products',
                    clothing: 'products',
                    buy_sell: 'products',
                    services: 'services',
                    community: 'local_promos',
                    dating: 'other'
                };
                categorySelect.value = map[normalized] || '';
	            }
	        }
	
	        const placementSelect = document.getElementById('ad-placement');
	        if (placementSelect) {
	            const nextPlacement = String(placement || this.postAdDraft?.placement || 'all').toLowerCase();
	            const allowed = new Set(['all', 'home', 'nearby', 'dating', 'companionship']);
	            placementSelect.value = allowed.has(nextPlacement) ? nextPlacement : 'all';
	        }

	        const description = document.getElementById('ad-description');
	        if (description && this.postAdDraft?.description) {
	            description.value = this.postAdDraft.description;
	        }
	
	        const draftCategory = this.postAdDraft?.category;
	        if (!category && draftCategory) {
	            const categorySelect = document.getElementById('ad-category');
	            if (categorySelect) categorySelect.value = draftCategory;
	        }

	        this.setupPostAdUploader();
	        this.renderPostAdUploads();
	    }

	    promoteCompanionshipAds() {
	        this.showPostItemModal({ category: 'dating', placement: 'companionship_featured', luxe: true });
	    }

		    hidePostAdModal({ clearDraft = false } = {}) {
	        const modal = document.getElementById('post-ad-modal');
	        if (!modal) return;
	        modal.classList.add('hidden');
	        const restoreBtn = document.getElementById('post-ad-restore');
	        if (restoreBtn) restoreBtn.classList.add('hidden');
		        if (clearDraft) {
		            this.postAdDraft = { placement: 'all', category: '', description: '' };
		            const form = document.getElementById('post-ad-form');
		            if (form) form.reset();
		            this.clearPostAdUploads();
		        }
		    }

    clearPostAdUploads() {
        const currentAdSrcs = new Set(
            Array.from(document.querySelectorAll('[data-ad-image]'))
                .map((img) => img?.src)
                .filter(Boolean)
        );
        this.postAdUploads.forEach((u) => {
            if (u?.src && u.src.startsWith('blob:')) {
                if (currentAdSrcs.has(u.src)) return;
                try { URL.revokeObjectURL(u.src); } catch {}
            }
        });
        this.postAdUploads = [];
        this.renderPostAdUploads();
    }

    readFileAsDataUrl(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error('read_failed'));
            reader.onload = () => resolve(String(reader.result || ''));
            reader.readAsDataURL(file);
        });
    }

    setupPostAdUploader() {
        const dropzone = document.getElementById('ad-upload-dropzone');
        const deviceInput = document.getElementById('ad-upload-device');
        const deviceBtn = document.getElementById('ad-upload-device-btn');
        const previewList = document.getElementById('ad-upload-previews');

        const trigger = () => {
            if (!deviceInput) return;
            deviceInput.value = '';
            deviceInput.click();
        };

        const addFiles = (fileList) => {
            if (!fileList) return;
            const files = Array.from(fileList).filter((f) => f.type && f.type.startsWith('image/'));
            files.forEach((file) => {
                if (this.postAdUploads.length >= 6) return;
                const id = `${file.name}-${file.lastModified}-${Math.random().toString(16).slice(2)}`;
                const previewUrl = URL.createObjectURL(file);
                this.postAdUploads.push({ id, name: file.name, size: file.size, src: previewUrl, file });
            });
            this.renderPostAdUploads(previewList);
        };

        if (deviceBtn && !deviceBtn.dataset.bound) {
            deviceBtn.addEventListener('click', trigger);
            deviceBtn.dataset.bound = '1';
        }
        if (deviceInput && !deviceInput.dataset.bound) {
            deviceInput.addEventListener('change', (e) => addFiles(e.target.files));
            deviceInput.dataset.bound = '1';
        }
        if (dropzone && !dropzone.dataset.bound) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-active');
            });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-active'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-active');
                addFiles(e.dataTransfer?.files);
            });
            dropzone.addEventListener('paste', (e) => {
                addFiles(e.clipboardData?.files);
            });
            dropzone.addEventListener('click', trigger);
            dropzone.dataset.bound = '1';
        }

        if (previewList && !previewList.dataset.bound) {
            previewList.addEventListener('click', (e) => {
                const btn = e.target?.closest?.('.market-upload-remove');
                if (!btn) return;
                const id = btn.parentElement?.dataset?.id;
                const removed = this.postAdUploads.find((u) => u.id === id);
                if (removed?.src && removed.src.startsWith('blob:')) {
                    try { URL.revokeObjectURL(removed.src); } catch {}
                }
                this.postAdUploads = this.postAdUploads.filter((u) => u.id !== id);
                this.renderPostAdUploads(previewList);
            });
            previewList.dataset.bound = '1';
        }
    }

    renderPostAdUploads(previewListEl) {
        const list = previewListEl || document.getElementById('ad-upload-previews');
        if (!list) return;
        if (!this.postAdUploads.length) {
            list.innerHTML = '<p class="market-upload-empty">No images added yet.</p>';
            return;
        }
        list.innerHTML = this.postAdUploads.map((item, idx) => `
            <div class="market-upload-chip" data-id="${item.id}">
                <img src="${item.src}" alt="${this.escapeHtml(item.name)}" loading="lazy">
                <button type="button" class="market-upload-remove" aria-label="Remove ${this.escapeHtml(item.name)}">&times;</button>
                ${idx === 0 ? '<div class="market-upload-primary">Primary</div>' : ''}
            </div>
        `).join('');
    }

	    openProfilePromoteBuilder() {
	        const placement = (document.getElementById('profile-ad-placement')?.value || 'home').trim().toLowerCase();
	        if (placement === 'dating_featured') {
	            this.openCompanionshipPostModal({ mode: 'dating_featured' });
	            return;
	        }
	        const featuredPresets = {
	            home_featured: { placement: 'home_featured' },
	            marketplace_featured: { placement: 'marketplace_featured' },
	            community_featured: { category: 'community', placement: 'community_featured' },
	            services_featured: { category: 'services', placement: 'services_featured' },
            vehicles_featured: { category: 'vehicles', placement: 'vehicles_featured' },
            realestate_featured: { category: 'real_estate', placement: 'realestate_featured' },
            electronics_featured: { category: 'electronics', placement: 'electronics_featured' },
            companionship_featured: { category: 'dating', placement: 'companionship_featured' }
        };
        const preset = featuredPresets[placement];
        if (preset) {
            this.showPostItemModal({ ...preset, luxe: true });
            return;
	        }
	        this.showPostAdModal({ placement });
	    }

	    insertDatingFeaturedProfileCard(profileId, profile) {
	        const container = document.getElementById('dating-home-ads-carousel');
	        if (!container || !profileId || !profile) return;
	        const photos = Array.isArray(profile.photos) ? profile.photos.filter(Boolean) : [];
	        const first = photos[0] || 'https://via.placeholder.com/600x400/0f172a/f8fafc?text=Profile';
	        const safeName = this.escapeHtml(String(profile.name || 'Featured profile'));
	        const age = Number.isFinite(profile.age) ? profile.age : '';
	        const city = this.escapeHtml(String(profile.city || '').trim());
	        const title = [safeName, age ? `, ${age}` : '', city ? ` 路 ${city}` : ''].join('');
	        const line = this.escapeHtml(String(profile.statusText || (profile.online ? 'Online now' : 'Offline')));
	        const tagline = this.escapeHtml(String(profile.looking || profile.bio || '').trim());

	        const trackImgs = (photos.length ? photos : [first]).map((src) => (
	            `<img src="${this.escapeHtml(String(src))}" alt="${safeName} profile photo" loading="lazy">`
	        )).join('');

	        const cardHtml = `
	            <article class="featured-ad-card" data-profile-id="${this.escapeHtml(String(profileId))}" role="button" tabindex="0" aria-label="View profile for ${safeName}">
	                <div class="featured-ad-tag tag-premium">Spotlight</div>
	                <div class="image-carousel">
	                    <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
	                    <div class="carousel-track" aria-label="Profile photos">
	                        ${trackImgs}
	                    </div>
	                    <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
	                </div>
	                <div class="featured-ad-body">
	                    <h4>${title}</h4>
	                    <p>${line}</p>
	                    <span>${tagline || 'Featured profile'}</span>
	                </div>
	            </article>
	        `;

	        container.insertAdjacentHTML('afterbegin', cardHtml);
	        this.bindImageCarousels();
	        this.bindDatingSponsoredProfileCards();
	        this.decorateDatingSponsoredPresence();
	    }

    getAdPlacementConfig(placement) {
        const key = String(placement || '').toLowerCase();
        const map = {
            home: { screen: 'home', imageSelector: '#home-bottom-ad-image' },
            home_featured: {
                screen: 'home',
                mode: 'featured',
                featuredCardSelector: '#home-featured-ad-slot',
                featuredTrackSelector: '#home-featured-ad-slot .carousel-track',
                scrollSelector: '#home-featured-ads-strip'
            },
            nearby: { screen: 'location', imageSelector: '#nearby-ad-image' },
            dating: { screen: 'dating', imageSelector: '#dating-ad-image' },
            companionship: { screen: 'dating', imageSelector: '#companionship-ad-image' },
            all: { screen: null, imageSelector: '[data-ad-image]' }
        };
        return map[key] || map.home;
    }

    applyPromotedAd({ placement = 'home', src = '' } = {}) {
        const config = this.getAdPlacementConfig(placement);
        if (config.mode === 'featured') {
            this.applyPromotedFeaturedAd({
                trackSelector: config.featuredTrackSelector,
                cardSelector: config.featuredCardSelector,
                scrollSelector: config.scrollSelector,
                src,
                meta: {}
            });
            return;
        }
        const targets = Array.from(document.querySelectorAll(config.imageSelector));
        targets.forEach((img) => {
            if (!img) return;
            img.src = src;
            const slot = img.closest('.home-bottom-ad-image-only');
            if (slot) slot.classList.remove('is-placeholder');
        });
    }

    resetPromotedAdIfMatches({ placement = 'home', src = '' } = {}) {
        const config = this.getAdPlacementConfig(placement);
        if (config.mode === 'featured') {
            this.resetPromotedFeaturedAd({
                cardSelector: config.featuredCardSelector,
                trackSelector: config.featuredTrackSelector,
                src
            });
            return;
        }
        const targets = Array.from(document.querySelectorAll(config.imageSelector));
        targets.forEach((img) => {
            if (!img) return;
            if (src && img.src !== src) return;
            img.src = 'assets/ad-placeholder.svg';
            const slot = img.closest('.home-bottom-ad-image-only');
            if (slot) slot.classList.add('is-placeholder');
        });
    }

    applyPromotedFeaturedAd({ cardSelector, trackSelector, src, meta = {} } = {}) {
        if (!trackSelector) return;
        const track = document.querySelector(trackSelector);
        if (!track) return;
        const card = cardSelector ? document.querySelector(cardSelector) : track.closest('.featured-ad-card');

        const uploaded = Array.isArray(this.profileAdUploads)
            ? this.profileAdUploads.map((u) => u?.src).filter(Boolean)
            : [];
        const sources = [];
        if (src) sources.push(src);
        uploaded.forEach((s) => {
            if (!s) return;
            if (sources.includes(s)) return;
            sources.push(s);
        });
        if (!sources.length) return;
        track.dataset.promotedPrimary = String(src || sources[0] || '');

        const existingImgs = Array.from(track.querySelectorAll('img'));
        if (!track.dataset.origSrcs && existingImgs.length) {
            const orig = existingImgs.map((img) => img.getAttribute('src') || '').filter(Boolean);
            track.dataset.origSrcs = JSON.stringify(orig);
        }

        const desiredCount = Math.max(3, existingImgs.length || 3);
        const normalized = [];
        for (let i = 0; i < desiredCount; i++) normalized.push(sources[i] || sources[0]);

        track.innerHTML = normalized
            .map((s, idx) => `<img src="${this.escapeHtml(String(s))}" alt="Promoted ad photo ${idx + 1}" loading="${idx === 0 ? 'eager' : 'lazy'}">`)
            .join('');

        if (card) {
            const body = card.querySelector('.featured-ad-body');
            const titleEl = body?.querySelector('h4');
            const priceEl = body?.querySelector('p');
            const metaEl = body?.querySelector('span');
            if (titleEl && !titleEl.dataset.origText) titleEl.dataset.origText = titleEl.textContent || '';
            if (priceEl && !priceEl.dataset.origText) priceEl.dataset.origText = priceEl.textContent || '';
            if (metaEl && !metaEl.dataset.origText) metaEl.dataset.origText = metaEl.textContent || '';

            const category = String(meta.category || '').trim();
            const description = String(meta.description || '').trim();
            if (titleEl) titleEl.textContent = category ? `Your ad 路 ${category}` : 'Your promoted ad';
            if (priceEl) priceEl.textContent = description ? description.slice(0, 72) : 'Promoted from your profile';
            if (metaEl) metaEl.textContent = 'Sponsored 路 Just now';
            card.dataset.promoted = '1';
        }
    }

    resetPromotedFeaturedAd({ cardSelector, trackSelector, src = '' } = {}) {
        const track = trackSelector ? document.querySelector(trackSelector) : null;
        const card = cardSelector ? document.querySelector(cardSelector) : null;
        if (!track || !card) return;

        if (src && track.dataset.promotedPrimary && track.dataset.promotedPrimary !== String(src)) {
            return;
        }

        const promotedImgs = Array.from(track.querySelectorAll('img'));
        if (src && promotedImgs.length) {
            const hasMatch = promotedImgs.some((img) => img.src === src || img.getAttribute('src') === src);
            if (!hasMatch) return;
        }

        let origSrcs = [];
        if (track.dataset.origSrcs) {
            try {
                const parsed = JSON.parse(track.dataset.origSrcs);
                if (Array.isArray(parsed)) origSrcs = parsed.map(String).filter(Boolean);
            } catch {}
        }
        if (origSrcs.length) {
            track.innerHTML = origSrcs
                .map((s, idx) => `<img src="${this.escapeHtml(String(s))}" alt="Featured ad photo ${idx + 1}" loading="${idx === 0 ? 'eager' : 'lazy'}">`)
                .join('');
        }

        const body = card.querySelector('.featured-ad-body');
        const titleEl = body?.querySelector('h4');
        const priceEl = body?.querySelector('p');
        const metaEl = body?.querySelector('span');
        if (titleEl?.dataset?.origText) titleEl.textContent = titleEl.dataset.origText;
        if (priceEl?.dataset?.origText) priceEl.textContent = priceEl.dataset.origText;
        if (metaEl?.dataset?.origText) metaEl.textContent = metaEl.dataset.origText;
        delete card.dataset.promoted;
        delete track.dataset.promotedPrimary;
    }

    setupProfileAdUploader() {
        const dropzone = document.getElementById('profile-ad-upload-dropzone');
        const deviceInput = document.getElementById('profile-ad-upload-device');
        const deviceBtn = document.getElementById('profile-ad-upload-device-btn');
        const previewList = document.getElementById('profile-ad-upload-previews');

        if (!dropzone || !deviceInput || !deviceBtn || !previewList) return;

        const trigger = () => {
            deviceInput.value = '';
            deviceInput.click();
        };

        const addFiles = (fileList) => {
            if (!fileList) return;
            const files = Array.from(fileList).filter((f) => f?.type && f.type.startsWith('image/'));
            const max = Number.isFinite(this.profileAdUploadLimit) ? this.profileAdUploadLimit : 6;
            if (!Array.isArray(this.profileAdUploads)) this.profileAdUploads = [];
            const startingCount = this.profileAdUploads.length;
            files.forEach((file) => {
                if (this.profileAdUploads.length >= max) return;
                const id = `${file.name}-${file.lastModified}-${Math.random().toString(16).slice(2)}`;
                const previewUrl = URL.createObjectURL(file);
                this.profileAdUploads.push({ id, name: file.name, size: file.size, src: previewUrl, file });
            });
            this.renderProfileAdUploads();
            if (startingCount < max && this.profileAdUploads.length >= max) {
                this.showNotification(`Max ${max} images for an ad.`, { force: true });
            }
        };

        if (!deviceBtn.dataset.bound) {
            deviceBtn.addEventListener('click', trigger);
            deviceBtn.dataset.bound = '1';
        }
        if (!deviceInput.dataset.bound) {
            deviceInput.addEventListener('change', (e) => addFiles(e.target.files));
            deviceInput.dataset.bound = '1';
        }
        if (!dropzone.dataset.bound) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-active');
            });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-active'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-active');
                addFiles(e.dataTransfer?.files);
            });
            dropzone.addEventListener('paste', (e) => addFiles(e.clipboardData?.files));
            dropzone.addEventListener('click', trigger);
            dropzone.dataset.bound = '1';
        }
        if (!previewList.dataset.bound) {
            previewList.addEventListener('click', (e) => {
                const btn = e.target?.closest?.('.market-upload-remove');
                if (!btn) return;
                const id = btn.parentElement?.dataset?.id;
                const removed = (this.profileAdUploads || []).find((u) => u.id === id);
                if (removed?.src && removed.src.startsWith('blob:')) {
                    try { URL.revokeObjectURL(removed.src); } catch {}
                }
                this.profileAdUploads = (this.profileAdUploads || []).filter((u) => u.id !== id);
                this.renderProfileAdUploads();
            });
            previewList.dataset.bound = '1';
        }
    }

    renderProfileAdUploads() {
        const list = document.getElementById('profile-ad-upload-previews');
        if (!list) return;
        const meta = document.getElementById('profile-ad-upload-meta');
        const max = Number.isFinite(this.profileAdUploadLimit) ? this.profileAdUploadLimit : 6;
        const uploads = Array.isArray(this.profileAdUploads) ? this.profileAdUploads : [];
        if (meta) meta.textContent = `${uploads.length}/${max} images`;
        if (!uploads.length) {
            list.innerHTML = '<p class="market-upload-empty">No images added yet.</p>';
            return;
        }
        list.innerHTML = uploads.map((item, idx) => `
            <div class="market-upload-chip" data-id="${item.id}">
                <img src="${item.src}" alt="${this.escapeHtml(item.name)}" loading="lazy">
                <button type="button" class="market-upload-remove" aria-label="Remove ${this.escapeHtml(item.name)}">&times;</button>
                ${idx === 0 ? '<div class="market-upload-primary">Primary</div>' : ''}
            </div>
        `).join('');
    }

    async handleProfileAdSubmit(e) {
        e.preventDefault();
        const placement = (document.getElementById('profile-ad-placement')?.value || 'home').trim().toLowerCase();
        const category = (document.getElementById('profile-ad-category')?.value || '').trim();
        const description = (document.getElementById('profile-ad-description')?.value || '').trim();

        this.profileAdDraft = { placement, category, description };

        if (!category || !description) {
            this.showNotification('Add a category and description.', { force: true });
            return;
        }
        if (!Array.isArray(this.profileAdUploads) || !this.profileAdUploads.length) {
            this.showNotification('Upload at least 1 image.', { force: true });
            return;
        }

        const feeInfo = this.getPromotionFeeForPlacement(placement);
        const paid = await this.requirePromotionFee({
            placement,
            title: feeInfo.kind === 'banner' ? 'Banner promotion fee' : 'Featured placement fee',
            subtitle: feeInfo.kind === 'banner'
                ? `Promote your banner on ${feeInfo.label || placement}.`
                : 'Featured placements are a paid promotion.'
        });
        if (!paid) return;

        const primaryUpload = this.profileAdUploads[0] || null;
        let nextSrc = primaryUpload?.src || '';
        const file = primaryUpload?.file || null;
        if (file && typeof file.size === 'number' && file.size <= 1_500_000) {
            try {
                const dataUrl = await this.readFileAsDataUrl(file);
                if (dataUrl) nextSrc = dataUrl;
            } catch {}
        }

        if (nextSrc) {
            const config = this.getAdPlacementConfig(placement);
            if (config.mode === 'featured') {
                this.applyPromotedFeaturedAd({
                    cardSelector: config.featuredCardSelector,
                    trackSelector: config.featuredTrackSelector,
                    scrollSelector: config.scrollSelector,
                    src: nextSrc,
                    meta: { category, description }
                });
            } else {
                this.applyPromotedAd({ placement, src: nextSrc });
            }
        }

        const title = category || 'Ad';
        this.addMyPost({
            kind: 'ad',
            title,
            subtitle: `Ad 路 ${placement}`,
            thumb: nextSrc,
            refs: { placement },
            payload: { category, description }
        });

        const currentAdSrcs = new Set(
            Array.from(document.querySelectorAll('[data-ad-image], #home-featured-ad-slot img'))
                .map((img) => img?.src)
                .filter(Boolean)
        );
        (this.profileAdUploads || []).forEach((u) => {
            if (u?.src && u.src.startsWith('blob:') && !currentAdSrcs.has(u.src)) {
                try { URL.revokeObjectURL(u.src); } catch {}
            }
        });
        this.profileAdUploads = [];
        this.renderProfileAdUploads();

        const categoryEl = document.getElementById('profile-ad-category');
        const descEl = document.getElementById('profile-ad-description');
        if (categoryEl) categoryEl.value = '';
        if (descEl) descEl.value = '';

        this.showNotification('Ad promoted.', { force: true, type: 'success' });
    }

    loadRealestate() {
        this.bindRealestateCategoryChips();
        const initialCategory = document.querySelector('.realestate-chip.active')?.dataset.category || 'all';
        this.renderRealestateFeed(initialCategory);
        this.bindRealestateCardClicks();
        this.bindRealestateModal();
        this.bindImageCarousels();
        this.bindFeaturedAdCardLightbox();
    }

    loadVehicles() {
        this.bindVehicleChips();
        this.bindVehicleFilters();
        this.bindVehicleModal();
        const initial = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
        this.renderVehiclesFeed(initial);
        this.bindVehicleFeedClicks();
        this.bindImageCarousels();
        this.bindFeaturedAdCardLightbox();
    }

    loadServices() {
        if (!Array.isArray(this.serviceProfiles) || !this.serviceProfiles.length) {
            this.serviceProfiles = this.loadSampleServiceProfiles();
        }
        this.bindServicesFilters();
        this.renderServicesFeed();
        this.bindImageCarousels();
        this.bindFeaturedAdCardLightbox();
    }

    bindServicesFilters() {
        const chipRow = document.getElementById('services-chip-row');
        const feedSelect = document.getElementById('services-feed-select');
        const countryInput = document.getElementById('services-country-filter');
        const citySelect = document.getElementById('services-city-filter');
        const citySearch = document.getElementById('services-city-search');
        const remoteToggle = document.getElementById('services-remote-toggle');
        const postedSelect = document.getElementById('services-posted');

        if (chipRow && !chipRow.dataset.bound) {
            chipRow.addEventListener('click', (event) => {
                const chip = event.target.closest('.service-chip');
                if (!chip) return;
                this.setServicesCategory(chip.dataset.category || 'all');
            });
            chipRow.dataset.bound = '1';
        }

        if (feedSelect && !feedSelect.dataset.bound) {
            feedSelect.addEventListener('change', () => {
                this.setServicesCategory(feedSelect.value || 'all');
            });
            feedSelect.dataset.bound = '1';
        }

        if (countryInput && !countryInput.dataset.bound) {
            countryInput.addEventListener('input', () => {
                this.servicesFeedFilters.country = countryInput.value.trim();
                this.renderServicesFeed();
            });
            countryInput.dataset.bound = '1';
        }
        if (countryInput) {
            this.servicesFeedFilters.country = countryInput.value.trim();
        }

        if (citySearch && !citySearch.dataset.bound) {
            citySearch.addEventListener('input', () => {
                this.servicesFeedFilters.citySearch = citySearch.value.trim();
                if (this.servicesFeedFilters.citySearch) {
                    this.servicesFeedFilters.citySelect = 'all';
                    if (citySelect) citySelect.value = 'all';
                }
                this.renderServicesFeed();
            });
            citySearch.dataset.bound = '1';
        }
        if (citySearch) {
            this.servicesFeedFilters.citySearch = citySearch.value.trim();
        }

        if (citySelect && !citySelect.dataset.bound) {
            citySelect.addEventListener('change', () => {
                this.servicesFeedFilters.citySelect = citySelect.value || 'all';
                if (this.servicesFeedFilters.citySelect !== 'all' && citySearch) {
                    citySearch.value = '';
                    this.servicesFeedFilters.citySearch = '';
                }
                this.renderServicesFeed();
            });
            citySelect.dataset.bound = '1';
        }
        if (citySelect) {
            this.servicesFeedFilters.citySelect = citySelect.value || 'all';
        }

        if (remoteToggle && !remoteToggle.dataset.bound) {
            remoteToggle.addEventListener('change', () => {
                this.servicesFeedFilters.remoteOnly = Boolean(remoteToggle.checked);
                this.renderServicesFeed();
            });
            remoteToggle.dataset.bound = '1';
        }
        if (remoteToggle) {
            this.servicesFeedFilters.remoteOnly = Boolean(remoteToggle.checked);
        }
        if (postedSelect && !postedSelect.dataset.bound) {
            postedSelect.addEventListener('change', () => {
                this.servicesFeedFilters.posted = postedSelect.value || 'all';
                this.renderServicesFeed();
            });
            postedSelect.dataset.bound = '1';
        }
        if (postedSelect) {
            this.servicesFeedFilters.posted = postedSelect.value || 'all';
        }

        if (!this.servicesFeedFilters.category) {
            this.servicesFeedFilters.category = 'all';
        }
        const initialCategory = chipRow?.querySelector('.service-chip.active')?.dataset.category
            || feedSelect?.value
            || this.servicesFeedFilters.category
            || 'all';
        this.setServicesCategory(initialCategory, { render: false });
    }

    setServicesCategory(category, { render = true } = {}) {
        const normalized = category || 'all';
        this.servicesFeedFilters.category = normalized;

        const chipRow = document.getElementById('services-chip-row');
        if (chipRow) {
            chipRow.querySelectorAll('.service-chip').forEach((chip) => {
                chip.classList.toggle('active', chip.dataset.category === normalized);
            });
        }

        const feedSelect = document.getElementById('services-feed-select');
        if (feedSelect) feedSelect.value = normalized;

        if (render) this.renderServicesFeed();
    }

    getServiceCategoryLabel(category) {
        const map = {
            all: 'All services',
            food: 'Food',
            entertainment: 'Entertainment',
            fitness: 'Fitness & Training',
            financial: 'Financial & Legal',
            health_beauty: 'Health & Beauty',
            home_services: 'Home Services',
            pet_services: 'Pet Services',
            skilled_trades: 'Skilled Trades',
            events_services: 'Events & Services',
            travel: 'Travel & Vacations',
            other: 'Other'
        };
        return map[category] || 'All services';
    }

    getServiceLocationLabel(service) {
        const city = String(service?.city || '').trim();
        const country = String(service?.country || '').trim();
        const location = [city, country].filter(Boolean).join(', ');
        if (location) return location;
        return service?.remote ? 'Remote' : '';
    }

    getFilteredServiceProfiles({ skipCity = false } = {}) {
        const filters = this.servicesFeedFilters || {};
        const category = String(filters.category || 'all');
        const countryQuery = this.normalizeLocationText(filters.country || '');
        const cityQuery = this.normalizeLocationText(filters.citySearch || '');
        const citySelect = String(filters.citySelect || 'all');
        const remoteOnly = filters.remoteOnly === true;
        const posted = String(filters.posted || 'all');
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        const monthAgo = new Date(today);
        monthAgo.setMonth(today.getMonth() - 1);

        let list = Array.isArray(this.serviceProfiles) ? [...this.serviceProfiles] : [];
        if (category && category !== 'all') {
            list = list.filter((service) => service.category === category);
        }
        if (countryQuery) {
            list = list.filter((service) => {
                const country = this.normalizeLocationText(service.country || '');
                return country.includes(countryQuery);
            });
        }
        if (remoteOnly) {
            list = list.filter((service) => service.remote === true);
        }
        if (posted && posted !== 'all') {
            list = list.filter((service) => {
                const activityDate = this.normalizeActivityDate(service.postedAt || service.createdAt || service.postedDate);
                if (!activityDate) return false;
                if (posted === 'today' && activityDate < today) return false;
                if (posted === 'week' && activityDate < weekAgo) return false;
                if (posted === 'month' && activityDate < monthAgo) return false;
                return true;
            });
        }
        if (!skipCity) {
            if (cityQuery) {
                list = list.filter((service) => {
                    const city = this.normalizeLocationText(service.city || '');
                    return city.includes(cityQuery);
                });
            } else if (citySelect && citySelect !== 'all') {
                list = list.filter((service) => {
                    const city = this.normalizeLocationText(service.city || '');
                    return city === this.normalizeLocationText(citySelect);
                });
            }
        }
        return list;
    }

    updateServicesCityOptions(sourceList = []) {
        const select = document.getElementById('services-city-filter');
        const datalist = document.getElementById('services-city-datalist');
        const cities = Array.from(new Set(
            (sourceList || [])
                .map((service) => String(service.city || '').trim())
                .filter(Boolean)
        )).sort((a, b) => a.localeCompare(b));

        if (select) {
            const current = select.value || 'all';
            const options = cities.map((city) => `<option value="${this.escapeHtml(city)}">${this.escapeHtml(city)}</option>`).join('');
            select.innerHTML = `<option value="all">All cities</option>${options}`;
            select.disabled = !cities.length;
            if (cities.includes(current)) select.value = current;
            else select.value = 'all';
        }

        if (datalist) this.fillDatalist(datalist, cities, 200);
    }

    renderServiceFeedCard(service) {
        const title = this.escapeHtml(String(service.title || 'Service'));
        const priceLine = [service.price, service.priceNote].filter(Boolean).join(' 路 ');
        const highlight = service.highlightLine || service.meta || (service.highlights || [])[0] || '';
        const location = this.getServiceLocationLabel(service);
        const metaLine = [location, highlight].filter(Boolean).join(' 路 ');
        const photos = Array.isArray(service.photos) ? service.photos.filter(Boolean) : [];
        const tagText = service.cardTag || this.getServiceCategoryLabel(service.category);
        const tagClass = service.cardTagClass ? ` ${service.cardTagClass}` : '';
        const dataAttrs = {
            serviceId: service.id,
            serviceTitle: service.title,
            servicePrice: service.price,
            servicePriceNote: service.priceNote,
            serviceLocation: location,
            servicePhone: service.phone,
            serviceRating: service.rating,
            serviceReviews: service.reviews,
            serviceProvider: service.provider,
            serviceRole: service.role,
            serviceAvatar: service.avatar,
            serviceBadge: service.badge,
            serviceDesc: service.desc,
            serviceMeta: service.meta,
            serviceHighlights: (service.highlights || []).join('|'),
            serviceAvailability: (service.availability || []).join('|'),
            serviceTags: (service.tags || []).join('|'),
            servicePhotos: photos.join('|')
        };
        const dataAttrString = Object.entries(dataAttrs)
            .filter(([, value]) => value !== undefined && value !== null && String(value).trim() !== '')
            .map(([key, value]) => `data-${key.replace(/[A-Z]/g, (m) => `-${m.toLowerCase()}`)}="${this.escapeHtml(String(value))}"`)
            .join(' ');

        const imagesHtml = photos.length
            ? photos.map((src, idx) => `<img src="${this.escapeHtml(src)}" alt="${title} photo ${idx + 1}" loading="lazy">`).join('')
            : `<img src="https://via.placeholder.com/600x400/111827/f8fafc?text=Service" alt="${title} photo" loading="lazy">`;

        return `
            <article class="featured-ad-card service-feed-card" ${dataAttrString} role="button" tabindex="0" aria-label="View ${title}">
                <div class="featured-ad-tag${tagClass}">${this.escapeHtml(tagText)}</div>
                <div class="image-carousel">
                    <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left"></i></button>
                    <div class="carousel-track" aria-label="${title} photos">
                        ${imagesHtml}
                    </div>
                    <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="featured-ad-body">
                    <h4>${title}</h4>
                    <p>${this.escapeHtml(priceLine)}</p>
                    <span>${this.escapeHtml(metaLine)}</span>
                </div>
            </article>
        `;
    }

    renderServicesFeed() {
        const feed = document.getElementById('services-feed');
        if (!feed) return;
        const countEl = document.getElementById('services-feed-count');
        const labelEl = document.getElementById('services-feed-label');

        const baseList = this.getFilteredServiceProfiles({ skipCity: true });
        this.updateServicesCityOptions(baseList);
        const filtered = this.getFilteredServiceProfiles();

        const count = filtered.length;
        if (countEl) countEl.textContent = `${count} ${count === 1 ? 'result' : 'results'}`;
        if (labelEl) {
            const categoryLabel = this.getServiceCategoryLabel(this.servicesFeedFilters.category);
            const extra = [];
            if (this.servicesFeedFilters.country) extra.push(this.servicesFeedFilters.country.trim());
            if (this.servicesFeedFilters.remoteOnly) extra.push('Remote');
            const posted = String(this.servicesFeedFilters.posted || 'all');
            const postedLabel = posted === 'today'
                ? 'Posted today'
                : posted === 'week'
                    ? 'Posted this week'
                    : posted === 'month'
                        ? 'Posted this month'
                        : '';
            if (postedLabel) extra.push(postedLabel);
            const suffix = extra.length ? ` 路 ${extra.join(' 路 ')}` : '';
            labelEl.textContent = `in ${categoryLabel}${suffix}`;
        }

        if (!filtered.length) {
            feed.classList.remove('services-feed-grouped');
            feed.innerHTML = '<div class="services-feed-empty">No service profiles match these filters.</div>';
            return;
        }

        feed.classList.add('services-feed-grouped');
        const sorted = filtered
            .slice()
            .sort((a, b) => {
                const dateA = this.normalizeActivityDate(a.postedAt || a.createdAt || a.postedDate);
                const dateB = this.normalizeActivityDate(b.postedAt || b.createdAt || b.postedDate);
                const timeA = dateA instanceof Date ? dateA.getTime() : 0;
                const timeB = dateB instanceof Date ? dateB.getTime() : 0;
                return timeB - timeA;
            });
        const toDayKey = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'unknown';
            return date.toISOString().slice(0, 10);
        };
        const grouped = sorted.reduce((acc, service) => {
            const date = this.normalizeActivityDate(service.postedAt || service.createdAt || service.postedDate);
            const key = toDayKey(date);
            if (!acc[key]) acc[key] = [];
            acc[key].push(service);
            return acc;
        }, {});
        const groupKeys = Object.keys(grouped).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
        });

        feed.innerHTML = groupKeys.map((key) => {
            const items = grouped[key] || [];
            const label = key === 'unknown'
                ? 'Unknown'
                : (this.formatFeedHeaderDate(new Date(`${key}T00:00:00`)) || 'Unknown');
            const countLabel = `${items.length} ${items.length === 1 ? 'service' : 'services'}`;
            return `
                <div class="vehicles-feed-group services-feed-group">
                    <div class="vehicles-feed-header">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${countLabel}</span>
                    </div>
                    <div class="services-feed-day-list">
                        ${items.map((service) => this.renderServiceFeedCard(service)).join('')}
                    </div>
                </div>
            `;
        }).join('');
        this.bindImageCarousels();
        this.bindFeaturedAdCardLightbox();
    }

    bindRealestateCategoryChips() {
        const chipRow = document.querySelector('.realestate-chip-row');
        if (!chipRow || chipRow.dataset.bound) return;

        const chips = Array.from(chipRow.querySelectorAll('.realestate-chip'));
        const applyFilter = (category) => {
            this.renderRealestateFeed(category || 'all');
            chips.forEach(chip => {
                chip.classList.toggle('active', chip.dataset.category === category);
            });
        };

        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                applyFilter(chip.dataset.category || 'all');
            });
        });
        chipRow.dataset.bound = '1';
        const initialCategory = chipRow.querySelector('.realestate-chip.active')?.dataset.category || 'all';
        applyFilter(initialCategory);
    }

    bindVehicleChips() {
        const chipRow = document.querySelector('.vehicles-chip-row');
        if (!chipRow || chipRow.dataset.bound) return;
        const chips = Array.from(chipRow.querySelectorAll('.vehicles-chip'));
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                chips.forEach(btn => btn.classList.remove('active'));
                chip.classList.add('active');
                this.renderVehiclesFeed(chip.dataset.category || 'all');
            });
        });
        chipRow.dataset.bound = '1';
    }

    bindVehicleFilters() {
        const searchInput = document.getElementById('vehicles-search');
        const makeSelect = document.getElementById('vehicles-make');
        const modelSelect = document.getElementById('vehicles-model');
        const conditionSelect = document.getElementById('vehicles-condition');
        const countryInput = document.getElementById('vehicles-country');
        const cityInput = document.getElementById('vehicles-city');
        const sellerInput = document.getElementById('vehicles-seller');
        const yearMinInput = document.getElementById('vehicles-year-min');
        const yearMaxInput = document.getElementById('vehicles-year-max');
        const mileageMinInput = document.getElementById('vehicles-mileage-min');
        const mileageMaxInput = document.getElementById('vehicles-mileage-max');
        const postedSelect = document.getElementById('vehicles-posted');
        const priceTermSelect = document.getElementById('vehicles-price-term');
        const sortSelect = document.getElementById('vehicles-sort');
        const savedSearchSelect = document.getElementById('vehicles-saved-search');
        const saveSearchBtn = document.getElementById('vehicles-save-search');
        const favsToggleBtn = document.getElementById('vehicles-favs-toggle');
        const minInput = document.getElementById('vehicles-price-min');
        const maxInput = document.getElementById('vehicles-price-max');

        this.populateVehicleMakeModel(makeSelect, modelSelect);
        const appliedFromUrl = this.applyVehiclesStateFromUrl({
            searchInput,
            makeSelect,
            modelSelect,
            conditionSelect,
            countryInput,
            cityInput,
            sellerInput,
            yearMinInput,
            yearMaxInput,
            mileageMinInput,
            mileageMaxInput,
            postedSelect,
            priceTermSelect,
            minInput,
            maxInput,
            sortSelect
        });
        if (!appliedFromUrl) {
            this.applyVehiclesInputsFromState({
                searchInput,
                makeSelect,
                modelSelect,
                conditionSelect,
                countryInput,
                cityInput,
                sellerInput,
                yearMinInput,
                yearMaxInput,
                mileageMinInput,
                mileageMaxInput,
                postedSelect,
                priceTermSelect,
                minInput,
                maxInput,
                sortSelect
            });
        }

        this.renderVehicleSavedSearches(savedSearchSelect);
        this.syncVehicleFavoritesButton(favsToggleBtn);

        const updateFilters = () => {
            this.vehicleFilters.search = (searchInput?.value || '').trim().toLowerCase();
            this.vehicleFilters.country = (countryInput?.value || '').trim().toLowerCase();
            this.vehicleFilters.city = (cityInput?.value || '').trim().toLowerCase();
            this.vehicleFilters.seller = (sellerInput?.value || '').trim().toLowerCase();
            this.vehicleFilters.posted = postedSelect?.value || 'any';
            this.vehicleFilters.priceTerm = priceTermSelect?.value || 'any';
            this.vehicleFilters.make = (makeSelect?.value || '').trim();
            this.vehicleFilters.model = (modelSelect?.value || '').trim();
            this.vehicleFilters.condition = (conditionSelect?.value || '').trim();
            this.vehicleFilters.yearMin = yearMinInput?.value ? parseInt(yearMinInput.value, 10) : null;
            this.vehicleFilters.yearMax = yearMaxInput?.value ? parseInt(yearMaxInput.value, 10) : null;
            this.vehicleFilters.mileageMin = mileageMinInput?.value ? parseInt(mileageMinInput.value, 10) : null;
            this.vehicleFilters.mileageMax = mileageMaxInput?.value ? parseInt(mileageMaxInput.value, 10) : null;
            this.vehicleFilters.min = minInput?.value ? parseFloat(minInput.value) : null;
            this.vehicleFilters.max = maxInput?.value ? parseFloat(maxInput.value) : null;
            this.vehicleFilters.sort = sortSelect?.value || 'newest';
            this.vehicleFilters.page = 1;
            const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
            this.persistVehicleState();
            this.updateVehiclesUrl();
            this.renderVehiclesFeed(activeCategory);
        };

        [searchInput, countryInput, cityInput, sellerInput].forEach(input => {
            if (input && !input.dataset.bound) {
                input.addEventListener('input', updateFilters);
                input.dataset.bound = '1';
            }
        });
        [makeSelect, modelSelect, conditionSelect, postedSelect, priceTermSelect, sortSelect].forEach(input => {
            if (input && !input.dataset.bound) {
                input.addEventListener('change', updateFilters);
                input.dataset.bound = '1';
            }
        });
        [yearMinInput, yearMaxInput, mileageMinInput, mileageMaxInput, minInput, maxInput].forEach(input => {
            if (input && !input.dataset.bound) {
                input.addEventListener('change', updateFilters);
                input.dataset.bound = '1';
            }
        });

        if (savedSearchSelect && !savedSearchSelect.dataset.bound) {
            savedSearchSelect.addEventListener('change', () => {
                const id = savedSearchSelect.value || '';
                if (!id) return;
                this.applyVehicleSavedSearch(id, {
                    searchInput,
                    makeSelect,
                    modelSelect,
                    conditionSelect,
                    countryInput,
                    cityInput,
                    sellerInput,
                    yearMinInput,
                    yearMaxInput,
                    mileageMinInput,
                    mileageMaxInput,
                    postedSelect,
                    priceTermSelect,
                    minInput,
                    maxInput,
                    sortSelect
                });
                updateFilters();
            });
            savedSearchSelect.dataset.bound = '1';
        }

        if (saveSearchBtn && !saveSearchBtn.dataset.bound) {
            saveSearchBtn.addEventListener('click', () => {
                this.saveVehicleSearch();
                this.renderVehicleSavedSearches(savedSearchSelect);
            });
            saveSearchBtn.dataset.bound = '1';
        }

        if (favsToggleBtn && !favsToggleBtn.dataset.bound) {
            favsToggleBtn.addEventListener('click', () => {
                this.vehicleFilters.favoritesOnly = !this.vehicleFilters.favoritesOnly;
                favsToggleBtn.classList.toggle('active', this.vehicleFilters.favoritesOnly);
                this.vehicleFilters.page = 1;
                this.persistVehicleState();
                this.updateVehiclesUrl();
                const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
                this.renderVehiclesFeed(activeCategory);
            });
            favsToggleBtn.dataset.bound = '1';
        }

        updateFilters();
    }

    renderVehiclesFeed(category) {
        const container = document.getElementById('vehicles-items');
        if (!container) return;
        const filtered = this.vehicleListings.filter(item => {
            if (!category || category === 'all') return true;
            return item.category === category;
        }).filter(item => {
            const { search, country, city, seller, posted, priceTerm, make, model, condition, yearMin, yearMax, mileageMin, mileageMax, min, max, favoritesOnly } = this.vehicleFilters;
            if (country && (item.country || '').toLowerCase() !== country) return false;
            if (city && (item.city || '').toLowerCase() !== city) return false;
            if (seller && !(item.seller || '').toLowerCase().includes(seller)) return false;
            if (favoritesOnly && !this.vehicleFavorites.has(item.id)) return false;
            if (make && (item.make || '') !== make) return false;
            if (model && (item.model || '') !== model) return false;
            if (condition && (item.condition || '') !== condition) return false;

            if (yearMin !== null && typeof item.year === 'number' && item.year < yearMin) return false;
            if (yearMax !== null && typeof item.year === 'number' && item.year > yearMax) return false;
            if (mileageMin !== null && typeof item.mileageKm === 'number' && item.mileageKm < mileageMin) return false;
            if (mileageMax !== null && typeof item.mileageKm === 'number' && item.mileageKm > mileageMax) return false;

            if (posted && posted !== 'any') {
                const today = new Date();
                const itemDate = item.date ? new Date(item.date) : null;
                if (!itemDate || Number.isNaN(itemDate.getTime())) return false;
                const ms = today.setHours(0, 0, 0, 0) - itemDate.setHours(0, 0, 0, 0);
                const days = ms / (1000 * 60 * 60 * 24);
                if (posted === 'today' && days !== 0) return false;
                if (posted === 'week' && (days < 0 || days > 7)) return false;
                if (posted === 'month' && (days < 0 || days > 31)) return false;
            }

            if (priceTerm && priceTerm !== 'any') {
                const raw = (item.price || '').toLowerCase();
                const term = raw.includes('/day') ? 'per_day' : 'one_time';
                if (term !== priceTerm) return false;
            }

            const value = typeof item.priceValue === 'number' ? item.priceValue : null;
            if (min !== null && value !== null && value < min) return false;
            if (max !== null && value !== null && value > max) return false;
            if (!search) return true;
            const haystack = [item.title, item.city, item.country, item.seller, item.category, item.make, item.model]
                .filter(Boolean)
                .join(' ')
                .toLowerCase();
            return haystack.includes(search);
        });

        const sort = this.vehicleFilters.sort || 'newest';
        const sorted = filtered.slice().sort((a, b) => {
            if (sort === 'price_low') {
                const av = typeof a.priceValue === 'number' ? a.priceValue : Number.POSITIVE_INFINITY;
                const bv = typeof b.priceValue === 'number' ? b.priceValue : Number.POSITIVE_INFINITY;
                return av - bv;
            }
            if (sort === 'price_high') {
                const av = typeof a.priceValue === 'number' ? a.priceValue : Number.NEGATIVE_INFINITY;
                const bv = typeof b.priceValue === 'number' ? b.priceValue : Number.NEGATIVE_INFINITY;
                return bv - av;
            }
            if (sort === 'title') {
                return (a.title || '').localeCompare(b.title || '');
            }
            return (b.date || '').localeCompare(a.date || '');
        });

        const { page, pageSize } = this.vehicleFilters;
        const total = sorted.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        const safePage = Math.min(Math.max(1, page), totalPages);
        this.vehicleFilters.page = safePage;
        const start = (safePage - 1) * pageSize;
        const pageItems = sorted.slice(start, start + pageSize);
        const grouped = pageItems.reduce((acc, item) => {
            const key = item.date || 'Unknown';
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});
	        const dates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
	        const html = dates.map(dateKey => {
	            const items = grouped[dateKey];
	            const label = this.formatRealestateDate(dateKey);
	            const cards = items.map(item => {
	                const title = this.escapeHtml(item.title);
	                const allMedia = (Array.isArray(item.images) && item.images.length ? item.images : [item.image].filter(Boolean))
	                    .filter(Boolean);
	                const media = allMedia.slice(0, 6);
	                const hasCarousel = allMedia.length > 1;
	                const images = media
	                    .map((src) => `<img src="${this.escapeHtml(String(src || ''))}" alt="${title} photo">`)
	                    .join('');
	                const nav = hasCarousel
	                    ? `
	                        <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
	                        <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
	                    `
	                    : '';
	                return `
	                    <div class="dating-feed-card vehicle-feed-card" data-vehicle-id="${this.escapeHtml(item.id)}" role="button" tabindex="0" aria-label="Open ${title}">
	                        <div class="image-carousel vehicle-card-carousel" aria-label="Photos for ${title}">
	                            ${nav}
	                            <div class="carousel-track">
	                                ${images}
	                            </div>
	                        </div>
	                        <div class="dating-feed-meta">
	                            <div class="dating-feed-name">${title}</div>
	                            <div class="dating-feed-location">${this.escapeHtml(item.city)} 路 ${this.escapeHtml(item.price)}</div>
	                            <div class="dating-feed-status ${this.vehicleFavorites.has(item.id) ? 'online' : 'offline'}">${this.vehicleFavorites.has(item.id) ? 'Saved' : 'View details'}</div>
	                        </div>
	                        <button class="dating-feed-action vehicle-fav-btn" type="button" aria-label="Save ${title}">${this.vehicleFavorites.has(item.id) ? 'Saved' : 'Save'}</button>
	                    </div>
	                `;
	            }).join('');
            return `
                <div class="vehicles-feed-group">
                    <div class="vehicles-feed-header">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${items.length} listings</span>
                    </div>
                    <div class="dating-feed">
                        ${cards}
                    </div>
                </div>
            `;
        }).join('');

	        container.innerHTML = html || '<p class="no-items">No vehicle listings match this filter.</p>';
	        const count = document.getElementById('vehicles-count');
	        if (count) count.textContent = `${filtered.length} listings`;
	        this.renderVehiclesPagination(totalPages);
	        this.bindImageCarousels();
	    }

    bindVehicleFeedClicks() {
        const container = document.getElementById('vehicles-items');
        if (!container || container.dataset.boundVehicleClick) return;
        container.addEventListener('click', (e) => {
            const fav = e.target.closest('.vehicle-fav-btn');
            if (fav) {
                e.stopPropagation();
                const card = e.target.closest('.vehicle-feed-card');
                const id = card?.dataset.vehicleId || '';
                if (id) {
                    this.toggleVehicleFavorite(id);
                    const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
                    this.renderVehiclesFeed(activeCategory);
                    const favsToggleBtn = document.getElementById('vehicles-favs-toggle');
                    this.syncVehicleFavoritesButton(favsToggleBtn);
                }
                return;
            }
            const card = e.target.closest('.vehicle-feed-card');
            if (!card) return;
            const id = card.dataset.vehicleId || '';
            this.openVehicleListingModal(id);
        });
        container.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            const card = e.target.closest('.vehicle-feed-card');
            if (!card) return;
            e.preventDefault();
            const id = card.dataset.vehicleId || '';
            this.openVehicleListingModal(id);
        });
        container.dataset.boundVehicleClick = '1';
    }

    openVehicleListingModal(id) {
        if (!id) return;
        const item = this.vehicleListings.find(entry => entry.id === id);
        if (!item) return;
        this.openVehicleModal(item);
    }

	    openVehicleModal(item) {
	        const modal = document.getElementById('vehicle-modal');
	        if (!modal) return;
	        const titleEl = document.getElementById('vehicle-modal-title');
	        const subEl = document.getElementById('vehicle-modal-sub');
	        const priceEl = document.getElementById('vehicle-modal-price');
	        const imgEl = document.getElementById('vehicle-modal-image');
	        const counterEl = document.getElementById('vehicle-media-counter');
	        const thumbsEl = document.getElementById('vehicle-media-thumbs');
	        const favBtn = document.getElementById('vehicle-modal-fav');
        const sellerNameEl = document.getElementById('vehicle-modal-seller-name');
	        const specsEl = document.getElementById('vehicle-modal-specs');

        const photos = Array.isArray(item.images) && item.images.length ? item.images : [item.image].filter(Boolean);
        this.vehicleModalPhotos = photos;
        this.vehicleModalIndex = 0;
        this.activeVehicleId = item.id;
        this.activeVehicleListing = item;

        if (titleEl) titleEl.textContent = item.title || 'Vehicle';
        if (subEl) subEl.textContent = [item.make, item.model, item.year].filter(Boolean).join(' 路 ');
	        if (priceEl) priceEl.textContent = item.price || '';
	        if (imgEl) imgEl.src = photos[0] || '';
	        if (counterEl) counterEl.textContent = `${photos.length ? 1 : 0} / ${photos.length}`;
        if (sellerNameEl) sellerNameEl.textContent = item.seller || '';
	        if (thumbsEl) this.renderVehicleModalThumbs(thumbsEl);

        if (specsEl) {
            const rows = [
                ['Condition', item.condition ? item.condition.toUpperCase() : ''],
                ['Mileage', typeof item.mileageKm === 'number' ? `${item.mileageKm.toLocaleString()} km` : ''],
                ['Location', [item.city, item.country].filter(Boolean).join(', ')],
                ['Category', item.category || '']
            ].filter(([, v]) => v);
            specsEl.innerHTML = rows.map(([k, v]) => `<div class="vehicle-spec-row"><span>${this.escapeHtml(k)}</span><strong>${this.escapeHtml(String(v))}</strong></div>`).join('');
        }

        if (favBtn) {
            const isFav = this.vehicleFavorites.has(item.id);
            favBtn.textContent = isFav ? 'Saved' : 'Save';
            favBtn.classList.toggle('active', isFav);
            favBtn.onclick = () => {
                this.toggleVehicleFavorite(item.id);
                const nowFav = this.vehicleFavorites.has(item.id);
                favBtn.textContent = nowFav ? 'Saved' : 'Save';
                favBtn.classList.toggle('active', nowFav);
                const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
                this.renderVehiclesFeed(activeCategory);
                const favsToggleBtn = document.getElementById('vehicles-favs-toggle');
                this.syncVehicleFavoritesButton(favsToggleBtn);
            };
        }

	        modal.classList.remove('hidden');
	    }

	    renderVehicleModalThumbs(container) {
	        if (!container) return;
	        const photos = Array.isArray(this.vehicleModalPhotos) ? this.vehicleModalPhotos : [];
	        if (photos.length <= 1) {
	            container.innerHTML = '';
	            container.classList.add('hidden');
	            return;
	        }
	        const idx = Math.min(Math.max(this.vehicleModalIndex || 0, 0), photos.length - 1);
	        container.classList.remove('hidden');
	        container.innerHTML = photos.map((src, i) => {
	            const active = i === idx;
	            const safeSrc = this.escapeHtml(String(src || ''));
	            return `<button class="vehicle-media-thumb${active ? ' active' : ''}" type="button" data-vehicle-thumb="${i}" aria-label="Open photo ${i + 1}"><img src="${safeSrc}" alt="Vehicle thumbnail ${i + 1}" loading="lazy"></button>`;
	        }).join('');

	        if (!container.dataset.bound) {
	            container.addEventListener('click', (e) => {
	                const btn = e.target.closest('[data-vehicle-thumb]');
	                if (!btn) return;
	                const i = parseInt(btn.dataset.vehicleThumb, 10);
	                if (!Number.isFinite(i)) return;
	                this.vehicleModalIndex = i;
	                const imgEl = document.getElementById('vehicle-modal-image');
	                const counterEl = document.getElementById('vehicle-media-counter');
	                const photos = Array.isArray(this.vehicleModalPhotos) ? this.vehicleModalPhotos : [];
	                const idx = Math.min(Math.max(0, this.vehicleModalIndex || 0), Math.max(0, photos.length - 1));
	                this.vehicleModalIndex = idx;
	                if (imgEl) imgEl.src = photos[idx] || '';
	                if (counterEl) counterEl.textContent = `${photos.length ? idx + 1 : 0} / ${photos.length}`;
	                this.renderVehicleModalThumbs(container);
	            });
	            container.dataset.bound = '1';
	        }

	        const active = container.querySelector('.vehicle-media-thumb.active');
	        active?.scrollIntoView?.({ block: 'nearest', inline: 'center' });
	    }

    closeVehicleModal() {
        const modal = document.getElementById('vehicle-modal');
        if (modal) modal.classList.add('hidden');
        this.activeVehicleListing = null;
    }

    bindVehicleModal() {
        const modal = document.getElementById('vehicle-modal');
        if (!modal || modal.dataset.bound) return;
	        const closeBtn = document.getElementById('vehicle-modal-close');
	        const prevBtn = document.getElementById('vehicle-media-prev');
	        const nextBtn = document.getElementById('vehicle-media-next');
	        const imgEl = document.getElementById('vehicle-modal-image');
	        const counterEl = document.getElementById('vehicle-media-counter');
	        const thumbsEl = document.getElementById('vehicle-media-thumbs');
        const sellerBtn = document.getElementById('vehicle-modal-seller');
        const sellerNameBtn = document.getElementById('vehicle-modal-seller-name');

	        const render = () => {
	            const photos = Array.isArray(this.vehicleModalPhotos) ? this.vehicleModalPhotos : [];
	            const idx = Math.min(Math.max(0, this.vehicleModalIndex || 0), Math.max(0, photos.length - 1));
	            this.vehicleModalIndex = idx;
	            if (imgEl) imgEl.src = photos[idx] || '';
	            if (counterEl) counterEl.textContent = `${photos.length ? idx + 1 : 0} / ${photos.length}`;
	            if (thumbsEl) this.renderVehicleModalThumbs(thumbsEl);
	        };

        const doClose = () => this.closeVehicleModal();
        if (closeBtn) closeBtn.addEventListener('click', doClose);
        if (prevBtn) prevBtn.addEventListener('click', () => {
            this.vehicleModalIndex = (this.vehicleModalIndex || 0) - 1;
            render();
        });
        if (nextBtn) nextBtn.addEventListener('click', () => {
            this.vehicleModalIndex = (this.vehicleModalIndex || 0) + 1;
            render();
        });
        if (sellerBtn && !sellerBtn.dataset.bound) {
            sellerBtn.addEventListener('click', () => {
                this.openSellerProfileFromVehicle();
            });
            sellerBtn.dataset.bound = '1';
        }
        if (sellerNameBtn && !sellerNameBtn.dataset.bound) {
            sellerNameBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                this.openSellerProfileFromVehicle();
            });
            sellerNameBtn.dataset.bound = '1';
        }
        modal.addEventListener('click', (e) => {
            if (e.target === modal) doClose();
        });
        document.addEventListener('keydown', (e) => {
            if (modal.classList.contains('hidden')) return;
            if (e.key === 'Escape') doClose();
        });
        modal.dataset.bound = '1';
    }

    parseServiceCardList(value = '') {
        return String(value || '')
            .split('|')
            .map(item => item.trim())
            .filter(Boolean);
    }

    formatStarRating(value) {
        const raw = typeof value === 'number' ? value : parseFloat(String(value || ''));
        if (!Number.isFinite(raw)) return value ? String(value) : '';
        const filled = Math.max(0, Math.min(5, Math.round(raw)));
        const stars = `${'猸'.repeat(filled)}${''.repeat(5 - filled)}`.trim();
        return `${stars} ${raw.toFixed(1)}`.trim();
    }

    computeSeedFromString(value = '') {
        return String(value || '').split('').reduce((sum, ch) => sum + ch.charCodeAt(0), 0);
    }

    normalizeSellerKey(name = '') {
        return String(name || '').trim().toLowerCase();
    }

    loadSellerReviewsStore() {
        try {
            const raw = localStorage.getItem(this.sellerReviewsStorageKey);
            const parsed = JSON.parse(raw || '{}');
            return parsed && typeof parsed === 'object' ? parsed : {};
        } catch {
            return {};
        }
    }

    saveSellerReviewsStore(store) {
        try {
            localStorage.setItem(this.sellerReviewsStorageKey, JSON.stringify(store || {}));
        } catch {}
    }

    getSellerReviews(sellerName) {
        const key = this.normalizeSellerKey(sellerName);
        if (!key) return [];
        const store = this.loadSellerReviewsStore();
        const list = store[key];
        return Array.isArray(list) ? list : [];
    }

    addSellerReview(sellerName, review) {
        const key = this.normalizeSellerKey(sellerName);
        if (!key) return;
        const store = this.loadSellerReviewsStore();
        const list = Array.isArray(store[key]) ? store[key] : [];
        store[key] = [review, ...list].slice(0, 12);
        this.saveSellerReviewsStore(store);
    }

    getProfileCommentKey(user) {
        if (!user) return '';
        const rawId = user.id ?? user.userId ?? user.profileId;
        if (rawId !== undefined && rawId !== null && String(rawId).trim() !== '') {
            return `id:${String(rawId).trim()}`;
        }
        const name = String(user.name || user.alias || user.username || '').trim().toLowerCase();
        const city = String(user.location?.city || user.city || '').trim().toLowerCase();
        const country = String(user.location?.country || user.country || '').trim().toLowerCase();
        const parts = [name, city, country].filter(Boolean);
        return parts.length ? `name:${parts.join('|')}` : '';
    }

    loadProfileCommentsStore() {
        try {
            const raw = localStorage.getItem(this.profileCommentsStorageKey);
            const parsed = JSON.parse(raw || '{}');
            return parsed && typeof parsed === 'object' ? parsed : {};
        } catch {
            return {};
        }
    }

    saveProfileCommentsStore(store) {
        try {
            localStorage.setItem(this.profileCommentsStorageKey, JSON.stringify(store || {}));
        } catch {}
    }

    getProfileComments(user) {
        const key = this.getProfileCommentKey(user);
        if (!key) return [];
        const store = this.loadProfileCommentsStore();
        const list = store[key];
        return Array.isArray(list) ? list : [];
    }

    addProfileComment(user, comment) {
        const key = this.getProfileCommentKey(user);
        if (!key) return;
        const store = this.loadProfileCommentsStore();
        const list = Array.isArray(store[key]) ? store[key] : [];
        store[key] = [comment, ...list].slice(0, 20);
        this.saveProfileCommentsStore(store);
    }

    formatReviewDate(date) {
        const parsed = new Date(date);
        if (!Number.isFinite(parsed.getTime())) return '';
        const diffMs = Date.now() - parsed.getTime();
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        if (diffMinutes < 60) return 'Just now';
        return this.formatDate(parsed);
    }

    buildDemoSellerReviews(sellerName = 'Seller', seed = 0, baseRating = 4.8) {
        const templates = [
            'Item was exactly as described and the pickup was quick and easy.',
            'Fast replies, honest condition notes, and smooth handoff.',
            'Great communication and careful packaging. Would buy again.',
            'Professional seller with accurate photos and timely updates.',
            'Friendly and reliable. The item matched the listing perfectly.'
        ];
        const reviewers = ['Avery M.', 'Jordan P.', 'Taylor K.', 'Morgan R.', 'Cameron S.'];
        const dates = ['2d ago', '1w ago', '3w ago', '1mo ago', '2mo ago'];
        const safeSeed = Number.isFinite(seed) ? seed : 0;
        const reviews = [];
        for (let i = 0; i < 3; i++) {
            const rating = Math.max(4, Math.min(5, baseRating - i * 0.1));
            reviews.push({
                name: reviewers[(safeSeed + i) % reviewers.length],
                rating,
                date: dates[(safeSeed + i) % dates.length],
                text: templates[(safeSeed + i) % templates.length],
                seller: sellerName
            });
        }
        return reviews;
    }

    buildSellerProfileData(item) {
        if (!item) return null;
        const sellerName = String(item.seller || 'Seller').trim() || 'Seller';
        const sellerKey = this.normalizeSellerKey(sellerName);
        const listings = (this.marketplaceItems || [])
            .filter(entry => String(entry.seller || '').trim().toLowerCase() === sellerKey)
            .slice(0, 4);
        const ratingSeed = parseFloat(item.featuredAd?.details?.rating || '');
        const baseRating = Number.isFinite(ratingSeed)
            ? ratingSeed
            : (4.7 + (Number(item.id) % 3) * 0.1);
        const ratingValue = Math.max(4, Math.min(5, baseRating));
        const reviewCountBase = 18 + (Number(item.id) % 60);
        const responseLabel = Number(item.id) % 2 === 0
            ? 'Responds in under 1 hour'
            : 'Responds within a day';
        const location = [item.city, item.country].filter(Boolean).join(', ');
        const initials = this.getInitials(sellerName) || '';
        const bioOptions = [
            'Carefully packaged listings with quick replies.',
            'Known for smooth pickups and honest descriptions.',
            'Premium seller focused on fast delivery and clear communication.'
        ];
        const bio = bioOptions[Math.abs(Number(item.id) || 0) % bioOptions.length];
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, Number(item.id) || 0, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const verified = Number(item.id) % 2 === 1;

        return {
            name: sellerName,
            initials,
            location,
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel,
            verified,
            bio,
            reviews,
            source: { type: 'marketplace', id: item.id }
        };
    }

    buildSellerProfileDataFromService(service) {
        if (!service) return null;
        const sellerName = String(service.provider || 'Service team').trim() || 'Service team';
        const ratingValue = Number.isFinite(service.rating) ? service.rating : 4.8;
        const reviewCountBase = Number.isFinite(service.reviews) ? service.reviews : 24;
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, Number(service.id) || 1, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const initials = this.getInitials(sellerName) || '';
        const listings = [
            {
                id: service.id || sellerName,
                title: service.title || 'Service',
                price: service.price || '',
                location: service.location || '',
                images: Array.isArray(service.photos) ? service.photos : [],
                source: 'service'
            }
        ];
        const verified = Boolean(service.badge);
        const bio = service.meta || service.desc || 'Trusted service provider with verified bookings.';
        const responseLabel = 'Responds within a few hours';

        return {
            name: sellerName,
            initials,
            location: service.location || '',
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel,
            verified,
            bio,
            reviews,
            source: { type: 'service', id: service.id }
        };
    }

    buildSellerProfileDataFromLuxuryAd(ad) {
        if (!ad) return null;
        const sellerName = String(ad.sellerName || 'Featured seller').trim() || 'Featured seller';
        const ratingValue = Number.isFinite(ad.ratingValue) ? ad.ratingValue : 4.9;
        const reviewCountBase = 40 + (sellerName.length % 30);
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, sellerName.length, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const initials = this.getInitials(sellerName) || '';
        const listings = [
            {
                id: ad.title || sellerName,
                title: ad.title || 'Featured listing',
                price: ad.price || '',
                location: ad.location || '',
                images: Array.isArray(ad.photos) ? ad.photos : [],
                source: 'luxury'
            }
        ];
        const bio = ad.summary || ad.desc || 'Curated premium seller with concierge support.';

        return {
            name: sellerName,
            initials,
            location: ad.location || '',
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel: 'Concierge response',
            verified: true,
            bio,
            reviews,
            source: { type: 'luxury', id: ad.title || sellerName }
        };
    }

    buildSellerProfileDataFromVehicle(item) {
        if (!item) return null;
        const sellerName = String(item.seller || 'Vehicle seller').trim() || 'Vehicle seller';
        const seed = this.computeSeedFromString(item.id || sellerName);
        const baseRating = Number.isFinite(item.rating) ? item.rating : (4.7 + (seed % 3) * 0.1);
        const ratingValue = Math.max(4, Math.min(5, baseRating));
        const reviewCountBase = Number.isFinite(item.reviews) ? item.reviews : 22 + (seed % 40);
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, seed, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const initials = this.getInitials(sellerName) || '';
        const location = [item.city, item.country].filter(Boolean).join(', ');
        const listings = [
            {
                id: item.id || sellerName,
                title: item.title || 'Vehicle listing',
                price: item.price || '',
                location,
                images: Array.isArray(item.images) ? item.images : [item.image].filter(Boolean),
                source: 'vehicle'
            }
        ];
        const bio = item.description || 'Verified vehicle seller with detailed inspections.';
        const responseLabel = 'Responds within a day';
        const verified = seed % 2 === 1;

        return {
            name: sellerName,
            initials,
            location,
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel,
            verified,
            bio,
            reviews,
            source: { type: 'vehicle', id: item.id }
        };
    }

    buildSellerProfileDataFromRealestate(listing) {
        if (!listing) return null;
        const sellerName = String(listing.seller || 'Property host').trim() || 'Property host';
        const seed = this.computeSeedFromString(listing.id || sellerName);
        const baseRating = Number.isFinite(listing.rating) ? listing.rating : (4.8 + (seed % 2) * 0.1);
        const ratingValue = Math.max(4, Math.min(5, baseRating));
        const reviewCountBase = Number.isFinite(listing.reviews) ? listing.reviews : 30 + (seed % 50);
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, seed, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const initials = this.getInitials(sellerName) || '';
        const location = listing.location || [listing.city, listing.country].filter(Boolean).join(', ');
        const listings = [
            {
                id: listing.id || sellerName,
                title: listing.title || 'Property listing',
                price: listing.price || '',
                location,
                images: Array.isArray(listing.images) ? listing.images : [],
                source: 'realestate'
            }
        ];
        const bio = listing.description || listing.meta || 'Verified host with premium property listings.';
        const responseLabel = 'Responds within 2 hours';
        const verified = Boolean(listing.badge);

        return {
            name: sellerName,
            initials,
            location,
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel,
            verified,
            bio,
            reviews,
            source: { type: 'realestate', id: listing.id }
        };
    }

    buildSellerProfileDataFromDiscoveryPost(post) {
        if (!post) return null;
        const seller = post.seller || post.user || {};
        const sellerName = String(seller.name || 'Seller').trim() || 'Seller';
        const photo = String(seller.avatar || seller.photo || '').trim();
        const seed = this.computeSeedFromString(post.id || sellerName);
        const baseRating = 4.7 + (seed % 3) * 0.1;
        const ratingValue = Math.max(4, Math.min(5, baseRating));
        const reviewCountBase = 18 + (seed % 30);
        const storedReviews = this.getSellerReviews(sellerName);
        const demoReviews = this.buildDemoSellerReviews(sellerName, seed, ratingValue);
        const reviews = [...storedReviews, ...demoReviews];
        const ratingValues = reviews.map(entry => entry.rating).filter((value) => Number.isFinite(value));
        const averageRating = ratingValues.length
            ? ratingValues.reduce((sum, value) => sum + value, 0) / ratingValues.length
            : ratingValue;
        const ratingLabel = this.formatStarRating(averageRating);
        const initials = this.getInitials(sellerName) || '';
        const location = this.buildListingLocationLabel(seller.location, post.location);
        const listing = post.listing || {};
        const priceValue = listing.priceText
            || (Number.isFinite(listing.price?.amount) ? listing.price.amount : (listing.price || ''));
        const images = listing.mediaUrl ? [listing.mediaUrl] : (listing.image ? [listing.image] : []);
        const listings = [
            {
                id: post.id || listing.title || sellerName,
                title: listing.title || 'Listing',
                price: priceValue,
                location,
                images,
                source: 'discovery'
            }
        ];
        const trust = String(seller.trust || '').toLowerCase();
        const verified = trust.includes('verified') || trust.includes('superhost') || trust.includes('top rated') || seed % 2 === 0;
        const bio = seller.trust || listing.summary || post.content || 'Trusted seller in the community.';
        const responseLabel = seller.online ? 'Responds quickly' : 'Responds within a day';

        return {
            name: sellerName,
            initials,
            photo,
            location,
            listings,
            ratingValue: averageRating,
            ratingLabel,
            reviewCount: reviewCountBase + storedReviews.length,
            responseLabel,
            verified,
            bio,
            reviews,
            source: { type: 'discovery', id: post.id }
        };
    }

    getLuxuryAdDataFromCard(card) {
        if (!card) return null;
        const dataset = card.dataset || {};
        const text = (selector) => card.querySelector(selector)?.textContent?.trim() || '';
        const title = dataset.adTitle || text('.featured-ad-body h4') || 'Featured listing';
        const price = dataset.adPrice || text('.featured-ad-body p') || '';
        const summary = dataset.adSummary || text('.featured-ad-body span') || '';
        const category = dataset.adCategory || '';
        const location = dataset.adLocation || '';
        const condition = dataset.adCondition || '';
        const delivery = dataset.adDelivery || '';
        const seller = dataset.adSeller || '';
        const rating = dataset.adRating || '';
        const ratingValue = parseFloat(rating);
        const ratingLabel = this.formatStarRating(rating);
        const stock = dataset.adStock || '';
        const tier = dataset.adTier || 'Sponsored Showcase';
        const windowLabel = dataset.adWindow || '7 days';
        const reason = dataset.adReason
            || `Paid placement to secure a ${tier} slot on the homepage and reach premium buyers for ${windowLabel}.`;
        const perksRaw = dataset.adPerks || 'Priority placement|Concierge review|Global reach';
        const perks = this.parseServiceCardList(perksRaw);
        const tags = this.parseServiceCardList(dataset.adTags || '');

        const details = [
            { label: 'Category', value: category },
            { label: 'Location', value: location },
            { label: 'Condition', value: condition },
            { label: 'Delivery', value: delivery },
            { label: 'Seller', value: seller },
            { label: 'Rating', value: ratingLabel },
            { label: 'Availability', value: stock }
        ].filter((entry) => entry.value);
        const customDetails = this.parseServiceCardList(dataset.adDetails || '')
            .map((item) => {
                const idx = item.indexOf(':');
                if (idx <= 0) return null;
                const label = item.slice(0, idx).trim();
                const value = item.slice(idx + 1).trim();
                if (!label || !value) return null;
                return { label, value };
            })
            .filter(Boolean);

        const photos = Array.from(card.querySelectorAll('.carousel-track img'))
            .map(img => img.src)
            .filter(Boolean);
        if (!photos.length) {
            const fallback = card.querySelector('img')?.src;
            if (fallback) photos.push(fallback);
        }

        const desc = dataset.adDesc || 'Curated placement with premium exposure and priority buyer reach.';

        return {
            title,
            price,
            summary,
            tier,
            reason,
            perks,
            photos,
            desc,
            details: customDetails.length ? customDetails : details,
            tags,
            sellerName: seller,
            location,
            ratingValue: Number.isFinite(ratingValue) ? ratingValue : null
        };
    }

    renderLuxuryAdThumbs(container) {
        if (!container) return;
        const photos = Array.isArray(this.luxuryAdPhotos) ? this.luxuryAdPhotos : [];
        if (!photos.length) {
            container.innerHTML = '';
            container.classList.add('hidden');
            return;
        }
        container.classList.remove('hidden');
        container.innerHTML = photos.map((src, index) => `
            <button class="luxury-ad-thumb${index === this.luxuryAdIndex ? ' active' : ''}" type="button" data-luxury-index="${index}" aria-label="View photo ${index + 1}">
                <img src="${this.escapeHtml(src)}" alt="Ad photo ${index + 1}" loading="lazy">
            </button>
        `).join('');

        container.querySelectorAll('.luxury-ad-thumb').forEach((btn) => {
            if (btn.dataset.bound) return;
            btn.addEventListener('click', () => {
                const next = parseInt(btn.dataset.luxuryIndex || '', 10);
                if (Number.isFinite(next)) this.setLuxuryAdIndex(next);
            });
            btn.dataset.bound = '1';
        });
    }

    setLuxuryAdIndex(index) {
        const photos = Array.isArray(this.luxuryAdPhotos) ? this.luxuryAdPhotos : [];
        if (!photos.length) return;
        const next = Math.min(Math.max(index, 0), photos.length - 1);
        this.luxuryAdIndex = next;
        const imageEl = document.getElementById('luxury-ad-image');
        if (imageEl) imageEl.src = photos[next];
        const thumbs = document.getElementById('luxury-ad-thumbs');
        if (thumbs) {
            thumbs.querySelectorAll('.luxury-ad-thumb').forEach((btn) => {
                const idx = parseInt(btn.dataset.luxuryIndex || '', 10);
                btn.classList.toggle('active', idx === next);
            });
        }
    }

    getServiceModalDataFromCard(card) {
        if (!card) return null;
        const dataset = card.dataset || {};
        const text = (selector) => card.querySelector(selector)?.textContent?.trim() || '';
        const title = dataset.serviceTitle || text('.featured-ad-body h4') || 'Service';
        const price = dataset.servicePrice || text('.featured-ad-body p') || '';
        const priceNote = dataset.servicePriceNote || '';
        const location = dataset.serviceLocation || '';
        const phone = dataset.servicePhone || '';
        const ratingValue = parseFloat(dataset.serviceRating);
        const reviewsValue = parseInt(dataset.serviceReviews, 10);
        const provider = dataset.serviceProvider || 'Service team';
        const role = dataset.serviceRole || 'Service professional';
        const avatar = dataset.serviceAvatar || card.querySelector('img')?.src || '';
        const badge = dataset.serviceBadge || '';
        const desc = dataset.serviceDesc || text('.featured-ad-body span') || '';
        const meta = dataset.serviceMeta || '';
        const highlights = this.parseServiceCardList(dataset.serviceHighlights);
        const availability = this.parseServiceCardList(dataset.serviceAvailability);
        const tags = this.parseServiceCardList(dataset.serviceTags);
        const headlineTag = card.querySelector('.featured-ad-tag')?.textContent?.trim();
        if (headlineTag) tags.unshift(headlineTag);
        const uniqueTags = Array.from(new Set(tags)).filter(Boolean);

        let photos = this.parseServiceCardList(dataset.servicePhotos);
        if (!photos.length) {
            photos = Array.from(card.querySelectorAll('.carousel-track img'))
                .map(img => img.src)
                .filter(Boolean);
        }

        return {
            id: dataset.serviceId || title,
            title,
            price,
            priceNote,
            location,
            phone,
            rating: Number.isFinite(ratingValue) ? ratingValue : null,
            reviews: Number.isFinite(reviewsValue) ? reviewsValue : null,
            provider,
            role,
            avatar,
            badge,
            desc,
            meta,
            highlights,
            availability,
            tags: uniqueTags,
            photos
        };
    }

    openServiceModalFromCard(card) {
        const data = this.getServiceModalDataFromCard(card);
        if (!data) return;
        this.openServiceModal(data);
    }

    openServiceModal(data = {}) {
        const modal = document.getElementById('service-modal');
        if (!modal) return;
        const imageEl = document.getElementById('service-modal-image');
        const titleEl = document.getElementById('service-modal-title');
        const locationEl = document.getElementById('service-modal-location');
        const phoneEl = document.getElementById('service-modal-phone');
        const feeEl = document.getElementById('service-modal-fee');
        const priceNoteEl = document.getElementById('service-modal-price-note');
        const descEl = document.getElementById('service-modal-desc');
        const metaEl = document.getElementById('service-modal-meta');
        const ratingSlot = document.getElementById('service-modal-rating-slot');
        const tagsEl = document.getElementById('service-modal-tags');
        const providerNameEl = document.getElementById('service-modal-provider-name');
        const providerRoleEl = document.getElementById('service-modal-provider-role');
        const providerAvatarEl = document.getElementById('service-modal-provider-avatar');
        const providerBadgeEl = document.getElementById('service-modal-provider-badge');
        const highlightsWrap = document.getElementById('service-modal-highlights-wrap');
        const highlightsEl = document.getElementById('service-modal-highlights');
        const availabilityWrap = document.getElementById('service-modal-availability-wrap');
        const availabilityEl = document.getElementById('service-modal-availability');
        const mapEl = document.getElementById('service-modal-map');
        const callBtn = document.getElementById('service-modal-call');
        const thumbsEl = document.getElementById('service-modal-thumbs');

        this.serviceModalPhotos = Array.isArray(data.photos) ? data.photos.filter(Boolean) : [];
        this.serviceModalIndex = 0;
        this.activeServiceId = data.id || null;
        this.activeServiceProfile = data;

        if (imageEl) imageEl.src = this.serviceModalPhotos[0] || '';
        if (thumbsEl) this.renderServiceModalThumbs(thumbsEl);
        this.updateServiceModalNavButtons();

        if (titleEl) titleEl.textContent = data.title || 'Service';
        if (locationEl) {
            locationEl.textContent = data.location ? `Location: ${data.location}` : '';
            locationEl.classList.toggle('hidden', !data.location);
        }
        if (phoneEl) {
            phoneEl.textContent = data.phone ? `Phone: ${data.phone}` : '';
            phoneEl.classList.toggle('hidden', !data.phone);
        }
        if (feeEl) feeEl.textContent = data.price || '';
        if (priceNoteEl) {
            priceNoteEl.textContent = data.priceNote || '';
            priceNoteEl.classList.toggle('hidden', !data.priceNote);
        }
        if (descEl) {
            descEl.textContent = data.desc || '';
            descEl.classList.toggle('hidden', !data.desc);
        }
        if (metaEl) {
            metaEl.textContent = data.meta || '';
            metaEl.classList.toggle('hidden', !data.meta);
        }
        if (providerNameEl) providerNameEl.textContent = data.provider || 'Service team';
        if (providerRoleEl) providerRoleEl.textContent = data.role || 'Service professional';
        if (providerAvatarEl) {
            if (data.avatar) {
                providerAvatarEl.src = data.avatar;
                providerAvatarEl.classList.remove('hidden');
                providerAvatarEl.alt = data.provider || 'Service provider';
            } else {
                providerAvatarEl.src = '';
                providerAvatarEl.classList.add('hidden');
            }
        }
        if (providerBadgeEl) {
            providerBadgeEl.textContent = data.badge || '';
            providerBadgeEl.classList.toggle('hidden', !data.badge);
        }

        if (tagsEl) {
            if (data.tags && data.tags.length) {
                tagsEl.innerHTML = data.tags
                    .map(tag => `<span class="service-modal-tag">${this.escapeHtml(tag)}</span>`)
                    .join('');
                tagsEl.classList.remove('hidden');
            } else {
                tagsEl.innerHTML = '';
                tagsEl.classList.add('hidden');
            }
        }

        if (highlightsWrap && highlightsEl) {
            if (data.highlights && data.highlights.length) {
                highlightsEl.innerHTML = data.highlights
                    .map(item => `<li><i class="fas fa-check" aria-hidden="true"></i><span>${this.escapeHtml(item)}</span></li>`)
                    .join('');
                highlightsWrap.classList.remove('hidden');
            } else {
                highlightsEl.innerHTML = '';
                highlightsWrap.classList.add('hidden');
            }
        }

        if (availabilityWrap && availabilityEl) {
            if (data.availability && data.availability.length) {
                availabilityEl.innerHTML = data.availability
                    .map(item => `<span>${this.escapeHtml(item)}</span>`)
                    .join('');
                availabilityWrap.classList.remove('hidden');
            } else {
                availabilityEl.innerHTML = '';
                availabilityWrap.classList.add('hidden');
            }
        }

        if (ratingSlot) {
            if (Number.isFinite(data.rating)) {
                const rating = data.rating;
                const reviewsLabel = Number.isFinite(data.reviews) ? `${data.reviews} reviews` : 'New';
                const ratingLine = this.formatStarRating(rating);
                ratingSlot.innerHTML = `
                    <span class="service-rating-stars">${this.escapeHtml(ratingLine)}</span>
                    <span class="service-rating-count">(${this.escapeHtml(reviewsLabel)})</span>
                `;
                ratingSlot.classList.remove('hidden');
            } else {
                ratingSlot.innerHTML = '';
                ratingSlot.classList.add('hidden');
            }
        }

        if (callBtn) {
            const rawPhone = String(data.phone || '').trim();
            const tel = rawPhone.replace(/[^\d+]/g, '');
            if (tel) {
                callBtn.href = `tel:${tel}`;
                callBtn.classList.remove('hidden');
            } else {
                callBtn.href = '#';
                callBtn.classList.add('hidden');
            }
        }

        if (mapEl) {
            const label = data.location ? `Service area: ${data.location}` : 'Remote service';
            mapEl.innerHTML = `<span><i class="fas fa-map-marker-alt" aria-hidden="true"></i>${this.escapeHtml(label)}</span>`;
        }

        modal.classList.remove('hidden');
    }

    openLuxuryAdModalFromCard(card) {
        const data = this.getLuxuryAdDataFromCard(card);
        if (!data) return;
        this.openLuxuryAdModal(data);
    }

    openLuxuryAdModal(data = {}) {
        const modal = document.getElementById('luxury-ad-modal');
        if (!modal) return;
        const imageEl = document.getElementById('luxury-ad-image');
        const titleEl = document.getElementById('luxury-ad-title');
        const priceEl = document.getElementById('luxury-ad-price');
        const metaEl = document.getElementById('luxury-ad-meta');
        const summaryEl = document.getElementById('luxury-ad-summary');
        const detailsEl = document.getElementById('luxury-ad-details');
        const tagsEl = document.getElementById('luxury-ad-tags');
        const tierEl = document.getElementById('luxury-ad-tier');
        const perksEl = document.getElementById('luxury-ad-perks');
        const thumbsEl = document.getElementById('luxury-ad-thumbs');

        this.activeLuxuryAd = data;
        this.lastLuxuryAd = data;
        this.luxuryAdPhotos = Array.isArray(data.photos) ? data.photos.filter(Boolean) : [];
        this.luxuryAdIndex = 0;

        if (imageEl) {
            imageEl.src = this.luxuryAdPhotos[0] || 'https://via.placeholder.com/900x650/0b1020/f8fafc?text=Featured';
            imageEl.alt = data.title || 'Featured listing';
        }
        if (thumbsEl) this.renderLuxuryAdThumbs(thumbsEl);

        if (titleEl) titleEl.textContent = data.title || 'Featured listing';
        if (priceEl) {
            priceEl.textContent = data.price || '';
            priceEl.classList.toggle('hidden', !data.price);
        }
        if (metaEl) {
            metaEl.textContent = data.summary || '';
            metaEl.classList.toggle('hidden', !data.summary);
        }
        if (summaryEl) {
            summaryEl.textContent = data.desc || '';
            summaryEl.classList.toggle('hidden', !data.desc);
        }
        if (detailsEl) {
            const details = Array.isArray(data.details) ? data.details : [];
            detailsEl.innerHTML = details.length
                ? details.map((detail) => {
                    const label = this.escapeHtml(detail.label);
                    const value = this.escapeHtml(detail.value);
                    const isSeller = String(detail.label || '').toLowerCase() === 'seller';
                    const valueHtml = isSeller
                        ? `<button class="seller-name-link" type="button" data-seller-source="luxury">${value}</button>`
                        : value;
                    return `
                        <div class="luxury-ad-detail">
                            <span>${label}</span>
                            <strong>${valueHtml}</strong>
                        </div>
                    `;
                }).join('')
                : '';
            detailsEl.classList.toggle('hidden', !details.length);
        }
        if (tagsEl) {
            const tags = Array.isArray(data.tags) ? data.tags : [];
            tagsEl.innerHTML = tags.length
                ? tags.map((tag) => `<span class="luxury-ad-tag">${this.escapeHtml(tag)}</span>`).join('')
                : '';
            tagsEl.classList.toggle('hidden', !tags.length);
        }
        if (tierEl) {
            tierEl.textContent = data.tier || 'Sponsored Showcase';
        }
        if (perksEl) {
            const perks = Array.isArray(data.perks) ? data.perks : [];
            perksEl.innerHTML = perks.length
                ? perks.map((perk) => `
                    <div class="luxury-ad-perk">
                        <i class="fas fa-crown" aria-hidden="true"></i>
                        <span>${this.escapeHtml(perk)}</span>
                    </div>
                `).join('')
                : '';
            perksEl.classList.toggle('hidden', !perks.length);
        }

        modal.classList.remove('hidden');
    }

    closeLuxuryAdModal() {
        const modal = document.getElementById('luxury-ad-modal');
        if (modal) modal.classList.add('hidden');
        this.activeLuxuryAd = null;
        this.luxuryAdPhotos = [];
        this.luxuryAdIndex = 0;
    }

    renderServiceModalThumbs(container) {
        if (!container) return;
        const photos = Array.isArray(this.serviceModalPhotos) ? this.serviceModalPhotos : [];
        if (photos.length <= 1) {
            container.innerHTML = '';
            container.classList.add('hidden');
            return;
        }
        const idx = Math.min(Math.max(this.serviceModalIndex || 0, 0), photos.length - 1);
        container.classList.remove('hidden');
        container.innerHTML = photos.map((src, i) => {
            const active = i === idx;
            const safeSrc = this.escapeHtml(String(src || ''));
            return `<button class="service-modal-thumb${active ? ' active' : ''}" type="button" data-service-thumb="${i}" aria-label="Open service photo ${i + 1}"><img src="${safeSrc}" alt="Service photo ${i + 1}" loading="lazy"></button>`;
        }).join('');

        if (!container.dataset.bound) {
            container.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-service-thumb]');
                if (!btn) return;
                const i = parseInt(btn.dataset.serviceThumb, 10);
                if (!Number.isFinite(i)) return;
                this.setServiceModalIndex(i);
            });
            container.dataset.bound = '1';
        }

        const active = container.querySelector('.service-modal-thumb.active');
        active?.scrollIntoView?.({ block: 'nearest', inline: 'center' });
    }

    setServiceModalIndex(index) {
        const photos = Array.isArray(this.serviceModalPhotos) ? this.serviceModalPhotos : [];
        if (!photos.length) return;
        const idx = Math.min(Math.max(index || 0, 0), photos.length - 1);
        this.serviceModalIndex = idx;
        const imgEl = document.getElementById('service-modal-image');
        if (imgEl) imgEl.src = photos[idx] || '';
        const thumbsEl = document.getElementById('service-modal-thumbs');
        if (thumbsEl) this.renderServiceModalThumbs(thumbsEl);
        this.updateServiceModalNavButtons();
    }

    updateServiceModalNavButtons() {
        const prevBtn = document.getElementById('service-media-prev');
        const nextBtn = document.getElementById('service-media-next');
        const photos = Array.isArray(this.serviceModalPhotos) ? this.serviceModalPhotos : [];
        const multiple = photos.length > 1;

        if (prevBtn) {
            prevBtn.classList.toggle('hidden', !multiple);
            prevBtn.disabled = !multiple || this.serviceModalIndex <= 0;
            prevBtn.setAttribute('aria-hidden', (!multiple).toString());
        }
        if (nextBtn) {
            nextBtn.classList.toggle('hidden', !multiple);
            nextBtn.disabled = !multiple || this.serviceModalIndex >= photos.length - 1;
            nextBtn.setAttribute('aria-hidden', (!multiple).toString());
        }
    }

    stepServiceModal(delta) {
        const photos = Array.isArray(this.serviceModalPhotos) ? this.serviceModalPhotos : [];
        if (!Number.isInteger(delta) || photos.length < 2) return;
        const nextIndex = this.serviceModalIndex + delta;
        if (nextIndex < 0 || nextIndex >= photos.length) return;
        this.setServiceModalIndex(nextIndex);
    }

    closeServiceModal() {
        const modal = document.getElementById('service-modal');
        if (modal) modal.classList.add('hidden');
    }

    bindLuxuryAdModal() {
        const modal = document.getElementById('luxury-ad-modal');
        if (!modal || modal.dataset.bound) return;
        const closeBtn = document.getElementById('luxury-ad-close');
        const viewBtn = document.getElementById('luxury-ad-view');
        const sellerBtn = document.getElementById('luxury-ad-seller');
        const shareBtn = document.getElementById('luxury-ad-share');
        const detailsEl = document.getElementById('luxury-ad-details');

        const doClose = () => this.closeLuxuryAdModal();
        if (closeBtn) closeBtn.addEventListener('click', doClose);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) doClose();
        });
        document.addEventListener('keydown', (e) => {
            if (modal.classList.contains('hidden')) return;
            if (e.key === 'Escape') doClose();
        });

        if (viewBtn && !viewBtn.dataset.bound) {
            viewBtn.addEventListener('click', () => {
                const title = this.activeLuxuryAd?.title || 'Featured listing';
                if (!this.luxuryAdPhotos.length) return;
                this.openMediaLightbox(this.luxuryAdPhotos, title, this.luxuryAdIndex || 0);
            });
            viewBtn.dataset.bound = '1';
        }

        if (sellerBtn && !sellerBtn.dataset.bound) {
            sellerBtn.addEventListener('click', () => {
                this.openSellerProfileFromLuxuryAd();
            });
            sellerBtn.dataset.bound = '1';
        }

        if (shareBtn && !shareBtn.dataset.bound) {
            shareBtn.addEventListener('click', async () => {
                const title = this.activeLuxuryAd?.title || 'Featured listing';
                const url = `${window.location.pathname}${window.location.search}#home`;
                if (navigator.share) {
                    try {
                        await navigator.share({ title, url });
                        return;
                    } catch {}
                }
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(`${title} - ${url}`);
                        this.showNotification('Link copied to clipboard.');
                        return;
                    } catch {}
                }
                this.showNotification('Share not supported.');
            });
            shareBtn.dataset.bound = '1';
        }

        if (detailsEl && !detailsEl.dataset.boundSeller) {
            detailsEl.addEventListener('click', (event) => {
                const sellerLink = event.target.closest('.seller-name-link');
                if (!sellerLink) return;
                event.stopPropagation();
                this.openSellerProfileFromLuxuryAd();
            });
            detailsEl.dataset.boundSeller = '1';
        }

        modal.dataset.bound = '1';
    }

    bindServiceModal() {
        const modal = document.getElementById('service-modal');
        if (!modal || modal.dataset.bound) return;
        const closeBtn = document.getElementById('service-modal-close');
        const prevBtn = document.getElementById('service-media-prev');
        const nextBtn = document.getElementById('service-media-next');
        const shareBtn = document.getElementById('service-modal-share');
        const sellerBtn = document.getElementById('service-modal-seller');
        const providerNameBtn = document.getElementById('service-modal-provider-name');
        const requestBtn = document.getElementById('service-modal-request');

        const doClose = () => this.closeServiceModal();
        if (closeBtn) closeBtn.addEventListener('click', doClose);
        if (prevBtn) {
            prevBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.stepServiceModal(-1);
            });
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.stepServiceModal(1);
            });
        }
        modal.addEventListener('click', (e) => {
            if (e.target === modal) doClose();
        });
        document.addEventListener('keydown', (e) => {
            if (modal.classList.contains('hidden')) return;
            if (e.key === 'Escape') doClose();
        });

        if (shareBtn && !shareBtn.dataset.bound) {
            shareBtn.addEventListener('click', async () => {
                const title = document.getElementById('service-modal-title')?.textContent?.trim() || 'Service';
                const url = `${window.location.pathname}${window.location.search}#services`;
                if (navigator.share) {
                    try {
                        await navigator.share({ title, url });
                        return;
                    } catch {}
                }
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(`${title} - ${url}`);
                        this.showNotification('Link copied to clipboard.');
                        return;
                    } catch {}
                }
                this.showNotification('Share not supported.');
            });
            shareBtn.dataset.bound = '1';
        }

        if (sellerBtn && !sellerBtn.dataset.bound) {
            sellerBtn.addEventListener('click', () => {
                this.openSellerProfileFromService();
            });
            sellerBtn.dataset.bound = '1';
        }

        if (providerNameBtn && !providerNameBtn.dataset.bound) {
            providerNameBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                this.openSellerProfileFromService();
            });
            providerNameBtn.dataset.bound = '1';
        }

        if (requestBtn && !requestBtn.dataset.bound) {
            requestBtn.addEventListener('click', () => {
                this.closeServiceModal();
                const quoteModal = document.getElementById('quote-modal');
                if (quoteModal) quoteModal.classList.remove('hidden');
            });
            requestBtn.dataset.bound = '1';
        }

        modal.dataset.bound = '1';
    }

    renderVehiclesPagination(totalPages) {
        const bar = document.getElementById('vehicles-pagination');
        if (!bar) return;
        const page = this.vehicleFilters.page || 1;
        const pages = totalPages || 1;
        if (pages <= 1) {
            bar.innerHTML = '';
            return;
        }
        const btn = (p, label, disabled = false, active = false) =>
            `<button class="page-btn${active ? ' active' : ''}" type="button" data-page="${p}" ${disabled ? 'disabled' : ''}>${label}</button>`;
        const parts = [];
        parts.push(btn(page - 1, 'Prev', page <= 1));
        const start = Math.max(1, page - 2);
        const end = Math.min(pages, page + 2);
        if (start > 1) parts.push(btn(1, '1'));
        if (start > 2) parts.push(`<span class="page-ellipsis"></span>`);
        for (let p = start; p <= end; p++) parts.push(btn(p, String(p), false, p === page));
        if (end < pages - 1) parts.push(`<span class="page-ellipsis"></span>`);
        if (end < pages) parts.push(btn(pages, String(pages)));
        parts.push(btn(page + 1, 'Next', page >= pages));
        bar.innerHTML = parts.join('');

        if (bar.dataset.bound) return;
        bar.addEventListener('click', (e) => {
            const b = e.target.closest('.page-btn');
            if (!b) return;
            const p = parseInt(b.dataset.page, 10);
            if (!p || Number.isNaN(p)) return;
            this.vehicleFilters.page = p;
            this.persistVehicleState();
            this.updateVehiclesUrl();
            const activeCategory = document.querySelector('.vehicles-chip.active')?.dataset.category || 'all';
            this.renderVehiclesFeed(activeCategory);
        });
        bar.dataset.bound = '1';
    }

    loadVehicleState() {
        try {
            const fav = JSON.parse(localStorage.getItem('vehicleFavorites') || '[]');
            this.vehicleFavorites = new Set(Array.isArray(fav) ? fav : []);
        } catch {
            this.vehicleFavorites = new Set();
        }
        try {
            const saved = JSON.parse(localStorage.getItem('vehicleSavedSearches') || '[]');
            this.vehicleSavedSearches = Array.isArray(saved) ? saved : [];
        } catch {
            this.vehicleSavedSearches = [];
        }
        try {
            const stored = JSON.parse(localStorage.getItem('vehicleFilters') || '{}');
            if (stored && typeof stored === 'object') {
                this.vehicleFilters = { ...this.vehicleFilters, ...stored };
            }
        } catch {
            // ignore
        }
    }

    persistVehicleState() {
        try {
            localStorage.setItem('vehicleFavorites', JSON.stringify(Array.from(this.vehicleFavorites)));
            localStorage.setItem('vehicleSavedSearches', JSON.stringify(this.vehicleSavedSearches));
            localStorage.setItem('vehicleFilters', JSON.stringify(this.vehicleFilters));
        } catch {
            // ignore
        }
    }

    toggleVehicleFavorite(id) {
        if (!id) return;
        if (this.vehicleFavorites.has(id)) this.vehicleFavorites.delete(id);
        else this.vehicleFavorites.add(id);
        this.persistVehicleState();
    }

    syncVehicleFavoritesButton(btn) {
        if (!btn) return;
        btn.classList.toggle('active', !!this.vehicleFilters.favoritesOnly);
        const count = this.vehicleFavorites.size;
        btn.textContent = count ? `Favorites (${count})` : 'Favorites';
    }

    populateVehicleMakeModel(makeSelect, modelSelect) {
        if (!makeSelect || makeSelect.dataset.boundOptions) return;
        const map = this.vehicleListings.reduce((acc, v) => {
            const make = v.make || '';
            const model = v.model || '';
            if (!make) return acc;
            if (!acc[make]) acc[make] = new Set();
            if (model) acc[make].add(model);
            return acc;
        }, {});
        const makes = Object.keys(map).sort((a, b) => a.localeCompare(b));
        makeSelect.innerHTML = ['<option value="">Any make</option>']
            .concat(makes.map(m => `<option value="${this.escapeHtml(m)}">${this.escapeHtml(m)}</option>`))
            .join('');
        makeSelect.dataset.boundOptions = '1';

        const updateModels = () => {
            if (!modelSelect) return;
            const make = makeSelect.value || '';
            const models = make && map[make] ? Array.from(map[make]).sort((a, b) => a.localeCompare(b)) : [];
            modelSelect.innerHTML = ['<option value="">Any model</option>']
                .concat(models.map(m => `<option value="${this.escapeHtml(m)}">${this.escapeHtml(m)}</option>`))
                .join('');
            modelSelect.disabled = !make;
            if (!make) modelSelect.value = '';
        };
        makeSelect.addEventListener('change', () => {
            updateModels();
        });
        updateModels();
    }

    saveVehicleSearch() {
        const name = (window.prompt('Name this search (e.g., Dubai rentals under $1k)', '') || '').trim();
        if (!name) return;
        const id = `vs_${Date.now()}`;
        const payload = {
            id,
            name,
            createdAt: new Date().toISOString(),
            filters: { ...this.vehicleFilters }
        };
        this.vehicleSavedSearches = [payload].concat(this.vehicleSavedSearches).slice(0, 20);
        this.persistVehicleState();
    }

    renderVehicleSavedSearches(selectEl) {
        if (!selectEl) return;
        const opts = ['<option value="">None</option>'].concat(
            (this.vehicleSavedSearches || []).map(s => `<option value="${this.escapeHtml(s.id)}">${this.escapeHtml(s.name)}</option>`)
        );
        selectEl.innerHTML = opts.join('');
    }

    applyVehicleSavedSearch(id, els) {
        const found = (this.vehicleSavedSearches || []).find(s => s.id === id);
        if (!found) return;
        const f = found.filters || {};
        if (els.searchInput) els.searchInput.value = f.search || '';
        if (els.makeSelect) els.makeSelect.value = f.make || '';
        if (els.modelSelect) {
            // models repopulate on make change
            els.makeSelect?.dispatchEvent(new Event('change'));
            els.modelSelect.value = f.model || '';
        }
        if (els.conditionSelect) els.conditionSelect.value = f.condition || '';
        if (els.countryInput) els.countryInput.value = f.country || '';
        if (els.cityInput) els.cityInput.value = f.city || '';
        if (els.sellerInput) els.sellerInput.value = f.seller || '';
        if (els.yearMinInput) els.yearMinInput.value = f.yearMin ?? '';
        if (els.yearMaxInput) els.yearMaxInput.value = f.yearMax ?? '';
        if (els.mileageMinInput) els.mileageMinInput.value = f.mileageMin ?? '';
        if (els.mileageMaxInput) els.mileageMaxInput.value = f.mileageMax ?? '';
        if (els.postedSelect) els.postedSelect.value = f.posted || 'any';
        if (els.priceTermSelect) els.priceTermSelect.value = f.priceTerm || 'any';
        if (els.minInput) els.minInput.value = f.min ?? '';
        if (els.maxInput) els.maxInput.value = f.max ?? '';
        if (els.sortSelect) els.sortSelect.value = f.sort || 'newest';
        this.vehicleFilters = { ...this.vehicleFilters, ...f, page: 1 };
        this.persistVehicleState();
        this.updateVehiclesUrl();
    }

	    updateVehiclesUrl() {
	        try {
	            const url = new URL(window.location.href);
            const params = url.searchParams;
            const f = this.vehicleFilters;
            const set = (k, v) => {
                if (v === null || v === undefined || v === '' || v === false) params.delete(k);
                else params.set(k, String(v));
            };
            set('v_search', f.search);
            set('v_make', f.make);
            set('v_model', f.model);
            set('v_cond', f.condition);
            set('v_country', f.country);
            set('v_city', f.city);
            set('v_seller', f.seller);
            set('v_posted', f.posted);
            set('v_term', f.priceTerm);
            set('v_year_min', f.yearMin);
            set('v_year_max', f.yearMax);
            set('v_mi_min', f.mileageMin);
            set('v_mi_max', f.mileageMax);
            set('v_min', f.min);
            set('v_max', f.max);
            set('v_sort', f.sort);
            set('v_favs', f.favoritesOnly ? 1 : '');
            set('v_page', f.page);
	            const existing = window.history.state;
	            const state = (existing && typeof existing === 'object')
	                ? existing
	                : { app: '6ixo', route: this.getCurrentRoute(), appHistoryIndex: this.browserHistoryIndex || 0 };
	            history.replaceState(state, '', url.toString());
	        } catch {
	            // ignore
	        }
	    }

    applyVehiclesStateFromUrl(els) {
        try {
            const url = new URL(window.location.href);
            const p = url.searchParams;
            const keys = [
                'v_search', 'v_make', 'v_model', 'v_cond', 'v_country', 'v_city', 'v_seller',
                'v_posted', 'v_term', 'v_year_min', 'v_year_max', 'v_mi_min', 'v_mi_max',
                'v_min', 'v_max', 'v_sort', 'v_favs', 'v_page'
            ];
            const hasAny = keys.some(k => p.has(k));
            if (!hasAny) return false;
            const read = (k) => p.get(k) || '';
            const num = (k) => {
                const v = read(k);
                if (!v) return null;
                const n = parseFloat(v);
                return Number.isNaN(n) ? null : n;
            };
            const int = (k) => {
                const v = read(k);
                if (!v) return null;
                const n = parseInt(v, 10);
                return Number.isNaN(n) ? null : n;
            };

            const next = {
                search: read('v_search').toLowerCase(),
                make: read('v_make'),
                model: read('v_model'),
                condition: read('v_cond'),
                country: read('v_country').toLowerCase(),
                city: read('v_city').toLowerCase(),
                seller: read('v_seller').toLowerCase(),
                posted: read('v_posted') || 'any',
                priceTerm: read('v_term') || 'any',
                yearMin: int('v_year_min'),
                yearMax: int('v_year_max'),
                mileageMin: int('v_mi_min'),
                mileageMax: int('v_mi_max'),
                min: num('v_min'),
                max: num('v_max'),
                sort: read('v_sort') || 'newest',
                favoritesOnly: read('v_favs') === '1',
                page: int('v_page') || 1
            };

            if (els.searchInput) els.searchInput.value = next.search || '';
            if (els.makeSelect) els.makeSelect.value = next.make || '';
            if (els.makeSelect) els.makeSelect.dispatchEvent(new Event('change'));
            if (els.modelSelect) els.modelSelect.value = next.model || '';
            if (els.conditionSelect) els.conditionSelect.value = next.condition || '';
            if (els.countryInput) els.countryInput.value = next.country || '';
            if (els.cityInput) els.cityInput.value = next.city || '';
            if (els.sellerInput) els.sellerInput.value = next.seller || '';
            if (els.yearMinInput) els.yearMinInput.value = next.yearMin ?? '';
            if (els.yearMaxInput) els.yearMaxInput.value = next.yearMax ?? '';
            if (els.mileageMinInput) els.mileageMinInput.value = next.mileageMin ?? '';
            if (els.mileageMaxInput) els.mileageMaxInput.value = next.mileageMax ?? '';
            if (els.postedSelect) els.postedSelect.value = next.posted || 'any';
            if (els.priceTermSelect) els.priceTermSelect.value = next.priceTerm || 'any';
            if (els.minInput) els.minInput.value = next.min ?? '';
            if (els.maxInput) els.maxInput.value = next.max ?? '';
            if (els.sortSelect) els.sortSelect.value = next.sort || 'newest';

            this.vehicleFilters = { ...this.vehicleFilters, ...next };
            return true;
        } catch {
            // ignore
            return false;
        }
    }

    applyVehiclesInputsFromState(els) {
        const f = this.vehicleFilters || {};
        if (els.searchInput) els.searchInput.value = f.search || '';
        if (els.makeSelect) els.makeSelect.value = f.make || '';
        if (els.makeSelect) els.makeSelect.dispatchEvent(new Event('change'));
        if (els.modelSelect) els.modelSelect.value = f.model || '';
        if (els.conditionSelect) els.conditionSelect.value = f.condition || '';
        if (els.countryInput) els.countryInput.value = f.country || '';
        if (els.cityInput) els.cityInput.value = f.city || '';
        if (els.sellerInput) els.sellerInput.value = f.seller || '';
        if (els.yearMinInput) els.yearMinInput.value = f.yearMin ?? '';
        if (els.yearMaxInput) els.yearMaxInput.value = f.yearMax ?? '';
        if (els.mileageMinInput) els.mileageMinInput.value = f.mileageMin ?? '';
        if (els.mileageMaxInput) els.mileageMaxInput.value = f.mileageMax ?? '';
        if (els.postedSelect) els.postedSelect.value = f.posted || 'any';
        if (els.priceTermSelect) els.priceTermSelect.value = f.priceTerm || 'any';
        if (els.minInput) els.minInput.value = f.min ?? '';
        if (els.maxInput) els.maxInput.value = f.max ?? '';
        if (els.sortSelect) els.sortSelect.value = f.sort || 'newest';
    }

    openVideoRingModal(src, label = '') {
        if (!src) return;
        const modal = document.getElementById('video-ring-modal');
        const player = document.getElementById('video-ring-player');
        const caption = document.getElementById('video-ring-caption');
        if (!modal || !player) return;

        if (caption) caption.textContent = label || '';
        player.pause();
        player.currentTime = 0;
        player.src = src;
        // Keep muted for reliable autoplay; user can unmute via controls.
        player.muted = true;
        player.playsInline = true;
        player.autoplay = true;

        modal.classList.remove('hidden');

        const playAttempt = player.play();
        if (playAttempt && typeof playAttempt.catch === 'function') {
            playAttempt.catch(() => {
                // Autoplay might be blocked; user can hit play.
            });
        }
    }

    closeVideoRingModal() {
        const modal = document.getElementById('video-ring-modal');
        const player = document.getElementById('video-ring-player');
        if (player) {
            player.pause();
            player.removeAttribute('src');
            try { player.load(); } catch {}
        }
        if (modal) modal.classList.add('hidden');
    }

    closeMatchModal() {
        const modal = document.getElementById('match-modal');
        if (modal) modal.classList.add('hidden');
    }

    openMatchModal({ name, photo } = {}) {
        const modal = document.getElementById('match-modal');
        if (!modal) return;
        const theirName = String(name || 'Match').trim() || 'Match';
        const theirPhoto = String(photo || '').trim();

        const nameEl = document.getElementById('match-name');
        if (nameEl) nameEl.textContent = theirName;

        const yourImg = document.getElementById('match-your-photo');
        if (yourImg) {
            const src = this.currentUser?.photo || this.buildChatAvatarDataUri(this.currentUser?.name || 'You');
            yourImg.src = src;
        }

        const theirImg = document.getElementById('match-their-photo');
        if (theirImg) {
            theirImg.src = theirPhoto || this.buildChatAvatarDataUri(theirName);
        }

        modal.classList.remove('hidden');
        document.getElementById('send-message-btn')?.focus?.();
    }

    handleChatKeydown(event) {
        if (event.key === 'Escape') this.closeChatModal();
    }

    formatChatTime(value) {
        const parsed = value instanceof Date ? value : new Date(value);
        if (!Number.isFinite(parsed.getTime())) return '';
        return parsed.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    ensureChatThread(threadKey) {
        if (!threadKey) return null;
        if (!this.messages[threadKey]) this.messages[threadKey] = [];
        return this.messages[threadKey];
    }

    buildChatAvatarDataUri(name) {
        const initials = this.getInitials(name) || '?';
        const safeInitials = String(initials).replace(/[^A-Za-z0-9]/g, '').slice(0, 2) || '?';
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" fill="#2563eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="32" fill="#ffffff">${safeInitials}</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    openChatModal({ name, photo, status, threadKey, placeholder, context } = {}) {
        const modal = document.getElementById('chat-modal');
        if (!modal) return;

        const displayName = String(name || 'User').trim() || 'User';
        const key = threadKey || `chat:${this.normalizeSellerKey(displayName) || 'thread'}`;
        this.activeChatUser = {
            name: displayName,
            photo: photo || '',
            status: status || 'Online'
        };
        this.activeChatThread = key;
        this.activeChatContext = context || null;
        this.ensureChatThread(key);

        const photoEl = document.getElementById('chat-user-photo');
        if (photoEl) {
            const src = photo && String(photo).trim() ? photo : this.buildChatAvatarDataUri(displayName);
            photoEl.src = src;
            photoEl.alt = displayName;
        }

        const nameEl = document.getElementById('chat-user-name');
        if (nameEl) nameEl.textContent = displayName;

        const statusEl = document.getElementById('chat-user-status');
        if (statusEl) {
            const statusText = this.activeChatUser.status || 'Online';
            const listingMatch = /^Listing:\s*(.+)$/i.exec(statusText);
            if (listingMatch) {
                statusEl.innerHTML = `<span class="chat-listing-label">Listing</span> <span class="chat-listing-title">${this.escapeHtml(listingMatch[1])}</span>`;
            } else {
                statusEl.textContent = statusText;
            }
        }

        const input = document.getElementById('message-input');
        if (input) {
            input.value = '';
            input.placeholder = placeholder || 'Type a message...';
        }

        this.renderChatMessages();
        modal.classList.remove('hidden');
        document.addEventListener('keydown', this.boundChatKeydown);
        input?.focus?.();
    }

    closeChatModal() {
        const modal = document.getElementById('chat-modal');
        if (modal) modal.classList.add('hidden');
        this.activeChatThread = null;
        this.activeChatUser = null;
        this.activeChatContext = null;
        document.removeEventListener('keydown', this.boundChatKeydown);
    }

    renderChatMessages() {
        const list = document.getElementById('chat-messages');
        if (!list) return;
        const threadKey = this.activeChatThread;
        const messages = threadKey ? (this.messages[threadKey] || []) : [];
        if (!messages.length) {
            list.innerHTML = '';
            return;
        }

        list.innerHTML = messages.map((entry) => {
            const sent = entry.sender === 'me';
            const text = this.escapeHtml(String(entry.text || ''));
            const timeLabel = this.formatChatTime(entry.timestamp || entry.time || entry.createdAt);
            const timeHtml = timeLabel ? `<div class="message-time">${this.escapeHtml(timeLabel)}</div>` : '';
            return `
                <div class="message${sent ? ' sent' : ''}">
                    <div>
                        <div class="message-bubble">${text}</div>
                        ${timeHtml}
                    </div>
                </div>
            `;
        }).join('');

        list.scrollTop = list.scrollHeight;
    }

    sendMessage() {
        const input = document.getElementById('message-input');
        if (!input) return;
        const text = String(input.value || '').trim();
        if (!text) return;
        if (!this.activeChatThread) {
            this.showNotification('Open a chat to send a message.');
            return;
        }
        const thread = this.ensureChatThread(this.activeChatThread);
        if (!thread) return;
        thread.push({
            sender: 'me',
            text,
            timestamp: new Date().toISOString()
        });
        input.value = '';
        this.renderChatMessages();
    }

    openChatFromMatch() {
        const name = String(document.getElementById('match-name')?.textContent || 'Match').trim() || 'Match';
        const photo = document.getElementById('match-their-photo')?.getAttribute('src') || '';
        this.closeMatchModal();
        this.openChatModal({
            name,
            photo,
            status: 'Online',
            threadKey: `match:${this.normalizeSellerKey(name) || 'match'}`,
            placeholder: `Send a message to ${name}`
        });
    }

    openMarketplaceChat(item) {
        if (!item) return;
        const sellerName = String(item.seller || 'Seller').trim() || 'Seller';
        const title = String(item.title || 'Listing').trim() || 'Listing';
        this.openSafetyModal({
            title: 'Safety tips before messaging',
            subtitle: 'Use safe meetup and payment practices before continuing.',
            onContinue: () => {
                this.closeMarketplaceItemModal();
                this.closeSellerProfileModal();
                this.openChatModal({
                    name: sellerName,
                    status: `Listing: ${title}`,
                    threadKey: `marketplace:${item.id}`,
                    placeholder: `Message ${sellerName} about ${title}`,
                    context: { type: 'marketplace', itemId: item.id, title }
                });
            }
        });
    }

    openDiscoveryChat(post) {
        if (!post) return;
        const seller = post.seller || post.user || {};
        const sellerName = String(seller.name || 'Seller').trim() || 'Seller';
        const photo = seller.avatar || seller.photo || '';
        const listing = post.listing || {};
        const title = String(listing.title || 'Listing').trim() || 'Listing';
        this.openSafetyModal({
            title: 'Safety tips before messaging',
            subtitle: 'Use safe meetup and payment practices before continuing.',
            onContinue: () => {
                this.closeSellerProfileModal();
                this.openChatModal({
                    name: sellerName,
                    photo,
                    status: `Listing: ${title}`,
                    threadKey: `discovery:${post.id}`,
                    placeholder: `Message ${sellerName} about ${title}`,
                    context: { type: 'discovery', postId: post.id, title }
                });
            }
        });
    }

    openSellerProfileChat() {
        if (!this.activeSellerProfile) return;
        const sellerName = String(this.activeSellerProfile.name || 'Seller').trim() || 'Seller';
        const status = this.activeSellerProfile.responseLabel || 'Seller';
        this.openSafetyModal({
            title: 'Safety tips before messaging',
            subtitle: 'Use safe meetup and payment practices before continuing.',
            onContinue: () => {
                this.closeSellerProfileModal();
                this.openChatModal({
                    name: sellerName,
                    status,
                    threadKey: `seller:${this.normalizeSellerKey(sellerName) || 'seller'}`,
                    placeholder: `Message ${sellerName}`,
                    context: { type: 'seller', name: sellerName }
                });
            }
        });
    }

    blockCurrentChatUser() {
        const name = this.activeChatUser?.name || 'this user';
        this.showNotification(`You blocked ${name}.`);
        this.addNotification({
            title: 'User blocked',
            message: `You blocked ${name}.`,
            type: 'system'
        });
        this.closeChatModal();
    }

    reportCurrentChatUser() {
        const name = this.activeChatUser?.name || 'this user';
        this.showNotification(`Report submitted for ${name}.`);
        this.addNotification({
            title: 'Report submitted',
            message: `You reported ${name}.`,
            type: 'system'
        });
    }

    hideAgeGate() {
        const modal = document.getElementById('age-gate-modal');
        if (modal) modal.classList.add('hidden');
    }

	    bindImageCarousels() {
	        document.querySelectorAll('.image-carousel').forEach(carousel => {
	            if (carousel.dataset.bound) return;
	            const track = carousel.querySelector('.carousel-track');
	            if (!track) return;
	            const prev = carousel.querySelector('.carousel-btn.prev');
	            const next = carousel.querySelector('.carousel-btn.next');

	            const scrollBy = (dir) => {
	                track.scrollBy({ left: dir * track.clientWidth, behavior: 'smooth' });
	            };
	            if (prev) {
	                prev.addEventListener('click', (e) => {
	                    e.stopPropagation();
	                    scrollBy(-1);
	                });
	            }
	            if (next) {
	                next.addEventListener('click', (e) => {
	                    e.stopPropagation();
	                    scrollBy(1);
	                });
	            }

	            const lightboxHost = carousel.closest('.featured-ad-card, .realestate-card');
            const isServiceCard = Boolean(lightboxHost?.dataset?.serviceId)
                || Boolean(lightboxHost?.closest?.('#services-content'));
            const isHomeFeatured = Boolean(lightboxHost?.closest?.('#home-content .home-featured-ads'));
            const isCommunitySponsored = Boolean(lightboxHost?.closest?.('#community-content .home-featured-ads'));
            const isDatingSponsored = Boolean(lightboxHost?.closest?.('#dating-content .dating-featured-ads-strip'));
            const isCompanionshipFeatured = Boolean(lightboxHost?.closest?.('#dating-content .companionship-featured-strip'));
            const isRealestateSection = Boolean(lightboxHost?.dataset?.realestateId)
                || Boolean(lightboxHost?.closest?.('#realestate-content'));
            const hasMarketplaceLink = Number.isFinite(parseInt(lightboxHost?.dataset?.marketplaceId || '', 10));
            const hasVehicleLink = Boolean(lightboxHost?.dataset?.vehicleId);
            const disableLightbox = isServiceCard || isHomeFeatured || isCommunitySponsored || isRealestateSection || hasMarketplaceLink || hasVehicleLink || isDatingSponsored || isCompanionshipFeatured;

	            if (isDatingSponsored && lightboxHost) {
	                const profileId = lightboxHost.dataset.profileId;
	                const profile = profileId ? this.datingSponsoredProfiles?.[profileId] : null;
	                const photos = Array.isArray(profile?.photos) ? profile.photos.filter(Boolean) : [];
	                if (photos.length) {
	                    const existing = Array.from(track.querySelectorAll('img'))
	                        .map(img => this.normalizeSrc(img.getAttribute('src') || ''));
	                    const incoming = photos.map(src => this.normalizeSrc(src));
	                    const needsUpdate = existing.length !== incoming.length
	                        || incoming.some((src, idx) => src !== existing[idx]);
	                    if (needsUpdate) {
	                        track.innerHTML = '';
	                        photos.forEach((src, idx) => {
	                            const img = document.createElement('img');
	                            img.src = src;
	                            img.alt = `${profile?.name || 'Profile'} photo ${idx + 1}`;
	                            img.loading = 'lazy';
	                            track.appendChild(img);
	                        });
	                    }
	                }
	            }

            const images = Array.from(track.querySelectorAll('img'));

            if (lightboxHost && (isDatingSponsored || isCompanionshipFeatured)) {
	                track.addEventListener('click', (e) => {
	                    const img = e.target.closest('img');
	                    if (!img) return;
	                    e.stopPropagation();
	                    this.openDatingSponsoredProfile(lightboxHost.dataset.profileId, lightboxHost);
	                });
	            } else if (lightboxHost && !disableLightbox) {
	                const label = lightboxHost
	                    ?.querySelector('h4')
	                    ?.textContent
	                    ?.trim() || 'Listing';
	                track.addEventListener('click', (e) => {
	                    const img = e.target.closest('img');
	                    if (!img) return;
	                    const index = images.indexOf(img);
	                    if (index < 0) return;
	                    this.openMediaLightbox(images.map(node => node.src), label, index);
	                    e.stopPropagation();
	                });
	            }
	            carousel.dataset.bound = '1';
	        });
	    }

    bindFeaturedAdCardLightbox() {
        document.querySelectorAll('.featured-ad-card').forEach(card => {
            if (card.dataset.boundLightbox) return;
            const isServiceCard = Boolean(card.dataset.serviceId) || Boolean(card.closest('#services-content'));
            const isHomeFeatured = Boolean(card.closest('#home-content .home-featured-ads'));
            const isMarketplaceSponsored = Boolean(card.closest('#marketplace-content .home-featured-ads'));
            const isDatingSponsored = Boolean(card.closest('#dating-content .dating-featured-ads-strip'));
            const isCompanionshipFeatured = Boolean(card.closest('#dating-content .companionship-featured-strip'));
            const isRealestateSponsored = Boolean(card.closest('#realestate-content .realestate-featured'));
            const isVehiclesSponsored = Boolean(card.closest('#vehicles-content .vehicle-featured-top'));
            const isServicesSponsored = Boolean(card.closest('#services-content .services-featured'));
            const isCommunitySponsored = Boolean(card.closest('#community-content .home-featured-ads'));
            const isRealestateCard = Boolean(card.dataset.realestateId);
            const hasMarketplaceLink = Number.isFinite(parseInt(card.dataset.marketplaceId || '', 10));
            const vehicleId = card.dataset.vehicleId || '';
            const hasVehicleLink = Boolean(vehicleId);
            if (isDatingSponsored || isCompanionshipFeatured) {
                card.dataset.boundLightbox = '1';
                return;
            }
            const open = () => {
                if (isCommunitySponsored) {
                    this.openLuxuryAdModalFromCard(card);
                    return;
                }
                const realestateId = card.dataset.realestateId;
                if (realestateId) {
                    if (isRealestateSponsored) {
                        this.openLuxuryAdModalFromCard(card);
                    } else {
                        this.openRealestateModalById(realestateId);
                    }
                    return;
                }
                if (vehicleId) {
                    if (isVehiclesSponsored) {
                        this.openLuxuryAdModalFromCard(card);
                    } else {
                        this.openVehicleListingModal(vehicleId);
                    }
                    return;
                }
                const marketplaceId = parseInt(card.dataset.marketplaceId || '', 10);
                if (Number.isFinite(marketplaceId)) {
                    if (isMarketplaceSponsored) {
                        this.openLuxuryAdModalFromCard(card);
                    } else {
                        this.openSellerProfileFromItem(marketplaceId);
                    }
                    return;
                }
                if (isServiceCard) {
                    if (isServicesSponsored) {
                        this.openLuxuryAdModalFromCard(card);
                    } else {
                        this.openServiceModalFromCard(card);
                    }
                    return;
                }
                if (isHomeFeatured) {
                    this.openHomeFeaturedSellerProfileFromCard(card);
                    return;
                }
                const carouselImages = Array.from(card.querySelectorAll('.carousel-track img')).map(img => img.src).filter(Boolean);
                const dataPhotos = (card.dataset.photos || '')
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);
                const fallback = card.querySelector('img')?.src ? [card.querySelector('img').src] : [];
                const sources = carouselImages.length ? carouselImages : (dataPhotos.length ? dataPhotos : fallback);
                if (!sources.length) return;
                const label = card.querySelector('.featured-ad-body h4')?.textContent?.trim() || 'Listing';
                this.openMediaLightbox(sources, label, 0);
            };

            card.addEventListener('click', (e) => {
                if (e.target.closest('.carousel-btn')) return;
                if (!isServiceCard && !isHomeFeatured && !isRealestateCard && !hasMarketplaceLink && !hasVehicleLink && e.target.closest('.carousel-track img')) return;
                if (e.target.closest('.vehicle-featured-dot, .vehicle-featured-dots')) return;
                open();
            });
            card.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                if (e.target.closest('.carousel-btn')) return;
                if (e.target.closest('.vehicle-featured-dot, .vehicle-featured-dots')) return;
                e.preventDefault();
                open();
            });
            card.setAttribute('tabindex', card.getAttribute('tabindex') || '0');
            card.dataset.boundLightbox = '1';
        });
    }

    formatFeedHeaderDate(date) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
        const today = new Date();
        const todayKey = today.toISOString().slice(0, 10);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayKey = yesterday.toISOString().slice(0, 10);
        const key = date.toISOString().slice(0, 10);
        if (key === todayKey) return 'Today';
        if (key === yesterdayKey) return 'Yesterday';
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    formatRealestateDate(dateInput) {
        if (!dateInput || dateInput === 'Unknown') return 'Unknown';
        const date = dateInput instanceof Date ? dateInput : new Date(`${dateInput}T00:00:00`);
        return this.formatFeedHeaderDate(date) || 'Unknown';
    }

    formatCompanionshipPostedDate(date) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
        const today = new Date();
        const todayKey = today.toISOString().slice(0, 10);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayKey = yesterday.toISOString().slice(0, 10);
        const key = date.toISOString().slice(0, 10);
        if (key === todayKey) return 'Today';
        if (key === yesterdayKey) return 'Yesterday';
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    formatCompanionshipFeedHeaderDate(date) {
        return this.formatFeedHeaderDate(date);
    }

    formatProfilePostedLabel(postedAt) {
        const dateLabel = this.formatCompanionshipPostedDate(postedAt);
        return dateLabel ? `Posted ${dateLabel}` : '';
    }

    parseRelativeActivityLabel(label) {
        if (!label) return null;
        const text = String(label).toLowerCase();
        const now = new Date();
        if (!text || text.includes('online now') || text.includes('just now')) return now;
        if (text.includes('yesterday')) {
            const date = new Date(now);
            date.setDate(now.getDate() - 1);
            date.setHours(12, 0, 0, 0);
            return date;
        }
        const m = text.match(/(\d+)\s*m/);
        if (m) return new Date(now.getTime() - (parseInt(m[1], 10) || 0) * 60000);
        const h = text.match(/(\d+)\s*h/);
        if (h) return new Date(now.getTime() - (parseInt(h[1], 10) || 0) * 60 * 60000);
        const d = text.match(/(\d+)\s*d/);
        if (d) {
            const date = new Date(now);
            date.setDate(now.getDate() - (parseInt(d[1], 10) || 0));
            date.setHours(12, 0, 0, 0);
            return date;
        }
        return null;
    }

    normalizeActivityDate(value) {
        if (!value) return null;
        if (value instanceof Date && !Number.isNaN(value.getTime())) return value;
        if (typeof value === 'number') {
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? null : date;
        }
        if (typeof value === 'string') {
            const relative = this.parseRelativeActivityLabel(value);
            if (relative) return relative;
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? null : date;
        }
        return null;
    }

    getUserActivityDate(user) {
        if (!user) return null;
        const candidates = [
            user.lastActiveAt,
            user.lastActive,
            user.activityAt,
            user.updatedAt,
            user.createdAt,
            user.postedAt
        ];
        for (const value of candidates) {
            const date = this.normalizeActivityDate(value);
            if (date) return date;
        }
        if (user.online) return new Date();
        return null;
    }

    normalizeDatingScheduleItem(item) {
        if (!item || typeof item !== 'object') return null;
        const destination = String(item.destination || '').trim();
        const startDate = String(item.startDate || item.start || '').trim();
        const endDate = String(item.endDate || item.end || '').trim();
        if (!destination || !startDate || !endDate) return null;
        const start = new Date(`${startDate}T00:00:00`);
        const end = new Date(`${endDate}T00:00:00`);
        if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return null;
        const alertCity = String(item.alertCity || '').trim();
        const alertCount = Number.isFinite(Number(item.alertCount))
            ? Math.max(0, parseInt(item.alertCount, 10) || 0)
            : 0;
        const notes = String(item.notes || item.note || '').trim();
        const plans = this.normalizeArrivePlusPlans(item.plans);
        return {
            id: String(item.id || `sched-${Date.now()}-${Math.random().toString(16).slice(2)}`),
            destination,
            startDate: startDate,
            endDate: endDate,
            createdAt: item.createdAt || new Date().toISOString(),
            alertCity: alertCity,
            alertCount: alertCount,
            alertedAt: item.alertedAt || null,
            plans,
            notes
        };
    }

    loadDatingSchedule() {
        try {
            const raw = localStorage.getItem(this.datingScheduleStorageKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed
                .map((item) => this.normalizeDatingScheduleItem(item))
                .filter(Boolean);
        } catch {
            return [];
        }
    }

    saveDatingSchedule() {
        try {
            localStorage.setItem(this.datingScheduleStorageKey, JSON.stringify(this.datingSchedule));
        } catch {}
    }

    formatScheduleDate(dateStr) {
        const date = new Date(`${dateStr}T00:00:00`);
        if (Number.isNaN(date.getTime())) return '';
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    getStayDurationLabel(startDate, endDate) {
        const start = new Date(`${startDate}T00:00:00`);
        const end = new Date(`${endDate}T00:00:00`);
        if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return '';
        const dayMs = 24 * 60 * 60 * 1000;
        let days = Math.round((end - start) / dayMs) + 1;
        if (!Number.isFinite(days) || days < 1) days = 1;
        return days === 1 ? '1 day' : `${days} days`;
    }

    getScheduleStatus(startDate, endDate) {
        const start = new Date(`${startDate}T00:00:00`);
        const end = new Date(`${endDate}T00:00:00`);
        if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();
        const startMs = start.getTime();
        const endMs = end.getTime();
        const dayMs = 24 * 60 * 60 * 1000;
        if (todayMs < startMs) {
            const diff = Math.ceil((startMs - todayMs) / dayMs);
            if (diff === 1) return { label: 'Arriving tomorrow', tone: 'upcoming' };
            return { label: `Arrives in ${diff} days`, tone: 'upcoming' };
        }
        if (todayMs > endMs) {
            return { label: 'Trip ended', tone: 'past' };
        }
        const remaining = Math.max(1, Math.round((endMs - todayMs) / dayMs) + 1);
        const remainingLabel = remaining === 1 ? 'Last day in town' : `${remaining} days left`;
        return { label: `In town - ${remainingLabel}`, tone: 'live' };
    }

    loadArrivePlusChecklist() {
        try {
            const raw = localStorage.getItem(this.arrivePlusChecklistKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.map((item) => String(item || '').trim()).filter(Boolean);
        } catch {
            return [];
        }
    }

    saveArrivePlusChecklist(items) {
        try {
            const payload = Array.isArray(items) ? items : [];
            localStorage.setItem(this.arrivePlusChecklistKey, JSON.stringify(payload));
        } catch {}
    }

    normalizeArrivePlusPlans(plans) {
        if (!Array.isArray(plans)) return [];
        const cleaned = plans.map((item) => String(item || '').trim()).filter(Boolean);
        return Array.from(new Set(cleaned));
    }

    formatArrivePlusPlansLabel(plans) {
        const trimmed = this.normalizeArrivePlusPlans(plans);
        if (!trimmed.length) return '';
        if (trimmed.length <= 3) return `Plans: ${trimmed.join(', ')}`;
        return `Plans: ${trimmed.slice(0, 3).join(', ')} +${trimmed.length - 3} more`;
    }

    updateArrivePlusChecklistSummary(inputs) {
        const summary = document.getElementById('arrive-plus-checklist-summary');
        if (!summary) return;
        const selected = inputs.filter((input) => input.checked).map((input) => input.value || '');
        if (!selected.length) {
            summary.textContent = 'Select activities you want to do.';
            return;
        }
        const trimmed = this.normalizeArrivePlusPlans(selected);
        if (trimmed.length <= 3) {
            summary.textContent = `Selected: ${trimmed.join(', ')}`;
            return;
        }
        summary.textContent = `Selected: ${trimmed.slice(0, 3).join(', ')} +${trimmed.length - 3} more`;
    }

    getArrivePlusChecklistLabel() {
        return this.formatArrivePlusPlansLabel(this.loadArrivePlusChecklist());
    }

    updateArrivePlusSchedulePlans(plans) {
        const normalized = this.normalizeArrivePlusPlans(plans);
        if (!normalized.length || !Array.isArray(this.datingSchedule) || !this.datingSchedule.length) return;
        let updated = false;
        this.datingSchedule = this.datingSchedule.map((entry) => {
            if (!entry || typeof entry !== 'object') return entry;
            const existing = this.normalizeArrivePlusPlans(entry.plans);
            if (existing.length) return entry;
            updated = true;
            return { ...entry, plans: normalized };
        });
        if (updated) this.saveDatingSchedule();
    }

    getPlansLabelForScheduleId(scheduleId) {
        if (!scheduleId) return '';
        const entry = (this.datingSchedule || []).find((item) => item.id === scheduleId);
        return this.formatArrivePlusPlansLabel(entry?.plans || []);
    }

    setupArrivePlusChecklist() {
        const list = document.getElementById('arrive-plus-checklist');
        if (!list || list.dataset.bound) return;
        const inputs = Array.from(list.querySelectorAll('input[type="checkbox"]'));
        if (!inputs.length) return;
        const saved = new Set(this.loadArrivePlusChecklist().map((item) => item.toLowerCase()));
        const toggleClass = (input) => {
            const label = input.closest('.arrive-plus-check');
            if (label) label.classList.toggle('checked', input.checked);
        };
        inputs.forEach((input) => {
            const value = String(input.value || '').trim();
            if (value && saved.has(value.toLowerCase())) {
                input.checked = true;
            }
            toggleClass(input);
            input.addEventListener('change', () => {
                toggleClass(input);
                const selected = inputs.filter((item) => item.checked).map((item) => item.value || '').filter(Boolean);
                this.saveArrivePlusChecklist(selected);
                this.updateArrivePlusChecklistSummary(inputs);
                this.updateArrivePlusSchedulePlans(selected);
                this.renderDatingScheduleList();
                this.renderTripAlerts();
            });
        });
        this.updateArrivePlusChecklistSummary(inputs);
        list.dataset.bound = '1';
    }

    setupArrivePlusPlanForm() {
        const form = document.getElementById('arrive-plus-plan-form');
        if (!form || form.dataset.bound) return;
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const select = document.getElementById('arrive-plus-plan-trip');
            const input = document.getElementById('arrive-plus-plan-input');
            const value = String(input?.value || '').trim();
            if (!value) {
                this.showNotification('Add an activity first.');
                return;
            }
            const scheduleId = String(select?.value || '').trim();
            if (!scheduleId) {
                this.showNotification('Add a trip before saving activities.');
                return;
            }
            const entry = (this.datingSchedule || []).find((item) => item.id === scheduleId);
            if (!entry) {
                this.showNotification('Trip not found.');
                return;
            }
            const updatedPlans = this.normalizeArrivePlusPlans([...(entry.plans || []), value]);
            this.datingSchedule = this.datingSchedule.map((item) => (
                item.id === scheduleId ? { ...item, plans: updatedPlans } : item
            ));
            this.saveDatingSchedule();
            this.renderDatingScheduleList();
            this.renderTripAlerts();
            if (input) input.value = '';
        });
        form.dataset.bound = '1';
    }

    renderArrivePlusPlanForm() {
        const form = document.getElementById('arrive-plus-plan-form');
        const select = document.getElementById('arrive-plus-plan-trip');
        if (!form || !select) return;
        const input = document.getElementById('arrive-plus-plan-input');
        const submit = form.querySelector('button[type="submit"]');
        const items = Array.isArray(this.datingSchedule)
            ? this.datingSchedule.slice().sort((a, b) => a.startDate.localeCompare(b.startDate))
            : [];
        if (!items.length) {
            select.innerHTML = '<option value="">No trips yet</option>';
            select.disabled = true;
            if (input) input.disabled = true;
            if (submit) submit.disabled = true;
            form.classList.add('is-disabled');
            return;
        }
        const previous = select.value;
        select.innerHTML = items.map((item) => {
            const range = this.formatScheduleRangeShort(item.startDate, item.endDate);
            const label = [item.destination, range].filter(Boolean).join(' 路 ');
            return `<option value="${this.escapeHtml(item.id)}">${this.escapeHtml(label || 'Trip')}</option>`;
        }).join('');
        select.disabled = false;
        if (input) input.disabled = false;
        if (submit) submit.disabled = false;
        form.classList.remove('is-disabled');
        if (previous && items.some((item) => item.id === previous)) {
            select.value = previous;
        } else {
            select.value = items[0].id;
        }
    }

    getNextScheduleEntry() {
        if (!Array.isArray(this.datingSchedule) || !this.datingSchedule.length) return null;
        const todayKey = new Date().toISOString().slice(0, 10);
        const upcoming = this.datingSchedule.filter((entry) => entry.endDate >= todayKey);
        const list = upcoming.length ? upcoming : this.datingSchedule.slice();
        list.sort((a, b) => a.startDate.localeCompare(b.startDate));
        return list[0] || null;
    }

    getSharedInterests(user) {
        const mine = Array.isArray(this.currentUser?.interests) ? this.currentUser.interests : [];
        const theirs = Array.isArray(user?.interests) ? user.interests : [];
        if (!mine.length || !theirs.length) return [];
        const normalize = (value) => String(value || '').trim().toLowerCase();
        const mineSet = new Set(mine.map(normalize).filter(Boolean));
        const shared = [];
        for (const interest of theirs) {
            const key = normalize(interest);
            if (!key || !mineSet.has(key)) continue;
            shared.push(String(interest));
        }
        return shared;
    }

    parseDestinationParts(destination) {
        const raw = String(destination || '').trim();
        if (!raw) return { city: '', country: '' };
        const parts = raw.split(',').map(part => part.trim()).filter(Boolean);
        return {
            city: parts[0] || raw,
            country: parts.slice(1).join(', ')
        };
    }

    matchesDestination(user, destination) {
        if (!user || !destination) return false;
        const { city, country } = this.parseDestinationParts(destination);
        const cityNeedle = this.normalizeLocationText(city);
        const countryNeedle = this.normalizeLocationText(country);
        if (!cityNeedle) return false;
        const cityValue = this.normalizeLocationText(user.location?.city);
        if (!cityValue) return false;
        const cityMatch = cityValue.includes(cityNeedle) || cityNeedle.includes(cityValue);
        if (!cityMatch) return false;
        if (!countryNeedle) return true;
        const countryValue = this.normalizeLocationText(user.location?.country);
        if (!countryValue) return true;
        return countryValue.includes(countryNeedle) || countryNeedle.includes(countryValue);
    }

    formatScheduleRangeShort(startDate, endDate) {
        const start = new Date(`${startDate}T00:00:00`);
        const end = new Date(`${endDate}T00:00:00`);
        if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return '';
        const sameDay = start.toDateString() === end.toDateString();
        const startLabel = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const endLabel = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        return sameDay ? startLabel : `${startLabel}${endLabel}`;
    }

    getScheduleAlertTargets(destination) {
        return (this.users || []).filter((u) => this.matchesDestination(u, destination));
    }

    normalizeTripAlertItem(item) {
        if (!item || typeof item !== 'object') return null;
        const destination = String(item.destination || '').trim();
        const startDate = String(item.startDate || '').trim();
        const endDate = String(item.endDate || '').trim();
        if (!destination || !startDate || !endDate) return null;
        return {
            id: String(item.id || `alert-${Date.now()}-${Math.random().toString(16).slice(2)}`),
            scheduleId: String(item.scheduleId || ''),
            senderId: item.senderId ?? null,
            senderName: String(item.senderName || 'Someone'),
            recipientId: item.recipientId ?? null,
            recipientName: String(item.recipientName || 'Local'),
            destination,
            startDate,
            endDate,
            status: String(item.status || 'new'),
            createdAt: item.createdAt || new Date().toISOString()
        };
    }

    loadTripAlerts() {
        try {
            const raw = localStorage.getItem(this.tripAlertsStorageKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.map((item) => this.normalizeTripAlertItem(item)).filter(Boolean);
        } catch {
            return [];
        }
    }

    saveTripAlerts() {
        try {
            localStorage.setItem(this.tripAlertsStorageKey, JSON.stringify(this.tripAlerts));
        } catch {}
    }

    normalizeNotification(item) {
        if (!item || typeof item !== 'object') return null;
        const title = String(item.title || '').trim();
        const message = String(item.message || '').trim();
        if (!title && !message) return null;
        return {
            id: String(item.id || `notice-${Date.now()}-${Math.random().toString(16).slice(2)}`),
            title: title || 'Notification',
            message,
            type: String(item.type || 'system'),
            createdAt: item.createdAt || new Date().toISOString(),
            read: Boolean(item.read)
        };
    }

    loadNotifications() {
        try {
            const raw = localStorage.getItem(this.notificationsStorageKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.map((item) => this.normalizeNotification(item)).filter(Boolean);
        } catch {
            return [];
        }
    }

    saveNotifications() {
        try {
            localStorage.setItem(this.notificationsStorageKey, JSON.stringify(this.notifications));
        } catch {}
    }

    updateNotificationBellVisibility(screenName = '') {
        const wrap = document.getElementById('notification-center-wrap');
        if (!wrap) return;
        const panel = document.getElementById('notification-center');
        const isHome = screenName === 'home';
        wrap.classList.toggle('hidden', !isHome);
        if (!isHome && panel) panel.classList.add('hidden');
    }

    loadMatches() {
        try {
            const raw = localStorage.getItem(this.matchesStorageKey);
            const parsed = JSON.parse(raw || '[]');
            if (!Array.isArray(parsed)) return new Set();
            const ids = parsed.map((id) => Number(id)).filter((id) => Number.isFinite(id));
            return new Set(ids);
        } catch {
            return new Set();
        }
    }

    saveMatches() {
        try {
            const payload = Array.from(this.matchIds || []);
            localStorage.setItem(this.matchesStorageKey, JSON.stringify(payload));
        } catch {}
    }

    addMatch(user) {
        const id = Number(user?.id);
        if (!Number.isFinite(id)) return false;
        if (!this.matchIds) this.matchIds = new Set();
        if (this.matchIds.has(id)) return false;
        this.matchIds.add(id);
        this.saveMatches();
        return true;
    }

    addNotification({ title = 'Notification', message = '', type = 'system' } = {}) {
        const entry = this.normalizeNotification({
            title,
            message,
            type,
            createdAt: new Date().toISOString(),
            read: false
        });
        if (!entry) return;
        this.notifications = [entry, ...(this.notifications || [])].slice(0, 60);
        this.saveNotifications();
        this.renderNotificationCenter();
        this.updateNotificationCount();
    }

    markAllNotificationsRead() {
        if (!Array.isArray(this.notifications) || !this.notifications.length) return;
        let updated = false;
        this.notifications = this.notifications.map((item) => {
            if (!item.read) {
                updated = true;
                return { ...item, read: true };
            }
            return item;
        });
        if (updated) {
            this.saveNotifications();
            this.renderNotificationCenter();
            this.updateNotificationCount();
        }
    }

    updateNotificationCount() {
        const badge = document.getElementById('notification-count');
        if (!badge) return;
        const unread = (this.notifications || []).filter((item) => !item.read).length;
        badge.textContent = unread > 0 ? String(unread) : '0';
        badge.classList.toggle('hidden', unread === 0);
    }

    renderNotificationCenter() {
        const list = document.getElementById('notification-list');
        if (!list) return;
        if (!Array.isArray(this.notifications) || !this.notifications.length) {
            list.innerHTML = '<div class="notification-empty">No notifications yet.</div>';
            return;
        }
        list.innerHTML = this.notifications.map((item) => {
            const created = new Date(item.createdAt || '');
            const timeLabel = Number.isNaN(created.getTime()) ? '' : this.formatRelativeTime(created);
            return `
                <div class="notification-item ${item.read ? '' : 'unread'}">
                    <div class="notification-item-title">${this.escapeHtml(item.title || 'Notification')}</div>
                    ${item.message ? `<p class="notification-item-message">${this.escapeHtml(item.message)}</p>` : ''}
                    ${timeLabel ? `<span class="notification-item-time">${this.escapeHtml(timeLabel)}</span>` : ''}
                </div>
            `;
        }).join('');
    }

    setupNotificationCenter() {
        const bell = document.getElementById('notification-bell');
        const panel = document.getElementById('notification-center');
        const clearBtn = document.getElementById('notification-clear');
        if (!bell || !panel || bell.dataset.bound) return;
        const handleToggle = () => {
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                this.markAllNotificationsRead();
            }
        };
        bell.addEventListener('click', (event) => {
            event.stopPropagation();
            handleToggle();
        });
        document.addEventListener('click', (event) => {
            if (panel.classList.contains('hidden')) return;
            if (panel.contains(event.target) || bell.contains(event.target)) return;
            panel.classList.add('hidden');
        });
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.notifications = [];
                this.saveNotifications();
                this.renderNotificationCenter();
                this.updateNotificationCount();
            });
        }
        this.renderNotificationCenter();
        this.updateNotificationCount();
        this.updateNotificationBellVisibility(this.activeScreen);
        bell.dataset.bound = '1';
    }

    renderTripAlerts() {
        const list = document.getElementById('trip-alerts-list');
        if (!list) return;
        if (!this.tripAlerts.length) {
            list.innerHTML = `
                <div class="trip-alerts-empty">
                    <p style="margin:0;color:#6b7280;">No trip alerts yet.</p>
                </div>`;
            return;
        }
        const items = this.tripAlerts.slice().sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
        list.innerHTML = items.map((alert) => {
            const duration = this.getStayDurationLabel(alert.startDate, alert.endDate);
            const range = this.formatScheduleRangeShort(alert.startDate, alert.endDate);
            const recipientLabel = alert.recipientName ? `Sent to ${alert.recipientName}` : '';
            const status = alert.status || 'new';
            const statusLabel = status === 'accepted'
                ? 'Accepted'
                : (status === 'declined' ? 'Declined' : 'New');
            const statusHtml = `<span class="trip-alert-status status-${this.escapeHtml(status)}">${statusLabel}</span>`;
            const actions = status === 'new'
                ? `
                    <button class="btn-primary small trip-alert-action" type="button" data-action="accept">Accept</button>
                    <button class="btn-secondary small trip-alert-action" type="button" data-action="decline">Decline</button>
                `
                : '';
            const plansLabel = this.getPlansLabelForScheduleId(alert.scheduleId);
            const plansHtml = plansLabel
                ? `<span class="trip-alert-intent">${this.escapeHtml(plansLabel)}</span>`
                : '';
            return `
                <div class="trip-alert-card" data-id="${this.escapeHtml(alert.id)}">
                    <div>
                        <h4>${this.escapeHtml(alert.destination)}</h4>
                        <div class="trip-alert-meta">
                            ${recipientLabel ? `<span>${this.escapeHtml(recipientLabel)}</span>` : ''}
                            <span>${this.escapeHtml(range)}</span>
                            <span class="trip-alert-duration">Stay 路 ${this.escapeHtml(duration)}</span>
                            ${plansHtml}
                            ${statusHtml}
                        </div>
                    </div>
                    <div class="trip-alert-actions">
                        ${actions}
                    </div>
                </div>
            `;
        }).join('');
    }

    renderDatingScheduleList() {
        const list = document.getElementById('dating-schedule-list');
        if (!list) return;
        if (!this.datingSchedule.length) {
            list.innerHTML = `
                <div class="dating-schedule-empty">
                    <p style="margin:0;color:#6b7280;">Add a destination to share your stay window.</p>
                </div>`;
            this.renderArrivePlusPreview();
            this.renderArrivePlusPlanForm();
            return;
        }
        const items = this.datingSchedule.slice().sort((a, b) => a.startDate.localeCompare(b.startDate));
        list.innerHTML = items.map((item) => {
            const startLabel = this.formatScheduleDate(item.startDate);
            const endLabel = this.formatScheduleDate(item.endDate);
            const duration = this.getStayDurationLabel(item.startDate, item.endDate);
            const status = this.getScheduleStatus(item.startDate, item.endDate);
            const statusHtml = status
                ? `<span class="dating-schedule-status status-${this.escapeHtml(status.tone)}">${this.escapeHtml(status.label)}</span>`
                : '';
            const plans = this.normalizeArrivePlusPlans(item.plans);
            const plansChips = plans.map((plan) => (
                `<span class="dating-schedule-plan-chip">${this.escapeHtml(plan)}</span>`
            )).join('');
            const dateRow = plans.length
                ? `
                    <div class="dating-schedule-date-row">
                        <span>${this.escapeHtml(startLabel)}  ${this.escapeHtml(endLabel)}</span>
                        <span class="dating-schedule-plan-label">Plans:</span>
                        ${plansChips}
                    </div>
                `
                : `<div class="dating-schedule-date-row"><span>${this.escapeHtml(startLabel)}  ${this.escapeHtml(endLabel)}</span></div>`;
            const notes = String(item.notes || '').trim();
            const notesHtml = notes
                ? `<span class="dating-schedule-note">${this.escapeHtml(notes)}</span>`
                : '';
            const alertLabel = item.alertCity
                ? `Alerts sent to ${item.alertCount || 0} in ${item.alertCity}`
                : '';
            const alertHtml = alertLabel
                ? `<span class="dating-schedule-alerts">${this.escapeHtml(alertLabel)}</span>`
                : '';
            return `
                <div class="dating-schedule-card" data-id="${this.escapeHtml(item.id)}">
                    <div>
                        <h4>${this.escapeHtml(item.destination)}</h4>
                        <div class="dating-schedule-meta">
                            ${dateRow}
                            ${notesHtml}
                            <span class="dating-schedule-duration">Stay 路 ${this.escapeHtml(duration)}</span>
                            ${statusHtml}
                            ${alertHtml}
                        </div>
                    </div>
                    <button class="btn-secondary small dating-schedule-remove" type="button">Remove</button>
                </div>
            `;
        }).join('');
        this.renderArrivePlusPreview();
        this.renderArrivePlusPlanForm();
    }

    renderArrivePlusPreview() {
        const list = document.getElementById('arrive-plus-preview-list');
        if (!list) return;
        const subtitle = document.getElementById('arrive-plus-preview-subtitle');
        const entry = this.getNextScheduleEntry();
        if (!entry) {
            if (subtitle) subtitle.textContent = 'Add a trip to see locals in your destination.';
            list.innerHTML = `
                <div class="arrive-plus-preview-empty">
                    Your Arrive+ preview appears after you add a destination and dates.
                </div>`;
            return;
        }
        const matches = this.getScheduleAlertTargets(entry.destination)
            .filter((u) => u && u.id !== this.currentUser?.id);
        matches.sort((a, b) => {
            if (a.online !== b.online) return a.online ? -1 : 1;
            if (a.isPremium !== b.isPremium) return a.isPremium ? -1 : 1;
            const distA = typeof a.location?.distance === 'number' ? a.location.distance : Number.POSITIVE_INFINITY;
            const distB = typeof b.location?.distance === 'number' ? b.location.distance : Number.POSITIVE_INFINITY;
            return distA - distB;
        });
        const preview = matches.slice(0, 4);
        if (subtitle) subtitle.textContent = `Preview for ${entry.destination}`;
        if (!preview.length) {
            list.innerHTML = `
                <div class="arrive-plus-preview-empty">
                    No locals found in ${this.escapeHtml(entry.destination)} yet.
                </div>`;
            return;
        }
        list.innerHTML = preview.map((user) => {
            const photo = user.photo || user.photos?.[0] || '';
            const locationLabel = this.getProfileLocationLabel(user);
            const shared = this.getSharedInterests(user);
            const sharedLabel = shared.length ? `${shared.length} shared interests` : 'New match';
            const onlineLabel = user.online ? 'Online' : 'Offline';
            const plansLabel = this.formatArrivePlusPlansLabel(entry.plans);
            const plansHtml = plansLabel ? `<span class="arrive-plus-tag is-plan">${this.escapeHtml(plansLabel)}</span>` : '';
            const tags = [
                `<span class="arrive-plus-tag ${user.online ? 'is-online' : 'is-offline'}">${onlineLabel}</span>`,
                user.isPremium ? '<span class="arrive-plus-tag is-premium">Premium</span>' : '',
                shared.length ? `<span class="arrive-plus-tag is-shared">${this.escapeHtml(sharedLabel)}</span>` : '',
                plansHtml
            ].filter(Boolean).join('');
            const interestTags = (shared.length ? shared : (user.interests || []).slice(0, 1))
                .map((tag) => `<span class="arrive-plus-tag">${this.escapeHtml(tag)}</span>`)
                .join('');
            return `
                <div class="arrive-plus-preview-item">
                    <img class="arrive-plus-preview-avatar" src="${this.escapeHtml(photo)}" alt="${this.escapeHtml(user.name || 'Match')}" loading="lazy" decoding="async">
                    <div>
                        <div class="arrive-plus-preview-name">${this.escapeHtml(user.name || 'Match')}${user.age ? `, ${this.escapeHtml(String(user.age))}` : ''}</div>
                        <div class="arrive-plus-preview-meta">${this.escapeHtml(locationLabel)}</div>
                        <div class="arrive-plus-preview-tags">
                            ${tags}
                            ${interestTags}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    getScheduleMatchForUser(user) {
        if (!user) return null;
        const todayKey = new Date().toISOString().slice(0, 10);
        const matches = (this.datingSchedule || []).filter((entry) => {
            if (!this.matchesDestination(user, entry.destination)) return false;
            if (entry.endDate && entry.endDate < todayKey) return false;
            return true;
        });
        if (!matches.length) return null;
        matches.sort((a, b) => a.startDate.localeCompare(b.startDate));
        return matches[0] || null;
    }

    getScheduleBadgeLabel(entry) {
        if (!entry) return '';
        const range = this.formatScheduleRangeShort(entry.startDate, entry.endDate);
        return range ? `Arrive+ ${range}` : 'Arrive+';
    }

    setupDatingSchedule() {
        const form = document.getElementById('dating-schedule-form');
        const list = document.getElementById('dating-schedule-list');
        const clearBtn = document.getElementById('dating-schedule-clear');
        const alertsList = document.getElementById('trip-alerts-list');
        this.setupArrivePlusChecklist();
        this.setupArrivePlusPlanForm();
        if (!form || form.dataset.bound) return;
        const destinationInput = document.getElementById('dating-schedule-destination');
        const startInput = document.getElementById('dating-schedule-start');
        const endInput = document.getElementById('dating-schedule-end');
        const notesInput = document.getElementById('dating-schedule-notes');
        const updateEndMin = () => {
            if (!endInput) return;
            if (startInput?.value) endInput.min = startInput.value;
            else endInput.removeAttribute('min');
        };
        if (startInput) startInput.addEventListener('change', updateEndMin);
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const destination = (destinationInput?.value || '').trim();
            const startDate = startInput?.value || '';
            const endDate = endInput?.value || '';
            const notes = (notesInput?.value || '').trim();
            if (!destination || !startDate || !endDate) {
                this.showNotification('Add destination and dates to schedule.');
                return;
            }
            if (endDate < startDate) {
                this.showNotification('End date must be the same or after start date.');
                return;
            }
            const alertTargets = this.getScheduleAlertTargets(destination);
            const alertCity = destination.split(',')[0]?.trim() || destination;
            const plans = this.loadArrivePlusChecklist();
            const entry = this.normalizeDatingScheduleItem({
                id: `sched-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                destination,
                startDate,
                endDate,
                createdAt: new Date().toISOString(),
                alertCity,
                alertCount: alertTargets.length,
                alertedAt: new Date().toISOString(),
                plans,
                notes
            });
            if (!entry) return;
            this.datingSchedule = [entry, ...this.datingSchedule];
            this.saveDatingSchedule();
            this.renderDatingScheduleList();
            this.applyDatingLocationFeed();
            if (alertTargets.length) {
                const senderName = this.currentUser?.name || 'You';
                const newAlerts = alertTargets.map((user) => this.normalizeTripAlertItem({
                    id: `alert-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    scheduleId: entry.id,
                    senderId: this.currentUser?.id ?? null,
                    senderName,
                    recipientId: user.id,
                    recipientName: user.name || 'Local',
                    destination: entry.destination,
                    startDate: entry.startDate,
                    endDate: entry.endDate,
                    status: 'new',
                    createdAt: new Date().toISOString()
                })).filter(Boolean);
                this.tripAlerts = newAlerts.concat(this.tripAlerts);
                this.saveTripAlerts();
                this.renderTripAlerts();
            }
            form.reset();
            updateEndMin();
            if (alertTargets.length) {
                this.showNotification(`Alerts sent to ${alertTargets.length} people in ${alertCity}.`);
            } else {
                this.showNotification(`No users found in ${alertCity} yet.`);
            }
            const noteMessage = alertTargets.length
                ? `Arrive+ alert sent to ${alertTargets.length} people in ${alertCity}.`
                : `No locals found in ${alertCity} yet.`;
            this.addNotification({
                title: 'Arrive+ trip posted',
                message: noteMessage,
                type: 'arrive_plus'
            });
        });
        if (list && !list.dataset.bound) {
            list.addEventListener('click', (event) => {
                const btn = event.target.closest('.dating-schedule-remove');
                if (!btn) return;
                const card = btn.closest('.dating-schedule-card');
                const id = card?.dataset?.id;
                if (!id) return;
                this.datingSchedule = this.datingSchedule.filter((item) => item.id !== id);
                this.tripAlerts = this.tripAlerts.filter((alert) => alert.scheduleId !== id);
                this.saveDatingSchedule();
                this.saveTripAlerts();
                this.renderDatingScheduleList();
                this.renderTripAlerts();
                this.applyDatingLocationFeed();
            });
            list.dataset.bound = '1';
        }
        if (clearBtn && !clearBtn.dataset.bound) {
            clearBtn.addEventListener('click', () => {
                if (!this.datingSchedule.length) return;
                this.datingSchedule = [];
                this.tripAlerts = [];
                this.saveDatingSchedule();
                this.saveTripAlerts();
                this.renderDatingScheduleList();
                this.renderTripAlerts();
                this.applyDatingLocationFeed();
            });
            clearBtn.dataset.bound = '1';
        }
        if (alertsList && !alertsList.dataset.bound) {
            alertsList.addEventListener('click', (event) => {
                const actionBtn = event.target.closest('.trip-alert-action');
                if (!actionBtn) return;
                const card = actionBtn.closest('.trip-alert-card');
                const id = card?.dataset?.id;
                if (!id) return;
                const action = actionBtn.dataset.action;
                const status = action === 'accept' ? 'accepted' : 'declined';
                const targetAlert = this.tripAlerts.find((alert) => alert.id === id);
                this.tripAlerts = this.tripAlerts.map((alert) => {
                    if (alert.id !== id) return alert;
                    return { ...alert, status };
                });
                this.saveTripAlerts();
                this.renderTripAlerts();
                if (targetAlert) {
                    const statusLabel = status === 'accepted' ? 'accepted' : 'declined';
                    const targetName = targetAlert.recipientName || 'A local';
                    const destination = targetAlert.destination || 'your trip';
                    this.addNotification({
                        title: `Trip alert ${statusLabel}`,
                        message: `${targetName} ${statusLabel} your Arrive+ alert for ${destination}.`,
                        type: 'trip_alert'
                    });
                }
            });
            alertsList.dataset.bound = '1';
        }
        this.renderDatingScheduleList();
        this.renderTripAlerts();
        form.dataset.bound = '1';
    }

			    renderRealestateFeed(category) {
			        const container = document.getElementById('realestate-grid');
			        if (!container) return;

			        const listings = (this.realestateListings || []).filter((item) => {
			            if (!category || category === 'all') return true;
			            return (item.categories || []).includes(category);
			        });

			        const sorted = listings.slice().sort((a, b) => String(b?.date || '').localeCompare(String(a?.date || '')));
			        const isAirbnb = String(category || '') === 'short_term';

			        const estimateNightlyPrice = (rawPrice) => {
			            const raw = String(rawPrice || '').trim();
			            if (!raw) return '';
			            const numeric = parseFloat(raw.replace(/[^0-9.]/g, ''));
			            if (!Number.isFinite(numeric) || numeric <= 0) return raw;
			            const lower = raw.toLowerCase();
			            if (lower.includes('/mo') || lower.includes('mo')) {
			                const nightly = Math.max(1, Math.round(numeric / 30));
			                return `Est. $${nightly.toLocaleString()} / night`;
			            }
			            if (lower.includes('/day') || lower.includes('day')) {
			                return `$${Math.round(numeric).toLocaleString()} / night`;
			            }
			            if (lower.includes('/night') || lower.includes('night')) return raw;
			            return raw;
			        };

			        const grouped = sorted.reduce((acc, item) => {
			            const key = String(item?.date || '').trim() || 'unknown';
			            if (!acc[key]) acc[key] = [];
			            acc[key].push(item);
			            return acc;
			        }, {});

			        const groupKeys = Object.keys(grouped).sort((a, b) => {
			            if (a === 'unknown') return 1;
			            if (b === 'unknown') return -1;
			            return b.localeCompare(a);
			        });

			        const html = groupKeys.map((dateKey) => {
			            const items = grouped[dateKey] || [];
			            const label = dateKey === 'unknown'
			                ? 'Unknown'
			                : (this.formatRealestateDate(dateKey) || 'Unknown');
			            if (isAirbnb) {
			                const cards = items.map((item) => {
			                    const id = this.escapeHtml(String(item?.id || ''));
			                    const title = this.escapeHtml(String(item?.title || 'Stay'));
			                    const location = this.escapeHtml(String(item?.location || item?.city || ''));
			                    const ratingValue = typeof item?.rating === 'number' ? item.rating : parseFloat(String(item?.rating || ''));
			                    const ratingText = Number.isFinite(ratingValue) ? ratingValue.toFixed(2).replace(/0$/, '').replace(/\.$/, '') : '';
			                    const priceText = estimateNightlyPrice(item?.price || '');

			                    const allMedia = (Array.isArray(item?.images) && item.images.length ? item.images : [item?.image].filter(Boolean))
			                        .filter(Boolean);
			                    const media = allMedia.length ? allMedia.slice(0, 8) : ['https://via.placeholder.com/900x650/ebeef5/111827?text=Stay'];
			                    const hasCarousel = allMedia.length > 1;
			                    const images = media
			                        .map((src) => `<img src="${this.escapeHtml(String(src || ''))}" alt="${title} photo" loading="lazy" decoding="async">`)
			                        .join('');
			                    const nav = hasCarousel
			                        ? `
			                            <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
			                            <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
			                        `
			                        : '';

			                    return `
			                        <article class="realestate-airbnb-card" data-realestate-id="${id}" role="button" tabindex="0" aria-label="Open ${title}">
			                            <div class="realestate-airbnb-media image-carousel" aria-label="Photos for ${title}">
			                                ${nav}
			                                <div class="carousel-track">
			                                    ${images}
			                                </div>
			                                <button class="realestate-airbnb-save" type="button" aria-label="Save ${title}" aria-pressed="false">
			                                    <i class="far fa-heart" aria-hidden="true"></i>
			                                </button>
			                            </div>
			                            <div class="realestate-airbnb-body">
			                                <div class="realestate-airbnb-row">
			                                    <div class="realestate-airbnb-location">${location}</div>
			                                    ${ratingText ? `<div class="realestate-airbnb-rating"><i class="fas fa-star" aria-hidden="true"></i>${this.escapeHtml(ratingText)}</div>` : ''}
			                                </div>
			                                <div class="realestate-airbnb-title">${title}</div>
			                                <div class="realestate-airbnb-sub">${this.escapeHtml(String(item?.meta || item?.availableOn || ''))}</div>
			                                ${priceText ? `<div class="realestate-airbnb-price">${this.escapeHtml(priceText)}</div>` : ''}
			                            </div>
			                        </article>
			                    `;
			                }).join('');

			                return `
			                    <div class="vehicles-feed-group">
			                        <div class="vehicles-feed-header">
			                            <h4>${this.escapeHtml(label)}</h4>
			                            <span>${items.length} listings</span>
			                        </div>
			                        <div class="realestate-airbnb-grid">
			                            ${cards}
			                        </div>
			                    </div>
			                `;
			            }

			            const cards = items.map((item) => {
			                const id = this.escapeHtml(String(item?.id || ''));
			                const title = this.escapeHtml(String(item?.title || 'Property'));
			                const city = this.escapeHtml(String(item?.city || ''));
			                const price = this.escapeHtml(String(item?.price || ''));
			                const meta = this.escapeHtml(String(item?.meta || item?.badge || 'View details'));

			                const allMedia = (Array.isArray(item?.images) && item.images.length ? item.images : [item?.image].filter(Boolean))
			                    .filter(Boolean);
			                const media = allMedia.length ? allMedia.slice(0, 6) : ['https://via.placeholder.com/900x650/ebeef5/111827?text=Property'];
			                const hasCarousel = allMedia.length > 1;
			                const images = media
			                    .map((src) => `<img src="${this.escapeHtml(String(src || ''))}" alt="${title} photo" loading="lazy" decoding="async">`)
			                    .join('');
			                const nav = hasCarousel
			                    ? `
			                        <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
			                        <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
			                    `
			                    : '';

			                return `
			                    <div class="dating-feed-card vehicle-feed-card realestate-feed-card" data-realestate-id="${id}" role="button" tabindex="0" aria-label="Open ${title}">
			                        <div class="image-carousel vehicle-card-carousel" aria-label="Photos for ${title}">
			                            ${nav}
			                            <div class="carousel-track">
			                                ${images}
			                            </div>
			                        </div>
			                        <div class="dating-feed-meta">
			                            <div class="dating-feed-name">${title}</div>
			                            <div class="dating-feed-location">${city}${city && price ? ' 路 ' : ''}${price}</div>
			                            <div class="dating-feed-status offline">${meta}</div>
			                        </div>
			                        <button class="dating-feed-action realestate-open-btn" type="button" aria-label="Open ${title}">Details</button>
			                    </div>
			                `;
			            }).join('');

			            return `
			                <div class="vehicles-feed-group">
			                    <div class="vehicles-feed-header">
			                        <h4>${this.escapeHtml(label)}</h4>
			                        <span>${items.length} listings</span>
			                    </div>
			                    <div class="dating-feed">
			                        ${cards}
			                    </div>
			                </div>
			            `;
			        }).join('');

			        container.innerHTML = html || '<p class="no-items">No real estate listings match this filter.</p>';

			        this.bindImageCarousels();
			        const count = document.getElementById('realestate-count');
			        if (count) count.textContent = `${listings.length} results`;
			    }

	    bindRealestateCardClicks() {
	        const container = document.getElementById('realestate-grid');
	        if (!container || container.dataset.boundRealestateClick) return;
	        container.addEventListener('click', (event) => {
	            if (event.target.closest('.carousel-btn')) return;
	            const saveBtn = event.target.closest('.realestate-airbnb-save');
	            if (saveBtn) {
	                event.stopPropagation();
	                const pressed = saveBtn.getAttribute('aria-pressed') === 'true';
	                saveBtn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
	                saveBtn.classList.toggle('active', !pressed);
	                const icon = saveBtn.querySelector('i');
	                if (icon) {
	                    icon.classList.toggle('far', pressed);
	                    icon.classList.toggle('fas', !pressed);
	                }
	                return;
	            }
	            const openBtn = event.target.closest('.realestate-open-btn');
	            if (openBtn) {
	                event.stopPropagation();
	            }
	            const card = event.target.closest('.realestate-feed-card, .realestate-airbnb-card');
	            if (!card) return;
	            const id = card.dataset.realestateId || '';
	            const title = card.querySelector('.dating-feed-name')?.textContent?.trim()
	                || card.querySelector('.realestate-airbnb-title')?.textContent?.trim()
	                || card.querySelector('h4')?.textContent?.trim()
	                || '';
	            if (id) {
	                this.openRealestateModalById(id);
	                return;
	            }
	            if (title) this.openRealestateModalByTitle(title);
	        });
	        container.addEventListener('keydown', (event) => {
	            if (event.key !== 'Enter' && event.key !== ' ') return;
	            const card = event.target.closest('.realestate-feed-card, .realestate-airbnb-card');
	            if (!card) return;
	            event.preventDefault();
	            const id = card.dataset.realestateId || '';
	            const title = card.querySelector('.dating-feed-name')?.textContent?.trim()
	                || card.querySelector('.realestate-airbnb-title')?.textContent?.trim()
	                || card.querySelector('h4')?.textContent?.trim()
	                || '';
	            if (id) {
	                this.openRealestateModalById(id);
	                return;
	            }
	            if (title) this.openRealestateModalByTitle(title);
	        });
	        container.dataset.boundRealestateClick = '1';
	    }

    openRealestateModalById(id) {
        const listing = (this.realestateListings || []).find(entry => entry.id === id);
        if (listing) {
            this.openRealestateModal(listing);
        }
    }

    openRealestateModalByTitle(title) {
        if (!title) return;
        const listing = (this.realestateListings || []).find(entry => entry.title === title);
        if (listing) {
            this.openRealestateModal(listing);
        }
    }

	    openRealestateModal(listing) {
	        const modal = document.getElementById('realestate-modal');
	        if (!modal || !listing) return;
	        const imgEl = document.getElementById('realestate-modal-image');
	        const videoEl = document.getElementById('realestate-modal-video');
	        const pillEl = document.getElementById('realestate-modal-pill');
	        const titleEl = document.getElementById('realestate-modal-title');
	        const locationEl = document.getElementById('realestate-modal-location');
	        const metaEl = document.getElementById('realestate-modal-meta');
	        const priceEl = document.getElementById('realestate-modal-price');
	        const descEl = document.getElementById('realestate-modal-desc');
	        const counterEl = document.getElementById('realestate-media-counter');
	        const thumbsEl = document.getElementById('realestate-media-thumbs');
	        const detailsEl = document.getElementById('realestate-modal-details');
	        const tagsEl = document.getElementById('realestate-modal-tags');

	        const photos = Array.isArray(listing.images) ? listing.images.filter(Boolean) : [];
	        const fallbackPhoto = 'https://via.placeholder.com/900x650/ebeef5/111827?text=Property';
	        const safePhotos = photos.length ? photos : [fallbackPhoto];
	        const media = safePhotos.map((src) => ({ type: 'image', src }));
	        const listingVideo = String(listing.video || '').trim();
	        if (listingVideo) media.push({ type: 'video', src: listingVideo });
	        this.realestateModalMedia = media;
	        this.realestateModalIndex = 0;
	        this.activeRealestateListing = listing;

	        if (videoEl) {
	            try { videoEl.pause(); } catch {}
	            videoEl.classList.add('hidden');
	            videoEl.removeAttribute('src');
	        }
	        if (imgEl) imgEl.classList.remove('hidden');
	        if (pillEl) {
	            pillEl.textContent = listing.badge || '';
	            pillEl.classList.toggle('hidden', !listing.badge);
	        }
	        if (titleEl) titleEl.textContent = listing.title || 'Property';
	        if (priceEl) priceEl.textContent = listing.price || '';

        const location = listing.location || [listing.city, listing.country].filter(Boolean).join(', ');
        if (locationEl) {
            locationEl.textContent = location || '';
            locationEl.classList.toggle('hidden', !location);
        }
        const meta = listing.meta || (Array.isArray(listing.tags) ? listing.tags.join(' 路 ') : '');
        if (metaEl) {
            metaEl.textContent = meta || '';
            metaEl.classList.toggle('hidden', !meta);
        }
	        if (descEl) {
	            const desc = listing.description || listing.meta || 'No description provided yet.';
	            descEl.textContent = desc;
	        }
	        const totalMedia = Array.isArray(this.realestateModalMedia) ? this.realestateModalMedia.length : 0;
	        if (counterEl) counterEl.textContent = `${totalMedia ? 1 : 0} / ${totalMedia}`;

	        if (tagsEl) {
	            const tags = Array.isArray(listing.tags) ? listing.tags.filter(Boolean) : [];
	            tagsEl.innerHTML = tags.length
	                ? tags.map((tag) => `<span class="realestate-modal-tag">${this.escapeHtml(String(tag))}</span>`).join('')
	                : '';
	            tagsEl.classList.toggle('hidden', !tags.length);
	        }

	        if (detailsEl) {
	            const details = [];
	            const add = (label, value) => {
	                const safeLabel = String(label || '').trim();
	                const safeValue = String(value || '').trim();
	                if (!safeLabel || !safeValue) return;
	                details.push({ label: safeLabel, value: safeValue });
	            };
	            const bedrooms = Number.isFinite(listing.bedrooms) ? listing.bedrooms : parseInt(String(listing.bedrooms || ''), 10);
	            const bathrooms = Number.isFinite(listing.bathrooms) ? listing.bathrooms : parseFloat(String(listing.bathrooms || ''));
	            const sqft = Number.isFinite(listing.sqft) ? listing.sqft : parseInt(String(listing.sqft || ''), 10);
	            add('Type', listing.propertyType || '');
	            add('Bedrooms', Number.isFinite(bedrooms) ? `${bedrooms} bed` : '');
	            add('Bathrooms', Number.isFinite(bathrooms) ? `${bathrooms} bath` : '');
	            add('Size', Number.isFinite(sqft) ? `${sqft.toLocaleString()} sq ft` : '');
	            add('Availability', listing.availableOn || '');
	            add('Amenities', listing.amenities || '');
	            add('Host', listing.seller || '');
	            add('Rating', Number.isFinite(listing.rating) ? `${listing.rating.toFixed(1)} / 5` : '');
	            add('Reviews', Number.isFinite(listing.reviews) ? `${listing.reviews}` : '');
	            detailsEl.innerHTML = details.length
	                ? details.map((row) => `
	                    <div class="realestate-modal-detail">
	                        <span>${this.escapeHtml(row.label)}</span>
	                        <strong>${this.escapeHtml(row.value)}</strong>
	                    </div>
	                `).join('')
	                : '';
	            detailsEl.classList.toggle('hidden', !details.length);
	        }

	        if (thumbsEl) this.renderRealestateModalThumbs(thumbsEl);
	        this.setRealestateModalIndex(0);

	        modal.classList.remove('hidden');
	    }

	    setRealestateModalIndex(nextIndex) {
	        const media = Array.isArray(this.realestateModalMedia) ? this.realestateModalMedia : [];
	        if (!media.length) return;
	        const idx = Math.min(Math.max(nextIndex, 0), media.length - 1);
	        this.realestateModalIndex = idx;
	        const imgEl = document.getElementById('realestate-modal-image');
	        const videoEl = document.getElementById('realestate-modal-video');
	        const counterEl = document.getElementById('realestate-media-counter');
	        const thumbsEl = document.getElementById('realestate-media-thumbs');
	        const entry = media[idx] || {};

	        if (entry.type === 'video') {
	            if (imgEl) imgEl.classList.add('hidden');
	            if (videoEl) {
	                videoEl.classList.remove('hidden');
	                const nextSrc = String(entry.src || '').trim();
	                if (nextSrc && videoEl.getAttribute('src') !== nextSrc) {
	                    try { videoEl.pause(); } catch {}
	                    videoEl.src = nextSrc;
	                    try { videoEl.load(); } catch {}
	                }
	            }
	        } else {
	            if (videoEl) {
	                try { videoEl.pause(); } catch {}
	                videoEl.classList.add('hidden');
	                videoEl.removeAttribute('src');
	            }
	            if (imgEl) {
	                imgEl.classList.remove('hidden');
	                imgEl.src = String(entry.src || '') || '';
	            }
	        }

	        if (counterEl) counterEl.textContent = `${idx + 1} / ${media.length}`;
	        if (thumbsEl) this.renderRealestateModalThumbs(thumbsEl);
	    }

	    renderRealestateModalThumbs(container) {
	        if (!container) return;
	        const media = Array.isArray(this.realestateModalMedia) ? this.realestateModalMedia : [];
	        if (media.length <= 1) {
	            container.innerHTML = '';
	            container.classList.add('hidden');
	            return;
	        }
	        const idx = Math.min(Math.max(this.realestateModalIndex || 0, 0), media.length - 1);
	        container.classList.remove('hidden');
	        container.innerHTML = media.map((entry, i) => {
	            const active = i === idx;
	            const isVideo = entry?.type === 'video';
	            if (isVideo) {
	                return `
	                    <button class="realestate-media-thumb is-video${active ? ' active' : ''}" type="button" data-realestate-thumb="${i}" aria-label="Open video">
	                        <span class="realestate-media-thumb-icon"><i class="fas fa-play" aria-hidden="true"></i></span>
	                    </button>
	                `;
	            }
	            const safeSrc = this.escapeHtml(String(entry?.src || ''));
	            return `<button class="realestate-media-thumb${active ? ' active' : ''}" type="button" data-realestate-thumb="${i}" aria-label="Open media ${i + 1}"><img src="${safeSrc}" alt="Thumbnail ${i + 1}" loading="lazy"></button>`;
	        }).join('');

	        if (!container.dataset.bound) {
	            container.addEventListener('click', (e) => {
	                const btn = e.target.closest('[data-realestate-thumb]');
	                if (!btn) return;
	                const i = parseInt(btn.dataset.realestateThumb, 10);
	                if (!Number.isFinite(i)) return;
	                this.setRealestateModalIndex(i);
	            });
	            container.dataset.bound = '1';
	        }

	        const active = container.querySelector('.realestate-media-thumb.active');
	        active?.scrollIntoView?.({ block: 'nearest', inline: 'center' });
	    }

	    closeRealestateModal() {
	        const modal = document.getElementById('realestate-modal');
	        if (modal) modal.classList.add('hidden');
	        this.activeRealestateListing = null;
	        const videoEl = document.getElementById('realestate-modal-video');
	        if (videoEl) {
	            try { videoEl.pause(); } catch {}
	            videoEl.classList.add('hidden');
	            videoEl.removeAttribute('src');
	        }
	        this.realestateModalMedia = [];
	        this.realestateModalIndex = 0;
	    }

	    bindRealestateModal() {
	        const modal = document.getElementById('realestate-modal');
	        if (!modal || modal.dataset.bound) return;
	        const closeBtn = document.getElementById('realestate-modal-close');
	        const prevBtn = document.getElementById('realestate-media-prev');
	        const nextBtn = document.getElementById('realestate-media-next');
	        const sellerBtn = document.getElementById('realestate-modal-seller');

	        const doClose = () => this.closeRealestateModal();
	        if (closeBtn) closeBtn.addEventListener('click', doClose);
	        if (prevBtn) prevBtn.addEventListener('click', (event) => {
	            event.stopPropagation();
	            this.setRealestateModalIndex((this.realestateModalIndex || 0) - 1);
	        });
	        if (nextBtn) nextBtn.addEventListener('click', (event) => {
	            event.stopPropagation();
	            this.setRealestateModalIndex((this.realestateModalIndex || 0) + 1);
	        });
        if (sellerBtn && !sellerBtn.dataset.bound) {
            sellerBtn.addEventListener('click', () => {
                this.openSellerProfileFromRealestate();
            });
            sellerBtn.dataset.bound = '1';
        }
	        modal.addEventListener('click', (event) => {
	            if (event.target === modal) doClose();
	        });
        document.addEventListener('keydown', (event) => {
            if (modal.classList.contains('hidden')) return;
            if (event.key === 'Escape') doClose();
        });
        modal.dataset.bound = '1';
    }

		    applyHomeFilters({ scrollToResults = false } = {}) {
		        const normalizeText = (value) => String(value || '')
		            .toLowerCase()
	            .replace(/[^a-z0-9]+/g, ' ')
	            .trim()
	            .replace(/\s+/g, ' ');
	        const rawQuery = document.getElementById('home-search-what')?.value || '';
	        const query = normalizeText(rawQuery);
	        const tokens = query ? query.split(' ').filter(Boolean) : [];

	        const rawLocation = document.getElementById('home-search-location')?.value || '';
	        const locationQuery = normalizeText(rawLocation);

	        const catGlobal = document.getElementById('global-category-select')?.value || '';
	        const catSearch = document.getElementById('home-search-category')?.value || '';
		        const catTop = document.getElementById('home-top-category')?.value || '';
		        const catSide = document.getElementById('home-filter-category')?.value || '';
		        const rawCategory = catGlobal || catSide || catSearch || catTop || '';
		        this.syncHomeCategoryNav(rawCategory);
		        const category = ['buy_sell', 'jobs', 'other'].includes(rawCategory) ? '' : rawCategory;

	        const minPrice = parseFloat(document.getElementById('home-filter-price-min')?.value);
	        const maxPrice = parseFloat(document.getElementById('home-filter-price-max')?.value);
	        const dateFilter = document.getElementById('home-filter-date')?.value || 'all';

	        const synonymMap = {
	            shoes: ['shoes', 'shoe', 'sneakers', 'sneaker', 'footwear', 'kicks', 'slides', 'boots'],
	            shoe: ['shoes', 'shoe', 'sneakers', 'sneaker', 'footwear', 'kicks', 'slides', 'boots'],
	            sneakers: ['sneakers', 'sneaker', 'shoes', 'shoe', 'footwear', 'kicks'],
	            sneaker: ['sneakers', 'sneaker', 'shoes', 'shoe', 'footwear', 'kicks'],
	            cars: ['cars', 'car', 'vehicle', 'vehicles', 'auto', 'automobile'],
	            car: ['cars', 'car', 'vehicle', 'vehicles', 'auto', 'automobile'],
	            vehicles: ['vehicles', 'vehicle', 'cars', 'car', 'auto', 'automobile'],
	            vehicle: ['vehicles', 'vehicle', 'cars', 'car', 'auto', 'automobile']
	        };
	        const expandToken = (token) => {
	            const t = String(token || '').trim().toLowerCase();
	            if (!t) return [];
	            if (synonymMap[t]) return synonymMap[t];
	            if (t.endsWith('s') && synonymMap[t.slice(0, -1)]) return synonymMap[t.slice(0, -1)];
	            return [t];
	        };
            const scoreQueryMatch = (haystackParts) => {
                if (!tokens.length) return { matched: true, score: 0 };
                const text = normalizeText(
                    (Array.isArray(haystackParts) ? haystackParts : [haystackParts])
                        .filter(Boolean)
                        .join(' ')
                );
                if (!text) return { matched: false, score: 0 };
                let matchedCount = 0;
                tokens.forEach((token) => {
                    const found = expandToken(token).some((alt) => alt && text.includes(alt));
                    if (found) matchedCount += 1;
                });
                return { matched: matchedCount > 0, score: matchedCount };
            };

	        const results = [];
	        (this.marketplaceItems || []).forEach((item) => {
	            results.push({
	                type: 'marketplace',
	                id: String(item.id),
	                title: item.title || '',
	                priceText: Number.isFinite(item.price) ? `$${item.price}` : String(item.price || ''),
	                priceValue: Number.isFinite(item.price) ? item.price : null,
	                city: item.city || '',
	                country: item.country || '',
	                locationLabel: [item.city, item.country].filter(Boolean).join(', ') || item.city || '',
	                searchHints: [],
	                imageUrl: item.images?.[0] || '',
	                postedAt: item.postedDate,
	                raw: item
	            });
	        });
	        (this.vehicleListings || []).forEach((vehicle) => {
	            results.push({
	                type: 'vehicle',
	                id: String(vehicle.id),
	                title: vehicle.title || '',
	                priceText: vehicle.price || '',
	                priceValue: Number.isFinite(vehicle.priceValue) ? vehicle.priceValue : null,
	                city: vehicle.city || '',
	                country: vehicle.country || '',
	                locationLabel: [vehicle.city, vehicle.country].filter(Boolean).join(', ') || vehicle.city || '',
	                searchHints: ['car', 'cars', 'vehicle', 'vehicles', 'auto', 'automobile'],
	                imageUrl: vehicle.images?.[0] || vehicle.image || '',
	                postedAt: vehicle.date,
	                raw: vehicle
	            });
	        });
	        (this.realestateListings || []).forEach((listing) => {
	            results.push({
	                type: 'realestate',
	                id: String(listing.id),
	                title: listing.title || '',
	                priceText: listing.price || '',
	                priceValue: null,
	                city: listing.city || '',
	                country: listing.country || '',
	                locationLabel: [listing.city, listing.country].filter(Boolean).join(', ') || listing.city || '',
	                searchHints: ['home', 'homes', 'house', 'houses', 'apartment', 'apartments', 'condo', 'condos', 'property', 'properties', 'real estate', 'realestate'],
	                imageUrl: listing.images?.[0] || '',
	                postedAt: listing.date,
	                raw: listing
	            });
	        });
	        (this.serviceProfiles || []).forEach((service) => {
	            results.push({
	                type: 'service',
	                id: String(service.id),
	                title: service.title || '',
	                priceText: service.price || '',
	                priceValue: null,
	                city: service.city || '',
	                country: service.country || '',
	                locationLabel: [service.city, service.country].filter(Boolean).join(', ') || service.city || '',
	                searchHints: ['service', 'services'],
	                imageUrl: service.photos?.[0] || '',
	                postedAt: service.postedAt,
	                raw: service
	            });
	        });
	        (this.discoveryPosts || []).forEach((post) => {
	            const listing = post.listing || {};
	            const listingType = String(post.listingType || listing.type || '').toLowerCase();
	            const seller = post.seller || post.user || {};
	            const sellerLoc = seller.location || {};
	            const locationLabel = this.buildListingLocationLabel(sellerLoc, post.location);
	            const media = listing.mediaUrl || listing.image || post.mediaUrl || '';
	            results.push({
	                type: 'discovery',
	                id: String(post.id),
	                title: listing.title || '',
	                priceText: this.formatListingPrice(listing, listingType),
	                priceValue: null,
	                city: sellerLoc.city || '',
	                country: sellerLoc.country || '',
	                locationLabel: locationLabel || '',
	                searchHints: ['listing', 'listings', 'marketplace'],
	                imageUrl: media,
	                postedAt: post.timestamp,
	                raw: post
	            });
	        });
	        (this.communityPosts || []).forEach((post) => {
	            const loc = post.location || {};
	            const locationLabel = [loc.city, loc.country].filter(Boolean).join(', ');
	            results.push({
	                type: 'community',
	                id: String(post.id),
	                title: post.title || '',
	                priceText: post.priceText || '',
	                priceValue: null,
	                city: loc.city || '',
	                country: loc.country || '',
	                locationLabel: locationLabel || '',
	                searchHints: ['community', 'event', 'events', 'group', 'groups', 'classes', 'rideshare'],
	                imageUrl: post.image || '',
	                postedAt: post.postedAt,
	                raw: post
	            });
	        });

	        const now = new Date();
	        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
	        const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);
	        const monthAgo = new Date(today); monthAgo.setMonth(today.getMonth() - 1);

	        const filterByCategory = (entry) => {
	            if (!category) return true;
	            if (category === 'vehicles') return entry.type === 'vehicle';
	            if (category === 'real_estate') return entry.type === 'realestate';
	            if (category === 'services') return entry.type === 'service';
	            if (entry.type !== 'marketplace') return false;
	            return String(entry.raw?.category || '') === category;
	        };

	        const intent = {
	            vehicle: tokens.some((t) => expandToken(t).some((alt) => ['car', 'cars', 'vehicle', 'vehicles', 'auto', 'automobile'].includes(alt))),
	            realestate: tokens.some((t) => expandToken(t).some((alt) => ['home', 'homes', 'house', 'houses', 'apartment', 'apartments', 'condo', 'condos', 'property', 'properties', 'real', 'estate', 'realestate'].includes(alt))),
	            service: tokens.some((t) => expandToken(t).some((alt) => ['service', 'services'].includes(alt))),
	            community: tokens.some((t) => expandToken(t).some((alt) => ['community', 'event', 'events', 'group', 'groups', 'classes', 'rideshare'].includes(alt)))
	        };
	        const intentBoost = (entry) => {
	            if (intent.vehicle && entry.type === 'vehicle') return 5;
	            if (intent.realestate && entry.type === 'realestate') return 5;
	            if (intent.service && entry.type === 'service') return 4;
	            if (intent.community && entry.type === 'community') return 3;
	            if (entry.type === 'marketplace') return 2;
	            if (entry.type === 'discovery') return 1;
	            return 0;
	        };

            const filtered = results.filter((entry) => {
                let queryScore = 0;
	            if (!filterByCategory(entry)) return false;

	            const locationText = entry.locationLabel || [entry.city, entry.country].filter(Boolean).join(', ');
	            if (locationQuery && !normalizeText(locationText).includes(locationQuery)) return false;

	            const haystackParts = [
	                entry.title,
	                entry.raw?.description,
	                entry.raw?.meta,
	                entry.raw?.summary,
	                entry.raw?.listing?.summary,
	                entry.raw?.content,
	                entry.raw?.seller,
	                entry.raw?.host,
	                entry.raw?.provider,
	                entry.raw?.brand,
	                entry.raw?.model,
	                entry.raw?.make,
	                entry.raw?.electronicsCategory,
	                entry.raw?.category,
	                entry.raw?.condition,
	                entry.raw?.listing?.condition,
	                entry.raw?.listingType,
	                entry.raw?.when,
	                ...(Array.isArray(entry.searchHints) ? entry.searchHints : []),
	                ...(Array.isArray(entry.raw?.tags) ? entry.raw.tags : [])
	            ];
	            if (Array.isArray(entry.raw?.listing?.tags)) haystackParts.push(...entry.raw.listing.tags);
                if (query) {
                    const { matched, score } = scoreQueryMatch(haystackParts);
                    if (!matched) return false;
                    queryScore = score;
                }

	            if (Number.isFinite(minPrice) && Number.isFinite(entry.priceValue) && entry.priceValue < minPrice) return false;
	            if (Number.isFinite(maxPrice) && Number.isFinite(entry.priceValue) && entry.priceValue > maxPrice) return false;

	            if (dateFilter !== 'all') {
	                const d = entry.postedAt instanceof Date ? entry.postedAt : new Date(entry.postedAt);
	                if (Number.isFinite(d.getTime())) {
	                    if (dateFilter === 'today' && d < today) return false;
	                    if (dateFilter === 'week' && d < weekAgo) return false;
	                    if (dateFilter === 'month' && d < monthAgo) return false;
	                }
	            }
                entry._queryScore = queryScore;
                return true;
            }).sort((a, b) => {
	            const boost = intentBoost(b) - intentBoost(a);
	            if (boost !== 0) return boost;
                const queryScoreDiff = (b._queryScore || 0) - (a._queryScore || 0);
                if (queryScoreDiff !== 0) return queryScoreDiff;
	            const ad = a.postedAt instanceof Date ? a.postedAt : new Date(a.postedAt);
	            const bd = b.postedAt instanceof Date ? b.postedAt : new Date(b.postedAt);
	            const at = Number.isFinite(ad.getTime()) ? ad.getTime() : 0;
	            const bt = Number.isFinite(bd.getTime()) ? bd.getTime() : 0;
                return bt - at;
            });
            filtered.forEach((entry) => delete entry._queryScore);

	        const hasFilters = Boolean(
	            query ||
	            locationQuery ||
	            category ||
	            (Number.isFinite(minPrice)) ||
	            (Number.isFinite(maxPrice)) ||
	            (dateFilter && dateFilter !== 'all')
	        );
	        this.renderHomeListings(filtered, { hasFilters });
	        if (scrollToResults) {
	            document.querySelector('#home-content .home-listings')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
	        }
	    }

	    renderHomeListings(items, { hasFilters = false } = {}) {
	        const grid = document.getElementById('home-listings-grid');
	        const count = document.getElementById('home-listing-count');
        const title = document.getElementById('home-results-title');
        if (!grid) return;
        if (count) count.textContent = `${items.length} items`;
        if (title) title.textContent = hasFilters ? 'Search Results' : 'Recent Listings';

        if (items.length === 0) {
            grid.innerHTML = `
                <div class="no-items" style="grid-column:1/-1;">
                    <i class="fas fa-box-open" style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem;"></i>
                    <h3>No listings found</h3>
                    <p>Try different keywords or filters.</p>
                </div>`;
            return;
        }

	        const fallbackImg = 'https://via.placeholder.com/600x420/ebeef5/111827?text=Listing';
	        grid.innerHTML = items.map((it) => {
	            const type = String(it.type || 'marketplace');
	            const typeLabel = (() => {
	                if (type === 'vehicle') return 'Vehicles';
	                if (type === 'realestate') return 'Real Estate';
	                if (type === 'service') return 'Services';
	                if (type === 'discovery') return 'Marketplace';
	                if (type === 'community') return 'Community';
	                const category = String(it.raw?.category || '');
	                return this.marketplaceCategoryLabel(category);
	            })();
	            const title = this.escapeHtml(String(it.title || 'Listing'));
	            const priceText = this.escapeHtml(String(it.priceText || ''));
	            const locationTextRaw = [typeLabel, it.locationLabel || [it.city, it.country].filter(Boolean).join(', ')].filter(Boolean).join('  ');
	            const locationText = this.escapeHtml(locationTextRaw);
	            const img = this.escapeHtml(String(it.imageUrl || fallbackImg));
	            return `
	                <div class="home-card-item" data-type="${this.escapeHtml(String(it.type || 'marketplace'))}" data-id="${this.escapeHtml(String(it.id || ''))}">
	                    <img class="home-card-img" src="${img}" alt="${title}">
	                    <div class="home-card-body">
	                        <div class="home-card-title">${title}</div>
	                        <div class="home-card-price">${priceText}</div>
	                        <div class="home-card-loc">${locationText}</div>
	                    </div>
	                </div>`;
	        }).join('');

	        grid.querySelectorAll('.home-card-item').forEach(card => {
	            card.addEventListener('click', () => {
	                const type = card.dataset.type || 'marketplace';
	                const id = card.dataset.id || '';
	                if (type === 'vehicle') {
	                    this.openVehicleListingModal(id);
	                    return;
	                }
	                if (type === 'realestate') {
	                    this.openRealestateModalById(id);
	                    return;
	                }
	                if (type === 'service') {
	                    const service = (this.serviceProfiles || []).find(entry => String(entry.id) === String(id));
	                    if (service) this.openServiceModal(service);
	                    return;
	                }
	                if (type === 'discovery') {
	                    const post = (this.discoveryPosts || []).find(entry => String(entry.id) === String(id));
	                    if (post) this.openDiscoveryListing(post);
	                    return;
	                }
	                if (type === 'community') {
	                    const post = (this.communityPosts || []).find(entry => String(entry.id) === String(id));
	                    if (!post) return;
	                    const loc = post.location || {};
	                    const locationLabel = [loc.city, loc.country].filter(Boolean).join(', ');
	                    const meta = {
	                        bio: post.summary || '',
	                        location: locationLabel,
	                        date: post.when || '',
	                        specs: post.priceText || '',
	                        tags: Array.isArray(post.tags) ? post.tags : []
	                    };
	                    const title = post.title || 'Community';
	                    const image = post.image || '';
	                    if (image) {
	                        this.openMediaLightbox([{ src: image, label: title, type: 'image', meta }], title, 0);
	                    } else {
	                        this.showNotification(title);
	                    }
	                    return;
	                }
	                const numericId = Number(id);
	                if (Number.isFinite(numericId)) this.showItemDetails(numericId);
	            });
	        });
	    }

    loadDiscoveryFeed() {
        const filter = this.activeDiscoveryFilter || 'all';
        this.syncGeoFilterControls();
        this.syncGeoSearchInputs();
        this.filterDiscoveryPosts(filter);
    }

    filterDiscoveryPosts(filter = 'all') {
        this.activeDiscoveryFilter = filter || 'all';
        this.updateDiscoveryFilterButtons(this.activeDiscoveryFilter);

        const lowerFilter = this.activeDiscoveryFilter;
        let filtered = this.discoveryPosts.filter(post => {
            if (!post) return false;
            const normalizedType = (post.listingType || post.listing?.type || '').toLowerCase();
            const listingFilters = ['sale', 'free', 'trade', 'rent', 'service'];
            if (listingFilters.includes(lowerFilter)) {
                return normalizedType === lowerFilter;
            }
            if (lowerFilter === 'online') {
                return post.isOnline === true || post.user?.online === true;
            }
            return true;
        });

        filtered = this.applyGeoFilters(filtered);
        filtered = this.applyGeoSearchFilters(filtered);
        this.filteredPosts = filtered;
        this.renderDiscoveryPosts(filtered);
    }

    updateDiscoveryFilterButtons(active) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const btnFilter = btn.dataset.filter || 'all';
            btn.classList.toggle('active', btnFilter === active);
        });
    }

    handleGeoFilterSelection(mode = 'worldwide') {
        if (!mode) mode = 'worldwide';
        this.discoveryGeoFilter = mode;
        if (mode === 'country') {
            const searchCountry = (this.discoveryCountrySearch || '').trim();
            if (searchCountry) {
                this.discoveryCountryFilter = searchCountry;
            } else if (!this.discoveryCountryFilter) {
                this.discoveryCountryFilter = this.currentUser?.location?.country || '';
            }
        }
        this.syncGeoFilterControls();
        this.filterDiscoveryPosts(this.activeDiscoveryFilter);
    }

    handleGeoSearchInput(type, value = '') {
        const normalized = (value || '').trim();
        if (type === 'city') {
            this.discoveryCitySearch = normalized;
        } else if (type === 'country') {
            this.discoveryCountrySearch = normalized;
        }
        this.filterDiscoveryPosts(this.activeDiscoveryFilter);
    }

    syncGeoFilterControls() {
        document.querySelectorAll('.geo-filter-btn').forEach(btn => {
            const mode = btn.dataset.geo || 'worldwide';
            btn.classList.toggle('active', mode === this.discoveryGeoFilter);
        });
    }

    syncGeoSearchInputs() {
        const cityInput = document.getElementById('geo-search-city');
        if (cityInput && cityInput.value !== this.discoveryCitySearch) {
            cityInput.value = this.discoveryCitySearch;
        }
        const countryInput = document.getElementById('geo-search-country');
        if (countryInput && countryInput.value !== this.discoveryCountrySearch) {
            countryInput.value = this.discoveryCountrySearch;
        }
    }

    applyGeoFilters(posts = []) {
        const mode = this.discoveryGeoFilter || 'worldwide';
        if (mode === 'worldwide') return posts;
        if (mode === 'nearby') {
            return posts.filter(post => {
                const location = this.getPostLocation(post);
                return location && typeof location.distance === 'number' && location.distance <= this.nearbyDistanceThreshold;
            });
        }
        if (mode === 'country') {
            const selectedCountry = (this.discoveryCountryFilter || '').toLowerCase();
            if (!selectedCountry) return posts;
            return posts.filter(post => {
                const location = this.getPostLocation(post);
                return location?.country && location.country.toLowerCase() === selectedCountry;
            });
        }
        return posts;
    }

    applyGeoSearchFilters(posts = []) {
        const cityTerm = (this.discoveryCitySearch || '').toLowerCase();
        const countryTerm = (this.discoveryCountrySearch || '').toLowerCase();
        if (!cityTerm && !countryTerm) return posts;
        return posts.filter(post => {
            const location = this.getPostLocation(post);
            const cityValue = (location?.city || '').toLowerCase();
            const countryValue = (location?.country || '').toLowerCase();
            const combinedLabel = [location?.city, location?.country].filter(Boolean).join(', ').toLowerCase();

            const matchesCity = cityTerm ? (cityValue.includes(cityTerm) || combinedLabel.includes(cityTerm)) : true;
            const matchesCountry = countryTerm ? (countryValue.includes(countryTerm) || combinedLabel.includes(countryTerm)) : true;
            return matchesCity && matchesCountry;
        });
    }

    renderDiscoveryPosts(posts) {
        const container = document.getElementById('discovery-posts');
        if (!container) return;

        if (!posts || posts.length === 0) {
            container.innerHTML = `
                <div class="no-posts">
                    <i class="fas fa-rss" style="font-size:2rem;opacity:0.35;margin-bottom:0.5rem;"></i>
                    <h3>No activity yet</h3>
                    <p>Share an update to appear here.</p>
                </div>`;
            return;
        }

	        container.innerHTML = posts.map((post, index) => {
	            const seller = post.seller || post.user || {};
	            const avatar = seller.avatar || seller.photo || 'https://via.placeholder.com/80x80/ccd5f6/1f2937?text=HS';
	            const name = seller.name || 'Global Member';
	            const online = post.isOnline === true || seller.online === true;
	            const timestamp = post.timestamp instanceof Date ? post.timestamp : new Date(post.timestamp);
	            const timeAgo = this.formatRelativeTime(timestamp);
                const isAboveFold = index === 0;
	            const listing = post.listing || {};
	            const listingType = (post.listingType || listing.type || 'sale').toLowerCase();
	            const badge = this.getListingTypeMeta(listingType);
	            const location = this.buildListingLocationLabel(seller.location, post.location);
	            const priceText = this.formatListingPrice(listing, listingType);
	            const summary = listing.summary || post.content || '';
	            const safeSummary = this.escapeHtml(summary).replace(/\n/g, '<br>');
	            const postKey = (post.id ?? index).toString();
	            const postElementId = `post-${postKey}`;
	            const sellerIdAttr = this.escapeHtml(String(post.id ?? postKey));
                const mediaSources = Array.isArray(listing.media) ? listing.media.filter(Boolean)
                    : (Array.isArray(post.media) ? post.media.filter(Boolean) : []);
	            const mediaUrl = mediaSources[0] || listing.mediaUrl || listing.image || post.mediaUrl || '';
	            const tags = Array.isArray(listing.tags) && listing.tags.length ? listing.tags
	                : (Array.isArray(post.tags) ? post.tags : []);
	            const tagsHtml = tags.length
	                ? `<div class="listing-tags">${tags.map(tag => `<span>${this.escapeHtml(String(tag))}</span>`).join('')}</div>`
	                : '';
	            const highlightParts = [
	                listing.specs ? `<span><i class="fas fa-list"></i>${this.escapeHtml(String(listing.specs))}</span>` : '',
	                listing.condition ? `<span><i class="fas fa-award"></i>${this.escapeHtml(String(listing.condition))}</span>` : '',
	                listing.availability ? `<span><i class="fas fa-clock"></i>${this.escapeHtml(String(listing.availability))}</span>` : '',
	                listing.fulfillment ? `<span><i class="fas fa-shipping-fast"></i>${this.escapeHtml(String(listing.fulfillment))}</span>` : ''
	            ].filter(Boolean).join('');
	            const highlightsHtml = highlightParts ? `<div class="listing-highlights">${highlightParts}</div>` : '';
                const mediaCountBadge = mediaSources.length > 1
                    ? `<div class="listing-media-count" aria-hidden="true">${mediaSources.length} photos</div>`
                    : '';
	                const mediaCarousel = mediaSources.length > 1
	                    ? `
	                        <div class="listing-media image-carousel" aria-label="Listing photos">
	                            <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>
	                            <div class="carousel-track">
	                                ${mediaSources.map((src, idx) => `
	                                    <img src="${src}" alt="${this.escapeHtml(listing.title || name + ' listing')} photo ${idx + 1}" loading="${isAboveFold && idx === 0 ? 'eager' : 'lazy'}" fetchpriority="${isAboveFold && idx === 0 ? 'high' : 'auto'}" draggable="false" data-index="${idx}">
	                                `).join('')}
	                            </div>
	                            <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>
	                            ${mediaCountBadge}
	                        </div>
	                    `
	                    : '';
	            const mediaHtml = mediaUrl
	                ? (mediaCarousel || `<div class="listing-media"><img src="${mediaUrl}" alt="${this.escapeHtml(listing.title || name + ' listing')}" loading="${isAboveFold ? 'eager' : 'lazy'}" fetchpriority="${isAboveFold ? 'high' : 'auto'}">${mediaCountBadge}</div>`)
	                : '';
	            const sellerStats = seller.stats ? `<span class="seller-stat-pill">${this.escapeHtml(String(seller.stats))}</span>` : '';
	            const labelLocation = location ? `<span class="post-location"><i class="fas fa-map-marker-alt"></i>${this.escapeHtml(location)}</span>` : '';
	            const likes = typeof post.likes === 'number' ? post.likes : 0;
	            const comments = typeof post.comments === 'number' ? post.comments : 0;

	            return `
	                <article class="discovery-post listing" id="${postElementId}" data-type="${listingType}" data-discovery-id="${sellerIdAttr}">
	                    <div class="post-header">
                        <img src="${avatar}" alt="${this.escapeHtml(name)}" class="post-user-avatar" loading="lazy">
                        <div class="post-user-info">
                            <div class="post-user-name">
                                <button class="seller-name-link" type="button" data-seller-source="discovery" data-seller-id="${sellerIdAttr}" aria-label="View ${this.escapeHtml(name)} profile">${this.escapeHtml(name)}</button>
                                ${online ? '<span class="online-indicator"><i class="fas fa-circle"></i> Live now</span>' : ''}
                            </div>
                            <div class="post-meta">
                                <span>${timeAgo}</span>
                                ${labelLocation}
                            </div>
                        </div>
                        <div class="post-header-meta">
                            ${sellerStats}
                            <button class="post-menu-btn" type="button" aria-label="More options">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                    <div class="listing-layout">
                        ${mediaHtml}
                        <div class="listing-details">
                            <div class="listing-type-badge ${badge.className}"><i class="${badge.icon}"></i>${badge.label}</div>
                            <h4 class="listing-title">${this.escapeHtml(listing.title || 'Untitled listing')}</h4>
                            <p class="listing-price">${this.escapeHtml(priceText)}</p>
                            <p class="listing-summary">${safeSummary}</p>
                            ${highlightsHtml}
                            ${tagsHtml}
                        </div>
                    </div>
                    <div class="post-actions">
                        <button class="post-action-btn like-btn" type="button" title="Save listing">
                            <i class="fas fa-bookmark"></i><span>${likes}</span>
                        </button>
                        <button class="post-action-btn comment-btn" type="button" title="Send inquiry">
                            <i class="fas fa-paper-plane"></i><span>Inquire</span>
                        </button>
                        <button class="post-action-btn seller-profile-btn" type="button" title="View seller profile" aria-label="View ${this.escapeHtml(name)} profile">
                            <i class="fas fa-user"></i><span>Seller</span>
                        </button>
                    </div>
                </article>`;
        }).join('');

	        container.querySelectorAll('.like-btn').forEach((btn, idx) => {
	            btn.addEventListener('click', () => {
	                const post = posts[idx];
	                if (!post) return;
	                post.likes = (post.likes || 0) + 1;
	                btn.querySelector('span').textContent = post.likes;
	            });
	        });

            const findPostByCard = (el) => {
                const card = el?.closest?.('.discovery-post');
                const postId = card?.dataset?.discoveryId || '';
                if (!postId) return null;
                let match = posts.find((p) => String(p?.id ?? '') === String(postId)) || null;
                if (!match && /^\d+$/.test(postId)) {
                    const idx = Number(postId);
                    if (Number.isFinite(idx)) match = posts[idx] || null;
                }
                return match;
            };

            container.querySelectorAll('.listing-media.image-carousel').forEach((carousel) => {
                if (carousel.dataset.bound) return;
                const track = carousel.querySelector('.carousel-track');
                const prev = carousel.querySelector('.carousel-btn.prev');
                const next = carousel.querySelector('.carousel-btn.next');
                const post = findPostByCard(carousel);
                if (!post || !track) return;

                const scrollBy = (dir) => track.scrollBy({ left: dir * track.clientWidth, behavior: 'smooth' });
                if (prev) {
                    prev.addEventListener('click', (event) => {
                        event.stopPropagation();
                        scrollBy(-1);
                    });
                }
                if (next) {
                    next.addEventListener('click', (event) => {
                        event.stopPropagation();
                        scrollBy(1);
                    });
                }
                track.addEventListener('pointerdown', (event) => event.stopPropagation());
                track.addEventListener('click', (event) => event.stopPropagation());
                track.querySelectorAll('img').forEach((img) => {
                    img.addEventListener('click', () => {
                        const idx = parseInt(img.dataset.index || '0', 10);
                        this.openDiscoveryListing(post, Number.isFinite(idx) ? idx : 0);
                    });
                });

                carousel.dataset.bound = '1';
            });

            container.querySelectorAll('.listing-media:not(.image-carousel)').forEach((mediaEl) => {
                if (mediaEl.dataset.boundSingle) return;
                mediaEl.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const post = findPostByCard(mediaEl);
                    if (!post) return;
                    this.openDiscoveryListing(post, 0);
                });
                mediaEl.dataset.boundSingle = '1';
            });

            container.querySelectorAll('.listing-title').forEach((titleEl) => {
                titleEl.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const post = findPostByCard(titleEl);
                    if (!post) return;
                    this.openDiscoveryListing(post);
                });
            });

	        container.querySelectorAll('.comment-btn').forEach((btn, idx) => {
	            btn.addEventListener('click', () => {
	                const post = posts[idx];
	                if (!post) return;
	                this.openDiscoveryChat(post);
	            });
	        });

	        container.querySelectorAll('.seller-profile-btn').forEach(btn => {
	            btn.addEventListener('click', () => {
	                const card = btn.closest('.discovery-post');
	                const postId = card?.dataset.discoveryId || '';
	                if (!postId) return;
	                this.openSellerProfileFromDiscovery(postId);
	            });
	        });

            container.querySelectorAll('.post-user-avatar').forEach((img) => {
                if (img.dataset.boundProfile) return;
                img.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const post = findPostByCard(img);
                    if (!post) return;
                    const card = img.closest('.discovery-post');
                    const fallbackPostId = card?.dataset?.discoveryId || '';
                    this.openSellerProfileFromDiscovery(post.id ?? fallbackPostId);
                });
                img.style.cursor = 'pointer';
                img.dataset.boundProfile = '1';
            });

	        container.querySelectorAll('.seller-name-link').forEach(btn => {
	            btn.addEventListener('click', (event) => {
	                event.stopPropagation();
	                const postId = btn.dataset.sellerId || '';
                if (!postId) return;
                this.openSellerProfileFromDiscovery(postId);
            });
        });
    }

    loadCommunity() {
        this.bindCommunityControls();
        this.updateCommunityCategoryButtons();
        this.updateCommunityFiltersFromInputs();
        this.filterCommunityPosts();
    }

    bindCommunityControls() {
        const chips = document.querySelectorAll('.community-chip');
        chips.forEach((chip) => {
            if (chip.dataset.bound) return;
            chip.addEventListener('click', () => {
                this.activeCommunityCategory = chip.dataset.community || 'all';
                this.updateCommunityCategoryButtons();
                this.filterCommunityPosts();
            });
            chip.dataset.bound = '1';
        });

        const applyBtn = document.getElementById('community-apply-filters');
        if (applyBtn && !applyBtn.dataset.bound) {
            applyBtn.addEventListener('click', () => {
                this.updateCommunityFiltersFromInputs();
                this.filterCommunityPosts();
            });
            applyBtn.dataset.bound = '1';
        }

        const searchInput = document.getElementById('community-search');
        if (searchInput && !searchInput.dataset.boundEnter) {
            searchInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                this.updateCommunityFiltersFromInputs();
                this.filterCommunityPosts();
            });
            searchInput.dataset.boundEnter = '1';
        }
        const countryInput = document.getElementById('community-country');
        if (countryInput && !countryInput.dataset.boundEnter) {
            countryInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                this.updateCommunityFiltersFromInputs();
                this.filterCommunityPosts();
            });
            countryInput.dataset.boundEnter = '1';
        }
        const cityInput = document.getElementById('community-city');
        if (cityInput && !cityInput.dataset.boundEnter) {
            cityInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                this.updateCommunityFiltersFromInputs();
                this.filterCommunityPosts();
            });
            cityInput.dataset.boundEnter = '1';
        }
    }

    updateCommunityFiltersFromInputs() {
        const searchValue = (document.getElementById('community-search')?.value || '').trim();
        const countryValue = (document.getElementById('community-country')?.value || '').trim();
        const cityValue = (document.getElementById('community-city')?.value || '').trim();
        const nearMe = Boolean(document.getElementById('community-near-me')?.checked);
        this.communityFilters = {
            ...(this.communityFilters || {}),
            search: searchValue,
            country: countryValue,
            city: cityValue,
            nearMe
        };
    }

    updateCommunityCategoryButtons() {
        const active = this.activeCommunityCategory || 'all';
        document.querySelectorAll('.community-chip').forEach((btn) => {
            const key = btn.dataset.community || 'all';
            btn.classList.toggle('active', key === active);
        });
    }

    getCommunityCategoryLabel(key) {
        const map = {
            all: 'Community',
            classes_lessons: 'Classes & Lessons',
            other: 'Other',
            rideshare: 'Rideshare',
            activities_groups: 'Activities & Groups',
            events: 'Events',
            volunteers: 'Volunteers',
            lost_found: 'Lost & Found',
            business_networking: 'Business & Networking',
            travel: 'Travel'
        };
        return map[key] || 'Community';
    }

    getCommunityCategoryDescription(key) {
        const map = {
            all: 'Latest posts from across the community.',
            classes_lessons: 'Workshops, lessons, and local classes near you.',
            other: 'Miscellaneous requests and neighborhood posts.',
            rideshare: 'Ride shares, airport runs, and local pickups.',
            activities_groups: 'Social groups, meetups, and shared activities.',
            events: 'Upcoming events, pop-ups, and gatherings.',
            volunteers: 'Volunteer opportunities and community support.',
            lost_found: 'Help reunite items with their owners.',
            business_networking: 'Networking, coworking, and founder meetups.',
            travel: 'Travel plans, swaps, and itinerary shares.'
        };
        return map[key] || map.all;
    }

    getCommunityPostLocation(post) {
        if (!post) return null;
        const location = post.location || {};
        if (typeof location === 'string') return this.buildLocationFromInput(location);
        if (typeof location === 'object') return this.ensureLocationDistance(location);
        return null;
    }

    buildCommunityLocationLabel(location) {
        if (!location) return '';
        const parts = [location.city, location.country].filter(Boolean);
        return parts.join(', ');
    }

    filterCommunityPosts() {
        const category = this.activeCommunityCategory || 'all';
        const filters = this.communityFilters || {};
        const searchTerm = (filters.search || '').toLowerCase();
        const countryTerm = (filters.country || '').toLowerCase();
        const cityTerm = (filters.city || '').toLowerCase();
        const nearMe = Boolean(filters.nearMe);

        let filtered = (this.communityPosts || []).filter((post) => {
            if (!post) return false;
            if (category !== 'all' && post.category !== category) return false;
            return true;
        });

        if (searchTerm) {
            filtered = filtered.filter((post) => {
                const location = this.getCommunityPostLocation(post);
                const haystack = [
                    post.title,
                    post.summary,
                    post.host,
                    this.getCommunityCategoryLabel(post.category),
                    ...(Array.isArray(post.tags) ? post.tags : []),
                    location?.city,
                    location?.country
                ]
                    .filter(Boolean)
                    .join(' ')
                    .toLowerCase();
                return haystack.includes(searchTerm);
            });
        }

        if (countryTerm) {
            filtered = filtered.filter((post) => {
                const location = this.getCommunityPostLocation(post);
                return (location?.country || '').toLowerCase().includes(countryTerm);
            });
        }

        if (cityTerm) {
            filtered = filtered.filter((post) => {
                const location = this.getCommunityPostLocation(post);
                const city = (location?.city || '').toLowerCase();
                const combined = [location?.city, location?.country].filter(Boolean).join(', ').toLowerCase();
                return city.includes(cityTerm) || combined.includes(cityTerm);
            });
        }

        if (nearMe) {
            filtered = filtered.filter((post) => {
                const location = this.getCommunityPostLocation(post);
                return location && typeof location.distance === 'number'
                    && location.distance <= this.nearbyDistanceThreshold;
            });
        }

        this.filteredCommunityPosts = filtered;
        this.updateCommunityFeedMeta(filtered);
        this.renderCommunityPosts(filtered);
    }

    updateCommunityFeedMeta(posts = []) {
        const category = this.activeCommunityCategory || 'all';
        const headingText = this.getCommunityCategoryLabel(category);
        const descriptionText = this.getCommunityCategoryDescription(category);
        const countText = `${posts.length} ${posts.length === 1 ? 'post' : 'posts'}`;

        const headingEls = [
            document.getElementById('community-page-heading'),
            document.getElementById('community-feed-heading')
        ];
        headingEls.forEach((el) => {
            if (el) el.textContent = headingText;
        });
        const descEls = [
            document.getElementById('community-page-description'),
            document.getElementById('community-feed-description')
        ];
        descEls.forEach((el) => {
            if (el) el.textContent = descriptionText;
        });

        const countEls = [
            document.getElementById('community-page-count'),
            document.getElementById('community-feed-count')
        ];
        countEls.forEach((el) => {
            if (el) el.textContent = countText;
        });

        const dateEl = document.getElementById('community-page-date');
        if (dateEl) {
            const latest = posts.reduce((acc, post) => {
                const date = post?.postedAt instanceof Date ? post.postedAt : new Date(post?.postedAt);
                if (!(date instanceof Date) || Number.isNaN(date.getTime())) return acc;
                if (!acc || date > acc) return date;
                return acc;
            }, null);
            dateEl.textContent = latest ? this.formatFeedHeaderDate(latest) : 'No posts';
        }
    }

    renderCommunityPosts(posts) {
        this.renderCommunityFeedList('community-page-feed', posts);
        this.renderCommunityFeedList('community-feed-list', posts);
    }

    renderCommunityFeedList(containerId, posts) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!posts || posts.length === 0) {
            container.innerHTML = `
                <div class="no-posts">
                    <i class="fas fa-users" style="font-size:2rem;opacity:0.35;margin-bottom:0.5rem;"></i>
                    <h3>No community posts yet</h3>
                    <p>Try a different category or check back soon.</p>
                </div>`;
            return;
        }

        container.innerHTML = posts.map((post) => this.renderCommunityFeedCard(post)).join('');

        container.querySelectorAll('.community-feed-card').forEach((card) => {
            if (card.dataset.boundCommunityPopup) return;
            const open = () => {
                const id = card.dataset.communityPostId || '';
                this.openCommunityPostMarketplaceModal(id);
            };
            card.addEventListener('click', open);
            card.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                e.preventDefault();
                open();
            });
            card.dataset.boundCommunityPopup = '1';
        });
    }

    renderCommunityFeedCard(post) {
        const title = this.escapeHtml(String(post?.title || 'Community post'));
        const summary = this.escapeHtml(String(post?.summary || ''));
        const categoryLabel = this.escapeHtml(this.getCommunityCategoryLabel(post?.category));
        const image = post?.image || 'https://via.placeholder.com/900x650/ebeef5/111827?text=Community';
        const location = this.getCommunityPostLocation(post);
        const locationLabel = this.escapeHtml(this.buildCommunityLocationLabel(location));
        const when = post?.when ? this.escapeHtml(String(post.when)) : '';
        const priceText = post?.priceText ? this.escapeHtml(String(post.priceText)) : '';
        const host = post?.host ? String(post.host) : '';
        const postedAt = post?.postedAt instanceof Date ? post.postedAt : new Date(post?.postedAt);
        const updatedLabel = this.formatRelativeTime(postedAt);
        const tags = Array.isArray(post?.tags) ? post.tags : [];
        const tagsHtml = tags.length
            ? `<div class="community-feed-tags">${tags.map(tag => `<span>${this.escapeHtml(String(tag))}</span>`).join('')}</div>`
            : '';
        const detailParts = [
            locationLabel ? `<span><i class="fas fa-map-marker-alt"></i>${locationLabel}</span>` : '',
            when ? `<span><i class="fas fa-calendar"></i>${when}</span>` : '',
            priceText ? `<span><i class="fas fa-tag"></i>${priceText}</span>` : ''
        ].filter(Boolean).join('');
        const detailsHtml = detailParts ? `<div class="community-feed-details">${detailParts}</div>` : '';
        const statusParts = [
            host ? `Hosted by ${host}` : '',
            updatedLabel ? `Updated ${updatedLabel}` : ''
        ].filter(Boolean);
        const statusHtml = statusParts.length
            ? `<div class="community-feed-status">${this.escapeHtml(statusParts.join(' 路 '))}</div>`
            : '';

        return `
            <article class="community-feed-card" role="listitem" tabindex="0" data-community-post-id="${this.escapeHtml(String(post?.id || ''))}" aria-label="Open ${title}">
                <div class="community-feed-media">
                    <img src="${image}" alt="${title}" loading="lazy">
                    <span class="community-feed-tag">${categoryLabel}</span>
                </div>
                <div class="community-feed-meta">
                    <h4 class="community-feed-title">${title}</h4>
                    <p class="community-feed-summary">${summary}</p>
                    ${detailsHtml}
                    ${tagsHtml}
                    ${statusHtml}
                </div>
            </article>
        `;
    }

    openCommunityPostMarketplaceModal(postId) {
        const key = String(postId || '').trim();
        if (!key) return;
        const list = Array.isArray(this.communityPosts) ? this.communityPosts : [];
        const post = list.find((p) => String(p?.id || '') === key)
            || (Array.isArray(this.filteredCommunityPosts) ? this.filteredCommunityPosts : []).find((p) => String(p?.id || '') === key);
        if (!post) return;

        const location = this.getCommunityPostLocation(post);
        const city = String(location?.city || '').trim();
        const country = String(location?.country || '').trim();
        const categoryLabel = this.getCommunityCategoryLabel(post.category);
        const host = String(post.host || 'Community host').trim();
        const image = post.image || 'https://via.placeholder.com/900x650/ebeef5/111827?text=Community';
        const seededId = Math.abs(this.hashStringToInt(`community:${post.id}`)) || Date.now();

        const pseudoItem = {
            id: seededId,
            source: { type: 'community', id: String(post.id || '') },
            category: 'community',
            condition: categoryLabel || 'Community',
            title: String(post.title || 'Community post'),
            price: String(post.priceText || ''),
            description: String(post.summary || ''),
            city,
            country,
            availability: String(post.when || ''),
            seller: host,
            images: [image],
            tags: Array.isArray(post.tags) ? post.tags : []
        };

        this.openMarketplaceItemModal(pseudoItem);
    }

    openCompanionshipProfileMarketplaceModal(profileId) {
        const key = String(profileId || '').trim();
        if (!key) return;
        const profile = (Array.isArray(this.companionshipProfiles) ? this.companionshipProfiles : []).find((p) => String(p?.id || '') === key);
        if (!profile) return;

        const alias = String(profile.alias || profile.name || 'Profile').trim() || 'Profile';
        const age = Number.isFinite(profile.age) ? profile.age : null;
        const city = String(profile.city || '').trim();
        const country = String(profile.country || '').trim();
        const title = age ? `${alias}, ${age}` : alias;
        const tagline = String(profile.tagline || profile.seeking || '').trim();
        const about = String(profile.description || '').trim();
        const safety = '18+ only. No escorting, sexual services, or paid arrangements.';
        const descriptionParts = [tagline, about, safety].filter(Boolean);
        const status = profile.online ? 'Online now' : String(profile.lastActive || 'Recently active');
        const postedAt = profile.postedAt instanceof Date ? profile.postedAt : null;
        const postedLabel = postedAt ? this.formatRelativeTime(postedAt) : '';
        const availability = [status, postedLabel ? `Posted ${postedLabel}` : ''].filter(Boolean).join(' 路 ');

        const images = Array.isArray(profile.photos) && profile.photos.length
            ? profile.photos.filter(Boolean)
            : [profile.photo].filter(Boolean);
        const firstImage = images[0] || 'https://via.placeholder.com/900x650/ebeef5/111827?text=Profile';
        const seededId = Math.abs(this.hashStringToInt(`companionship:${profile.id}`)) || Date.now();
        const tags = [
            profile.premium ? 'Premium' : '',
            String(profile.gender || '').trim(),
            String(profile.serviceCategory || profile.intentCategory || '').trim()
        ].filter(Boolean);

        const pseudoItem = {
            id: seededId,
            source: { type: 'companionship', id: String(profile.id || '') },
            category: 'companionship',
            condition: 'Profile',
            title,
            price: profile.premium ? 'Premium' : 'Companionship',
            description: descriptionParts.join(' 路 '),
            city,
            country,
            availability,
            seller: alias,
            images: images.length ? images : [firstImage],
            video: String(profile.video || '').trim(),
            postedDate: postedAt || undefined,
            tags
        };

        this.openMarketplaceItemModal(pseudoItem);
    }

    normalizeMarketplaceCategory(label) {
        const raw = String(label || '').trim().toLowerCase();
        const map = {
            'real estate': 'real_estate',
            'home & decor': 'home',
            'home & d茅cor': 'home',
            'buy & sell': 'buy_sell'
        };
        if (!raw) return 'other';
        const direct = raw.replace(/\s+/g, '_');
        return map[raw] || map[direct] || direct;
    }

    openHomeFeaturedSellerProfileFromCard(card) {
        if (!card) return;
        const data = this.getLuxuryAdDataFromCard(card);
        if (!data) return;

        const seller = String(data.sellerName || 'Seller').trim() || 'Seller';
        const title = String(data.title || 'Listing').trim() || 'Listing';
        const priceLine = String(data.price || '').trim();
        const location = String(data.location || '').trim();
        const category = String(card.dataset.adCategory || '').trim();
        const ratingValue = Number.isFinite(data.ratingValue) ? data.ratingValue : 4.8;

        const [city, country] = location.includes(',')
            ? location.split(',').map((s) => s.trim())
            : ['', location];

        const seededId = Math.abs(this.hashStringToInt(`home_featured:${seller}:${title}:${location}`)) || Date.now();
        const listingKey = String(seededId);
        const photos = Array.isArray(data.photos) ? data.photos.filter(Boolean) : [];
        const thumb = photos[0] || 'https://via.placeholder.com/120x120/ebeef5/111827?text=Listing';
        const perks = Array.isArray(data.perks) ? data.perks.filter(Boolean) : [];
        const descriptionParts = [
            data.desc ? String(data.desc).trim() : '',
            data.reason ? `Why sponsored: ${String(data.reason).trim()}` : '',
            perks.length ? `Perks: ${perks.join(', ')}` : ''
        ].filter(Boolean);

        const pseudoItem = {
            id: seededId,
            source: { type: 'home_featured', id: listingKey },
            category: this.normalizeMarketplaceCategory(category),
            condition: String(card.dataset.adCondition || '').trim(),
            title,
            price: priceLine,
            description: descriptionParts.join('\n'),
            city,
            country,
            availability: String(card.dataset.adStock || '').trim(),
            seller,
            images: photos.length ? photos : [thumb],
            tags: Array.isArray(data.tags) ? data.tags.filter(Boolean) : []
        };

        if (!this.homeFeaturedItemsByKey) this.homeFeaturedItemsByKey = {};
        this.homeFeaturedItemsByKey[listingKey] = pseudoItem;

        this.openSellerProfileModal({
            name: seller,
            initials: this.getInitials(seller),
            location: location || [city, country].filter(Boolean).join(', '),
            listings: [
                {
                    id: listingKey,
                    title,
                    price: priceLine,
                    location: location || [city, country].filter(Boolean).join(', '),
                    images: photos.slice(0, 3),
                    thumb,
                    source: 'home_featured'
                }
            ],
            ratingValue,
            ratingLabel: this.formatStarRating(String(ratingValue.toFixed(1))),
            reviewCount: 24,
            responseLabel: 'Responds within a day',
            verified: true,
            badgeText: String(data.tier || 'Sponsored'),
            heroImage: thumb,
            heroPillText: location ? 'Featured 路 ' + location : 'Featured',
            galleryImages: photos.length ? photos : [thumb],
            galleryLabel: title,
            bio: descriptionParts[0] || '',
            reviews: [],
            source: { type: 'home_featured', id: listingKey }
        });
    }

    getListingTypeMeta(type) {
        const map = {
            sale: { label: 'For Sale', icon: 'fas fa-tag', className: 'listing-type-sale' },
            free: { label: 'Free', icon: 'fas fa-gift', className: 'listing-type-free' },
            trade: { label: 'Trade', icon: 'fas fa-exchange-alt', className: 'listing-type-trade' },
            rent: { label: 'Rent', icon: 'fas fa-key', className: 'listing-type-rent' },
            service: { label: 'Service', icon: 'fas fa-briefcase', className: 'listing-type-service' }
        };
        return map[type] || map.sale;
    }

    formatListingPrice(listing, listingType) {
        if (!listing) return '';
        if (listing.priceText) return listing.priceText;
        if (listing.price && typeof listing.price.amount === 'number') {
            const currency = listing.price.currency || 'USD';
            const amount = listing.price.amount.toLocaleString(undefined, { maximumFractionDigits: 0 });
            const freq = listing.price.frequency ? ` / ${listing.price.frequency}` : '';
            return `${currency} ${amount}${freq}`;
        }
        switch (listingType) {
            case 'free':
                return 'Free 路 pick up or pay forward';
            case 'trade':
                return 'Open to thoughtful trades';
            case 'rent':
                return 'Rental terms available on request';
            case 'service':
                return 'Service rate available on request';
            default:
                return 'Accepting reasonable offers';
        }
    }

    buildListingLocationLabel(location, fallback) {
        if (typeof fallback === 'string' && fallback.trim()) return fallback;
        if (!location) return '';
        const parts = [];
        if (location.flag) parts.push(location.flag);
        if (location.city) parts.push(location.city);
        if (location.country) parts.push(location.country);
        if (parts.length) return parts.join(' ');
        return '';
    }

    buildUserListingPriceText(type, rawPrice) {
        if (rawPrice && rawPrice.trim()) return rawPrice.trim();
        switch (type) {
            case 'free':
                return 'Free 路 pickup or pay forward';
            case 'trade':
                return 'Open to trades';
            case 'rent':
                return 'Rental terms on request';
            case 'service':
                return 'Service rate on request';
            default:
                return 'Open to offers';
        }
    }

    buildUserFulfillmentText(type, regionLabel) {
        if (type === 'service') return 'Remote-friendly 路 flexible timezone';
        if (type === 'rent') return `Hosts in ${regionLabel}`;
        if (type === 'trade') return `Meetup or insured shipping from ${regionLabel}`;
        if (type === 'free') return `Pickup in ${regionLabel}`;
        return `Ships from ${regionLabel}`;
    }

    getEstimatedDistance(country) {
        if (!country) return 10;
        return this.countryDistanceMap[country] ?? 6000;
    }

    getCountryFlag(country) {
        if (!country) return '';
        return this.countryFlagMap[country] || '';
    }

    parseRegionLabel(regionLabel = '') {
        if (!regionLabel) return { city: '', country: '' };
        const parts = regionLabel.split(',');
        const city = (parts.shift() || '').trim();
        const country = parts.join(',').trim();
        return { city, country };
    }

    buildLocationFromInput(regionLabel) {
        const { city, country } = this.parseRegionLabel(regionLabel);
        return {
            city,
            country,
            flag: this.getCountryFlag(country),
            distance: this.getEstimatedDistance(country)
        };
    }

    ensureLocationDistance(rawLocation = {}) {
        const location = { ...rawLocation };
        if (typeof location.city === 'string' && location.city.includes(',') && !location.country) {
            const parsedCity = this.parseRegionLabel(location.city);
            location.city = parsedCity.city;
            location.country = parsedCity.country;
        }
        if (!location.country && typeof location.name === 'string') {
            const parsedName = this.parseRegionLabel(location.name);
            location.city = location.city || parsedName.city;
            location.country = parsedName.country;
        }
        if (typeof location.distance !== 'number') {
            location.distance = this.getEstimatedDistance(location.country);
        }
        if (!location.flag && location.country) {
            location.flag = this.getCountryFlag(location.country);
        }
        return location;
    }

    getPostLocation(post) {
        if (!post) return null;
        const sources = [post.user?.location, post.seller?.location, post.location];
        for (const source of sources) {
            if (!source) continue;
            if (typeof source === 'string') {
                return this.buildLocationFromInput(source);
            }
            if (typeof source === 'object') {
                return this.ensureLocationDistance(source);
            }
        }
        return null;
    }

    parseTagInput(value) {
        if (!value) return [];
        return value.split(',').map(tag => tag.trim()).filter(Boolean);
    }

    addDiscoveryPostUploads(fileList) {
        if (!fileList) return;
        const maxUploads = Number.isFinite(this.discoveryPostUploadLimit) ? this.discoveryPostUploadLimit : 10;
        const files = Array.from(fileList).filter((f) => f?.type && f.type.startsWith('image/'));
        if (!Array.isArray(this.discoveryPostUploads)) this.discoveryPostUploads = [];
        const startingCount = this.discoveryPostUploads.length;
        files.forEach((file) => {
            if (this.discoveryPostUploads.length >= maxUploads) return;
            const id = `${file.name}-${file.lastModified}-${Math.random().toString(16).slice(2)}`;
            const previewUrl = URL.createObjectURL(file);
            this.discoveryPostUploads.push({ id, name: file.name, size: file.size, src: previewUrl, file });
        });

        const input = document.getElementById('post-media-upload');
        if (input) input.value = '';
        this.renderDiscoveryPostUploads();
        if (startingCount < maxUploads && this.discoveryPostUploads.length >= maxUploads) {
            this.showNotification(`Max ${maxUploads} photos for a post.`);
        }
    }

    removeDiscoveryPostUpload(id) {
        if (!id) return;
        const removed = (this.discoveryPostUploads || []).find((u) => u.id === id);
        if (removed?.src && removed.src.startsWith('blob:')) {
            try { URL.revokeObjectURL(removed.src); } catch {}
        }
        this.discoveryPostUploads = (this.discoveryPostUploads || []).filter((u) => u.id !== id);
        this.renderDiscoveryPostUploads();
    }

    renderDiscoveryPostUploads(previewListEl) {
        const list = previewListEl || document.getElementById('post-media-previews');
        if (!list) return;
        const maxUploads = Number.isFinite(this.discoveryPostUploadLimit) ? this.discoveryPostUploadLimit : 10;
        const uploads = Array.isArray(this.discoveryPostUploads) ? this.discoveryPostUploads : [];
        const meta = document.getElementById('post-media-upload-meta');
        if (meta) meta.textContent = `${uploads.length}/${maxUploads} photos`;
        const input = document.getElementById('post-media-upload');
        if (input) input.disabled = uploads.length >= maxUploads;
        if (!uploads.length) {
            list.innerHTML = '';
            return;
        }
        list.innerHTML = uploads.map((item, idx) => `
            <div class="market-upload-chip" data-id="${item.id}">
                <img src="${item.src}" alt="${this.escapeHtml(item.name)}" loading="lazy">
                <button type="button" class="market-upload-remove" aria-label="Remove ${this.escapeHtml(item.name)}">&times;</button>
                ${idx === 0 ? '<div class="market-upload-primary">Primary</div>' : ''}
            </div>
        `).join('');
    }

    getMyPostsStorageKey() {
        const userId = this.currentUser?.id ?? this.currentUser?.name ?? 'guest';
        return `hs_my_posts:v1:${String(userId)}`;
    }

    loadMyPosts() {
        try {
            const raw = localStorage.getItem(this.getMyPostsStorageKey());
            const parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
        } catch {
            return [];
        }
    }

    saveMyPosts() {
        try {
            localStorage.setItem(this.getMyPostsStorageKey(), JSON.stringify(this.myPosts || []));
        } catch {}
    }

    addMyPost(entry) {
        if (!entry || typeof entry !== 'object') return;
        if (!Array.isArray(this.myPosts)) this.myPosts = [];
        const next = { ...entry };
        if (!next.id) next.id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
        if (!next.createdAt) next.createdAt = Date.now();
        this.myPosts.unshift(next);
        if (this.myPosts.length > 50) this.myPosts = this.myPosts.slice(0, 50);
        this.saveMyPosts();
        if (document.getElementById('profile-content')?.classList.contains('active')) this.renderMyPosts();
    }

    removeMyPost(id) {
        if (!id) return;
        const before = Array.isArray(this.myPosts) ? this.myPosts.length : 0;
        this.myPosts = (this.myPosts || []).filter((p) => String(p?.id) !== String(id));
        if (this.myPosts.length !== before) this.saveMyPosts();
    }

    renderMyPosts() {
        const container = document.getElementById('my-posts-list');
        if (!container) return;
        const posts = Array.isArray(this.myPosts) ? this.myPosts : [];
        if (!posts.length) {
            container.innerHTML = `
                <div class="my-posts-empty">
                    <p><strong>No posts yet.</strong> Create one from Discover or Post Item to see it here.</p>
                </div>`;
            return;
        }
	        container.innerHTML = posts.map((post) => {
	            const kind = String(post.kind || 'post');
	            const title = this.escapeHtml(post.title || 'Untitled');
	            const subtitle = this.escapeHtml(post.subtitle || kind.toUpperCase());
	            const thumbSrc = String(post.thumb || '').trim();
	            const safeThumbSrc = this.escapeHtml(thumbSrc);
	            const thumb = thumbSrc
	                ? `<img class="my-post-thumb" src="${safeThumbSrc}" alt="${title}" loading="lazy">`
	                : `<div class="my-post-thumb placeholder" aria-hidden="true"></div>`;
            const createdAt = post.createdAt ? new Date(post.createdAt) : null;
            const timeLabel = createdAt instanceof Date && !Number.isNaN(createdAt.getTime())
                ? this.formatRelativeTime(createdAt)
                : '';
            const meta = [subtitle, timeLabel].filter(Boolean).join(' 路 ');
            return `
                <article class="my-post-card" data-my-post-id="${this.escapeHtml(String(post.id))}">
                    ${thumb}
                    <div class="my-post-body">
                        <div class="my-post-title">${title}</div>
                        <div class="my-post-meta">${this.escapeHtml(meta)}</div>
                        <div class="my-post-actions">
                            <button type="button" class="btn-secondary small" data-action="view">View</button>
                            <button type="button" class="btn-secondary small" data-action="delete">Delete</button>
                        </div>
                    </div>
                </article>
            `;
        }).join('');
    }

    handleMyPostsClick(event) {
        const btn = event?.target?.closest?.('[data-action]');
        if (!btn) return;
        const card = btn.closest('.my-post-card');
        const id = card?.dataset?.myPostId || '';
        if (!id) return;
        const action = btn.dataset.action || '';
        const entry = (this.myPosts || []).find((p) => String(p?.id) === String(id));
        if (!entry) return;
        if (action === 'delete') {
            this.deleteMyPostEntry(entry);
            return;
        }
        if (action === 'view') {
            this.openMyPostEntry(entry);
        }
    }

		    deleteMyPostEntry(entry) {
		        if (!entry) return;
		        const kind = String(entry.kind || '');
		        const refs = entry.refs && typeof entry.refs === 'object' ? entry.refs : {};
	        if (kind === 'ad' && refs.placement) {
	            this.resetPromotedAdIfMatches({ placement: refs.placement, src: entry.thumb || '' });
	        }
	        if (refs.marketplaceItemId != null) {
	            const id = String(refs.marketplaceItemId);
	            const safe = typeof CSS !== 'undefined' && typeof CSS.escape === 'function' ? CSS.escape(id) : id.replace(/"/g, '\\"');
	            const selector = `.featured-ad-card[data-post-item-id="${safe}"]`;
	            document.querySelectorAll(selector).forEach((node) => node.remove());
	        }
		        if (refs.marketplaceItemId != null) {
		            this.marketplaceItems = (this.marketplaceItems || []).filter((i) => String(i?.id) !== String(refs.marketplaceItemId));
		            if (document.getElementById('marketplace-content')?.classList.contains('active')) this.applyMarketplaceFilters();
		        }
	        if (refs.datingProfileId) {
	            const id = String(refs.datingProfileId);
	            const safe = typeof CSS !== 'undefined' && typeof CSS.escape === 'function' ? CSS.escape(id) : id.replace(/"/g, '\\"');
	            document.querySelectorAll(`.featured-ad-card[data-profile-id="${safe}"]`).forEach((node) => node.remove());
	            if (this.datingSponsoredProfiles && typeof this.datingSponsoredProfiles === 'object') {
	                delete this.datingSponsoredProfiles[id];
	            }
	        }
	        if (refs.discoveryPostId != null) {
	            this.discoveryPosts = (this.discoveryPosts || []).filter((p) => String(p?.id) !== String(refs.discoveryPostId));
	            this.filterDiscoveryPosts(this.activeDiscoveryFilter);
	        }
	        this.removeMyPost(entry.id);
        this.renderMyPosts();
    }

	    openMyPostEntry(entry) {
	        if (!entry) return;
	        const kind = String(entry.kind || '');
	        const refs = entry.refs && typeof entry.refs === 'object' ? entry.refs : {};
	        if (kind === 'dating_featured' && refs.datingProfileId) {
	            const id = String(refs.datingProfileId);
	            const safe = typeof CSS !== 'undefined' && typeof CSS.escape === 'function' ? CSS.escape(id) : id.replace(/"/g, '\\"');
	            this.switchScreen('dating');
	            requestAnimationFrame(() => {
	                const card = document.querySelector(`#dating-home-ads-carousel .featured-ad-card[data-profile-id="${safe}"]`);
	                if (card) {
	                    try { card.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch {}
	                    card.click();
	                }
	            });
	            return;
	        }
	        if (kind === 'marketplace' && refs.marketplaceItemId != null) {
	            const item = (this.marketplaceItems || []).find((i) => String(i?.id) === String(refs.marketplaceItemId));
	            if (item) {
	                this.showItemDetails(item.id);
                return;
            }
        }
        if (refs.discoveryPostId != null) {
            const post = (this.discoveryPosts || []).find((p) => String(p?.id) === String(refs.discoveryPostId));
            if (post) {
                this.openDiscoveryListing(post, 0);
                return;
            }
        }
        if (kind === 'ad' && entry.thumb) {
            const placement = String(refs.placement || '').trim();
            if (placement && placement !== 'all') {
                const config = this.getAdPlacementConfig(placement);
                if (config?.screen) {
                    this.switchScreen(config.screen);
                    requestAnimationFrame(() => {
                        const selector = config.scrollSelector || config.imageSelector || '';
                        if (!selector) return;
                        const target = document.querySelector(selector);
                        target?.scrollIntoView?.({ behavior: 'smooth', block: 'center' });
                    });
                }
            }
            const payload = entry.payload && typeof entry.payload === 'object' ? entry.payload : {};
            const createdAt = entry.createdAt ? new Date(entry.createdAt) : null;
            const meta = {
                bio: payload.description || '',
                specs: payload.category || '',
                date: createdAt instanceof Date && !Number.isNaN(createdAt.getTime()) ? this.formatRelativeTime(createdAt) : ''
            };
            this.openMediaLightbox([{ src: entry.thumb, label: 'Your ad', type: 'image', meta }], 'Your ad', 0);
        }
    }

    updatePostButton() {
        const input = document.getElementById('post-text');
        const btn = document.getElementById('post-btn');
        if (!btn) return;
        const title = document.getElementById('post-title');
        const region = document.getElementById('post-region');
        const hasText = (input?.value || '').trim().length > 0;
        const hasTitle = (title?.value || '').trim().length > 0;
        const hasRegion = (region?.value || '').trim().length > 0;
        btn.disabled = !(hasText && hasTitle && hasRegion);
    }

	    createDiscoveryPost() {
	        const textarea = document.getElementById('post-text');
	        if (!textarea) return;
	        const content = (textarea.value || '').trim();
	        if (!content) return;

	        const titleInput = document.getElementById('post-title');
	        const locationInput = document.getElementById('post-region');
	        const priceInput = document.getElementById('post-price');
	        const conditionInput = document.getElementById('post-condition');
	        const fulfillmentInput = document.getElementById('post-fulfillment');
	        const availabilityInput = document.getElementById('post-availability');
	        const mediaInput = document.getElementById('post-media-url');
            const mediaUploadInput = document.getElementById('post-media-upload');
	        const tagsInput = document.getElementById('post-tags');
	        const listingTypeSelect = document.getElementById('post-listing-type');

        const listingTitle = (titleInput?.value || '').trim();
        const listingLocation = (locationInput?.value || '').trim();
        const listingType = (listingTypeSelect?.value || 'sale').toLowerCase();
        if (!listingTitle || !listingLocation) {
            this.showNotification('Please add a title and location for your listing.');
            return;
        }

        const onlineToggle = document.getElementById('post-online-status');
        const isOnline = onlineToggle ? onlineToggle.checked : false;
	        const tags = this.parseTagInput(tagsInput?.value || '');
	        const priceText = this.buildUserListingPriceText(listingType, priceInput?.value || '');
	        const fulfillmentText = this.buildUserFulfillmentText(listingType, listingLocation);
	        const conditionText = (conditionInput?.value || '').trim();
	        const availabilityText = (availabilityInput?.value || '').trim();
	        const fulfillmentOverride = (fulfillmentInput?.value || '').trim();
	        const fallbackMedia = this.currentUser.photos?.[0] || this.currentUser.photo || 'https://via.placeholder.com/600x400/ebeef5/111827?text=Listing';
            const urlMedia = (mediaInput?.value || '').trim();
	            const uploadMedia = Array.isArray(this.discoveryPostUploads) ? this.discoveryPostUploads.map((u) => u?.src).filter(Boolean) : [];
                const maxMedia = Number.isFinite(this.discoveryPostUploadLimit) ? this.discoveryPostUploadLimit : 10;
	            const media = [];
	            if (urlMedia) media.push(urlMedia);
	            uploadMedia.forEach((src) => {
	                if (media.length >= maxMedia) return;
	                if (!media.includes(src)) media.push(src);
	            });
            if (!media.length) media.push(fallbackMedia);
	        const mediaUrl = media[0] || fallbackMedia;

        const sellerLocation = this.buildLocationFromInput(listingLocation);
        const seller = {
            name: this.currentUser.name || 'You',
            avatar: this.currentUser.photo || this.currentUser.photos?.[0] || 'https://via.placeholder.com/80x80/ccd5f6/1f2937?text=YOU',
            location: sellerLocation,
            online: isOnline,
            stats: 'New listing',
            trust: 'Community member'
        };

		        const newPost = {
		            id: Date.now(),
		            seller,
		            user: seller,
		            listingType,
		            listing: {
		                title: listingTitle,
		                summary: content,
		                priceText,
		                condition: conditionText || (listingType === 'service' ? 'Service offering' : 'Community submitted'),
		                availability: availabilityText || 'Replies within a day',
		                fulfillment: fulfillmentOverride || fulfillmentText,
		                mediaUrl,
                        media,
		                tags
		            },
	            content,
            timestamp: new Date(),
            isOnline,
            likes: 0,
            comments: 0,
            location: sellerLocation
        };

		        this.discoveryPosts.unshift(newPost);
		        this.filterDiscoveryPosts(this.activeDiscoveryFilter);
		        this.addMyPost({
		            kind: 'discover',
		            title: listingTitle,
		            subtitle: 'Discover post',
		            thumb: mediaUrl,
		            refs: { discoveryPostId: newPost.id },
		            payload: { listingType, media }
		        });

		        textarea.value = '';
	        if (titleInput) titleInput.value = '';
	        if (locationInput) locationInput.value = '';
	        if (priceInput) priceInput.value = '';
	        if (conditionInput) conditionInput.value = '';
	        if (fulfillmentInput) fulfillmentInput.value = '';
	        if (availabilityInput) availabilityInput.value = '';
	        if (mediaInput) mediaInput.value = '';
            if (mediaUploadInput) mediaUploadInput.value = '';
	        if (tagsInput) tagsInput.value = '';
	    if (listingTypeSelect) listingTypeSelect.value = 'sale';
	        if (onlineToggle) onlineToggle.checked = false;
            this.discoveryPostUploads = [];
            this.renderDiscoveryPostUploads();
	        this.updatePostButton();
	        this.showNotification('Shared with the community!');
	    }

    formatRelativeTime(date) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
        const now = new Date();
        const diffSeconds = Math.floor((now - date) / 1000);
        if (diffSeconds < 60) return 'Just now';
        const diffMinutes = Math.floor(diffSeconds / 60);
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    escapeHtml(text) {
        const safe = text == null ? '' : String(text);
        return safe.replace(/[&<>"']/g, (char) => {
            switch (char) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#39;';
                default: return char;
            }
        });
    }

			    loadDatingPage() {
		        const backBtn = document.getElementById('dating-back');
		        if (backBtn) backBtn.onclick = () => {
		            if (this.browserHistoryIndex > 0) window.history.back();
	            else this.switchScreen('home');
	        };
        const searchInput = document.getElementById('dating-search');
        const distanceRange = document.getElementById('dating-distance');
        const distanceValue = document.getElementById('dating-distance-value');
        const onlineOnly = document.getElementById('dating-online');
        const searchScope = document.getElementById('dating-search-scope');
        const postedSelect = document.getElementById('dating-posted');
        const categorySelect = document.getElementById('dating-category');
        if (categorySelect && !categorySelect.dataset.bound) {
            categorySelect.addEventListener('change', (e) => this.handleDatingCategorySelect(e.target.value));
            categorySelect.dataset.bound = '1';
        }
	        const categoryBack = document.getElementById('dating-category-back');
        if (categoryBack && !categoryBack.dataset.bound) {
            categoryBack.addEventListener('click', () => {
                if (this.browserHistoryIndex > 0) window.history.back();
                else this.closeDatingCategory(true);
            });
            categoryBack.dataset.bound = '1';
        }
        this.setupCompanionshipUI();
        this.setupDatingCategoryFilterButtons();
        if (!this.isApplyingRoute) {
            const route = this.parseRouteFromLocation();
            const category = String(route?.datingCategory || '').trim();
            if (category) this.openDatingCategory(category);
            else this.closeDatingCategory(true);
        }

        if (distanceRange && distanceValue) {
            distanceRange.oninput = () => {
                distanceValue.textContent = `${distanceRange.value}km`;
                this.applyDatingFilters();
            };
        }
        if (searchInput) searchInput.oninput = () => this.applyDatingFilters();
        if (onlineOnly) onlineOnly.onchange = () => this.applyDatingFilters();
        if (searchScope && !searchScope.dataset.bound) {
            searchScope.addEventListener('change', () => this.applyDatingFilters());
            searchScope.dataset.bound = '1';
        }
        if (postedSelect && !postedSelect.dataset.bound) {
            postedSelect.addEventListener('change', () => {
                this.applyDatingFilters();
                this.applyDatingLocationFeed();
            });
            postedSelect.dataset.bound = '1';
        }
        this.setupDatingLocationFeed();
        this.setupDatingSchedule();

		        // initial render
		        this.applyDatingFilters();
			        this.bindDatingSponsoredProfileCards();
			        this.decorateDatingSponsoredPresence();
			        this.setupDatingHomeAdsScrollToggle();
			    }

		    setupDatingHomeAdsScrollToggle() {
		        const toggle = document.getElementById('dating-home-ads-scroll-toggle');
		        const strip = document.querySelector('#dating-content .dating-featured-ads-strip');
		        if (!toggle || !strip || toggle.dataset.bound) return;

		        const toggleWrap = toggle.closest('label') || toggle.parentElement;
		        const scroller = strip.querySelector('#dating-home-ads-carousel') || strip.querySelector('.featured-ads-carousel');
		        const prevBtn = strip.querySelector('#dating-home-ads-prev');
		        const nextBtn = strip.querySelector('#dating-home-ads-next');

		        try {
		            const saved = localStorage.getItem('hs_dating_home_ads_scroll');
		            if (saved === 'true' || saved === 'false') toggle.checked = saved === 'true';
		        } catch {}

		        const updateNav = () => {
		            const scrollMode = strip.classList.contains('is-scroll');
		            const hasOverflow = Boolean(scroller) && scroller.scrollWidth > scroller.clientWidth + 4;
		            const showNav = scrollMode && hasOverflow;
		            if (prevBtn) prevBtn.hidden = !showNav;
		            if (nextBtn) nextBtn.hidden = !showNav;
		            if (!showNav || !scroller || !prevBtn || !nextBtn) return;

		            const max = Math.max(0, scroller.scrollWidth - scroller.clientWidth);
		            const left = scroller.scrollLeft;
		            prevBtn.disabled = left <= 2;
		            nextBtn.disabled = left >= max - 2;
		        };

		        if (scroller && prevBtn && nextBtn && !strip.dataset.navBound) {
		            const step = () => Math.max(240, Math.floor(scroller.clientWidth * 0.9));
		            const scrollByStep = (dir) => scroller.scrollBy({ left: dir * step(), behavior: 'smooth' });

		            prevBtn.addEventListener('click', (event) => {
		                event.preventDefault();
		                event.stopPropagation();
		                scrollByStep(-1);
		            });
		            nextBtn.addEventListener('click', (event) => {
		                event.preventDefault();
		                event.stopPropagation();
		                scrollByStep(1);
		            });

		            scroller.addEventListener('scroll', updateNav, { passive: true });
		            window.addEventListener('resize', updateNav);
		            strip.dataset.navBound = '1';
		        }

		        const apply = () => {
		            const cardCount = strip.querySelectorAll('.featured-ad-card').length;
		            const allowScroll = cardCount > 3;
		            if (toggleWrap) toggleWrap.hidden = !allowScroll;

		            strip.classList.toggle('is-scroll', Boolean(toggle.checked) && allowScroll);
		            try { localStorage.setItem('hs_dating_home_ads_scroll', toggle.checked ? 'true' : 'false'); } catch {}
		            updateNav();
		        };

		        toggle.addEventListener('change', apply);
		        toggle.dataset.bound = '1';
		        apply();
		    }


	    applyDatingFilters() {
	        const term = (document.getElementById('dating-search')?.value || '').toLowerCase();
	        const maxDist = parseInt(document.getElementById('dating-distance')?.value) || 50;
	        const onlineOnly = document.getElementById('dating-online')?.checked || false;
	        const searchScope = document.getElementById('dating-search-scope')?.value || 'all';
	        const postedFilter = document.getElementById('dating-posted')?.value || 'all';
	        const now = new Date();
	        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
	        const weekAgo = new Date(today);
	        weekAgo.setDate(today.getDate() - 7);
	        const monthAgo = new Date(today);
	        monthAgo.setMonth(today.getMonth() - 1);

        // Ensure distances are up to date
        this.updateUserDistances();

        const profiles = this.users.filter(u => {
            if (onlineOnly && !u.online) return false;
            if (u.location?.distance && u.location.distance > maxDist) return false;
            if (postedFilter && postedFilter !== 'all') {
                const activityDate = this.getUserActivityDate(u);
                if (!activityDate) return false;
                if (postedFilter === 'today' && activityDate < today) return false;
                if (postedFilter === 'week' && activityDate < weekAgo) return false;
                if (postedFilter === 'month' && activityDate < monthAgo) return false;
            }
            if (term) {
                const nameText = (u.name || '').toLowerCase();
                const interestsText = ((u.interests || []).join(' ') || '').toLowerCase();
                const locationText = `${u.location?.city || ''} ${u.location?.country || ''}`.toLowerCase();
                const bioText = (u.bio || '').toLowerCase();
                let match = false;
                switch (searchScope) {
                    case 'name':
                        match = nameText.includes(term);
                        break;
                    case 'interests':
                        match = interestsText.includes(term);
                        break;
                    case 'location':
                        match = locationText.includes(term);
                        break;
                    default:
                        match = (nameText + ' ' + bioText + ' ' + interestsText + ' ' + locationText).includes(term);
                }
                if (!match) return false;
            }
            return true;
        });
        this.renderDatingProfiles(profiles);
    }

    renderDatingProfiles(list) {
        const grid = document.getElementById('dating-grid');
        if (!grid) return;
        if (list.length === 0) {
            grid.innerHTML = `
                <div class="dating-empty">
                    <i class="fas fa-heart" style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem;"></i>
                    <h3>No profiles match</h3>
                    <p>Try broadening your search or distance.</p>
                </div>`;
            return;
        }
        grid.innerHTML = list.map(u => `
            <div class="dating-card" data-id="${u.id}" title="View ${u.name}">
                <img src="${u.photo}" alt="${u.name}" class="dating-card-photo" loading="lazy" tabindex="0" role="button" aria-label="View ${u.name}'s photos">
                <div class="dating-card-body">
                    <div class="dating-card-name">
                        <span>${u.name}</span>
                        ${u.online ? '<span class="dating-card-online" title="Online"></span>' : ''}
                    </div>
                    <div class="dating-card-age">${u.age} yrs</div>
                    <div class="dating-card-bio">${this.truncateText(u.bio, 90)}</div>
                    <div class="dating-card-distance">${u.location?.distance ? u.location.distance + 'km away' : 'Distance unknown'}</div>
                </div>
            </div>`).join('');

        grid.querySelectorAll('.dating-card').forEach(card => {
            card.addEventListener('click', () => {
                const id = parseInt(card.dataset.id);
                const user = this.users.find(u => u.id === id);
                if (!user) return;
                const gallery = this.buildUserGallery(user).map(item => item.src);
                this.openProfileModal(user, 0, gallery);
            });
            const img = card.querySelector('.dating-card-photo');
            if (img) {
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(card.dataset.id);
                    const user = this.users.find(u => u.id === id);
                    if (!user) return;
                    const galleryObjects = this.buildUserGallery(user);
                    const gallery = galleryObjects.map(item => item.src);
                    const photoSrc = e.currentTarget.getAttribute('src');
                    let startIndex = 0;
                    if (photoSrc) {
                        const targetKey = this.normalizeSrc(photoSrc);
                        const found = galleryObjects.findIndex(item => this.normalizeSrc(item.src) === targetKey);
                        if (found >= 0) startIndex = found;
                    }
                    this.openProfileModal(user, startIndex, gallery);
                });
                img.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        img.click();
                    }
                });
            }
        });
    }

		    bindDatingSponsoredProfileCards() {
		        const cards = document.querySelectorAll('#dating-content .dating-featured-ads-strip .featured-ad-card, #dating-content .companionship-featured-strip .featured-ad-card');
		        cards.forEach((card) => {
		            if (card.dataset.boundSponsored) return;
		            if (!card.hasAttribute('role')) card.setAttribute('role', 'button');
		            if (!card.hasAttribute('tabindex')) card.setAttribute('tabindex', '0');
		            const id = card.dataset.profileId;
		            card.addEventListener('click', () => this.openDatingSponsoredProfile(id, card));
		            card.addEventListener('keydown', (event) => {
		                if (event.key === 'Enter' || event.key === ' ') {
		                    event.preventDefault();
		                    this.openDatingSponsoredProfile(id, card);
		                }
		            });
		            card.dataset.boundSponsored = '1';
		        });
		    }

		    decorateDatingSponsoredPresence() {
		        const cards = document.querySelectorAll('#dating-content .dating-featured-ads-strip .featured-ad-card');
		        cards.forEach((card) => {
		            if (card.dataset.presenceBound) return;
		            const profileId = card.dataset.profileId;
		            const profile = profileId ? this.datingSponsoredProfiles?.[profileId] : null;
		            const fallbackText = card.querySelector('.featured-ad-body p')?.textContent || '';
		            const isOnline = profile?.online === true || (!profile && /online now/i.test(fallbackText));

		            let dot = card.querySelector('.featured-ad-online-dot');
		            if (!dot) {
		                dot = document.createElement('span');
		                dot.className = 'featured-ad-online-dot';
		                dot.setAttribute('aria-label', 'Online now');
		                card.appendChild(dot);
		            }

		            dot.hidden = !isOnline;

		            card.dataset.presenceBound = '1';
		        });
		    }

		    buildSponsoredProfileFromCard(card) {
		        const text = card?.querySelector('.featured-ad-body h4')?.textContent || 'Sponsored profile';
		        const [namePart, rest] = text.split(',').map(s => (s || '').trim());
		        const ageText = (rest || '').split('路')[0]?.trim() || '';
	        const cityText = (rest || '').split('路')[1]?.trim() || '';
	        const age = parseInt(ageText, 10);
	        const photos = Array.from(card?.querySelectorAll('.carousel-track img') || [])
	            .map(img => img.getAttribute('src'))
	            .filter(Boolean);
	        const line = card?.querySelector('.featured-ad-body p')?.textContent?.trim() || '';
	        const detail = card?.querySelector('.featured-ad-body span')?.textContent?.trim() || '';
	        const online = /online now/i.test(line);
	        const offline = /offline/i.test(line);
	        return {
	            id: card?.dataset?.profileId || 'sponsored',
	            name: namePart || 'Sponsored profile',
	            age: Number.isFinite(age) ? age : '',
	            role: 'Spotlight Member',
	            distance: [line, cityText].filter(Boolean).join(' 路 '),
	            looking: detail || 'Open to meaningful connections.',
	            bio: 'This is a boosted profile. Tap Message to start a chat (demo).',
	            online: online ? true : offline ? false : false,
	            statusText: online ? 'Online now' : 'Offline',
	            highlights: [detail].filter(Boolean),
	            interests: [],
            lifestyle: {
                drinking: 'Sometimes',
                smoking: 'No',
                cannabis: 'No',
                religion: 'Not specified',
                kids: 'Open to kids',
                education: 'Not specified',
                occupation: 'Not specified'
            },
	            photos: photos.length ? photos : ['https://via.placeholder.com/600x800/ebeef5/111827?text=Profile']
	        };
	    }

	    parseSponsoredProfileLocation(label = '', card = null) {
	        const text = String(label || '').trim();
	        const blocked = /(spotlight|online|offline|near you|available|reply|replies|verified|elite|premium|concierge|member)/i;
	        let distance;
	        const distanceMatch = text.match(/(\d+(?:\.\d+)?)\s*km/i);
	        if (distanceMatch) distance = parseFloat(distanceMatch[1]);

	        const findLocation = (value = '') => {
	            const parts = String(value || '').split('路').map(s => s.trim()).filter(Boolean);
	            if (!parts.length) return '';
	            return parts.slice().reverse().find(part => part && !blocked.test(part) && !/km/i.test(part)) || '';
	        };

	        let city = '';
	        let country = '';
	        let locationCandidate = findLocation(text);

	        if (!locationCandidate && card) {
	            const title = card.querySelector('.featured-ad-body h4')?.textContent || '';
	            locationCandidate = findLocation(title);
	        }

	        if (locationCandidate) {
	            if (locationCandidate.includes(',')) {
	                const [cityPart, countryPart] = locationCandidate.split(',').map(s => s.trim());
	                city = cityPart || '';
	                country = countryPart || '';
	            } else {
	                city = locationCandidate;
	            }
	        }

	        if (!Number.isFinite(distance) && card) {
	            const line = card.querySelector('.featured-ad-body p')?.textContent || '';
	            const lineMatch = line.match(/(\d+(?:\.\d+)?)\s*km/i);
	            if (lineMatch) distance = parseFloat(lineMatch[1]);
	        }

	        if (!city && !country && !Number.isFinite(distance)) return null;
	        return {
	            city: city || undefined,
	            country: country || undefined,
	            distance: Number.isFinite(distance) ? distance : undefined
	        };
	    }

	    buildSponsoredProfileUser(profile, card) {
	        if (!profile) return null;
	        const photos = Array.isArray(profile.photos) ? profile.photos.filter(Boolean) : [];
	        const location = this.parseSponsoredProfileLocation(profile.distance, card);
	        return {
	            name: profile.name || 'Sponsored profile',
	            age: profile.age,
	            bio: profile.bio || profile.looking || '',
	            interests: Array.isArray(profile.interests) ? profile.interests : [],
	            lifestyle: profile.lifestyle || profile.lifestylePreferences || null,
	            location: location || undefined,
	            online: profile.online === true,
	            photo: photos[0] || '',
	            photos,
	            matchPreferences: profile.looking || '',
	            postedAt: profile.postedAt || null
	        };
	    }

		    openDatingSponsoredProfile(profileId, card) {
		        const profile = this.datingSponsoredProfiles?.[profileId] || this.buildSponsoredProfileFromCard(card);
		        const isDatingFeatured = Boolean(card?.closest?.('#dating-content .dating-featured-ads-strip'));
		        const isCompanionshipFeatured = Boolean(card?.closest?.('#dating-content .companionship-featured-strip'));
		        if (isDatingFeatured) {
		            const user = this.buildSponsoredProfileUser(profile, card);
		            if (user) {
		                const gallery = Array.isArray(profile?.photos) ? profile.photos : [];
		                this.openProfileModal(user, 0, gallery);
		                return;
		            }
		        }
		        this.openDemoProfileObject({ ...profile, hideLifestyle: isCompanionshipFeatured });
		    }

		    openDemoProfileObject(profile) {
		        const modal = document.getElementById('demo-profile-modal');
		        if (!profile || !modal) return;

	        this.activeDemoProfile = profile;

	        const photo = document.getElementById('demo-profile-photo');
	        if (photo) {
	            const src = profile.photos?.[0] || 'https://via.placeholder.com/600x800/ebeef5/111827?text=Profile';
	            photo.src = src;
	            photo.alt = profile.name;
	        }

	        const nameEl = document.getElementById('demo-profile-name');
	        if (nameEl) {
	            const ageSuffix = profile.age ? `, ${profile.age}` : '';
	            nameEl.textContent = `${profile.name}${ageSuffix}`;
	        }

	        const roleEl = document.getElementById('demo-profile-role');
	        if (roleEl) roleEl.textContent = profile.role || '';

	        const statusEl = document.getElementById('demo-profile-status');
	        if (statusEl) {
	            const isOnline = profile.online === true;
	            statusEl.hidden = false;
	            statusEl.textContent = profile.statusText || (isOnline ? 'Online now' : 'Offline');
	            statusEl.classList.toggle('offline', !isOnline);
	        }

	        const distanceEl = document.getElementById('demo-profile-distance');
	        if (distanceEl) distanceEl.textContent = profile.distance || '';

	        const bioEl = document.getElementById('demo-profile-bio');
	        if (bioEl) bioEl.textContent = profile.bio || '';

	        const lookingEl = document.getElementById('demo-profile-looking');
	        if (lookingEl) lookingEl.textContent = profile.looking || 'Open to meaningful connections.';

	        const highlightsEl = document.getElementById('demo-profile-highlights');
	        if (highlightsEl) {
	            const highlights = Array.isArray(profile.highlights) ? profile.highlights : [];
	            if (highlights.length) {
	                highlightsEl.innerHTML = highlights.map(item => `<li><i class="fas fa-star"></i><span>${this.escapeHtml(String(item || ''))}</span></li>`).join('');
	            } else {
	                highlightsEl.innerHTML = '<li><span>No highlights shared yet.</span></li>';
	            }
	        }

	        const interestsEl = document.getElementById('demo-profile-interests');
	        if (interestsEl) {
	            const interests = Array.isArray(profile.interests) ? profile.interests : [];
	            if (interests.length) {
	                interestsEl.innerHTML = interests.map(tag => `<span>${this.escapeHtml(String(tag || ''))}</span>`).join('');
	            } else {
	                interestsEl.innerHTML = '<span>Curious about everything</span>';
	            }
	        }

		        const lifestyleEl = document.getElementById('demo-profile-lifestyle');
		        if (lifestyleEl) {
		            const wrap = lifestyleEl.closest('div');
		            const shouldHide = profile.hideLifestyle === true;
		            if (wrap) wrap.classList.toggle('hidden', shouldHide);
		            if (shouldHide) {
		                lifestyleEl.innerHTML = '';
		            } else {
		                const entries = this.getLifestyleEntries(profile);
		                lifestyleEl.innerHTML = entries.map((row) => (
		                    `<div class="lifestyle-item"><span class="lifestyle-label">${this.escapeHtml(row.label)}</span><span class="lifestyle-value">${this.escapeHtml(row.value)}</span></div>`
		                )).join('');
		            }
		        }

	        const galleryBtn = document.getElementById('demo-profile-gallery-btn');
	        if (galleryBtn) {
	            const hasPhotos = Array.isArray(profile.photos) && profile.photos.length;
	            galleryBtn.disabled = !hasPhotos;
	            galleryBtn.classList.toggle('disabled', !hasPhotos);
	            galleryBtn.onclick = hasPhotos
	                ? () => {
	                    const items = profile.photos.map(src => ({ src, label: profile.name }));
	                    this.openMediaLightbox(items, profile.name, 0);
	                }
	                : null;
	        }

	        const messageBtn = document.getElementById('demo-profile-message-btn');
	        if (messageBtn) {
	            messageBtn.onclick = () => this.handleDemoMessage(profile);
	        }

	        modal.classList.remove('hidden');
	        const closeBtn = document.getElementById('demo-profile-close');
	        closeBtn?.focus?.();

	        document.removeEventListener('keydown', this.boundDemoProfileKeydown);
	        document.addEventListener('keydown', this.boundDemoProfileKeydown);
	    }

    closeDemoProfile() {
        const modal = document.getElementById('demo-profile-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        this.activeDemoProfile = null;
        document.removeEventListener('keydown', this.boundDemoProfileKeydown);
    }

    handleDemoProfileKeydown(event) {
        if (event.key === 'Escape') {
            this.closeDemoProfile();
        }
    }

    handleDemoMessage(profile) {
        if (!profile) return;
        const name = profile?.name || 'this demo match';
        const photo = profile?.photos?.[0] || profile?.photo || '';
        const status = profile?.statusText || (profile?.online ? 'Online' : 'Offline');
        this.closeDemoProfile();
        this.openChatModal({
            name,
            photo,
            status,
            threadKey: `demo:${this.normalizeSellerKey(name) || 'match'}`,
            placeholder: `Send a message to ${name}`
        });
    }

    setupProfileModalControls() {
        const modal = document.getElementById('profile-modal');
        if (!modal || modal.dataset.bound) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) this.closeProfileModal();
        });
        const closeBtn = document.getElementById('profile-modal-close');
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeProfileModal());
        const prev = document.getElementById('profile-photo-prev');
        if (prev) prev.addEventListener('click', () => this.stepProfilePhoto(-1));
        const next = document.getElementById('profile-photo-next');
        if (next) next.addEventListener('click', () => this.stepProfilePhoto(1));
        const messageBtn = document.getElementById('profile-modal-message');
        if (messageBtn) messageBtn.addEventListener('click', () => this.handleProfileMessage());
        const likeBtn = document.getElementById('profile-modal-like');
        if (likeBtn) likeBtn.addEventListener('click', () => this.handleProfileLike());
        const flowersBtn = document.getElementById('profile-modal-flowers');
        if (flowersBtn) flowersBtn.addEventListener('click', () => this.handleProfileGift('flowers'));
        const creditBtn = document.getElementById('profile-modal-credit');
        if (creditBtn) creditBtn.addEventListener('click', () => this.handleProfileGift('credits'));
        const commentBtn = document.getElementById('profile-comment-submit');
        if (commentBtn) commentBtn.addEventListener('click', () => this.submitProfileComment());
        const commentInput = document.getElementById('profile-comment-input');
        if (commentInput) {
            commentInput.addEventListener('keydown', (event) => {
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault();
                    this.submitProfileComment();
                }
            });
        }
        modal.dataset.bound = '1';
    }

    setupSellerProfileModalControls() {
        const modal = document.getElementById('seller-profile-modal');
        if (!modal || modal.dataset.bound) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) this.closeSellerProfileModal();
        });
        const closeBtn = document.getElementById('seller-profile-close');
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeSellerProfileModal());
        const messageBtn = document.getElementById('seller-profile-message');
        if (messageBtn) {
            messageBtn.addEventListener('click', () => {
                this.openSellerProfileChat();
            });
        }
        const reviewBtn = document.getElementById('seller-profile-review');
        if (reviewBtn) {
            reviewBtn.addEventListener('click', () => {
                const sellerName = this.activeSellerProfile?.name || 'Seller';
                this.openSellerRatingModal({
                    sellerName,
                    source: this.activeSellerProfileSource
                });
            });
        }
        const shareBtn = document.getElementById('seller-profile-share');
        if (shareBtn) {
            shareBtn.addEventListener('click', () => {
                this.showNotification('Share link copied (demo).');
            });
        }
        const listings = document.getElementById('seller-profile-listings');
        if (listings && !listings.dataset.bound) {
            listings.addEventListener('click', (event) => {
                const card = event.target.closest('.seller-listing-card');
                if (!card) return;
                const source = card.dataset.source || 'marketplace';
                const rawId = card.dataset.id || '';
                const shouldClose = source !== 'home_featured';
                if (shouldClose) this.closeSellerProfileModal();
                if (source === 'service') {
                    if (this.activeServiceProfile) {
                        this.openServiceModal(this.activeServiceProfile);
                        return;
                    }
                    const service = (this.serviceProfiles || []).find(entry => String(entry.id) === String(rawId));
                    if (service) this.openServiceModal(service);
                    return;
                }
                if (source === 'luxury') {
                    const ad = this.activeLuxuryAd || this.lastLuxuryAd;
                    if (ad) this.openLuxuryAdModal(ad);
                    return;
                }
                if (source === 'vehicle') {
                    const vehicle = (this.vehicleListings || []).find(entry => String(entry.id) === String(rawId));
                    if (vehicle) this.openVehicleModal(vehicle);
                    return;
                }
                if (source === 'realestate') {
                    if (rawId) this.openRealestateModalById(rawId);
                    return;
                }
                if (source === 'discovery') {
                    const post = (this.discoveryPosts || []).find(entry => String(entry.id) === String(rawId));
                    if (post) this.openDiscoveryListing(post);
                    return;
                }
                if (source === 'community') {
                    this.openCommunityPostMarketplaceModal(rawId);
                    return;
                }
                if (source === 'companionship') {
                    this.openCompanionshipProfileMarketplaceModal(rawId);
                    return;
                }
                if (source === 'home_featured') {
                    const scroll = document.querySelector('#seller-profile-modal .seller-profile-scroll');
                    scroll?.scrollTo?.({ top: 0, behavior: 'smooth' });
                    return;
                }
                const itemId = parseInt(rawId || '', 10);
                if (!Number.isFinite(itemId)) return;
                this.showItemDetails(itemId);
            });
            listings.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter' && event.key !== ' ') return;
                const card = event.target.closest('.seller-listing-card');
                if (!card) return;
                event.preventDefault();
                const source = card.dataset.source || 'marketplace';
                const rawId = card.dataset.id || '';
                const shouldClose = source !== 'home_featured';
                if (shouldClose) this.closeSellerProfileModal();
                if (source === 'service') {
                    if (this.activeServiceProfile) {
                        this.openServiceModal(this.activeServiceProfile);
                        return;
                    }
                    const service = (this.serviceProfiles || []).find(entry => String(entry.id) === String(rawId));
                    if (service) this.openServiceModal(service);
                    return;
                }
                if (source === 'luxury') {
                    const ad = this.activeLuxuryAd || this.lastLuxuryAd;
                    if (ad) this.openLuxuryAdModal(ad);
                    return;
                }
                if (source === 'vehicle') {
                    const vehicle = (this.vehicleListings || []).find(entry => String(entry.id) === String(rawId));
                    if (vehicle) this.openVehicleModal(vehicle);
                    return;
                }
                if (source === 'realestate') {
                    if (rawId) this.openRealestateModalById(rawId);
                    return;
                }
                if (source === 'discovery') {
                    const post = (this.discoveryPosts || []).find(entry => String(entry.id) === String(rawId));
                    if (post) this.openDiscoveryListing(post);
                    return;
                }
                if (source === 'community') {
                    this.openCommunityPostMarketplaceModal(rawId);
                    return;
                }
                if (source === 'companionship') {
                    this.openCompanionshipProfileMarketplaceModal(rawId);
                    return;
                }
                if (source === 'home_featured') {
                    const scroll = document.querySelector('#seller-profile-modal .seller-profile-scroll');
                    scroll?.scrollTo?.({ top: 0, behavior: 'smooth' });
                    return;
                }
                const itemId = parseInt(rawId || '', 10);
                if (!Number.isFinite(itemId)) return;
                this.showItemDetails(itemId);
            });
            listings.dataset.bound = '1';
        }
        modal.dataset.bound = '1';
    }

    setupSafetyModalControls() {
        const modal = document.getElementById('safety-modal');
        if (!modal || modal.dataset.bound) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) this.closeSafetyModal();
        });
        const closeBtn = document.getElementById('safety-close');
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeSafetyModal());
        const cancelBtn = document.getElementById('safety-cancel');
        if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeSafetyModal());
        const continueBtn = document.getElementById('safety-continue');
        if (continueBtn) {
            continueBtn.addEventListener('click', () => {
                const skip = document.getElementById('safety-skip');
                if (skip && skip.checked) {
                    try { localStorage.setItem('hs_safety_skip', 'true'); } catch {}
                }
                const cont = this.pendingSafetyContinue;
                this.pendingSafetyContinue = null;
                this.closeSafetyModal();
                if (typeof cont === 'function') cont();
            });
        }
        modal.dataset.bound = '1';
    }

    handleSafetyKeydown(event) {
        if (event.key === 'Escape') this.closeSafetyModal();
    }

    openSafetyModal({ title = 'Safe sale tips', subtitle = 'Quick checklist before you message or buy.', onContinue } = {}) {
        const modal = document.getElementById('safety-modal');
        if (!modal) {
            if (typeof onContinue === 'function') onContinue();
            return;
        }

        try {
            if (localStorage.getItem('hs_safety_skip') === 'true') {
                if (typeof onContinue === 'function') onContinue();
                return;
            }
        } catch {}

        const titleEl = document.getElementById('safety-title');
        if (titleEl) titleEl.textContent = title;
        const subtitleEl = document.getElementById('safety-subtitle');
        if (subtitleEl) subtitleEl.textContent = subtitle;
        const skip = document.getElementById('safety-skip');
        if (skip) skip.checked = false;

        this.pendingSafetyContinue = typeof onContinue === 'function' ? onContinue : null;
        modal.classList.remove('hidden');
        document.addEventListener('keydown', this.boundSafetyKeydown);
        document.getElementById('safety-continue')?.focus?.();
    }

    closeSafetyModal() {
        const modal = document.getElementById('safety-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        this.pendingSafetyContinue = null;
        document.removeEventListener('keydown', this.boundSafetyKeydown);
    }

    setupSellerRatingModalControls() {
        const modal = document.getElementById('seller-rating-modal');
        if (!modal || modal.dataset.bound) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) this.closeSellerRatingModal();
        });
        document.addEventListener('keydown', (event) => {
            if (modal.classList.contains('hidden')) return;
            if (event.key === 'Escape') this.closeSellerRatingModal();
        });
        const closeBtn = document.getElementById('seller-rating-close');
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeSellerRatingModal());
        const cancelBtn = document.getElementById('seller-rating-cancel');
        if (cancelBtn) cancelBtn.addEventListener('click', () => this.closeSellerRatingModal());
        const submitBtn = document.getElementById('seller-rating-submit');
        if (submitBtn) submitBtn.addEventListener('click', () => this.submitSellerRating());
        const starsEl = document.getElementById('seller-rating-stars');
        if (starsEl && !starsEl.dataset.bound) {
            starsEl.addEventListener('click', (event) => {
                const btn = event.target.closest('.seller-rating-star');
                if (!btn) return;
                const value = parseInt(btn.dataset.value || '', 10);
                if (!Number.isFinite(value)) return;
                this.setSellerRatingValue(value);
            });
            starsEl.dataset.bound = '1';
        }
        modal.dataset.bound = '1';
    }

    setupMarketplaceItemModalControls() {
        const modal = document.getElementById('marketplace-item-modal');
        if (!modal || modal.dataset.bound) return;
        const closeBtn = document.getElementById('marketplace-item-close');
        const prevBtn = document.getElementById('marketplace-item-prev');
        const nextBtn = document.getElementById('marketplace-item-next');
        const galleryBtn = document.getElementById('marketplace-item-gallery');
        const sellerBtn = document.getElementById('marketplace-item-seller');
        const offerBtn = document.getElementById('marketplace-item-offer');
        const purchaseBtn = document.getElementById('marketplace-item-purchase');
        const shareBtn = document.getElementById('marketplace-item-share');

        const getTrack = () => document.getElementById('marketplace-item-track');
        const scrollBy = (dir) => {
            const track = getTrack();
            if (!track) return;
            track.scrollBy({ left: dir * track.clientWidth, behavior: 'smooth' });
        };

        modal.addEventListener('click', (event) => {
            if (event.target === modal) this.closeMarketplaceItemModal();
        });
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeMarketplaceItemModal());
        if (prevBtn) {
            prevBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                scrollBy(-1);
            });
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                scrollBy(1);
            });
        }
        if (galleryBtn) galleryBtn.addEventListener('click', () => this.openMarketplaceItemGallery());
        if (sellerBtn) sellerBtn.addEventListener('click', () => this.openMarketplaceItemSeller());
        if (offerBtn) offerBtn.addEventListener('click', () => this.openMarketplaceItemOffer());
        if (purchaseBtn) purchaseBtn.addEventListener('click', () => this.completeMarketplacePurchase());
        if (shareBtn) shareBtn.addEventListener('click', () => this.shareMarketplaceItem());

        modal.dataset.bound = '1';
    }

    handleMarketplaceItemModalKeydown(event) {
        if (event.key === 'Escape') {
            this.closeMarketplaceItemModal();
        }
    }

    openProfileModal(user, startIndex = 0, galleryOverride = null) {
        const modal = document.getElementById('profile-modal');
        if (!user || !modal) return;
        const fallback = 'https://via.placeholder.com/800x600/0f172a/ffffff?text=Profile';
        const gallerySources = Array.isArray(galleryOverride) && galleryOverride.length
            ? galleryOverride
            : (this.buildUserGallery(user) || []);
        const gallery = this.buildLightboxItems(gallerySources, user.name);
        this.profileModalPhotos = gallery.length ? gallery : [{ src: fallback, type: 'image' }];
        this.activeProfile = user;
        this.activeProfilePhotoIndex = Math.min(Math.max(startIndex, 0), this.profileModalPhotos.length - 1);
        this.renderProfileModalContent();
        modal.classList.remove('hidden');
        document.addEventListener('keydown', this.boundProfileModalKeydown);
    }

    closeProfileModal() {
        const modal = document.getElementById('profile-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        this.activeProfile = null;
        this.profileModalPhotos = [];
        this.activeProfilePhotoIndex = 0;
        document.removeEventListener('keydown', this.boundProfileModalKeydown);
    }

	    openSellerProfileModal(data = {}) {
	        const modal = document.getElementById('seller-profile-modal');
	        if (!modal) return;
	        this.activeSellerProfile = data;
        this.activeSellerProfileSource = data.source || null;
        const sourceType = String(data?.source?.type || '').trim();
        const isLuxury = sourceType === 'home_featured';
        modal.classList.toggle('luxury', isLuxury);
        const hero = document.getElementById('seller-profile-luxury-hero');
        const heroTier = document.getElementById('seller-profile-luxury-tier');
        const heroPill = document.getElementById('seller-profile-luxury-pill');
        const heroThumbs = document.getElementById('seller-profile-luxury-thumbs');
        let heroImages = isLuxury
            ? (Array.isArray(data?.galleryImages) ? data.galleryImages : [])
                .map((src) => String(src || '').trim())
                .filter(Boolean)
            : [];
        const heroImage = isLuxury
            ? String(data?.heroImage || heroImages[0] || data?.listings?.[0]?.thumb || '').trim()
            : '';
        if (isLuxury && !heroImages.length && heroImage) heroImages = [heroImage];

        if (isLuxury && heroImages.length) {
            const label = String(data?.galleryLabel || data?.listings?.[0]?.title || data?.name || 'Gallery').trim() || 'Gallery';
            this.sellerProfileLuxuryGallery = { images: heroImages, index: 0, label };
        } else {
            this.sellerProfileLuxuryGallery = null;
        }
        if (hero) {
            hero.classList.toggle('hidden', !isLuxury);
            if (heroImage) {
                const safeUrl = heroImage.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '');
                hero.style.backgroundImage = `url("${safeUrl}")`;
            } else {
                hero.style.backgroundImage = '';
            }
            if (!hero.dataset.boundGallery) {
                const openGallery = () => {
                    const gallery = this.sellerProfileLuxuryGallery;
                    if (!gallery || !gallery.images?.length) return;
                    this.openMediaLightbox(gallery.images, gallery.label, gallery.index || 0);
                };
                hero.addEventListener('click', (e) => {
                    if (hero.classList.contains('hidden')) return;
                    e.stopPropagation();
                    openGallery();
                });
                hero.addEventListener('keydown', (e) => {
                    if (hero.classList.contains('hidden')) return;
                    if (e.key !== 'Enter' && e.key !== ' ') return;
                    e.preventDefault();
                    openGallery();
                });
                hero.dataset.boundGallery = '1';
            }
        }
        if (heroThumbs) {
            heroThumbs.classList.toggle('hidden', !(isLuxury && heroImages.length));
            heroThumbs.innerHTML = isLuxury && heroImages.length
                ? heroImages.map((src, idx) => {
                    const safeSrc = this.escapeHtml(src);
                    const isActive = idx === 0;
                    return `
                        <button class="seller-profile-luxury-thumb${isActive ? ' active' : ''}" type="button" data-seller-hero-idx="${idx}" aria-label="View photo ${idx + 1}">
                            <img src="${safeSrc}" alt="Photo ${idx + 1}" loading="lazy">
                        </button>
                    `;
                }).join('')
                : '';

            heroThumbs.querySelectorAll('.seller-profile-luxury-thumb').forEach((btn) => {
                if (btn.dataset.bound) return;
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.sellerHeroIdx || '', 10);
                    if (!Number.isFinite(idx) || idx < 0 || idx >= heroImages.length) return;
                    const src = heroImages[idx] || '';
                    if (hero && src) {
                        const safeUrl = src.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '');
                        hero.style.backgroundImage = `url("${safeUrl}")`;
                    }
                    if (this.sellerProfileLuxuryGallery) {
                        this.sellerProfileLuxuryGallery.index = idx;
                    }
                    heroThumbs.querySelectorAll('.seller-profile-luxury-thumb').forEach((b) => {
                        b.classList.toggle('active', b === btn);
                    });
                    modal.querySelector('.seller-profile-scroll')?.scrollTo?.({ top: 0, behavior: 'smooth' });
                    const gallery = this.sellerProfileLuxuryGallery;
                    if (gallery && gallery.images?.length) {
                        this.openMediaLightbox(gallery.images, gallery.label, idx);
                    }
                });
                btn.dataset.bound = '1';
            });
        }
        if (heroTier) {
            const tierText = String(data?.badgeText || data?.tier || (isLuxury ? 'Sponsored' : '')).trim();
            heroTier.textContent = tierText || 'Sponsored';
        }
        if (heroPill) {
            const pillText = String(data?.heroPillText || (isLuxury ? 'Featured' : '')).trim();
            heroPill.textContent = pillText || 'Featured';
        }

        const nameEl = document.getElementById('seller-profile-name');
        if (nameEl) nameEl.textContent = data.name || 'Seller';

	        const avatarEl = document.getElementById('seller-profile-avatar');
	        if (avatarEl) {
                const initials = data.initials || this.getInitials(data.name) || '';
                const photo = String(data.photo || '').trim();
                if (photo) {
                    const safeUrl = photo.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '');
                    avatarEl.style.backgroundImage = `url("${safeUrl}")`;
                    avatarEl.classList.add('has-photo');
                    avatarEl.textContent = '';
                } else {
                    avatarEl.style.backgroundImage = '';
                    avatarEl.classList.remove('has-photo');
                    avatarEl.textContent = initials;
                }
            }

        const badgeEl = document.getElementById('seller-profile-badge');
        if (badgeEl) {
            const badgeText = String(data.badgeText || '').trim();
            badgeEl.textContent = badgeText || 'Verified seller';
            badgeEl.classList.toggle('hidden', !(data.verified || badgeText));
        }

        const ratingEl = document.getElementById('seller-profile-rating');
        if (ratingEl) {
            const parts = [];
            if (data.ratingLabel) parts.push(data.ratingLabel);
            if (Number.isFinite(data.reviewCount)) parts.push(`${data.reviewCount} reviews`);
            ratingEl.textContent = parts.join(' 路 ');
        }

        const locationEl = document.getElementById('seller-profile-location');
        if (locationEl) {
            locationEl.textContent = data.location || 'Location not listed';
        }

        const bioEl = document.getElementById('seller-profile-bio');
        if (bioEl) {
            bioEl.textContent = data.bio || '';
            bioEl.classList.toggle('hidden', !data.bio);
        }

        const listingCountEl = document.getElementById('seller-profile-listing-count');
        if (listingCountEl) {
            listingCountEl.textContent = Array.isArray(data.listings) ? String(data.listings.length) : '0';
        }

        const responseEl = document.getElementById('seller-profile-response');
        if (responseEl) responseEl.textContent = data.responseLabel || 'Response time varies';

        const ratingNumberEl = document.getElementById('seller-profile-rating-number');
        if (ratingNumberEl) {
            ratingNumberEl.textContent = Number.isFinite(data.ratingValue) ? `${data.ratingValue.toFixed(1)} avg` : 'New';
        }

        const listingsEl = document.getElementById('seller-profile-listings');
        if (listingsEl) {
            const listings = Array.isArray(data.listings) ? data.listings : [];
            listingsEl.innerHTML = listings.length ? listings.map((item) => {
                const title = this.escapeHtml(String(item.title || 'Listing'));
                const thumb = item.thumb || item.images?.[0] || 'https://via.placeholder.com/120x120/ebeef5/111827?text=Listing';
                const priceValue = item.price;
                const priceLabel = Number.isFinite(priceValue) ? `$${priceValue}` : (priceValue ? String(priceValue) : '');
                const location = item.location || [item.city, item.country].filter(Boolean).join(', ');
                const metaParts = [priceLabel, location].filter(Boolean);
                const meta = this.escapeHtml(metaParts.join(' 路 '));
                const source = this.escapeHtml(String(item.source || 'marketplace'));
                return `
                    <div class="seller-listing-card" data-id="${this.escapeHtml(String(item.id))}" data-source="${source}" role="button" tabindex="0" aria-label="Open ${title}">
                        <img class="seller-listing-thumb" src="${this.escapeHtml(thumb)}" alt="${title}" loading="lazy">
                        <div class="seller-listing-body">
                            <div class="seller-listing-title">${title}</div>
                            <div class="seller-listing-meta">${meta || 'Listing details available'}</div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="seller-profile-empty">No active listings yet.</p>';
        }

        const reviewsEl = document.getElementById('seller-profile-reviews');
        if (reviewsEl) {
            const reviews = Array.isArray(data.reviews) ? data.reviews : [];
            reviewsEl.innerHTML = reviews.length ? reviews.map((review) => {
                const ratingLine = this.formatStarRating(review.rating);
                const rawDate = review.date || '';
                const dateLabel = review.dateLabel
                    || (rawDate && String(rawDate).includes('ago') ? rawDate : (rawDate ? this.formatReviewDate(rawDate) : ''));
                return `
                    <div class="seller-review">
                        <div class="seller-review-head">
                            <span>${this.escapeHtml(review.name || 'Buyer')}</span>
                            <span>${this.escapeHtml(ratingLine)}</span>
                        </div>
                        <div class="seller-review-meta">Verified purchase 路 ${this.escapeHtml(dateLabel)}</div>
                        <p>${this.escapeHtml(review.text || '')}</p>
                    </div>
                `;
            }).join('') : '<p class="seller-profile-empty">No reviews yet.</p>';
        }

        modal.classList.remove('hidden');
        document.addEventListener('keydown', this.boundSellerProfileKeydown);
    }

    openSellerRatingModal({ sellerName = 'Seller', itemTitle = '', source = null } = {}) {
        const modal = document.getElementById('seller-rating-modal');
        if (!modal) return;
        this.pendingSellerRating = {
            sellerName,
            itemTitle,
            source,
            rating: 0
        };
        const titleEl = document.getElementById('seller-rating-title');
        if (titleEl) titleEl.textContent = 'Rate your purchase';
        const subEl = document.getElementById('seller-rating-sub');
        if (subEl) {
            const subject = itemTitle
                ? `How was your purchase of ${itemTitle} from ${sellerName}?`
                : `How was your experience with ${sellerName}?`;
            subEl.textContent = subject;
        }
        const starsEl = document.getElementById('seller-rating-stars');
        if (starsEl && !starsEl.innerHTML.trim()) {
            starsEl.innerHTML = Array.from({ length: 5 }, (_, i) => {
                const value = i + 1;
                const label = value === 1 ? '1 star' : `${value} stars`;
                return `<button class="seller-rating-star" type="button" data-value="${value}" role="radio" aria-checked="false" aria-label="${label}">${'猸'.repeat(value)}</button>`;
            }).join('');
        }
        const textEl = document.getElementById('seller-rating-text');
        if (textEl) textEl.value = '';
        this.setSellerRatingValue(0);
        modal.classList.remove('hidden');
    }

    setSellerRatingValue(value) {
        const rating = Number.isFinite(value) ? value : 0;
        if (this.pendingSellerRating) {
            this.pendingSellerRating.rating = rating;
        }
        const starsEl = document.getElementById('seller-rating-stars');
        if (starsEl) {
            starsEl.querySelectorAll('.seller-rating-star').forEach((btn) => {
                const btnValue = parseInt(btn.dataset.value || '', 10);
                const isActive = Number.isFinite(btnValue) && btnValue <= rating;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-checked', btnValue === rating ? 'true' : 'false');
            });
        }
        const valueEl = document.getElementById('seller-rating-value');
        if (valueEl) {
            valueEl.textContent = rating > 0 ? this.formatStarRating(rating) : 'Select a rating';
        }
    }

    submitSellerRating() {
        const context = this.pendingSellerRating;
        if (!context || !context.sellerName) return;
        if (!context.rating || context.rating < 1) {
            this.showNotification('Select a rating to submit.');
            return;
        }
        const textEl = document.getElementById('seller-rating-text');
        const comment = String(textEl?.value || '').trim();
        const reviewerName = String(this.currentUser?.name || 'You').trim() || 'You';
        const review = {
            name: reviewerName,
            rating: context.rating,
            date: new Date().toISOString(),
            text: comment || 'Smooth transaction and friendly seller.'
        };
        this.addSellerReview(context.sellerName, review);
        this.closeSellerRatingModal();
        this.showNotification('Review submitted. Thank you!');
        this.refreshActiveSellerProfile(context.source);
    }

    closeSellerRatingModal() {
        const modal = document.getElementById('seller-rating-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        this.pendingSellerRating = null;
    }

    refreshActiveSellerProfile(sourceOverride = null) {
        const source = sourceOverride || this.activeSellerProfileSource;
        if (!source || !source.type) return;
        if (source.type === 'marketplace') {
            const item = (this.marketplaceItems || []).find(entry => Number(entry.id) === Number(source.id));
            if (item) this.openSellerProfileModal(this.buildSellerProfileData(item));
            return;
        }
        if (source.type === 'service') {
            if (this.activeServiceProfile) {
                this.openSellerProfileModal(this.buildSellerProfileDataFromService(this.activeServiceProfile));
            }
            return;
        }
        if (source.type === 'luxury') {
            const ad = this.activeLuxuryAd || this.lastLuxuryAd;
            if (ad) {
                this.openSellerProfileModal(this.buildSellerProfileDataFromLuxuryAd(ad));
            }
            return;
        }
        if (source.type === 'vehicle') {
            const vehicle = (this.vehicleListings || []).find(entry => String(entry.id) === String(source.id));
            if (vehicle) {
                this.openSellerProfileModal(this.buildSellerProfileDataFromVehicle(vehicle));
            }
            return;
        }
        if (source.type === 'realestate') {
            const listing = (this.realestateListings || []).find(entry => String(entry.id) === String(source.id));
            if (listing) {
                this.openSellerProfileModal(this.buildSellerProfileDataFromRealestate(listing));
            }
            return;
        }
        if (source.type === 'discovery') {
            const post = (this.discoveryPosts || []).find(entry => String(entry.id) === String(source.id));
            if (post) {
                this.openSellerProfileModal(this.buildSellerProfileDataFromDiscoveryPost(post));
            }
        }
    }

    closeSellerProfileModal() {
        const modal = document.getElementById('seller-profile-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        modal.classList.remove('luxury');
        const hero = document.getElementById('seller-profile-luxury-hero');
        const heroThumbs = document.getElementById('seller-profile-luxury-thumbs');
        if (hero) {
            hero.classList.add('hidden');
            hero.style.backgroundImage = '';
        }
        if (heroThumbs) {
            heroThumbs.classList.add('hidden');
            heroThumbs.innerHTML = '';
        }
        this.sellerProfileLuxuryGallery = null;
        this.activeSellerProfile = null;
        this.activeSellerProfileSource = null;
        document.removeEventListener('keydown', this.boundSellerProfileKeydown);
    }

    handleSellerProfileKeydown(event) {
        if (event.key === 'Escape') {
            this.closeSellerProfileModal();
        }
    }

    handleProfileModalKeydown(event) {
        if (event.key === 'Escape') {
            this.closeProfileModal();
            return;
        }
        if (event.key === 'ArrowLeft') this.stepProfilePhoto(-1);
        if (event.key === 'ArrowRight') this.stepProfilePhoto(1);
    }

    renderProfileComments() {
        const wrap = document.getElementById('profile-modal-comments');
        const listEl = document.getElementById('profile-comments-list');
        const countEl = document.getElementById('profile-comments-count');
        if (!wrap || !listEl) return;
        const isDatingScreen = this.activeScreen === 'dating';
        wrap.classList.toggle('hidden', isDatingScreen);
        if (isDatingScreen) return;
        const comments = this.getProfileComments(this.activeProfile);
        if (countEl) {
            countEl.textContent = comments.length
                ? `${comments.length} ${comments.length === 1 ? 'comment' : 'comments'}`
                : 'No comments';
        }
        if (!comments.length) {
            listEl.innerHTML = '<div class="profile-comment-empty">No comments yet.</div>';
            return;
        }
        listEl.innerHTML = comments.map((comment) => {
            const created = new Date(comment.createdAt || comment.date || '');
            const timeLabel = Number.isNaN(created.getTime()) ? '' : this.formatRelativeTime(created);
            return `
                <div class="profile-comment">
                    <div class="profile-comment-head">
                        <span class="profile-comment-name">${this.escapeHtml(comment.name || 'Anonymous')}</span>
                        ${timeLabel ? `<span class="profile-comment-time">${this.escapeHtml(timeLabel)}</span>` : ''}
                    </div>
                    <p class="profile-comment-text">${this.escapeHtml(comment.text || '')}</p>
                </div>
            `;
        }).join('');
    }

    submitProfileComment() {
        if (!this.activeProfile || this.activeScreen === 'dating') return;
        const input = document.getElementById('profile-comment-input');
        if (!input) return;
        const text = String(input.value || '').trim();
        if (!text) {
            this.showNotification('Write a comment first.');
            return;
        }
        const reviewerName = String(this.currentUser?.name || 'Anonymous').trim() || 'Anonymous';
        const comment = {
            name: reviewerName,
            text,
            createdAt: new Date().toISOString()
        };
        this.addProfileComment(this.activeProfile, comment);
        input.value = '';
        this.renderProfileComments();
        this.showNotification('Comment posted.');
    }

    renderProfileModalContent() {
        const user = this.activeProfile;
        if (!user) return;

        const nameEl = document.getElementById('profile-modal-name');
        if (nameEl) nameEl.textContent = user.age ? `${user.name}, ${user.age}` : (user.name || 'Profile');

	        const locEl = document.getElementById('profile-modal-location');
	        if (locEl) locEl.textContent = this.getProfileLocationLabel(user);

	        const phoneEl = document.getElementById('profile-modal-phone');
	        if (phoneEl) {
	            const raw = String(user.phone || '').trim();
	            if (raw) {
	                const tel = raw.replace(/[^\d+]/g, '');
	                phoneEl.innerHTML = `<i class="fas fa-phone" aria-hidden="true"></i> <a href="tel:${this.escapeHtml(tel)}">${this.escapeHtml(raw)}</a>`;
	                phoneEl.classList.remove('hidden');
	            } else {
	                phoneEl.textContent = '';
	                phoneEl.classList.add('hidden');
	            }
	        }

        const postedEl = document.getElementById('profile-modal-posted');
        if (postedEl) {
            const activityDate = this.getUserActivityDate(user);
            const label = activityDate ? this.formatProfilePostedLabel(activityDate) : '';
            if (label) {
                postedEl.textContent = label;
                postedEl.classList.remove('hidden');
            } else {
                postedEl.textContent = '';
                postedEl.classList.add('hidden');
            }
        }

        const statusDot = document.getElementById('profile-modal-status');
        if (statusDot) statusDot.classList.toggle('offline', !user.online);

        const bioEl = document.getElementById('profile-modal-bio');
        if (bioEl) bioEl.textContent = user.bio || 'No bio added yet.';

        const interestsEl = document.getElementById('profile-modal-interests');
        if (interestsEl) {
            const interests = Array.isArray(user.interests) && user.interests.length
                ? user.interests
                : ['Open to new interests'];
            interestsEl.innerHTML = interests.map(tag => `<span class="profile-modal-tag">${this.escapeHtml(String(tag || ''))}</span>`).join('');
        }

        const lifestyleWrap = document.getElementById('profile-modal-lifestyle-wrap');
        const lifestyleEl = document.getElementById('profile-modal-lifestyle');
        if (lifestyleWrap && lifestyleEl) {
            const entries = this.getLifestyleEntries(user);
            lifestyleEl.innerHTML = entries.map((row) => (
                `<div class="lifestyle-item"><span class="lifestyle-label">${this.escapeHtml(row.label)}</span><span class="lifestyle-value">${this.escapeHtml(row.value)}</span></div>`
            )).join('');
            lifestyleWrap.classList.remove('hidden');
        }

        const arriveWrap = document.getElementById('profile-modal-arrive-wrap');
        const arriveMeta = document.getElementById('profile-modal-arrive-meta');
        const arriveTags = document.getElementById('profile-modal-arrive-tags');
        if (arriveWrap && arriveMeta && arriveTags) {
            const scheduleMatch = this.getScheduleMatchForUser(user);
            const plans = scheduleMatch?.plans || [];
            if (scheduleMatch && plans.length) {
                const range = this.formatScheduleRangeShort(scheduleMatch.startDate, scheduleMatch.endDate);
                const meta = [scheduleMatch.destination, range].filter(Boolean).join(' 路 ');
                arriveMeta.textContent = meta;
                arriveTags.innerHTML = plans.map((plan) => (
                    `<span class="profile-modal-tag">${this.escapeHtml(String(plan || ''))}</span>`
                )).join('');
                arriveWrap.classList.remove('hidden');
            } else {
                arriveWrap.classList.add('hidden');
                arriveMeta.textContent = '';
                arriveTags.innerHTML = '';
            }
        }

        const prefWrap = document.getElementById('profile-modal-preferences-wrap');
        const prefText = document.getElementById('profile-modal-preferences');
        const prefValue = user.matchPreferences || user.looking;
        if (prefWrap) {
            if (prefValue) {
                prefWrap.classList.remove('hidden');
                if (prefText) prefText.textContent = prefValue;
            } else {
                prefWrap.classList.add('hidden');
                if (prefText) prefText.textContent = 'Open to seeing where things go.';
            }
        }

	        const offersWrap = document.getElementById('profile-modal-offers-wrap');
	        const offersEl = document.getElementById('profile-modal-offers');
	        if (offersWrap && offersEl) {
	            if (this.activeScreen === 'dating') {
	                offersWrap.classList.add('hidden');
	                offersEl.innerHTML = '';
	            } else {
	            const offers = this.getMarketplaceOffersForUser(user);
	            if (!offers.length) {
	                offersWrap.classList.add('hidden');
	                offersEl.innerHTML = '';
	            } else {
                offersWrap.classList.remove('hidden');
                offersEl.innerHTML = offers.map((item) => {
                    const thumb = (item.images && item.images[0]) || '';
                    const title = this.escapeHtml(String(item.title || 'Listing'));
                    const category = String(item.category || '').toLowerCase();
                    const isService = category === 'services' || category === 'service';
                    const pill = isService ? 'Service' : 'Item';
                    const pillClass = isService ? 'profile-offer-pill service' : 'profile-offer-pill';
                    const categoryLabel = category ? category.replace(/_/g, ' ') : '';
                    const meta = this.escapeHtml([item.city || '', categoryLabel].filter(Boolean).join('  '));
                    const priceText = typeof item.price === 'number'
                        ? `$${item.price}`
                        : this.escapeHtml(String(item.price || ''));
                    return `
                        <div class="profile-offer-card" data-marketplace-id="${this.escapeHtml(String(item.id))}" role="button" tabindex="0" aria-label="Open ${title}">
                            <img class="profile-offer-thumb" src="${thumb}" alt="${title}">
                            <div>
                                <div class="profile-offer-top">
                                    <span class="${pillClass}"><i class="fas fa-tag" aria-hidden="true"></i> ${pill}</span>
                                    <span class="profile-offer-price">${priceText}</span>
                                </div>
                                <div class="profile-offer-title">${title}</div>
                                <div class="profile-offer-meta">${meta}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                offersEl.querySelectorAll('[data-marketplace-id]').forEach((card) => {
                    if (card.dataset.bound) return;
                    const open = () => {
                        const id = parseInt(card.dataset.marketplaceId, 10);
                        if (!Number.isFinite(id)) return;
                        this.showItemDetails(id);
                    };
                    card.addEventListener('click', open);
                    card.addEventListener('keydown', (e) => {
                        if (e.key !== 'Enter' && e.key !== ' ') return;
                        e.preventDefault();
                        open();
                    });
                    card.dataset.bound = '1';
	                });
	            }
	            }
	        }

        this.renderProfileComments();
        this.updateProfileModalPhoto();
    }

    getMarketplaceOffersForUser(user) {
        if (!user) return [];
        const ids = Array.isArray(user.marketplaceOfferIds) ? user.marketplaceOfferIds : [];
        if (ids.length) {
            const byId = new Map((this.marketplaceItems || []).map((item) => [item.id, item]));
            return ids.map((id) => byId.get(id)).filter(Boolean);
        }
        const sellerName = String(user.name || '').trim().toLowerCase();
        if (!sellerName) return [];
        return (this.marketplaceItems || []).filter((item) => String(item.seller || '').trim().toLowerCase() === sellerName);
    }

    updateProfileModalPhoto() {
        const photos = this.profileModalPhotos || [];
        const index = Math.min(Math.max(this.activeProfilePhotoIndex || 0, 0), Math.max(photos.length - 1, 0));
        this.activeProfilePhotoIndex = index;
        const photoEl = document.getElementById('profile-modal-photo');
        const videoEl = document.getElementById('profile-modal-video');
        const counterEl = document.getElementById('profile-photo-counter');
        const prev = document.getElementById('profile-photo-prev');
        const next = document.getElementById('profile-photo-next');
        const current = photos[index] || {};
        const currentType = current.type || (typeof current === 'string' ? 'image' : 'image');
        const currentSrc = current.src || current;
        const name = this.activeProfile?.name || 'Profile';

        if (photoEl && videoEl) {
            const showVideo = currentType === 'video';
            photoEl.classList.toggle('hidden', showVideo);
            videoEl.classList.toggle('hidden', !showVideo);
            if (showVideo) {
                videoEl.src = currentSrc;
                videoEl.setAttribute('aria-label', `${name} video`);
            } else {
                photoEl.src = currentSrc;
                photoEl.alt = `${name} photo ${index + 1}`;
                videoEl.pause();
                videoEl.removeAttribute('src');
                videoEl.load();
            }
        }
        if (counterEl) counterEl.textContent = `${index + 1} / ${photos.length || 1}`;
        if (prev) prev.disabled = photos.length <= 1 || index === 0;
        if (next) next.disabled = photos.length <= 1 || index >= photos.length - 1;
    }

    stepProfilePhoto(delta = 1) {
        const photos = this.profileModalPhotos || [];
        if (!photos.length) return;
        const nextIndex = this.activeProfilePhotoIndex + delta;
        if (nextIndex < 0 || nextIndex >= photos.length) return;
        this.activeProfilePhotoIndex = nextIndex;
        this.updateProfileModalPhoto();
    }

    handleProfileMessage() {
        if (!this.activeProfile) return;
        const profile = this.activeProfile;
        const name = profile?.name || 'this match';
        const photo = profile?.photo || profile?.photos?.[0] || '';
        const status = profile?.online ? 'Online' : 'Offline';
        this.closeProfileModal();
        this.openChatModal({
            name,
            photo,
            status,
            threadKey: `dating:${profile?.id ?? (this.normalizeSellerKey(name) || 'match')}`,
            placeholder: `Send a message to ${name}`
        });
    }

    handleProfileLike() {
        if (!this.activeProfile) return;
        const name = this.activeProfile?.name || 'this match';
        this.showNotification(`You liked ${name}'s profile.`);
        if (this.addMatch(this.activeProfile)) {
            this.addNotification({
                title: 'New match',
                message: `You matched with ${name}.`,
                type: 'match'
            });
        }
    }

    handleProfileGift(type) {
        if (!this.activeProfile) return;
        const name = this.activeProfile?.name || 'this match';
        if (type === 'flowers') {
            this.showNotification(`You sent a flower to ${name}. Theyll see it first in their feed.`);
        } else {
            this.showNotification(`You sent credits to ${name}. Theyll be notified to message you.`);
        }
    }

    handleDatingCategorySelect(value) {
        if (!value) {
            this.closeDatingCategory(false);
            return;
        }
        this.openDatingCategory(value);
    }

		    openDatingCategory(categoryKey) {
        const baseView = document.getElementById('dating-base-view');
        const categoryPage = document.getElementById('dating-category-page');
        if (!categoryPage || !baseView) return;

        baseView.classList.add('hidden');
        categoryPage.classList.remove('hidden');

	        this.currentDatingCategory = categoryKey;
	        this.currentDatingCategoryFilter = this.currentDatingCategoryFilter || 'all';

	        if (!this.isApplyingRoute) {
	            this.updateBrowserRoute(this.getCurrentRoute(), { replace: false });
	        }

	        const datingContent = document.getElementById('dating-content');
	        const arrivePlusSchedule = document.getElementById('arrive-plus-schedule');
	        if (datingContent) {
	            datingContent.classList.toggle('companionship-mode', categoryKey === 'companionship');
	            datingContent.classList.toggle('hookup-plus-mode', categoryKey === 'instant_meetups');
	        }
	        if (arrivePlusSchedule) {
	            arrivePlusSchedule.classList.toggle('hidden', categoryKey !== 'arrive_plus');
	        }

	        const headerTitle = document.getElementById('dating-header-title');
	        if (headerTitle) {
	            if (categoryKey === 'companionship') {
	                headerTitle.textContent = 'Companionship';
	            } else if (categoryKey === 'instant_meetups') {
	                headerTitle.textContent = 'Hookup+';
	            } else if (categoryKey === 'arrive_plus') {
	                headerTitle.textContent = 'Arrive+';
	            } else {
	                headerTitle.textContent = 'Dating';
	            }
	        }

        const select = document.getElementById('dating-category');
        if (select && select.value !== categoryKey) select.value = categoryKey;

        const title = document.getElementById('dating-category-title');
        if (title) title.textContent = this.datingCategoryLabels?.[categoryKey] || 'Category';
        const subtitle = document.getElementById('dating-category-subtitle');
        if (subtitle) subtitle.textContent = this.getDatingCategorySubtitle(categoryKey);

        this.updateDatingCategoryFilterButtons(this.currentDatingCategoryFilter);
        this.renderDatingCategoryFeed();
    }

	    closeDatingCategory(resetSelect = false) {
        const baseView = document.getElementById('dating-base-view');
        const categoryPage = document.getElementById('dating-category-page');
        if (baseView) baseView.classList.remove('hidden');
        if (categoryPage) categoryPage.classList.add('hidden');

	        this.currentDatingCategory = null;
	        this.currentDatingCategoryFilter = 'all';

	        if (!this.isApplyingRoute && this.activeScreen === 'dating') {
	            this.updateBrowserRoute(this.getCurrentRoute(), { replace: false });
	        }

	        const datingContent = document.getElementById('dating-content');
	        if (datingContent) {
	            datingContent.classList.remove('companionship-mode');
	            datingContent.classList.remove('hookup-plus-mode');
	        }
	        const arrivePlusSchedule = document.getElementById('arrive-plus-schedule');
	        if (arrivePlusSchedule) arrivePlusSchedule.classList.add('hidden');

        const headerTitle = document.getElementById('dating-header-title');
        if (headerTitle) headerTitle.textContent = 'Dating';

	        if (resetSelect) {
	            const select = document.getElementById('dating-category');
	            if (select) select.value = '';
	        }

	        this.hideHookupPlusPane();
	        this.hideCompanionshipPane();
	        this.updateDatingCategoryFilterButtons('all');
	        this.applyDatingFilters();
	    }

    showCompanionshipPane() {
        // Ensure companionship feed can render even if other navigation code reset the category state.
        this.currentDatingCategory = 'companionship';
        this.currentDatingCategoryFilter = this.currentDatingCategoryFilter || 'all';

        const pane = document.getElementById('companionship-pane');
        const defaultFeed = document.getElementById('dating-category-feed');
        if (!pane) {
            if (defaultFeed) defaultFeed.classList.remove('hidden');
            return;
        }
        if (defaultFeed) defaultFeed.classList.add('hidden');
        pane.classList.remove('hidden');
        this.resetCompanionshipPagination();
        this.applyCompanionshipFilters();
        this.startCompanionshipTimeTicker();
    }

    hideCompanionshipPane() {
        const pane = document.getElementById('companionship-pane');
        const defaultFeed = document.getElementById('dating-category-feed');
        if (pane) pane.classList.add('hidden');
        if (defaultFeed) defaultFeed.classList.remove('hidden');
        this.stopCompanionshipTimeTicker();
    }

    showHookupPlusPane() {
        this.currentDatingCategory = 'instant_meetups';
        this.currentDatingCategoryFilter = this.currentDatingCategoryFilter || 'all';

        const pane = document.getElementById('hookup-plus-pane');
        const defaultFeed = document.getElementById('dating-category-feed');
        if (!pane) {
            if (defaultFeed) defaultFeed.classList.remove('hidden');
            return;
        }

        // Ensure other category panes are hidden.
        this.hideCompanionshipPane();
        if (defaultFeed) defaultFeed.classList.add('hidden');
        pane.classList.remove('hidden');

        this.setupHookupPlusUi();
        this.resetHookupPlusDeck({ shuffle: false });
    }

    hideHookupPlusPane() {
        const pane = document.getElementById('hookup-plus-pane');
        const defaultFeed = document.getElementById('dating-category-feed');
        if (pane) pane.classList.add('hidden');
        if (defaultFeed) defaultFeed.classList.remove('hidden');
        this.hookupPlusAnimating = false;
        this.hookupPlusDragging = null;
    }

	    setupHookupPlusUi() {
	        const pane = document.getElementById('hookup-plus-pane');
	        if (!pane) return;

	        const cityInput = document.getElementById('hookup-plus-city');
	        const radiusInput = document.getElementById('hookup-plus-radius');
	        const radiusValue = document.getElementById('hookup-plus-radius-value');
	        const refreshBtn = document.getElementById('hookup-plus-refresh');
	        const passBtn = document.getElementById('hookup-plus-pass');
	        const likeBtn = document.getElementById('hookup-plus-like');
	        const detailsBtn = document.getElementById('hookup-plus-details');

        const defaultCity =
            this.hookupPlusFilters.city ||
            this.currentUser?.location?.city ||
            '';
        if (cityInput && !cityInput.value) cityInput.value = defaultCity;
        if (cityInput && defaultCity && this.hookupPlusFilters.city !== defaultCity) {
            this.hookupPlusFilters.city = defaultCity;
        }

        if (radiusInput) {
            const next = Number(this.hookupPlusFilters.radiusKm) || 10;
            radiusInput.value = String(Math.min(50, Math.max(1, next)));
            if (radiusValue) radiusValue.textContent = `${radiusInput.value}km`;
        }

        if (cityInput && !cityInput.dataset.bound) {
            const schedule = (() => {
                let t = null;
                return () => {
                    if (t) window.clearTimeout(t);
                    t = window.setTimeout(() => this.resetHookupPlusDeck({ shuffle: false }), 200);
                };
            })();
            cityInput.addEventListener('input', () => {
                this.hookupPlusFilters.city = String(cityInput.value || '').trim();
                schedule();
            });
            cityInput.dataset.bound = '1';
        }

        if (radiusInput && !radiusInput.dataset.bound) {
            radiusInput.addEventListener('input', () => {
                const next = Number(radiusInput.value) || 10;
                this.hookupPlusFilters.radiusKm = next;
                if (radiusValue) radiusValue.textContent = `${next}km`;
            });
            radiusInput.addEventListener('change', () => this.resetHookupPlusDeck({ shuffle: false }));
            radiusInput.dataset.bound = '1';
        }

        if (refreshBtn && !refreshBtn.dataset.bound) {
            refreshBtn.addEventListener('click', () => this.resetHookupPlusDeck({ shuffle: true }));
            refreshBtn.dataset.bound = '1';
        }

        if (passBtn && !passBtn.dataset.bound) {
            passBtn.addEventListener('click', () => this.hookupPlusSwipe('pass'));
            passBtn.dataset.bound = '1';
        }

        if (likeBtn && !likeBtn.dataset.bound) {
            likeBtn.addEventListener('click', () => this.hookupPlusSwipe('like'));
            likeBtn.dataset.bound = '1';
        }

	        if (detailsBtn && !detailsBtn.dataset.bound) {
	            detailsBtn.addEventListener('click', () => this.openHookupPlusDetails());
	            detailsBtn.dataset.bound = '1';
	        }

        if (!pane.dataset.boundKeys) {
            document.addEventListener('keydown', (e) => {
                const isActive = !document.getElementById('hookup-plus-pane')?.classList.contains('hidden');
                if (!isActive) return;
                if (e.key === 'ArrowLeft') this.hookupPlusSwipe('pass');
                if (e.key === 'ArrowRight') this.hookupPlusSwipe('like');
                if (e.key === 'ArrowUp') this.openHookupPlusDetails();
            });
            pane.dataset.boundKeys = '1';
        }
    }

    computeDistanceKm(a, b) {
        if (!a || !b) return null;
        const lat1 = Number(a.lat);
        const lon1 = Number(a.lng);
        const lat2 = Number(b.lat);
        const lon2 = Number(b.lng);
        if (![lat1, lon1, lat2, lon2].every(Number.isFinite)) return null;
        const toRad = (deg) => (deg * Math.PI) / 180;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const sa = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(sa), Math.sqrt(1 - sa));
        return R * c;
    }

    resolveHookupPlusCenter() {
        const city = String(this.hookupPlusFilters.city || '').trim();
        if (this.userLocation?.lat && this.userLocation?.lng) {
            const label = city || this.currentUser?.location?.city || 'Nearby';
            return { lat: this.userLocation.lat, lng: this.userLocation.lng, label };
        }
        if (city) {
            const matchKey = Object.keys(this.companionshipCityGeo || {}).find((k) => k.toLowerCase().startsWith(`${city.toLowerCase()}|`));
            if (matchKey) {
                const coords = this.companionshipCityGeo[matchKey];
                if (coords?.lat && coords?.lng) return { lat: coords.lat, lng: coords.lng, label: city };
            }
        }
        const fallbackCity = this.currentUser?.location?.city || city;
        if (fallbackCity) {
            const matchKey = Object.keys(this.companionshipCityGeo || {}).find((k) => k.toLowerCase().startsWith(`${String(fallbackCity).toLowerCase()}|`));
            if (matchKey) {
                const coords = this.companionshipCityGeo[matchKey];
                if (coords?.lat && coords?.lng) return { lat: coords.lat, lng: coords.lng, label: fallbackCity };
            }
        }
        return null;
    }

	    normalizeHookupPlusProfile(item) {
	        if (!item) return null;
        const isMeetupFeedItem = typeof item.title === 'string' && (Object.prototype.hasOwnProperty.call(item, 'subtitle') || Object.prototype.hasOwnProperty.call(item, 'distance'));
        if (isMeetupFeedItem) {
            const rawTitle = String(item.title || '').trim();
            const [left, rolePart] = rawTitle.split('').map((s) => String(s || '').trim());
            const [namePart, agePart] = left.split(',').map((s) => String(s || '').trim());
            const age = agePart ? parseInt(agePart, 10) : null;
            const name = namePart || 'Profile';
            const role = rolePart || '';
            return {
                id: String(item.id || name).trim(),
                name,
                age: Number.isFinite(age) ? age : null,
                role,
                subtitle: String(item.subtitle || '').trim(),
                bio: String(item.description || '').trim(),
                photos: Array.isArray(item.photos) ? item.photos.filter(Boolean) : [],
                online: item.online === true,
                premium: item.premium === true,
                distanceKm: Number.isFinite(Number(item.distance)) ? Number(item.distance) : null,
                city: String(this.hookupPlusFilters.city || this.currentUser?.location?.city || '').trim(),
                country: String(this.currentUser?.location?.country || '').trim()
            };
        }
        const photos = Array.isArray(item.photos) ? item.photos.filter(Boolean) : [];
        return {
            id: `u:${item.id || item.name || Math.random().toString(16).slice(2)}`,
            name: String(item.name || 'Profile'),
            age: item.age ?? null,
            role: String(item.lifestylePreferences?.occupation || item.lifestyle?.occupation || ''),
            subtitle: '',
            bio: String(item.bio || ''),
            photos,
            online: item.online === true,
            premium: item.isPremium === true,
            distanceKm: null,
            city: String(item.location?.city || item.location?.location || item.location?.name || item.city || ''),
            country: String(item.location?.country || item.country || ''),
            lat: item.location?.lat,
            lng: item.location?.lng
	        };
	    }

	    buildHookupPlusDeck() {
	        const radiusKm = Number(this.hookupPlusFilters.radiusKm) || 10;
	        const center = this.resolveHookupPlusCenter();

	        const baseProfiles = (this.datingCategoryFeeds?.instant_meetups || []).map((item) => this.normalizeHookupPlusProfile(item)).filter(Boolean);
	        const userProfiles = (Array.isArray(this.users) ? this.users : []).map((u) => this.normalizeHookupPlusProfile(u)).filter(Boolean);

        const merged = [...baseProfiles, ...userProfiles].map((p) => {
            let distanceKm = p.distanceKm;
            if (!Number.isFinite(distanceKm) && center && Number.isFinite(Number(p.lat)) && Number.isFinite(Number(p.lng))) {
                distanceKm = this.computeDistanceKm(center, { lat: p.lat, lng: p.lng });
            }
            return { ...p, distanceKm: Number.isFinite(distanceKm) ? distanceKm : null };
        });

	        const filtered = merged.filter((p) => {
	            if (!Number.isFinite(p.distanceKm)) return true;
	            return p.distanceKm <= radiusKm;
	        });

	        return { deck: filtered };
	    }

	    resetHookupPlusDeck({ shuffle = false } = {}) {
	        const { deck } = this.buildHookupPlusDeck();
	        const next = Array.isArray(deck) ? deck.slice() : [];
	        if (shuffle && next.length > 1) {
	            for (let i = next.length - 1; i > 0; i--) {
	                const j = Math.floor(Math.random() * (i + 1));
                [next[i], next[j]] = [next[j], next[i]];
            }
	        }
	        this.hookupPlusDeck = next;
	        this.hookupPlusDeckIndex = 0;
	        this.renderHookupPlusDeck();
	    }

    renderHookupPlusDeck() {
        const pane = document.getElementById('hookup-plus-pane');
        const deckEl = document.getElementById('hookup-plus-deck');
        const emptyEl = document.getElementById('hookup-plus-empty');
        if (!pane || pane.classList.contains('hidden') || !deckEl) return;

        const remaining = this.hookupPlusDeck.slice(this.hookupPlusDeckIndex);
        if (!remaining.length) {
            deckEl.innerHTML = '';
            if (emptyEl) emptyEl.classList.remove('hidden');
            return;
        }
        if (emptyEl) emptyEl.classList.add('hidden');

	        const stack = remaining.slice(0, 3);
	        deckEl.innerHTML = stack.map((profile, i) => {
            const isTop = i === 0;
            const offset = i * 10;
            const scale = 1 - i * 0.035;
            const photos = Array.isArray(profile.photos) ? profile.photos : [];
            const src = photos[0] || 'https://via.placeholder.com/900x1200/ebeef5/111827?text=Profile';
            const distanceText = Number.isFinite(profile.distanceKm) ? `${Math.round(profile.distanceKm)}km` : '';
            const onlineText = profile.online ? 'Online now' : 'Offline';
            const dotStyle = profile.online ? '' : 'style="background:#94a3b8"';
            const roleLine = [profile.role, profile.city].filter(Boolean).join(' 路 ');

	            return `
	                <article class="hookup-plus-card${isTop ? ' is-top' : ''}" data-profile-id="${this.escapeHtml(String(profile.id))}"
	                    style="transform: translateY(${offset}px) scale(${scale});">
                    <div class="hookup-plus-card-media">
                        <img src="${this.escapeHtml(src)}" alt="${this.escapeHtml(profile.name)} photo" loading="lazy" decoding="async">
                    </div>
                    <div class="hookup-plus-card-overlay" aria-hidden="true"></div>
                    <div class="hookup-plus-card-badges" aria-hidden="true">
                        <div class="hookup-plus-badge"><span class="dot" ${dotStyle}></span>${this.escapeHtml(onlineText)}</div>
                        ${distanceText ? `<div class="hookup-plus-badge"><i class="fas fa-location-dot" aria-hidden="true"></i>${this.escapeHtml(distanceText)}</div>` : ''}
                    </div>
	                    <div class="hookup-plus-card-meta">
	                        <h3>${this.escapeHtml(profile.name)}${profile.age ? `, ${this.escapeHtml(String(profile.age))}` : ''}</h3>
	                        ${roleLine ? `<p>${this.escapeHtml(roleLine)}</p>` : ''}
	                        ${profile.subtitle ? `<p>${this.escapeHtml(profile.subtitle)}</p>` : (profile.bio ? `<p>${this.escapeHtml(profile.bio)}</p>` : '')}
	                    </div>
	                </article>
	            `;
	        }).join('');

	        // Bind interactions to the top card after rendering.
	        this.bindHookupPlusTopCard();
	    }

    bindHookupPlusTopCard() {
        const deckEl = document.getElementById('hookup-plus-deck');
        const card = deckEl?.querySelector?.('.hookup-plus-card.is-top');
        if (!card || card.dataset.bound) return;

        const start = (e) => {
            if (this.hookupPlusAnimating) return;
            this.hookupPlusDragging = {
                id: card.getAttribute('data-profile-id') || '',
                pointerId: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                moved: false
            };
            card.style.transition = 'none';
            try { card.setPointerCapture(e.pointerId); } catch {}
        };

        const move = (e) => {
            const s = this.hookupPlusDragging;
            if (!s || s.pointerId !== e.pointerId) return;
            const dx = e.clientX - s.startX;
            const dy = e.clientY - s.startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) s.moved = true;
            const rot = Math.max(-18, Math.min(18, dx * 0.06));
            card.style.transform = `translateX(${dx}px) rotate(${rot}deg)`;
            card.style.opacity = String(Math.max(0.65, 1 - Math.abs(dx) / 420));
        };

        const end = (e) => {
            const s = this.hookupPlusDragging;
            if (!s || (e && s.pointerId !== e.pointerId)) return;
            this.hookupPlusDragging = null;
            const rect = card.getBoundingClientRect();
            const dx = rect.left + rect.width / 2 - window.innerWidth / 2;
            if (Math.abs(dx) > 110) {
                this.hookupPlusSwipe(dx > 0 ? 'like' : 'pass', { fromGesture: true });
                return;
            }
            card.style.transition = 'transform 0.22s ease, opacity 0.22s ease';
            card.style.transform = '';
            card.style.opacity = '1';
        };

	        const click = (e) => {
	            if (this.hookupPlusAnimating) return;
	            const s = this.hookupPlusDragging;
	            if (s?.moved) return;
	            this.openHookupPlusDetails();
	        };

        card.addEventListener('pointerdown', start);
        card.addEventListener('pointermove', move);
        card.addEventListener('pointerup', end);
        card.addEventListener('pointercancel', end);
        card.addEventListener('click', click);

	        card.dataset.bound = '1';
	    }

    openHookupPlusDetails() {
        const profile = this.hookupPlusDeck[this.hookupPlusDeckIndex];
        if (!profile) return;
        const demo = {
            id: profile.id,
            name: profile.name,
            age: profile.age,
            role: profile.role || '',
            distance: Number.isFinite(profile.distanceKm) ? `${Math.round(profile.distanceKm)}km away` : '',
            looking: profile.subtitle || 'Open to meeting nearby.',
            bio: profile.bio || profile.subtitle || '',
            online: profile.online === true,
            statusText: profile.online ? 'Online now' : 'Offline',
            photos: profile.photos || []
        };
        this.openDemoProfileObject(demo);
    }

    hookupPlusSwipe(direction, { fromGesture = false } = {}) {
        if (this.hookupPlusAnimating) return;
        const profile = this.hookupPlusDeck[this.hookupPlusDeckIndex];
        if (!profile) return;

        const deckEl = document.getElementById('hookup-plus-deck');
        const card = deckEl?.querySelector?.('.hookup-plus-card.is-top');
        if (!card) return;

        this.hookupPlusAnimating = true;

        const like = direction === 'like';
        if (like) this.hookupPlusLikes.add(profile.id);
        else this.hookupPlusPasses.add(profile.id);
        if (like) {
            this.addNotification({
                title: 'Hookup+',
                message: `You liked ${profile.name}.`,
                type: 'dating'
            });
        }

        const targetX = like ? window.innerWidth * 1.2 : -window.innerWidth * 1.2;
        card.style.transition = 'transform 0.26s ease, opacity 0.26s ease';
        card.style.transform = `translateX(${targetX}px) rotate(${like ? 18 : -18}deg)`;
        card.style.opacity = '0';

        const shouldMatch = like && Math.random() < (profile.premium ? 0.42 : 0.28);

        window.setTimeout(() => {
            this.hookupPlusDeckIndex += 1;
            this.hookupPlusAnimating = false;
            this.renderHookupPlusDeck();
            if (shouldMatch) {
                const photo = Array.isArray(profile.photos) ? profile.photos[0] : '';
                this.addNotification({
                    title: 'Hookup+',
                    message: `${profile.name} is interested in you.`,
                    type: 'dating'
                });
                this.openMatchModal({ name: profile.name, photo });
            }
        }, 270);

        if (fromGesture) {
            // Clear gesture transform state (the card will be re-rendered).
            try { card.releasePointerCapture?.(this.hookupPlusDragging?.pointerId); } catch {}
        }
    }

    resetCompanionshipPagination() {
        this.companionshipFeedPage = 1;
    }

	    setupCompanionshipUI() {
	        const countrySelect = document.getElementById('companionship-country');
	        const regionSelect = document.getElementById('companionship-region');
	        const citySelect = document.getElementById('companionship-city');
        const nearBtn = document.getElementById('companionship-near-me');
        const clearBtn = document.getElementById('companionship-clear');
	        const postTrigger = document.getElementById('companionship-post-trigger');
	        const promoteBtn = document.getElementById('companionship-promote-ad');
        const postMinimize = document.getElementById('companionship-post-minimize');
        const postMaximize = document.getElementById('companionship-post-maximize');
        const postClose = document.getElementById('companionship-post-close');
        const postModal = document.getElementById('companionship-post-modal');
        const postRestore = document.getElementById('companionship-post-restore');
        const postCancel = document.getElementById('companionship-post-cancel');
        const postForm = document.getElementById('companionship-post-form');
        const storyVideoInput = document.getElementById('companionship-video-file');
        const storyPreview = document.getElementById('companionship-story-preview');
        const storyStatus = document.getElementById('companionship-story-status');
        const photoInput = document.getElementById('companionship-images-file');
        const photoSlots = document.getElementById('companionship-photo-slots');
        const formCountry = document.getElementById('companionship-country-input');
        const formRegion = document.getElementById('companionship-region-input');
        const formCity = document.getElementById('companionship-city-input');
        const genderFilter = document.getElementById('companionship-gender-filter');
        const seekingFilter = document.getElementById('companionship-seeking-filter');
        const categoryCards = document.querySelectorAll('.companionship-category-card');
	        const miniCountry = document.getElementById('companionship-mini-country');
	        const miniRegion = document.getElementById('companionship-mini-region');
	        const miniCity = document.getElementById('companionship-mini-city');
	        const hasTopLocationFilters = Boolean(countrySelect && regionSelect && citySelect);
	        const previewUpdate = () => this.renderCompanionshipPostLivePreview();

	        if (hasTopLocationFilters) {
	            this.populateCompanionshipCountries();
	            this.populateCompanionshipRegions('');
	            this.populateCompanionshipCities('', '');
	        }
        this.populateCompanionshipMiniCountries();
        this.populateCompanionshipMiniRegions('');
        this.populateCompanionshipMiniCities('', '');
        this.populateCompanionshipFormCountries();
        this.populateCompanionshipFormRegions('');
        this.populateCompanionshipFormCities('', '');

        if (countrySelect && !countrySelect.dataset.bound) {
            countrySelect.addEventListener('change', (e) => {
                const value = e.target.value;
                this.companionshipFilters.country = value;
                this.companionshipFilters.region = '';
                this.companionshipFilters.city = '';
                this.populateCompanionshipRegions(value);
                this.populateCompanionshipCities(value, '');
                this.populateCompanionshipMiniRegions(value);
                this.populateCompanionshipMiniCities(value, '');
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            countrySelect.dataset.bound = '1';
        }

        if (regionSelect && !regionSelect.dataset.bound) {
            regionSelect.addEventListener('change', (e) => {
                const value = e.target.value;
                this.companionshipFilters.region = value;
                this.companionshipFilters.city = '';
                this.populateCompanionshipCities(this.companionshipFilters.country, value);
                this.populateCompanionshipMiniCities(this.companionshipFilters.country, value);
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            regionSelect.dataset.bound = '1';
        }

        if (citySelect && !citySelect.dataset.bound) {
            citySelect.addEventListener('change', (e) => {
                this.companionshipFilters.city = e.target.value;
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            citySelect.dataset.bound = '1';
        }

        if (nearBtn && !nearBtn.dataset.bound) {
            nearBtn.addEventListener('click', () => {
                if (!this.userLocation) {
                    this.showNotification('Turn on location to use Near me.');
                    return;
                }
                this.companionshipFilters.nearMe = !this.companionshipFilters.nearMe;
                nearBtn.classList.toggle('active', this.companionshipFilters.nearMe);
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            nearBtn.dataset.bound = '1';
        }

        if (clearBtn && !clearBtn.dataset.bound) {
            clearBtn.addEventListener('click', () => {
                this.companionshipFilters = {
                    country: '',
                    region: '',
                    city: '',
                    nearMe: false,
                    gender: '',
                    seeking: '',
                    category: '',
                    query: '',
                    onlineOnly: false,
                    sort: 'smart'
                };
                if (nearBtn) nearBtn.classList.remove('active');
                if (hasTopLocationFilters) {
                    this.populateCompanionshipCountries();
                    this.populateCompanionshipRegions('');
                    this.populateCompanionshipCities('', '');
                }
                if (genderFilter) genderFilter.value = '';
                if (seekingFilter) seekingFilter.value = '';
                this.updateCompanionshipCategoryCards('');
                this.populateCompanionshipMiniCountries();
                this.populateCompanionshipMiniRegions('');
                this.populateCompanionshipMiniCities('', '');
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            clearBtn.dataset.bound = '1';
        }

	        if (postForm && !postForm.dataset.bound) {
	            postForm.addEventListener('submit', (e) => this.handleCompanionshipPostSubmit(e));
	            postForm.dataset.bound = '1';
	        }

            if (promoteBtn && !promoteBtn.dataset.bound) {
                promoteBtn.addEventListener('click', () => {
                    this.promoteCompanionshipAds();
                });
                promoteBtn.dataset.bound = '1';
            }

        const clearPostPhotos = ({ revoke = true } = {}) => {
            const list = Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [];
            if (revoke) {
                list.forEach((it) => {
                    if (it?.url) {
                        try { URL.revokeObjectURL(it.url); } catch {}
                    }
                });
            }
            this.companionshipPostImages = [];
            if (photoInput) photoInput.value = '';
            if (photoSlots) photoSlots.innerHTML = '';
        };

	        const renderPhotoSlots = () => {
	            if (!photoSlots) return;
            const list = Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [];
            const max = 5;
            const slots = Array.from({ length: max }).map((_, idx) => {
                const item = list[idx];
                if (item?.url) {
                    return `
                        <div class="companionship-photo-slot" data-idx="${idx}" aria-label="Photo ${idx + 1}">
                            <img src="${this.escapeHtml(item.url)}" alt="Selected photo ${idx + 1}">
                            <span class="sr-only">Selected photo ${idx + 1}</span>
                            <button type="button" class="companionship-photo-remove" data-idx="${idx}" aria-label="Remove photo ${idx + 1}">&times;</button>
                        </div>
                    `;
                }
                return `
                    <button type="button" class="companionship-photo-slot is-empty" data-add="1" aria-label="Add photo">
                        <span>+</span>
                    </button>
                `;
	            }).join('');
	            photoSlots.innerHTML = slots;
	            previewUpdate();

	            photoSlots.querySelectorAll('[data-add="1"]').forEach((btn) => {
	                if (btn.dataset.bound) return;
	                btn.addEventListener('click', () => photoInput?.click());
                btn.dataset.bound = '1';
            });
            photoSlots.querySelectorAll('.companionship-photo-remove').forEach((btn) => {
                if (btn.dataset.bound) return;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.idx || '', 10);
                    if (!Number.isFinite(idx)) return;
                    const current = Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [];
                    const item = current[idx];
                    if (item?.url) {
                        try { URL.revokeObjectURL(item.url); } catch {}
                    }
                    this.companionshipPostImages = current.filter((_, i) => i !== idx);
                    renderPhotoSlots();
                });
                btn.dataset.bound = '1';
            });
        };

        if (photoInput && !photoInput.dataset.bound) {
            photoInput.addEventListener('change', () => {
                const incoming = Array.from(photoInput.files || []).filter((f) => f && f.type && f.type.startsWith('image/'));
                if (!incoming.length) return;
                const existing = Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [];
                const byKey = new Map(existing.map((it) => [it.key, it]));
                incoming.forEach((file) => {
                    const key = `${file.name}|${file.size}|${file.lastModified}`;
                    if (byKey.has(key)) return;
                    if (byKey.size >= 5) return;
                    const url = URL.createObjectURL(file);
                    byKey.set(key, { key, file, url });
                });
                this.companionshipPostImages = Array.from(byKey.values()).slice(0, 5);
                photoInput.value = '';
                renderPhotoSlots();
            });
            photoInput.dataset.bound = '1';
        }

	        const clearStoryPreview = () => {
	            if (storyStatus) {
	                storyStatus.textContent = '';
	                storyStatus.classList.remove('error');
	            }
            if (storyPreview) {
                try { storyPreview.pause(); } catch {}
                storyPreview.classList.add('hidden');
                storyPreview.removeAttribute('src');
                storyPreview.load();
            }
	            if (this.companionshipPostStoryPreviewUrl) {
	                try { URL.revokeObjectURL(this.companionshipPostStoryPreviewUrl); } catch {}
	                this.companionshipPostStoryPreviewUrl = '';
	            }
	            previewUpdate();
	        };

        if (storyVideoInput && !storyVideoInput.dataset.bound) {
            storyVideoInput.addEventListener('change', async () => {
                clearStoryPreview();
                const modal = document.getElementById('companionship-post-modal');
                const file = storyVideoInput.files?.[0] || null;
                if (!file) return;
                const requestId = String(Date.now() + Math.random());
                storyVideoInput.dataset.storyPreviewRequest = requestId;
                if (storyStatus) storyStatus.textContent = 'Checking video';
                const result = await this.validateShortVideo(file, 5, 10);
                if (storyVideoInput.dataset.storyPreviewRequest !== requestId) {
                    if (result?.ok && result.url) {
                        try { URL.revokeObjectURL(result.url); } catch {}
                    }
                    return;
                }
                if (!modal || modal.classList.contains('hidden')) {
                    if (result?.ok && result.url) {
                        try { URL.revokeObjectURL(result.url); } catch {}
                    }
                    return;
                }
	                if (!result.ok) {
	                    if (storyStatus) {
	                        storyStatus.textContent = result.message || 'Video must be 510 seconds.';
	                        storyStatus.classList.add('error');
	                    }
	                    storyVideoInput.value = '';
	                    previewUpdate();
	                    return;
	                }
	                this.companionshipPostStoryPreviewUrl = result.url || '';
	                if (storyPreview && this.companionshipPostStoryPreviewUrl) {
	                    storyPreview.src = this.companionshipPostStoryPreviewUrl;
	                    storyPreview.classList.remove('hidden');
	                    storyPreview.play().catch(() => {});
	                }
	                if (storyStatus) storyStatus.textContent = 'Looks good (510 seconds).';
	                previewUpdate();
	            });
	            storyVideoInput.dataset.bound = '1';
	        }

        if (postTrigger && !postTrigger.dataset.bound) {
            postTrigger.addEventListener('click', () => this.openCompanionshipPostModal());
            postTrigger.dataset.bound = '1';
        }
        if (postMinimize && !postMinimize.dataset.bound) {
            postMinimize.addEventListener('click', () => this.closeCompanionshipPostModal(true));
            postMinimize.dataset.bound = '1';
        }
        if (postMaximize && !postMaximize.dataset.bound) {
            postMaximize.addEventListener('click', () => {
                const modalContent = postModal?.querySelector('.modal-content');
                if (!modalContent) return;
                const isMaximized = modalContent.classList.toggle('is-maximized');
                postMaximize.setAttribute('aria-pressed', isMaximized ? 'true' : 'false');
            });
            postMaximize.dataset.bound = '1';
        }
        if (postClose && !postClose.dataset.bound) {
            postClose.addEventListener('click', () => this.closeCompanionshipPostModal());
            postClose.dataset.bound = '1';
        }
        if (postCancel && !postCancel.dataset.bound) {
            postCancel.addEventListener('click', () => this.closeCompanionshipPostModal());
            postCancel.dataset.bound = '1';
        }
        if (postModal && !postModal.dataset.bound) {
            postModal.addEventListener('click', (e) => {
                if (e.target === postModal) this.closeCompanionshipPostModal();
            });
            postModal.dataset.bound = '1';
        }
	        if (postRestore && !postRestore.dataset.bound) {
	            postRestore.addEventListener('click', () => this.openCompanionshipPostModal());
	            postRestore.dataset.bound = '1';
	        }

	        [
	            'companionship-alias',
	            'companionship-age',
	            'companionship-ad-category',
	            'companionship-country-input',
	            'companionship-region-input',
	            'companionship-city-input',
	            'companionship-tagline',
	            'companionship-description',
	            'companionship-story-text'
	        ].forEach((id) => {
	            const el = document.getElementById(id);
	            if (!el || el.dataset.boundPreview) return;
	            const eventName = el.tagName === 'SELECT' ? 'change' : 'input';
	            el.addEventListener(eventName, previewUpdate);
	            el.addEventListener('change', previewUpdate);
	            el.dataset.boundPreview = '1';
	        });
	        previewUpdate();

	        if (formCountry && !formCountry.dataset.bound) {
	            formCountry.addEventListener('change', (e) => {
	                const value = e.target.value;
	                this.populateCompanionshipFormRegions(value);
                this.populateCompanionshipFormCities(value, '');
            });
            formCountry.dataset.bound = '1';
        }
        if (formRegion && !formRegion.dataset.bound) {
            formRegion.addEventListener('change', (e) => {
                const value = e.target.value;
                this.populateCompanionshipFormCities(formCountry?.value || '', value);
            });
            formRegion.dataset.bound = '1';
        }

        if (genderFilter && !genderFilter.dataset.bound) {
            genderFilter.addEventListener('change', (e) => {
                this.companionshipFilters.gender = e.target.value;
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            genderFilter.dataset.bound = '1';
        }
        if (seekingFilter && !seekingFilter.dataset.bound) {
            seekingFilter.addEventListener('change', (e) => {
                this.companionshipFilters.seeking = e.target.value;
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            seekingFilter.dataset.bound = '1';
        }

        categoryCards.forEach((card) => {
            if (card.dataset.bound) return;
            card.addEventListener('click', () => {
                const key = card.dataset.category || '';
                const next = (this.companionshipFilters.category === key) ? '' : key;
                this.companionshipFilters.category = next;
                this.updateCompanionshipCategoryCards(next);
                this.resetCompanionshipPagination();
                this.applyCompanionshipFilters();
            });
            card.dataset.bound = '1';
        });
        this.updateCompanionshipCategoryCards(this.companionshipFilters.category || '');

        const isSelect = (el) => el && el.tagName === 'SELECT';
        const syncMiniLocation = () => {
            this.companionshipFilters.country = (miniCountry?.value || '').trim();
            this.companionshipFilters.region = (miniRegion?.value || '').trim();
            this.companionshipFilters.city = (miniCity?.value || '').trim();
        };

        if (miniCountry && !miniCountry.dataset.bound) {
            if (isSelect(miniCountry)) {
                miniCountry.addEventListener('change', () => {
                    const value = miniCountry.value || '';
                    this.companionshipFilters.country = value;
                    this.companionshipFilters.region = '';
                    this.companionshipFilters.city = '';
                    if (hasTopLocationFilters) {
                        this.populateCompanionshipCountries();
                        this.populateCompanionshipRegions(value);
                        this.populateCompanionshipCities(value, '');
                    }
                    this.populateCompanionshipMiniRegions(value);
                    this.populateCompanionshipMiniCities(value, '');
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                });
            } else {
                const handler = () => {
                    syncMiniLocation();
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                };
                miniCountry.addEventListener('input', handler);
                miniCountry.addEventListener('change', handler);
                miniCountry.addEventListener('blur', handler);
            }
            miniCountry.dataset.bound = '1';
        }

        if (miniRegion && !miniRegion.dataset.bound) {
            if (isSelect(miniRegion)) {
                miniRegion.addEventListener('change', () => {
                    const value = miniRegion.value || '';
                    this.companionshipFilters.region = value;
                    this.companionshipFilters.city = '';
                    if (hasTopLocationFilters) {
                        this.populateCompanionshipRegions(this.companionshipFilters.country);
                        this.populateCompanionshipCities(this.companionshipFilters.country, value);
                    }
                    this.populateCompanionshipMiniCities(this.companionshipFilters.country, value);
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                });
            } else {
                const handler = () => {
                    syncMiniLocation();
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                };
                miniRegion.addEventListener('input', handler);
                miniRegion.addEventListener('change', handler);
                miniRegion.addEventListener('blur', handler);
            }
            miniRegion.dataset.bound = '1';
        }

        if (miniCity && !miniCity.dataset.bound) {
            if (isSelect(miniCity)) {
                miniCity.addEventListener('change', () => {
                    this.companionshipFilters.city = miniCity.value || '';
                    if (hasTopLocationFilters) {
                        this.populateCompanionshipCities(this.companionshipFilters.country, this.companionshipFilters.region);
                    }
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                });
            } else {
                const handler = () => {
                    syncMiniLocation();
                    this.resetCompanionshipPagination();
                    this.applyCompanionshipFilters();
                };
                miniCity.addEventListener('input', handler);
                miniCity.addEventListener('change', handler);
                miniCity.addEventListener('blur', handler);
            }
            miniCity.dataset.bound = '1';
        }

        this.syncCompanionshipMiniLocationFromFilters();

        if (photoSlots && !photoSlots.dataset.bound) {
            renderPhotoSlots();
            photoSlots.dataset.bound = '1';
        }
    }

	    openCompanionshipPostModal({ pushState = true, mode } = {}) {
	        const modal = document.getElementById('companionship-post-modal');
	        if (!modal) return;
	        const nextMode = mode ?? this.companionshipPostMode ?? 'companionship';
	        this.companionshipPostMode = nextMode;
	        const titleEl = document.getElementById('companionship-post-title');
	        if (titleEl) {
	            titleEl.textContent = nextMode === 'dating_featured'
	                ? 'Create a featured dating profile'
	                : 'Post a companionship profile';
	        }
	        const restoreBtn = document.getElementById('companionship-post-restore');
	        if (restoreBtn) restoreBtn.classList.add('hidden');
	        const modalContent = modal.querySelector('.modal-content');
	        if (modalContent) modalContent.classList.remove('is-maximized');
        const maximizeBtn = document.getElementById('companionship-post-maximize');
        if (maximizeBtn) maximizeBtn.setAttribute('aria-pressed', 'false');

        // Prefill location from current filters (bottom location selectors).
        const country = this.companionshipFilters?.country || '';
        const region = this.companionshipFilters?.region || '';
        const city = this.companionshipFilters?.city || '';
        const category = this.companionshipFilters?.category || '';

        const formCountry = document.getElementById('companionship-country-input');
        const formRegion = document.getElementById('companionship-region-input');
        const formCity = document.getElementById('companionship-city-input');
        const formCategory = document.getElementById('companionship-ad-category');

        if (formCountry) {
            this.populateCompanionshipFormCountries();
            formCountry.value = country;
            this.populateCompanionshipFormRegions(country);
        }
        if (formRegion) {
            formRegion.value = region;
            this.populateCompanionshipFormCities(country, region);
        }
        if (formCity) {
            formCity.value = city;
        }
	        if (formCategory && category) {
	            formCategory.value = category;
	        }

	        modal.classList.remove('hidden');
	        this.renderCompanionshipPostLivePreview();

	        if (!this.isApplyingUiState && pushState) {
	            this.updateBrowserUiState({ kind: 'modal', id: 'companionship-post-modal' }, { replace: false });
	        }
	    }

	    renderCompanionshipPostLivePreview() {
	        const modal = document.getElementById('companionship-post-modal');
	        const preview = document.getElementById('companionship-post-preview');
	        if (!modal || !preview || modal.classList.contains('hidden')) return;

	        const mode = this.companionshipPostMode || 'companionship';
	        const alias = (document.getElementById('companionship-alias')?.value || '').trim();
	        const ageRaw = (document.getElementById('companionship-age')?.value || '').trim();
	        const age = ageRaw ? parseInt(ageRaw, 10) : NaN;
	        const category = (document.getElementById('companionship-ad-category')?.value || '').trim();
	        const country = (document.getElementById('companionship-country-input')?.value || '').trim();
	        const region = (document.getElementById('companionship-region-input')?.value || '').trim();
	        const city = (document.getElementById('companionship-city-input')?.value || '').trim();
	        const tagline = (document.getElementById('companionship-tagline')?.value || '').trim();
	        const description = (document.getElementById('companionship-description')?.value || '').trim();
	        const storyText = (document.getElementById('companionship-story-text')?.value || '').trim();

	        const photos = Array.isArray(this.companionshipPostImages) && this.companionshipPostImages.length
	            ? this.companionshipPostImages.map((it) => it?.url).filter(Boolean)
	            : [];
	        const primaryPhoto = photos[0] || 'https://via.placeholder.com/120x120/ebeef5/111827?text=Profile';
	        const hasVideo = Boolean(this.companionshipPostStoryPreviewUrl);

	        const categoryLabelMap = {
	            men: 'Men',
	            women: 'Women',
	            massage: 'Massage',
	            gigs_jobs: 'Gigs & Jobs'
	        };
	        const categoryLabel = categoryLabelMap[category] || (category ? category : '');
	        const location = [city, region, country].filter(Boolean).join(', ');

	        const safeName = this.escapeHtml(alias || (mode === 'dating_featured' ? 'Featured profile' : 'Your profile'));
	        const safeAge = Number.isFinite(age) ? age : '';

	        if (mode === 'dating_featured') {
	            const cardCity = city || (country ? country : '');
	            const title = `${safeName}${safeAge ? `, ${safeAge}` : ''}${cardCity ? ` 路 ${this.escapeHtml(cardCity)}` : ''}`;
	            const line = this.escapeHtml(`Spotlight${categoryLabel ? ` 路 ${categoryLabel}` : ''}`);
	            const sub = this.escapeHtml(tagline || storyText || description || 'Boosted profile you can browse');
	            const trackImgs = (photos.length ? photos : [primaryPhoto]).map((src) => (
	                `<img src="${this.escapeHtml(String(src))}" alt="${safeName} profile photo" loading="lazy">`
	            )).join('');
	            preview.innerHTML = `
	                <article class="featured-ad-card preview-card" role="presentation" aria-label="Live preview">
	                    <div class="featured-ad-tag tag-premium">Spotlight</div>
	                    <div class="image-carousel">
	                        <div class="carousel-track" aria-label="Preview photos">
	                            ${trackImgs}
	                        </div>
	                    </div>
	                    <div class="featured-ad-body">
	                        <h4>${title}</h4>
	                        <p>${line}</p>
	                        <span>${sub}</span>
	                    </div>
	                </article>
	            `;
	            return;
	        }

	        const safety = '18+ | No escorting, sexual services, or paid arrangements';
	        const locationLine = this.escapeHtml(tagline || safety);
	        const statusBits = [
	            `<span class="companionship-status-label">Online now</span>`,
	            `<span class="companionship-posted-time">Just now</span>`,
	            location ? `<span class="companionship-location-text">${this.escapeHtml(location)}</span>` : '',
	            categoryLabel ? `<span class="companionship-distance-text">${this.escapeHtml(categoryLabel)}</span>` : ''
	        ].filter(Boolean).join(' 路 ');
	        preview.innerHTML = `
	            <div class="dating-feed-card companionship-feed-card preview-card${hasVideo ? ' has-video' : ''}" role="presentation" aria-label="Live preview">
	                <img class="dating-feed-avatar" src="${this.escapeHtml(primaryPhoto)}" alt="${safeName}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/120x120/ebeef5/111827?text=Profile'">
	                <div class="dating-feed-meta">
	                    <div class="dating-feed-name">${safeName}${safeAge ? `, ${safeAge}` : ''}</div>
	                    <div class="dating-feed-location">${locationLine}</div>
	                    <div class="dating-feed-status online">${statusBits}</div>
	                </div>
	                <span class="dating-feed-action">Preview</span>
	            </div>
	        `;
	    }

    closeCompanionshipPostModal(showRestore = false) {
        if (!showRestore && !this.isApplyingUiState) {
            const state = window.history.state;
            if (state?.ui?.kind === 'modal' && state?.ui?.id === 'companionship-post-modal') {
                window.history.back();
                return;
            }
        }
        const modal = document.getElementById('companionship-post-modal');
        if (!modal) return;
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) modalContent.classList.remove('is-maximized');
        const maximizeBtn = document.getElementById('companionship-post-maximize');
        if (maximizeBtn) maximizeBtn.setAttribute('aria-pressed', 'false');
        const restoreBtn = document.getElementById('companionship-post-restore');
        if (restoreBtn) restoreBtn.classList.toggle('hidden', !showRestore);
        modal.classList.add('hidden');

        // Clean up any preview URL only when actually closing (not minimizing).
        if (!showRestore) {
            const list = Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [];
            list.forEach((it) => {
                if (it?.url) {
                    try { URL.revokeObjectURL(it.url); } catch {}
                }
            });
            this.companionshipPostImages = [];
            const photoInput = document.getElementById('companionship-images-file');
            if (photoInput) photoInput.value = '';
            const photoSlots = document.getElementById('companionship-photo-slots');
            if (photoSlots) photoSlots.innerHTML = '';
            if (this.companionshipPostStoryPreviewUrl) {
                try { URL.revokeObjectURL(this.companionshipPostStoryPreviewUrl); } catch {}
                this.companionshipPostStoryPreviewUrl = '';
            }
            const storyPreview = document.getElementById('companionship-story-preview');
            if (storyPreview) {
                try { storyPreview.pause(); } catch {}
                storyPreview.classList.add('hidden');
                storyPreview.removeAttribute('src');
                storyPreview.load();
            }
            const storyStatus = document.getElementById('companionship-story-status');
            if (storyStatus) {
                storyStatus.textContent = '';
                storyStatus.classList.remove('error');
            }
        }
    }

    syncCompanionshipMiniLocationFromFilters() {
        const c = this.companionshipFilters.country || '';
        const r = this.companionshipFilters.region || '';
        const city = this.companionshipFilters.city || '';
        this.populateCompanionshipMiniCountries();
        this.populateCompanionshipMiniRegions(c);
        this.populateCompanionshipMiniCities(c, r);
        const miniCountry = document.getElementById('companionship-mini-country');
        const miniRegion = document.getElementById('companionship-mini-region');
        const miniCity = document.getElementById('companionship-mini-city');
        if (miniCountry) miniCountry.value = c;
        if (miniRegion) miniRegion.value = r;
        if (miniCity) miniCity.value = city;
    }

    updateCompanionshipCategoryCards(activeKey = '') {
        document.querySelectorAll('.companionship-category-card').forEach((card) => {
            const key = card.dataset.category || '';
            card.classList.toggle('active', Boolean(activeKey) && key === activeKey);
        });
    }

	    matchesCompanionshipCategory(profile, categoryKey) {
	        const key = String(categoryKey || '').toLowerCase();
	        if (!key) return true;
	        const intent = String(profile?.intentCategory || '').toLowerCase();
	        const service = String(profile?.serviceCategory || '').toLowerCase();
	        const gender = String(profile?.gender || '').toLowerCase();
	        const text = [profile?.tagline, profile?.description, profile?.seeking].filter(Boolean).join(' ').toLowerCase();

	        if (key === 'men') return gender === 'man' || gender === 'male' || intent === 'men' || text.includes(' man ');
	        if (key === 'women') return gender === 'woman' || gender === 'female' || intent === 'women' || text.includes(' woman ');
	        if (key === 'massage') return service === 'massage' || intent === 'massage' || text.includes('massage');
	        if (key === 'gigs_jobs') return service === 'gigs_jobs' || service === 'gigs&jobs' || service === 'gigs' || service === 'jobs' || intent === 'gigs_jobs'
	            || text.includes('gig') || text.includes('job') || text.includes('hire') || text.includes('assistant') || text.includes('errand');

	        if (key === 'friends') return intent === 'friends' || text.includes('friend') || text.includes('platonic') || text.includes('buddy');
	        if (key === 'dates') return intent === 'dates' || text.includes('date') || text.includes('dinner') || text.includes('coffee') || text.includes('brunch');
	        if (key === 'events') return intent === 'events' || text.includes('event') || text.includes('concert') || text.includes('show') || text.includes('museum') || text.includes('gallery');
	        if (key === 'wellness') return intent === 'wellness' || service === 'massage' || service === 'wellness'
	            || text.includes('wellness') || text.includes('massage') || text.includes('spa') || text.includes('stretch') || text.includes('fitness');
	        if (key === 'help') return intent === 'help' || service === 'gigs_jobs' || service === 'gigs&jobs' || service === 'gigs' || service === 'jobs'
	            || text.includes('gig') || text.includes('job') || text.includes('hire') || text.includes('assistant') || text.includes('errand') || text.includes('help');
	        return true;
	    }

    matchesCompanionshipQuery(profile, query) {
        const q = String(query || '').trim().toLowerCase();
        if (!q) return true;
        const haystack = [
            profile?.alias,
            profile?.tagline,
            profile?.description,
            profile?.seeking,
            profile?.city,
            profile?.region,
            profile?.country,
            profile?.serviceCategory
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(q);
    }

    populateCompanionshipCountries() {
        const select = document.getElementById('companionship-country');
        if (!select) return;
        const active = this.companionshipFilters.country || '';
        this.populateCountrySelect(select, { placeholder: 'Country', active });
    }

    populateCompanionshipRegions(country) {
        const select = document.getElementById('companionship-region');
        if (!select) return;
        const active = this.companionshipFilters.region || '';
        this.populateStateSelect(select, country, { placeholder: 'Province/State', active });
    }

    populateCompanionshipCities(country, region) {
        const select = document.getElementById('companionship-city');
        if (!select) return;
        const active = this.companionshipFilters.city || '';
        this.populateCitySelect(select, country, region, { placeholder: 'City', active });
    }

    populateCompanionshipMiniCountries() {
        const select = document.getElementById('companionship-mini-country');
        if (!select) return;
        const active = this.companionshipFilters.country || '';
        this.populateCountrySelect(select, { placeholder: 'Country', active });
    }

    populateCompanionshipMiniRegions(country) {
        const select = document.getElementById('companionship-mini-region');
        if (!select) return;
        const active = this.companionshipFilters.region || '';
        this.populateStateSelect(select, country, { placeholder: 'Province/State', active });
    }

    populateCompanionshipMiniCities(country, region) {
        const select = document.getElementById('companionship-mini-city');
        if (!select) return;
        const active = this.companionshipFilters.city || '';
        this.populateCitySelect(select, country, region, { placeholder: 'City', active });
    }

    populateCompanionshipFormCountries() {
        const select = document.getElementById('companionship-country-input');
        if (!select) return;
        this.populateCountrySelect(select, { placeholder: 'Country' });
    }

    populateCompanionshipFormRegions(country) {
        const select = document.getElementById('companionship-region-input');
        if (!select) return;
        this.populateStateSelect(select, country, { placeholder: 'Province/State' });
    }

    populateCompanionshipFormCities(country, region) {
        const select = document.getElementById('companionship-city-input');
        if (!select) return;
        this.populateCitySelect(select, country, region, { placeholder: 'City' });
    }

    // Dating location feed helpers
    setupDatingLocationFeed() {
        const countrySel = document.getElementById('dating-feed-country');
        const regionSel = document.getElementById('dating-feed-region');
        const citySel = document.getElementById('dating-feed-city');
        const statusSel = document.getElementById('dating-feed-status');
        if (!countrySel || !regionSel || !citySel || !statusSel) return;

        const isSelect = (el) => el && el.tagName === 'SELECT';
        const syncFromInputs = () => {
            this.datingLocationFeedFilters.country = (countrySel.value || '').trim();
            this.datingLocationFeedFilters.region = (regionSel.value || '').trim();
            this.datingLocationFeedFilters.city = (citySel.value || '').trim();
            this.datingLocationFeedFilters.status = statusSel.value || 'all';
        };

        if (isSelect(countrySel) && isSelect(regionSel) && isSelect(citySel)) {
            this.populateDatingFeedCountries();
            this.populateDatingFeedRegions('');
            this.populateDatingFeedCities('', '');

            if (!countrySel.dataset.bound) {
                countrySel.addEventListener('change', (e) => {
                    this.datingLocationFeedFilters.country = e.target.value;
                    this.datingLocationFeedFilters.region = '';
                    this.datingLocationFeedFilters.city = '';
                    this.populateDatingFeedRegions(e.target.value);
                    this.populateDatingFeedCities(e.target.value, '');
                    this.applyDatingLocationFeed();
                });
                countrySel.dataset.bound = '1';
            }
            if (!regionSel.dataset.bound) {
                regionSel.addEventListener('change', (e) => {
                    this.datingLocationFeedFilters.region = e.target.value;
                    this.datingLocationFeedFilters.city = '';
                    this.populateDatingFeedCities(this.datingLocationFeedFilters.country, e.target.value);
                    this.applyDatingLocationFeed();
                });
                regionSel.dataset.bound = '1';
            }
            if (!citySel.dataset.bound) {
                citySel.addEventListener('change', (e) => {
                    this.datingLocationFeedFilters.city = e.target.value;
                    this.applyDatingLocationFeed();
                });
                citySel.dataset.bound = '1';
            }
        } else {
            const bindText = (el) => {
                if (!el || el.dataset.bound) return;
                const handler = () => {
                    syncFromInputs();
                    this.applyDatingLocationFeed();
                };
                el.addEventListener('input', handler);
                el.addEventListener('change', handler);
                el.addEventListener('blur', handler);
                el.dataset.bound = '1';
            };

            bindText(countrySel);
            bindText(regionSel);
            bindText(citySel);
        }

        if (!statusSel.dataset.bound) {
            statusSel.addEventListener('change', () => {
                syncFromInputs();
                this.applyDatingLocationFeed();
            });
            statusSel.dataset.bound = '1';
        }

        syncFromInputs();
        this.applyDatingLocationFeed();
    }

    getDatingLocationOptions() {
        const countries = new Set();
        const regionsByCountry = {};
        const citiesByRegion = {};
        (this.users || []).forEach((u) => {
            const c = u.location?.country;
            const r = u.location?.region;
            const city = u.location?.city;
            if (c) countries.add(c);
            if (c && r) {
                if (!regionsByCountry[c]) regionsByCountry[c] = new Set();
                regionsByCountry[c].add(r);
            }
            if (c && r && city) {
                const key = `${c}|${r}`;
                if (!citiesByRegion[key]) citiesByRegion[key] = new Set();
                citiesByRegion[key].add(city);
            }
        });
        return { countries, regionsByCountry, citiesByRegion };
    }

    populateDatingFeedCountries() {
        const select = document.getElementById('dating-feed-country');
        if (!select) return;
        const active = this.datingLocationFeedFilters.country || '';
        this.populateCountrySelect(select, { placeholder: 'All countries', active });
    }

    populateDatingFeedRegions(country) {
        const select = document.getElementById('dating-feed-region');
        if (!select) return;
        const active = this.datingLocationFeedFilters.region || '';
        this.populateStateSelect(select, country, { placeholder: 'All states', active });
    }

    populateDatingFeedCities(country, region) {
        const select = document.getElementById('dating-feed-city');
        if (!select) return;
        const active = this.datingLocationFeedFilters.city || '';
        this.populateCitySelect(select, country, region, { placeholder: 'All cities', active });
    }

    applyDatingLocationFeed() {
        const list = this.users || [];
        const { country, region, city, status } = this.datingLocationFeedFilters;
        const cNeedle = this.normalizeLocationText(country);
        const rNeedle = this.normalizeLocationText(region);
        const cityNeedle = this.normalizeLocationText(city);
        const postedFilter = document.getElementById('dating-posted')?.value || 'all';
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        const monthAgo = new Date(today);
        monthAgo.setMonth(today.getMonth() - 1);
        const filtered = list.filter((u) => {
            if (cNeedle && !this.normalizeLocationText(u.location?.country).includes(cNeedle)) return false;
            if (rNeedle && !this.normalizeLocationText(u.location?.region).includes(rNeedle)) return false;
            if (cityNeedle && !this.normalizeLocationText(u.location?.city).includes(cityNeedle)) return false;
            if (status === 'online' && !u.online) return false;
            if (status === 'offline' && u.online) return false;
            if (postedFilter && postedFilter !== 'all') {
                const activityDate = this.getUserActivityDate(u);
                if (!activityDate) return false;
                if (postedFilter === 'today' && activityDate < today) return false;
                if (postedFilter === 'week' && activityDate < weekAgo) return false;
                if (postedFilter === 'month' && activityDate < monthAgo) return false;
            }
            return true;
        });
        this.renderDatingLocationFeed(filtered);
    }

    renderDatingLocationFeed(list) {
        const container = document.getElementById('dating-location-feed');
        if (!container) return;
        const safeList = Array.isArray(list) ? list : [];
        const dateEl = document.getElementById('dating-feed-date');
        const countEl = document.getElementById('dating-feed-count');
        const formatActivityHeader = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
            const label = this.formatCompanionshipFeedHeaderDate(date);
            if (label === 'Today' || label === 'Yesterday') return label;
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        };
        const latest = safeList.reduce((acc, u) => {
            const activityDate = this.getUserActivityDate(u);
            if (!(activityDate instanceof Date) || Number.isNaN(activityDate.getTime())) return acc;
            if (!acc || activityDate > acc) return activityDate;
            return acc;
        }, null);
        const headerWrap = container.parentElement?.querySelector('.dating-feed-header');
        const headerLabel = latest ? formatActivityHeader(latest) : '';
        if (dateEl) dateEl.textContent = headerLabel;
        if (headerWrap) headerWrap.classList.toggle('hidden', !headerLabel);
        if (countEl) {
            const count = safeList.length;
            countEl.textContent = `${count} ${count === 1 ? 'profile' : 'profiles'}`;
        }
        if (!safeList.length) {
            container.innerHTML = `
                <div class="dating-feed-empty">
                    <p style="margin:0;color:#6b7280;">No profiles match this location.</p>
                </div>`;
            return;
        }
        const toDayKey = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'unknown';
            return date.toISOString().slice(0, 10);
        };
        const grouped = safeList.reduce((acc, u) => {
            const activityDate = this.getUserActivityDate(u);
            const key = toDayKey(activityDate);
            if (!acc[key]) acc[key] = [];
            acc[key].push({ user: u, activityDate });
            return acc;
        }, {});
        const groupKeys = Object.keys(grouped).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
        });
        const groupLabel = (key) => {
            if (!key || key === 'unknown') return '';
            return formatActivityHeader(new Date(`${key}T00:00:00`));
        };

        container.innerHTML = groupKeys.map((key) => {
            const items = grouped[key] || [];
            const label = groupLabel(key);
            const cards = items.map(({ user: u }) => {
            const loc = [u.location?.city, u.location?.region, u.location?.country].filter(Boolean).join(', ');
            const status = u.online ? 'online' : 'offline';
            const photo = u.photo || 'https://via.placeholder.com/120x120/ebeef5/111827?text=Profile';
            const hasVideo = Boolean(u.profileVideo);
            const scheduleMatch = this.getScheduleMatchForUser(u);
            const scheduleBadge = scheduleMatch ? this.getScheduleBadgeLabel(scheduleMatch) : '';
            return `
                <div class="dating-feed-card${hasVideo ? ' has-video' : ''}" data-id="${u.id}">
                    <img src="${photo}" alt="${u.name}" class="dating-feed-avatar" loading="lazy">
                    <div class="dating-feed-meta">
                        <span class="dating-feed-name">${u.name}, ${u.age}</span>
                        ${scheduleBadge ? `<span class="dating-feed-badge">${this.escapeHtml(scheduleBadge)}</span>` : ''}
                        <span class="dating-feed-location">${loc || 'Location unavailable'}</span>
                    </div>
                    <div>
                            <span class="dating-feed-status ${status}">${u.online ? 'Online' : 'Offline'}</span>
                            <span class="dating-feed-action">View</span>
                        </div>
                    </div>`;
            }).join('');
            const countLabel = `${items.length} ${items.length === 1 ? 'profile' : 'profiles'}`;
            const header = label
                ? `
                    <div class="dating-feed-day">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${countLabel}</span>
                    </div>
                `
                : '';
            return `
                <div class="dating-feed-group">
                    ${header}
                    <div class="dating-feed-day-list">
                        ${cards}
                    </div>
                </div>
            `;
        }).join('');

        container.querySelectorAll('.dating-feed-card').forEach(card => {
            if (card.dataset.bound) return;
            card.addEventListener('click', () => {
                const id = parseInt(card.dataset.id, 10);
                const user = this.users.find(u => u.id === id);
                if (!user) return;
                const gallery = this.buildUserGallery(user).map(item => item.src);
                this.openProfileModal(user, 0, gallery);
            });
            card.dataset.bound = '1';
        });
    }

    applyCompanionshipFilters() {
        const paneVisible = !document.getElementById('companionship-pane')?.classList?.contains?.('hidden');
        if (this.currentDatingCategory !== 'companionship' && !paneVisible) return;
        const generalFilter = this.currentDatingCategoryFilter || 'all';
        const { country, region, city, nearMe, gender, seeking, category, query, onlineOnly, sort } = this.companionshipFilters;
        const cNeedle = this.normalizeLocationText(country);
        const rNeedle = this.normalizeLocationText(region);
        const cityNeedle = this.normalizeLocationText(city);
	        const nearRadius = this.companionshipNearMeRadius;
	        const userCoords = this.userLocation || null;
	        const nearBtn = document.getElementById('companionship-near-me');
	        if (nearBtn) nearBtn.classList.toggle('active', Boolean(nearMe));

	        const canUseNearby = Boolean(userCoords && userCoords.lat && userCoords.lng);
	        if (!canUseNearby && (nearMe || generalFilter === 'nearby')) {
	            if (!this.didWarnCompanionshipNearby) {
	                this.didWarnCompanionshipNearby = true;
	                this.showNotification('Turn on location to use Nearby. Showing all profiles.');
	            }
	            if (this.companionshipFilters.nearMe) {
	                this.companionshipFilters.nearMe = false;
	                if (nearBtn) nearBtn.classList.remove('active');
	            }
	            if (this.currentDatingCategoryFilter === 'nearby') {
	                this.currentDatingCategoryFilter = 'all';
	                this.updateDatingCategoryFilterButtons('all');
	            }
	        }

	        this.syncCompanionshipMiniLocationFromFilters();

	        const profiles = (this.companionshipProfiles || []).map((p) => {
	            const coords = this.getCompanionshipCoords(p);
	            let distance;
	            if (canUseNearby && coords?.lat && coords?.lng) {
	                distance = this.calculateDistance(userCoords.lat, userCoords.lng, coords.lat, coords.lng);
	            }
	            return { ...p, distance };
	        });

	        const filtered = profiles.filter((p) => {
            if (cNeedle && !this.normalizeLocationText(p.country).includes(cNeedle)) return false;
            if (rNeedle && !this.normalizeLocationText(p.region).includes(rNeedle)) return false;
            if (cityNeedle && !this.normalizeLocationText(p.city).includes(cityNeedle)) return false;
            if (gender && (p.gender || '').toLowerCase() !== gender.toLowerCase()) return false;
            if (seeking && (p.seeking || '').toLowerCase() !== seeking.toLowerCase()) return false;
            if (category && !this.matchesCompanionshipCategory(p, category)) return false;
            if (query && !this.matchesCompanionshipQuery(p, query)) return false;
            if (onlineOnly && !p.online) return false;
            if (generalFilter === 'online' && !p.online) return false;
            if (generalFilter === 'premium' && !p.premium) return false;
	            const withinNearby = typeof p.distance === 'number' && p.distance <= nearRadius;
	            const enforceNearby = canUseNearby && (this.companionshipFilters.nearMe || this.currentDatingCategoryFilter === 'nearby');
	            if (enforceNearby && !withinNearby) return false;
	            return true;
	        });

        const getPostedTime = (p) => (p?.postedAt instanceof Date ? p.postedAt.getTime() : 0);
        const sortKey = String(sort || 'smart').toLowerCase();
	        filtered.sort((a, b) => {
            if (sortKey === 'newest') return getPostedTime(b) - getPostedTime(a);
            if (sortKey === 'distance') {
                const ad = (typeof a.distance === 'number') ? a.distance : Number.POSITIVE_INFINITY;
                const bd = (typeof b.distance === 'number') ? b.distance : Number.POSITIVE_INFINITY;
                if (ad !== bd) return ad - bd;
                return getPostedTime(b) - getPostedTime(a);
            }
            if (sortKey === 'premium') {
                if (a.premium !== b.premium) return a.premium ? -1 : 1;
                return getPostedTime(b) - getPostedTime(a);
            }
            // smart
            if (a.online !== b.online) return a.online ? -1 : 1;
            if (a.premium !== b.premium) return a.premium ? -1 : 1;
            const ad = (typeof a.distance === 'number') ? a.distance : Number.POSITIVE_INFINITY;
            const bd = (typeof b.distance === 'number') ? b.distance : Number.POSITIVE_INFINITY;
            if (ad !== bd) return ad - bd;
	            return getPostedTime(b) - getPostedTime(a);
	        });

	        const pageSize = Math.max(1, parseInt(this.companionshipFeedPageSize, 10) || 8);
	        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
	        const currentPage = Math.min(Math.max(1, parseInt(this.companionshipFeedPage, 10) || 1), totalPages);
	        this.companionshipFeedPage = currentPage;
        const startIdx = (currentPage - 1) * pageSize;
        const pageItems = filtered.slice(startIdx, startIdx + pageSize);

        this.renderCompanionshipFeed(pageItems);
	        this.renderCompanionshipPagination(totalPages, filtered.length);
	    }

	    renderCompanionshipPagination(totalPages, totalCount = 0) {
	        const bar = document.getElementById('companionship-pagination');
	        if (!bar) return;
        const page = this.companionshipFeedPage || 1;
        const pages = totalPages || 1;
        if (pages <= 1) {
            bar.innerHTML = '';
            return;
        }
        const btn = (p, label, disabled = false, active = false) =>
            `<button class="page-btn${active ? ' active' : ''}" type="button" data-comp-page="${p}" ${disabled ? 'disabled' : ''} aria-label="Page ${label}">${label}</button>`;
        const parts = [];
        parts.push(btn(page - 1, 'Prev', page <= 1));
        const start = Math.max(1, page - 2);
        const end = Math.min(pages, page + 2);
        if (start > 1) parts.push(btn(1, '1'));
        if (start > 2) parts.push(`<span class="page-ellipsis"></span>`);
        for (let p = start; p <= end; p++) parts.push(btn(p, String(p), false, p === page));
        if (end < pages - 1) parts.push(`<span class="page-ellipsis"></span>`);
        if (end < pages) parts.push(btn(pages, String(pages)));
        parts.push(btn(page + 1, 'Next', page >= pages));
        bar.innerHTML = parts.join('');

        if (bar.dataset.bound) return;
        bar.addEventListener('click', (e) => {
            const b = e.target.closest('.page-btn');
            if (!b) return;
            const p = parseInt(b.dataset.compPage, 10);
            if (!p || Number.isNaN(p)) return;
            this.companionshipFeedPage = p;
            this.applyCompanionshipFilters();
            document.getElementById('companionship-feed')?.scrollIntoView?.({ block: 'start', behavior: 'smooth' });
        });
        bar.dataset.bound = '1';
    }

    renderCompanionshipFeed(list) {
        const feed = document.getElementById('companionship-feed');
        if (!feed) return;
        const postCtaCard = `
            <div class="dating-feed-card companionship-feed-post-card" role="button" tabindex="0" aria-label="Post your ad">
                <div class="dating-feed-avatar companionship-feed-cta-icon" aria-hidden="true">
                    <i class="fas fa-bullhorn" aria-hidden="true"></i>
                </div>
                <div class="dating-feed-meta">
                    <div class="dating-feed-name">Post your ad</div>
                    <div class="dating-feed-location">Create a companionship listing for your area.</div>
                    <div class="dating-feed-status offline">Fast 路 18+ only 路 Consent-first</div>
                </div>
                <span class="btn-luxe small companionship-feed-post-action">Post</span>
            </div>
        `;
        feed.classList.remove('companionship-feed');
        feed.classList.add('dating-feed');
        if (!list.length) {
            feed.innerHTML = `
                <div class="companionship-empty">
                    <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                    <div>
                        <h4>No profiles for this area yet</h4>
                        <p>Change the location or post the first companionship listing.</p>
                    </div>
                </div>
                ${postCtaCard}`;
            feed.querySelectorAll('.companionship-feed-post-card').forEach((card) => {
                if (card.dataset.bound) return;
                const open = () => this.openCompanionshipPostModal();
                card.addEventListener('click', open);
                card.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter' && e.key !== ' ') return;
                    e.preventDefault();
                    open();
                });
                card.dataset.bound = '1';
            });
            return;
        }

        const toDayKey = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'Unknown';
            return date.toISOString().slice(0, 10);
        };
        const grouped = list.reduce((acc, p) => {
            const postedAt = p.postedAt instanceof Date ? p.postedAt : new Date();
            const key = toDayKey(postedAt);
            if (!acc[key]) acc[key] = [];
            acc[key].push(p);
            return acc;
        }, {});

        const groupKeys = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
        const groupLabel = (key) => {
            if (!key || key === 'Unknown') return 'Unknown';
            return this.formatCompanionshipFeedHeaderDate(new Date(`${key}T00:00:00`));
        };

        feed.innerHTML = groupKeys.map(key => {
            const items = grouped[key] || [];
            const label = groupLabel(key);
                const cards = items.map((p) => {
	                    const location = [p.city, p.region, p.country].filter(Boolean).join(', ');
	                    const distance = typeof p.distance === 'number' ? `${p.distance}km away` : '';
	                    const status = p.online ? 'Online now' : (p.lastActive || 'Recently active');
                    const tagline = p.tagline || p.seeking || '';
                    const safety = '18+ | No escorting, sexual services, or paid arrangements';
                    const postedAt = p.postedAt instanceof Date ? p.postedAt : new Date();
                    const postedLabel = this.formatRelativeTime(postedAt);
                    const hasVideo = Boolean(p.video);
	                    const primaryStatus = p.online ? 'Online now' : this.escapeHtml(status);
	                    return `
	                    <div class="dating-feed-card companionship-feed-card${hasVideo ? ' has-video' : ''}" data-id="${p.id}" data-distance="${typeof p.distance === 'number' ? p.distance : ''}" role="button" tabindex="0" aria-label="Open ${this.escapeHtml(p.alias)} profile">
	                        <img class="dating-feed-avatar" src="${p.photo}" alt="${this.escapeHtml(p.alias)}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/120x120/ebeef5/111827?text=Profile'">
	                        <div class="dating-feed-meta">
	                            <div class="dating-feed-name">${this.escapeHtml(p.alias)}, ${p.age}${p.premium ? ' 路 Premium' : ''}</div>
	                            <div class="dating-feed-location">${this.escapeHtml(tagline || safety)}</div>
	                            <div class="dating-feed-status ${p.online ? 'online' : 'offline'}"><span class="companionship-status-label">${primaryStatus}</span> 路 <span class="companionship-posted-time" data-ts="${postedAt.getTime()}">${postedLabel}</span>${location ? ` 路 <span class="companionship-location-text">${this.escapeHtml(location)}</span>` : ''}${distance ? ` 路 <span class="companionship-distance-text">${this.escapeHtml(distance)}</span>` : ''}</div>
	                        </div>
	                        <span class="dating-feed-action">View</span>
	                    </div>
	                `;
                }).join('');

            return `
                <div class="vehicles-feed-group">
                    <div class="vehicles-feed-header">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${items.length} profiles</span>
                    </div>
                    <div class="companionship-feed-list">
                        ${cards}
                    </div>
                </div>
            `;
        }).join('') + postCtaCard;

        feed.querySelectorAll('.companionship-feed-card').forEach(card => {
            if (card.dataset.bound) return;
            const open = () => {
                const id = card.dataset.id;
                const profile = (this.companionshipProfiles || []).find(p => p.id === id);
                if (!profile) return;
                const dist = parseFloat(card.dataset.distance);
                if (Number.isFinite(dist)) profile.distance = dist;
                this.openCompanionshipProfileMarketplaceModal(profile.id);
            };
            card.addEventListener('click', (e) => {
                const id = card.dataset.id;
                const profile = (this.companionshipProfiles || []).find(p => p.id === id);
                if (!profile) return;
                const dist = parseFloat(card.dataset.distance);
                if (Number.isFinite(dist)) profile.distance = dist;

                const clickedAvatar = Boolean(e.target?.closest?.('.dating-feed-avatar'));
                if (clickedAvatar && profile.video) {
                    this.openCompanionshipStoryById(profile.id);
                    return;
                }

                open();
            });
            card.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                e.preventDefault();
                open();
            });
            card.dataset.bound = '1';
        });

        feed.querySelectorAll('.companionship-feed-post-card').forEach((card) => {
            if (card.dataset.bound) return;
            const open = () => this.openCompanionshipPostModal();
            card.addEventListener('click', open);
            card.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                e.preventDefault();
                open();
            });
            card.dataset.bound = '1';
        });

        this.startCompanionshipTimeTicker();
    }

    openCompanionshipStoryById(id) {
        const key = String(id ?? '');
        const list = Array.isArray(this.companionshipStoryItems) && this.companionshipStoryItems.length
            ? this.companionshipStoryItems
            : (this.companionshipProfiles || []).filter((p) => p && p.video);
        if (!list.length) return;
        const startIndex = Math.max(0, list.findIndex((p) => String(p.id) === key));
        const items = list.map((p) => ({
            id: String(p.id ?? ''),
            name: String(p.alias || p.name || 'Profile'),
            sub: [p.city, p.country].filter(Boolean).join(', '),
            avatar: String(p.photo || ''),
            video: String(p.video || ''),
            caption: String(p.storyText || p.storyCaption || p.caption || p.tagline || '')
        })).filter((it) => it.video);
        this.openStoryOverlay(items, startIndex);
    }

    openStoryOverlay(items, startIndex = 0, { pushState = true } = {}) {
        const overlay = document.getElementById('story-overlay');
        const video = document.getElementById('story-video');
        const captionEl = document.getElementById('story-caption');
        if (!overlay || !video) return;

        const list = Array.isArray(items) ? items.filter((it) => it && it.video) : [];
        if (!list.length) return;

        this.storyItems = list;
        this.storyIndex = Math.min(Math.max(0, startIndex), list.length - 1);

        if (!this.isApplyingUiState) {
            const state = window.history.state;
            if (pushState && overlay.classList.contains('hidden')) {
                this.updateBrowserUiState({ kind: 'story', items: list, index: this.storyIndex }, { replace: false });
            } else if (state?.ui?.kind === 'story') {
                // Keep current history entry in sync with story progress.
                this.updateBrowserUiState({ kind: 'story', items: list, index: this.storyIndex }, { replace: true });
            }
        }

        const ensureBound = () => {
            if (overlay.dataset.bound) return;

            const onOverlayClick = (e) => {
                if (e.target === overlay) {
                    this.closeStoryOverlay();
                    return;
                }

                const rect = video.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const ratio = rect.width ? x / rect.width : 0.5;
                if (ratio < 0.33) this.stepStory(-1);
                else this.stepStory(1);
            };

            const onKey = (e) => {
                if (overlay.classList.contains('hidden')) return;
                if (e.key === 'Escape') this.closeStoryOverlay();
                if (e.key === 'ArrowLeft') this.stepStory(-1);
                if (e.key === 'ArrowRight') this.stepStory(1);
            };

            const onHoldStart = () => {
                if (!video.paused) video.pause();
            };
            const onHoldEnd = () => {
                if (overlay.classList.contains('hidden')) return;
                if (video.paused) video.play().catch(() => {});
            };

            overlay.addEventListener('click', onOverlayClick);
            document.addEventListener('keydown', onKey);
            overlay.addEventListener('mousedown', onHoldStart);
            overlay.addEventListener('mouseup', onHoldEnd);
            overlay.addEventListener('touchstart', onHoldStart, { passive: true });
            overlay.addEventListener('touchend', onHoldEnd);
            overlay.dataset.bound = '1';
        };

        ensureBound();

        const playIndex = () => {
            const item = this.storyItems[this.storyIndex];
            if (!item) return;
            if (captionEl) {
                const text = String(item.caption || '').trim();
                captionEl.textContent = text;
                captionEl.classList.toggle('hidden', !text);
            }
            this.preloadStoryVideo(item.video);
            video.pause();
            video.removeAttribute('src');
            video.removeAttribute('poster');
            video.load();
            video.src = item.video;
            video.currentTime = 0;
            video.muted = true;
            video.playsInline = true;
            video.preload = 'auto';
            if (item.avatar) video.poster = item.avatar;
            video.loop = false;
            video.play().catch(() => {});
        };

        if (!overlay.classList.contains('hidden')) {
            // noop
        } else {
            overlay.classList.remove('hidden');
        }

        playIndex();

        if (!video.dataset.storyBound) {
            video.addEventListener('ended', () => this.stepStory(1));
            video.dataset.storyBound = '1';
        }
    }

    closeStoryOverlay({ useHistory = true } = {}) {
        if (useHistory && !this.isApplyingUiState) {
            const state = window.history.state;
            if (state?.ui?.kind === 'story') {
                window.history.back();
                return;
            }
        }
        const overlay = document.getElementById('story-overlay');
        const video = document.getElementById('story-video');
        const captionEl = document.getElementById('story-caption');
        if (overlay) overlay.classList.add('hidden');
        if (captionEl) {
            captionEl.textContent = '';
            captionEl.classList.add('hidden');
        }
        if (video) {
            try { video.pause(); } catch {}
            video.removeAttribute('src');
            video.removeAttribute('poster');
            video.load();
        }
        this.storyItems = [];
        this.storyIndex = 0;
    }

    preloadStoryVideo(src) {
        const url = String(src || '').trim();
        if (!url) return;
        this.storyPreload = this.storyPreload || new Map();
        if (this.storyPreload.has(url)) return;

        try {
            const v = document.createElement('video');
            v.preload = 'auto';
            v.muted = true;
            v.playsInline = true;
            v.src = url;
            v.load();
            this.storyPreload.set(url, { video: v, ts: Date.now() });
        } catch {
            return;
        }

        const max = 8;
        while (this.storyPreload.size > max) {
            const firstKey = this.storyPreload.keys().next().value;
            const entry = this.storyPreload.get(firstKey);
            this.storyPreload.delete(firstKey);
            try {
                entry?.video?.pause?.();
                entry?.video?.removeAttribute?.('src');
                entry?.video?.load?.();
            } catch {}
        }
    }

    stepStory(delta = 1) {
        const list = Array.isArray(this.storyItems) ? this.storyItems : [];
        if (!list.length) return;
        const nextIndex = this.storyIndex + delta;
        if (nextIndex < 0) {
            this.storyIndex = 0;
        } else if (nextIndex >= list.length) {
            this.closeStoryOverlay();
            return;
        } else {
            this.storyIndex = nextIndex;
        }
        this.openStoryOverlay(list, this.storyIndex, { pushState: false });
    }

    buildCompanionshipUser(profile) {
        const location = {
            city: profile.city,
            country: profile.country,
            distance: typeof profile.distance === 'number' ? profile.distance : undefined
        };
        return {
            name: profile.alias,
            age: profile.age,
            bio: profile.description || profile.tagline,
            interests: [profile.gender, profile.seeking].filter(Boolean),
            location,
            online: profile.online,
            photo: profile.photo,
            photos: profile.photos && profile.photos.length ? profile.photos : [profile.photo],
            matchPreferences: profile.seeking || '',
            postedAt: profile.postedAt instanceof Date ? profile.postedAt : undefined
        };
    }

    startCompanionshipTimeTicker() {
        if (this.companionshipTickerId) return;
        const tick = () => {
            const pane = document.getElementById('companionship-pane');
            if (!pane || pane.classList.contains('hidden')) return;
            document.querySelectorAll('.companionship-posted-time[data-ts]').forEach(el => {
                const ts = parseInt(el.dataset.ts || '', 10);
                if (!Number.isFinite(ts)) return;
                el.textContent = this.formatRelativeTime(new Date(ts));
            });
        };
        tick();
        this.companionshipTickerId = window.setInterval(tick, 60_000);
    }

    stopCompanionshipTimeTicker() {
        if (!this.companionshipTickerId) return;
        window.clearInterval(this.companionshipTickerId);
        this.companionshipTickerId = null;
    }

	    async handleCompanionshipPostSubmit(event) {
	        event.preventDefault();
	        const mode = this.companionshipPostMode || 'companionship';
	        const form = event.target;
	        const alias = form.querySelector('#companionship-alias')?.value?.trim();
	        const age = parseInt(form.querySelector('#companionship-age')?.value || '0', 10);
	        const category = form.querySelector('#companionship-ad-category')?.value || '';
	        const country = form.querySelector('#companionship-country-input')?.value || '';
        const region = form.querySelector('#companionship-region-input')?.value || '';
        const city = form.querySelector('#companionship-city-input')?.value || '';
        const tagline = form.querySelector('#companionship-tagline')?.value?.trim();
        const description = form.querySelector('#companionship-description')?.value?.trim();
        const storyText = form.querySelector('#companionship-story-text')?.value?.trim() || '';
        const videoFile = form.querySelector('#companionship-video-file')?.files?.[0] || null;
        const imageFiles = (Array.isArray(this.companionshipPostImages) && this.companionshipPostImages.length)
            ? this.companionshipPostImages.map((it) => it.file).filter(Boolean)
            : Array.from(form.querySelector('#companionship-images-file')?.files || []);

        if (!alias || !age || age < 18 || !category || !country || !city || !tagline || !description) {
            this.showNotification('Add name, 18+ age, category, location, headline, and description to post.');
            return;
        }

        const isOnline = true;

        const validImages = imageFiles
            .filter((file) => file && file.type && file.type.startsWith('image/'))
            .slice(0, 5);
        if (imageFiles.length > 5) {
            this.showNotification('Only up to 5 photos will be used.');
        }

        let videoUrl = '';
        if (videoFile) {
            if (this.companionshipPostStoryPreviewUrl) {
                videoUrl = this.companionshipPostStoryPreviewUrl;
            } else {
                const result = await this.validateShortVideo(videoFile, 5, 10);
                if (!result.ok) {
                    this.showNotification(result.message || 'Video must be between 5 and 10 seconds.');
                    return;
                }
                videoUrl = result.url;
            }
        }

        const fallbackPhotoUrl = 'https://via.placeholder.com/500x650/0f172a/ffffff?text=Profile';
        const previewMap = new Map(
            (Array.isArray(this.companionshipPostImages) ? this.companionshipPostImages : [])
                .filter((it) => it?.file && it?.url)
                .map((it) => [`${it.file.name}|${it.file.size}|${it.file.lastModified}`, it.url])
        );
        const galleryPhotos = validImages.length
            ? validImages.map((file) => previewMap.get(`${file.name}|${file.size}|${file.lastModified}`) || URL.createObjectURL(file))
            : [fallbackPhotoUrl];
        const primaryPhotoUrl = galleryPhotos[0] || fallbackPhotoUrl;

	        let gender = '';
	        let serviceCategory = '';
	        let intentCategory = category;
	        if (category === 'men') gender = 'Man';
	        if (category === 'women') gender = 'Woman';
	        if (category === 'massage') serviceCategory = 'massage';
	        if (category === 'gigs_jobs') serviceCategory = 'gigs_jobs';
	        if (category === 'help') serviceCategory = 'gigs_jobs';
	        if (category === 'wellness') serviceCategory = 'wellness';
	        if (category === 'men' || category === 'women') intentCategory = '';

	        if (mode === 'dating_featured') {
	            this.closeCompanionshipPostModal(true);
	            const paid = await this.requirePromotionFee({
	                placement: 'dating_featured',
	                title: 'Dating featured profile fee',
	                subtitle: 'Dating featured profiles are a paid placement.'
	            });
	            if (!paid) {
	                this.openCompanionshipPostModal({ pushState: false, mode: 'dating_featured' });
	                return;
	            }

	            const profileId = `dating-ad-${Date.now()}`;
	            const sponsored = {
	                id: profileId,
	                name: alias,
	                age,
	                role: 'Spotlight Member',
	                distance: `${city}${country ? `, ${country}` : ''}`,
	                looking: tagline,
	                bio: description,
	                online: true,
	                statusText: 'Online now',
	                highlights: [String(storyText || '').trim()].filter(Boolean).slice(0, 3),
	                interests: [category].filter(Boolean),
	                lifestyle: null,
	                city,
	                country,
	                photos: galleryPhotos,
	                postedAt: new Date(),
	                video: videoUrl
	            };
	            if (!this.datingSponsoredProfiles || typeof this.datingSponsoredProfiles !== 'object') {
	                this.datingSponsoredProfiles = {};
	            }
	            this.datingSponsoredProfiles[profileId] = sponsored;
	            this.insertDatingFeaturedProfileCard(profileId, sponsored);
	            this.addMyPost({
	                kind: 'dating_featured',
	                title: alias,
	                subtitle: 'Dating featured profile',
	                thumb: primaryPhotoUrl,
	                refs: { datingProfileId: profileId },
	                payload: { mode, category, city, country }
	            });

	            // Keep blob URLs alive for the posted profile (do not revoke on close/reset).
	            this.companionshipPostStoryPreviewUrl = '';
	            this.companionshipPostImages = [];
	            form.reset();
	            this.showNotification('Posted! Your featured dating profile is live.');
	            this.closeCompanionshipPostModal();
	            return;
	        }

	        const newProfile = {
	            id: `comp-${Date.now()}`,
	            alias,
	            age,
	            tagline,
	            description,
	            storyText: String(storyText || '').slice(0, 90),
	            country,
	            region,
	            city,
	            gender,
	            intentCategory,
	            serviceCategory,
	            photo: primaryPhotoUrl,
	            photos: galleryPhotos,
	            online: isOnline,
	            premium: false,
	            lastActive: 'Online now',
	            postedAt: new Date(),
	            video: videoUrl
	        };
	        const coords = this.getCompanionshipCoords(newProfile);
	        if (coords) {
	            newProfile.lat = coords.lat;
	            newProfile.lng = coords.lng;
	        }

	        this.companionshipProfiles.unshift(newProfile);
	        // Keep blob URLs alive for the posted profile (do not revoke on close/reset).
	        this.companionshipPostStoryPreviewUrl = '';
	        this.companionshipPostImages = [];
	        form.reset();
	        this.resetCompanionshipPagination();
	        this.applyCompanionshipFilters();
		        this.showNotification('Posted! Your companionship profile is live.');
	        this.closeCompanionshipPostModal();
	    }

    validateShortVideo(file, minSeconds = 5, maxSeconds = 10) {
        if (!file) return Promise.resolve({ ok: true, url: '' });
        if (!file.type || !file.type.startsWith('video/')) {
            return Promise.resolve({ ok: false, message: 'Please select a video file.' });
        }
        const url = URL.createObjectURL(file);
        return new Promise((resolve) => {
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.onloadedmetadata = () => {
                const duration = video.duration;
                if (!Number.isFinite(duration)) {
                    URL.revokeObjectURL(url);
                    resolve({ ok: false, message: 'Could not read video duration.' });
                    return;
                }
                if (duration < minSeconds || duration > maxSeconds) {
                    URL.revokeObjectURL(url);
                    resolve({ ok: false, message: `Video must be ${minSeconds}-${maxSeconds} seconds.` });
                    return;
                }
                resolve({ ok: true, url });
            };
            video.onerror = () => {
                URL.revokeObjectURL(url);
                resolve({ ok: false, message: 'Video could not be loaded.' });
            };
            video.src = url;
        });
    }

    getCompanionshipCoords(profile) {
        if (profile?.lat && profile?.lng) return { lat: profile.lat, lng: profile.lng };
        if (!profile?.city || !profile?.country) return null;
        const key = `${profile.city}|${profile.country}`;
        return this.companionshipCityGeo[key] || null;
    }

    setupDatingCategoryFilterButtons() {
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.addEventListener('click', () => {
                if (!this.currentDatingCategory) return;
                this.currentDatingCategoryFilter = btn.dataset.filter || 'all';
                this.updateDatingCategoryFilterButtons(this.currentDatingCategoryFilter);
                this.renderDatingCategoryFeed();
            });
            btn.dataset.bound = '1';
        });
    }

    updateDatingCategoryFilterButtons(filter) {
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.toggle('active', (btn.dataset.filter || 'all') === filter);
        });
    }

    renderDatingCategoryFeed() {
        const key = this.currentDatingCategory;
        const container = document.getElementById('dating-category-feed');
        if (!key || !container) return;

        if (key === 'instant_meetups') {
            this.showHookupPlusPane();
            return;
        }

        if (key === 'companionship') {
            this.hideHookupPlusPane();
            this.showCompanionshipPane();
            this.applyCompanionshipFilters();
            return;
        }
        this.hideHookupPlusPane();
        this.hideCompanionshipPane();

        const feed = this.datingCategoryFeeds?.[key] || [];
        const filter = this.currentDatingCategoryFilter || 'all';

        const filtered = feed.filter(item => {
            if (filter === 'online' && !item.online) return false;
            if (filter === 'nearby' && (typeof item.distance === 'number' && item.distance > 10)) return false;
            if (filter === 'premium' && !item.premium) return false;
            return true;
        });

        if (filtered.length === 0) {
            const label = this.datingCategoryLabels?.[key] || 'this category';
            container.innerHTML = `
                <div class="category-empty">
                    <i class="fas fa-sparkles" style="font-size:2.5rem;opacity:0.35;margin-bottom:0.5rem;"></i>
                    <h3>No matches yet</h3>
                    <p>Be the first to post in <strong>${label}</strong> or adjust your filters.</p>
                </div>`;
            return;
        }

        this.categoryPhotoSets = {};

        const fallbackPhoto = 'https://via.placeholder.com/600x400/ebeef5/111827?text=Profile';
        container.innerHTML = filtered.map(item => {
            const distance = (typeof item.distance === 'number') ? `${item.distance}km away` : 'Distance n/a';
            const photos = Array.isArray(item.photos) && item.photos.length
                ? item.photos.slice(0, 5)
                : [fallbackPhoto, fallbackPhoto, fallbackPhoto];
            const mainPhoto = photos[0];
            const groupId = `${key}-${item.id}`;
            this.categoryPhotoSets[groupId] = {
                items: photos.map(src => ({ src, label: item.title })),
                meta: {
                    type: key,
                    title: item.title,
                    subtitle: item.subtitle,
                    description: item.description,
                    distance: item.distance,
                    online: item.online,
                    tags: item.tags
                }
            };
            const photoCount = photos.length ? `<span class="category-photo-count" aria-label="${photos.length} photos"><i class="fas fa-images"></i>${photos.length} photos</span>` : '';
            const useCompanionshipLayout = key === 'companionship';
            let photoSectionHtml = '';
            if (useCompanionshipLayout) {
                const gridItems = photos.map((src, idx) => `
                    <img src="${src}" alt="${item.title} photo ${idx + 1}" class="companionship-photo category-photo-click" data-photo-src="${src}" data-photo-label="${item.title}" data-photo-group="${groupId}" data-photo-index="${idx}" tabindex="0" role="button" aria-label="View ${item.title} photo ${idx + 1}" loading="lazy">
                `).join('');
                photoSectionHtml = `
                    <div class="companionship-photo-grid">
                        ${photoCount}
                        ${gridItems}
                    </div>`;
            } else {
                const extraPhotos = photos.slice(1);
                const thumbsHtml = extraPhotos.length ? `
                    <div class="category-thumbs">
                        ${extraPhotos.map((src, idx) => `<img src="${src}" alt="${item.title} photo ${idx + 2}" class="category-thumb category-photo-click" data-photo-src="${src}" data-photo-label="${item.title}" data-photo-group="${groupId}" data-photo-index="${idx + 1}" tabindex="0" role="button" aria-label="View ${item.title} photo ${idx + 2}" loading="lazy">`).join('')}
                    </div>` : '';
                photoSectionHtml = `
                    <div class="category-main-photo-wrapper">
                        <img src="${mainPhoto}" alt="${item.title} primary photo" class="category-main-photo category-photo-click" data-photo-src="${mainPhoto}" data-photo-label="${item.title}" data-photo-group="${groupId}" data-photo-index="0" tabindex="0" role="button" aria-label="View ${item.title} photo 1" loading="lazy">
                        ${photoCount}
                    </div>
                    ${thumbsHtml}`;
            }
            const hasVideo = Boolean(item.video);
            const videoDuration = item.videoDuration || 10;
            const videoLabelText = useCompanionshipLayout
                ? `${videoDuration}s companionship video`
                : `${videoDuration}s spotlight`;
            const videoHtml = hasVideo
                ? `
                    <div class="category-video${useCompanionshipLayout ? ' companionship-video' : ''}" aria-label="Profile video clip">
                        <video src="${item.video}" controls playsinline preload="metadata" poster="${mainPhoto}"></video>
                        <span class="category-video-label"><i class="fas fa-video"></i>${videoLabelText}</span>
                    </div>`
                : '';
            const mediaBlock = `
                <div class="category-media${useCompanionshipLayout ? ' companionship-layout' : ''}">
                    ${photoSectionHtml}
                    ${videoHtml}
                </div>`;
            const tagsHtml = item.tags?.length ? `<div class="category-card-tags">${item.tags.map(tag => `<span>${tag}</span>`).join('')}</div>` : '';
            return `
            <article class="category-card">
                <div class="category-card-header">
                    <div>
                        <h3>
                            <button class="category-card-name-link" type="button" data-photo-group="${groupId}" data-photo-index="0">
                                ${item.title}
                            </button>
                        </h3>
                        <p>${item.subtitle}</p>
                    </div>
                    ${item.online ? '<span class="category-status online">Online</span>' : ''}
                </div>
                <div class="category-card-meta">
                    <span><i class="fas fa-map-marker-alt"></i>${distance}</span>
                    <span><i class="fas fa-clock"></i>Updated ${item.updated}</span>
                    ${item.premium ? '<span class="category-premium"><i class="fas fa-crown"></i> Premium</span>' : ''}
                </div>
                ${mediaBlock}
                <p class="category-card-body">${item.description}</p>
                ${tagsHtml}
            </article>`;
        }).join('');

        const photoElements = container.querySelectorAll('.category-photo-click');
        photoElements.forEach(el => {
            el.addEventListener('click', (event) => {
                event.stopPropagation();
                const target = event.currentTarget;
                const src = target.dataset.photoSrc || target.getAttribute('src');
                if (!src) return;
                const datasetLabel = target.dataset.photoLabel || '';
                const title = datasetLabel || target.getAttribute('aria-label')?.replace(/^View\s+/i, '') || 'Profile photo';
                const groupId = target.dataset.photoGroup;
                const photoIndex = parseInt(target.dataset.photoIndex || '0', 10) || 0;
                const groupInfo = groupId ? this.categoryPhotoSets?.[groupId] : null;
                if (groupInfo?.meta?.type === 'companionship') {
                    const profile = this.buildCompanionshipProfile(groupInfo.meta);
                    const gallery = groupInfo.items?.map((it) => it.src) || [];
                    const index = Math.min(Math.max(photoIndex, 0), Math.max(gallery.length - 1, 0));
                    this.openProfileModal(profile, index, gallery);
                    return;
                }
                if (groupInfo?.items?.length) {
                    const index = Math.min(Math.max(photoIndex, 0), groupInfo.items.length - 1);
                    this.openMediaLightbox(groupInfo.items, groupInfo.items[index]?.label || title, index);
                    return;
                }
                this.openMediaLightbox(src, title);
            });
            el.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    el.click();
                }
            });
        });

        const nameLinks = container.querySelectorAll('.category-card-name-link');
        nameLinks.forEach(link => {
            link.addEventListener('click', () => {
                const groupId = link.dataset.photoGroup;
                const startIndex = parseInt(link.dataset.photoIndex || '0', 10) || 0;
                const groupInfo = groupId ? this.categoryPhotoSets?.[groupId] : null;
                if (!groupInfo) return;
                const gallery = groupInfo.items?.map((it) => it.src) || [];
                const index = Math.min(Math.max(startIndex, 0), Math.max(gallery.length - 1, 0));
                if (groupInfo.meta?.type === 'companionship') {
                    const profile = this.buildCompanionshipProfile(groupInfo.meta);
                    this.openProfileModal(profile, index, gallery);
                    return;
                }
                if (groupInfo.items?.length) {
                    this.openMediaLightbox(groupInfo.items, groupInfo.items[index]?.label || 'Profile', index);
                }
            });
        });
    }

    getDatingCategorySubtitle(key) {
        const copy = {
            serious_long_term: 'Deep-dive profiles who are ready to invest in a future.',
            casual_dating: 'Low-pressure vibes and chemistry-first encounters.',
            friendship: 'New circles, shared hobbies, and platonic adventures.',
            travel_vacation: 'Connect with travelers and locals for destination memories.',
            networking_social: 'Expand your circle with collaborative, ambitious people.',
            companionship: 'Location-based companionship listings you can filter by Men, Women, Massage, and Gigs & Jobs.',
            arrive_plus: 'Arrival-ready plans for people landing in town and ready to meet.',
            instant_meetups: 'Spur-of-the-moment hookups from people already nearby.',
            virtual_video: 'Video-first dating and remote hangouts that fit your schedule.',
            exclusive_premium: 'Curated introductions and premium, invite-only gatherings.',
            premium_18_plus: 'Verified 18+ dating with stronger safety tools.'
        };
        return copy[key] || 'Live feed tailored to your selection.';
    }

    truncateText(text, max) {
        if (!text) return '';
        return text.length > max ? text.slice(0, max - 1) + '' : text;
    }

    bindFeaturedAds() {
        const featuredData = [
            {
                title: 'iPhone 15 Pro Max 路 1TB',
                bio: 'Verified seller with fast worldwide shipping and original accessories.',
                location: 'Ships worldwide from San Francisco',
                date: 'Posted today',
                images: [
                    'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=900&h=650',
                    'https://images.unsplash.com/photo-1512499617640-c2f999098c01?auto=format&fit=crop&w=900&h=650'
                ],
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            },
            {
                title: 'Lisbon Daylight Loft',
                bio: 'Creative rental with plants, projector, and modular seating.',
                location: 'Lisbon, Portugal',
                date: 'Updated 2h ago',
                images: [
                    'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=900&h=650',
                    'https://images.unsplash.com/photo-1523419400524-2230b3fc2e0f?auto=format&fit=crop&w=900&h=650'
                ],
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            },
            {
                title: 'Mid-century Dining Suite',
                bio: 'Walnut finish set with white-glove delivery available.',
                location: 'Bay Area pickup',
                date: 'Posted this week',
                images: [
                    'https://images.unsplash.com/photo-1484100356142-db6ab6244067?auto=format&fit=crop&w=900&h=650',
                    'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=900&h=650'
                ],
                video: 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4'
            }
        ];

        const promote = document.getElementById('home-promote-ad');
        if (promote && !promote.dataset.bound) {
            promote.addEventListener('click', () => {
                this.showPostItemModal({ placement: 'home_featured', luxe: true });
            });
            promote.dataset.bound = '1';
        }

        const cards = document.querySelectorAll('.featured-ad-card');
        cards.forEach((card, idx) => {
            if (card.dataset.bound) return;
            const isMarketplaceSponsored = Boolean(card.closest('#marketplace-content .home-featured-ads'));
            const isRealestateSponsored = Boolean(card.closest('#realestate-content .realestate-featured'));
            const isVehiclesSponsored = Boolean(card.closest('#vehicles-content .vehicle-featured-top'));
            const isServicesSponsored = Boolean(card.closest('#services-content .services-featured'));
            const isCommunitySponsored = Boolean(card.closest('#community-content .home-featured-ads'));
            if (isMarketplaceSponsored || isRealestateSponsored || isVehiclesSponsored || isServicesSponsored || isCommunitySponsored) return;
            const data = featuredData[idx] || {};
            const imgEl = card.querySelector('img');
            const titleEl = card.querySelector('h4');
            const detailsEls = card.querySelectorAll('p, span');
            const title = (titleEl?.textContent || data.title || 'Featured pick').trim();
            const captionParts = [title, ...Array.from(detailsEls).map(el => el.textContent.trim()).filter(Boolean)];
            const meta = {
                bio: data.bio || captionParts.join('  '),
                location: data.location || detailsEls?.[1]?.textContent || '',
                date: data.date || ''
            };
            const images = (data.images && data.images.length) ? data.images : [imgEl?.getAttribute('src') || ''];
            const gallery = images.filter(Boolean).map(src => ({ src, label: title, type: 'image', meta }));
            if (data.video) {
                gallery.push({ src: data.video, label: `${title} video`, type: 'video', meta });
            }
            const openFeatured = () => {
                if (gallery.length) {
                    this.openMediaLightbox(gallery, title, 0);
                } else {
                    this.showNotification(title || 'Featured ad');
                }
            };
            card.addEventListener('click', openFeatured);
            card.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openFeatured();
                }
            });
            card.dataset.bound = '1';
        });
    }

    getProfileLocationLabel(user) {
        if (!user?.location) return 'Location unknown';
        const { city, country, distance } = user.location;
        const parts = [];
        if (typeof distance === 'number') parts.push(`${distance}km away`);
        if (city) parts.push(city);
        if (country) parts.push(country);
        return parts.length ? parts.join(' 路 ') : 'Location unknown';
    }

    buildCompanionshipProfile(meta = {}) {
        const parsedAge = this.extractAge(meta.title);
        return {
            name: meta.title || 'Companionship profile',
            age: parsedAge,
            bio: meta.description || meta.subtitle || 'Looking for steady company.',
            interests: Array.isArray(meta.tags) && meta.tags.length ? meta.tags : ['Warm presence', 'Good listener'],
            location: { distance: meta.distance },
            online: meta.online,
            matchPreferences: meta.subtitle || ''
        };
    }

    extractAge(text = '') {
        const match = String(text).match(/,\s*(\d{2})/);
        if (!match) return undefined;
        const age = parseInt(match[1], 10);
        return Number.isFinite(age) ? age : undefined;
    }

    showProfileModal(userId) {
        const user = this.users.find(u => u.id === userId);
        if (!user) return;
        this.openProfileModal(user, 0);
    }

    normalizeSrc(src) {
        return (src || '').split('?')[0];
    }

    getLifestyleEntries(profile = {}) {
        const source = profile.lifestylePreferences || profile.lifestyle || {};
        const normalized = source && typeof source === 'object' && !Array.isArray(source) ? source : {};
        const pick = (keys) => {
            for (const key of keys) {
                const value = normalized[key];
                if (value === 0) return value;
                if (value) return value;
            }
            return '';
        };
        const rows = [
            { label: 'Drinking', value: pick(['drinking', 'drink']) },
            { label: 'Smoking', value: pick(['smoking', 'smoke']) },
            { label: 'Cannabis', value: pick(['cannabis', 'weed']) },
            { label: 'Religion', value: pick(['religion', 'faith']) },
            { label: 'Kids', value: pick(['kids', 'children']) },
            { label: 'Education', value: pick(['education', 'school']) },
            { label: 'Occupation', value: pick(['occupation', 'job', 'work']) }
        ];
        return rows.map((row) => ({
            label: row.label,
            value: row.value ? String(row.value) : 'Not shared'
        }));
    }

    buildUserGallery(user) {
        if (!user) return [];
        const images = [];
        const seen = new Set();
        const pushUnique = (src) => {
            if (!src) return;
            const key = this.normalizeSrc(src);
            if (seen.has(key)) return;
            seen.add(key);
            images.push({ src, label: user.name });
        };
        pushUnique(user.photo);
        if (Array.isArray(user.photos)) {
            user.photos.forEach(pushUnique);
        }
        return images;
    }

    buildLightboxItems(sources, defaultLabel = '') {
        if (!sources) return [];
        const raw = Array.isArray(sources) ? sources : [sources];
        const items = raw.map(item => {
            if (!item) return null;
            if (typeof item === 'string') {
                return { src: item, label: defaultLabel, type: 'image' };
            }
            if (typeof item === 'object') {
                const src = item.src || item.url || '';
                if (!src) return null;
                const type = item.type || (src.match(/\\.(mp4|webm|ogg)(\\?|$)/i) ? 'video' : 'image');
                return {
                    src,
                    label: item.label ?? defaultLabel,
                    type,
                    meta: item.meta
                };
            }
            return null;
        }).filter(Boolean);

        const unique = [];
        const seen = new Set();
        items.forEach(entry => {
            const key = this.normalizeSrc(entry.src);
            if (seen.has(key)) return;
            seen.add(key);
            unique.push(entry);
        });
        return unique;
    }

    refreshMediaLightbox() {
        const frame = document.getElementById('ml-frame');
        const caption = document.getElementById('media-lightbox-caption');
        const counter = document.getElementById('ml-counter');
        if (!frame) return;

        const current = this.lightboxItems?.[this.lightboxIndex];
        if (!current) return;

        frame.innerHTML = '';
        if (current.type === 'video') {
            const video = document.createElement('video');
            video.src = current.src;
            video.controls = true;
            video.playsInline = true;
            video.preload = 'metadata';
            video.setAttribute('aria-label', current.label || 'Profile video');
            frame.appendChild(video);
        } else {
            const img = document.createElement('img');
            img.src = current.src;
            img.alt = current.label ? `${current.label} enlarged` : 'Enlarged profile photo';
            frame.appendChild(img);
        }

	        if (caption) {
	            const meta = current.meta || {};
	            const bio = meta.bio ? this.escapeHtml(String(meta.bio)) : '';
	            const location = meta.location ? this.escapeHtml(String(meta.location)) : '';
	            const posted = meta.date ? this.escapeHtml(String(meta.date)) : '';
	            const specs = meta.specs ? this.escapeHtml(String(meta.specs)) : '';
	            const delivery = meta.delivery ? this.escapeHtml(String(meta.delivery)) : '';
	            const availability = meta.availability ? this.escapeHtml(String(meta.availability)) : '';
	            const payment = meta.payment ? this.escapeHtml(String(meta.payment)) : '';
	            const contact = meta.contact ? this.escapeHtml(String(meta.contact)) : '';
	            const tagsValue = Array.isArray(meta.tags) ? meta.tags : (typeof meta.tags === 'string' ? meta.tags.split(',') : []);
	            const tags = tagsValue
	                .map(tag => String(tag || '').trim())
	                .filter(Boolean)
	                .slice(0, 12);
	            const tagsText = tags.length ? this.escapeHtml(tags.join('  ')) : '';
	            const rows = [
	                current.label || '',
	                bio && `<div class="ml-meta-row"><i class="fas fa-user"></i><span>${bio}</span></div>`,
	                specs && `<div class="ml-meta-row"><i class="fas fa-list" aria-hidden="true"></i><span>${specs}</span></div>`,
	                delivery && `<div class="ml-meta-row"><i class="fas fa-truck" aria-hidden="true"></i><span>${delivery}</span></div>`,
	                availability && `<div class="ml-meta-row"><i class="fas fa-clock" aria-hidden="true"></i><span>${availability}</span></div>`,
	                tagsText && `<div class="ml-meta-row"><i class="fas fa-hashtag" aria-hidden="true"></i><span>${tagsText}</span></div>`,
	                contact && `<div class="ml-meta-row"><i class="fas fa-phone" aria-hidden="true"></i><span>${contact}</span></div>`,
	                payment && `<div class="ml-meta-row"><i class="fas fa-credit-card" aria-hidden="true"></i><span>${payment}</span></div>`,
	                location && `<div class="ml-meta-row"><i class="fas fa-map-marker-alt"></i><span>${location}</span></div>`,
	                posted && `<div class="ml-meta-row"><i class="fas fa-clock"></i><span>${posted}</span></div>`
	            ].filter(Boolean).join('');
	            caption.innerHTML = rows || '';
	        }

	        if (counter) {
	            if (this.lightboxItems.length > 1) {
	                counter.textContent = `${this.lightboxIndex + 1} of ${this.lightboxItems.length}`;
	                counter.classList.remove('hidden');
	            } else {
	                counter.textContent = '';
	                counter.classList.add('hidden');
	            }
	        }

	        this.renderMediaLightboxThumbs();
	    }

	    renderMediaLightboxThumbs() {
	        const thumbs = document.getElementById('ml-thumbs');
	        if (!thumbs) return;
	        const items = Array.isArray(this.lightboxItems) ? this.lightboxItems : [];
	        if (items.length <= 1) {
	            thumbs.innerHTML = '';
	            thumbs.classList.add('hidden');
	            return;
	        }

	        const idx = Math.min(Math.max(this.lightboxIndex || 0, 0), items.length - 1);
	        thumbs.classList.remove('hidden');
	        thumbs.innerHTML = items.map((item, i) => {
	            const isActive = i === idx;
	            const label = this.escapeHtml(String(item.label || 'Media'));
	            if (item.type === 'video') {
	                return `<button class="ml-thumb ml-thumb-video${isActive ? ' active' : ''}" type="button" data-ml-thumb="${i}" aria-label="Open video ${i + 1}"><i class="fas fa-play" aria-hidden="true"></i></button>`;
	            }
	            const src = this.escapeHtml(String(item.src || ''));
	            return `<button class="ml-thumb${isActive ? ' active' : ''}" type="button" data-ml-thumb="${i}" aria-label="Open photo ${i + 1}"><img src="${src}" alt="${label} thumbnail" loading="lazy"></button>`;
	        }).join('');

	        if (!thumbs.dataset.bound) {
	            thumbs.addEventListener('click', (e) => {
	                const btn = e.target.closest('[data-ml-thumb]');
	                if (!btn) return;
	                const i = parseInt(btn.dataset.mlThumb, 10);
	                if (!Number.isFinite(i)) return;
	                this.lightboxIndex = Math.min(Math.max(i, 0), (this.lightboxItems?.length || 1) - 1);
	                this.refreshMediaLightbox();
	                this.updateLightboxNavButtons();
	            });
	            thumbs.dataset.bound = '1';
	        }

	        const active = thumbs.querySelector('.ml-thumb.active');
	        active?.scrollIntoView?.({ block: 'nearest', inline: 'center' });
	    }

    updateLightboxNavButtons() {
        const prevBtn = document.getElementById('media-lightbox-prev');
        const nextBtn = document.getElementById('media-lightbox-next');
        const multiple = this.lightboxItems.length > 1;

        if (prevBtn) {
            prevBtn.classList.toggle('hidden', !multiple);
            prevBtn.disabled = !multiple || this.lightboxIndex <= 0;
            prevBtn.setAttribute('aria-hidden', (!multiple).toString());
        }
        if (nextBtn) {
            nextBtn.classList.toggle('hidden', !multiple);
            nextBtn.disabled = !multiple || this.lightboxIndex >= this.lightboxItems.length - 1;
            nextBtn.setAttribute('aria-hidden', (!multiple).toString());
        }
    }

    stepMediaLightbox(delta) {
        if (!Number.isInteger(delta) || this.lightboxItems.length < 2) return;
        const nextIndex = this.lightboxIndex + delta;
        if (nextIndex < 0 || nextIndex >= this.lightboxItems.length) return;
        this.lightboxIndex = nextIndex;
        this.refreshMediaLightbox();
        this.updateLightboxNavButtons();
    }

    openMediaLightbox(sources, label = '', startIndex = 0) {
        const overlay = document.getElementById('media-lightbox');
        if (!overlay) return;

        const items = this.buildLightboxItems(sources, label);
        if (!items.length) return;

        this.lightboxItems = items;
        this.lightboxIndex = Math.min(Math.max(startIndex, 0), items.length - 1);

        this.refreshMediaLightbox();
        this.updateLightboxNavButtons();

        overlay.classList.remove('hidden');
        document.body.classList.add('media-lightbox-open');

        document.removeEventListener('keydown', this.boundLightboxKeydown);
        document.addEventListener('keydown', this.boundLightboxKeydown);

        const focusTarget = (this.lightboxItems.length > 1
            ? document.getElementById('media-lightbox-next')
            : document.getElementById('ml-close')) || overlay;
        focusTarget?.focus?.();
    }

	    closeMediaLightbox() {
	        const overlay = document.getElementById('media-lightbox');
	        if (!overlay) return;
	        const frame = document.getElementById('ml-frame');
	        const caption = document.getElementById('media-lightbox-caption');
	        const counter = document.getElementById('ml-counter');
	        const thumbs = document.getElementById('ml-thumbs');

        overlay.classList.add('hidden');
        document.body.classList.remove('media-lightbox-open');
        document.removeEventListener('keydown', this.boundLightboxKeydown);

        if (frame) frame.innerHTML = '';
        if (caption) caption.textContent = '';
	        if (counter) {
	            counter.textContent = '';
	            counter.classList.add('hidden');
	        }
	        if (thumbs) {
	            thumbs.innerHTML = '';
	            thumbs.classList.add('hidden');
	        }

	        this.lightboxItems = [];
	        this.lightboxIndex = 0;
	        this.updateLightboxNavButtons();
	    }

    handleLightboxKeydown(event) {
        if (event.key === 'Escape') {
            this.closeMediaLightbox();
        } else if (event.key === 'ArrowRight') {
            this.stepMediaLightbox(1);
        } else if (event.key === 'ArrowLeft') {
            this.stepMediaLightbox(-1);
        }
    }

    // Location Screen
    loadNearbyUsers() {
        this.updateNearbyList();
        this.initializeMap();
    }

    resolveNearbyCountryFilter(query = '') {
        const q = String(query || '').trim().toLowerCase();
        if (!q) return '';
        const countries = Array.from(new Set(
            (this.users || [])
                .map(u => u?.location?.country)
                .filter(Boolean)
                .map(String)
        ));
        if (!countries.length) return '';
        const exact = countries.find(country => country.toLowerCase() === q);
        if (exact) return exact;
        const prefixMatches = countries.filter(country => country.toLowerCase().startsWith(q));
        if (prefixMatches.length === 1) return prefixMatches[0];
        return '';
    }

    getNearbyDistance(user) {
        const loc = user?.location;
        if (!loc) return Number.POSITIVE_INFINITY;
        const demoDistance = loc.nearbyDistance;
        if (typeof demoDistance === 'number') return demoDistance;
        const distance = loc.distance;
        if (typeof distance === 'number') return distance;
        return Number.POSITIVE_INFINITY;
    }

    getNearbyFilteredUsers() {
        const distanceValue = parseInt(document.getElementById('distance-range')?.value || '', 10);
        const distanceFilter = Number.isFinite(distanceValue) ? distanceValue : Infinity;
        const q = (this.nearbySearchQuery || '').trim().toLowerCase();
        const countryFilter = (this.nearbyCountryFilter || '').trim().toLowerCase();
        const onlineOnly = this.nearbyOnlineOnly === true;

        let filtered = (this.users || []).filter(Boolean);
        if (onlineOnly) {
            filtered = filtered.filter(user => user?.online === true);
        }
        if (countryFilter) {
            filtered = filtered.filter(user => {
                const userCountry = String(user?.location?.country || '').trim().toLowerCase();
                return userCountry === countryFilter;
            });
        } else {
            filtered = filtered.filter(user => this.getNearbyDistance(user) <= distanceFilter);
            if (q) {
                filtered = filtered.filter(user => {
                    const haystack = [
                        user.name,
                        Array.isArray(user.interests) ? user.interests.join(' ') : '',
                        user.location?.city,
                        user.location?.country
                    ]
                        .filter(Boolean)
                        .join(' ')
                        .toLowerCase();
                    return haystack.includes(q);
                });
            }
        }

        return filtered.sort((a, b) => {
            const countryA = String(a?.location?.country || '');
            const countryB = String(b?.location?.country || '');
            const countryCmp = countryA.localeCompare(countryB);
            if (countryCmp !== 0) return countryCmp;
            const cityA = String(a?.location?.city || '');
            const cityB = String(b?.location?.city || '');
            const cityCmp = cityA.localeCompare(cityB);
            if (cityCmp !== 0) return cityCmp;
            return this.getNearbyDistance(a) - this.getNearbyDistance(b);
        });
    }

    updateNearbyList() {
        const nearbyList = document.getElementById('nearby-list');
        const nearbyUsers = this.getNearbyFilteredUsers();
        
        nearbyList.innerHTML = '';
        
        nearbyUsers.forEach(user => {
            const userElement = document.createElement('div');
	            userElement.className = 'nearby-item';
            const isOnline = Boolean(user.online);
            const statusLabel = isOnline ? 'Online now' : 'Offline';
            const statusClass = isOnline ? 'nearby-status' : 'nearby-status offline';
            const safeName = this.escapeHtml(String(user.name || ''));
            const city = this.escapeHtml(String(user.location?.city || ''));
            const country = this.escapeHtml(String(user.location?.country || ''));
            const distanceValue = this.getNearbyDistance(user);
            const distanceLabel = Number.isFinite(distanceValue) ? `${distanceValue}km away` : 'Distance unknown';
            const canShowMap = Boolean(user.location?.city || user.location?.country);
            const cityQuery = canShowMap ? this.getUserCityQuery(user) : '';
            const mapUrl = cityQuery ? this.buildGoogleMapsLink(cityQuery) : '';
            const staticPreview = cityQuery ? this.buildStaticMapPreviewUrl(cityQuery) : '';

            userElement.innerHTML = `
                <div class="nearby-main" role="button" tabindex="0" aria-label="Open ${safeName}">
                    <img src="${user.photo}" alt="${safeName}">
                    <div class="nearby-info">
                        <h4>${safeName}, ${user.age}</h4>
                        <p>${distanceLabel}${city || country ? `  ${[city, country].filter(Boolean).join(', ')}` : ''}</p>
                    </div>
                </div>
                <div class="nearby-actions">
                    <div class="${statusClass}">
                        <span class="dot" aria-hidden="true"></span>
                        <span>${statusLabel}</span>
                    </div>
                    ${staticPreview ? `
                        <a class="nearby-map-preview" href="${mapUrl}" target="_blank" rel="noopener" aria-label="Open map for ${safeName}">
                            <img src="${staticPreview}" alt="Map preview for ${safeName}">
                        </a>
                    ` : ''}
	                    ${mapUrl ? `<a class="btn-secondary small" href="${mapUrl}" target="_blank" rel="noopener">Open city</a>` : ''}
	                </div>
	            `;
            const openUser = () => {
                const gallery = this.buildUserGallery(user).map(item => item.src);
                this.openProfileModal(user, 0, gallery);
            };
            const main = userElement.querySelector('.nearby-main');
            if (main) {
                main.addEventListener('click', openUser);
                main.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter' && e.key !== ' ') return;
                    e.preventDefault();
                    openUser();
                });
            }
            nearbyList.appendChild(userElement);
        });
    }

    updateDistanceFilter(distance) {
        document.getElementById('distance-value').textContent = `${distance}km`;
        this.updateNearbyList();
        this.updateMapMarkers();
    }

	    obfuscateCoords(lat, lng, seed = 0) {
	        return this.obfuscateCoordsWithRadius(lat, lng, seed, 0.02);
	    }

	    obfuscateCoordsWithRadius(lat, lng, seed = 0, maxOffset = 0.02) {
	        const la = Number(lat);
	        const lo = Number(lng);
	        if (!Number.isFinite(la) || !Number.isFinite(lo)) return null;
	        const s = Number(seed) || 0;
	        const x = Math.sin(s * 999 + la * 12.9898 + lo * 78.233) * 43758.5453;
	        const y = Math.cos(s * 1337 + la * 93.9898 + lo * 67.345) * 24634.6345;
	        const fx = x - Math.floor(x);
	        const fy = y - Math.floor(y);
	        const dLat = (fx - 0.5) * maxOffset;
	        const dLng = (fy - 0.5) * maxOffset;
	        return { lat: la + dLat, lng: lo + dLng };
	    }

	    hashStringToInt(input) {
	        const str = String(input || '');
	        let hash = 0;
	        for (let i = 0; i < str.length; i += 1) {
	            hash = (hash << 5) - hash + str.charCodeAt(i);
	            hash |= 0;
	        }
	        return hash;
	    }

	    getUserCityQuery(user) {
	        const city = user?.location?.city;
	        const country = user?.location?.country;
	        return [city, country].filter(Boolean).join(', ');
	    }

	    getUserApproxCoords(user) {
	        const loc = user?.location;
	        const la = Number(loc?.lat);
	        const lo = Number(loc?.lng);
	        if (!Number.isFinite(la) || !Number.isFinite(lo)) return null;

	        const snapped = {
	            lat: Math.round(la * 10) / 10,
	            lng: Math.round(lo * 10) / 10
	        };

	        const seed = this.hashStringToInt(this.getUserCityQuery(user)) || 0;
	        return this.obfuscateCoordsWithRadius(snapped.lat, snapped.lng, seed, 0.015);
	    }

	    buildGoogleMapsLink(queryOrLat, lng) {
	        if (typeof queryOrLat === 'string') {
	            const query = queryOrLat.trim();
	            if (!query) return '';
	            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
	        }
	        const la = Number(queryOrLat);
	        const lo = Number(lng);
	        if (!Number.isFinite(la) || !Number.isFinite(lo)) return '';
	        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${la.toFixed(1)},${lo.toFixed(1)}`)}`;
	    }

	    buildStaticMapPreviewUrl(queryOrLat, lng) {
	        if (!this.googleApiKey || this.googleApiKey.includes('YOUR_GOOGLE_API_KEY')) return '';
	        if (typeof queryOrLat === 'string') {
	            const query = queryOrLat.trim();
	            if (!query) return '';
	            return `https://maps.googleapis.com/maps/api/staticmap?center=${encodeURIComponent(query)}&zoom=12&size=360x220&scale=2&maptype=roadmap&key=${encodeURIComponent(this.googleApiKey)}`;
	        }
	        const la = Number(queryOrLat);
	        const lo = Number(lng);
	        if (!Number.isFinite(la) || !Number.isFinite(lo)) return '';
	        const marker = encodeURIComponent(`color:red|${la.toFixed(1)},${lo.toFixed(1)}`);
	        return `https://maps.googleapis.com/maps/api/staticmap?center=${encodeURIComponent(
	            `${la.toFixed(1)},${lo.toFixed(1)}`
	        )}&zoom=12&size=360x220&scale=2&maptype=roadmap&markers=${marker}&key=${encodeURIComponent(this.googleApiKey)}`;
	    }

	    clearMapFallback() {
	        const mapEl = document.getElementById('map');
	        if (!mapEl || !mapEl.classList.contains('map-fallback')) return;
	        if (this.googleMap) return;
	        mapEl.classList.remove('map-fallback');
	        mapEl.innerHTML = '';
	    }

	    renderMapFallback() {
	        const mapEl = document.getElementById('map');
	        if (!mapEl) return;
	        mapEl.classList.add('map-fallback');
	        mapEl.innerHTML = '';

	        const layer = document.createElement('div');
	        layer.className = 'map-fallback-layer';

	        const label = document.createElement('div');
	        label.className = 'map-fallback-label';
	        label.textContent = 'Demo map preview';
	        layer.appendChild(label);

	        const users = this.getNearbyFilteredUsers().slice(0, 10);
	        let pinCount = 0;

	        users.forEach((user) => {
	            const coords = this.getUserApproxCoords(user);
	            if (!coords) return;
	            const x = (coords.lng + 180) / 360;
	            const y = (90 - coords.lat) / 180;
	            const clampedX = Math.min(Math.max(x, 0.04), 0.96);
	            const clampedY = Math.min(Math.max(y, 0.08), 0.92);

	            const pin = document.createElement('button');
	            pin.type = 'button';
	            pin.className = 'map-fallback-pin';
	            pin.style.left = `${(clampedX * 100).toFixed(2)}%`;
	            pin.style.top = `${(clampedY * 100).toFixed(2)}%`;
	            pin.style.setProperty('--pin-accent', user.online ? '#22c55e' : '#94a3b8');

	            const safeName = String(user.name || 'Profile');
	            pin.setAttribute('aria-label', `Open ${safeName} profile`);

	            const img = document.createElement('img');
	            img.src = user.photo;
	            img.alt = safeName;
	            pin.appendChild(img);

	            pin.addEventListener('click', () => {
	                const gallery = this.buildUserGallery(user).map(item => item.src);
	                this.openProfileModal(user, 0, gallery);
	            });

	            layer.appendChild(pin);
	            pinCount += 1;
	        });

	        if (!pinCount) {
	            const empty = document.createElement('div');
	            empty.className = 'map-fallback-empty';
	            empty.textContent = 'No demo profiles match these filters.';
	            layer.appendChild(empty);
	        }

	        mapEl.appendChild(layer);
	    }

    async initializeMap() {
        const mapEl = document.getElementById('map');
        if (!mapEl) return;
        const hasKey = Boolean(this.googleApiKey && !this.googleApiKey.includes('YOUR_GOOGLE_API_KEY'));
        if (!hasKey) {
            this.renderMapFallback();
            return;
        }
        try {
            await this.loadGoogleMaps();
        } catch (err) {
            this.renderMapFallback();
            return;
        }
        if (!window.google || !window.google.maps) {
            this.renderMapFallback();
            return;
        }
        this.clearMapFallback();
        const center = { lat: 20, lng: 0 }; // world view default
        const zoom = 2;
        if (!this.googleMap) {
            this.googleMap = new google.maps.Map(mapEl, {
                center,
                zoom,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
            });
        } else {
            this.googleMap.setCenter(center);
            this.googleMap.setZoom(zoom);
        }
        // Ensure proper sizing after becoming visible
        if (window.google && this.googleMap) {
            setTimeout(() => {
                if (google.maps.event && this.googleMap) {
                    google.maps.event.trigger(this.googleMap, 'resize');
                    this.googleMap.setCenter(center);
                }
            }, 0);
        }
        this.updateMapMarkers();
    }

    async loadGoogleMaps() {
        if (window.google && window.google.maps) return;
        if (this.googleMapsLoading) return this.googleMapsLoading;
        if (!this.googleApiKey || this.googleApiKey.includes('YOUR_GOOGLE_API_KEY')) {
            this.showNotification('Set your Google Maps API key for the map to load.');
        }
        this.googleMapsLoading = new Promise((resolve, reject) => {
            const existing = document.querySelector('script[data-hs="gmaps"]');
            if (existing) {
                existing.addEventListener('load', () => resolve());
                existing.addEventListener('error', (e) => reject(e));
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(this.googleApiKey)}&v=weekly`;
            script.async = true;
            script.defer = true;
            script.dataset.hs = 'gmaps';
            script.onload = () => resolve();
            script.onerror = (e) => reject(e);
            document.body.appendChild(script);
        });
        return this.googleMapsLoading;
    }

	    updateMapMarkers(options = {}) {
	        if (!this.googleMap || !window.google || !window.google.maps) {
	            this.renderMapFallback();
	            return;
	        }
	        // Clear existing markers
	        this.googleMapMarkers.forEach(m => m.setMap(null));
	        this.googleMapMarkers = [];

	        const mapUsers = this.getNearbyFilteredUsers();
	        const fitToResults = options.fitToResults === true || Boolean(this.nearbyCountryFilter);
	        const bounds = fitToResults ? new google.maps.LatLngBounds() : null;
	        let boundsCount = 0;
	        let lastBoundsCoords = null;

	        mapUsers.forEach(user => {
	            const coords = this.getUserApproxCoords(user);
	            if (!coords) return;
	            if (bounds) {
	                bounds.extend(coords);
	                boundsCount += 1;
	                lastBoundsCoords = coords;
	            }

	            const baseIcon = {
	                path: google.maps.SymbolPath.CIRCLE,
	                fillOpacity: 1,
                fillColor: user.online ? '#22c55e' : '#94a3b8',
                strokeOpacity: 1,
                strokeColor: '#0f172a',
                strokeWeight: 1.5,
                scale: 6
            };

            const marker = new google.maps.Marker({
                position: coords,
                map: this.googleMap,
                title: `${user.name}`,
                icon: baseIcon
            });

            if (user.online === true) {
                const halo = new google.maps.Circle({
                    map: this.googleMap,
                    center: coords,
                    radius: 120000,
                    fillColor: '#22c55e',
                    fillOpacity: 0.08,
                    strokeOpacity: 0
                });
                this.googleMapMarkers.push(halo);
            }

	            marker.addListener('click', () => {
	                const gallery = this.buildUserGallery(user).map(item => item.src);
	                this.openProfileModal(user, 0, gallery);
	            });
	            this.googleMapMarkers.push(marker);
	        });

	        if (bounds && boundsCount > 0) {
	            if (boundsCount === 1) {
	                if (lastBoundsCoords) {
	                    this.googleMap.setCenter(lastBoundsCoords);
	                    this.googleMap.setZoom(10);
	                }
	            } else {
	                this.googleMap.fitBounds(bounds, 64);
	            }
	        }
	    }

    // Profile Screen
	    loadUserProfile() {
	        document.getElementById('profile-name').textContent = this.currentUser.name;
	        document.getElementById('profile-age').textContent = `${this.currentUser.age} years old`;
	        document.getElementById('profile-photo').src = this.currentUser.photo;
	        const username = document.getElementById('profile-username');
	        if (username) username.value = this.currentUser.name || '';
	        document.getElementById('profile-bio').value = this.currentUser.bio || '';
	        const phone = document.getElementById('profile-phone');
	        if (phone) phone.value = this.currentUser.phone || '';
	        const mapVisible = document.getElementById('profile-map-visible');
	        if (mapVisible) mapVisible.checked = this.currentUser.mapVisible === true;
	        
	        this.loadInterests();
        // Initialize photo placeholders from state if present
        if (!this.currentUser.photos) this.currentUser.photos = [null, null, null];
	        for (let i = 0; i < 3; i++) this.renderPhotoSlot(i);
		        this.renderMyPosts();
	        this.updateWalletUi();
	    }

	    getWalletStorageKey() {
	        const userId = this.currentUser?.id ?? this.currentUser?.name ?? 'guest';
	        return `hs_wallet:v1:${String(userId)}`;
	    }

	    loadWallet() {
	        try {
	            const raw = localStorage.getItem(this.getWalletStorageKey());
	            const parsed = raw ? JSON.parse(raw) : null;
	            const credits = Number(parsed?.credits ?? 0);
	            const earnings = Number(parsed?.earnings ?? 0);
	            return {
	                credits: Number.isFinite(credits) ? Math.max(0, Math.floor(credits)) : 0,
	                earnings: Number.isFinite(earnings) ? Math.max(0, Math.floor(earnings)) : 0
	            };
	        } catch {
	            return { credits: 0, earnings: 0 };
	        }
	    }

	    saveWallet() {
	        try {
	            localStorage.setItem(this.getWalletStorageKey(), JSON.stringify(this.wallet || { credits: 0, earnings: 0 }));
	        } catch {}
	    }

	    updateWalletUi() {
	        const creditsEl = document.getElementById('wallet-credits');
	        const earningsEl = document.getElementById('wallet-earnings');
	        const credits = Number(this.wallet?.credits ?? 0);
	        const earnings = Number(this.wallet?.earnings ?? 0);
	        if (creditsEl) creditsEl.textContent = String(Number.isFinite(credits) ? credits : 0);
	        if (earningsEl) earningsEl.textContent = String(Number.isFinite(earnings) ? earnings : 0);
	    }

	    openAddCreditsPrompt({ suggested = 50 } = {}) {
	        const raw = window.prompt('Add credits (demo):', String(suggested));
	        if (raw == null) return;
	        const value = parseInt(String(raw).replace(/[^\d]/g, ''), 10);
	        if (!Number.isFinite(value) || value <= 0) {
	            this.showNotification('Enter a valid credit amount.', { force: true, type: 'error' });
	            return;
	        }
	        if (!this.wallet || typeof this.wallet !== 'object') this.wallet = { credits: 0, earnings: 0 };
	        this.wallet.credits = Math.max(0, (Number(this.wallet.credits) || 0) + value);
	        this.saveWallet();
	        this.updateWalletUi();
	        this.showNotification(`Added ${value} credits.`, { force: true, type: 'success' });
	        this.refreshPromotionFeeModal();
	    }

	    getPromotionFeeForPlacement(placement) {
	        const key = String(placement || '').trim().toLowerCase();
	        if (!key) return { amount: 0, kind: 'none', label: '' };
	        if (key === 'dating_featured') return { amount: this.promotionFees.featured.default, kind: 'featured', label: 'Dating featured profiles' };
	        if (key === 'premium') return { amount: this.promotionFees.featured.default, kind: 'featured', label: 'Premium offers' };
	        if (key.endsWith('_featured')) return { amount: this.promotionFees.featured.default, kind: 'featured', label: key.replace(/_featured$/, ' featured') };
	        const bannerFee = this.promotionFees.banner[key];
	        if (typeof bannerFee === 'number') return { amount: bannerFee, kind: 'banner', label: `${key} banner` };
	        return { amount: 0, kind: 'none', label: key };
	    }

		    async requirePromotionFee({ placement, title = 'Promotion fee', subtitle = '' } = {}) {
		        const modal = document.getElementById('promotion-fee-modal');
		        if (!modal) return true;
		        const restoreBtn = document.getElementById('promotion-fee-restore');
		        if (restoreBtn) restoreBtn.classList.add('hidden');
		        const { amount, kind, label } = this.getPromotionFeeForPlacement(placement);
		        if (!amount) return true;
		        return new Promise((resolve) => {
	            // cancel any existing pending payment
	            if (this.pendingPromotionFee?.resolve) {
	                try { this.pendingPromotionFee.resolve(false); } catch {}
	            }
		            this.pendingPromotionFee = {
		                amount,
		                kind,
		                placement: String(placement || ''),
		                title,
		                subtitle,
		                label,
		                resolve
		            };
		            this.refreshPromotionFeeModal();
		            modal.classList.remove('hidden');
		        });
		    }

	    refreshPromotionFeeModal() {
	        const pending = this.pendingPromotionFee;
	        const modal = document.getElementById('promotion-fee-modal');
	        if (!pending || !modal) return;
	        const titleEl = document.getElementById('promotion-fee-title');
	        const subEl = document.getElementById('promotion-fee-sub');
	        const amountEl = document.getElementById('promotion-fee-amount');
	        const creditsEl = document.getElementById('promotion-fee-credits');
	        const statusEl = document.getElementById('promotion-fee-status');
	        const payBtn = document.getElementById('promotion-fee-pay');
	        const credits = Number(this.wallet?.credits ?? 0);
	        const required = Number(pending.amount ?? 0);
	        if (titleEl) titleEl.textContent = pending.title || 'Promotion fee';
	        if (subEl) subEl.textContent = pending.subtitle || `Paid placement: ${pending.label || pending.placement}`;
	        if (amountEl) amountEl.textContent = String(required);
	        if (creditsEl) creditsEl.textContent = String(Number.isFinite(credits) ? credits : 0);
	        const canPay = Number.isFinite(credits) && credits >= required;
	        if (payBtn) payBtn.disabled = !canPay;
	        if (statusEl) {
	            statusEl.textContent = canPay
	                ? 'Ready to publish.'
	                : `You need ${Math.max(0, required - (Number.isFinite(credits) ? credits : 0))} more credits.`;
	        }
	    }

		    setupPromotionFeeModalControls() {
		        const modal = document.getElementById('promotion-fee-modal');
		        if (!modal || modal.dataset.bound) return;
		        const addBtn = document.getElementById('promotion-fee-add');
		        if (addBtn) addBtn.addEventListener('click', () => this.openAddCreditsPrompt());
		        const payBtn = document.getElementById('promotion-fee-pay');
		        if (payBtn) payBtn.addEventListener('click', () => this.payPromotionFeeAndContinue());
		        modal.dataset.bound = '1';
		    }

		    closePromotionFeeModal(paid) {
		        const modal = document.getElementById('promotion-fee-modal');
		        if (modal) modal.classList.add('hidden');
		        const restoreBtn = document.getElementById('promotion-fee-restore');
		        if (restoreBtn) restoreBtn.classList.add('hidden');
		        const pending = this.pendingPromotionFee;
		        this.pendingPromotionFee = null;
		        if (pending?.resolve) {
		            try { pending.resolve(Boolean(paid)); } catch {}
	        }
	    }

	    payPromotionFeeAndContinue() {
	        const pending = this.pendingPromotionFee;
	        if (!pending) return;
	        const required = Number(pending.amount ?? 0);
	        const credits = Number(this.wallet?.credits ?? 0);
	        if (!Number.isFinite(required) || required <= 0) {
	            this.closePromotionFeeModal(true);
	            return;
	        }
	        if (!Number.isFinite(credits) || credits < required) {
	            this.showNotification('Not enough credits to publish.', { force: true, type: 'error' });
	            this.refreshPromotionFeeModal();
	            return;
	        }
	        this.wallet.credits = credits - required;
	        this.saveWallet();
	        this.updateWalletUi();
	        this.showNotification(`Paid ${required} credits. Published.`, { force: true, type: 'success' });
	        this.closePromotionFeeModal(true);
	    }

    onPhotoSelected(e, index) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) {
            this.showNotification('Please choose an image file.');
            e.target.value = '';
            return;
        }
        const url = URL.createObjectURL(file);
        if (!this.currentUser.photos) this.currentUser.photos = [null, null, null];
        // Revoke old URL if present
        if (this.currentUser.photos[index]?.url) {
            try { URL.revokeObjectURL(this.currentUser.photos[index].url); } catch {}
        }
        this.currentUser.photos[index] = { file, url };
        this.renderPhotoSlot(index);
        this.showNotification('Photo added.');
    }

    removePhoto(index) {
        if (!this.currentUser.photos) this.currentUser.photos = [null, null, null];
        if (this.currentUser.photos[index]?.url) {
            try { URL.revokeObjectURL(this.currentUser.photos[index].url); } catch {}
        }
        this.currentUser.photos[index] = null;
        const input = document.getElementById(`photo-input-${index}`);
        if (input) input.value = '';
        this.renderPhotoSlot(index);
        this.showNotification('Photo removed.');
    }

    renderPhotoSlot(index) {
        const img = document.getElementById(`profile-photo-${index}`);
        const placeholder = document.getElementById(`photo-placeholder-${index}`);
        const removeBtn = document.getElementById(`photo-remove-${index}`);
        const state = (this.currentUser.photos && this.currentUser.photos[index]) || null;
        if (state && img && placeholder && removeBtn) {
            img.src = state.url;
            img.hidden = false;
            placeholder.style.display = 'none';
            removeBtn.disabled = false;
        } else if (img && placeholder && removeBtn) {
            img.hidden = true;
            placeholder.style.display = '';
            removeBtn.disabled = true;
        }
    }

    // Profile Video Recording (10s, one retake)
    async startVideoRecording() {
        const recordBtn = document.getElementById('record-video-btn');
        const retakeBtn = document.getElementById('retake-video-btn');
        const useBtn = document.getElementById('use-video-btn');
        const status = document.getElementById('profile-video-status');
        const preview = document.getElementById('profile-video-preview');
        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                if (status) status.textContent = 'Camera not supported in this environment.';
                return;
            }
            // Reset previous
            this.recordedChunks = [];
            this.hasRetaken = this.hasRetaken ?? false;
            this.mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            this.mediaRecorder = new MediaRecorder(this.mediaStream, { mimeType: 'video/webm;codecs=vp8,opus' });
            this.mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) this.recordedChunks.push(e.data); };
            this.mediaRecorder.onstop = () => {
                const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                if (preview) {
                    preview.src = url;
                    preview.hidden = false;
                    preview.play();
                }
                if (status) status.textContent = 'Recording complete. Review your video.';
                if (useBtn) useBtn.disabled = false;
                if (retakeBtn) retakeBtn.disabled = this.hasRetaken; // allow one retake
                // Stop camera tracks
                this.mediaStream.getTracks().forEach(t => t.stop());
                this.mediaStream = null;
            };
            this.mediaRecorder.start();
            if (status) status.textContent = 'Recording...';
            if (recordBtn) recordBtn.disabled = true;
            // Stop after 10 seconds
            setTimeout(() => {
                try { this.mediaRecorder?.stop(); } catch {}
            }, 10000);
        } catch (err) {
            if (status) status.textContent = 'Failed to start camera: ' + (err?.message || err);
        }
    }

    retakeVideo() {
        const status = document.getElementById('profile-video-status');
        const retakeBtn = document.getElementById('retake-video-btn');
        const useBtn = document.getElementById('use-video-btn');
        const preview = document.getElementById('profile-video-preview');
        if (this.hasRetaken) {
            if (status) status.textContent = 'Retake already used.';
            return;
        }
        // Revoke existing preview URL
        if (preview && preview.src) {
            try { URL.revokeObjectURL(preview.src); } catch {}
            preview.src = '';
            preview.hidden = true;
        }
        if (useBtn) useBtn.disabled = true;
        this.hasRetaken = true;
        if (retakeBtn) retakeBtn.disabled = true;
        this.startVideoRecording();
    }

    useRecordedVideo() {
        const preview = document.getElementById('profile-video-preview');
        const status = document.getElementById('profile-video-status');
        if (preview && preview.src) {
            this.currentUser.profileVideoUrl = preview.src;
            if (status) status.textContent = 'Video saved to your profile (demo).';
        }
    }

    loadInterests() {
        const interestsContainer = document.getElementById('interests-tags');
        interestsContainer.innerHTML = '';
        
        this.currentUser.interests.forEach(interest => {
            const tag = document.createElement('div');
            tag.className = 'interest-tag';
            tag.innerHTML = `
                ${interest}
                <span class="remove" onclick="app.removeInterest('${interest}')"></span>
            `;
            interestsContainer.appendChild(tag);
        });
    }

    addInterest(interest) {
        if (!interest.trim()) return;
        
        interest = interest.trim();
        if (!this.currentUser.interests.includes(interest)) {
            this.currentUser.interests.push(interest);
            this.loadInterests();
        }
        
        document.getElementById('interest-input').value = '';
    }

    removeInterest(interest) {
        this.currentUser.interests = this.currentUser.interests.filter(i => i !== interest);
        this.loadInterests();
    }

	    saveProfile() {
	        const username = document.getElementById('profile-username');
	        if (username) {
	            const nextName = (username.value || '').trim();
	            if (nextName) {
	                this.currentUser.name = nextName;
	                const parts = nextName.split(/\s+/);
	                this.currentUser.firstName = parts[0] || this.currentUser.firstName;
	                this.currentUser.lastName = parts.slice(1).join(' ') || this.currentUser.lastName;
	            }
	        }
	        this.currentUser.bio = document.getElementById('profile-bio').value;
	        const phone = document.getElementById('profile-phone');
	        if (phone) {
	            this.currentUser.phone = (phone.value || '').trim();
	            try { localStorage.setItem('hs_profile_phone', this.currentUser.phone); } catch {}
	        }
	        const mapVisible = document.getElementById('profile-map-visible');
	        if (mapVisible) {
	            this.currentUser.mapVisible = Boolean(mapVisible.checked);
	            try { localStorage.setItem('hs_map_visible', this.currentUser.mapVisible ? 'true' : 'false'); } catch {}
	        }
        this.updateMapMarkers();
        this.showNotification('Profile saved successfully!');
    }

    // Marketplace functionality
    loadMarketplace() {
        this.bindMarketplaceVehicleFeaturedCarousels();
        this.bindMarketplaceCardInteractions();
        this.applyMarketplaceFilters();
    }

    loadElectronics() {
        const root = document.getElementById('electronics-content');
        this.bindMarketplaceCardInteractions(root);
        this.bindElectronicsFilters(root);
        this.applyElectronicsFilters();
    }

    loadClothing() {
        const clothingRoot = document.getElementById('clothing-content');
        this.bindMarketplaceCardInteractions(clothingRoot);
        this.bindClothingFilters(clothingRoot);
        this.applyClothingFilters();
    }

    loadJobs() {
        const root = document.getElementById('jobs-content');
        this.bindMarketplaceCardInteractions(root);
        this.bindJobsFilters(root);
        this.applyJobsFilters();
    }

    loadMarketplaceSaved() {
        try {
            const raw = localStorage.getItem('hs_marketplace_saved');
            const list = JSON.parse(raw || '[]');
            if (!Array.isArray(list)) return new Set();
            return new Set(list.map((id) => Number(id)).filter((id) => Number.isFinite(id)));
        } catch {
            return new Set();
        }
    }

    persistMarketplaceSaved() {
        try {
            localStorage.setItem('hs_marketplace_saved', JSON.stringify(Array.from(this.marketplaceSaved || [])));
        } catch {}
    }

    isMarketplaceSaved(itemId) {
        return (this.marketplaceSaved || new Set()).has(Number(itemId));
    }

    toggleMarketplaceSaved(itemId) {
        const id = Number(itemId);
        if (!Number.isFinite(id)) return false;
        if (!this.marketplaceSaved) this.marketplaceSaved = new Set();
        if (this.marketplaceSaved.has(id)) {
            this.marketplaceSaved.delete(id);
            this.persistMarketplaceSaved();
            return false;
        }
        this.marketplaceSaved.add(id);
        this.persistMarketplaceSaved();
        return true;
    }

    handleMarketplaceMessage(itemId) {
        const id = Number(itemId);
        if (!Number.isFinite(id)) return;
        const item = (this.marketplaceItems || []).find((entry) => Number(entry.id) === id);
        if (!item) return;
        this.openMarketplaceChat(item);
    }

    loadMarketplaceRecent() {
        try {
            const raw = localStorage.getItem('hs_marketplace_recent');
            const list = JSON.parse(raw || '[]');
            if (!Array.isArray(list)) return [];
            return list.map((id) => Number(id)).filter((id) => Number.isFinite(id)).slice(0, 10);
        } catch {
            return [];
        }
    }

    recordMarketplaceRecent(itemId) {
        const id = Number(itemId);
        if (!Number.isFinite(id)) return;
        const existing = Array.isArray(this.marketplaceRecent) ? this.marketplaceRecent : [];
        const next = [id, ...existing.filter((x) => x !== id)].slice(0, 10);
        this.marketplaceRecent = next;
        try { localStorage.setItem('hs_marketplace_recent', JSON.stringify(next)); } catch {}
    }

    marketplaceCategoryLabel(category) {
        const map = {
            electronics: 'Electronics',
            clothing: 'Fashion',
            sports: 'Sports',
            home: 'Home',
            vehicles: 'Vehicles',
            services: 'Services',
            real_estate: 'Real Estate',
            jobs: 'Jobs',
            buy_sell: 'Buy & Sell',
            dating: 'Dating',
            companionship: 'Companionship',
            community: 'Community',
            other: 'Other'
        };
        return map[category] || (category ? String(category) : 'Listing');
    }

    marketplaceConditionLabel(condition) {
        const map = {
            new: 'New',
            like_new: 'Like new',
            excellent: 'Excellent',
            good: 'Good',
            fair: 'Fair',
            for_parts: 'For parts'
        };
        return map[condition] || (condition ? String(condition) : '');
    }

    marketplaceDeliveryLabel(delivery) {
        if (!delivery || !delivery.method) return '';
        const map = {
            pickup: 'Pickup',
            shipping: 'Shipping',
            local_delivery: 'Local delivery',
            digital: 'Digital',
            other: 'Delivery'
        };
        const base = map[delivery.method] || String(delivery.method);
        const fee = typeof delivery.shippingFee === 'number' && !Number.isNaN(delivery.shippingFee)
            ? delivery.shippingFee
            : null;
        if (delivery.method !== 'shipping' || fee === null) return base;
        return `${base} ($${fee.toFixed(2)})`;
    }

    getElectronicsSubcategoryLabel(key) {
        const map = {
            phones_accessories: 'Phones & Accessories',
            tv_video_home_theatre: 'TV, Video & Home Theatre',
            computers_tablets: 'Computers & Tablets',
            audio_headphones: 'Audio & Headphones',
            gaming_consoles: 'Gaming & Consoles',
            cameras_photography: 'Cameras & Photography',
            repair_parts_accessories: 'Repair, Parts & Accessories',
            other: 'Other'
        };
        return map[key] || 'Electronics';
    }

    getElectronicsSubcategory(item) {
        if (!item || item.category !== 'electronics') return '';
        return item.electronicsCategory || item.subcategory || 'other';
    }

    getElectronicsBadges(item) {
        if (!item || item.category !== 'electronics') return [];
        const raw = Array.isArray(item.electronicsBadges) ? item.electronicsBadges : [];
        return raw.map((badge) => String(badge || '').trim()).filter(Boolean).slice(0, 2);
    }

    renderMarketplaceBadges(item) {
        const badges = [];
        if (item?.category === 'electronics') {
            const extras = this.getElectronicsBadges(item);
            extras.forEach((badge) => {
                badges.push(`<span class="marketplace-badge soft">${this.escapeHtml(String(badge))}</span>`);
            });
        }
        return badges.join('');
    }

    normalizeFeaturedAdDetailValue(value) {
        return String(value || '').replace(/\|/g, ' / ').trim();
    }

    buildFeaturedAdDetailRows(item, { priceText = '', availability = '', sellerName = '', overrides = {} } = {}) {
        if (!item) return [];
        const rows = [];
        const add = (label, value) => {
            const cleaned = this.normalizeFeaturedAdDetailValue(value);
            if (!label || !cleaned) return;
            rows.push({ label, value: cleaned });
        };

        const location = overrides.location || [item.city, item.country].filter(Boolean).join(', ');
        const seller = overrides.seller || sellerName || item.seller || '';
        const categoryLabel = overrides.category || this.marketplaceCategoryLabel(item.category || '');
        const availabilityValue = overrides.availability || availability || item.availability || '';
        const conditionValue = overrides.condition || this.marketplaceConditionLabel(item.condition || '');
        const deliveryValue = overrides.delivery || this.marketplaceDeliveryLabel(item.delivery);
        const categoryKey = String(item.category || '').toLowerCase();

        if (categoryKey === 'services') {
            const service = item.service || {};
            const serviceCategoryLabel = service.category
                ? this.getServiceCategoryLabel(service.category)
                : (categoryLabel || 'Service');
            const normalizedCategory = serviceCategoryLabel === 'All services' ? 'Service' : serviceCategoryLabel;
            const serviceAvailability = service.availabilityWindow || availabilityValue || '';
            const serviceLine = service.duration || item.title || '';
            add('Category', normalizedCategory);
            add('Location', location);
            add('Provider', seller);
            add('Availability', serviceAvailability);
            add('Service', serviceLine);
            return rows;
        }

        if (categoryKey === 'real_estate') {
            const re = item.realestate || {};
            const propertyLabelMap = {
                apartment: 'Apartment',
                condo: 'Condo',
                house: 'House',
                studio: 'Studio',
                townhome: 'Townhome',
                villa: 'Villa',
                land: 'Land / Lot',
                office: 'Office',
                cowork: 'Co-working'
            };
            const listingTypeLabelMap = {
                for_rent_short: 'Short-term rental',
                for_rent_long: 'Long-term rental',
                for_sale: 'For sale',
                commercial: 'Commercial'
            };
            const propertyLabel = propertyLabelMap[re.propertyType] || '';
            const listingTypeLabel = listingTypeLabelMap[re.listingType] || '';
            const typeLabel = propertyLabel || listingTypeLabel || categoryLabel;
            const beds = Number.isFinite(re.bedrooms) ? re.bedrooms : null;
            const baths = Number.isFinite(re.bathrooms) ? re.bathrooms : null;
            const bedLine = (beds !== null || baths !== null)
                ? [beds !== null ? `${beds} bd` : '', baths !== null ? `${baths} ba` : ''].filter(Boolean).join(' 路 ')
                : '';
            const amenityParts = [];
            if (re.amenities) amenityParts.push(re.amenities);
            if (re.furnished) amenityParts.push('Furnished');
            if (re.parking) amenityParts.push('Parking');
            if (re.pets) amenityParts.push('Pet friendly');
            const amenitiesLabel = amenityParts.filter(Boolean).join(' 路 ');
            const availableOn = re.availableOn || availabilityValue || '';
            add('Type', typeLabel);
            add('Location', location);
            add('Beds', bedLine);
            add('Amenities', amenitiesLabel);
            add('Availability', availableOn);
            return rows;
        }

        if (categoryKey === 'vehicles') {
            const vehicle = item.vehicle || {};
            const vehicleCategoryMap = {
                repairs: 'Repairs',
                detailing: 'Detailing',
                rentals: 'Rentals',
                tires_rims: 'Tires & Rims',
                auto_parts: 'Auto parts',
                other: 'Vehicle'
            };
            const vehicleName = [vehicle.make, vehicle.model].filter(Boolean).join(' ');
            const vehicleType = vehicleName || vehicleCategoryMap[vehicle.category] || 'Vehicle';
            const typeLine = [vehicleType, vehicle.year].filter(Boolean).join(' ');
            const mileage = Number.isFinite(vehicle.mileage) ? vehicle.mileage : null;
            const vehicleCondition = overrides.condition
                || this.marketplaceConditionLabel(vehicle.condition || item.condition || '');
            add('Type', typeLine);
            add('Location', location);
            add('Rate', priceText);
            add('Mileage', mileage !== null ? `${mileage.toLocaleString()} mi` : '');
            add('Condition', vehicleCondition);
            add('Availability', availabilityValue);
            return rows;
        }

        add('Category', categoryLabel);
        add('Location', location);
        add('Condition', conditionValue);
        add('Delivery', deliveryValue);
        add('Seller', seller);
        add('Availability', availabilityValue);
        return rows;
    }

    buildFeaturedAdDetailsString(rows = []) {
        return rows
            .map((row) => `${row.label}:${this.normalizeFeaturedAdDetailValue(row.value)}`)
            .filter((entry) => entry !== ':')
            .join('|');
    }

    buildDataAttributesString(dataAttrs = {}) {
        return Object.entries(dataAttrs)
            .filter(([, value]) => value !== undefined && value !== null && String(value).trim() !== '')
            .map(([key, value]) => `data-${key.replace(/[A-Z]/g, (m) => `-${m.toLowerCase()}`)}="${this.escapeHtml(String(value))}"`)
            .join(' ');
    }

    buildFeaturedAdDataAttrs(item, featuredAd, { priceText = '', metaLine = '', sellerName = '' } = {}) {
        const details = featuredAd?.details || {};
        const location = details.location || [item?.city, item?.country].filter(Boolean).join(', ');
        const tags = Array.isArray(featuredAd?.tags) ? featuredAd.tags : [];
        const perks = Array.isArray(featuredAd?.perks) ? featuredAd.perks : [];
        return {
            adTitle: featuredAd?.title || item?.title || 'Featured listing',
            adPrice: featuredAd?.priceLine || priceText || '',
            adSummary: featuredAd?.metaLine || metaLine || '',
            adDesc: featuredAd?.summary || item?.description || '',
            adCategory: details.category || this.marketplaceCategoryLabel(item?.category || ''),
            adLocation: details.location || location,
            adCondition: details.condition || '',
            adDelivery: details.delivery || '',
            adSeller: details.seller || sellerName || item?.seller || '',
            adRating: details.rating || '',
            adStock: details.availability || '',
            adTier: featuredAd?.tier || 'Sponsored Showcase',
            adReason: featuredAd?.reason || '',
            adTags: tags.join('|'),
            adPerks: perks.join('|'),
            adDetails: featuredAd?.adDetails || ''
        };
    }

    buildFeaturedAdCarouselHtml(images = [], label = 'Listing') {
        const safeImages = Array.isArray(images) ? images.filter(Boolean) : [];
        const fallback = safeImages.length
            ? safeImages
            : ['https://via.placeholder.com/600x400/0b1020/f8fafc?text=Featured'];
        const safeLabel = this.escapeHtml(String(label || 'Listing'));
        const imagesHtml = fallback.map((src, idx) => `
            <img src="${this.escapeHtml(String(src))}" alt="${safeLabel} photo ${idx + 1}" loading="lazy">
        `).join('');
        return `
            <div class="image-carousel">
                <button class="carousel-btn prev" type="button" aria-label="Previous photo"><i class="fas fa-chevron-left"></i></button>
                <div class="carousel-track">
                    ${imagesHtml}
                </div>
                <button class="carousel-btn next" type="button" aria-label="Next photo"><i class="fas fa-chevron-right"></i></button>
            </div>
        `;
    }

    getFeaturedTagClass(tagText = '') {
        const normalized = String(tagText || '').toLowerCase();
        if (normalized.includes('top')) return 'tag-top';
        if (normalized.includes('new')) return 'tag-new';
        if (normalized.includes('premium')) return 'tag-premium';
        if (normalized.includes('sponsor')) return 'tag-premium';
        return '';
    }

	    insertFeaturedAdCard(item, { priceText = '', sellerName = '', sellerPhoto = '' } = {}) {
	        if (!item || !item.featuredAd || !item.featured) return;
	        const featuredAd = item.featuredAd || {};
	        const title = featuredAd.title || item.title || 'Featured listing';
	        const priceLine = featuredAd.priceLine || priceText || '';
	        const metaLine = featuredAd.metaLine || item.availability || '';
	        const images = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
	        const placementKey = String(item.placement || '').trim().toLowerCase();
	        const dataAttrs = {
	            postItemId: item.id,
	            postItemPlacement: item.placement || '',
	            ...this.buildFeaturedAdDataAttrs(item, featuredAd, { priceText, metaLine, sellerName })
	        };
	        const location = [item.city, item.country].filter(Boolean).join(', ');
		        const categoryKey = String(item.category || '').toLowerCase();
		        let container = null;
		        let cardHtml = '';

		        if (placementKey === 'marketplace_featured') {
		            container = document.querySelector('#marketplace-content .home-featured-ads .featured-ads-carousel');
		            const attrString = this.buildDataAttributesString({
		                ...dataAttrs,
		                marketplaceId: item.id,
		                adTier: featuredAd?.tier || 'Marketplace Sponsored'
		            });
	            cardHtml = `
	                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
	                    <div class="featured-ad-tag tag-premium">Sponsored</div>
	                    ${this.buildFeaturedAdCarouselHtml(images, title)}
	                    <div class="featured-ad-body">
	                        <h4>${this.escapeHtml(String(title))}</h4>
	                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
	                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
		                    </div>
		                </article>
		            `;
		        } else if (placementKey === 'home_featured') {
		            container = document.querySelector('#home-content .home-featured-ads .featured-ads-carousel');
		            const attrString = this.buildDataAttributesString(dataAttrs);
		            cardHtml = `
		                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
		                    ${this.buildFeaturedAdCarouselHtml(images, title)}
		                    <div class="featured-ad-body">
		                        <h4>${this.escapeHtml(String(title))}</h4>
		                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
		                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
		                    </div>
		                </article>
		            `;
		        } else if (placementKey === 'community_featured') {
		            container = document.querySelector('#community-content .home-featured-ads .featured-ads-carousel');
		            const attrString = this.buildDataAttributesString({
		                ...dataAttrs,
		                adTier: featuredAd?.tier || 'Community Sponsored'
		            });
		            cardHtml = `
		                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
		                    <div class="featured-ad-tag tag-premium">Sponsored</div>
		                    ${this.buildFeaturedAdCarouselHtml(images, title)}
		                    <div class="featured-ad-body">
		                        <h4>${this.escapeHtml(String(title))}</h4>
		                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
		                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
		                    </div>
		                </article>
		            `;
		        } else if (placementKey === 'services_featured') {
		            container = document.getElementById('services-featured-grid');
		            const serviceFeatured = item.service?.featured || {};
		            const tagText = serviceFeatured.tag || 'Sponsored';
		            const tagClass = this.getFeaturedTagClass(tagText);
	            const highlightLine = serviceFeatured.highlightLine || metaLine;
            const serviceAvailability = item.service?.availabilityWindow || item.availability || '';
            const serviceData = {
                serviceId: `svc-${item.id}`,
                serviceTitle: serviceFeatured.title || title,
                servicePrice: serviceFeatured.priceLine || priceLine,
                serviceLocation: location,
                serviceProvider: sellerName || item.seller || 'Service team',
                serviceRole: item.service?.role || 'Service provider',
                serviceAvatar: sellerPhoto,
                serviceDesc: item.description || '',
                serviceMeta: featuredAd.metaLine || '',
                serviceHighlights: (item.tags || []).join('|'),
                serviceAvailability: serviceAvailability ? serviceAvailability : '',
                serviceTags: [tagText, ...(item.tags || [])].filter(Boolean).join('|'),
                servicePhotos: images.join('|')
            };
            const attrString = this.buildDataAttributesString({ ...dataAttrs, ...serviceData });
            cardHtml = `
                <article class="featured-ad-card service-featured-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
                    <div class="featured-ad-tag${tagClass ? ` ${tagClass}` : ''}">${this.escapeHtml(tagText)}</div>
                    ${this.buildFeaturedAdCarouselHtml(images, title)}
                    <div class="featured-ad-body">
                        <h4>${this.escapeHtml(String(serviceFeatured.title || title))}</h4>
                        <p>${this.escapeHtml(String(serviceFeatured.priceLine || priceLine))}</p>
                        <span>${this.escapeHtml(String(highlightLine || ''))}</span>
	                    </div>
	                </article>
	            `;
	        } else if (placementKey === 'vehicles_featured') {
	            container = document.querySelector('#vehicles-content .vehicle-featured-top .featured-ads-carousel');
	            const attrString = this.buildDataAttributesString({
	                ...dataAttrs,
	                vehicleId: `veh-post-${item.id}`
            });
            cardHtml = `
                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
                    ${this.buildFeaturedAdCarouselHtml(images, title)}
                    <div class="featured-ad-body">
                        <h4>${this.escapeHtml(String(title))}</h4>
                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
	                    </div>
	                </article>
	            `;
	        } else if (placementKey === 'realestate_featured') {
	            container = document.getElementById('realestate-featured-grid');
	            const attrString = this.buildDataAttributesString({
	                ...dataAttrs,
	                realestateId: `re-post-${item.id}`
            });
            cardHtml = `
                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
                    <div class="featured-ad-tag">Sponsored</div>
                    ${this.buildFeaturedAdCarouselHtml(images, title)}
                    <div class="featured-ad-body">
                        <h4>${this.escapeHtml(String(title))}</h4>
                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
	                    </div>
	                </article>
	            `;
		        } else if (placementKey === 'companionship_featured') {
		            container = document.querySelector('#dating-content .companionship-featured-strip .featured-ads-carousel');
		            const attrString = this.buildDataAttributesString({
		                ...dataAttrs,
		                profileId: `companionship-featured-${item.id}`
	            });
	            cardHtml = `
	                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
	                    <div class="featured-ad-tag tag-premium">Featured</div>
	                    ${this.buildFeaturedAdCarouselHtml(images, title)}
	                    <div class="featured-ad-body">
	                        <h4>${this.escapeHtml(String(title))}</h4>
	                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
	                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
		                    </div>
		                </article>
		            `;
		        } else if (categoryKey === 'services') {
		            container = document.getElementById('services-featured-grid');
		            const serviceFeatured = item.service?.featured || {};
		            const tagText = serviceFeatured.tag || 'Sponsored';
		            const tagClass = this.getFeaturedTagClass(tagText);
		            const highlightLine = serviceFeatured.highlightLine || metaLine;
	            const serviceAvailability = item.service?.availabilityWindow || item.availability || '';
	            const serviceData = {
	                serviceId: `svc-${item.id}`,
	                serviceTitle: serviceFeatured.title || title,
	                servicePrice: serviceFeatured.priceLine || priceLine,
	                serviceLocation: location,
	                serviceProvider: sellerName || item.seller || 'Service team',
	                serviceRole: item.service?.role || 'Service provider',
	                serviceAvatar: sellerPhoto,
	                serviceDesc: item.description || '',
	                serviceMeta: featuredAd.metaLine || '',
	                serviceHighlights: (item.tags || []).join('|'),
	                serviceAvailability: serviceAvailability ? serviceAvailability : '',
	                serviceTags: [tagText, ...(item.tags || [])].filter(Boolean).join('|'),
	                servicePhotos: images.join('|')
	            };
	            const attrString = this.buildDataAttributesString({ ...dataAttrs, ...serviceData });
	            cardHtml = `
	                <article class="featured-ad-card service-featured-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
	                    <div class="featured-ad-tag${tagClass ? ` ${tagClass}` : ''}">${this.escapeHtml(tagText)}</div>
	                    ${this.buildFeaturedAdCarouselHtml(images, title)}
	                    <div class="featured-ad-body">
	                        <h4>${this.escapeHtml(String(serviceFeatured.title || title))}</h4>
	                        <p>${this.escapeHtml(String(serviceFeatured.priceLine || priceLine))}</p>
	                        <span>${this.escapeHtml(String(highlightLine || ''))}</span>
	                    </div>
	                </article>
	            `;
	        } else if (categoryKey === 'vehicles') {
	            container = document.querySelector('#vehicles-content .vehicle-featured-top .featured-ads-carousel');
	            const attrString = this.buildDataAttributesString({
	                ...dataAttrs,
	                vehicleId: `veh-post-${item.id}`
	            });
	            cardHtml = `
	                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
	                    ${this.buildFeaturedAdCarouselHtml(images, title)}
	                    <div class="featured-ad-body">
	                        <h4>${this.escapeHtml(String(title))}</h4>
	                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
	                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
	                    </div>
	                </article>
	            `;
	        } else if (categoryKey === 'real_estate') {
	            container = document.getElementById('realestate-featured-grid');
	            const attrString = this.buildDataAttributesString({
	                ...dataAttrs,
	                realestateId: `re-post-${item.id}`
	            });
	            cardHtml = `
	                <article class="featured-ad-card" ${attrString} role="button" tabindex="0" aria-label="View ${this.escapeHtml(String(title))}">
	                    <div class="featured-ad-tag">Sponsored</div>
	                    ${this.buildFeaturedAdCarouselHtml(images, title)}
	                    <div class="featured-ad-body">
	                        <h4>${this.escapeHtml(String(title))}</h4>
	                        <p>${this.escapeHtml(String(priceLine))}${location ? ` 路 ${this.escapeHtml(location)}` : ''}</p>
	                        <span>${this.escapeHtml(String(metaLine || ''))}</span>
	                    </div>
	                </article>
	            `;
		        }

		        if (!container || !cardHtml) return;
		        container.insertAdjacentHTML('afterbegin', cardHtml);
		        this.bindImageCarousels();
		        this.bindFeaturedAdCardLightbox();
		        if (placementKey === 'companionship_featured') {
		            this.bindDatingSponsoredProfileCards();
		        }
		    }

    marketplaceSpecsLine(item) {
        if (!item) return '';
        const parts = [];
        const vehicle = item.vehicle || {};
        const isVehicle = item.category === 'vehicles' || Boolean(vehicle.make || vehicle.model || vehicle.year);
        if (isVehicle) {
            const vehicleName = [vehicle.make, vehicle.model].filter(Boolean).join(' ');
            const vehicleCore = [vehicleName, vehicle.year].filter(Boolean).join(' ');
            if (vehicleCore) parts.push(vehicleCore);
            const mileage = typeof vehicle.mileage === 'number' && Number.isFinite(vehicle.mileage) ? vehicle.mileage : null;
            if (mileage !== null) parts.push(`${mileage.toLocaleString()} mi`);
            const transmissionMap = { automatic: 'Automatic', manual: 'Manual' };
            if (vehicle.transmission) parts.push(transmissionMap[vehicle.transmission] || String(vehicle.transmission));
            const fuelMap = { gasoline: 'Gasoline', diesel: 'Diesel', hybrid: 'Hybrid', electric: 'Electric' };
            if (vehicle.fuel) parts.push(fuelMap[vehicle.fuel] || String(vehicle.fuel));
        } else {
            if (item.brand) parts.push(String(item.brand));
            if (item.model) parts.push(String(item.model));
            if (typeof item.quantity === 'number' && Number.isFinite(item.quantity) && item.quantity > 0) {
                parts.push(`Qty ${item.quantity}`);
            }
        }

        const conditionSource = isVehicle && vehicle.condition ? vehicle.condition : item.condition;
        const condition = this.marketplaceConditionLabel(conditionSource);
        if (condition) parts.push(condition);

        const delivery = this.marketplaceDeliveryLabel(item.delivery);
        if (delivery) parts.push(delivery);

        return parts.filter(Boolean).join('  ');
    }

    getInitials(name) {
        const parts = String(name || '')
            .trim()
            .split(/\s+/)
            .filter(Boolean)
            .slice(0, 2);
        if (!parts.length) return '';
        return parts.map(p => p[0].toUpperCase()).join('');
    }

    renderMarketplaceCard(item, { compact = false, disableCarousel = false } = {}) {
        const images = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
        const imagesAttr = images.map(src => encodeURIComponent(src)).join('|');
        const firstImage = images[0] || 'https://via.placeholder.com/900x650/ebeef5/111827?text=Listing';
        const title = this.escapeHtml(String(item.title || 'Listing'));
        const city = this.escapeHtml(String(item.city || ''));
        const seller = this.escapeHtml(String(item.seller || 'Seller'));
        const initials = this.getInitials(item.seller || 'Seller') || '';
        const saved = this.isMarketplaceSaved(item.id);
        const verified = Number(item.id) % 2 === 1;
        const rating = (4.7 + (Number(item.id) % 3) * 0.1).toFixed(1);
        const dateLabel = this.formatDate(item.postedDate);
        const specs = this.marketplaceSpecsLine(item);
        const specsHtml = specs ? `<div class="seller-sub"><span class="item-location">${this.escapeHtml(specs)}</span></div>` : '';
        const rawDescription = String(item.description || item.summary || '').trim();
        const descText = rawDescription ? this.truncateText(rawDescription, compact ? 90 : 120) : '';
        const descHtml = descText ? `<p class="item-desc${compact ? ' compact' : ''}">${this.escapeHtml(descText)}</p>` : '';
        const categoryLabel = this.escapeHtml(this.marketplaceCategoryLabel(item?.category));

        const classes = ['marketplace-item', compact ? 'compact' : ''].filter(Boolean).join(' ');
        const disableAttr = disableCarousel ? ' data-disable-carousel="1"' : '';
        return `
	            <div class="${classes}" data-id="${item.id}" data-images="${imagesAttr}"${disableAttr} role="button" tabindex="0" aria-label="Open ${title}">
	                <div class="marketplace-item-media" data-photo-index="0">
	                    <img src="${firstImage}" alt="${title}" class="item-image" loading="lazy" decoding="async">
                        <div class="marketplace-media-badges" aria-hidden="true"></div>
                        <div class="marketplace-category-label" aria-hidden="true">
                            <i class="fas fa-tag" aria-hidden="true"></i>
                            <span>${categoryLabel}</span>
                        </div>
	                </div>
	                <div class="item-info">
	                    <div class="marketplace-title-row">
	                        <h4 class="item-title">${title}</h4>
	                        <button class="marketplace-save-btn ${saved ? 'saved' : ''}" type="button" aria-pressed="${saved ? 'true' : 'false'}" aria-label="${saved ? 'Unsave listing' : 'Save listing'}">
	                            <i class="fas fa-bookmark" aria-hidden="true"></i>
	                        </button>
	                    </div>
                    <div class="marketplace-sub-row">
                        <div class="item-price">$${this.escapeHtml(String(item.price ?? ''))}</div>
                        <div class="item-date">${this.escapeHtml(dateLabel)}</div>
                    </div>
                    ${descHtml}
                    <div class="marketplace-card-actions">
                        <button class="marketplace-offer-btn" type="button" aria-label="Send a message about ${title}">
                            <i class="fas fa-handshake" aria-hidden="true"></i>
                            Send a message
                        </button>
                        </div>
	                    ${specsHtml}
                    <button class="marketplace-seller-row seller-profile-link" type="button" data-seller-id="${this.escapeHtml(String(item.id))}" aria-label="View seller profile for ${seller}">
                        <div class="seller-avatar" aria-hidden="true">${this.escapeHtml(initials)}</div>
                        <div class="seller-meta">
                            <div class="seller-name">${seller}${verified ? ' <span class="seller-verified">Verified</span>' : ''}</div>
                            <div class="seller-sub">
                                <span class="item-location">${city}</span>
                                <span class="seller-rating"><i class="fas fa-star" aria-hidden="true"></i> ${rating}</span>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        `;
    }

    renderMarketplaceFeedCard(item) {
        if (item?.category === 'jobs') {
            return this.renderJobsFeedCard(item);
        }
        const images = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
        const imagesAttr = images.map(src => encodeURIComponent(src)).join('|');
        const firstImage = images[0] || 'https://via.placeholder.com/900x650/ebeef5/111827?text=Listing';
        const title = this.escapeHtml(String(item.title || 'Listing'));
        const city = this.escapeHtml(String(item.city || ''));
        const seller = this.escapeHtml(String(item.seller || 'Seller'));
        const sellerIdAttr = this.escapeHtml(String(item.id));
        const saved = this.isMarketplaceSaved(item.id);
        const verified = Number(item.id) % 2 === 1;
        const rating = (4.7 + (Number(item.id) % 3) * 0.1).toFixed(1);
        const dateLabel = this.formatDate(item.postedDate);
        const specs = this.marketplaceSpecsLine(item);
        const specsHtml = specs ? `<div class="dating-feed-status">${this.escapeHtml(specs)}</div>` : '';
        const categoryLabel = this.escapeHtml(this.marketplaceCategoryLabel(item?.category));

	        return `
	            <div class="dating-feed-card vehicle-feed-card marketplace-feed-card marketplace-item" data-id="${item.id}" data-images="${imagesAttr}" role="button" tabindex="0" aria-label="Open ${title}">
	                <div class="vehicle-card-carousel marketplace-item-media" data-photo-index="0">
	                    <img src="${firstImage}" alt="${title}" class="item-image" loading="lazy" decoding="async">
                        <div class="marketplace-media-badges" aria-hidden="true"></div>
                        <div class="marketplace-category-label" aria-hidden="true">
                            <i class="fas fa-tag" aria-hidden="true"></i>
                            <span>${categoryLabel}</span>
                        </div>
	                </div>
	                <div class="dating-feed-meta">
	                    <div class="dating-feed-name">${title}</div>
                    <div class="dating-feed-location">$${this.escapeHtml(String(item.price ?? ''))} 路 ${city}</div>
                    ${specsHtml}
                    <div class="dating-feed-status ${verified ? 'online' : 'offline'}">By <button class="seller-name-link" type="button" data-seller-source="marketplace" data-seller-id="${sellerIdAttr}" aria-label="View seller profile for ${seller}">${seller}</button> 路 <i class="fas fa-star" aria-hidden="true" style="color:#facc15;margin:0 0.25rem 0 0.35rem;"></i>${rating} 路 ${this.escapeHtml(String(dateLabel))}</div>
                </div>
                <div class="marketplace-feed-actions">
                    <button class="marketplace-offer-btn" type="button" aria-label="Send a message about ${title}">
                        <i class="fas fa-handshake" aria-hidden="true"></i>
                        Send a message
                    </button>
                    <button class="marketplace-save-btn ${saved ? 'saved' : ''}" type="button" aria-pressed="${saved ? 'true' : 'false'}" aria-label="${saved ? 'Unsave listing' : 'Save listing'}">
                        <i class="fas fa-bookmark" aria-hidden="true"></i>
                    </button>
                    <button class="seller-profile-btn" type="button" data-seller-id="${this.escapeHtml(String(item.id))}" aria-label="View seller profile for ${seller}">
                        <i class="fas fa-user" aria-hidden="true"></i>
                        Seller
                    </button>
                    <span class="dating-feed-action">View</span>
                </div>
            </div>
        `;
    }

    renderJobsFeedCard(item) {
        const title = this.escapeHtml(String(item.title || 'Role'));
        const company = this.escapeHtml(String(item.seller || 'Company'));
        const categoryLabel = this.getJobsCategoryLabel(item.jobCategory) || 'Job';
        const locationLabel = this.escapeHtml(this.getJobLocationLabel(item));
        const typeLabel = this.getJobTypeLabel(item.employmentType);
        const experienceLabel = this.getJobExperienceLabel(item.experienceLevel);
        const payLabel = this.escapeHtml(this.getJobPayLabel(item));
        const postedLabel = this.formatRelativeTime(this.normalizeActivityDate(item.postedDate) || new Date());
        const statusLabel = this.escapeHtml(this.getJobStatusLabel(item));
        const saved = this.isMarketplaceSaved(item.id);
        const summaryText = this.truncateText(String(item.description || ''), 140);
        const tags = Array.isArray(item.tags) ? item.tags.slice(0, 4) : [];
        const tagsHtml = tags.length
            ? `<div class="jobs-card-tags">${tags.map((tag) => `<span>${this.escapeHtml(String(tag))}</span>`).join('')}</div>`
            : '';
        const logo = item.companyLogo
            ? `<img src="${this.escapeHtml(item.companyLogo)}" alt="${company} logo" loading="lazy">`
            : this.escapeHtml(this.getInitials(company) || '');

        return `
            <div class="jobs-card marketplace-item" data-id="${item.id}" role="button" tabindex="0" aria-label="Open ${title}">
                <div class="jobs-card-top">
                    <div class="jobs-card-brand">
                        <div class="jobs-logo">${logo}</div>
                        <div>
                            <div class="jobs-role">${title}</div>
                            <div class="jobs-company">${company} 路 ${this.escapeHtml(categoryLabel)}</div>
                            <div class="jobs-location">${locationLabel}</div>
                        </div>
                    </div>
                    <span class="jobs-status-pill">${statusLabel}</span>
                </div>
                <div class="jobs-card-meta">
                    <span>${payLabel}</span>
                    <span>${this.escapeHtml(typeLabel)}</span>
                    <span>${this.escapeHtml(experienceLabel)}</span>
                </div>
                <p class="jobs-summary">${this.escapeHtml(summaryText)}</p>
                ${tagsHtml}
                <div class="jobs-card-footer">
                    <span class="jobs-posted">Posted ${this.escapeHtml(postedLabel)}</span>
                    <div class="jobs-card-actions">
                        <button class="marketplace-offer-btn" type="button" aria-label="Apply for ${title}">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                            Apply now
                        </button>
                        <button class="marketplace-save-btn ${saved ? 'saved' : ''}" type="button" aria-pressed="${saved ? 'true' : 'false'}" aria-label="${saved ? 'Unsave listing' : 'Save listing'}">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    bindMarketplaceCardInteractions(root = document.getElementById('marketplace-content')) {
        if (!root || root.dataset.boundMarketplaceCards) return;

        const handleOpen = (itemEl) => {
            const itemId = parseInt(itemEl?.dataset?.id || '', 10);
            if (!Number.isFinite(itemId)) return;
            this.showItemDetails(itemId);
        };

        root.addEventListener('click', (e) => {
            const sellerBtn = e.target.closest('.seller-profile-btn, .seller-profile-link, .seller-name-link');
            if (sellerBtn) {
                e.stopPropagation();
                const itemEl = sellerBtn.closest('.marketplace-item');
                const itemId = parseInt(sellerBtn.dataset.sellerId || itemEl?.dataset?.id || '', 10);
                if (!Number.isFinite(itemId)) return;
                this.openSellerProfileFromItem(itemId);
                return;
            }
            const saveBtn = e.target.closest('.marketplace-save-btn');
            if (saveBtn) {
                e.stopPropagation();
                const itemEl = saveBtn.closest('.marketplace-item');
                const itemId = parseInt(itemEl?.dataset?.id || '', 10);
                if (!Number.isFinite(itemId)) return;
                const saved = this.toggleMarketplaceSaved(itemId);
                saveBtn.classList.toggle('saved', saved);
                saveBtn.setAttribute('aria-pressed', saved ? 'true' : 'false');
                saveBtn.setAttribute('aria-label', saved ? 'Unsave listing' : 'Save listing');
                if (saved) {
                    const item = (this.marketplaceItems || []).find((entry) => Number(entry.id) === itemId);
                    const title = item?.title || 'Listing';
                    this.addNotification({
                        title: 'Saved listing',
                        message: `Saved ${title} for later.`,
                        type: 'marketplace'
                    });
                }
                return;
            }
            const offerBtn = e.target.closest('.marketplace-offer-btn');
            if (offerBtn) {
                e.stopPropagation();
                const itemEl = offerBtn.closest('.marketplace-item');
                const itemId = parseInt(itemEl?.dataset?.id || '', 10);
                if (!Number.isFinite(itemId)) return;
            this.handleMarketplaceMessage(itemId);
            return;
            }
            const itemEl = e.target.closest('.marketplace-item');
            if (!itemEl) return;
            if (e.target.closest('.marketplace-item-media')) return;
            handleOpen(itemEl);
        });

        root.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            const sellerBtn = e.target.closest('.seller-profile-btn, .seller-profile-link, .seller-name-link');
            if (sellerBtn) {
                e.preventDefault();
                const itemEl = sellerBtn.closest('.marketplace-item');
                const itemId = parseInt(sellerBtn.dataset.sellerId || itemEl?.dataset?.id || '', 10);
                if (!Number.isFinite(itemId)) return;
                this.openSellerProfileFromItem(itemId);
                return;
            }
            const itemEl = e.target.closest('.marketplace-item');
            if (!itemEl) return;
            if (e.target.closest('.marketplace-save-btn')) return;
            e.preventDefault();
            handleOpen(itemEl);
        });

        root.dataset.boundMarketplaceCards = '1';
    }

    renderMarketplaceSections(pool = null) {
        const sections = document.getElementById('marketplace-sections');
        if (!sections) return;
        const trendingEl = document.getElementById('marketplace-trending');
        const recommendedEl = document.getElementById('marketplace-recommended');
        const recentSection = document.getElementById('marketplace-recent-section');
        const recentEl = document.getElementById('marketplace-recent');
        if (!trendingEl || !recommendedEl || !recentSection || !recentEl) return;

        const allItems = this.marketplaceItems || [];
        const source = Array.isArray(pool) ? pool : allItems;
        const byId = new Map(allItems.map((entry) => [Number(entry.id), entry]));
        const poolIds = Array.isArray(pool) ? new Set(source.map((entry) => Number(entry.id))) : null;

        const sortByDateDesc = (arr) => arr.slice().sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
        const sorted = sortByDateDesc(source);
        const sortedAll = sortByDateDesc(allItems);

        const pickUnique = (primary, fallback, max, exclude = new Set()) => {
            const out = [];
            const seen = new Set(exclude);
            const addFrom = (list) => {
                for (const entry of list) {
                    const id = Number(entry?.id);
                    if (!Number.isFinite(id) || seen.has(id)) continue;
                    out.push(entry);
                    seen.add(id);
                    if (out.length >= max) break;
                }
            };
            addFrom(primary);
            if (out.length < max) addFrom(fallback);
            return out;
        };

        const trending = pickUnique(sorted, sortedAll, 8);
        const trendingIds = new Set(trending.map((entry) => Number(entry.id)));

        const seedId = (Array.isArray(this.marketplaceRecent) && this.marketplaceRecent.length)
            ? this.marketplaceRecent[0]
            : null;
        const seedItem = seedId ? byId.get(Number(seedId)) : null;
        const seedCategory = seedItem?.category || null;
        const recommendedPrimary = seedCategory
            ? sortedAll.filter(entry => entry.category === seedCategory)
            : sortedAll;
        const recommended = pickUnique(
            recommendedPrimary.filter(entry => !trendingIds.has(Number(entry.id))),
            sortedAll,
            8,
            trendingIds
        );
        const resolvedRecommended = recommended.length ? recommended : trending.slice(0, 8);

        const recent = (Array.isArray(this.marketplaceRecent) ? this.marketplaceRecent : [])
            .map((id) => byId.get(Number(id)))
            .filter(Boolean)
            .filter((entry) => !poolIds || poolIds.has(Number(entry.id)))
            .slice(0, 10);

        trendingEl.innerHTML = trending.map(entry => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true })).join('');
        recommendedEl.innerHTML = resolvedRecommended.map(entry => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true })).join('');

        if (recent.length) {
            recentSection.classList.remove('hidden');
            recentEl.innerHTML = recent.map(entry => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true })).join('');
        } else {
            recentSection.classList.add('hidden');
            recentEl.innerHTML = '';
        }
    }

    bindMarketplaceVehicleFeaturedCarousels() {
        const cards = Array.from(document.querySelectorAll('.vehicle-featured-top .featured-ad-card.vehicle-featured-static'));
        if (!cards.length) return;

        cards.forEach(card => {
            if (card.dataset.boundVehicleFeaturedCarousel) return;
            const media = card.querySelector('.vehicle-featured-media');
            if (!media) return;
            if (media.querySelector('.carousel-track')) {
                card.dataset.boundVehicleFeaturedCarousel = '1';
                return;
            }

            const dataPhotos = (card.dataset.photos || '')
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
            const fallbackSrc = media.querySelector('img')?.getAttribute('src') || '';
            const photos = dataPhotos.length ? dataPhotos : (fallbackSrc ? [fallbackSrc] : []);
            if (photos.length <= 1) {
                card.dataset.boundVehicleFeaturedCarousel = '1';
                return;
            }

            const title = card.querySelector('.featured-ad-body h4')?.textContent?.trim() || 'Vehicle photo';
            const fallbackAlt = media.querySelector('img')?.getAttribute('alt') || title;
            const initialIndex = Math.max(0, Math.min(parseInt(media.dataset.photoIndex || '0', 10) || 0, photos.length - 1));

            media.classList.add('image-carousel');
            // Prevent bindImageCarousels() from attaching its own handlers (it opens lightbox on image click).
            media.dataset.bound = '1';

            const prev = document.createElement('button');
            prev.type = 'button';
            prev.className = 'carousel-btn prev';
            prev.setAttribute('aria-label', 'Previous photo');
            prev.innerHTML = '<i class="fas fa-chevron-left" aria-hidden="true"></i>';

            const next = document.createElement('button');
            next.type = 'button';
            next.className = 'carousel-btn next';
            next.setAttribute('aria-label', 'Next photo');
            next.innerHTML = '<i class="fas fa-chevron-right" aria-hidden="true"></i>';

            const track = document.createElement('div');
            track.className = 'carousel-track';
            photos.forEach((src, idx) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = fallbackAlt;
                img.loading = 'lazy';
                img.decoding = 'async';
                img.draggable = false;
                img.dataset.index = String(idx);
                track.appendChild(img);
            });

            const scrollBy = (dir) => {
                track.scrollBy({ left: dir * track.clientWidth, behavior: 'smooth' });
            };
            prev.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollBy(-1);
            });
            next.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollBy(1);
            });

            track.addEventListener('pointerdown', (e) => e.stopPropagation());
            track.addEventListener('click', (e) => e.stopPropagation());

            media.textContent = '';
            media.appendChild(prev);
            media.appendChild(track);
            media.appendChild(next);

            window.requestAnimationFrame(() => {
                track.scrollTo({ left: initialIndex * track.clientWidth });
                media.dataset.photoIndex = String(initialIndex);
            });

            card.dataset.boundVehicleFeaturedCarousel = '1';
        });
    }

    applyMarketplaceFilters() {
        const rawSearch = document.getElementById('market-search')?.value || '';
        const searchNormalized = this.normalizeSearchText(rawSearch);
        const stopwords = new Set([
            'a', 'an', 'and', 'are', 'as', 'at', 'be', 'by', 'for', 'from', 'i', 'in', 'is', 'it', 'me', 'my',
            'near', 'of', 'on', 'or', 'show', 'the', 'this', 'to', 'under', 'up', 'with', 'you', 'your'
        ]);
        const searchTokens = searchNormalized
            ? searchNormalized
                .split(' ')
                .map((t) => t.trim())
                .filter(Boolean)
                .filter((t) => !stopwords.has(t))
                .filter((t) => !/^\d+$/.test(t))
            : [];
        const synonymMap = {
            shoes: ['shoes', 'shoe', 'sneakers', 'sneaker', 'footwear', 'kicks', 'slides', 'boots'],
            shoe: ['shoes', 'shoe', 'sneakers', 'sneaker', 'footwear', 'kicks', 'slides', 'boots'],
            sneakers: ['sneakers', 'sneaker', 'shoes', 'shoe', 'footwear', 'kicks'],
            sneaker: ['sneakers', 'sneaker', 'shoes', 'shoe', 'footwear', 'kicks'],
            cars: ['cars', 'car', 'vehicle', 'vehicles', 'auto', 'automobile'],
            car: ['cars', 'car', 'vehicle', 'vehicles', 'auto', 'automobile'],
            vehicles: ['vehicles', 'vehicle', 'cars', 'car', 'auto', 'automobile'],
            vehicle: ['vehicles', 'vehicle', 'cars', 'car', 'auto', 'automobile'],
            bike: ['bike', 'bikes', 'bicycle', 'bicycles'],
            bicycles: ['bike', 'bikes', 'bicycle', 'bicycles'],
            bicycle: ['bike', 'bikes', 'bicycle', 'bicycles']
        };
        const tokenMatches = (token, haystack) => {
            const t = String(token || '').trim().toLowerCase();
            if (!t) return true;
            const alts = synonymMap[t] || (t.endsWith('s') && synonymMap[t.slice(0, -1)]) || [t];
            return alts.some((alt) => alt && haystack.includes(alt));
        };

        const categoryFilter = document.getElementById('category-filter')?.value || '';
        const countryFilter = document.getElementById('country-filter')?.value.toLowerCase() || '';
        const cityFilter = document.getElementById('city-filter')?.value.toLowerCase() || '';
        const priceMinValue = parseFloat(document.getElementById('price-filter-min')?.value);
        const priceMaxValue = parseFloat(document.getElementById('price-filter-max')?.value);
        const hasPriceMin = Number.isFinite(priceMinValue);
        const hasPriceMax = Number.isFinite(priceMaxValue);
        const dateFilter = document.getElementById('date-filter')?.value || 'today';

        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);
        const monthAgo = new Date(today); monthAgo.setMonth(today.getMonth() - 1);

        const source = Array.isArray(this.marketplaceItems) ? this.marketplaceItems : [];
        this.filteredItems = source.filter(item => {
            // Category filter
            if (categoryFilter && item.category !== categoryFilter) return false;
            
                const itemCountry = (item.country || '').toLowerCase();
                const itemCity = (item.city || '').toLowerCase();
                if (countryFilter && !itemCountry.includes(countryFilter)) return false;
                if (cityFilter && !itemCity.includes(cityFilter)) return false;
            
            // Price filter
            const rawItemPrice = item?.price;
            const itemPrice = Number.isFinite(rawItemPrice)
                ? rawItemPrice
                : parseFloat(String(rawItemPrice || '').replace(/[^0-9.]/g, ''));
            if ((hasPriceMin || hasPriceMax) && !Number.isFinite(itemPrice)) return false;
            if (hasPriceMin && itemPrice < priceMinValue) return false;
            if (hasPriceMax && itemPrice > priceMaxValue) return false;

            // Keyword search
            if (searchTokens.length) {
                const haystack = this.normalizeSearchText([
                    item.title,
                    item.description,
                    item.seller,
                    item.city,
                    item.country,
                    item.category,
                    item.condition,
                    item.availability,
                    item.delivery,
                    item.paymentMethod,
                    ...(Array.isArray(item.tags) ? item.tags : [])
                ].filter(Boolean).join(' '));
                if (!haystack) return false;
                const matches = searchTokens.every((t) => tokenMatches(t, haystack));
                if (!matches) return false;
            }
            
            // Date filter
            const itemDate = new Date(item.postedDate);
            switch (dateFilter) {
                case 'today':
                    if (itemDate < today) return false;
                    break;
                case 'week':
                    if (itemDate < weekAgo) return false;
                    break;
                case 'month':
                    if (itemDate < monthAgo) return false;
                    break;
                // 'all' shows everything
            }
            
            return true;
        });

        this.renderMarketplaceItems();
        this.renderMarketplaceSections(this.filteredItems);
    }

    normalizeSearchText(value) {
        return String(value || '')
            .toLowerCase()
            .replace(/[\u2018\u2019'"]/g, '')
            .replace(/[^a-z0-9]+/g, ' ')
            .trim()
            .replace(/\s+/g, ' ');
    }

    escapeRegex(value) {
        return String(value || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    setMarketplaceAdvancedFiltersExpanded(expanded) {
        const advancedToggle = document.getElementById('market-advanced-toggle');
        const advancedPanel = document.getElementById('market-advanced-filters');
        if (!advancedToggle || !advancedPanel) return;
        const showText = advancedToggle.dataset.showText || 'More filters';
        const hideText = advancedToggle.dataset.hideText || 'Hide filters';
        advancedToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        advancedPanel.setAttribute('aria-hidden', expanded ? 'false' : 'true');
        advancedPanel.classList.toggle('hidden', !expanded);
        advancedToggle.textContent = expanded ? hideText : showText;
    }

    interpretMarketplaceSearchQuery(rawQuery = '') {
        const raw = String(rawQuery || '').trim();
        const normalized = this.normalizeSearchText(raw);
        const lowerRaw = raw.toLowerCase();

        if (!normalized) {
            return { term: '', category: '', city: '', country: '', priceMin: null, priceMax: null, dateFilter: '' };
        }

        let dateFilter = '';
        if (/\b(all time|anytime|all listings|all)\b/.test(lowerRaw)) dateFilter = 'all';
        else if (/\b(today|tonight)\b/.test(lowerRaw)) dateFilter = 'today';
        else if (/\b(this week|past week|last week|last 7 days|past 7 days|7 days|week)\b/.test(lowerRaw)) dateFilter = 'week';
        else if (/\b(this month|past month|last month|past 30 days|30 days|month)\b/.test(lowerRaw)) dateFilter = 'month';

        const parseNumber = (value) => {
            const next = Number(String(value || '').replace(/,/g, ''));
            return Number.isFinite(next) ? next : null;
        };

        let priceMin = null;
        let priceMax = null;

        const rangeMatch = lowerRaw.match(/\b(?:between|from)\s*\$?(\d[\d,]*)\s*(?:and|to|-)\s*\$?(\d[\d,]*)\b/);
        if (rangeMatch) {
            const a = parseNumber(rangeMatch[1]);
            const b = parseNumber(rangeMatch[2]);
            if (a !== null && b !== null) {
                priceMin = Math.min(a, b);
                priceMax = Math.max(a, b);
            }
        } else {
            const dashMatch = lowerRaw.match(/\b\$?(\d[\d,]*)\s*-\s*\$?(\d[\d,]*)\b/);
            if (dashMatch) {
                const a = parseNumber(dashMatch[1]);
                const b = parseNumber(dashMatch[2]);
                if (a !== null && b !== null) {
                    priceMin = Math.min(a, b);
                    priceMax = Math.max(a, b);
                }
            }
            const maxMatch = lowerRaw.match(/\b(?:under|below|less than|up to|max(?:imum)?)\s*\$?(\d[\d,]*)\b/);
            if (maxMatch) priceMax = parseNumber(maxMatch[1]);
            const minMatch = lowerRaw.match(/\b(?:over|above|more than|at least|min(?:imum)?)\s*\$?(\d[\d,]*)\b/);
            if (minMatch) priceMin = parseNumber(minMatch[1]);
        }

        const items = Array.isArray(this.marketplaceItems) ? this.marketplaceItems : [];
        const cities = Array.from(new Set(items.map((i) => String(i?.city || '').trim()).filter(Boolean)));
        const countries = Array.from(new Set(items.map((i) => String(i?.country || '').trim()).filter(Boolean)));

        const findBestMatch = (candidates) => {
            const scored = candidates
                .map((value) => ({ value, key: this.normalizeSearchText(value) }))
                .filter((entry) => entry.key)
                .sort((a, b) => b.key.length - a.key.length);
            for (const entry of scored) {
                const pattern = new RegExp(`(^|\\s)${this.escapeRegex(entry.key)}(\\s|$)`, 'i');
                if (pattern.test(normalized)) return entry.value;
            }
            return '';
        };

        const city = findBestMatch(cities);
        const country = findBestMatch(countries);

        const categoryHints = {
            electronics: ['iphone', 'phone', 'laptop', 'macbook', 'ipad', 'tablet', 'camera', 'headphones', 'tv', 'monitor', 'console', 'playstation', 'xbox', 'nintendo'],
            clothing: ['shoes', 'sneakers', 'jacket', 'coat', 'dress', 'jeans', 'hoodie', 'boots'],
            sports: ['bike', 'bicycle', 'treadmill', 'weights', 'dumbbell', 'kayak', 'golf', 'ski', 'snowboard'],
            home: ['couch', 'sofa', 'table', 'chair', 'bed', 'dresser', 'lamp', 'rug', 'desk'],
            vehicles: ['car', 'truck', 'suv', 'sedan', 'vehicle', 'motorcycle', 'scooter'],
            services: ['service', 'cleaning', 'tutor', 'plumber', 'landscaping', 'repair', 'photography', 'design'],
            real_estate: ['apartment', 'condo', 'house', 'rent', 'lease', 'room', 'real estate', 'realestate'],
            jobs: ['job', 'jobs', 'hiring', 'role', 'position', 'resume', 'interview'],
            buy_sell: ['buy', 'sell', 'sale', 'for sale'],
            community: ['meetup', 'event', 'class', 'group'],
            dating: ['date', 'dating', 'match']
        };

        let category = '';
        let bestScore = 0;
        Object.entries(categoryHints).forEach(([key, keywords]) => {
            const score = keywords.reduce((acc, kw) => acc + (normalized.includes(this.normalizeSearchText(kw)) ? 1 : 0), 0);
            if (score > bestScore) {
                bestScore = score;
                category = key;
            }
        });
        if (bestScore === 0) category = '';

        let cleaned = normalized;
        const removeWholeWord = (word) => {
            if (!word) return;
            const key = this.normalizeSearchText(word);
            if (!key) return;
            cleaned = cleaned.replace(new RegExp(`(^|\\s)${this.escapeRegex(key)}(\\s|$)`, 'g'), ' ');
        };
        removeWholeWord(city);
        removeWholeWord(country);
        cleaned = cleaned
            .replace(/\b\d+\b/g, ' ')
            .replace(/\b(today|tonight|week|month|all|anytime|time)\b/g, ' ')
            .replace(/\b(under|below|less|than|up|to|max|over|above|more|at|least|min|between|from|and|in|near|around|with|for)\b/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const cleanedTokens = cleaned
            ? cleaned.split(' ').filter(Boolean).filter((t) => t.length > 1).slice(0, 6)
            : [];

        return {
            term: cleanedTokens.join(' '),
            category,
            city,
            country,
            priceMin,
            priceMax,
            dateFilter
        };
    }

    applyMarketplaceAiSearch() {
        const input = document.getElementById('market-search');
        if (!input) return;
        const raw = String(input.value || '').trim();
        if (!raw) {
            this.showNotification('Type a search like bike in Oakland under $500, then tap AI.');
            return;
        }

        const interpreted = this.interpretMarketplaceSearchQuery(raw);
        const updates = [];

        const categoryEl = document.getElementById('category-filter');
        if (categoryEl && interpreted.category && categoryEl.value !== interpreted.category) {
            categoryEl.value = interpreted.category;
            updates.push('category');
        }
        const dateEl = document.getElementById('date-filter');
        if (dateEl && interpreted.dateFilter && dateEl.value !== interpreted.dateFilter) {
            dateEl.value = interpreted.dateFilter;
            updates.push('date');
        }
        const minEl = document.getElementById('price-filter-min');
        if (minEl && interpreted.priceMin !== null) {
            minEl.value = String(interpreted.priceMin);
            updates.push('min');
        }
        const maxEl = document.getElementById('price-filter-max');
        if (maxEl && interpreted.priceMax !== null) {
            maxEl.value = String(interpreted.priceMax);
            updates.push('max');
        }
        const countryEl = document.getElementById('country-filter');
        const cityEl = document.getElementById('city-filter');
        const setLocation = Boolean(interpreted.country || interpreted.city);
        if (setLocation) this.setMarketplaceAdvancedFiltersExpanded(true);
        if (countryEl && interpreted.country) {
            countryEl.value = interpreted.country;
            updates.push('country');
        }
        if (cityEl && interpreted.city) {
            cityEl.value = interpreted.city;
            updates.push('city');
        }

        if (interpreted.term) {
            input.value = interpreted.term;
        }

        this.applyMarketplaceFilters();
        this.showNotification(updates.length ? 'AI applied filters.' : 'AI search applied.');
    }

    interpretHomeSearchQuery(rawQuery = '') {
        const raw = String(rawQuery || '').trim();
        const normalized = this.normalizeSearchText(raw);
        const lowerRaw = raw.toLowerCase();

        if (!normalized) {
            return { term: '', category: '', city: '', country: '', priceMin: null, priceMax: null, dateFilter: '' };
        }

        let dateFilter = '';
        if (/\b(all time|anytime|all listings|all)\b/.test(lowerRaw)) dateFilter = 'all';
        else if (/\b(today|tonight)\b/.test(lowerRaw)) dateFilter = 'today';
        else if (/\b(this week|past week|last week|last 7 days|past 7 days|7 days|week)\b/.test(lowerRaw)) dateFilter = 'week';
        else if (/\b(this month|past month|last month|past 30 days|30 days|month)\b/.test(lowerRaw)) dateFilter = 'month';

        const parseNumber = (value) => {
            const next = Number(String(value || '').replace(/,/g, ''));
            return Number.isFinite(next) ? next : null;
        };

        let priceMin = null;
        let priceMax = null;

        const rangeMatch = lowerRaw.match(/\b(?:between|from)\s*\$?(\d[\d,]*)\s*(?:and|to|-)\s*\$?(\d[\d,]*)\b/);
        if (rangeMatch) {
            const a = parseNumber(rangeMatch[1]);
            const b = parseNumber(rangeMatch[2]);
            if (a !== null && b !== null) {
                priceMin = Math.min(a, b);
                priceMax = Math.max(a, b);
            }
        } else {
            const dashMatch = lowerRaw.match(/\b\$?(\d[\d,]*)\s*-\s*\$?(\d[\d,]*)\b/);
            if (dashMatch) {
                const a = parseNumber(dashMatch[1]);
                const b = parseNumber(dashMatch[2]);
                if (a !== null && b !== null) {
                    priceMin = Math.min(a, b);
                    priceMax = Math.max(a, b);
                }
            }
            const maxMatch = lowerRaw.match(/\b(?:under|below|less than|up to|max(?:imum)?)\s*\$?(\d[\d,]*)\b/);
            if (maxMatch) priceMax = parseNumber(maxMatch[1]);
            const minMatch = lowerRaw.match(/\b(?:over|above|more than|at least|min(?:imum)?)\s*\$?(\d[\d,]*)\b/);
            if (minMatch) priceMin = parseNumber(minMatch[1]);
        }

        const locationSource = []
            .concat(Array.isArray(this.marketplaceItems) ? this.marketplaceItems : [])
            .concat(Array.isArray(this.vehicleListings) ? this.vehicleListings : [])
            .concat(Array.isArray(this.realestateListings) ? this.realestateListings : [])
            .concat(Array.isArray(this.serviceProfiles) ? this.serviceProfiles : []);

        const cities = Array.from(new Set(locationSource.map((i) => String(i?.city || '').trim()).filter(Boolean)));
        const countries = Array.from(new Set(locationSource.map((i) => String(i?.country || '').trim()).filter(Boolean)));

        const findBestMatch = (candidates) => {
            const scored = candidates
                .map((value) => ({ value, key: this.normalizeSearchText(value) }))
                .filter((entry) => entry.key)
                .sort((a, b) => b.key.length - a.key.length);
            for (const entry of scored) {
                const pattern = new RegExp(`(^|\\s)${this.escapeRegex(entry.key)}(\\s|$)`, 'i');
                if (pattern.test(normalized)) return entry.value;
            }
            return '';
        };

        const city = findBestMatch(cities);
        const country = findBestMatch(countries);

        const categoryHints = {
            electronics: ['iphone', 'phone', 'laptop', 'macbook', 'ipad', 'tablet', 'camera', 'headphones', 'tv', 'monitor', 'console', 'playstation', 'xbox', 'nintendo'],
            clothing: ['shoes', 'sneakers', 'jacket', 'coat', 'dress', 'jeans', 'hoodie', 'boots'],
            sports: ['bike', 'bicycle', 'treadmill', 'weights', 'dumbbell', 'kayak', 'golf', 'ski', 'snowboard'],
            home: ['couch', 'sofa', 'table', 'chair', 'bed', 'dresser', 'lamp', 'rug', 'desk'],
            vehicles: ['car', 'truck', 'suv', 'sedan', 'vehicle', 'motorcycle', 'scooter'],
            services: ['service', 'cleaning', 'tutor', 'plumber', 'landscaping', 'repair', 'photography', 'design'],
            real_estate: ['apartment', 'condo', 'house', 'rent', 'lease', 'room', 'real estate', 'realestate'],
            buy_sell: ['buy', 'sell', 'sale', 'for sale'],
            community: ['meetup', 'event', 'class', 'group']
        };

        let category = '';
        let bestScore = 0;
        Object.entries(categoryHints).forEach(([key, keywords]) => {
            const score = keywords.reduce((acc, kw) => acc + (normalized.includes(this.normalizeSearchText(kw)) ? 1 : 0), 0);
            if (score > bestScore) {
                bestScore = score;
                category = key;
            }
        });
        if (bestScore === 0) category = '';

        let cleaned = normalized;
        const removeWholeWord = (word) => {
            if (!word) return;
            const key = this.normalizeSearchText(word);
            if (!key) return;
            cleaned = cleaned.replace(new RegExp(`(^|\\s)${this.escapeRegex(key)}(\\s|$)`, 'g'), ' ');
        };
        removeWholeWord(city);
        removeWholeWord(country);
        cleaned = cleaned
            .replace(/\b\d+\b/g, ' ')
            .replace(/\b(today|tonight|week|month|all|anytime|time)\b/g, ' ')
            .replace(/\b(under|below|less|than|up|to|max|over|above|more|at|least|min|between|from|and|in|near|around|with|for)\b/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const cleanedTokens = cleaned
            ? cleaned.split(' ').filter(Boolean).filter((t) => t.length > 1).slice(0, 6)
            : [];

        return {
            term: cleanedTokens.join(' '),
            category,
            city,
            country,
            priceMin,
            priceMax,
            dateFilter
        };
    }

    applyHomeAiSearch() {
        const whatInput = document.getElementById('home-search-what');
        if (!whatInput) return;
        const raw = String(whatInput.value || '').trim();
        if (!raw) {
            this.showNotification('Type a search like bike in Oakland under $500, then tap AI.');
            return;
        }

        const interpreted = this.interpretHomeSearchQuery(raw);
        const updates = [];

        const locationInput = document.getElementById('home-search-location');
        if (locationInput && (interpreted.city || interpreted.country)) {
            const nextLocation = [interpreted.city, interpreted.country].filter(Boolean).join(', ');
            if (nextLocation && String(locationInput.value || '').trim() !== nextLocation) {
                locationInput.value = nextLocation;
                updates.push('location');
            }
        }

        const dateEl = document.getElementById('home-filter-date');
        if (dateEl && interpreted.dateFilter && dateEl.value !== interpreted.dateFilter) {
            dateEl.value = interpreted.dateFilter;
            updates.push('date');
        }

        const minEl = document.getElementById('home-filter-price-min');
        if (minEl && interpreted.priceMin !== null) {
            minEl.value = String(interpreted.priceMin);
            updates.push('min');
        }
        const maxEl = document.getElementById('home-filter-price-max');
        if (maxEl && interpreted.priceMax !== null) {
            maxEl.value = String(interpreted.priceMax);
            updates.push('max');
        }

        const globalCat = document.getElementById('global-category-select');
        const searchCat = document.getElementById('home-search-category');
        const sideCat = document.getElementById('home-filter-category');
        if (interpreted.category) {
            if (globalCat && globalCat.value !== interpreted.category) globalCat.value = interpreted.category;
            if (searchCat && searchCat.value !== interpreted.category) searchCat.value = interpreted.category;
            if (sideCat && sideCat.value !== interpreted.category) sideCat.value = interpreted.category;
            updates.push('category');
        }

        if (interpreted.term) whatInput.value = interpreted.term;

        this.applyHomeFilters({ scrollToResults: true });
        this.showNotification(updates.length ? 'AI applied filters.' : 'AI search applied.');
    }

    bindElectronicsFilters(root = document.getElementById('electronics-content')) {
        if (!root || root.dataset.boundElectronicsFilters) return;
        if (!this.electronicsFilters) {
            this.electronicsFilters = {
                subcategory: '',
                condition: '',
                term: '',
                priceMin: '',
                priceMax: '',
                location: ''
            };
        }

        const chipRow = root.querySelector('#electronics-chip-row');
        const chips = chipRow ? Array.from(chipRow.querySelectorAll('.electronics-chip')) : [];
        const searchInput = root.querySelector('#electronics-search');
        const conditionSelect = root.querySelector('#electronics-condition');
        const priceMinInput = root.querySelector('#electronics-price-min');
        const priceMaxInput = root.querySelector('#electronics-price-max');
        const locationInput = root.querySelector('#electronics-location');
        const clearBtn = root.querySelector('#electronics-clear-filters');

        const syncActiveChip = (active) => {
            chips.forEach((chip) => {
                const isActive = active && chip.dataset.category === active;
                chip.classList.toggle('active', isActive);
                chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
        };

        chips.forEach((chip) => {
            chip.addEventListener('click', () => {
                const next = chip.dataset.category || '';
                const current = this.electronicsFilters?.subcategory || '';
                this.electronicsFilters.subcategory = current === next ? '' : next;
                syncActiveChip(this.electronicsFilters.subcategory);
                this.applyElectronicsFilters();
            });
        });

        if (conditionSelect) {
            conditionSelect.addEventListener('change', () => {
                this.electronicsFilters.condition = conditionSelect.value || '';
                this.applyElectronicsFilters();
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', () => {
                this.electronicsFilters.term = searchInput.value || '';
                this.applyElectronicsFilters();
            });
        }

        if (priceMinInput) {
            priceMinInput.addEventListener('input', () => {
                this.electronicsFilters.priceMin = priceMinInput.value || '';
                this.applyElectronicsFilters();
            });
        }

        if (priceMaxInput) {
            priceMaxInput.addEventListener('input', () => {
                this.electronicsFilters.priceMax = priceMaxInput.value || '';
                this.applyElectronicsFilters();
            });
        }

        if (locationInput) {
            locationInput.addEventListener('input', () => {
                this.electronicsFilters.location = locationInput.value || '';
                this.applyElectronicsFilters();
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.electronicsFilters = {
                    subcategory: '',
                    condition: '',
                    term: '',
                    priceMin: '',
                    priceMax: '',
                    location: ''
                };
                this.syncElectronicsFilterUi(root);
                this.applyElectronicsFilters();
            });
        }

        root.dataset.boundElectronicsFilters = '1';
        this.syncElectronicsFilterUi(root);
    }

    syncElectronicsFilterUi(root = document.getElementById('electronics-content')) {
        if (!root) return;
        const filters = this.electronicsFilters || {};
        const activeSubcategory = filters.subcategory || '';

        root.querySelectorAll('.electronics-chip').forEach((chip) => {
            const isActive = activeSubcategory && chip.dataset.category === activeSubcategory;
            chip.classList.toggle('active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        const searchInput = root.querySelector('#electronics-search');
        if (searchInput) searchInput.value = filters.term || '';
        const conditionSelect = root.querySelector('#electronics-condition');
        if (conditionSelect) conditionSelect.value = filters.condition || '';
        const priceMinInput = root.querySelector('#electronics-price-min');
        if (priceMinInput) priceMinInput.value = filters.priceMin || '';
        const priceMaxInput = root.querySelector('#electronics-price-max');
        if (priceMaxInput) priceMaxInput.value = filters.priceMax || '';
        const locationInput = root.querySelector('#electronics-location');
        if (locationInput) locationInput.value = filters.location || '';
    }

    getFilteredElectronicsItems() {
        const filters = this.electronicsFilters || {};
        const subcategory = filters.subcategory || '';
        const condition = filters.condition || '';
        const term = (filters.term || '').trim().toLowerCase();
        const location = (filters.location || '').trim().toLowerCase();
        const parseNumber = (value) => {
            if (value === null || value === undefined || value === '') return null;
            const num = Number(value);
            return Number.isFinite(num) ? num : null;
        };
        const minPrice = parseNumber(filters.priceMin);
        const maxPrice = parseNumber(filters.priceMax);
        const hasFilters = Boolean(subcategory || condition || term || location || minPrice !== null || maxPrice !== null);

        const filtered = (this.marketplaceItems || []).filter((item) => {
            if (!item || item.category !== 'electronics') return false;
            if (subcategory && this.getElectronicsSubcategory(item) !== subcategory) return false;
            if (condition && item.condition !== condition) return false;
            if (term) {
                const subcategoryLabel = this.getElectronicsSubcategoryLabel(this.getElectronicsSubcategory(item));
                const conditionLabel = this.marketplaceConditionLabel(item.condition);
                const deliveryLabel = this.marketplaceDeliveryLabel(item.delivery);
                const specsLine = this.marketplaceSpecsLine(item);
                const priceText = typeof item.price === 'number' ? String(item.price) : String(item.price || '');
                const haystack = [
                    item.title,
                    item.brand,
                    item.model,
                    item.description,
                    item.seller,
                    item.city,
                    item.country,
                    item.availability,
                    priceText,
                    subcategoryLabel,
                    conditionLabel,
                    deliveryLabel,
                    specsLine,
                    this.marketplaceCategoryLabel(item.category),
                    ...(Array.isArray(item.tags) ? item.tags : []),
                    ...(Array.isArray(item.electronicsBadges) ? item.electronicsBadges : [])
                ]
                    .map((value) => String(value || '').toLowerCase())
                    .join(' ');
                if (!haystack.includes(term)) return false;
            }
            if (minPrice !== null && (typeof item.price !== 'number' || item.price < minPrice)) return false;
            if (maxPrice !== null && (typeof item.price !== 'number' || item.price > maxPrice)) return false;
            if (location) {
                const city = String(item.city || '').toLowerCase();
                const country = String(item.country || '').toLowerCase();
                if (!city.includes(location) && !country.includes(location)) return false;
            }
            return true;
        });

        const label = subcategory ? this.getElectronicsSubcategoryLabel(subcategory) : 'Electronics';
        return { items: filtered, label, hasFilters };
    }

    renderElectronicsFeatured(items = []) {
        const section = document.getElementById('electronics-featured-section');
        const row = document.getElementById('electronics-featured-row');
        if (!section || !row) return;

        const source = Array.isArray(items) ? items.slice() : [];
        const sorted = source.sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
        const featured = sorted.filter((item) => item.featured);
        const picks = (featured.length ? featured : sorted).slice(0, 6);

        if (!picks.length) {
            section.classList.add('hidden');
            row.innerHTML = '';
            return;
        }

        section.classList.remove('hidden');
        row.innerHTML = picks
            .map((entry) => this.renderMarketplaceCard(entry, { compact: true, disableCarousel: true }))
            .join('');
        this.bindMarketplaceItemCarousels(row);
    }

    applyElectronicsFilters() {
        const container = document.getElementById('electronics-items');
        if (!container) return;

        const { items, label, hasFilters } = this.getFilteredElectronicsItems();
        const titleEl = document.getElementById('electronics-feed-title');
        const countEl = document.getElementById('electronics-count');
        if (titleEl) titleEl.textContent = `${label} listings`;
        if (countEl) countEl.textContent = `${items.length} ${items.length === 1 ? 'listing' : 'listings'}`;

        const emptyMessage = hasFilters
            ? 'No listings match these filters yet. Try clearing a filter or widening your search.'
            : `Be the first to post in ${label}.`;
        this.renderMarketplaceFeedGroups(items, {
            container,
            emptyTitle: 'No listings yet',
            emptyMessage
        });
        this.renderElectronicsFeatured(items);
    }

    bindClothingFilters(root = document.getElementById('clothing-content')) {
        if (!root || root.dataset.boundClothingFilters) return;
        if (!this.clothingFilters) {
            this.clothingFilters = { category: 'all', chip: 'all', audience: 'all' };
        }

        const categoryCards = Array.from(root.querySelectorAll('.clothing-category-card'));
        const filterChips = Array.from(root.querySelectorAll('.clothing-filter-chip'));
        const audienceChips = Array.from(root.querySelectorAll('.clothing-audience-chip'));

        categoryCards.forEach((card) => {
            card.addEventListener('click', () => {
                const next = card.dataset.category || 'all';
                const current = this.clothingFilters?.category || 'all';
                this.clothingFilters.category = current === next ? 'all' : next;
                if (this.clothingFilters.category === 'all') {
                    this.clothingFilters.audience = 'all';
                }
                this.syncClothingFilterUi(root);
                this.applyClothingFilters();
            });
        });

        filterChips.forEach((chip) => {
            chip.addEventListener('click', () => {
                const next = chip.dataset.filter || 'all';
                const current = this.clothingFilters?.chip || 'all';
                this.clothingFilters.chip = current === next ? 'all' : next;
                this.syncClothingFilterUi(root);
                this.applyClothingFilters();
            });
        });

        audienceChips.forEach((chip) => {
            chip.addEventListener('click', () => {
                const next = chip.dataset.audience || 'all';
                const current = this.clothingFilters?.audience || 'all';
                this.clothingFilters.audience = current === next ? 'all' : next;
                this.syncClothingFilterUi(root);
                this.applyClothingFilters();
            });
        });

        root.dataset.boundClothingFilters = '1';
        this.syncClothingFilterUi(root);
    }

    syncClothingFilterUi(root = document.getElementById('clothing-content')) {
        if (!root) return;
        const activeCategory = this.clothingFilters?.category || 'all';
        const activeChip = this.clothingFilters?.chip || 'all';
        const activeAudience = this.clothingFilters?.audience || 'all';

        const audienceSection = root.querySelector('.clothing-audience-filters');
        if (audienceSection) {
            audienceSection.classList.toggle('hidden', activeCategory === 'all');
        }

        root.querySelectorAll('.clothing-category-card').forEach((card) => {
            const isActive = activeCategory !== 'all' && card.dataset.category === activeCategory;
            card.classList.toggle('is-active', isActive);
            card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        root.querySelectorAll('.clothing-filter-chip').forEach((chip) => {
            const isActive = (chip.dataset.filter || 'all') === activeChip;
            chip.classList.toggle('active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        root.querySelectorAll('.clothing-audience-chip').forEach((chip) => {
            const isActive = (chip.dataset.audience || 'all') === activeAudience;
            chip.classList.toggle('active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        const audienceTitle = root.querySelector('#clothing-audience-title');
        if (audienceTitle) {
            const categoryLabelMap = {
                reseller: 'Reseller',
                used: 'Used',
                free: 'Free',
                bidding: 'Bidding'
            };
            const categoryLabel = activeCategory === 'all'
                ? 'All categories'
                : (categoryLabelMap[activeCategory] || 'Category');
            audienceTitle.textContent = `${categoryLabel} 路 Audience`;
        }
    }

    applyClothingFilters() {
        const container = document.getElementById('clothing-items');
        if (!container) return;

        const category = this.clothingFilters?.category || 'all';
        const chip = this.clothingFilters?.chip || 'all';
        const audience = this.clothingFilters?.audience || 'all';
        const items = (this.marketplaceItems || []).filter((item) => item.category === 'clothing');
        const filtered = items.filter((item) => {
            if (!this.matchesClothingCategory(item, category)) return false;
            if (!this.matchesClothingChip(item, chip)) return false;
            if (!this.matchesClothingAudience(item, audience)) return false;
            return true;
        });

        const titleEl = document.getElementById('clothing-feed-title');
        const countEl = document.getElementById('clothing-count');
        if (titleEl) titleEl.textContent = this.buildClothingFeedLabel(category, chip, audience);
        if (countEl) countEl.textContent = `${filtered.length} ${filtered.length === 1 ? 'listing' : 'listings'}`;
        this.renderMarketplaceFeedGroups(filtered, {
            container,
            emptyTitle: 'No listings yet',
            emptyMessage: 'Try a different filter or post the first drop.'
        });
    }

    bindJobsFilters(root = document.getElementById('jobs-content')) {
        if (!root || root.dataset.boundJobsFilters) return;
        if (!this.jobsFilters) {
            this.jobsFilters = {
                category: 'marketing_sales',
                term: '',
                location: '',
                remoteOnly: false,
                type: 'all',
                salaryMin: 'any',
                salaryMax: 'any',
                experience: 'all',
                posted: 'all',
                sort: 'newest'
            };
        }
        const categoryChips = Array.from(root.querySelectorAll('.jobs-filter-chip'));
        const typeChips = Array.from(root.querySelectorAll('.jobs-type-chip'));
        const postedTabs = Array.from(root.querySelectorAll('.jobs-posted-tab'));
        const searchInput = root.querySelector('#jobs-search');
        const locationInput = root.querySelector('#jobs-location');
        const remoteToggle = root.querySelector('#jobs-remote');
        const salaryMinSelect = root.querySelector('#jobs-salary-min');
        const salaryMaxSelect = root.querySelector('#jobs-salary-max');
        const experienceSelect = root.querySelector('#jobs-experience');
        const sortSelect = root.querySelector('#jobs-sort');
        const searchBtn = root.querySelector('#jobs-search-btn');

        const syncFromInputs = () => {
            this.jobsFilters.term = (searchInput?.value || '').trim();
            this.jobsFilters.location = (locationInput?.value || '').trim();
            this.jobsFilters.remoteOnly = Boolean(remoteToggle?.checked);
            this.jobsFilters.salaryMin = salaryMinSelect?.value || 'any';
            this.jobsFilters.salaryMax = salaryMaxSelect?.value || 'any';
            this.jobsFilters.experience = experienceSelect?.value || 'all';
            this.jobsFilters.sort = sortSelect?.value || 'newest';
        };

        categoryChips.forEach((chip) => {
            chip.addEventListener('click', () => {
                const next = chip.dataset.filter || 'all';
                this.jobsFilters.category = next;
                this.syncJobsFilterUi(root);
                this.applyJobsFilters();
            });
        });
        typeChips.forEach((chip) => {
            chip.addEventListener('click', () => {
                const next = chip.dataset.type || 'all';
                this.jobsFilters.type = next;
                this.syncJobsFilterUi(root);
                this.applyJobsFilters();
            });
        });
        postedTabs.forEach((tab) => {
            tab.addEventListener('click', () => {
                const next = tab.dataset.posted || 'all';
                this.jobsFilters.posted = next;
                this.syncJobsFilterUi(root);
                this.applyJobsFilters();
            });
        });

        const bindInput = (el) => {
            if (!el || el.dataset.bound) return;
            const handler = () => {
                syncFromInputs();
                this.applyJobsFilters();
            };
            el.addEventListener('input', handler);
            el.addEventListener('change', handler);
            el.dataset.bound = '1';
        };

        bindInput(searchInput);
        bindInput(locationInput);
        bindInput(remoteToggle);
        bindInput(salaryMinSelect);
        bindInput(salaryMaxSelect);
        bindInput(experienceSelect);
        bindInput(sortSelect);

        if (searchBtn && !searchBtn.dataset.bound) {
            searchBtn.addEventListener('click', () => {
                syncFromInputs();
                this.applyJobsFilters();
            });
            searchBtn.dataset.bound = '1';
        }

        root.dataset.boundJobsFilters = '1';
        this.syncJobsFilterUi(root);
    }

    syncJobsFilterUi(root = document.getElementById('jobs-content')) {
        if (!root) return;
        const active = this.jobsFilters?.category || 'marketing_sales';
        root.querySelectorAll('.jobs-filter-chip').forEach((chip) => {
            const isActive = (chip.dataset.filter || 'all') === active;
            chip.classList.toggle('active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        const typeActive = this.jobsFilters?.type || 'all';
        root.querySelectorAll('.jobs-type-chip').forEach((chip) => {
            const isActive = (chip.dataset.type || 'all') === typeActive;
            chip.classList.toggle('active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        const postedActive = this.jobsFilters?.posted || 'all';
        root.querySelectorAll('.jobs-posted-tab').forEach((tab) => {
            const isActive = (tab.dataset.posted || 'all') === postedActive;
            tab.classList.toggle('active', isActive);
            tab.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
    }

    applyJobsFilters() {
        const container = document.getElementById('jobs-items');
        if (!container) return;
        let filter = this.jobsFilters?.category || 'marketing_sales';
        let categoryLabel = this.getJobsCategoryLabel(filter);
        if (!categoryLabel) {
            filter = 'marketing_sales';
            this.jobsFilters.category = filter;
            categoryLabel = this.getJobsCategoryLabel(filter);
        }
        const items = (this.marketplaceItems || []).filter((item) => item.category === 'jobs');
        const term = (this.jobsFilters?.term || '').toLowerCase();
        const locationNeedle = (this.jobsFilters?.location || '').toLowerCase();
        const remoteOnly = Boolean(this.jobsFilters?.remoteOnly);
        const typeFilter = this.jobsFilters?.type || 'all';
        const experienceFilter = this.jobsFilters?.experience || 'all';
        const salaryMin = this.parseJobsPayValue(this.jobsFilters?.salaryMin);
        const salaryMax = this.parseJobsPayValue(this.jobsFilters?.salaryMax);
        const postedFilter = this.jobsFilters?.posted || 'all';
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);

        const filtered = items.filter((item) => {
            if (!this.isJobsCategoryMatch(item, filter)) return false;
            if (term) {
                const haystack = `${item.title || ''} ${item.description || ''} ${item.seller || ''} ${(item.tags || []).join(' ')}`.toLowerCase();
                if (!haystack.includes(term)) return false;
            }
            if (locationNeedle) {
                const locText = `${item.city || ''} ${item.location || ''}`.toLowerCase();
                if (!locText.includes(locationNeedle)) return false;
            }
            if (remoteOnly && !this.isJobRemote(item)) return false;
            if (typeFilter !== 'all' && item.employmentType !== typeFilter) return false;
            if (experienceFilter !== 'all' && item.experienceLevel !== experienceFilter) return false;
            const payMin = this.getJobPayMin(item);
            const payMax = this.getJobPayMax(item);
            if (typeof salaryMin === 'number' && Number.isFinite(salaryMin) && payMax < salaryMin) return false;
            if (typeof salaryMax === 'number' && Number.isFinite(salaryMax) && payMin > salaryMax) return false;
            if (postedFilter && postedFilter !== 'all') {
                const postedDate = this.normalizeActivityDate(item.postedDate);
                if (!postedDate) return false;
                if (postedFilter === 'today' && postedDate < today) return false;
                if (postedFilter === 'week' && postedDate < weekAgo) return false;
            }
            return true;
        });

        const sortMode = this.jobsFilters?.sort || 'newest';
        const sorted = filtered.slice().sort((a, b) => {
            if (sortMode === 'salary_high') return this.getJobPayMax(b) - this.getJobPayMax(a);
            if (sortMode === 'salary_low') return this.getJobPayMin(a) - this.getJobPayMin(b);
            return new Date(b.postedDate) - new Date(a.postedDate);
        });

        const titleEl = document.getElementById('jobs-feed-title');
        const countEl = document.getElementById('jobs-count');
        if (titleEl) titleEl.textContent = categoryLabel ? `${categoryLabel} roles` : 'Job listings';
        if (countEl) countEl.textContent = `${sorted.length} ${sorted.length === 1 ? 'listing' : 'listings'}`;

        const emptyTitle = categoryLabel ? `No ${categoryLabel.toLowerCase()} roles yet` : 'No listings yet';
        const emptyMessage = categoryLabel
            ? `Check back soon for ${categoryLabel.toLowerCase()} openings.`
            : 'Check back soon for new listings.';
        this.renderMarketplaceFeedGroups(sorted, {
            container,
            emptyTitle,
            emptyMessage,
            sortByDate: sortMode === 'newest'
        });
    }

    getJobsCategoryLabel(key) {
        const map = {
            marketing_sales: 'Marketing & Sales',
            skilled_trades: 'Skilled Trades & Construction',
            creative_media: 'Creative & Media',
            tech_digital: 'Tech & Digital',
            business_office: 'Business & Office',
            transportation: 'Transportation',
            food_hospitality: 'Food & Hospitality',
            healthcare_wellness: 'Healthcare & Wellness',
            cleaning_maintenance: 'Cleaning & Maintenance',
            childcare_education: 'Childcare & Education',
            retail_customer_service: 'Retail & Customer Service',
            general_gigs: 'General Gigs & Freelance'
        };
        return map[key] || '';
    }

    getJobTypeLabel(type) {
        const map = {
            full_time: 'Full-time',
            part_time: 'Part-time',
            contract: 'Contract',
            internship: 'Internship'
        };
        return map[type] || 'Role';
    }

    getJobExperienceLabel(level) {
        const map = {
            entry: 'Entry',
            mid: 'Mid-level',
            senior: 'Senior'
        };
        const raw = String(level || '').trim();
        if (!raw) return 'Experience';
        const key = raw.toLowerCase();
        return map[key] || raw;
    }

    getJobLocationLabel(item) {
        const city = item?.city ? String(item.city) : 'Location TBD';
        if (item?.remote && item?.locationType) return `${city} 路 ${item.locationType}`;
        if (item?.remote) return `${city} 路 Remote`;
        if (item?.locationType) return `${city} 路 ${item.locationType}`;
        return city;
    }

    getJobPayLabel(item) {
        const min = this.getJobPayMin(item);
        const max = this.getJobPayMax(item);
        const unit = item?.payUnit === 'year' ? '/yr' : '/hr';
        if (min && max && min !== max) return `$${min}-${max}${unit}`;
        if (min) return `$${min}${unit}`;
        if (typeof item?.price !== 'undefined') return `$${item.price}${unit}`;
        return 'Pay TBD';
    }

    getJobPayMin(item) {
        if (!item) return 0;
        const min = Number(item.payMin ?? item.price ?? 0);
        return Number.isFinite(min) ? min : 0;
    }

    getJobPayMax(item) {
        if (!item) return this.getJobPayMin(item);
        const max = Number(item.payMax ?? item.payMin ?? item.price ?? 0);
        return Number.isFinite(max) ? max : this.getJobPayMin(item);
    }

    getJobStatusLabel(item) {
        const text = String(item?.jobStatus || '').trim();
        if (text) return text;
        if (item?.tags?.some?.((tag) => String(tag).toLowerCase().includes('vip'))) return 'Hiring fast';
        return 'Open role';
    }

    isJobRemote(item) {
        if (!item) return false;
        if (item.remote) return true;
        const locationType = String(item.locationType || '').toLowerCase();
        return locationType.includes('remote');
    }

    parseJobsPayValue(value) {
        if (!value || value === 'any') return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
    }

    setupPostItemLivePreview() {
        const preview = document.getElementById('post-item-preview-card');
        if (!preview) return;
        if (preview.dataset.bound) {
            this.renderPostItemLivePreview();
            return;
        }
        const fieldIds = [
            'item-title',
            'item-price',
            'item-description',
            'item-city',
            'item-country',
            'item-category',
            'item-brand',
            'item-model',
            'item-condition',
            'item-quantity',
            'item-delivery',
            'item-shipping-fee',
            'item-availability',
            'item-tags',
            'item-placement',
            'item-featured',
            'job-company',
            'vehicle-make',
            'vehicle-model',
            'vehicle-year',
            'vehicle-mileage',
            'vehicle-condition',
            'vehicle-transmission',
            'vehicle-fuel',
            'vehicle-category'
        ];
        fieldIds.forEach((id) => {
            const field = document.getElementById(id);
            if (!field || field.dataset.previewBound) return;
            const handler = () => this.renderPostItemLivePreview();
            field.addEventListener('input', handler);
            field.addEventListener('change', handler);
            field.dataset.previewBound = '1';
        });
        preview.dataset.bound = '1';
        this.renderPostItemLivePreview();
    }

    renderPostItemLivePreview() {
        const preview = document.getElementById('post-item-preview-card');
        if (!preview) return;
        const getValue = (id) => (document.getElementById(id)?.value || '').trim();
        const getNumber = (id) => {
            const raw = getValue(id);
            if (!raw) return null;
            const num = Number(raw);
            return Number.isFinite(num) ? num : null;
        };
        const formatPrice = (value) => {
            if (!Number.isFinite(value) || value <= 0) return '$0.00';
            const hasCents = Math.abs(value % 1) > 0;
            return `$${value.toLocaleString(undefined, {
                minimumFractionDigits: hasCents ? 2 : 0,
                maximumFractionDigits: hasCents ? 2 : 0
            })}`;
        };

        const category = document.getElementById('item-category')?.value || '';
        const categoryLabel = this.marketplaceCategoryLabel(category) || 'Marketplace';
        const title = getValue('item-title') || `Promote your ${categoryLabel.toLowerCase()}`;
        const description = getValue('item-description');
        const availability = getValue('item-availability');
        const city = getValue('item-city');
        const country = getValue('item-country');
        const location = [city, country].filter(Boolean).join(', ');
        const bodyCopy = description
            ? this.truncateText(description, 220)
            : ('Share ' + categoryLabel.toLowerCase() + ' with buyers browsing Discover and Marketplace.');
        const priceNumber = getNumber('item-price');
        const priceLabel = Number.isFinite(priceNumber) && priceNumber > 0 ? formatPrice(priceNumber) : '';
        const conditionKey = document.getElementById('item-condition')?.value || '';
        const conditionLabel = this.marketplaceConditionLabel(conditionKey) || '';
        const deliveryMethod = document.getElementById('item-delivery')?.value || '';
        const shippingFee = getNumber('item-shipping-fee');
        const delivery = deliveryMethod
            ? {
                method: deliveryMethod,
                shippingFee: Number.isFinite(shippingFee) ? shippingFee : null
            }
            : null;
        const deliveryLabel = this.marketplaceDeliveryLabel(delivery);
        const highlightParts = [];
        if (availability) highlightParts.push(availability);
        if (location) highlightParts.push(location);
        const highlight = highlightParts.join(' 路 ');
        const metaParts = [];
        if (priceLabel) metaParts.push(priceLabel);
        if (highlight) metaParts.push(highlight);
        if (conditionLabel) metaParts.push(conditionLabel);
        if (deliveryLabel) metaParts.push(deliveryLabel);
        const metaText = metaParts.length
            ? metaParts.join(' 路 ')
            : 'Add price, city, and delivery info to build trust.';

        const tags = this.parseTagInput(document.getElementById('item-tags')?.value || '').slice(0, 4);
        const fallbackTagsMap = {
            electronics: ['Verified tech', 'Fast ship', 'Warranty'],
            services: ['Same-week slots', 'Mobile', 'Trusted'],
            jobs: ['Hiring now', 'Benefits', 'Apply today'],
            real_estate: ['New listing', 'Book a tour', 'Move-in ready'],
            vehicles: ['Low mileage', 'Certified', 'Delivery available'],
            dating: ['Verified', 'Local'],
            community: ['Local promos', 'Events'],
            buy_sell: ['Products', 'Services', 'Events'],
            other: ['Local promos', 'Announcements']
        };
    const fallbackTags = (fallbackTagsMap[category] || ['Products', 'Services', 'Local promos']).slice();
        if (conditionLabel) fallbackTags.push(conditionLabel);
        if (deliveryLabel) fallbackTags.push(deliveryLabel);
        const tagList = (tags.length ? tags : fallbackTags).slice(0, 4);

        const imageList = Array.isArray(this.marketplaceUploads) ? this.marketplaceUploads : [];
        const fallbackImage = 'assets/ad-placeholder.svg';
        const imageSrc = imageList.length ? imageList[0].src : fallbackImage;
        const toArray = (value) => (Array.isArray(value) ? value : [value]);
        const setText = (ids, value) => {
            toArray(ids).forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
        };
        const setHtml = (ids, value) => {
            toArray(ids).forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = value;
            });
        };
        const setImage = (ids, src, alt) => {
            toArray(ids).forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.src = src;
                    if (alt) el.alt = alt;
                }
            });
        };

        const imageAlt = title ? `${title} photo` : 'Ad placement preview';
        setImage(['post-ad-preview-image', 'home-bottom-ad-image'], imageSrc, imageAlt);
        const homeSlot = document.querySelector('.home-bottom-ad-image-only');
        if (homeSlot) homeSlot.classList.toggle('is-placeholder', imageSrc === fallbackImage);

        const tagsHtml = tagList.length
            ? tagList
                .map((tag) => `<span class="home-bottom-ad-tag">${this.escapeHtml(tag)}</span>`)
                .join('')
            : '<span class="home-bottom-ad-tag preview-empty-tag">Add tags like shipping, negotiable</span>';
        setHtml(['post-ad-preview-tags', 'home-bottom-ad-tags'], tagsHtml);

        const ctaText = (() => {
            switch (category) {
                case 'electronics':
                    return 'Promote electronics';
                case 'services':
                    return 'Book this service';
                case 'jobs':
                    return 'Post this role';
                case 'real_estate':
                    return 'Show this property';
                case 'vehicles':
                    return 'List this vehicle';
                case 'dating':
                    return 'Boost this spotlight';
                case 'community':
                    return 'Boost community post';
                default:
                    return 'Post this ad';
            }
        })();

        const ctaHtml = '<i class="fas fa-bullhorn" aria-hidden="true"></i>' + this.escapeHtml(ctaText);
        setHtml(['post-ad-preview-cta', 'home-bottom-ad-cta'], ctaHtml);

        setText(['post-ad-preview-eyebrow', 'home-bottom-ad-eyebrow'], 'Sponsored 路 ' + categoryLabel);
        setText(['post-ad-preview-title', 'home-bottom-ad-title'], title);
        setText(['post-ad-preview-body', 'home-bottom-ad-body'], bodyCopy);
        setText(['post-ad-preview-meta', 'home-bottom-ad-meta'], metaText);
    }

    setupPostItemJobPreview() {
        const preview = document.getElementById('job-card-preview');
        if (!preview || preview.dataset.bound) {
            if (preview) this.renderPostItemJobPreview();
            return;
        }
        const fieldIds = [
            'job-company',
            'job-company-logo',
            'job-category',
            'job-type',
            'job-experience',
            'job-pay-max',
            'job-remote',
            'item-title',
            'item-price',
            'item-city',
            'item-country',
            'item-description',
            'item-tags'
        ];
        fieldIds.forEach((id) => {
            const field = document.getElementById(id);
            if (!field || field.dataset.previewBound) return;
            const handler = () => this.renderPostItemJobPreview();
            field.addEventListener('input', handler);
            field.addEventListener('change', handler);
            field.dataset.previewBound = '1';
        });
        preview.dataset.bound = '1';
        this.renderPostItemJobPreview();
    }

    renderPostItemJobPreview() {
        const preview = document.getElementById('job-card-preview');
        if (!preview) return;
        const category = document.getElementById('item-category')?.value || '';
        if (category !== 'jobs') return;

        const companyInput = document.getElementById('job-company');
        const company = (companyInput?.value || '').trim() || 'Company name';
        const logoUrl = (document.getElementById('job-company-logo')?.value || '').trim();
        const role = (document.getElementById('item-title')?.value || '').trim() || 'Job title';
        const city = (document.getElementById('item-city')?.value || '').trim();
        const country = (document.getElementById('item-country')?.value || '').trim();
        const locationParts = [city, country].filter(Boolean);
        const locationBase = locationParts.length ? locationParts.join(', ') : 'Location';
        const remoteOnly = Boolean(document.getElementById('job-remote')?.checked);
        const locationLabel = remoteOnly ? `${locationBase} 路 Remote` : locationBase;
        const jobCategory = document.getElementById('job-category')?.value || '';
        const categoryLabel = this.getJobsCategoryLabel(jobCategory) || 'Category';
        const typeLabel = this.getJobTypeLabel(document.getElementById('job-type')?.value || '');
        const experienceLabel = this.getJobExperienceLabel(document.getElementById('job-experience')?.value || '');
        const payMinRaw = (document.getElementById('item-price')?.value || '').trim();
        const payMin = payMinRaw ? parseFloat(payMinRaw) : null;
        const payMaxRaw = (document.getElementById('job-pay-max')?.value || '').trim();
        const payMax = payMaxRaw ? parseFloat(payMaxRaw) : null;
        const payLabel = this.getJobPayLabel({
            payMin: Number.isFinite(payMin) ? payMin : null,
            payMax: Number.isFinite(payMax) ? payMax : null,
            payUnit: 'hr',
            price: Number.isFinite(payMin) ? payMin : undefined
        });
        const summaryRaw = (document.getElementById('item-description')?.value || '').trim();
        const summary = summaryRaw ? this.truncateText(summaryRaw, 140) : 'Describe the role so candidates know what to expect.';
        const tags = this.parseTagInput(document.getElementById('item-tags')?.value || '').slice(0, 4);

        const logoEl = document.getElementById('job-preview-logo');
        if (logoEl) {
            if (logoUrl) {
                const safeUrl = this.escapeHtml(logoUrl);
                logoEl.innerHTML = `<img src="${safeUrl}" alt="${this.escapeHtml(company)} logo" loading="lazy">`;
            } else {
                logoEl.textContent = this.getInitials(company) || 'JC';
            }
        }

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        setText('job-preview-title', role);
        setText('job-preview-company', `${company} 路 ${categoryLabel}`);
        setText('job-preview-location', locationLabel);
        setText('job-preview-pay', payLabel || 'Pay TBD');
        setText('job-preview-type', typeLabel);
        setText('job-preview-exp', experienceLabel);
        setText('job-preview-summary', summary);

        const tagsEl = document.getElementById('job-preview-tags');
        if (tagsEl) {
            if (tags.length) {
                tagsEl.innerHTML = tags.map((tag) => `<span>${this.escapeHtml(tag)}</span>`).join('');
            } else {
                tagsEl.innerHTML = '<span class="jobs-preview-empty">Add tags like benefits, remote, urgent</span>';
            }
        }
    }

    isJobsCategoryMatch(item, category) {
        if (!item || !category) return false;
        if (item.jobCategory && item.jobCategory === category) return true;
        const tags = Array.isArray(item.tags)
            ? item.tags.map((tag) => String(tag).toLowerCase())
            : [];
        const text = `${item.title || ''} ${item.description || ''} ${item.seller || ''}`.toLowerCase();
        const hasTerm = (terms) => terms.some((term) => text.includes(term) || tags.includes(term));
        const map = {
            marketing_sales: ['marketing', 'sales', 'growth', 'brand', 'social media', 'business development'],
            skilled_trades: ['construction', 'trade', 'electrician', 'plumber', 'carpenter', 'contractor', 'foreman', 'labor'],
            creative_media: ['creative', 'media', 'designer', 'design', 'photographer', 'videographer', 'editor', 'content'],
            tech_digital: ['tech', 'software', 'developer', 'engineer', 'data', 'digital', 'product', 'ux', 'ui'],
            business_office: ['office', 'admin', 'assistant', 'operations', 'accounting', 'hr', 'finance'],
            transportation: ['driver', 'delivery', 'logistics', 'transport', 'fleet', 'rideshare'],
            food_hospitality: ['hospitality', 'restaurant', 'chef', 'server', 'barista', 'bartender', 'catering', 'concierge'],
            healthcare_wellness: ['healthcare', 'medical', 'nurse', 'clinic', 'wellness', 'therapist', 'trainer'],
            cleaning_maintenance: ['cleaning', 'maintenance', 'janitor', 'housekeeping', 'facility', 'handyman'],
            childcare_education: ['childcare', 'education', 'teacher', 'tutor', 'nanny', 'daycare'],
            retail_customer_service: ['retail', 'customer service', 'cashier', 'sales associate', 'store', 'pos'],
            general_gigs: ['gig', 'freelance', 'contract', 'temporary', 'part-time', 'task', 'helper']
        };
        const terms = map[category] || [];
        return hasTerm(terms);
    }

    matchesClothingCategory(item, category) {
        if (!category || category === 'all') return true;
        const text = this.getClothingFilterText(item);
        const tags = Array.isArray(item.tags) ? item.tags.map((tag) => String(tag).toLowerCase()) : [];
        const conditionText = String(item.condition || '').toLowerCase();
        const isNewish = conditionText === 'new'
            || conditionText === 'like_new'
            || conditionText.includes('like new')
            || conditionText.includes('brand new');
        const isUsed = this.isClothingUsed(item, text, conditionText);
        const hasTag = (terms) => terms.some((term) => tags.includes(term) || text.includes(term));

        if (category === 'reseller') {
            return hasTag(['reseller', 'resell', 'consign', 'consignment', 'boutique', 'storefront'])
                || (isNewish && Boolean(item.brand || item.model));
        }
        if (category === 'used') {
            return isUsed || hasTag(['used', 'pre-owned', 'preowned', 'vintage', 'worn', 'preloved']);
        }
        if (category === 'free') {
            return Number(item.price) === 0
                || hasTag(['free', 'giveaway', 'no cost'])
                || text.includes('free');
        }
        if (category === 'bidding') {
            return hasTag(['bid', 'bidding', 'auction', 'ask', 'offer']);
        }
        return true;
    }

    matchesClothingChip(item, chip) {
        if (!chip || chip === 'all') return true;
        const text = this.getClothingFilterText(item);
        const hasKeyword = (terms) => terms.some((term) => text.includes(term));
        const conditionText = String(item.condition || '').toLowerCase();
        const isNewish = conditionText === 'new'
            || conditionText === 'like_new'
            || conditionText.includes('like new')
            || conditionText.includes('brand new');

        if (chip === 'sneakers') {
            return hasKeyword([
                'sneaker', 'jordans', 'jordan', 'dunk', 'yeezy', 'air max', 'air force',
                'new balance', 'asics', 'saucony', 'reebok', 'puma', 'nike', 'adidas'
            ]);
        }
        if (chip === 'streetwear') {
            return hasKeyword([
                'streetwear', 'hoodie', 'crewneck', 'tee', 't-shirt', 'jacket', 'cargo',
                'denim', 'vintage', 'supreme', 'stussy', 'off-white', 'fear of god'
            ]);
        }
        if (chip === 'accessories') {
            return hasKeyword([
                'accessory', 'belt', 'bag', 'hat', 'cap', 'beanie', 'wallet', 'sunglasses',
                'watch', 'jewelry', 'scarf'
            ]);
        }
        if (chip === 'deadstock') {
            return isNewish || text.includes('deadstock') || /\bds\b/.test(text);
        }
        if (chip === 'used') {
            return this.isClothingUsed(item, text, conditionText);
        }
        if (chip === 'size_7_12') {
            return /\b(?:size|sz)\s*(7(?:\.5)?|8(?:\.5)?|9(?:\.5)?|10(?:\.5)?|11(?:\.5)?|12)\b/.test(text);
        }
        return true;
    }

    matchesClothingAudience(item, audience) {
        if (!audience || audience === 'all') return true;
        const text = this.getClothingFilterText(item);
        const hasKeyword = (terms) => terms.some((term) => text.includes(term));

        if (audience === 'men') {
            return hasKeyword(['men', 'mens', 'male', 'unisex', 'men\'s', 'menswear']);
        }
        if (audience === 'women') {
            return hasKeyword(['women', 'womens', 'female', 'women\'s', 'womenswear']);
        }
        if (audience === 'kids') {
            return hasKeyword(['kids', 'kid', 'youth', 'boys', 'girls', 'toddler', 'child']);
        }
        return true;
    }

    isClothingUsed(item, text, conditionText = '') {
        if (conditionText && !['new', 'like_new'].includes(conditionText)) return true;
        return text.includes('used')
            || text.includes('pre-owned')
            || text.includes('preowned')
            || text.includes('worn')
            || text.includes('vintage')
            || text.includes('preloved');
    }

    getClothingFilterText(item) {
        const tags = Array.isArray(item.tags) ? item.tags.join(' ') : '';
        return [
            item.title,
            item.description,
            item.brand,
            item.model,
            item.condition,
            tags
        ]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();
    }

    buildClothingFeedLabel(category, chip, audience) {
        const categoryLabelMap = {
            reseller: 'Reseller',
            used: 'Used',
            free: 'Free',
            bidding: 'Bidding'
        };
        const chipLabelMap = {
            sneakers: 'Sneakers',
            streetwear: 'Streetwear',
            accessories: 'Accessories',
            deadstock: 'Deadstock',
            used: 'Used',
            size_7_12: 'Size 7-12'
        };
        const audienceLabelMap = {
            men: 'Men',
            women: 'Women',
            kids: 'Kids'
        };
        const categoryLabel = categoryLabelMap[category] || '';
        const chipLabel = chipLabelMap[chip] || '';
        const audienceLabel = audienceLabelMap[audience] || '';

        const parts = [];
        if (audience && audience !== 'all') parts.push(audienceLabel);
        if (chip && chip !== 'all') parts.push(chipLabel);
        if (category && category !== 'all') parts.push(categoryLabel);
        return parts.length ? `${parts.join(' 路 ')} asks` : 'Live asks';
    }

    renderMarketplaceFeedGroups(items, { container, emptyTitle = 'No listings yet', emptyMessage = 'Check back soon for new listings.', sortByDate = true } = {}) {
        if (!container) return;
        container.classList.remove('marketplace-grid');
        container.classList.add('marketplace-feed-list');

        const list = Array.isArray(items) ? items : [];
        if (!list.length) {
            container.innerHTML = `
                <div class="no-items">
                    <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <h3>${this.escapeHtml(emptyTitle)}</h3>
                    <p>${this.escapeHtml(emptyMessage)}</p>
                </div>
            `;
            return;
        }

        const sorted = sortByDate
            ? list.slice().sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate))
            : list.slice();
        const toDayKey = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'unknown';
            return date.toISOString().slice(0, 10);
        };
        const grouped = sorted.reduce((acc, item) => {
            const date = this.normalizeActivityDate(item.postedDate);
            const key = toDayKey(date);
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});
        const groupKeys = Object.keys(grouped).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
        });

        container.innerHTML = groupKeys.map((key) => {
            const groupItems = grouped[key] || [];
            const label = key === 'unknown'
                ? 'Unknown'
                : (this.formatFeedHeaderDate(new Date(`${key}T00:00:00`)) || 'Unknown');
            const countLabel = `${groupItems.length} ${groupItems.length === 1 ? 'listing' : 'listings'}`;
            return `
                <div class="vehicles-feed-group marketplace-feed-group">
                    <div class="vehicles-feed-header">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${countLabel}</span>
                    </div>
                    <div class="marketplace-feed-day-list">
                        ${groupItems.map((item) => this.renderMarketplaceFeedCard(item)).join('')}
                    </div>
                </div>
            `;
        }).join('');

        this.bindMarketplaceItemCarousels(container);
    }

    renderMarketplaceCategoryGrid(category, { containerId, countId, titleId, label } = {}) {
        const container = containerId ? document.getElementById(containerId) : null;
        if (!container) return;
        const countEl = countId ? document.getElementById(countId) : null;
        const titleEl = titleId ? document.getElementById(titleId) : null;
        const categoryLabel = label || this.marketplaceCategoryLabel(category);
        const items = (this.marketplaceItems || [])
            .filter((item) => item.category === category)
            .slice()
            .sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));

        if (titleEl) titleEl.textContent = `${categoryLabel} listings`;
        if (countEl) countEl.textContent = `${items.length} ${items.length === 1 ? 'listing' : 'listings'}`;
        this.renderMarketplaceFeedGroups(items, {
            container,
            emptyTitle: 'No listings yet',
            emptyMessage: `Be the first to post in ${categoryLabel}.`
        });
    }

	    renderMarketplaceItems() {
	        const container = document.getElementById('marketplace-items');
	        const feedTitle = document.getElementById('feed-title');
	        const listingCount = document.getElementById('listing-count');
	        
	        if (!container) return;
	        container.classList.remove('marketplace-grid');
	        container.classList.add('marketplace-feed-list');

	        const dateFilter = document.getElementById('date-filter')?.value || 'today';
	        const dateLabels = {
	            'today': "Today's Listings",
	            'week': "This Week's Listings",
	            'month': "This Month's Listings",
	            'all': "All Listings"
	        };
            const keyword = (document.getElementById('market-search')?.value || '').trim();
            const hasKeyword = Boolean(keyword);
            const hasOtherFilters = Boolean(
                (document.getElementById('category-filter')?.value || '') ||
                (document.getElementById('country-filter')?.value || '') ||
                (document.getElementById('city-filter')?.value || '') ||
                (document.getElementById('price-filter-min')?.value || '') ||
                (document.getElementById('price-filter-max')?.value || '')
            );
	        
	        if (feedTitle) feedTitle.textContent = (hasKeyword || hasOtherFilters) ? 'Search Results' : dateLabels[dateFilter];
	        if (listingCount) listingCount.textContent = `${this.filteredItems.length} items`;

        if (this.filteredItems.length === 0) {
            container.innerHTML = `
                <div class="no-items">
                    <i class="fas fa-shopping-bag" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <h3>No items found</h3>
                    <p>Try adjusting your filters or check back later for new listings.</p>
                </div>
            `;
            return;
        }

        const sorted = this.filteredItems
            .slice()
            .sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
        const toDayKey = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return 'unknown';
            return date.toISOString().slice(0, 10);
        };
        const grouped = sorted.reduce((acc, item) => {
            const date = this.normalizeActivityDate(item.postedDate);
            const key = toDayKey(date);
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});
        const groupKeys = Object.keys(grouped).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
        });

        container.innerHTML = groupKeys.map((key) => {
            const items = grouped[key] || [];
            const label = key === 'unknown' ? '' : this.formatFeedHeaderDate(new Date(`${key}T00:00:00`));
            const countLabel = `${items.length} ${items.length === 1 ? 'item' : 'items'}`;
            const header = label
                ? `
                    <div class="vehicles-feed-header">
                        <h4>${this.escapeHtml(label)}</h4>
                        <span>${countLabel}</span>
                    </div>
                `
                : '';
            return `
                <div class="vehicles-feed-group marketplace-feed-group">
                    ${header}
                    <div class="marketplace-feed-day-list">
                        ${items.map(item => this.renderMarketplaceFeedCard(item)).join('')}
                    </div>
                </div>
            `;
        }).join('');

        this.bindMarketplaceItemCarousels(container);
    }

    bindMarketplaceItemCarousels(container) {
        if (!container) return;
        const items = Array.from(container.querySelectorAll('.marketplace-item'));
        if (!items.length) return;

        items.forEach(item => {
            if (item.dataset.boundMarketplaceCarousel) return;
            if (item.dataset.disableCarousel) {
                item.dataset.boundMarketplaceCarousel = '1';
                return;
            }
            const media = item.querySelector('.marketplace-item-media');
            if (!media) return;
            if (media.querySelector('.carousel-track')) {
                item.dataset.boundMarketplaceCarousel = '1';
                return;
            }

            const raw = item.dataset.images || '';
            const photos = raw
                ? raw.split('|').map(s => {
                    try { return decodeURIComponent(s); } catch { return ''; }
                }).filter(Boolean)
                : [];
            const fallbackSrc = media.querySelector('img')?.getAttribute('src') || '';
            const sources = photos.length ? photos : (fallbackSrc ? [fallbackSrc] : []);
            if (sources.length <= 1) {
                item.dataset.boundMarketplaceCarousel = '1';
                return;
            }

            const title = item.querySelector('.item-title')?.textContent?.trim() || 'Listing';
            const fallbackAlt = media.querySelector('img')?.getAttribute('alt') || title;
            const initialIndex = Math.max(0, Math.min(parseInt(media.dataset.photoIndex || '0', 10) || 0, sources.length - 1));

            media.classList.add('image-carousel');
            // Prevent bindImageCarousels() from attaching its own handlers.
            media.dataset.bound = '1';

            const prev = document.createElement('button');
            prev.type = 'button';
            prev.className = 'carousel-btn prev';
            prev.setAttribute('aria-label', 'Previous photo');
            prev.innerHTML = '<i class="fas fa-chevron-left" aria-hidden="true"></i>';

            const next = document.createElement('button');
            next.type = 'button';
            next.className = 'carousel-btn next';
            next.setAttribute('aria-label', 'Next photo');
            next.innerHTML = '<i class="fas fa-chevron-right" aria-hidden="true"></i>';

            const track = document.createElement('div');
            track.className = 'carousel-track';
            sources.forEach((src, idx) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = fallbackAlt;
                img.loading = 'lazy';
                img.decoding = 'async';
                img.draggable = false;
                img.dataset.index = String(idx);
                track.appendChild(img);
            });

            const scrollBy = (dir) => {
                track.scrollBy({ left: dir * track.clientWidth, behavior: 'smooth' });
            };
            prev.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollBy(-1);
            });
            next.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollBy(1);
            });

            const stop = (e) => e.stopPropagation();
            track.addEventListener('pointerdown', stop);
            track.addEventListener('click', stop);

            const badges = media.querySelector('.marketplace-media-badges');
            media.textContent = '';
            media.appendChild(prev);
            media.appendChild(track);
            media.appendChild(next);
            if (badges) media.appendChild(badges);

            window.requestAnimationFrame(() => {
                track.scrollTo({ left: initialIndex * track.clientWidth });
                media.dataset.photoIndex = String(initialIndex);
            });

            item.dataset.boundMarketplaceCarousel = '1';
        });
    }

	    showItemDetails(itemId) {
	        const item = this.marketplaceItems.find(i => i.id === itemId);
	        if (!item) return;
	        this.recordMarketplaceRecent(itemId);
	        this.renderMarketplaceSections(this.filteredItems);
	        this.renderHomePersonalizedRows();
	        this.openMarketplaceItemModal(item);
	    }

    buildMarketplaceItemGallery(item) {
        if (!item) return { meta: {}, gallery: [] };
        const tags = Array.isArray(item.tags) ? item.tags : [];
        const contact = item.contact && typeof item.contact === 'object' ? item.contact : null;
        const contactParts = [];
        if (contact?.method) {
            const methodMap = {
                phone: 'Phone',
                text: 'Text',
                email: 'Email',
                whatsapp: 'WhatsApp',
                instagram: 'Instagram'
            };
            contactParts.push(methodMap[contact.method] || String(contact.method));
        }
        if (contact?.phone) contactParts.push(String(contact.phone));
        if (contact?.email) contactParts.push(String(contact.email));
        if (contact?.link) contactParts.push(String(contact.link));
        const contactText = contactParts.filter(Boolean).join(' 路 ');

        const meta = {
            bio: item.description || '',
            location: item.city || '',
            date: this.formatDate(item.postedDate),
            specs: this.marketplaceSpecsLine(item),
            delivery: this.marketplaceDeliveryLabel(item.delivery),
            availability: item.availability || '',
            tags,
            contact: contactText,
            payment: item.paymentMethod || ''
        };
        const fallback = 'https://via.placeholder.com/900x650/ebeef5/111827?text=Listing';
        const images = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
        const sources = images.length ? images : [fallback];
        const gallery = sources.map(src => ({ src, label: item.title, type: 'image', meta }));

        const videoSrc = item.video;
        if (videoSrc) {
            const storyText = String(item.storyText || '').trim();
            gallery.push({ src: videoSrc, label: storyText ? `${item.title} 路 ${storyText}` : `${item.title} video`, type: 'video', meta });
        }

        return { meta, gallery };
    }

    openMarketplaceItemModal(item) {
        const modal = document.getElementById('marketplace-item-modal');
        if (!item || !modal) return;
        this.activeMarketplaceItem = item;
        const sourceType = String(item?.source?.type || '').trim();

        const categoryEl = document.getElementById('marketplace-item-category');
        const conditionEl = document.getElementById('marketplace-item-condition');
        const titleEl = document.getElementById('marketplace-item-title');
        const priceEl = document.getElementById('marketplace-item-price');
        const metaEl = document.getElementById('marketplace-item-meta');
        const descEl = document.getElementById('marketplace-item-description');
        const detailsEl = document.getElementById('marketplace-item-details');
        const tagsEl = document.getElementById('marketplace-item-tags');
        const sellerBtn = document.getElementById('marketplace-item-seller');
        const sellerAvatar = document.getElementById('marketplace-item-seller-avatar');
        const sellerName = document.getElementById('marketplace-item-seller-name');
        const sellerLocation = document.getElementById('marketplace-item-seller-location');
        const sellerRating = document.getElementById('marketplace-item-seller-rating');
        const track = document.getElementById('marketplace-item-track');
        const prevBtn = document.getElementById('marketplace-item-prev');
        const nextBtn = document.getElementById('marketplace-item-next');

        const featuredLabelEl = modal.querySelector('.marketplace-item-header .featured-label');
        if (featuredLabelEl) {
            featuredLabelEl.textContent = sourceType === 'community'
                ? 'Community'
                : (sourceType === 'companionship' ? 'Profile' : 'Listing');
        }
        const sellerCtaEl = modal.querySelector('.seller-profile-cta');
        if (sellerCtaEl) {
            sellerCtaEl.textContent = sourceType === 'community'
                ? 'View host'
                : (sourceType === 'companionship' ? 'View profile' : 'View seller');
        }

        const { meta, gallery } = this.buildMarketplaceItemGallery(item);
        this.activeMarketplaceItemGallery = gallery;

        const categoryLabel = this.marketplaceCategoryLabel(item.category);
        if (categoryEl) categoryEl.textContent = categoryLabel || 'Listing';
        const conditionLabel = this.marketplaceConditionLabel(item.condition);
        if (conditionEl) {
            conditionEl.textContent = conditionLabel || '';
            conditionEl.classList.toggle('hidden', !conditionLabel);
        }
        if (titleEl) titleEl.textContent = item.title || 'Listing';
        if (priceEl) {
            const priceText = typeof item.price === 'number'
                ? `$${item.price}`
                : String(item.price || '');
            priceEl.textContent = priceText;
        }

        if (metaEl) {
            const location = [item.city, item.country].filter(Boolean).join(', ');
            const metaParts = [meta.specs, location, meta.date].filter(Boolean);
            metaEl.textContent = metaParts.join(' 路 ') || 'Listing details';
        }

        if (descEl) descEl.textContent = item.description || 'No description provided yet.';

        if (detailsEl) {
            const detailItems = [
                { label: 'Condition', value: conditionLabel },
                { label: 'Delivery', value: meta.delivery },
                { label: 'Availability', value: meta.availability },
                { label: 'Payment', value: meta.payment },
                { label: 'Contact', value: meta.contact },
                { label: 'Posted', value: meta.date }
            ].filter((detail) => detail.value);
            detailsEl.innerHTML = detailItems.map((detail) => `
                <div class="marketplace-item-detail">
                    <span>${this.escapeHtml(detail.label)}</span>
                    <strong>${this.escapeHtml(String(detail.value))}</strong>
                </div>
            `).join('');
        }

        if (tagsEl) {
            const tags = Array.isArray(item.tags) ? item.tags : [];
            tagsEl.innerHTML = tags.length
                ? tags.map(tag => `<span class="marketplace-item-tag">${this.escapeHtml(String(tag))}</span>`).join('')
                : '';
        }

        const seller = String(item.seller || 'Seller');
        if (sellerAvatar) sellerAvatar.textContent = this.getInitials(seller) || '';
        if (sellerName) sellerName.innerHTML = `${this.escapeHtml(seller)}${Number(item.id) % 2 === 1 ? ' <span class="seller-verified">Verified</span>' : ''}`;
        if (sellerLocation) sellerLocation.textContent = [item.city, item.country].filter(Boolean).join(', ') || 'Location not listed';
        if (sellerRating) sellerRating.innerHTML = `<i class="fas fa-star" aria-hidden="true"></i> ${(4.7 + (Number(item.id) % 3) * 0.1).toFixed(1)}`;
        if (sellerBtn) sellerBtn.setAttribute('aria-label', `View seller profile for ${seller}`);

        if (track) {
            const fallback = 'https://via.placeholder.com/900x650/ebeef5/111827?text=Listing';
            const images = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
            const sources = images.length ? images : [fallback];
            track.innerHTML = sources.map((src, idx) => `
                <img src="${this.escapeHtml(src)}" alt="${this.escapeHtml(item.title || 'Listing')} photo ${idx + 1}" loading="lazy" decoding="async">
            `).join('');
            if (prevBtn) prevBtn.classList.toggle('hidden', sources.length <= 1);
            if (nextBtn) nextBtn.classList.toggle('hidden', sources.length <= 1);
            window.requestAnimationFrame(() => {
                track.scrollTo({ left: 0 });
            });
        }

        modal.classList.remove('hidden');
        document.addEventListener('keydown', this.boundMarketplaceItemModalKeydown);
    }

    closeMarketplaceItemModal() {
        const modal = document.getElementById('marketplace-item-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        modal.classList.add('hidden');
        this.activeMarketplaceItem = null;
        this.activeMarketplaceItemGallery = [];
        document.removeEventListener('keydown', this.boundMarketplaceItemModalKeydown);
    }

    openMarketplaceItemGallery() {
        if (!this.activeMarketplaceItem || !this.activeMarketplaceItemGallery.length) return;
        this.openMediaLightbox(this.activeMarketplaceItemGallery, this.activeMarketplaceItem.title || 'Listing', 0);
    }

    openMarketplaceItemSeller() {
        if (!this.activeMarketplaceItem) return;
        const sourceType = String(this.activeMarketplaceItem?.source?.type || '').trim();
        if (sourceType === 'community') {
            const postId = String(this.activeMarketplaceItem?.source?.id || '').trim();
            const post = (Array.isArray(this.communityPosts) ? this.communityPosts : []).find((p) => String(p?.id || '') === postId)
                || (Array.isArray(this.filteredCommunityPosts) ? this.filteredCommunityPosts : []).find((p) => String(p?.id || '') === postId);
            if (!post) return;
            const host = String(post.host || 'Community host').trim();
            const location = this.getCommunityPostLocation(post);
            const locationLabel = this.buildCommunityLocationLabel(location) || '';
            const title = String(post.title || 'Community post');
            const photo = post.image || '';
            const listings = [
                {
                    id: String(post.id || title),
                    title,
                    price: 0,
                    location: locationLabel,
                    images: [photo].filter(Boolean),
                    source: 'community'
                }
            ];
            this.closeMarketplaceItemModal();
            this.openSellerProfileModal({
                name: host,
                initials: this.getInitials(host),
                location: locationLabel,
                listings,
                ratingValue: 4.8,
                ratingLabel: this.formatStarRating('4.8'),
                reviewCount: 12,
                responseLabel: 'Responds within a day',
                verified: true,
                bio: String(post.summary || '').trim(),
                reviews: [],
                source: { type: 'community', id: String(post.id || '') }
            });
            return;
        }
        if (sourceType === 'companionship') {
            const profileId = String(this.activeMarketplaceItem?.source?.id || '').trim();
            const profile = (Array.isArray(this.companionshipProfiles) ? this.companionshipProfiles : []).find((p) => String(p?.id || '') === profileId);
            if (!profile) return;
            const alias = String(profile.alias || profile.name || 'Profile').trim() || 'Profile';
            const locationLabel = [profile.city, profile.country].filter(Boolean).join(', ');
            const title = String(profile.tagline || profile.seeking || 'Companionship profile').trim() || 'Companionship profile';
            const photo = String(profile.photo || '').trim();
            const listings = [
                {
                    id: String(profile.id || alias),
                    title,
                    price: profile.premium ? 'Premium' : 'Companionship',
                    location: locationLabel,
                    images: (Array.isArray(profile.photos) ? profile.photos : []).filter(Boolean).slice(0, 3),
                    thumb: photo,
                    source: 'companionship'
                }
            ];
            this.closeMarketplaceItemModal();
            this.openSellerProfileModal({
                name: alias,
                initials: this.getInitials(alias),
                location: locationLabel,
                listings,
                ratingValue: 4.9,
                ratingLabel: this.formatStarRating('4.9'),
                reviewCount: 18,
                responseLabel: profile.online ? 'Online now' : 'Responds within a day',
                verified: Boolean(profile.premium),
                bio: String(profile.description || profile.tagline || '').trim(),
                reviews: [],
                source: { type: 'companionship', id: String(profile.id || '') }
            });
            return;
        }

        const itemId = this.activeMarketplaceItem.id;
        this.closeMarketplaceItemModal();
        this.openSellerProfileFromItem(itemId);
    }

    openMarketplaceItemOffer() {
        if (!this.activeMarketplaceItem) return;
        const sourceType = String(this.activeMarketplaceItem?.source?.type || '').trim();
        if (sourceType === 'community') {
            const title = String(this.activeMarketplaceItem.title || 'Community post').trim();
            const host = String(this.activeMarketplaceItem.seller || 'Community host').trim();
            const photo = Array.isArray(this.activeMarketplaceItem.images) ? (this.activeMarketplaceItem.images[0] || '') : '';
            this.openSafetyModal({
                title: 'Safety tips before messaging',
                subtitle: 'Use safe meetup and payment practices before continuing.',
                onContinue: () => {
                    this.openChatModal({
                        name: host,
                        photo,
                        status: `Listing: ${title}`,
                        threadKey: `community:${this.normalizeSellerKey(host) || 'host'}:${String(this.activeMarketplaceItem?.source?.id || '')}`,
                        placeholder: `Message ${host}`
                    });
                }
            });
            return;
        }
        if (sourceType === 'companionship') {
            const title = String(this.activeMarketplaceItem.title || 'Profile').trim();
            const alias = String(this.activeMarketplaceItem.seller || 'Profile').trim();
            const photo = Array.isArray(this.activeMarketplaceItem.images) ? (this.activeMarketplaceItem.images[0] || '') : '';
            const profileId = String(this.activeMarketplaceItem?.source?.id || '').trim();
            this.openSafetyModal({
                title: 'Safety tips before messaging',
                subtitle: 'Use safe meetup and payment practices before continuing.',
                onContinue: () => {
                    this.openChatModal({
                        name: alias,
                        photo,
                        status: `Profile: ${title}`,
                        threadKey: `companionship:${this.normalizeSellerKey(alias) || 'profile'}:${profileId}`,
                        placeholder: `Message ${alias}`
                    });
                }
            });
            return;
        }
        this.handleMarketplaceMessage(this.activeMarketplaceItem.id);
    }

    shareMarketplaceItem() {
        if (!this.activeMarketplaceItem) return;
        const title = this.activeMarketplaceItem.title || 'Listing';
        this.showNotification(`Share link copied for ${title} (demo).`);
    }

    completeMarketplacePurchase() {
        if (!this.activeMarketplaceItem) return;
        const item = this.activeMarketplaceItem;
        const sellerName = String(item.seller || 'Seller').trim() || 'Seller';
        const title = item.title || 'Listing';
        this.openSafetyModal({
            title: 'Safety tips before buying',
            subtitle: 'Double-check meetup, payment, and item verification before you pay.',
            onContinue: () => {
                this.showNotification(`Purchase recorded for ${title}.`);
                this.closeMarketplaceItemModal();
                this.openSellerRatingModal({
                    sellerName,
                    itemTitle: title,
                    source: { type: 'marketplace', id: item.id }
                });
            }
        });
    }

    openDiscoveryListing(post, startIndex = 0) {
        if (!post) return;
        const listing = post.listing || {};
        const title = listing.title || 'Listing';
        const seller = post.seller || post.user || {};
        const location = this.buildListingLocationLabel(seller.location, post.location);
        const postedAt = post.timestamp instanceof Date ? post.timestamp : new Date(post.timestamp);
        const postedLabel = this.formatRelativeTime(postedAt);
        const specsParts = [listing.priceText, listing.condition].filter(Boolean);
        const meta = {
            bio: listing.summary || post.content || '',
            location,
            date: postedLabel,
            specs: specsParts.join(' 路 '),
            delivery: listing.fulfillment || '',
            availability: listing.availability || '',
            tags: Array.isArray(listing.tags) ? listing.tags : []
        };
        const mediaSources = Array.isArray(listing.media) ? listing.media.filter(Boolean) : [];
        const fallbackMedia = listing.mediaUrl || listing.image || '';
        const sources = mediaSources.length ? mediaSources : (fallbackMedia ? [fallbackMedia] : []);
        if (sources.length) {
            const items = sources.map((src) => ({ src, label: title, type: 'image', meta }));
            const initial = Number.isFinite(startIndex) ? Math.max(0, Math.min(startIndex, items.length - 1)) : 0;
            this.openMediaLightbox(items, title, initial);
            return;
        }
        this.showNotification(title);
    }

    openSellerProfileFromItem(itemId) {
        const item = this.marketplaceItems.find(i => i.id === itemId);
        if (!item) return;
        const data = this.buildSellerProfileData(item);
        if (!data) return;
        this.openSellerProfileModal(data);
    }

    openSellerProfileFromService() {
        if (!this.activeServiceProfile) return;
        const data = this.buildSellerProfileDataFromService(this.activeServiceProfile);
        if (!data) return;
        this.closeServiceModal();
        this.openSellerProfileModal(data);
    }

    openSellerProfileFromLuxuryAd() {
        if (!this.activeLuxuryAd) return;
        const data = this.buildSellerProfileDataFromLuxuryAd(this.activeLuxuryAd);
        if (!data) return;
        this.closeLuxuryAdModal();
        this.openSellerProfileModal(data);
    }

    openSellerProfileFromVehicle() {
        if (!this.activeVehicleListing) return;
        const data = this.buildSellerProfileDataFromVehicle(this.activeVehicleListing);
        if (!data) return;
        this.closeVehicleModal();
        this.openSellerProfileModal(data);
    }

    openSellerProfileFromRealestate() {
        if (!this.activeRealestateListing) return;
        const data = this.buildSellerProfileDataFromRealestate(this.activeRealestateListing);
        if (!data) return;
        this.closeRealestateModal();
        this.openSellerProfileModal(data);
    }

    openSellerProfileFromDiscovery(postId) {
        let post = (this.discoveryPosts || []).find(entry => String(entry.id) === String(postId));
        if (!post) {
            const idx = parseInt(postId, 10);
            if (Number.isFinite(idx)) post = (this.discoveryPosts || [])[idx];
        }
        if (!post) return;
        this.activeDiscoveryPost = post;
        const data = this.buildSellerProfileDataFromDiscoveryPost(post);
        if (!data) return;
        this.openSellerProfileModal(data);
    }

		    showPostItemModal(options = {}) {
		        if (!options?.skipAuth) {
		            const ok = this.requireSignedIn({
		                reason: 'post a listing',
		                onAuthed: () => this.showPostItemModal({ ...options, skipAuth: true })
		            });
		            if (!ok) return;
		        }
		        const modal = document.getElementById('post-item-modal');
		        if (modal) modal.classList.remove('hidden');
        const restoreBtn = document.getElementById('post-item-restore');
        if (restoreBtn) restoreBtn.classList.add('hidden');
        this.clearPostItemStoryPreview({ revoke: true });
        this.setupMarketplaceUploader();
        this.renderMarketplaceUploads();
        const categorySelect = document.getElementById('item-category');
        if (categorySelect && options.category) {
            categorySelect.value = options.category;
        }
        const placementSelect = document.getElementById('item-placement');
        if (placementSelect && options.placement) {
            placementSelect.value = options.placement;
        }
        const featuredToggle = document.getElementById('item-featured');
        if (featuredToggle && options.luxe) {
            featuredToggle.checked = true;
        }
        this.updatePostItemCategoryFields(categorySelect?.value || '');
        this.setupPostItemJobPreview();
    this.setupPostItemLivePreview();
        
        // Pre-fill city if user location is available
	        const cityInput = document.getElementById('item-city');
	        if (cityInput && this.userLocation) {
	            // Simple city detection based on coordinates (simplified)
	            cityInput.value = 'San Francisco'; // Default for demo
	        }

	        if (!this.isApplyingUiState && options.pushState !== false) {
	            const payload = {};
	            if (options.category) payload.category = options.category;
	            if (options.placement) payload.placement = options.placement;
	            if (options.luxe) payload.luxe = true;
	            this.updateBrowserUiState({ kind: 'modal', id: 'post-item-modal', options: payload }, { replace: false });
	        }
	    }

	    hidePostItemModal() {
	        if (!this.isApplyingUiState) {
	            const state = window.history.state;
	            if (state?.ui?.kind === 'modal' && state?.ui?.id === 'post-item-modal') {
	                window.history.back();
	                return;
	            }
	        }
	        const modal = document.getElementById('post-item-modal');
	        if (modal) {
	            modal.classList.add('hidden');
            document.getElementById('post-item-form').reset();
            this.clearPostItemStoryPreview({ revoke: true });
            this.marketplaceUploads = [];
            this.renderMarketplaceUploads();
            this.updatePostItemCategoryFields('');
            this.renderPostItemLivePreview();
        }
    }

    clearPostItemStoryPreview({ revoke = true, resetInput = true } = {}) {
        const input = document.getElementById('item-story-video');
        const preview = document.getElementById('item-story-preview');
        const status = document.getElementById('item-story-status');
        if (status) {
            status.textContent = '';
            status.classList.remove('error');
        }
        if (preview) {
            try { preview.pause(); } catch {}
            preview.classList.add('hidden');
            preview.removeAttribute('src');
            try { preview.load(); } catch {}
        }
        if (revoke && this.postItemStoryPreviewUrl) {
            try { URL.revokeObjectURL(this.postItemStoryPreviewUrl); } catch {}
        }
        this.postItemStoryPreviewUrl = '';
        this.postItemStoryFile = null;
        this.postItemStoryVideoOk = false;
        if (resetInput && input) input.value = '';
    }

	    setupMacWindowControls() {
	        const bind = ({ modalId, closeId, minimizeId, maximizeId, restoreId, onClose, onMinimize, onRestore }) => {
	            const modal = document.getElementById(modalId);
	            if (!modal) return;
            const closeBtn = closeId ? document.getElementById(closeId) : null;
            const minimizeBtn = minimizeId ? document.getElementById(minimizeId) : null;
            const maximizeBtn = maximizeId ? document.getElementById(maximizeId) : null;
            const restoreBtn = restoreId ? document.getElementById(restoreId) : null;

            const getContent = () => modal.querySelector('.modal-content');
            const setRestoreVisible = (visible) => {
                if (!restoreBtn) return;
                restoreBtn.classList.toggle('hidden', !visible);
            };
            const resetMaximize = () => {
                const content = getContent();
                if (content) content.classList.remove('is-maximized');
                if (maximizeBtn) maximizeBtn.setAttribute('aria-pressed', 'false');
            };
            const doClose = () => {
                resetMaximize();
                setRestoreVisible(false);
                if (typeof onClose === 'function') {
                    onClose();
                } else {
                    modal.classList.add('hidden');
                }
            };

            if (closeBtn && !closeBtn.dataset.bound) {
                closeBtn.addEventListener('click', doClose);
                closeBtn.dataset.bound = '1';
            }
            if (minimizeBtn && !minimizeBtn.dataset.bound) {
                minimizeBtn.addEventListener('click', () => {
                    if (typeof onMinimize === 'function') {
                        onMinimize({ modal, setRestoreVisible });
                        return;
                    }
                    modal.classList.add('hidden');
                    setRestoreVisible(true);
                });
                minimizeBtn.dataset.bound = '1';
            }
            if (maximizeBtn && !maximizeBtn.dataset.bound) {
                maximizeBtn.addEventListener('click', () => {
                    const content = getContent();
                    if (!content) return;
                    const isMaximized = content.classList.toggle('is-maximized');
                    maximizeBtn.setAttribute('aria-pressed', isMaximized ? 'true' : 'false');
                });
                maximizeBtn.dataset.bound = '1';
            }
            if (restoreBtn && !restoreBtn.dataset.bound) {
                restoreBtn.addEventListener('click', () => {
                    modal.classList.remove('hidden');
                    setRestoreVisible(false);
                    if (typeof onRestore === 'function') {
                        onRestore({ modal });
                    }
                });
                restoreBtn.dataset.bound = '1';
            }

            if (!modal.dataset.macBound) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) doClose();
                });
                modal.dataset.macBound = '1';
            }
        };

        bind({
            modalId: 'chat-modal',
            closeId: 'chat-close',
            minimizeId: 'chat-minimize',
            maximizeId: 'chat-maximize',
            restoreId: 'chat-restore',
            onClose: () => this.closeChatModal(),
            onMinimize: ({ modal, setRestoreVisible }) => {
                modal.classList.add('hidden');
                setRestoreVisible(true);
                document.removeEventListener('keydown', this.boundChatKeydown);
            },
            onRestore: () => {
                document.addEventListener('keydown', this.boundChatKeydown);
                const input = document.getElementById('message-input');
                input?.focus?.();
            }
        });

	        bind({
	            modalId: 'companionship-post-modal',
	            closeId: 'companionship-post-close',
	            minimizeId: 'companionship-post-minimize',
	            maximizeId: 'companionship-post-maximize',
	            restoreId: 'companionship-post-restore',
	            onClose: () => this.closeCompanionshipPostModal(false),
	            onMinimize: () => this.closeCompanionshipPostModal(true)
	        });

	        bind({
	            modalId: 'post-item-modal',
	            closeId: 'post-item-close',
	            minimizeId: 'post-item-minimize',
	            maximizeId: 'post-item-maximize',
	            restoreId: 'post-item-restore',
	            onClose: () => this.hidePostItemModal()
	        });

        bind({
            modalId: 'post-ad-modal',
            closeId: 'post-ad-close',
            minimizeId: 'post-ad-minimize',
            maximizeId: 'post-ad-maximize',
            restoreId: 'post-ad-restore',
            onClose: () => this.hidePostAdModal()
        });

        bind({
            modalId: 'companionship-payment-modal',
            closeId: 'companionship-payment-close',
            minimizeId: 'companionship-payment-minimize',
            maximizeId: 'companionship-payment-maximize',
            restoreId: 'companionship-payment-restore'
        });

	        bind({
	            modalId: 'quote-modal',
	            closeId: 'quote-modal-close',
	            minimizeId: 'quote-modal-minimize',
	            maximizeId: 'quote-modal-maximize',
	            restoreId: 'quote-modal-restore'
	        });

	        bind({
	            modalId: 'promotion-fee-modal',
	            closeId: 'promotion-fee-close',
	            minimizeId: 'promotion-fee-minimize',
	            maximizeId: 'promotion-fee-maximize',
	            restoreId: 'promotion-fee-restore',
	            onClose: () => this.closePromotionFeeModal(false),
	            onRestore: ({ modal }) => {
	                if (!this.pendingPromotionFee) {
	                    modal.classList.add('hidden');
	                    const restoreBtn = document.getElementById('promotion-fee-restore');
	                    if (restoreBtn) restoreBtn.classList.add('hidden');
	                    return;
	                }
	                this.refreshPromotionFeeModal();
	            }
	        });
	    }

	    minimizeModalForCheckout({ modalId, restoreId, maximizeId } = {}) {
	        const modal = modalId ? document.getElementById(modalId) : null;
	        if (!modal) return;
	        const content = modal.querySelector('.modal-content');
	        if (content) content.classList.remove('is-maximized');
	        const maximizeBtn = maximizeId ? document.getElementById(maximizeId) : null;
	        if (maximizeBtn) maximizeBtn.setAttribute('aria-pressed', 'false');
	        const restoreBtn = restoreId ? document.getElementById(restoreId) : null;
	        if (restoreBtn) restoreBtn.classList.remove('hidden');
	        modal.classList.add('hidden');
	    }

	    restoreModalFromCheckout({ modalId, restoreId } = {}) {
	        const modal = modalId ? document.getElementById(modalId) : null;
	        if (modal) modal.classList.remove('hidden');
	        const restoreBtn = restoreId ? document.getElementById(restoreId) : null;
	        if (restoreBtn) restoreBtn.classList.add('hidden');
	    }

    bindPostItemCategory() {
        const categorySelect = document.getElementById('item-category');
        if (!categorySelect || categorySelect.dataset.bound) return;
        categorySelect.addEventListener('change', (e) => {
            this.updatePostItemCategoryFields(e.target.value);
        });
        categorySelect.dataset.bound = '1';
    }

    updatePostItemCategoryFields(category) {
        const realestateFields = document.getElementById('realestate-fields');
        const vehicleFields = document.getElementById('vehicle-fields');
        const serviceFields = document.getElementById('service-fields');
        const serviceFeaturedFields = document.getElementById('service-featured-fields');
        const featuredAdFields = document.getElementById('featured-ad-fields');
        const jobsFields = document.getElementById('jobs-fields');
        const isRealEstate = category === 'real_estate';
        const isVehicle = category === 'vehicles';
        const isService = category === 'services';
        const isJobs = category === 'jobs';
        const postModal = document.getElementById('post-item-modal');
        if (postModal) {
            postModal.classList.toggle('jobs-mode', isJobs);
        }
        if (realestateFields) {
            realestateFields.classList.toggle('hidden', !isRealEstate);
        }
        if (vehicleFields) {
            vehicleFields.classList.toggle('hidden', !isVehicle);
        }
        if (serviceFields) {
            serviceFields.classList.toggle('hidden', !isService);
        }
        if (jobsFields) {
            jobsFields.classList.toggle('hidden', !isJobs);
        }
        if (serviceFeaturedFields) {
            const placement = document.getElementById('item-placement')?.value || '';
            const featured = Boolean(document.getElementById('item-featured')?.checked);
            const showFeaturedFields = isService && (placement === 'services_featured' || featured);
            serviceFeaturedFields.classList.toggle('hidden', !showFeaturedFields);
        }
			        if (featuredAdFields) {
			            const placement = String(document.getElementById('item-placement')?.value || '').trim().toLowerCase();
			            const featured = Boolean(document.getElementById('item-featured')?.checked);
			            const showFeaturedProfile = featured || placement.endsWith('_featured') || placement === 'premium';
			            featuredAdFields.classList.toggle('hidden', !showFeaturedProfile);
			        }
        document.querySelectorAll('[data-required-realestate]').forEach(field => {
            if (isRealEstate) field.setAttribute('required', 'required');
            else field.removeAttribute('required');
        });
        document.querySelectorAll('[data-required-vehicle]').forEach(field => {
            if (isVehicle) field.setAttribute('required', 'required');
            else field.removeAttribute('required');
        });
        document.querySelectorAll('[data-required-service]').forEach(field => {
            if (isService) field.setAttribute('required', 'required');
            else field.removeAttribute('required');
        });
        document.querySelectorAll('[data-required-jobs]').forEach(field => {
            if (isJobs) field.setAttribute('required', 'required');
            else field.removeAttribute('required');
        });
        document.querySelectorAll('[data-service-hide]').forEach(field => {
            field.classList.toggle('hidden', isService);
        });
        document.querySelectorAll('[data-jobs-hide]').forEach(field => {
            field.classList.toggle('hidden', isJobs);
        });

        const setLabel = (forId, value) => {
            const label = document.querySelector(`label[for="${forId}"]`);
            if (!label) return;
            if (!label.dataset.defaultText) label.dataset.defaultText = label.textContent.trim();
            label.textContent = value;
        };
        const resetLabel = (forId) => {
            const label = document.querySelector(`label[for="${forId}"]`);
            if (!label || !label.dataset.defaultText) return;
            label.textContent = label.dataset.defaultText;
        };
        const setPlaceholder = (id, value) => {
            const input = document.getElementById(id);
            if (!input) return;
            if (!input.dataset.defaultPlaceholder) {
                input.dataset.defaultPlaceholder = input.getAttribute('placeholder') || '';
            }
            input.setAttribute('placeholder', value);
        };
        const resetPlaceholder = (id) => {
            const input = document.getElementById(id);
            if (!input || input.dataset.defaultPlaceholder === undefined) return;
            input.setAttribute('placeholder', input.dataset.defaultPlaceholder);
        };
        const setText = (id, value) => {
            const node = document.getElementById(id);
            if (!node) return;
            if (!node.dataset.defaultText) node.dataset.defaultText = node.textContent.trim();
            node.textContent = value;
        };
        const resetText = (id) => {
            const node = document.getElementById(id);
            if (!node || !node.dataset.defaultText) return;
            node.textContent = node.dataset.defaultText;
        };

        if (isService) {
            setLabel('item-title', 'Service title');
            setPlaceholder('item-title', 'Service name');
            setLabel('item-price', 'Starting price ($)');
            setLabel('item-description', 'Service description');
            setPlaceholder('item-description', 'Describe your service, inclusions, and ideal clients...');
            setLabel('item-availability', 'Availability / booking window');
            setPlaceholder('item-availability', 'Same-week slots 路 replies within a day');
            setPlaceholder('item-tags', 'mobile, certified, weekend slots, luxury');
            setText('item-details-title', 'Service Logistics');
            setText('item-details-subtitle', 'Share response time, preferred contact, and any booking notes.');
        } else if (isJobs) {
            setLabel('item-title', 'Job title');
            setPlaceholder('item-title', 'e.g., Social Media Lead');
            setLabel('item-price', 'Pay min ($)');
            setPlaceholder('item-price', '25');
            setLabel('item-description', 'Role summary');
            setPlaceholder('item-description', 'Describe responsibilities, schedule, and benefits...');
            setLabel('item-availability', 'Schedule / start date');
            setPlaceholder('item-availability', 'Start ASAP 路 flexible schedule');
            setPlaceholder('item-tags', 'benefits, remote, urgent, weekend shifts');
            setText('item-details-title', 'Job Posting Details');
            setText('item-details-subtitle', 'Match the fields that appear on the job card.');
        } else {
            resetLabel('item-title');
            resetPlaceholder('item-title');
            resetLabel('item-price');
            resetLabel('item-description');
            resetPlaceholder('item-description');
            resetLabel('item-availability');
            resetPlaceholder('item-availability');
            resetPlaceholder('item-tags');
            resetText('item-details-title');
            resetText('item-details-subtitle');
        }
        if (isJobs) {
            this.setupPostItemJobPreview();
            this.renderPostItemJobPreview();
        }
        this.renderPostItemLivePreview();
    }

	    async handlePostItem(e) {
	        e.preventDefault();
	        
	        const title = document.getElementById('item-title').value.trim();
	        const category = document.getElementById('item-category').value;
	        const price = parseFloat(document.getElementById('item-price').value);
	        const country = document.getElementById('item-country').value.trim();
	        const city = document.getElementById('item-city').value.trim();
	        const description = document.getElementById('item-description').value.trim();
	        const storyText = (document.getElementById('item-story-text')?.value || '').trim();
	        const storyFile = document.getElementById('item-story-video')?.files?.[0] || null;
	        const paymentMethod = document.getElementById('item-payment')?.value || '';
				        const placement = String(document.getElementById('item-placement')?.value || '').trim().toLowerCase();
				        const featuredToggle = document.getElementById('item-featured');
				        const isFeatured = Boolean(featuredToggle?.checked) || placement.endsWith('_featured') || placement === 'premium';

	        const condition = document.getElementById('item-condition')?.value || '';
	        const brand = (document.getElementById('item-brand')?.value || '').trim();
	        const model = (document.getElementById('item-model')?.value || '').trim();
	        const quantityRaw = (document.getElementById('item-quantity')?.value || '').trim();
	        const quantity = quantityRaw ? parseInt(quantityRaw, 10) : null;
	        const deliveryMethod = document.getElementById('item-delivery')?.value || '';
	        const shippingFeeRaw = (document.getElementById('item-shipping-fee')?.value || '').trim();
	        const shippingFee = shippingFeeRaw ? parseFloat(shippingFeeRaw) : null;
	        const availability = (document.getElementById('item-availability')?.value || '').trim();
	        const contactMethod = document.getElementById('item-contact-method')?.value || '';
	        const contactPhone = (document.getElementById('item-contact-phone')?.value || '').trim();
	        const contactEmail = (document.getElementById('item-contact-email')?.value || '').trim();
	        const contactLink = (document.getElementById('item-link')?.value || '').trim();
        const tags = this.parseTagInput(document.getElementById('item-tags')?.value || '');
        const serviceCategory = document.getElementById('service-category')?.value || '';
        const serviceDuration = (document.getElementById('service-duration')?.value || '').trim();
        const serviceExperienceRaw = (document.getElementById('service-experience')?.value || '').trim();
        const serviceExperience = serviceExperienceRaw ? parseInt(serviceExperienceRaw, 10) : null;
	        const serviceAvailabilityWindow = (document.getElementById('service-availability-window')?.value || '').trim();
	        const serviceAvailabilityOther = (document.getElementById('service-availability-other')?.value || '').trim();
	        const serviceResponse = (document.getElementById('service-response')?.value || '').trim();
	        const serviceFeaturedTag = (document.getElementById('service-featured-tag')?.value || '').trim();
	        const serviceFeaturedTitle = (document.getElementById('service-featured-title')?.value || '').trim();
	        const serviceFeaturedPrice = (document.getElementById('service-featured-price')?.value || '').trim();
	        const serviceFeaturedHighlight = (document.getElementById('service-featured-highlight')?.value || '').trim();
	        const featuredAdTitle = (document.getElementById('featured-ad-title')?.value || '').trim();
	        const featuredAdPrice = (document.getElementById('featured-ad-price')?.value || '').trim();
	        const featuredAdMeta = (document.getElementById('featured-ad-meta')?.value || '').trim();
	        const featuredAdSummary = (document.getElementById('featured-ad-summary')?.value || '').trim();
	        const featuredAdCategory = (document.getElementById('featured-ad-category')?.value || '').trim();
	        const featuredAdLocation = (document.getElementById('featured-ad-location')?.value || '').trim();
	        const featuredAdCondition = (document.getElementById('featured-ad-condition')?.value || '').trim();
	        const featuredAdDelivery = (document.getElementById('featured-ad-delivery')?.value || '').trim();
	        const featuredAdSeller = (document.getElementById('featured-ad-seller')?.value || '').trim();
	        const featuredAdRating = (document.getElementById('featured-ad-rating')?.value || '').trim();
	        const featuredAdAvailability = (document.getElementById('featured-ad-availability')?.value || '').trim();
        const featuredAdTags = this.parseTagInput(document.getElementById('featured-ad-tags')?.value || '');
        const featuredAdPerks = this.parseTagInput(document.getElementById('featured-ad-perks')?.value || '');
        const jobCompany = (document.getElementById('job-company')?.value || '').trim();
        const jobCategory = document.getElementById('job-category')?.value || '';
        const jobType = document.getElementById('job-type')?.value || '';
        const jobExperience = document.getElementById('job-experience')?.value || '';
        const jobPayMaxRaw = (document.getElementById('job-pay-max')?.value || '').trim();
        const jobPayMax = jobPayMaxRaw ? parseFloat(jobPayMaxRaw) : null;
        const jobRemote = Boolean(document.getElementById('job-remote')?.checked);
        const jobCompanyLogo = (document.getElementById('job-company-logo')?.value || '').trim();
        const images = this.marketplaceUploads.length
            ? this.marketplaceUploads.map(f => f.src)
            : ['https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=400'];
        let storyVideoUrl = '';
	        if (storyFile) {
	            const canReusePreview = Boolean(this.postItemStoryVideoOk && this.postItemStoryFile === storyFile && this.postItemStoryPreviewUrl);
	            if (canReusePreview) {
	                storyVideoUrl = this.postItemStoryPreviewUrl;
	                // Preserve the blob URL for the posted item (do not revoke on close/reset).
	                this.postItemStoryPreviewUrl = '';
	                this.postItemStoryFile = null;
	                this.postItemStoryVideoOk = false;
	            } else {
	                const result = await this.validateShortVideo(storyFile, 5, 10);
	                if (!result.ok) {
	                    this.showNotification(result.message || 'Story video must be 510 seconds.');
	                    return;
	                }
	                storyVideoUrl = result.url || '';
	            }
	        }

	        if (!title || !category || !price || !country || !city || !description) {
	            this.showNotification('Please fill in all fields.');
	            return;
	        }

	        if (isFeatured) {
	            this.minimizeModalForCheckout({
	                modalId: 'post-item-modal',
	                restoreId: 'post-item-restore',
	                maximizeId: 'post-item-maximize'
	            });
	            const feePlacement = (placement === 'premium' || placement.endsWith('_featured'))
	                ? placement
	                : `${placement || 'featured'}_featured`;
	            const paid = await this.requirePromotionFee({
	                placement: feePlacement,
	                title: 'Featured placement fee',
	                subtitle: 'Featured placements are a paid promotion.'
	            });
	            if (!paid) {
	                this.restoreModalFromCheckout({ modalId: 'post-item-modal', restoreId: 'post-item-restore' });
	                return;
	            }
	            const restoreBtn = document.getElementById('post-item-restore');
	            if (restoreBtn) restoreBtn.classList.add('hidden');
	        }

	        const sellerName = category === 'jobs' && jobCompany ? jobCompany : (this.currentUser?.name || 'You');
	        const sellerPhoto = this.currentUser?.photo || this.currentUser?.photos?.[0] || 'https://via.placeholder.com/80x80/ccd5f6/1f2937?text=YOU';

	        // Create new item
	        const newItem = {
	            id: Date.now(), // Simple ID generation
	            title,
	            category,
	            price,
	            country,
	            city,
	            description,
	            seller: sellerName,
	            postedDate: new Date(),
	            images,
	            video: storyVideoUrl || '',
	            storyText: storyText || '',
	            paymentMethod,
	            placement,
	            featured: isFeatured,
	            condition,
	            brand,
	            model,
	            quantity: Number.isFinite(quantity) ? quantity : null,
	            delivery: deliveryMethod
	                ? { method: deliveryMethod, shippingFee: Number.isFinite(shippingFee) ? shippingFee : null }
	                : null,
	            availability,
	            contact: (contactMethod || contactPhone || contactEmail || contactLink)
	                ? { method: contactMethod, phone: contactPhone, email: contactEmail, link: contactLink }
	                : null,
            tags
        };

	        if (category === 'vehicles') {
	            const vehicle = {
	                make: (document.getElementById('vehicle-make')?.value || '').trim(),
	                model: (document.getElementById('vehicle-model')?.value || '').trim(),
	                year: parseInt(document.getElementById('vehicle-year')?.value || '', 10) || null,
	                mileage: parseInt(document.getElementById('vehicle-mileage')?.value || '', 10) || null,
	                condition: document.getElementById('vehicle-condition')?.value || '',
	                category: document.getElementById('vehicle-category')?.value || '',
	                transmission: document.getElementById('vehicle-transmission')?.value || '',
	                fuel: document.getElementById('vehicle-fuel')?.value || '',
	                color: (document.getElementById('vehicle-color')?.value || '').trim(),
	                vin: (document.getElementById('vehicle-vin')?.value || '').trim(),
	                certified: Boolean(document.getElementById('vehicle-certified')?.checked),
	                warranty: Boolean(document.getElementById('vehicle-warranty')?.checked),
	                contactPhone: (document.getElementById('vehicle-contact')?.value || '').trim(),
	                description: (document.getElementById('vehicle-description')?.value || '').trim()
	            };
	            newItem.vehicle = vehicle;
	        }

        if (category === 'services') {
            const availabilityValue = serviceAvailabilityWindow === 'Other'
                ? serviceAvailabilityOther
                : serviceAvailabilityWindow;
            const service = {
	                category: serviceCategory,
	                duration: serviceDuration,
	                experience: Number.isFinite(serviceExperience) ? serviceExperience : null,
	                availabilityWindow: availabilityValue,
	                responseTime: serviceResponse
	            };
	            const hasFeatured = serviceFeaturedTag || serviceFeaturedTitle || serviceFeaturedPrice || serviceFeaturedHighlight;
	            if (hasFeatured) {
	                service.featured = {
	                    tag: serviceFeaturedTag,
	                    title: serviceFeaturedTitle,
	                    priceLine: serviceFeaturedPrice,
	                    highlightLine: serviceFeaturedHighlight
	                };
	            }
            newItem.service = service;
        }

        if (category === 'jobs') {
            newItem.jobCategory = jobCategory;
            newItem.employmentType = jobType;
            newItem.experienceLevel = jobExperience;
            newItem.remote = jobRemote;
            newItem.payMin = Number.isFinite(price) ? price : null;
            newItem.payMax = Number.isFinite(jobPayMax) ? jobPayMax : null;
            newItem.payUnit = 'hr';
            if (jobCompanyLogo) {
                newItem.companyLogo = jobCompanyLogo;
            } else if (images[0]) {
                newItem.companyLogo = images[0];
            }
        }

        if (category === 'real_estate') {
            const realestate = {
                listingType: document.getElementById('realestate-listing-type')?.value || '',
                propertyType: document.getElementById('realestate-property-type')?.value || '',
	                bedrooms: parseInt(document.getElementById('realestate-bedrooms')?.value || '', 10) || null,
	                bathrooms: parseFloat(document.getElementById('realestate-bathrooms')?.value || '') || null,
	                sqft: parseInt(document.getElementById('realestate-sqft')?.value || '', 10) || null,
	                availableOn: document.getElementById('realestate-availability')?.value || '',
	                address: (document.getElementById('realestate-address')?.value || '').trim(),
	                postal: (document.getElementById('realestate-postal')?.value || '').trim(),
	                priceTerm: document.getElementById('realestate-price-term')?.value || '',
	                furnished: Boolean(document.getElementById('realestate-furnished')?.checked),
	                parking: Boolean(document.getElementById('realestate-parking')?.checked),
	                pets: Boolean(document.getElementById('realestate-pets')?.checked),
	                amenities: (document.getElementById('realestate-amenities')?.value || '').trim(),
	                contactPhone: (document.getElementById('realestate-contact')?.value || '').trim()
	            };
		            newItem.realestate = realestate;
		        }

	        const showInMarketplace = placement !== 'community' && placement !== 'community_featured' && placement !== 'dating' && placement !== 'companionship_featured';
	        if (showInMarketplace) {
	            this.marketplaceItems.unshift(newItem);
	        }

	        const listingLocation = [city, country].filter(Boolean).join(', ');
	        const sellerLocation = this.buildLocationFromInput(listingLocation);
		            const listingTypeValue = document.getElementById('realestate-listing-type')?.value || '';
		            let listingType = 'sale';
		            if (category === 'services' || category === 'jobs') listingType = 'service';
		            if (category === 'real_estate') {
		                if (listingTypeValue.startsWith('for_rent')) listingType = 'rent';
		                else if (listingTypeValue === 'for_sale') listingType = 'sale';
		                else if (listingTypeValue === 'commercial') listingType = 'rent';
		            }
            const priceTerm = document.getElementById('realestate-price-term')?.value || '';
            const priceSuffixMap = {
                per_month: '/ mo',
                per_week: '/ wk',
                per_night: '/ night',
                per_sqft: '/ sq ft'
            };
	            const priceSuffix = priceSuffixMap[priceTerm] || '';
	            const priceText = `$${price}${priceSuffix}`;
	            const fallbackCategory = this.marketplaceCategoryLabel(category);
	            const fallbackLocation = [city, country].filter(Boolean).join(', ');
	            const fallbackCondition = this.marketplaceConditionLabel(newItem.condition || newItem.vehicle?.condition || '');
	            const fallbackDelivery = this.marketplaceDeliveryLabel(newItem.delivery);
	            if (isFeatured) {
	                const detailOverrides = {
	                    category: featuredAdCategory,
	                    location: featuredAdLocation,
	                    condition: featuredAdCondition,
	                    delivery: featuredAdDelivery,
	                    seller: featuredAdSeller,
	                    availability: featuredAdAvailability
	                };
	                const detailRows = this.buildFeaturedAdDetailRows(newItem, {
	                    priceText,
	                    availability,
	                    sellerName,
	                    overrides: detailOverrides
	                });
	                const adDetails = this.buildFeaturedAdDetailsString(detailRows);
	                const featuredAd = {
	                    title: featuredAdTitle || title,
	                    priceLine: featuredAdPrice || priceText,
	                    metaLine: featuredAdMeta || availability || '',
	                    summary: featuredAdSummary || description,
	                    details: {
	                        category: featuredAdCategory || fallbackCategory,
	                        location: featuredAdLocation || fallbackLocation,
	                        condition: featuredAdCondition || fallbackCondition,
	                        delivery: featuredAdDelivery || fallbackDelivery,
	                        seller: featuredAdSeller || sellerName,
	                        rating: featuredAdRating || 'New',
	                        availability: featuredAdAvailability || availability
	                    },
	                    tags: featuredAdTags,
	                    perks: featuredAdPerks
	                };
	                if (detailRows.length) featuredAd.detailRows = detailRows;
	                if (adDetails) featuredAd.adDetails = adDetails;
	                newItem.featuredAd = featuredAd;
	            }
	            const conditionLabelMap = {
	                new: 'New',
	                like_new: 'Like new',
	                excellent: 'Excellent',
	                good: 'Good',
	                fair: 'Fair',
	                for_parts: 'For parts'
	            };
	            const itemConditionLabel = conditionLabelMap[condition] || '';
	            const vehicleConditionLabel = conditionLabelMap[newItem.vehicle?.condition] || '';
            const listingCondition = category === 'vehicles'
                ? (vehicleConditionLabel || 'Vehicle')
                : (category === 'services'
                    ? 'Service offering'
                    : (category === 'jobs'
                        ? 'Job posting'
                        : (itemConditionLabel || (category === 'real_estate' ? 'Real estate' : 'Marketplace'))));
            const fulfillment = deliveryMethod === 'shipping'
                ? (Number.isFinite(shippingFee) ? `Shipping ($${shippingFee.toFixed(2)})` : 'Shipping')
                : (deliveryMethod === 'pickup' ? 'Pickup' : (deliveryMethod === 'local_delivery' ? 'Local delivery' : 'In-app chat'));
            const mergedTags = Array.from(new Set([category.replace('_', ' '), ...tags])).filter(Boolean);
            const listingSpecsParts = [];
	            if (category === 'vehicles') {
	                const v = newItem.vehicle || {};
	                const name = [v.make, v.model].filter(Boolean).join(' ');
	                const core = [name, v.year].filter(Boolean).join(' ');
	                if (core) listingSpecsParts.push(core);
	                const mileage = typeof v.mileage === 'number' && Number.isFinite(v.mileage) ? v.mileage : null;
	                if (mileage !== null) listingSpecsParts.push(`${mileage.toLocaleString()} mi`);
	                if (v.transmission) listingSpecsParts.push(String(v.transmission));
	                if (v.fuel) listingSpecsParts.push(String(v.fuel));
	                if (v.color) listingSpecsParts.push(String(v.color));
            } else if (category === 'services') {
                const service = newItem.service || {};
                const categoryLabels = {
                    food: 'Food',
                    entertainment: 'Entertainment',
                    fitness: 'Fitness',
	                    financial: 'Financial & legal',
	                    health_beauty: 'Health & beauty',
	                    home_services: 'Home Services',
	                    pet_services: 'Pet Services',
	                    skilled_trades: 'Skilled trades',
	                    events_services: 'Events & Services',
	                    travel: 'Travel',
	                    other: 'Service'
	                };
	                if (service.category) listingSpecsParts.push(categoryLabels[service.category] || service.category);
	                if (service.duration) listingSpecsParts.push(service.duration);
	                if (Number.isFinite(service.experience) && service.experience > 0) {
	                    listingSpecsParts.push(`${service.experience} yrs exp`);
	                }
                if (service.availabilityWindow) listingSpecsParts.push(service.availabilityWindow);
            } else if (category === 'jobs') {
                const categoryLabel = this.getJobsCategoryLabel(jobCategory) || jobCategory;
                if (categoryLabel) listingSpecsParts.push(categoryLabel);
                if (jobType) listingSpecsParts.push(this.getJobTypeLabel(jobType));
                if (jobExperience) listingSpecsParts.push(this.getJobExperienceLabel(jobExperience));
                if (jobRemote) listingSpecsParts.push('Remote');
                const payLabel = this.getJobPayLabel({
                    payMin: Number.isFinite(price) ? price : null,
                    payMax: Number.isFinite(jobPayMax) ? jobPayMax : null,
                    payUnit: 'hr',
                    price
                });
                if (payLabel) listingSpecsParts.push(payLabel);
            } else if (category === 'real_estate') {
                const re = newItem.realestate || {};
                if (re.propertyType) listingSpecsParts.push(String(re.propertyType));
	                const beds = typeof re.bedrooms === 'number' && Number.isFinite(re.bedrooms) ? re.bedrooms : null;
	                const baths = typeof re.bathrooms === 'number' && Number.isFinite(re.bathrooms) ? re.bathrooms : null;
	                if (beds !== null || baths !== null) {
	                    listingSpecsParts.push([beds !== null ? `${beds} bd` : '', baths !== null ? `${baths} ba` : ''].filter(Boolean).join(' 路 '));
	                }
	                const sqft = typeof re.sqft === 'number' && Number.isFinite(re.sqft) ? re.sqft : null;
	                if (sqft !== null) listingSpecsParts.push(`${sqft.toLocaleString()} sqft`);
	            } else {
	                if (brand) listingSpecsParts.push(brand);
	                if (model) listingSpecsParts.push(model);
	                if (Number.isFinite(quantity) && quantity) listingSpecsParts.push(`Qty ${quantity}`);
	            }
	            const listingSpecs = listingSpecsParts.filter(Boolean).join('  ');
	            const newPost = {
	                id: Date.now() + 1,
	                seller: {
	                    name: sellerName,
                    avatar: sellerPhoto,
                    location: sellerLocation,
                    online: true,
                    stats: 'New listing',
                    trust: 'Marketplace'
                },
                user: {
                    name: sellerName,
                    avatar: sellerPhoto,
                    location: sellerLocation,
                    online: true
                },
	                listingType,
	                listing: {
	                    title,
	                    summary: description,
	                    priceText,
	                    condition: listingCondition,
	                    availability: availability || 'Replies within a day',
	                    fulfillment,
	                    mediaUrl: images[0],
	                    tags: mergedTags,
	                    specs: listingSpecs
	                },
	                content: description,
	                timestamp: new Date(),
	                isOnline: true,
                likes: 0,
                comments: 0,
                location: sellerLocation
            };
	            this.discoveryPosts.unshift(newPost);
	            this.filterDiscoveryPosts(this.activeDiscoveryFilter);
	            this.insertFeaturedAdCard(newItem, { priceText, sellerName, sellerPhoto });
        this.hidePostItemModal();
        this.showNotification('Item posted successfully!');
        this.addNotification({
            title: 'Listing posted',
            message: `${title} is now live in Marketplace.`,
            type: 'marketplace'
        });
	        
	        // Refresh the marketplace if currently viewing
        if (document.getElementById('marketplace-content').classList.contains('active')) {
            if (showInMarketplace) {
                this.applyMarketplaceFilters();
            }
        }
	        const clothingContent = document.getElementById('clothing-content');
	        if (clothingContent?.classList.contains('active')) {
	            if (showInMarketplace) {
	                this.applyClothingFilters();
	            }
	        }

	        this.addMyPost({
	            kind: 'marketplace',
	            title,
	            subtitle: category === 'services' ? 'Service listing' : (category === 'jobs' ? 'Job post' : 'Marketplace listing'),
	            thumb: images?.[0] || '',
	            refs: { marketplaceItemId: newItem.id, discoveryPostId: newPost.id },
	            payload: { category, placement, featured: isFeatured }
	        });
	    }

    formatDate(date) {
        const now = new Date();
        const itemDate = new Date(date);
        const diffMs = now - itemDate;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffHours < 1) return 'Just posted';
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        return itemDate.toLocaleDateString();
    }

    setupMarketplaceUploader() {
        const dropzone = document.getElementById('market-upload-dropzone');
        const deviceInput = document.getElementById('market-upload-device');
        const galleryInput = document.getElementById('market-upload-gallery');
        const cameraInput = document.getElementById('market-upload-camera');
        const importInput = document.getElementById('market-upload-import');
        const deviceBtn = document.getElementById('market-upload-device-btn');
        const galleryBtn = document.getElementById('market-upload-gallery-btn');
        const cameraBtn = document.getElementById('market-upload-camera-btn');
        const importBtn = document.getElementById('market-upload-import-btn');
        const previewList = document.getElementById('market-upload-previews');
        const storyVideoInput = document.getElementById('item-story-video');
        const storyPreview = document.getElementById('item-story-preview');
        const storyStatus = document.getElementById('item-story-status');

        const trigger = (input) => {
            if (!input) return;
            input.value = '';
            input.click();
        };

        const addFiles = (fileList) => {
            if (!fileList) return;
            const files = Array.from(fileList).filter(f => f.type && f.type.startsWith('image/'));
            files.forEach(file => {
                if (this.marketplaceUploads.length >= 12) return;
                const id = `${file.name}-${file.lastModified}-${Math.random().toString(16).slice(2)}`;
                const previewUrl = URL.createObjectURL(file);
                this.marketplaceUploads.push({ id, name: file.name, size: file.size, src: previewUrl, file });
            });
            this.renderMarketplaceUploads(previewList);
        };

        if (deviceBtn && deviceInput && !deviceBtn.dataset.bound) {
            deviceBtn.addEventListener('click', () => trigger(deviceInput));
            deviceInput.addEventListener('change', (e) => addFiles(e.target.files));
            deviceBtn.dataset.bound = '1';
        }
        if (galleryBtn && galleryInput && !galleryBtn.dataset.bound) {
            galleryBtn.addEventListener('click', () => trigger(galleryInput));
            galleryInput.addEventListener('change', (e) => addFiles(e.target.files));
            galleryBtn.dataset.bound = '1';
        }
        if (cameraBtn && cameraInput && !cameraBtn.dataset.bound) {
            cameraBtn.addEventListener('click', () => trigger(cameraInput));
            cameraInput.addEventListener('change', (e) => addFiles(e.target.files));
            cameraBtn.dataset.bound = '1';
        }
        if (importBtn && importInput && !importBtn.dataset.bound) {
            importBtn.addEventListener('click', () => trigger(importInput));
            importInput.addEventListener('change', (e) => addFiles(e.target.files));
            importBtn.dataset.bound = '1';
        }
        if (dropzone && !dropzone.dataset.bound) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-active');
            });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-active'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-active');
                addFiles(e.dataTransfer?.files);
            });
            dropzone.addEventListener('paste', (e) => {
                addFiles(e.clipboardData?.files);
            });
            dropzone.addEventListener('click', () => trigger(deviceInput || galleryInput));
            dropzone.dataset.bound = '1';
        }

        if (storyVideoInput && !storyVideoInput.dataset.bound) {
            storyVideoInput.addEventListener('change', async () => {
                const modal = document.getElementById('post-item-modal');
                const file = storyVideoInput.files?.[0] || null;
                this.clearPostItemStoryPreview({ revoke: true, resetInput: false });
                if (!file) return;
                this.postItemStoryFile = file;
                const requestId = String(Date.now() + Math.random());
                storyVideoInput.dataset.storyPreviewRequest = requestId;
                if (storyStatus) {
                    storyStatus.textContent = 'Checking video';
                    storyStatus.classList.remove('error');
                }
                const result = await this.validateShortVideo(file, 5, 10);
                if (storyVideoInput.dataset.storyPreviewRequest !== requestId) {
                    if (result?.ok && result.url) {
                        try { URL.revokeObjectURL(result.url); } catch {}
                    }
                    return;
                }
                if (!modal || modal.classList.contains('hidden')) {
                    if (result?.ok && result.url) {
                        try { URL.revokeObjectURL(result.url); } catch {}
                    }
                    return;
                }
                if (!result.ok) {
                    if (storyStatus) {
                        storyStatus.textContent = result.message || 'Video must be 510 seconds.';
                        storyStatus.classList.add('error');
                    }
                    storyVideoInput.value = '';
                    this.postItemStoryFile = null;
                    this.postItemStoryVideoOk = false;
                    return;
                }
                this.postItemStoryPreviewUrl = result.url || '';
                this.postItemStoryVideoOk = true;
                if (storyPreview && this.postItemStoryPreviewUrl) {
                    storyPreview.src = this.postItemStoryPreviewUrl;
                    storyPreview.classList.remove('hidden');
                    storyPreview.play().catch(() => {});
                }
                if (storyStatus) storyStatus.textContent = 'Looks good (510 seconds).';
            });
            storyVideoInput.dataset.bound = '1';
        }
    }

	    async handlePostAdSubmit(e) {
	        e.preventDefault();
	        const placement = (document.getElementById('ad-placement')?.value || 'all').trim().toLowerCase();
	        const category = (document.getElementById('ad-category')?.value || '').trim();
	        const description = (document.getElementById('ad-description')?.value || '').trim();
	        this.postAdDraft = { placement, category, description };

        if (!category || !description) {
            this.showNotification('Add a category and description.');
            return;
        }
	        if (!this.postAdUploads.length) {
	            this.showNotification('Upload at least 1 image.');
	            return;
	        }

	        this.minimizeModalForCheckout({
	            modalId: 'post-ad-modal',
	            restoreId: 'post-ad-restore',
	            maximizeId: 'post-ad-maximize'
	        });
	        const paid = await this.requirePromotionFee({
	            placement,
	            title: 'Banner promotion fee',
	            subtitle: placement === 'all'
	                ? 'Promote your banner across all placements.'
	                : `Promote your banner on ${placement}.`
	        });
	        if (!paid) {
	            this.showPostAdModal();
	            return;
	        }

	        const primaryUpload = this.postAdUploads[0] || null;
	        let nextSrc = primaryUpload?.src || '';
	        const file = primaryUpload?.file || null;
	        if (file && typeof file.size === 'number' && file.size <= 1_500_000) {
            try {
                const dataUrl = await this.readFileAsDataUrl(file);
                if (dataUrl) nextSrc = dataUrl;
            } catch {}
        }
	        if (nextSrc) this.applyPromotedAd({ placement, src: nextSrc });

        this.hidePostAdModal({ clearDraft: true });
        this.showNotification('Ad posted.');
        this.addMyPost({
            kind: 'ad',
            title: category || 'Ad',
            subtitle: placement && placement !== 'all' ? `Ad 路 ${placement}` : 'Ad',
            thumb: nextSrc,
            refs: { placement: placement || 'all' },
            payload: { category, description }
        });
    }

    renderMarketplaceUploads(previewListEl) {
        const list = previewListEl || document.getElementById('market-upload-previews');
        if (!list) return;
        if (!this.marketplaceUploads.length) {
            list.innerHTML = '<p class="market-upload-empty">No media added yet.</p>';
            this.renderPostItemLivePreview();
            return;
        }
        list.innerHTML = this.marketplaceUploads.map((item) => `
            <div class="market-upload-chip" data-id="${item.id}">
                <img src="${item.src}" alt="${item.name}" loading="lazy">
                <button type="button" class="market-upload-remove" aria-label="Remove ${item.name}">&times;</button>
            </div>
        `).join('');
        list.querySelectorAll('.market-upload-remove').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.addEventListener('click', () => {
                const id = btn.parentElement?.dataset?.id;
                this.marketplaceUploads = this.marketplaceUploads.filter(f => f.id !== id);
                this.renderMarketplaceUploads(list);
            });
            btn.dataset.bound = '1';
        });
        this.renderPostItemLivePreview();
    }

    // Utility Functions
    showNotification(message, options = {}) {
        const opts = options && typeof options === 'object' ? options : {};
        const force = opts.force === true;
        const type = String(opts.type || 'info').toLowerCase();

        const isHome = this.activeScreen === 'home'
            || document.getElementById('home-content')?.classList.contains('active');
        if (!isHome && !force) return;

        const palette = {
            info: '#4ecdc4',
            success: '#22c55e',
            error: '#ef4444',
            warn: '#f59e0b'
        };
        const bg = palette[type] || palette.info;
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: ${bg};
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

// Initialize the app when the page loads
let app;
document.addEventListener('DOMContentLoaded', () => {
    try {
        app = new DatingApp();
        window.app = app;
        const params = new URLSearchParams(window.location.search);
        const open = (params.get('open') || '').toLowerCase();
        if (open === 'post-ad' || open === 'post_item' || open === 'post-item') {
            requestAnimationFrame(() => {
                try {
                    app.showPostAdModal();
                } catch (err) {
                    console.warn('Debug open post-item modal failed:', err);
                }
            });
        }
    } catch (err) {
        console.error('App failed to initialize:', err);
        const loading = document.getElementById('loading-screen');
        if (loading) {
            loading.style.display = 'flex';
            loading.innerHTML = `
                <div style="text-align:center;max-width:520px;padding:0 1.25rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;"><i class="fas fa-triangle-exclamation" aria-hidden="true"></i></div>
                    <h1 style="margin:0 0 0.5rem;font-size:2rem;">6ixo</h1>
                    <p style="margin:0 0 1rem;opacity:0.9;font-size:1.05rem;">The app didnt load. Refresh the page. If it keeps happening, open DevTools  Console and send the error.</p>
                    <button type="button" style="border:0;border-radius:12px;padding:0.9rem 1.1rem;font-weight:700;background:#ffffff;color:#1d4ed8;cursor:pointer;" onclick="window.location.reload()">Refresh</button>
                </div>
            `;
        }
        const main = document.getElementById('main-app');
        if (main) main.classList.remove('hidden');
    }
});

// Service Worker for PWA capabilities (optional)
if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then((registration) => {
                console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}
